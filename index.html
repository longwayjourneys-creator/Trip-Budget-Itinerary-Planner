<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trip Budget">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Trip Budget & Itinerary Planner</title>

 
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        /* Add to your root styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: #fafafa;
            color: #1f2937; /* Darker for better contrast */
            line-height: 1.6;
            padding: 20px;
            font-size: 15px; /* Base size */
        }
        h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px; /* Tighter */
            line-height: 1.2;
        }
        h2 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.3px;
            line-height: 1.3;
        }
        h3 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.2px;
            line-height: 1.4;
        }
        /* Small caps for labels */
        .stat-label,
        .section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px; /* Wider spacing */
            font-weight: 700; /* Bolder */
            color: #6b7280;
        }        
        .container { max-width: 900px; margin: 0 auto; }
        
        :root {
            /* Primary Colors */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            
            /* Gray Scale */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
            
            /* Success */
            --success-50: #f0fdf4;
            --success-500: #10b981;
            --success-600: #059669;
            
            /* Error */
            --error-50: #fef2f2;
            --error-500: #ef4444;
            --error-600: #dc2626;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        .header { background: white; padding: 40px; margin-bottom: 30px; border-radius: 8px; border-left: 4px solid #333; }
        .header h1 { font-size: 28px; font-weight: 600; margin-bottom: 8px; color: #111; }
        .header .subtitle { color: #666; font-size: 15px; }
        .header-title-edit { border: 2px solid #3b82f6; border-radius: 4px; padding: 8px 12px; font-size: 28px; font-weight: 600; width: 100%; }
        .header-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .header-btn {
            background: rgba(255, 255, 255, 0.2); /* Glass effect */
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }       
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4rgba(21, 16, 16, 0.2) 0, 0.2;
        }
        .header-btn.danger { background: #ef4444; }
        .header-btn.danger:hover { background: #dc2626; }

        .currency-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .currency-selector label { font-size: 14px; font-weight: 600; color: #374151; }
        .currency-selector select { padding: 8px 12px; border: 2px solid #cbd5e1; border-radius: 4px; font-size: 14px; background: white; cursor: pointer; }
        .currency-selector select:focus { outline: none; border-color: #3b82f6; }
        .rate-toggle { display: flex; align-items: center; gap: 8px; }
        .rate-toggle-label { font-size: 13px; color: #666; }

        .day-card-controls { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; }
        .day-control-btn { background: #f3f4f6; color: #374151; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .day-control-btn:hover { background: #e5e7eb; }
        .day-control-btn.danger { background: #fee2e2; color: #dc2626; }
        .day-control-btn.danger:hover { background: #fecaca; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .stat-card.blue { background: #f0f9ff; border-color: #3b82f6; }
        .stat-card.red { background: #fef3f2; border-color: #ef4444; }
        .stat-card.green { background: #f0fdf4; border-color: #22c55e; }
        .stat-label { font-size: 12px; text-transform: uppercase; color: #999; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: 600; color: #111; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s; }
        .stat-value:hover { background: #f0f0f0; }
        .stat-card.green .stat-value { color: #16a34a; }
        .stat-sub { font-size: 13px; color: #666; margin-top: 4px; }
        .edit-input { width: 100%; max-width: 150px; padding: 4px 8px; border: 2px solid #3b82f6; border-radius: 4px; font-size: 24px; font-weight: 600; text-align: center; }
        
        .search-bar { background: white; padding: 15px 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; position: relative; }
        .search-input { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 15px; }
        .search-input:focus { outline: none; border-color: #3b82f6; }
        .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 5px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; display: none; }
        .search-dropdown.show { display: block; }
        .search-result-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .search-result-item:hover { background: #f9f9f9; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-day { font-weight: 600; color: #111; font-size: 14px; margin-bottom: 4px; }
        .search-result-location { color: #666; font-size: 13px; margin-bottom: 4px; }
        .search-result-match { color: #3b82f6; font-size: 12px; }
        .search-result-highlight { background: #fef08a; padding: 0 2px; border-radius: 2px; }
        .search-no-results { padding: 20px; text-align: center; color: #999; font-size: 14px; }
        
        .control-bar { background: white; padding: 15px 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .control-bar .rate { font-size: 14px; color: #666; }
        .control-bar .rate-value { font-size: 16px; font-weight: 600; cursor: pointer; padding: 6px 10px; border-radius: 4px; }
        .control-bar .rate-value:hover { background: #f0f0f0; }
        /* Primary Button */
        .btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        /* Secondary Button */
        .btn-secondary {
            background: white;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: #eff6ff;
            transform: translateY(-2px);
        }
        /* Danger Button */
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .converter { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .converter h3 { font-size: 16px; margin-bottom: 15px; }
        .converter-inputs { display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; }
        .converter-input { display: flex; flex-direction: column; }
        .converter-input label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .converter-input input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 18px; font-weight: 600; }
        .converter-swap { font-size: 24px; cursor: pointer; user-select: none; }
        
        .daily-budget { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .daily-budget-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .daily-budget h3 { font-size: 16px; margin: 0; }
        .daily-budget-toggle { font-size: 20px; transition: transform 0.3s; }
        .daily-budget-toggle.open { transform: rotate(180deg); }
        .daily-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; display: none; }
        .daily-stats.show { display: grid; }
        .daily-stat { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; }
        .daily-stat-label { font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 5px; }
        .daily-stat-value { font-size: 22px; font-weight: 600; }
        .daily-stat-note { font-size: 10px; opacity: 0.7; margin-top: 4px; }
        
        .toggle { background: white; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; cursor: pointer; }
        .toggle:hover { background: #f9f9f9; }
        .toggle-switch { width: 50px; height: 26px; background: #ddd; border-radius: 13px; position: relative; transition: background 0.3s; }
        .toggle-switch.on { background: #22c55e; }
        .toggle-slider { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch.on .toggle-slider { transform: translateX(18px); }
        
        .progress { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 30px; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .progress-bar {
            width: 100%;
            height: 12px; /* Thicker */
            background: #f3f4f6;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06); /* Inner shadow */
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 6px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother */
            position: relative;
            overflow: hidden;
        }
        /* Add shimmer effect */
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            to {
                left: 100%;
            }
        }
        .progress-fill.over {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .chart-container { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .chart-container h3 { font-size: 16px; margin: 0; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 15px; }
        .chart-header-toggle { font-size: 20px; transition: transform 0.3s; }
        .chart-header-toggle.open { transform: rotate(180deg); }
        .chart-content { display: none; }
        .chart-content.show { display: block; }
        .chart-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .chart-toggle button { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .chart-toggle button.active { background: #111; color: white; border-color: #111; }
        .chart { display: grid; gap: 10px; }
        .chart-bar { display: flex; align-items: center; gap: 10px; }
        .chart-label { min-width: 120px; font-size: 13px; font-weight: 600; }
        .chart-bar-bg { flex: 1; height: 30px; background: #f0f0f0; border-radius: 4px; overflow: hidden; position: relative; }
        .chart-bar-fill { height: 100%; display: flex; align-items: center; padding: 0 10px; color: white; font-size: 12px; font-weight: 600; transition: width 0.3s; }
        .chart-bar-fill.acc { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .chart-bar-fill.trn { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        .chart-bar-fill.food { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .chart-bar-fill.act { background: linear-gradient(90deg, #10b981, #059669); }
        .chart-value { min-width: 100px; text-align: right; font-size: 13px; font-weight: 600; }
        
        .day-card { background: white; margin-bottom: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .day-card.done { opacity: 0.7; border-left: 4px solid #22c55e; }
        .day-header { padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .day-header:hover { background: #f9f9f9; }
        .day-info { display: flex; align-items: center; gap: 20px; flex: 1; }
        .day-check { width: 24px; height: 24px; cursor: pointer; }
        .day-num { width: 40px; height: 40px; background: #111; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .day-card.done .day-num { background: #22c55e; }
        .day-title h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .day-title .date { font-size: 13px; color: #666; }
        .day-cost .amount { font-size: 18px; font-weight: 600; }
        .day-cost .usd { font-size: 13px; color: #666; }
        
        .details { padding: 20px; border-top: 1px solid #f0f0f0; display: none; }
        .details.show { display: block; }
        .edit-btn { background: #111; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; margin-bottom: 15px; }
        .edit-btn:hover { background: #333; }
        .edit-btn.save { background: #28a745; }
        .section { margin-top: 15px; padding: 15px; background: #fafafa; border-radius: 4px; }
        .section.blue { background: #f0f9ff; border-left: 3px solid #3b82f6; }
        .section.yellow { background: #fffbf0; border-left: 3px solid #ffc107; }
        .section-label { font-size: 12px; text-transform: uppercase; color: #999; margin-bottom: 8px; }
        .section-content { font-size: 14px; color: #333; }
        .section-cost { font-weight: 600; color: #111; margin-top: 8px; }
        .section-cost.actual { color: #ef4444; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        input[type="text"], input[type="number"], input[type="time"], textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; }
        textarea { min-height: 60px; resize: vertical; }
        
        .photo-section { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px; }
        .photo-upload { display: flex; gap: 10px; margin-bottom: 10px; }
        .photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .photo-item { position: relative; aspect-ratio: 1; border-radius: 4px; overflow: hidden; cursor: pointer; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-delete { position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; z-index: 10; }
        
        .photo-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .photo-modal.show { display: flex; }
        .photo-modal-content { max-width: 90%; max-height: 90%; position: relative; }
        .photo-modal-content img { max-width: 100%; max-height: 90vh; border-radius: 8px; }
        .photo-modal-close { position: absolute; top: -40px; right: 0; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; }
        
        .schedule-section { margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3b82f6; }
        .schedule-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 10px; }
        .schedule-header h4 { font-size: 14px; font-weight: 600; margin: 0; }
        .schedule-toggle { font-size: 16px; }
        .schedule-grid { display: grid; gap: 2px; margin-top: 15px; }
	    .schedule-hour { display: grid; grid-template-columns: 130px 1fr auto; gap: 0; align-items: stretch; background: white; border-radius: 4px; overflow: hidden; border: 1px solid #e5e7eb; transition: all 0.2s; }
        .schedule-hour:hover { border-color: #3b82f6; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1); }
        .schedule-time { display: flex; align-items: center; justify-content: center; background: #f9fafb; border-right: 2px solid #e5e7eb; padding: 12px 8px; }
        .schedule-time input { border: none; background: transparent; font-size: 13px; font-weight: 600; color: #374151; text-align: center; width: 100%; cursor: pointer; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .schedule-time input:focus { outline: none; }
        .schedule-activity { padding: 12px 15px; display: flex; align-items: center; }
        .schedule-activity input { border: none; background: transparent; font-size: 14px; color: #111827; width: 100%; }
        .schedule-activity input:focus { outline: none; }
        .schedule-activity input::placeholder { color: #9ca3af; }
        .schedule-actions { display: flex; align-items: center; padding: 0 10px; }
        .schedule-delete { background: transparent; color: #ef4444; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 16px; transition: all 0.2s; }
        .schedule-delete:hover { background: #fee; }
        .schedule-add-btn { width: 100%; padding: 12px; background: white; border: 2px dashed #cbd5e1; border-radius: 4px; color: #64748b; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;	margin-top: 10px; }
        .schedule-add-btn:hover { border-color: #3b82f6; color: #3b82f6; background: #f0f9ff; }
        .schedule-timeline { background: white; border-radius: 6px; border: 1px solid #e5e7eb; overflow: hidden; margin-top: 15px; }
        .timeline-hours { display: grid; grid-template-columns: 80px 1fr; }
        .timeline-hour-row { display: contents; }
        .timeline-hour-label { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; border-right: 2px solid #e5e7eb; background: #f9fafb; font-size: 12px; font-weight: 600; color: #6b7280; text-align: right; }
        .timeline-hour-cell { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; position: relative; min-height: 50px; cursor: pointer; transition: background 0.2s; }
        .timeline-hour-cell:hover { background: #f0f9ff; }
        .timeline-event { position: absolute; left: 5px; right: 5px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 10px; border-radius: 4px; font-size: 13px; cursor: pointer; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); transition: all 0.2s; z-index: 1; }        .timeline-event:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4); }
        .timeline-event-time { font-weight: 600; font-size: 11px; opacity: 0.9; margin-bottom: 2px; }
        .timeline-event-title { font-size: 13px; line-height: 1.3; }
        .timeline-event-delete { position: absolute; top: 4px; right: 4px; background: rgba(255, 255, 255, 0.3); border: none; border-radius: 3px; padding: 2px 6px; font-size: 11px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .timeline-event:hover .timeline-event-delete { opacity: 1; }
        .timeline-event-delete:hover { background: rgba(255, 255, 255, 0.5); }
        .schedule-view-toggle { display: flex; gap: 8px; margin-bottom: 10px; }
        .schedule-view-btn { padding: 6px 14px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; color: #64748b; transition: all 0.2s; }
        .schedule-view-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .schedule-view-btn:hover:not(.active) { border-color: #3b82f6; color: #3b82f6; }

	    .subtitle-edit { border: 2px solid #3b82f6; border-radius: 4px; padding: 6px 10px; font-size: 15px; width: 100%; margin-top: 8px; }
        .trip-notes-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .trip-notes-section h3 { font-size: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .trip-notes-section textarea { width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical; }

        .category-budget-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .category-budget-section h3 { font-size: 16px; margin-bottom: 15px; }
        .category-budget-item { margin-bottom: 20px; }
        .category-budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .category-budget-label { font-size: 14px; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 8px; }
        .category-budget-amount { font-size: 14px; color: #6b7280; }
        .category-budget-input { width: 120px; padding: 4px 8px; border: 2px solid #3b82f6; border-radius: 4px; font-size: 14px; font-weight: 600; }
        .category-budget-bar { width: 100%; height: 24px; background: #f3f4f6; border-radius: 12px; overflow: hidden; position: relative; }
        .category-budget-fill { height: 100%; transition: width 0.3s; position: relative; display: flex; align-items: center; padding: 0 10px; font-size: 12px; font-weight: 600; color: white; }
        .category-budget-fill.low { background: linear-gradient(90deg, #10b981, #059669); }
        .category-budget-fill.medium { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .category-budget-fill.high { background: linear-gradient(90deg, #ef4444, #dc2626); }

        .travelers-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .travelers-section h3 { font-size: 16px; margin-bottom: 15px; }
        .traveler-count { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .traveler-count-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #3b82f6; background: white; color: #3b82f6; font-size: 20px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .traveler-count-btn:hover { background: #3b82f6; color: white; }
        .traveler-count-display { font-size: 24px; font-weight: 600; min-width: 60px; text-align: center; }
        .traveler-list { display: grid; gap: 10px; margin-top: 15px; }
        .traveler-item { display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; }
        .traveler-item input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .cost-split-toggle { margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 6px; }
        .cost-split-option { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
        .cost-split-option input[type="radio"] { width: 18px; height: 18px; cursor: pointer; }
        .cost-split-option label { font-size: 14px; color: #374151; cursor: pointer; }
        .per-person-cost { display: inline-block; margin-left: 8px; padding: 2px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 12px; font-weight: 600; }
       
        .weather-section { background: white; padding: 15px; border-radius: 6px; border-left: 3px solid #3b82f6; margin-top: 15px; }
        .weather-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .weather-header h4 { font-size: 14px; font-weight: 600; margin: 0; }
        .weather-fetch-btn { background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s; }
        .weather-fetch-btn:hover { background: #2563eb; }
        .weather-fetch-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .weather-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .weather-card { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px; border-radius: 6px; text-align: center; }
        .weather-icon { font-size: 32px; margin-bottom: 5px; }
        .weather-temp { font-size: 20px; font-weight: 600; }
        .weather-desc { font-size: 11px; opacity: 0.9; margin-top: 4px; text-transform: capitalize; }
        .weather-error { color: #ef4444; font-size: 13px; padding: 10px; background: #fee2e2; border-radius: 4px; }
        .weather-loading { color: #666; font-size: 13px; font-style: italic; }

        .category-manager { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .category-manager h3 { font-size: 16px; margin-bottom: 15px; }
        .category-list { display: grid; gap: 10px; margin-bottom: 15px; }
        .category-item { display: grid; grid-template-columns: 50px 1fr 80px 100px auto; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; }
        .category-icon-picker { width: 40px; height: 40px; font-size: 20px; text-align: center; line-height: 40px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; }
        .category-color-picker { width: 60px; height: 30px; border: 2px solid #e5e7eb; border-radius: 4px; cursor: pointer; }
        .add-category-btn { width: 100%; padding: 12px; background: white; border: 2px dashed #cbd5e1; border-radius: 6px; color: #64748b; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .add-category-btn:hover { border-color: #3b82f6; color: #3b82f6; background: #f0f9ff; }
        .icon-picker-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; max-height: 500px; overflow-y: auto; }
        .icon-picker-modal.show { display: block; }
        .icon-picker-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; }
        .icon-picker-overlay.show { display: block; }
        .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 15px; }
        .icon-option { width: 50px; height: 50px; font-size: 24px; display: flex; align-items: center; justify-content: center; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .icon-option:hover { border-color: #3b82f6; background: #f0f9ff; transform: scale(1.1); }

        .tab-navigation { background: white; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; display: flex; overflow: hidden; }
        .tab-btn { flex: 1; padding: 15px 20px; background: white; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 16px; font-weight: 600; color: #6b7280; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn:hover { background: #f9fafb; color: #374151; }
        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; background: #f0f9ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .map-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .map-section h3 { font-size: 16px; margin-bottom: 15px; }
        .map-container { width: 100%; height: 500px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; }
        .map-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .map-btn { padding: 8px 16px; background: white; border: 2px solid #3b82f6; color: #3b82f6; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; }
        .map-btn:hover { background: #3b82f6; color: white; }
        .map-btn.active { background: #3b82f6; color: white; }
        .route-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .route-stat-card { background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 3px solid #3b82f6; }
        .route-stat-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .route-stat-value { font-size: 20px; font-weight: 600; color: #111; }
        .location-marker-popup { font-size: 13px; }
        .location-marker-popup strong { display: block; margin-bottom: 5px; font-size: 14px; }
        .map-loading { padding: 20px; text-align: center; color: #666; font-style: italic; }
        .route-arrow { 
            background: none !important; 
            border: none !important; 
            font-size: 20px; 
            color: #3b82f6; 
            text-shadow: 0 0 3px white;
        }

        .location-item { display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #3b82f6; cursor: move; }
        .location-item.dragging { opacity: 0.5; }
        .location-item.drag-over { border-top: 3px solid #3b82f6; }

        .checklist-item {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .checklist-item.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        .checklist-item.drag-over {
            background-color: #e3f2fd;
            border-top: 2px solid #3b82f6;
        }

        @media print {
            .control-bar, .toggle, .converter, .daily-budget, .edit-btn, .btn, .photo-upload, .photo-delete, .search-bar, .day-control-btn, .tab-navigation { display: none !important; }
            .tab-content { display: block !important; }
            .day-card { page-break-inside: avoid; }
            .details { display: block !important; }
            .chart-content { display: block !important; }
            .schedule-grid, .schedule-timeline { display: block !important; }
            .day-header { cursor: default !important; }
        }

        .receipt-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .receipt-upload {
            margin-bottom: 15px;
        }
        .receipt-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .receipt-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .receipt-details {
            flex: 1;
        }
        .receipt-details input,
        .receipt-details select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .receipt-analytics {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .receipt-header:hover {
            background: #f3f4f6;
        }
        .receipt-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }


        .gallery-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .gallery-view-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .gallery-view-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        .gallery-view-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        .gallery-timeline {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .gallery-day-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .gallery-day-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .gallery-day-header h3 {
            margin: 0 0 5px 0;
            font-size: 20px;
            color: #1f2937;
        }
        .gallery-day-location {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .gallery-photo-count {
            font-size: 12px;
            color: #9ca3af;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .gallery-grid-all {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .gallery-photo-item {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .gallery-photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .gallery-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gallery-photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 15px 10px 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .gallery-photo-item:hover .gallery-photo-overlay {
            opacity: 1;
        }
        .gallery-photo-day {
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .gallery-photo-location {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
        }
        .gallery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .photo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .photo-header:hover {
            background: #f3f4f6;
        }
        .photo-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }


        .trip-manager-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .trip-manager-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .trip-comparison-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        .trip-comparison-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr 1.5fr 1.5fr 1fr;
            gap: 15px;
            padding: 12px 15px;
            background: #f9fafb;
            font-weight: 600;
            font-size: 13px;
            color: #6b7280;
            text-transform: uppercase;
        }
        .trip-comparison-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr 1.5fr 1.5fr 1fr;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: background 0.2s;
        }
        .trip-comparison-row:hover {
            background: #f9fafb;
        }
        .trip-comparison-row.current {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
        }
        .trip-list {
            display: grid;
            gap: 15px;
        }
        .trip-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }
        .trip-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        .trip-card.current-trip {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .trip-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .current-badge {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .trip-card-info {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        .trip-card-dates {
            font-size: 13px;
            color: #999;
            margin-bottom: 15px;
        }
        .trip-card-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .trip-comparison-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
        }

        .trends-chart {
            min-height: 200px;
        }
        .comparison-card {
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .comparison-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .comparison-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .comparison-sub {
            font-size: 13px;
            opacity: 0.8;
        }
        .timeline-container {
            padding: 20px 10px;
        }
        .timeline-item {
            display: grid;
            grid-template-columns: 40px 1fr;
            gap: 20px;
            margin-bottom: 10px;
        }
        .timeline-marker {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .timeline-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #e0e0e0;
            z-index: 1;
            transition: all 0.3s;
        }
        .timeline-item.completed .timeline-dot {
            background: #10b981;
            box-shadow: 0 0 0 2px #10b981;
        }
        .timeline-line {
            width: 2px;
            flex: 1;
            background: #e0e0e0;
            margin-top: 4px;
        }
        .timeline-item.completed .timeline-line {
            background: linear-gradient(to bottom, #10b981, #e0e0e0);
        }
        .timeline-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #e0e0e0;
            transition: all 0.3s;
        }
        .timeline-item.completed .timeline-content {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .timeline-content:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }
        .timeline-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .timeline-location {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 6px;
        }
        .timeline-spending {
            font-size: 14px;
            color: #3b82f6;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .timeline-note {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }


        .export-menu {
            margin-top: 15px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        .export-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 15px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }
        .export-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        .export-btn:active {
            transform: translateY(0);
        }
        @media print {
            body * {
                visibility: hidden;
            }
            
            #app, #app * {
                visibility: visible;
            }
            
            #app {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .header-btn, .btn, .edit-btn, .tab-navigation, 
            .control-bar, .export-menu, .map-section,
            .photo-modal, .search-bar {
                display: none !important;
            }
            
            .day-card {
                background: white;
                margin-bottom: 15px;
                border-radius: 12px; /* Rounder corners */
                border: none; /* Remove border */
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); /* Subtle shadow */
                transition: all 0.2s ease;
                overflow: hidden;
            }

            .day-card:hover {
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12); /* Lift on hover */
                transform: translateY(-2px);
            }

            .day-card.done {
                opacity: 0.8;
                border-left: 4px solid #10b981;
                background: linear-gradient(to right, #f0fdf4 0%, white 10%); /* Subtle green tint */
            }
            
            .stats {
                page-break-after: avoid;
            }
        }
        

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .trip-selector {
            padding: 8px 12px;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            max-width: 200px;
        }
        .header-button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .header-grid-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 10px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 70px;
            height: 70px;
        }
        .header-grid-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }
        .header-grid-btn .btn-icon {
            font-size: 24px;
        }
        .header-grid-btn .btn-label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
        }

        /* Settings Full Page */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: fadeIn 0.2s;
        }
        .settings-page {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: min(600px, 100%);
            background: white;
            z-index: 2001;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            animation: slideInRight 0.3s;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #e5e7eb;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .settings-header h2 {
            color: white;
        }
        .settings-menu-grid {
            display: grid;
            gap: 15px;
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        .settings-menu-card {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
            padding: 25px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .settings-menu-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        .settings-card-icon {
            font-size: 36px;
        }
        .settings-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .settings-card-desc {
            font-size: 13px;
            color: #6b7280;
        }
        .settings-card-arrow {
            font-size: 24px;
            color: #9ca3af;
        }
        .settings-content-page {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            margin: 20px 30px 0;
            background: #f3f4f6;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        .back-button:hover {
            background: #e5e7eb;
        }
        .settings-form-group {
            margin-bottom: 30px;
        }
        .settings-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
            color: #374151;
        }
        .settings-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }
        .settings-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .info-box {
            padding: 15px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            line-height: 1.6;
        }

        /* Analytics Cards Section */
        .analytics-cards-section {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .analytics-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .analytics-card {
            background: white;
            border: none; /* Remove border */
            border-radius: 16px;
            padding: 28px 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }
        /* Add decorative blob */
        .analytics-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1), transparent);
            border-radius: 50%;
            transition: all 0.3s;
        }
        .analytics-card:hover {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
        }
        .analytics-card:hover::before {
            transform: scale(1.2);
        }
        .analytics-card-icon {
            font-size: 40px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        .analytics-card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }
        .analytics-card-desc {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }
        .analytics-card-arrow {
            font-size: 20px;
            color: #9ca3af;
        }

        /* Analytics Page - Centered Modal */
        .analytics-page {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(1000px, 90vw);
            max-height: 85vh;
            background: white;
            z-index: 2001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            animation: modalZoomIn 0.3s;
            overflow: hidden;
        }

        @keyframes modalZoomIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            gap: 20px;
            border-radius: 12px 12px 0 0;
        }

        .analytics-content {
            flex: 1;
            overflow-y: auto;
            background: #f9fafb;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #6b7280;
        }
        .empty-state h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #1f2937;
        }
        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* Export Page */
        .export-page {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: min(800px, 100%);
            background: white;
            z-index: 2001;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            animation: slideInRight 0.3s;
        }

        .export-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            gap: 20px;
        }

        .export-page-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f9fafb;
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .export-option-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 30px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .export-option-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
        }

        .export-card-icon {
            font-size: 48px;
        }

        .export-card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .export-card-desc {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        /* Day Activities Cards */
        .day-activities-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .day-activity-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 15px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .day-activity-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .day-card-icon {
            font-size: 28px;
        }

        .day-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .day-card-badge {
            font-size: 12px;
            color: #6b7280;
            padding: 4px 10px;
            background: #f3f4f6;
            border-radius: 12px;
        }

        /* Day Section Page */
        .day-section-page {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: min(900px, 100%);
            background: white;
            z-index: 2001;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            animation: slideInRight 0.3s;
        }

        .day-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            gap: 15px;
        }

        .day-section-content {
            flex: 1;
            overflow-y: auto;
            background: #f9fafb;
        }

        .timeline-hour-row {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 15px;
            border-bottom: 1px solid #f0f0f0;
            min-height: 60px;
        }

        .timeline-hour-row:last-child {
            border-bottom: none;
        }

        .timeline-hour-label {
            padding: 10px 0;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }

        .timeline-hour-cell {
            padding: 10px 0;
            cursor: pointer;
            position: relative;
            min-height: 60px;
        }

        .timeline-hour-cell:hover {
            background: #f9fafb;
        }

        .timeline-hours {
            display: flex;
            flex-direction: column;
        }

        .event-drag-handle {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .timeline-event:hover .event-drag-handle {
            opacity: 1;
        }

        .event-drag-handle:hover {
            background: rgba(255,255,255,0.3) !important;
        }

        .timeline-event {
            user-select: none;
        }

        /* Custom Modal System */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            animation: fadeIn 0.2s;
        }

        .custom-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            min-width: 400px;
            max-width: 500px;
            animation: slideUp 0.3s;
        }

        .custom-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 2px solid #f0f0f0;
        }

        .custom-modal-body {
            padding: 25px;
        }

        .custom-modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px 25px;
            border-top: 2px solid #f0f0f0;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-btn-cancel:hover {
            background: #d1d5db;
        }

        .modal-btn-confirm {
            background: #3b82f6;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #2563eb;
        }

        /* Day Activities Grid */
        .day-activities-grid {
            margin: 20px 0;
        }

        .category-card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .category-card, .notes-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            min-height: 180px;
        }

        .category-card:hover, .notes-card:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .notes-card {
            grid-column: 1 / -1; /* Makes notes card span full width */
            background: #ffffff;
            border-color: #f59e0b;
        }

        .category-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .category-card-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
        }

        .category-card-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
        }

        .category-card-content {
            flex: 1;
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 15px;
            
            /* Modern line clamping */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            
            /* Standard property for future browsers */
            line-clamp: 3;
            max-lines: 3;
            
            /* Fallback for very old browsers */
            max-height: 4.5em;
            position: relative;
        }

        /* Optional: Add gradient fade for browsers without proper ellipsis */
        @supports not ((-webkit-line-clamp: 3) or (line-clamp: 3)) {
            .category-card-content::after {
                content: '';
                position: absolute;
                bottom: 0;
                right: 0;
                width: 40px;
                height: 1.5em;
                background: linear-gradient(to right, transparent, #f9fafb 70%);
                pointer-events: none;
            }
        }

        .category-card-cost {
            font-size: 14px;
        }

        .planned-cost {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .actual-cost {
            font-size: 13px;
            color: #10b981;
            font-weight: 600;
        }

        /* Today Tab Styles */
        .today-hero {
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .today-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .today-action-card {
            background: white;
            padding: 25px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .today-action-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }


        /* Edit Link Style */
        .edit-day-link {
            color: #3b82f6;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            text-decoration: none;
            border: 1px solid transparent;
        }
        .edit-day-link:hover {
            background: #f0f9ff;
            border-color: #dbeafe;
        }

        /* Save Button Style */
        .save-edit-btn {
            color: #3b82f6;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .save-edit-btn:hover {
            background: #f0f9ff;
            border-color: #dbeafe;      
        }

        /* Toast Notifications - Professional Feedback */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10001;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
        }

        .toast.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
        }

        .toast.info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
        }

        /* Floating Action Button - Professional Pattern */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            z-index: 1000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .fab:active {
            transform: scale(0.9);
        }

        /* Pull to Refresh - Native-like Loading */
        .pull-to-refresh {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: top 0.3s;
            z-index: 9999;
        }

        .pull-to-refresh.pulling {
            top: 20px;
        }

        .pull-to-refresh-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f0f0f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .fab {
                display: flex; /* Show on mobile */
            }
        }

        /* Swipeable Cards - iOS-style Interaction */
        .swipeable-card {
            position: relative;
            touch-action: pan-y;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .swipeable-card.swiping {
            transition: none;
        }

        /* ============================================ */
        /* MOBILE STYLES - CONSOLIDATED - DO NOT DUPLICATE */
        /* ============================================ */
        @media (max-width: 768px) {
            /* Force everything to respect viewport */
            body {
                padding: 10px !important;
                overflow-x: hidden !important;
            }
            
            .container {
                max-width: 900px;
                margin: 0 auto;
                padding: 0 20px; /* Add horizontal padding */
            }

            /* Better section spacing */
            .stats,
            .chart-container,
            .category-budget-section,
            .map-section {
                margin-bottom: 32px; /* More breathing room */
            }
            /* Card internal spacing */
            .stat-card,
            .day-card,
            .analytics-card {
                padding: 24px; /* Consistent padding */
            }
            /* Better gap in grids */
            .stats,
            .analytics-cards-grid {
                gap: 20px; /* More space between cards */
            }
            
            /* ===== HEADER ===== */
            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 40px;
                margin-bottom: 30px;
                border-radius: 16px; /* Rounder */
                border: none; /* Remove left border */
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2); /* Purple glow */
                color: white;
            }
            
            .header h1 {
                font-size: 32px;
                font-weight: 700;
                margin-bottom: 8px;
                color: white; /* White text on gradient */
            }
            
            .header .subtitle {
                color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
                font-size: 15px;
            }
            
            .header > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 15px !important;
            }
            
            .header-actions {
                width: 100% !important;
                flex-direction: column !important;
                align-items: stretch !important;
            }
            
            .trip-selector {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .header-button-grid {
                width: 100%;
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 5px !important;
            }
            
            .header-grid-btn {
                padding: 8px 4px !important;
                min-width: 0 !important;
                height: 60px !important;
            }
            
            .header-grid-btn .btn-icon {
                font-size: 18px !important;
            }
            
            .header-grid-btn .btn-label {
                font-size: 9px !important;
            }

                .header {
                    position: sticky;
                    top: 0;
                    z-index: 100;
                    margin-bottom: 15px;
                    border-radius: 0 0 12px 12px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    padding: 20px 15px; /* Smaller default padding on mobile */
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }
                
                /* When scrolled - compact mode */
                .header.scrolled {
                    padding: 12px 15px !important;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                }
                
                /* Title - show/hide elements based on scroll */
                .header h1 {
                    font-size: 20px !important;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    margin-bottom: 8px;
                }
                
                .header.scrolled h1 {
                    font-size: 16px !important;
                    margin-bottom: 0 !important;
                }
                
                /* Subtitle - hide when scrolled */
                .header .subtitle {
                    opacity: 1;
                    max-height: 50px;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    overflow: hidden;
                }
                
                .header.scrolled .subtitle {
                    opacity: 0;
                    max-height: 0;
                    margin: 0 !important;
                }
                
                /* Header actions - hide when scrolled */
                .header-actions {
                    opacity: 1;
                    max-height: 200px;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    overflow: hidden;
                }
                
                .header.scrolled .header-actions {
                    opacity: 0;
                    max-height: 0;
                    margin: 0 !important;
                }
                
                /* Container for title that stays visible */
                .header > div:first-child {
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }

                .header::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 40px;
                    height: 4px;
                    background: rgba(0, 0, 0, 0.1);
                    border-radius: 2px 2px 0 0;
                    transition: opacity 0.3s;
                }
                
                .header.scrolled::after {
                    opacity: 0;
                }
            
            /* ===== STATS CARDS ===== */
            .stats {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .stat-card {
                background: white;
                padding: 24px;
                border-radius: 16px;
                border: none; /* Remove border */
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                position: relative;
                overflow: hidden;
            }

            .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                width: 100px;
                height: 100px;
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent);
                border-radius: 0 16px 0 50%;
            }
            
            .stat-card.blue {
                background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                border: 1px solid #bfdbfe;
            }

            .stat-card.red {
                background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
                border: 1px solid #fecaca;
            }

            .stat-card.green {
                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                border: 1px solid #bbf7d0;
            }

            .stat-value {
                font-size: 32px; /* Bigger */
                font-weight: 700; /* Bolder */
                background: linear-gradient(135deg, #1f2937, #3b82f6); /* Gradient text */
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            /* ===== DAY CARDS - THE BIG FIX ===== */
            .day-card {
                margin-bottom: 15px;
                overflow: hidden;
            }
            
            .day-header {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                justify-content: flex-start !important;
                gap: 10px !important;
                padding: 12px !important;
            }
            
            .day-info {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                gap: 10px !important;
                width: 100% !important;
            }
            
            .day-title {
                flex: 1;
                min-width: 0;
            }
            
            .day-title h3 {
                font-size: 15px !important;
                margin: 0 !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .day-title .date {
                font-size: 12px !important;
            }
            
            .day-cost {
                width: 100% !important;
                text-align: left !important;
                padding-top: 10px !important;
                border-top: 1px solid #e0e0e0 !important;
            }
            
            .day-cost .amount {
                font-size: 16px !important;
            }
            
            .day-cost .usd {
                font-size: 12px !important;
            }
            
            /* ===== CATEGORY CARDS IN DAY DETAILS ===== */
            .day-activities-grid {
                display: block !important;
            }
            
            .category-card-grid {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .category-card,
            .notes-card {
                width: 100% !important;
                min-height: auto !important;
            }
            
            .day-activities-cards {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .day-activity-card {
                padding: 12px 8px !important;
                min-width: 0 !important;
            }
            
            .day-card-icon {
                font-size: 20px !important;
            }
            
            .day-card-title {
                font-size: 11px !important;
            }
            
            .day-card-badge {
                font-size: 9px !important;
                padding: 2px 6px !important;
            }
            
            /* ===== TAB NAVIGATION ===== */
            .tab-navigation {
                display: flex !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: none !important;
            }
            
            .tab-navigation::-webkit-scrollbar {
                display: none !important;
            }
            
            .tab-btn {
                flex: 0 0 auto !important;
                min-width: 110px !important;
                font-size: 12px !important;
                padding: 10px 12px !important;
                white-space: nowrap !important;
            }
            
            /* ===== ANALYTICS CARDS SECTION ===== */
            .analytics-cards-section {
                margin: 20px 0 !important;
                padding: 15px !important;
            }
            
            .analytics-cards-section h3 {
                font-size: 18px !important;
                margin-bottom: 15px !important;
            }
            
            .analytics-cards-grid {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .analytics-card {
                display: grid !important;
                grid-template-columns: auto 1fr !important;
                grid-template-rows: auto !important;
                gap: 12px !important;
                padding: 15px !important;
            }
            
            .analytics-card-icon {
                font-size: 28px !important;
                grid-row: 1 / 2;
            }
            
            .analytics-card-title {
                font-size: 15px !important;
                grid-row: 1;
                grid-column: 2;
            }
            
            .analytics-card-desc {
                font-size: 12px !important;
                grid-row: 2;
                grid-column: 1 / -1;
            }
            
            .analytics-card-arrow {
                display: none !important;
            }
            
            /* ===== ALL GRIDS ===== */
            .grid,
            .export-grid,
            .route-stats,
            .converter-inputs {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .converter-swap {
                transform: rotate(90deg);
            }
            
            .gallery-grid,
            .gallery-grid-all {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .gallery-controls {
                flex-direction: column;
            }
            
            .gallery-view-btn {
                width: 100%;
            }
            
            .photo-gallery {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            
            /* ===== MAP ===== */
            .map-section {
                overflow: hidden;
            }
            
            .map-container {
                width: 100% !important;
                height: 250px !important;
                touch-action: pan-y !important;
            }
            
            .map-controls {
                display: flex !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                gap: 5px !important;
            }
            
            .map-btn {
                flex: 0 0 auto !important;
                white-space: nowrap !important;
                font-size: 11px !important;
                padding: 6px 10px !important;
            }
            
            /* ===== MODALS - CRITICAL FIX FOR POSITION ===== */
            
            /* Small centered modals */
            .custom-modal::before {
                content: '';
                position: absolute;
                top: 12px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: #cbd5e1;
                border-radius: 2px;
            }
            
            .custom-modal-header {
                padding-top: 28px !important; /* Make room for handle */
            }

            .custom-modal::before {
                content: '';
                position: absolute;
                top: 12px;
                left: 50%; 
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: #cbd5e1;
                border-radius: 2px;
            }
            
            .custom-modal-header {
                padding-top: 28px !important; /* Make room for handle */
            }

            
            .custom-modal-body {
                max-height: 50vh !important;
                overflow-y: auto !important;
            }
            
            /* Side sliding modals - Full screen */
            .settings-page,
            .day-section-page,
            .export-page {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                max-width: 100vw !important;
                height: 100vh !important;
                transform: translateX(0) !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* Centered modals - Full screen with scroll */
            .analytics-page {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 90vh !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .analytics-header,
            .export-page-header,
            .day-section-header,
            .settings-header {
                flex-shrink: 0 !important;
                padding: 15px 20px !important;
            }
            
            .analytics-header h2,
            .export-page-header h2,
            .day-section-header h2,
            .settings-header h2 {
                font-size: 18px !important;
            }
            
            .analytics-content,
            .export-page-content,
            .day-section-content,
            .settings-menu-grid,
            .settings-content-page {
                flex: 1 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 15px !important;
            }
            
            /* Trip manager modal */
            .trip-manager-modal {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
                margin: 0 !important;
                padding: 20px !important;
            }
            
            /* Back buttons in modals */
            .back-button {
                margin: 10px 20px !important;
                padding: 8px 16px !important;
                font-size: 13px !important;
            }
            
            /* ===== SCHEDULE ===== */
            .schedule-hour {
                grid-template-columns: 100px 1fr auto !important;
                gap: 8px;
            }
            
            .schedule-time input {
                font-size: 12px;
            }
            
            /* ===== SEARCH ===== */
            .search-bar {
                padding: 10px 15px;
            }
            
            .search-input {
                font-size: 14px;
                padding: 10px 50px 10px 12px;
            }
            
            /* ===== TODAY TAB ===== */
            .today-hero {
                padding: 30px 20px;
            }
            
            .today-hero h1 {
                font-size: 24px;
            }
            
            .today-hero p {
                font-size: 16px;
            }
            
            /* ===== TRIP MANAGER ===== */
            .trip-comparison-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .trip-comparison-header,
            .trip-comparison-row {
                min-width: 600px;
                font-size: 11px;
                gap: 8px;
                padding: 10px;
            }
            
            /* ===== RECEIPTS ===== */
            .receipt-item {
                grid-template-columns: 1fr !important;
                flex-direction: column;
            }
            
            .receipt-details {
                grid-template-columns: 1fr !important;
            }
            
            /* ===== WEATHER ===== */
            .weather-display {
                grid-template-columns: 1fr !important;
            }
            
            /* ===== CHECKLISTS ===== */
            .checklist-item {
                flex-direction: column;
                align-items: stretch !important;
                gap: 8px;
            }
            
            .checklist-item input[type="text"] {
                width: 100% !important;
            }
            
            /* ===== CHARTS & TRENDS ===== */
            .trends-chart,
            .chart,
            .chart-bar {
                width: 100% !important;
                overflow-x: auto !important;
            }
            
            .chart-label {
                min-width: 80px !important;
                font-size: 11px !important;
            }
            
            .chart-value {
                min-width: 70px !important;
                font-size: 11px !important;
            }
            
            /* ===== PREVENT INPUT ZOOM ON iOS ===== */
            input,
            select,
            textarea {
                font-size: 16px !important;
            }
            
            /* ===== TOUCH TARGETS ===== */
            .btn,
            .header-btn,
            .edit-btn,
            .modal-btn {
                min-height: 44px;
                padding: 10px 16px;
                font-size: 14px !important;
            }
            
            .day-check,
            input[type="checkbox"] {
                min-width: 24px;
                min-height: 24px;
            }
            
            /* ===== PREVENT OVERFLOW ===== */
            .section-content {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            input[type="text"],
            input[type="number"],
            textarea {
                max-width: 100%;
            }
            
            /* ===== CATEGORY/NOTES MODAL FIX ===== */
            .custom-modal .custom-modal-body input,
            .custom-modal .custom-modal-body textarea {
                width: 100% !important;
                max-width: 100% !important;
            }
            /* ===== APP-LIKE IMPROVEMENTS ===== */

            /* Smooth scrolling everywhere */
            * {
                -webkit-overflow-scrolling: touch !important;
            }

            /* Remove tap highlight */
            * {
                -webkit-tap-highlight-color: transparent !important;
            }

            /* Better button press feedback */
            .btn:active,
            .header-btn:active,
            .analytics-card:active,
            .day-activity-card:active,
            .tab-btn:active {
                transform: scale(0.97) !important;
                transition: transform 0.1s !important;
            }

            /* Sticky header on scroll */
            .header {
                position: sticky !important;
                top: 0 !important;
                z-index: 100 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }

            /* Pull-to-refresh hint */
            body::before {
                content: '';
                position: fixed;
                top: -50px;
                left: 0;
                right: 0;
                height: 50px;
                background: linear-gradient(180deg, rgba(59,130,246,0.1), transparent);
                pointer-events: none;
            }

            /* Better card shadows on mobile */
            .day-card,
            .stat-card,
            .analytics-card,
            .today-card {
                box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
            }

            .day-card:active,
            .analytics-card:active {
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            }

            /* iOS-style swipe indicators */
            .tab-navigation::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to left, white, transparent);
                pointer-events: none;
            }

            /* Safe area insets for iPhone notch */
            @supports (padding: max(0px)) {
                body {
                    padding-left: max(10px, env(safe-area-inset-left)) !important;
                    padding-right: max(10px, env(safe-area-inset-right)) !important;
                    padding-bottom: max(10px, env(safe-area-inset-bottom)) !important;
                }
            }
                .custom-modal {
                position: fixed !important;
                top: auto !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                transform: none !important;
                border-radius: 20px 20px 0 0 !important;
                max-height: 85vh !important;
                min-width: 100% !important;
                max-width: 100% !important;
                animation: slideUpFromBottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }


            @keyframes slideUpFromBottom {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }

            .btn:active,
            .header-btn:active,
            .modal-btn:active,
            .analytics-card:active,
            .day-activity-card:active,
            .tab-btn:active {
                transform: scale(0.97) !important;
                opacity: 0.8;
                transition: transform 0.1s, opacity 0.1s !important;
            }
            
            /* Remove tap highlight color */
            * {
                -webkit-tap-highlight-color: transparent !important;
            }
            
            /* Better card interactions */
            .day-card,
            .analytics-card,
            .category-card {
                background: white;
                border: none; /* Remove border */
                border-radius: 16px;
                padding: 24px;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
                position: relative;
                overflow: hidden;
            }
            /* Add gradient overlay based on category color */
            .category-card::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, var(--category-color), transparent);
            }
            .category-card:hover {
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
                transform: translateY(-2px);
            }
            .category-card-icon {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
        }


    </style>
</head>
<body>
    <div class="container" id="app"></div>
    <script>
        let renderTimeout = null;
        const debouncedRender = () => {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(render, 50);
        };

        const DEFAULT_CATEGORIES = [
            {id: 'acc', name: 'Accommodation', icon: '', color: '#ef4444'},
            {id: 'trn', name: 'Transportation', icon: '', color: '#3b82f6'},
            {id: 'food', name: 'Food', icon: '', color: '#10b981'},
            {id: 'act', name: 'Activities', icon: '', color: '#f59e0b'}
        ];

        const DATA = {
            budget: 5000,
            rate: 155,
            currency: 'JPY',
            currencySymbol: '',
            liveRate: true,
            lastFetchedRate: null,
            tripStartDate: '2026-06-18',
            tripEndDate: '2026-08-11',
            categories: [
                {id: 'acc', name: 'Accommodation', icon: '', color: '#3b82f6'},
                {id: 'trn', name: 'Transportation', icon: '', color: '#8b5cf6'},
                {id: 'food', name: 'Food', icon: '', color: '#f59e0b'},
                {id: 'act', name: 'Activities', icon: '', color: '#10b981'}
            ],
            categoryBudgets: {},
            showCategoryManager: false,
            iconPickerOpen: false,
            iconPickerCategory: null,
            expanded: null,
            editing: null,
            editTitle: false,
            tripTitle: 'Japan Trip 2026 - Budget & Itinerary',
            tripSubtitle: 'June 18 - August 11, 2026',
            tripNotes: '',
            packingList: [],
            editPackingList: false,
            categoryBudgets: {
                acc: 0,
                trn: 0,
                food: 0,
                act: 0
            },
            travelers: ['Traveler 1'],
            travelerCount: 1,
            costSplitMode: 'total', // 'total', 'perPerson', or 'shared'
            showTravelers: false,
            showTravelerList: false,
            editCategoryBudget: null,
            showEst: false,
            editBudget: false,
            editRate: false,
            editBeforeChecklist: false,
            editTripChecklist: false,
            converterUSD: 100,
            converterYEN: 15500,
            searchQuery: '',
            searchResults: [],
            showSearchResults: false,
            searchMode: 'enter',
            chartView: 'planned',
            showDailyBudget: false,
            showChart: false,
            showChartAcc: false,
            showChartTrn: false,
            showChartFood: false,
            showChartAct: false,
            photoModal: null,
            activeTab: 'planning', // or 'itinerary'
            showMap: false,
            mapInitialized: false,
            mapView: 'all', // 'all', 'route', or 'clusters'
            geocodedLocations: {}, // Cache geocoded locations
            locationOrder: {},
            beforeChecklist: [{item: 'Book flights', checked: false}, {item: 'Get travel insurance', checked: false}],
            tripChecklist: [{item: 'Charge electronics', checked: false}, {item: 'Pack passport', checked: false}],
            receipts: [], // Array of receipt objects per day
            showReceipts: false,
            editingCategoryModal: null, // e.g., {dayIndex: 0, category: 'acc'}
            editingNotesModal: null, // e.g., {dayIndex: 0}
            // Add to your DATA object initialization
            customWaypoints: [],
            mapEditMode: false,
            draggableMarkers: {},
            editingLocation: null,
            locationOrder: {},
            

            days: [
                {d:1,dt:'6-18-2026',loc:'Tokyo  Okayama',acc:{n:'ARK Hotel Okayama (3n)',p:19200},trn:{d:'Bullet train ~8:30',p:20000},food:{d:'Conbini/local',p:1000},act:{d:'Land 2:10pm, train to Okayama, check in, izakaya dinner',p:0},note:'First day - take it easy',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:2,dt:'6-19-2026',loc:'Okayama',acc:{n:'ARK Hotel Okayama',p:0},trn:{d:'Local transport',p:500},food:{d:'Hotel breakfast, local',p:2000},act:{d:'Okayama Castle and Korakuen Gardens. Closes 5:30pm',p:640},note:'Castle beautiful, allow 3-4hrs',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:3,dt:'6-20-2026',loc:'Okayama',acc:{n:'ARK Hotel Okayama',p:0},trn:{d:'Local transport',p:500},food:{d:'Hotel breakfast',p:0},act:{d:'Kibiji bike path - bike rental',p:1500},note:'Beautiful bike ride',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:4,dt:'6-21-2026',loc:'Kurashiki  Takamatsu',acc:{n:'Hostel Jaq Takamatsu (2n)',p:6842},trn:{d:'OkayamaKurashiki 330, KurashikiUno 800, Ferry',p:1810},food:{d:'Local/conbini',p:2000},act:{d:'Kurashiki: Canal Area, Historical Quarter',p:0},note:'Timing tight',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:5,dt:'6-22-2026',loc:'Takamatsu',acc:{n:'Hostel Jaq Takamatsu',p:0},trn:{d:'Local transport',p:0},food:{d:'Breakfast, Sanuki udon',p:1000},act:{d:'Ritsurin Koen, Shikoku Mura museum',p:500},note:"One of Japan's best gardens",done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:6,dt:'6-23-2026',loc:'Takamatsu  Shodoshima',acc:{n:'Sen Guesthouse (2n)',p:10500},trn:{d:'Local, ferries, bus',p:2440},food:{d:'Conbini',p:0},act:{d:'Morning: Megijima & Takamatsu castle',p:200},note:'Plan ahead',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:7,dt:'6-24-2026',loc:'Shodoshima Island',acc:{n:'Sen Guesthouse',p:0},trn:{d:'Local buses',p:0},food:{d:'Local restaurants',p:1500},act:{d:'Monkey Park and Kankakei Gorge',p:2000},note:'Beautiful gorge',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:8,dt:'6-25-2026',loc:'Daisen-oki National Park',acc:{n:'Yonago Universal Hotel',p:4200},trn:{d:'Bus, Ferry, train (3H)',p:7300},food:{d:'Local',p:1500},act:{d:'Daisen-oki National Park',p:0},note:'Early start',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:9,dt:'6-26-2026',loc:'Tottori',acc:{n:'Tottori hostel',p:4500},trn:{d:'YonagoTottori',p:1700},food:{d:'Local',p:1500},act:{d:'Tottori sand dunes, Uradome Coast',p:0},note:'Famous sand dunes',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:10,dt:'6-27-2026',loc:'Himeji',acc:{n:'Hotel Livemax Himeji',p:5000},trn:{d:'TottoriHimeji, local',p:500},food:{d:'Local',p:1500},act:{d:'Himeji Castle and Kokoen Garden',p:0},note:'UNESCO castle',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:11,dt:'6-28-2026',loc:'Mount Seppiko',acc:{n:'Green Station Mt Seppiko',p:12000},trn:{d:'Local',p:500},food:{d:'Local',p:1500},act:{d:'Mt Seppiko full day hike 8-10hrs',p:0},note:'Challenging hike',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:12,dt:'6-29-2026',loc:'Kobe',acc:{n:'Capsule Inn Osaka',p:3000},trn:{d:'Bus to HimejiKobe',p:990},food:{d:'Kobe Gyudon',p:3000},act:{d:'Sorakuen Koen, Chinatown, Mt. Rokko',p:0},note:'Kobe beef!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:13,dt:'6-30-2026',loc:'Osaka',acc:{n:'Capsule Inn Osaka',p:2500},trn:{d:'KobeOsaka',p:400},food:{d:'Local food',p:1500},act:{d:'Minoo Park, Osaka Castle',p:600},note:'Beautiful waterfall',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:14,dt:'7-1-2026',loc:'Osaka',acc:{n:'Capsule Inn Osaka',p:2500},trn:{d:'Local',p:250},food:{d:'Local food',p:1500},act:{d:'Minami district',p:0},note:'Dotonbori at night',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:15,dt:'7-2-2026',loc:'Osaka',acc:{n:'Capsule Inn Osaka',p:2500},trn:{d:'Local',p:250},food:{d:'Local food',p:1500},act:{d:'Universal Studios Japan',p:8000},note:'Arrive early',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:16,dt:'7-3-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto (5n)',p:6000},trn:{d:'OsakaKyoto, local',p:1100},food:{d:'Hotel breakfast, local',p:1000},act:{d:'Nijo Castle, Kiyomizudera',p:1500},note:'Temple exploration',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:17,dt:'7-4-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto',p:6000},trn:{d:'Local',p:500},food:{d:'Hotel breakfast, local',p:1000},act:{d:"Ginkakuji, Philosopher's Path",p:500},note:'Canal walk',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:18,dt:'7-5-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto',p:6000},trn:{d:'Local',p:500},food:{d:'Hotel breakfast, local',p:1000},act:{d:'Fushimi Inari Shrine, bamboo forest',p:1000},note:'1000 torii gates',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:19,dt:'7-6-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto',p:6000},trn:{d:'Local',p:500},food:{d:'Hotel breakfast/conbini',p:500},act:{d:'Arashiyama, Yoshiminedera',p:1500},note:'Bamboo grove',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:20,dt:'7-7-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto',p:6000},trn:{d:'Local',p:500},food:{d:'Hotel breakfast, local',p:1000},act:{d:'Free day - explore more',p:0},note:'Catch up',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:21,dt:'7-8-2026',loc:'Maibara  Kanazawa',acc:{n:'Kanazawa Capsule Hotel',p:2500},trn:{d:'KyotoMaibaraKanazawa',p:8200},food:{d:'Local',p:1000},act:{d:'Mt. Ibuki day hike',p:0},note:'Long travel day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:22,dt:'7-9-2026',loc:'Kanazawa',acc:{n:'Kanazawa Capsule Hotel',p:2500},trn:{d:'Local transport',p:0},food:{d:'Local',p:1500},act:{d:'Kenrokuen, Nagamachi',p:500},note:'Great garden',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:23,dt:'7-10-2026',loc:'Takayama',acc:{n:'APA Hotel Takaoka (2n)',p:4000},trn:{d:'KanazawaTakayama round trip',p:13000},food:{d:'Local',p:2000},act:{d:'Hida Folk Village, Old Town',p:800},note:'Preserved town',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:24,dt:'7-11-2026',loc:'Kurobe',acc:{n:'APA Hotel Takaoka',p:4000},trn:{d:'TakaokaKurobe round trip',p:2400},food:{d:'Hotel breakfast',p:1000},act:{d:'Kurobe Gorge',p:2500},note:'Scenic railway',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:25,dt:'7-12-2026',loc:'Tateyama Alpine Route',acc:{n:'Hotel M Matsumoto',p:3500},trn:{d:'Alpine RouteMatsumoto',p:17500},food:{d:'Buy food before',p:2000},act:{d:'Tateyama Alpine Route - snow walls',p:0},note:'Epic day!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:26,dt:'7-13-2026',loc:'Shimosuwa',acc:{n:'Masuya Guesthouse (2d)',p:3500},trn:{d:'MatsumotoShimosuwa',p:500},food:{d:'Local',p:3000},act:{d:'Matsumoto Castle, onsens',p:0},note:'Relaxing onsen',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:27,dt:'7-14-2026',loc:'Shimosuwa',acc:{n:'Masuya Guesthouse',p:3500},trn:{d:'Bike rental',p:1000},food:{d:'Local',p:3000},act:{d:'Bike around Lake Suwa',p:0},note:'Lake views',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:28,dt:'7-15-2026',loc:'Nakasendo  Kawaguchiko',acc:{n:'Hotel Fuyokaku',p:5500},trn:{d:'ShimosuwaNakatsugawaFuji',p:11600},food:{d:'Local',p:2000},act:{d:'Nakasendo samurai trail',p:0},note:'Historic trail',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:29,dt:'7-16-2026',loc:'Mount Fuji',acc:{n:'Hotel Fuyokaku',p:5500},trn:{d:'Bus to Mt Fuji',p:3000},food:{d:'Local',p:2000},act:{d:'Climb Mount Fuji 6:30am',p:4000},note:'Epic! Warm clothes',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:30,dt:'7-17-2026',loc:'Kawaguchiko Lake',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'KawaguchikoTokyo',p:5700},food:{d:'Local',p:2000},act:{d:'Explore lakes, Oshino Hakkai',p:300},note:'Last Mt Fuji views',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:31,dt:'7-18-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:"Mom's Touch, local",p:3000},act:{d:'Tokyo Ramen St, Imperial Palace',p:2000},note:'Electric atmosphere!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:32,dt:'7-19-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Asakusa, Edo Museum, Skytree',p:5000},note:'Big day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:33,dt:'7-20-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Shibuya, Shinjuku, Gyoen',p:500},note:'Famous crossing',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:34,dt:'7-21-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Odaiba, temples',p:2000},note:'Waterfront',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:35,dt:'7-22-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Jinbocho, Kawagoe',p:2000},note:'Flexible day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:36,dt:'7-23-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Free day',p:2000},note:'Entertainment',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:37,dt:'7-24-2026',loc:'Tokyo  Hitachi',acc:{n:'Toyoko Inn Hitachi',p:5200},trn:{d:'TokyoHitachi',p:5000},food:{d:'Local',p:3000},act:{d:'Free morning, travel afternoon',p:0},note:'Travel day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:38,dt:'7-25-2026',loc:'Ibaraki',acc:{n:'Toyoko Inn Hitachi',p:5200},trn:{d:'Local',p:500},food:{d:'Local',p:2000},act:{d:'Hitachi Seaside Park',p:0},note:'Kochia bushes',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:39,dt:'7-26-2026',loc:'Northern Ibaraki',acc:{n:'Toyoko Inn Hitachi',p:5200},trn:{d:'Local',p:500},food:{d:'Local',p:2000},act:{d:'Hananuki Gorge, hiking',p:0},note:'Less touristy',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:40,dt:'7-27-2026',loc:'Daigo',acc:{n:'Hotel Okukujikan',p:9000},trn:{d:'HitachiDaigo',p:1700},food:{d:'Local',p:2000},act:{d:'Fukuroda Falls, onsens',p:0},note:'Waterfall',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:41,dt:'7-28-2026',loc:'Oyama & Utsunomiya',acc:{n:'Nikko area',p:0},trn:{d:'DaigoOyamaUtsunomiya',p:2900},food:{d:'Local',p:2000},act:{d:'Explore both cities',p:0},note:'City exploration',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:42,dt:'7-29-2026',loc:'Nikko',acc:{n:'Nikko accommodation',p:10000},trn:{d:'UtsunomiyaNikko',p:800},food:{d:'Local',p:2000},act:{d:'Toshogu Shrine, Kirifuri Falls',p:0},note:'UNESCO site',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:43,dt:'7-30-2026',loc:'Nikko',acc:{n:'Nikko accommodation',p:10000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Okunikko - waterfalls, lakes',p:0},note:'Lake Chuzenji',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:44,dt:'7-31-2026',loc:'Takasaki',acc:{n:'Hotel Select Inn',p:5000},trn:{d:'NikkoTakasaki',p:3000},food:{d:'Local',p:2000},act:{d:'Hodota Kofun-gun tomb',p:1300},note:'Ancient burial mounds',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:45,dt:'8-1-2026',loc:'Shima Onsen',acc:{n:'Shima Yamaguchikan',p:22000},trn:{d:'TakasakiShima Onsen',p:500},food:{d:'Ryokan included',p:0},act:{d:'BIRTHDAY! Onsens',p:1000},note:'BIRTHDAY!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:46,dt:'8-2-2026',loc:'Shima  Numata',acc:{n:'Minpaku Sarai Nikkoya',p:3000},trn:{d:'BusTakasakiNumata',p:1100},food:{d:'Local',p:2000},act:{d:'Stay late, public baths',p:0},note:'Last morning',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:47,dt:'8-3-2026',loc:'Oze National Park',acc:{n:'Minpaku Sarai Nikkoya',p:3000},trn:{d:'NumataOze bus',p:0},food:{d:'Local',p:2000},act:{d:'Oze hiking - marshlands',p:0},note:'Beautiful hiking',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:48,dt:'8-4-2026',loc:'Yonezawa',acc:{n:'Yonezawa accommodation',p:5000},trn:{d:'NumataYonezawa',p:900},food:{d:'Local ramen',p:2000},act:{d:'Rental bike, trails',p:1000},note:'Explore',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:49,dt:'8-5-2026',loc:'Muikamachi  Fukushima',acc:{n:'APA Fukushima',p:5000},trn:{d:'NumataMuikamachiTokamachi',p:2600},food:{d:'Local',p:1000},act:{d:'Bike to Untan, Kiyotsu Gorge',p:500},note:'Scenic gorge',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:50,dt:'8-6-2026',loc:'Takahata  Yamagata',acc:{n:'Yamagata APA',p:5500},trn:{d:'Trains and buses',p:2500},food:{d:'Local',p:2000},act:{d:'Day trip to Yamagata',p:0},note:'Rural Japan',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:51,dt:'8-7-2026',loc:'Yamagata',acc:{n:'Yamagata APA',p:5500},trn:{d:'Buses, local',p:1000},food:{d:'Local',p:2000},act:{d:'Mt Zao, Basho Museum',p:1000},note:'Crater lake',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:52,dt:'8-8-2026',loc:'Sendai',acc:{n:'Capsule Hotel 9H',p:3300},trn:{d:'YamagataSendai',p:1300},food:{d:'Local',p:1000},act:{d:'Omoshiroyama, Great Akiu Falls',p:0},note:'Good food',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:53,dt:'8-9-2026',loc:'Sendai Day 2',acc:{n:'Capsule Hotel 9H',p:3300},trn:{d:'Local',p:500},food:{d:'Gyutan beef tongue',p:2000},act:{d:'Matsushima Bay',p:0},note:'Three great views',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:54,dt:'8-10-2026',loc:'Train to Tokyo',acc:{n:'None',p:0},trn:{d:'SendaiTokyo',p:0},food:{d:'Local',p:1000},act:{d:'Prepare for flight',p:0},note:'Last day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:55,dt:'8-11-2026',loc:'Flight Home',acc:{n:'Flight',p:0},trn:{d:'Flight 7:45am',p:0},food:{d:'Airport food',p:1000},act:{d:'Sayonara Japan! ',p:0},note:'End of adventure!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false}
            ]
        };
        
        const CURRENCIES = {
            'JPY': { name: 'Japanese Yen', symbol: '' },
            'EUR': { name: 'Euro', symbol: '' },
            'GBP': { name: 'British Pound', symbol: '' },
            'CAD': { name: 'Canadian Dollar', symbol: 'CA$' },
            'AUD': { name: 'Australian Dollar', symbol: 'A$' },
            'CHF': { name: 'Swiss Franc', symbol: 'CHF' },
            'CNY': { name: 'Chinese Yuan', symbol: '' },
            'KRW': { name: 'South Korean Won', symbol: '' },
            'MXN': { name: 'Mexican Peso', symbol: 'MX$' },
            'INR': { name: 'Indian Rupee', symbol: '' }
        };

        const fetchLiveRate = async () => {
            if (!DATA.liveRate) return;
            
            try {
                const response = await fetch(`https://open.exchangerate-api.com/v6/latest/USD`);
                const data = await response.json();
                
                if (data.rates && data.rates[DATA.currency]) {
                    DATA.rate = data.rates[DATA.currency];
                    DATA.lastFetchedRate = new Date().toLocaleString();
                    saveToStorage();
                    render();
                }
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
            }
        };

        const changeCurrency = (newCurrency) => {
            DATA.currency = newCurrency;
            DATA.currencySymbol = CURRENCIES[newCurrency].symbol;
            if (DATA.liveRate) {
                fetchLiveRate();
            } else {
                saveToStorage();
                render();
            }
        };

       const updateTravelerCount = (change) => {
            const newCount = Math.max(1, DATA.travelerCount + change);
            DATA.travelerCount = newCount;
            
            // Adjust travelers array
            if (newCount > DATA.travelers.length) {
                for (let i = DATA.travelers.length; i < newCount; i++) {
                    DATA.travelers.push(`Traveler ${i + 1}`);
                }
            } else {
                DATA.travelers = DATA.travelers.slice(0, newCount);
            }
            
            saveToStorage();
            render();
        };

        const updateTravelerName = (idx, name) => {
            DATA.travelers[idx] = name;
            saveToStorage();
        };

        const setCostSplitMode = (mode) => {
            DATA.costSplitMode = mode;
            saveToStorage();
            debouncedRender(); // Changed from render()

        };

        const getWeatherIcon = (condition) => {
            const icons = {
                'clear': '',
                'clouds': '',
                'rain': '',
                'drizzle': '',
                'thunderstorm': '',
                'snow': '',
                'mist': '',
                'fog': '',
                'haze': ''
            };
            
            const conditionLower = condition.toLowerCase();
            for (let key in icons) {
                if (conditionLower.includes(key)) {
                    return icons[key];
                }
            }
            return '';
        };

        const fetchWeather = async (dayIndex) => {
            const day = DATA.days[dayIndex];
            const location = day.loc.split('')[0].trim().split(',')[0].trim();
            
            DATA.days[dayIndex].weatherLoading = true;
            render();
            
            try {
                // First, get coordinates for the location
                const geoResponse = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1&language=en&format=json`
                );
                const geoData = await geoResponse.json();
                
                if (!geoData.results || geoData.results.length === 0) {
                    DATA.days[dayIndex].weatherLoading = false;
                    alert(` No weather data found for "${location}"\n\nPlease check the location name and try again.`);
                    render();
                    return;
                }
                
                const { latitude, longitude, name } = geoData.results[0];
                
                // Parse the date from the day
                const now = new Date();
                const targetDate = new Date(day.dt);
                
                // Check if date is in the future
                const daysInFuture = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
                
                if (daysInFuture > 14) {
                    DATA.days[dayIndex].weatherLoading = false;
                    alert(` Too far in advance\n\nWeather forecasts are only available for dates within 14 days.\n"${day.dt}" is ${daysInFuture} days away.`);
                    render();
                    return;
                }
                
                if (daysInFuture < 0) {
                    DATA.days[dayIndex].weatherLoading = false;
                    alert(` Historical data\n\n"${day.dt}" is in the past. Historical weather data is not available.`);
                    render();
                    return;
                }
                
                // Date is within forecast range
                const dateStr = targetDate.toISOString().split('T')[0];
                
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode,windspeed_10m_max&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`
                );
                const weatherData = await weatherResponse.json();
                
                if (weatherData.daily && weatherData.daily.time[0] === dateStr) {
                    const tempMax = Math.round(weatherData.daily.temperature_2m_max[0]);
                    const tempMin = Math.round(weatherData.daily.temperature_2m_min[0]);
                    const tempMaxF = Math.round((tempMax * 9/5) + 32);
                    const tempMinF = Math.round((tempMin * 9/5) + 32);
                    const weatherCode = weatherData.daily.weathercode[0];
                    const windSpeed = Math.round(weatherData.daily.windspeed_10m_max[0]);
                    const precipitation = weatherData.daily.precipitation_sum[0];
                    
                    // Simple weather code to condition mapping
                    const getWeatherCondition = (code) => {
                        if (code === 0) return { condition: 'Clear sky', icon: '' };
                        if (code <= 3) return { condition: 'Partly cloudy', icon: '' };
                        if (code <= 48) return { condition: 'Foggy', icon: '' };
                        if (code <= 67) return { condition: 'Rain', icon: '' };
                        if (code <= 77) return { condition: 'Snow', icon: '' };
                        if (code <= 99) return { condition: 'Thunderstorm', icon: '' };
                        return { condition: 'Unknown', icon: '' };
                    };
                    
                    const { condition, icon } = getWeatherCondition(weatherCode);
                    
                    DATA.days[dayIndex].weather = {
                        temp: tempMaxF,
                        tempMin: tempMinF,
                        tempC: tempMax,
                        tempMinC: tempMin,
                        condition: condition,
                        icon: icon,
                        windSpeed: windSpeed,
                        precipitation: precipitation,
                        location: name
                    };
                } else {
                    throw new Error('Weather data not available');
                }
                
            } catch (error) {
                console.error('Weather fetch failed:', error);
                DATA.days[dayIndex].weather = { 
                    error: 'Weather data unavailable',
                    icon: '',
                    condition: 'Error'
                };
            }
            
            DATA.days[dayIndex].weatherLoading = false;
            saveToStorage();
            render();
        };

        const checkAndFetchUpcomingWeather = () => {
            const now = new Date();
            
            DATA.days.forEach((day, index) => {
                // Skip if weather is already loaded or loading
                if (day.weather || day.weatherLoading) return;
                
                // Parse the day's date
                const dayDate = new Date(day.dt);
                
                // Check if date is within 2 weeks in the future
                const daysInFuture = Math.ceil((dayDate - now) / (1000 * 60 * 60 * 24));
                
                // Only auto-fetch if date is within 0-14 days in the future
                if (daysInFuture >= 0 && daysInFuture <= 14) {
                    // Add a small delay to avoid hitting API rate limits
                    setTimeout(() => {
                        fetchWeather(index);
                    }, index * 1000); // Stagger requests by 1 second each
                }
            });
        };

        const formatCostWithSplit = (amount) => {
            if (DATA.costSplitMode === 'perPerson' && DATA.travelerCount > 1) {
                const perPerson = amount / DATA.travelerCount;
                return `${DATA.currencySymbol}${amount.toLocaleString()} <span class="per-person-cost">${DATA.currencySymbol}${perPerson.toFixed(0)}/person</span>`;
            }
            return `${DATA.currencySymbol}${amount.toLocaleString()}`;
        };
        
        const calc = (d) => {
            let total = 0;
            DATA.categories.forEach(cat => {
                total += d[cat.id]?.p || 0;
            });
            return total;
        };

        const calcA = (d) => {
            let total = 0;
            DATA.categories.forEach(cat => {
                total += d.a?.[cat.id] || 0;
            });
            return total;
        };


        const addDay = () => {
            let newDayNumber = DATA.days.length + 1;
            let newDate = '';
            
            if (DATA.days.length === 0) {
                // First day - use trip start date
                newDate = DATA.tripStartDate;
            } else {
                // Add to end - use day after last day
                const lastDay = DATA.days[DATA.days.length - 1];
                newDayNumber = lastDay.d + 1;
                
                // Calculate next date
                const lastDate = new Date(lastDay.dt);
                lastDate.setDate(lastDate.getDate() + 1);
                newDate = lastDate.toISOString().split('T')[0];
            }
            
            const newDay = {
                d: newDayNumber,
                dt: newDate,
                loc: 'New Location', // Always use "New Location" for new days
                note: '',
                done: false,
                a: {},
                photos: [],
                receipts: [],
                journalNote: '',
                schedule: [],
                showSchedule: false,
                weather: null,
                weatherLoading: false,
            };
            
            // Add all category fields
            DATA.categories.forEach(cat => {
                newDay[cat.id] = {d: '', p: 0};
                newDay.a[cat.id] = 0;
            });
            
            DATA.days.push(newDay);
            saveToStorage();
            render();
        };

        const deleteDay = (idx) => {
            showConfirmModal('Delete Day', `Delete Day ${DATA.days[idx].d} - ${DATA.days[idx].loc}?`, (confirmed) => {
                if (confirmed) {
                    DATA.days.splice(idx, 1);
                    // Renumber remaining days
                    DATA.days.forEach((day, i) => {
                        day.d = i + 1;
                    });
                    if (DATA.expanded === idx) DATA.expanded = null;
                    saveToStorage();
                    render();
                }
            });
        };

        const duplicateDay = (idx) => {
            const original = DATA.days[idx];
            const duplicate = {
                ...original,
                d: DATA.days.length + 1,
                done: false,
                a: {acc: 0, trn: 0, food: 0, act: 0},
                photos: [],
                journalNote: '',
                schedule: [...original.schedule],
                acc: {...original.acc},
                trn: {...original.trn},
                food: {...original.food},
                act: {...original.act}
            };
            DATA.days.push(duplicate);
            saveToStorage();
            render();
        };
        
        const stats = () => {
            let tP = 0, tA = 0, done = 0;
            let catP = {};
            let catA = {};
            let itemsP = {};
            let itemsA = {};
            
            // Initialize categories
            DATA.categories.forEach(cat => {
                catP[cat.id] = 0;
                catA[cat.id] = 0;
                itemsP[cat.id] = [];
                itemsA[cat.id] = [];
            });
            
            let fixedCosts = 0;
            
            DATA.days.forEach(d => {
                if(d.done) done++;
                
                DATA.categories.forEach(cat => {
                    const pVal = d[cat.id]?.p || 0;
                    const aVal = d.a?.[cat.id] || 0;
                    
                    tP += pVal;
                    tA += aVal;
                    catP[cat.id] += pVal;
                    catA[cat.id] += aVal;
                    
                    // For fixed costs, use first two categories
                    if (DATA.categories.indexOf(cat) < 2) {
                        fixedCosts += pVal;
                    }
                    
                    if(pVal > 0) {
                        itemsP[cat.id].push({
                            day: d.d, 
                            name: (d[cat.id]?.n || d[cat.id]?.d || 'Item').substring(0,40), 
                            value: pVal
                        });
                    }
                    
                    if(aVal > 0) {
                        itemsA[cat.id].push({
                            day: d.d, 
                            name: (d[cat.id]?.n || d[cat.id]?.d || 'Item').substring(0,40), 
                            value: aVal
                        });
                    }
                });
            });
            
            // Convert local currency amounts to USD for calculations
            const tP_USD = tP / DATA.rate;
            const tA_USD = tA / DATA.rate;
            const tBudget_USD = DATA.budget; // Budget is already in USD
            
            // Calculate remaining in local currency first
            const remaining = tBudget_USD - tA_USD;
            
            // Convert remaining back to local currency for display
            const remainingLocal = remaining * DATA.rate;
            
            const daysLeft = DATA.days.length - done;
            const avgDailySpent = done > 0 ? tA / done : 0;
            const avgDailyBudget = tP / DATA.days.length;
            const variableRemaining = remainingLocal - (fixedCosts - (catA[DATA.categories[0]?.id || 'acc'] + catA[DATA.categories[1]?.id || 'trn']));
            const canSpendPerDay = daysLeft > 0 ? variableRemaining / daysLeft : 0;
            
            return { 
                tP, tA, done, 
                rem: remainingLocal, // Show in local currency
                pct: (tA_USD / tBudget_USD * 100), // Calculate percentage in USD
                estRem: tBudget_USD - tP_USD, // Estimated remaining in USD
                estPct: (tP_USD / tBudget_USD * 100), // Estimated percentage in USD
                over: tP_USD > tBudget_USD, // Compare in USD
                daysLeft, 
                avgDailySpent, 
                avgDailyBudget, 
                canSpendPerDay, 
                catP, 
                catA,
                itemsP,
                itemsA,
                tBudget_USD, // Budget in USD
                tP_USD, // Planned in USD
                tA_USD // Actual in USD
            };
        };
        
        const update = (i, cat, k, v) => {
            if(k === 'p') {
                DATA.days[i][cat][k] = parseFloat(v) || 0;
            } else if(k === 'd' || k === 'n') {
                DATA.days[i][cat][k] = v;
            } else if(cat === 'base') {
                DATA.days[i][k] = k === 'd' ? parseInt(v) : v;
            } else if(DATA.days[i].a && ['acc','trn','food','act'].includes(cat)) {
                DATA.days[i].a[cat] = parseFloat(v) || 0;
            }
            saveToStorage();
            showToast(' Saved', 'success');
            render();
        };
        
        const updateJournal = (i, v) => { 
            DATA.days[i].journalNote = v; 
            saveToStorage(); 
            showToast(' Journal saved', 'success');
        };
        
        const addPhoto = (i, dataUrl) => { 
            if (!DATA.days[i].photos) DATA.days[i].photos = []; 
            DATA.days[i].photos.push(dataUrl); 
            saveToStorage(); 
            render(); 
        };
        
        const deletePhoto = (i, photoIdx) => { 
            DATA.days[i].photos.splice(photoIdx, 1); 
            saveToStorage(); 
            render(); 
        };
        
        const handlePhotoUpload = (i, e) => { 
            const file = e.target.files[0]; 
            if (file) { 
                const reader = new FileReader(); 
                reader.onload = (event) => { 
                    addPhoto(i, event.target.result); 
                }; 
                reader.readAsDataURL(file); 
            } 
        };
        
        const addScheduleItem = (i) => { 
            if (!DATA.days[i].schedule) DATA.days[i].schedule = []; 
            DATA.days[i].schedule.push({time: '09:00', activity: ''}); 
            saveToStorage(); 
            render(); 
        };
        
        const updateSchedule = (i, idx, field, value) => { 
            DATA.days[i].schedule[idx][field] = value; 
            saveToStorage(); 
            if (field === 'activity') {
                showToast(' Schedule updated', 'success');
            }
        };
        
        const deleteSchedule = (i, idx) => { 
            DATA.days[i].schedule.splice(idx, 1); 
            saveToStorage(); 
            render(); 
        };
        
        const openPhotoModal = (photo) => { 
            DATA.photoModal = photo; 
            render(); 
        };
        
        const closePhotoModal = () => { 
            DATA.photoModal = null; 
            render(); 
        };
        
        const highlightText = (text, query) => {
            if (!query) return text;
            const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escaped})`, 'gi');
            return text.replace(regex, '<span class="search-result-highlight">$1</span>');
        };
        
        const jumpToDay = (dayIndex) => {
            DATA.expanded = dayIndex;
            DATA.showSearchResults = false;
            DATA.searchQuery = '';
            render();
            setTimeout(() => {
                const dayCard = document.querySelector(`.day-card[data-day="${dayIndex}"]`);
                if (dayCard) {
                    dayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        };
        
        const saveToStorage = () => {
            if (window.CURRENT_TRIP_ID) {
                window.ALL_TRIPS[window.CURRENT_TRIP_ID] = JSON.parse(JSON.stringify(DATA));
                localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
                localStorage.setItem('currentTripId', window.CURRENT_TRIP_ID);
                hapticFeedback('success'); // ADD THIS
            }
        };

        const showToast = (message, type = 'info') => {
            // Check if toasts are disabled
            if (DATA.disableToasts) return;
            
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(t => t.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Use animation speed setting
            const speed = DATA.animationSpeed === 'fast' ? 150 : DATA.animationSpeed === 'slow' ? 500 : 300;
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), speed);
            }, 2000); // Show for 2 seconds
        };
        
        const loadFromStorage = () => {
            const saved = localStorage.getItem('tripData');
            
            // Check if we have the new multi-trip structure
            const multiTripData = localStorage.getItem('allTrips');
            const currentTripId = localStorage.getItem('currentTripId');
            
            if (multiTripData) {
                // New multi-trip structure
                window.ALL_TRIPS = JSON.parse(multiTripData);
                window.CURRENT_TRIP_ID = currentTripId || Object.keys(window.ALL_TRIPS)[0];
                
                // Load current trip
                if (window.ALL_TRIPS[window.CURRENT_TRIP_ID]) {
                    Object.assign(DATA, window.ALL_TRIPS[window.CURRENT_TRIP_ID]);
                }
            } else if (saved) {
                // Migrate old single-trip data to new structure
                const oldData = JSON.parse(saved);
                const tripId = 'trip_' + Date.now();
                
                // Check if we already have trips (don't overwrite!)
                const existingTrips = localStorage.getItem('allTrips');
                if (existingTrips) {
                    // Already migrated, just load existing
                    window.ALL_TRIPS = JSON.parse(existingTrips);
                    window.CURRENT_TRIP_ID = localStorage.getItem('currentTripId') || Object.keys(window.ALL_TRIPS)[0];
                } else {
                    // First time migration
                    window.ALL_TRIPS = {
                        [tripId]: oldData
                    };
                    window.CURRENT_TRIP_ID = tripId;
                    
                    // Save in new format
                    localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
                    localStorage.setItem('currentTripId', window.CURRENT_TRIP_ID);
                }
                
                Object.assign(DATA, window.ALL_TRIPS[window.CURRENT_TRIP_ID]);
                localStorage.removeItem('tripData'); // Remove old format after successful migration
            } else {
                // No data - initialize with empty state
                window.ALL_TRIPS = {};
                window.CURRENT_TRIP_ID = null;
            }
            
            if (DATA.liveRate && window.CURRENT_TRIP_ID) {
                fetchLiveRate();
            } else {
                render();
            }
                const modalStatesToClear = [
                    'editingCategoryModal',
                    'editingNotesModal',
                    'showModal',
                    'editing',
                    'expanded',
                    'showSettings',
                    'showExportMenu',
                    'showAnalyticsPage',
                    'showTripManager',
                    'editPackingList',
                    'editTripChecklist',
                    'editBeforeChecklist',
                    'showTravelers',
                    'showTravelerList'
                ];
                
                modalStatesToClear.forEach(state => {
                    if (DATA[state] !== undefined) {
                        DATA[state] = false;
                    }
                });
                
                // Also clear day-specific states
                if (DATA.days) {
                    DATA.days.forEach(day => {
                        day.showDaySection = null;
                        day.showSchedule = false;
                    });
                }
                setTimeout(checkAndFetchUpcomingWeather, 2000);
        };

        const ICON_OPTIONS = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
       
        const addCategory = () => {
            const newId = 'cat_' + Date.now();
            DATA.categories.push({
                id: newId,
                name: 'New Category',
                icon: '',
                color: '#6b7280'
            });
            DATA.categoryBudgets[newId] = 0;
            
            // Add to all existing days
            DATA.days.forEach(day => {
                day[newId] = {d: '', p: 0};
                day.a[newId] = 0;
            });
            
            saveToStorage();
            render();
        };

        const deleteCategory = (catId) => {
            if (DATA.categories.length <= 1) {
                alert("You must have at least one category!");
                return;
            }
            
            showConfirmModal('Delete Category', 'Delete this category? This will remove it from all days.', (confirmed) => {
                if (confirmed) {
                    DATA.categories = DATA.categories.filter(c => c.id !== catId);
                    delete DATA.categoryBudgets[catId];
                    
                    // Remove from all days
                    DATA.days.forEach(day => {
                        delete day[catId];
                        delete day.a[catId];
                    });
                    
                    saveToStorage();
                    render();
                }
            });
        };

        const updateCategory = (catId, field, value) => {
            const cat = DATA.categories.find(c => c.id === catId);
            if (cat) {
                cat[field] = value;
                saveToStorage();
                debouncedRender(); // Changed from render()

            }
        };

        const openIconPicker = (catId) => {
            DATA.iconPickerOpen = true;
            DATA.iconPickerCategory = catId;
            render();
        };

        const closeIconPicker = () => {
            DATA.iconPickerOpen = false;
            DATA.iconPickerCategory = null;
            render();
        };

        const selectIcon = (icon) => {
            if (DATA.iconPickerCategory) {
                updateCategory(DATA.iconPickerCategory, 'icon', icon);
            }
            closeIconPicker();
        };

        const calculateTripDays = () => {
            const start = new Date(DATA.tripStartDate);
            const end = new Date(DATA.tripEndDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end
            return diffDays;
        };

        const updateTripDates = () => {
            const expectedDays = calculateTripDays();
            const currentDays = DATA.days.length;
            
            if (expectedDays !== currentDays) {
                showConfirmModal('Adjust Trip Length', `Trip length changed to ${expectedDays} days. Current itinerary has ${currentDays} days. Adjust number of days?`, (confirmed) => {
                    if (confirmed) {
                        if (expectedDays > currentDays) {
                            // Add days
                            for (let i = currentDays; i < expectedDays; i++) {
                                const newDay = {
                                    d: i + 1,
                                    dt: 'MM-DD-YYYY',
                                    loc: 'New Location',
                                    note: '',
                                    done: false,
                                    a: {},
                                    photos: [],
                                    journalNote: '',
                                    schedule: [],
                                    showSchedule: false,
                                    scheduleView: 'list',
                                    weather: null,
                                    weatherLoading: false
                                };
                                
                                // Add all category fields
                                DATA.categories.forEach(cat => {
                                    newDay[cat.id] = {d: '', p: 0};
                                    newDay.a[cat.id] = 0;
                                });
                                
                                DATA.days.push(newDay);
                            }
                        } else {
                            // Remove days
                            DATA.days = DATA.days.slice(0, expectedDays);
                        }
                        
                        saveToStorage();
                        render();
                    } 
                });
            } else {
                saveToStorage();
                render();
            }
        };
        
        const exp = () => { 
            let csv = 'Day,Date,Location,Category,Planned,Actual,Diff,Planned$,Actual$,Done\n'; 
            DATA.days.forEach(d => { 
                ['acc','trn','food','act'].forEach(c => { 
                    const p = d[c].p, a = d.a[c]; 
                    csv += `${d.d},${d.dt},${d.loc},${c},${p},${a},${a-p},${(p/DATA.rate).toFixed(2)},${(a/DATA.rate).toFixed(2)},${d.done}\n`; 
                }); 
            }); 
            const blob = new Blob([csv], {type:'text/csv'}); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = 'japan_trip_55days.csv'; 
            a.click(); 
        };
        
        const downloadHTML = () => { 
            const htmlContent = document.documentElement.outerHTML; 
            const updatedHTML = htmlContent.replace(/const DATA = \{[\s\S]*?\};/, `const DATA = ${JSON.stringify(DATA, null, 4)};`); 
            const blob = new Blob([updatedHTML], {type:'text/html'}); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = 'japan_trip_updated.html'; 
            a.click(); 
            URL.revokeObjectURL(url); 
        };

        const switchTab = (tab) => {
            // Save scroll position of tab navigation
            const tabNav = document.querySelector('.tab-navigation');
            const scrollPos = tabNav ? tabNav.scrollLeft : 0;
            
            const mapState = saveMapState();
            
            DATA.activeTab = tab;
            saveToStorage();
            render();
            
            restoreMapState(mapState);
            
            // Restore tab scroll position
            setTimeout(() => {
                const newTabNav = document.querySelector('.tab-navigation');
                if (newTabNav) {
                    newTabNav.scrollLeft = scrollPos;
                }
            }, 50);
        };
        // Make functions globally accessible

        let mapInstance = null;
        let markersLayer = null;
        let routeLayer = null;

        const initMap = () => {
            console.log(' Initializing map...');
            
            if (mapInstance) {
                mapInstance.remove();
            }
            
            const mapElement = document.getElementById('tripMap');
            if (!mapElement) {
                console.error('Map element not found');
                return;
            }
            
            // MOBILE-FRIENDLY MAP OPTIONS
            const isMobile = window.innerWidth <= 768;
            
            mapInstance = L.map('tripMap', {
                tap: isMobile,
                tapTolerance: 15,
                touchZoom: true,
                dragging: true,
                zoomControl: true,
                scrollWheelZoom: false, // Prevent accidental zoom on scroll
                doubleClickZoom: true,
                boxZoom: false,
                keyboard: false
            }).setView([20, 0], 2);
            
            // Add better mobile zoom controls
            if (isMobile) {
                mapInstance.touchZoom.enable();
                mapInstance.dragging.enable();
            }
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: ' OpenStreetMap contributors  CARTO',
                maxZoom: 19
            }).addTo(mapInstance);
            
            markersLayer = L.layerGroup().addTo(mapInstance);
            routeLayer = L.layerGroup().addTo(mapInstance);
            
            DATA.mapInitialized = true;
            
            // Load from cache if available
            if (Object.keys(DATA.geocodedLocations).length > 0) {
                console.log(' Loading from cache:', Object.keys(DATA.geocodedLocations).length, 'locations');
                renderMapFromCache();
                
                const locationDiv = document.getElementById('mapTotalLocations');
                if (locationDiv) {
                    locationDiv.textContent = Object.keys(DATA.geocodedLocations).length;
                }
            } else {
                console.log(' No cache found, will geocode on refresh');
                const locationDiv = document.getElementById('mapTotalLocations');
                if (locationDiv) {
                    locationDiv.textContent = '0';
                }
            }
        };

        const renderMapFromCache = () => {
            if (!mapInstance || !markersLayer || !routeLayer) {
                console.error('Map not initialized');
                return;
            }
            
            console.log(' Rendering map from cache');
            
            markersLayer.clearLayers();
            routeLayer.clearLayers();
            draggableMarkers = {};
            
            const locations = [];
            let totalDistance = 0;
            
            // Group days by location
            const uniqueLocations = new Map();
            DATA.days.forEach(day => {
                const locationNames = day.loc.split('').map(l => l.trim());
                locationNames.forEach(locName => {
                    if (!uniqueLocations.has(locName)) {
                        uniqueLocations.set(locName, []);
                    }
                    uniqueLocations.get(locName).push({d: day.d, dt: day.dt, loc: day.loc});
                });
            });
            
            // Add markers from cache
            for (const [locName, days] of uniqueLocations) {
                const coords = DATA.geocodedLocations[locName];
                if (coords) {
                    const marker = L.marker([coords.lat, coords.lng], {
                        draggable: DATA.mapEditMode
                    }).addTo(markersLayer);
                    
                    if (DATA.mapEditMode) {
                        marker.on('dragend', (e) => {
                            const newPos = e.target.getLatLng();
                            DATA.geocodedLocations[locName].lat = newPos.lat;
                            DATA.geocodedLocations[locName].lng = newPos.lng;
                            saveToStorage();
                            
                            // Update coordinates display in location list
                            const locationItems = document.querySelectorAll('.location-item');
                            locationItems.forEach(item => {
                                const nameDiv = item.querySelector('[data-location]');
                                if (nameDiv && nameDiv.dataset.location === locName) {
                                    const coordsDiv = item.querySelector('.location-coords');
                                    if (coordsDiv) {
                                        coordsDiv.textContent = `${newPos.lat.toFixed(4)}, ${newPos.lng.toFixed(4)}`;
                                    }
                                }
                            });
                            
                            // Redraw route if in route view
                            if (DATA.mapView === 'route') {
                                drawRoute();
                            }
                        });
                    }
                    
                    const daysList = days.map(d => `Day ${d.d} (${d.dt})`).join('<br>');
                    marker.bindPopup(`
                        <div class="location-marker-popup">
                            <strong>${coords.name}, ${coords.country}</strong>
                            <div style="margin-top:5px;font-size:12px;">${daysList}</div>
                            <div style="margin-top:5px;font-size:11px;color:#666;">
                                ${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}
                            </div>
                        </div>
                    `);
                    
                    draggableMarkers[locName] = marker;
                    locations.push(coords);
                }
            }
            
            // Add custom waypoints
            DATA.customWaypoints.forEach((waypoint, idx) => {
                const marker = L.marker([waypoint.lat, waypoint.lng], {
                    draggable: DATA.mapEditMode
                }).addTo(markersLayer);
                
                if (DATA.mapEditMode) {
                    marker.on('dragend', (e) => {
                        const newPos = e.target.getLatLng();
                        DATA.customWaypoints[idx].lat = newPos.lat;
                        DATA.customWaypoints[idx].lng = newPos.lng;
                        saveToStorage();
                    });
                }

                const popupContent = `
                    <div class="location-marker-popup">
                        <strong> ${waypoint.name}</strong>
                        <div style="margin-top:5px;font-size:11px;color:#666;">
                            ${waypoint.lat.toFixed(4)}, ${waypoint.lng.toFixed(4)}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                if (DATA.mapEditMode) {
                    marker.on('popupopen', () => {
                        const deleteBtn = document.getElementById(`deleteWaypoint_${idx}`);
                        const editBtn = document.getElementById(`editWaypointCoords_${idx}`);
                        
                        if (deleteBtn) {
                            deleteBtn.onclick = () => {
                                marker.closePopup();
                                showConfirmModal('Delete Waypoint', `Delete waypoint "${waypoint.name}"?`, (confirmed) => {
                                    if (confirmed) {
                                        DATA.customWaypoints.splice(idx, 1);
                                        saveToStorage();
                                        renderMapFromCache();
                                    }
                                });
                            };
                        }
                        
                        if (editBtn) {
                            editBtn.onclick = () => {
                                marker.closePopup();
                                editWaypointCoords(idx);
                            };
                        }
                    });
                }
            });
            
            // Draw route if needed
            if (DATA.mapView === 'route') {
                totalDistance = drawRoute();
            }
            
            // Fit bounds
            if (locations.length > 0) {
                const bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lng]));
                mapInstance.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Update stats
            updateMapStats(locations.length, totalDistance);
        };

        const geocodeLocation = async (location, dayIndex) => {
            if (DATA.geocodedLocations[location]) {
                return DATA.geocodedLocations[location];
            }
            
            try {
                // Add timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1&language=en&format=json`,
                    { signal: controller.signal }
                );
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const result = {
                        lat: data.results[0].latitude,
                        lng: data.results[0].longitude,
                        name: data.results[0].name,
                        country: data.results[0].country
                    };
                    
                    DATA.geocodedLocations[location] = result;
                    saveToStorage();
                    return result;
                }
            } catch (error) {
                console.error('Geocoding failed for', location, error);
            }
            
            return null;
};

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            // Haversine formula to calculate distance between two points
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance; // in kilometers
        };

        const updateMap = async () => {
            if (!mapInstance || !markersLayer || !routeLayer) return;

            console.log(' Starting map update...');
            console.log(' Geocoded locations in cache:', Object.keys(DATA.geocodedLocations).length);
            
            // Clear existing markers and routes
            markersLayer.clearLayers();
            routeLayer.clearLayers();
            
            const uniqueLocations = new Map(); // Use Map to deduplicate
            
            // Collect unique locations first (no geocoding yet)
            DATA.days.forEach(day => {
                const locationNames = day.loc.split('').map(l => l.trim());
                locationNames.forEach(locName => {
                    if (!uniqueLocations.has(locName)) {
                        uniqueLocations.set(locName, {
                            name: locName,
                            days: []
                        });
                    }
                    uniqueLocations.get(locName).days.push({
                        d: day.d,
                        dt: day.dt,
                        loc: day.loc
                    });
                });
            });
            
            const locations = [];
            let totalDistance = 0;
            let geocoded = 0;
            
            // Geocode in sequence (to avoid rate limiting and lag)
            for (const [locName, locInfo] of uniqueLocations) {
                console.log('Geocoding:', locName);
                const coords = await geocodeLocation(locName);
                if (coords) {
                    console.log(' Found:', locName, coords);
                    geocoded++;
                    
                    // Add marker immediately as we geocode
                    const marker = L.marker([coords.lat, coords.lng]).addTo(markersLayer);
                    
                    const daysList = locInfo.days.map(d => `Day ${d.d} (${d.dt})`).join('<br>');
                    marker.bindPopup(`
                        <div class="location-marker-popup">
                            <strong>${coords.name}, ${coords.country}</strong>
                            <div style="margin-top:5px;font-size:12px;">${daysList}</div>
                        </div>
                    `);
                    
                    locations.push({
                        ...coords,
                        days: locInfo.days
                    });
                    
                    // Update progress
                    document.getElementById('mapTotalLocations').textContent = `${geocoded}/${uniqueLocations.size}`;
                } else {
                    console.log(' Failed:', locName);
                }
                // Small delay to prevent overwhelming the API
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            // Build route from day order (not unique locations)
            if (DATA.mapView === 'route' && locations.length > 1) {
                const routeCoords = [];
                let prevCoords = null;
                
                for (const day of DATA.days) {
                    const locName = day.loc.split('')[0].trim();
                    const coords = DATA.geocodedLocations[locName];
                    
                    if (coords) {
                        const currentCoords = [coords.lat, coords.lng];
                        
                        // Only add if different from previous
                        if (!prevCoords || 
                            prevCoords[0] !== currentCoords[0] || 
                            prevCoords[1] !== currentCoords[1]) {
                            routeCoords.push(currentCoords);
                            
                            // Calculate distance from previous
                            if (prevCoords) {
                                const dist = calculateDistance(
                                    prevCoords[0], prevCoords[1],
                                    currentCoords[0], currentCoords[1]
                                );
                                totalDistance += dist;
                            }
                            
                            prevCoords = currentCoords;
                        }
                    }
                }
                
                if (routeCoords.length > 1) {
                    // Draw polyline
                    L.polyline(routeCoords, {
                        color: '#3b82f6',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(routeLayer);
                    
                    // Add direction arrows (fewer of them)
                    for (let i = 0; i < routeCoords.length - 1; i += Math.max(1, Math.floor(routeCoords.length / 10))) {
                        const midLat = (routeCoords[i][0] + routeCoords[i + 1][0]) / 2;
                        const midLng = (routeCoords[i][1] + routeCoords[i + 1][1]) / 2;
                        
                        L.marker([midLat, midLng], {
                            icon: L.divIcon({
                                html: '',
                                className: 'route-arrow',
                                iconSize: [20, 20]
                            })
                        }).addTo(routeLayer);
                    }
                }
            }
            
            // Fit map to show all markers
            if (locations.length > 0) {
                const bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lng]));
                mapInstance.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Update final stats
            document.getElementById('mapTotalLocations').textContent = locations.length;
            document.getElementById('mapTotalDistance').textContent = 
                totalDistance > 0 ? `${totalDistance.toFixed(0)} km (${(totalDistance * 0.621371).toFixed(0)} mi)` : 'N/A';
            document.getElementById('mapTotalDays').textContent = DATA.days.length;
        };
       
       const updateMapStats = (locationCount, distance) => {
            const locationDiv = document.getElementById('mapTotalLocations');
            const distanceDiv = document.getElementById('mapTotalDistance');
            const daysDiv = document.getElementById('mapTotalDays');
            
            if (locationDiv) locationDiv.textContent = locationCount;
            if (distanceDiv) {
                distanceDiv.textContent = distance > 0 ? 
                    `${distance.toFixed(0)} km (${(distance * 0.621371).toFixed(0)} mi)` : 
                    'N/A';
            }
            if (daysDiv) daysDiv.textContent = DATA.days.length;
        };

        const switchMapView = (view) => {
            DATA.mapView = view;
            saveToStorage();
            
            // Update button states without full re-render
            document.querySelectorAll('.map-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (DATA.mapInitialized) {
                updateMap();
            }
        };

        const geocodeAllLocations = async () => {
            const btn = document.getElementById('geocodeBtn');
            if (btn) {
                btn.textContent = ' Mapping...';
                btn.disabled = true;
            }
            
            // Show progress message
            document.getElementById('mapTotalLocations').textContent = 'Loading...';
            
            await updateMap();
            
            if (btn) {
                btn.textContent = ' Complete';
                setTimeout(() => {
                    btn.textContent = ' Refresh Map';
                    btn.disabled = false;
                }, 2000);
            }
        };

        const toggleMapEditMode = () => {
            DATA.mapEditMode = !DATA.mapEditMode;
            if (!DATA.mapEditMode) {
                DATA.editingLocation = null;
            }
            saveToStorage();
            
            // Update button manually
            const editBtn = Array.from(document.querySelectorAll('.map-btn')).find(b => b.textContent.includes('Edit') || b.textContent.includes('Done'));
            if (editBtn) {
                editBtn.classList.toggle('active', DATA.mapEditMode);
                editBtn.innerHTML = DATA.mapEditMode ? ' Done Editing' : ' Edit Map';
            }
            
            // Show/hide location list - but with the RIGHT layout
            const locationList = document.querySelector('.location-list');
            if (DATA.mapEditMode) {
                // Create and show location list with the nice layout
                if (!locationList) {
                    const statsDiv = document.querySelector('.route-stats');
                    if (statsDiv) {
                        const html = `
                            <div class="location-list">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                    <h4 style="font-size:14px;margin:0;"> Route Order</h4>
                                    <div style="display:flex;gap:8px;">
                                        <button class="btn" onclick="addManualLocation()" style="padding:4px 12px;font-size:12px;background:#10b981;">
                                             Add Location
                                        </button>
                                        <button class="btn" onclick="addCustomWaypoint()" style="padding:4px 12px;font-size:12px;background:#8b5cf6;">
                                             Add Waypoint
                                        </button>
                                    </div>
                                </div>
                                <div style="font-size:12px;color:#666;margin-bottom:10px;">
                                     Drag to reorder your route. Locations and waypoints in order from top to bottom.
                                </div>
                                ${getAllMapLocations().map(loc => `
                                    <div class="location-item" draggable="true" 
                                        data-location-id="${loc.id}"
                                        ondragstart="handleDragStart(event, '${loc.id}')"
                                        ondragover="handleDragOver(event)"
                                        ondrop="handleDrop(event, '${loc.id}')"
                                        ondragend="handleDragEnd(event)">
                                        <span class="location-drag-handle"></span>
                                        <div style="flex:1;">
                                            <div style="font-weight:600;font-size:13px;display:flex;align-items:center;gap:8px;">
                                                ${loc.type === 'waypoint' ? '' : ''} 
                                                <span data-location="${loc.id}">${loc.name}</span>
                                                ${loc.type === 'waypoint' ? '<span style="font-size:10px;background:#8b5cf6;color:white;padding:2px 6px;border-radius:4px;">WAYPOINT</span>' : ''}
                                            </div>
                                            <div class="location-coords">${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}</div>
                                        </div>
                                        <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `editWaypointInfo(${loc.waypointIndex})` : `editLocation('${loc.name}')`}" style="padding:4px 10px;font-size:11px;"> Edit Name</button>
                                        <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `editWaypointCoords(${loc.waypointIndex})` : `editLocationCoords('${loc.name}')`}" style="padding:4px 10px;font-size:11px;background:#3b82f6;"> Edit Coords</button>
                                        <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `deleteWaypointFromList(${loc.waypointIndex})` : `deleteLocationFromCache('${loc.name}')`}" style="padding:4px 10px;font-size:11px;background:#ef4444;"> Delete</button>
                                    </div>
                                `).join('')}
                                ${getAllMapLocations().length === 0 ? `
                                    <div style="padding:20px;text-align:center;color:#999;font-size:13px;">
                                        No locations yet. Add locations or waypoints to plan your route.
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        statsDiv.insertAdjacentHTML('afterend', html);
                    }
                }
            } else {
                // Hide location list
                if (locationList) {
                    locationList.remove();
                }
            }
            
            // Redraw map with updated draggable state
            if (DATA.mapInitialized && Object.keys(DATA.geocodedLocations).length > 0) {
                renderMapFromCache();
            }
        };
        
        const addCustomWaypoint = () => {
            if (!mapInstance) {
                showAlertModal('Map Not Ready', 'Please wait for the map to load first!');
                return;
            }
            
            const center = mapInstance.getCenter();
            
            showInputModal(
                'Add Waypoint',
                'Enter a name for this waypoint',
                'Custom Waypoint',
                '',
                (waypointName) => {
                    DATA.customWaypoints.push({
                        name: waypointName,
                        lat: center.lat,
                        lng: center.lng
                    });
                    
                    saveToStorage();
                    
                    if (DATA.mapInitialized) {
                        renderMapFromCache();
                    }
                }
            );
        };
       
        window.addCustomWaypoint = addCustomWaypoint

        const addManualLocation = () => {
            showInputModal(
                'Add Location',
                'Enter the location name',
                'Tokyo, Japan',
                '',
                (name) => {
                    showInputModal(
                        'Enter Latitude',
                        'Enter latitude (-90 to 90)',
                        '35.6762',
                        '',
                        (latStr) => {
                            showInputModal(
                                'Enter Longitude',
                                'Enter longitude (-180 to 180)',
                                '139.6503',
                                '',
                                (lngStr) => {
                                    const lat = parseFloat(latStr);
                                    const lng = parseFloat(lngStr);
                                    
                                    if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                                        showAlertModal('Invalid Coordinates', 'Please enter valid latitude and longitude values.');
                                        return;
                                    }
                                    
                                    DATA.geocodedLocations[name] = {
                                        lat: lat,
                                        lng: lng,
                                        name: name,
                                        country: 'Custom'
                                    };
                                    
                                    saveToStorage();
                                    render();
                                }
                            );
                        }
                    );
                }
            );
        };

        const editWaypointCoords = (idx) => {
            const waypoint = DATA.customWaypoints[idx];
            
            const latStr = prompt('Enter new latitude:', waypoint.lat);
            const lngStr = prompt('Enter new longitude:', waypoint.lng);
            
            if (latStr === null || lngStr === null) return;
            
            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Invalid coordinates!');
                return;
            }
            
            DATA.customWaypoints[idx].lat = lat;
            DATA.customWaypoints[idx].lng = lng;
            saveToStorage();
            renderMapFromCache();
        };

        const editLocationCoords = (locationName) => {
            const coords = DATA.geocodedLocations[locationName];
            if (!coords) return;
            
            const latStr = prompt('Enter new latitude (-90 to 90):', coords.lat);
            const lngStr = prompt('Enter new longitude (-180 to 180):', coords.lng);
            
            if (latStr === null || lngStr === null) return;
            
            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Invalid coordinates!');
                return;
            }
            
            DATA.geocodedLocations[locationName].lat = lat;
            DATA.geocodedLocations[locationName].lng = lng;
            saveToStorage();
            
            // Update the coords display
            const coordsDiv = document.querySelector(`[data-location="${locationName}"] + .location-coords`);
            if (coordsDiv) {
                coordsDiv.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
            
            // Redraw map
            if (DATA.mapInitialized) {
                renderMapFromCache();
            }
        };

        window.deleteLocationFromCache = (locationName) => {
            showConfirmModal('Delete Location', `Delete "${locationName}" from map? This will remove it from the cached locations but won't change your trip days.`, (confirmed) => {
                if (confirmed) {
                    console.log('Deleting location:', locationName);
                    delete DATA.geocodedLocations[locationName];
                    saveToStorage();
                    
                    // Remove the location item from DOM
                    const locationItems = document.querySelectorAll('.location-item');
                    locationItems.forEach(item => {
                        const nameDiv = item.querySelector('[data-location]');
                        if (nameDiv && nameDiv.dataset.location === locationName) {
                            item.remove();
                        }
                    });
                    
                    // Redraw map without this location
                    if (DATA.mapInitialized) {
                        renderMapFromCache();
                    }
                    
                    // Show empty state if no locations left
                    if (Object.keys(DATA.geocodedLocations).length === 0) {
                        const locationList = document.querySelector('.location-list');
                        if (locationList) {
                            const existingItems = locationList.querySelectorAll('.location-item');
                            if (existingItems.length === 0) {
                                const emptyDiv = document.querySelector('.location-list > div:last-child');
                                if (!emptyDiv || !emptyDiv.textContent.includes('No locations')) {
                                    locationList.querySelector('h4').insertAdjacentHTML('afterend', `
                                        <div style="padding:20px;text-align:center;color:#999;font-size:13px;">
                                            No locations yet. Add locations manually or refresh the map to geocode from your trip days.
                                        </div>
                                    `);
                                }
                            }
                        }
                    }
                    
                    console.log('Location deleted. Remaining:', Object.keys(DATA.geocodedLocations));
                }
            });
        };
                
        const clearMapCache = () => {
            showConfirmModal('Clear Map Cache', 'Clear all cached map locations? This will remove all your edits and custom waypoints. You\'ll need to refresh the map to reload from trip days.', (confirmed) => {
                if (confirmed) {
                    console.log(' Clearing map cache...');
                    DATA.geocodedLocations = {};
                    DATA.customWaypoints = [];
                    DATA.mapInitialized = false;
                    saveToStorage();

                    if (mapInstance) {
                        mapInstance.remove();
                        mapInstance = null;
                        markersLayer = null;
                        routeLayer = null;
                    }
                    
                    alert('Map cache cleared! Click "Refresh Map" to reload from your trip days.');
                    render();
                }
            }); 
        };

        const saveMapState = () => {
            if (mapInstance) {
                return {
                    center: mapInstance.getCenter(),
                    zoom: mapInstance.getZoom(),
                    wasInitialized: true
                };
            }
            return null;
        };

        const restoreMapState = (state) => {
            // If we're on planning tab and map should be visible
            if (DATA.showMap && DATA.activeTab === 'planning') {
                setTimeout(() => {
                    const mapElement = document.getElementById('tripMap');
                    
                    if (mapElement && !DATA.mapInitialized) {
                        // Initialize the map
                        initMap();
                        
                        // Auto-fit to show all markers
                        if (mapInstance && Object.keys(DATA.geocodedLocations).length > 0) {
                            const allCoords = Object.values(DATA.geocodedLocations).map(loc => [loc.lat, loc.lng]);
                            
                            // Add waypoint coords too
                            DATA.customWaypoints.forEach(wp => {
                                allCoords.push([wp.lat, wp.lng]);
                            });
                            
                            if (allCoords.length > 0) {
                                const bounds = L.latLngBounds(allCoords);
                                mapInstance.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                    }
                }, 100);
            }
        };

        const toggleMap = () => {
            // Use the same approach as tab switching
            const mapState = saveMapState();
            
            // Destroy map before render (just like tab switch does)
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
                markersLayer = null;
                routeLayer = null;
                DATA.mapInitialized = false;
            }
            
            DATA.showMap = !DATA.showMap;
            saveToStorage();
            render();
            
            // Restore map state (just like tab switch does)
            restoreMapState(mapState);
        };

        const getAllMapLocations = () => {
            // Combine regular locations and waypoints with order info
            const locations = [];
            
            // Add all geocoded locations
            Object.entries(DATA.geocodedLocations).forEach(([name, coords]) => {
                locations.push({
                    id: name,
                    name: name,
                    lat: coords.lat,
                    lng: coords.lng,
                    type: 'location',
                    order: DATA.locationOrder?.[name] || 999
                });
            });
            
            // Add all custom waypoints
            DATA.customWaypoints.forEach((wp, idx) => {
                locations.push({
                    id: `waypoint_${idx}`,
                    name: wp.name,
                    lat: wp.lat,
                    lng: wp.lng,
                    type: 'waypoint',
                    waypointIndex: idx,
                    order: DATA.locationOrder?.[`waypoint_${idx}`] || 999
                });
            });
            
            // Sort by order
            locations.sort((a, b) => a.order - b.order);
            
            return locations;
        };

        const updateLocationOrder = () => {
            // Save current order based on DOM position
            const items = document.querySelectorAll('.location-item');
            DATA.locationOrder = {};
            
            items.forEach((item, index) => {
                const locationId = item.dataset.locationId;
                if (locationId) {
                    DATA.locationOrder[locationId] = index;
                }
            });
            
            saveToStorage();
        };

        let draggedElement = null;

        window.handleDragStart = (e, locationId) => {
            draggedElement = locationId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };

        window.handleDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const draggingItem = document.querySelector('.dragging');
            const afterElement = getDragAfterElement(e.currentTarget.parentElement, e.clientY);
            
            if (afterElement == null) {
                e.currentTarget.parentElement.appendChild(draggingItem);
            } else {
                e.currentTarget.parentElement.insertBefore(draggingItem, afterElement);
            }
        };

        window.handleDrop = (e, locationId) => {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            updateLocationOrder();
            
            // Redraw route with new order
            if (DATA.mapView === 'route' && DATA.mapInitialized) {
                drawRoute();
            }
        };

        window.handleDragEnd = (e) => {
            e.target.classList.remove('dragging');
            draggedElement = null;
        };

        const getDragAfterElement = (container, y) => {
            const draggableElements = [...container.querySelectorAll('.location-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        };
       
        const drawRoute = () => {
            if (!routeLayer) return 0;
            
            routeLayer.clearLayers();
            
            const orderedLocations = getAllMapLocations();
            const routeCoords = [];
            let totalDistance = 0;
            let prevCoords = null;
            
            orderedLocations.forEach(loc => {
                const currentCoords = [loc.lat, loc.lng];
                routeCoords.push(currentCoords);
                
                if (prevCoords) {
                    totalDistance += calculateDistance(
                        prevCoords[0], prevCoords[1],
                        currentCoords[0], currentCoords[1]
                    );
                }
                
                prevCoords = currentCoords;
            });
            
            if (routeCoords.length > 1) {
                L.polyline(routeCoords, {
                    color: DATA.mapEditMode ? '#f59e0b' : '#3b82f6',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: DATA.mapEditMode ? '5, 10' : '10, 10'
                }).addTo(routeLayer);
                
                const arrowInterval = Math.max(1, Math.floor(routeCoords.length / 8));
                for (let i = 0; i < routeCoords.length - 1; i += arrowInterval) {
                    const midLat = (routeCoords[i][0] + routeCoords[i + 1][0]) / 2;
                    const midLng = (routeCoords[i][1] + routeCoords[i + 1][1]) / 2;
                    
                    L.marker([midLat, midLng], {
                        icon: L.divIcon({
                            html: '',
                            className: 'route-arrow',
                            iconSize: [20, 20]
                        })
                    }).addTo(routeLayer);
                }
            }
            
            return totalDistance;
        };

        window.editWaypointInfo = (idx) => {
            const waypoint = DATA.customWaypoints[idx];
            const newName = prompt('Enter waypoint name:', waypoint.name);
            
            if (newName && newName !== waypoint.name) {
                DATA.customWaypoints[idx].name = newName;
                saveToStorage();
                
                // Update the display
                const nameSpan = document.querySelector(`[data-location="waypoint_${idx}"]`);
                if (nameSpan) {
                    nameSpan.textContent = newName;
                }
                
                // Redraw map markers
                if (DATA.mapInitialized) {
                    renderMapFromCache();
                }
            }
        };

        window.deleteWaypointFromList = (idx) => {
            showConfirmModal('Delete Waypoint', `Delete waypoint "${DATA.customWaypoints[idx].name}"?`, (confirmed) => {
                if (confirmed) {
                    DATA.customWaypoints.splice(idx, 1);
                    saveToStorage();
                    
                    // Remove from DOM
                    const item = document.querySelector(`[data-location-id="waypoint_${idx}"]`);
                    if (item) item.remove();
                    
                    // Redraw map
                    if (DATA.mapInitialized) {
                        renderMapFromCache();
                    }
                    
                    // Refresh the list to update indices
                    toggleMapEditMode();
                    toggleMapEditMode();
                }
            });
        };

        let draggedChecklistItem = null;
        let draggedChecklistType = null;

        const handleChecklistDragStart = (e, type, index) => {
            draggedChecklistItem = index;
            draggedChecklistType = type;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };

        const handleChecklistDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        };

        const handleChecklistDrop = (e, type, targetIndex) => {
            e.preventDefault();
            if (draggedChecklistType !== type || draggedChecklistItem === null) return;
            
            const sourceIndex = draggedChecklistItem;
            
            if (sourceIndex !== targetIndex) {
                let arrayToUpdate;
                switch (type) {
                    case 'packing':
                        arrayToUpdate = DATA.packingList;
                        break;
                    case 'before':
                        arrayToUpdate = DATA.beforeChecklist;
                        break;
                    case 'trip':
                        arrayToUpdate = DATA.tripChecklist;
                        break;
                    default:
                        return;
                }
                
                // Remove the dragged item
                const [draggedItem] = arrayToUpdate.splice(sourceIndex, 1);
                
                // Insert at new position
                if (targetIndex >= arrayToUpdate.length) {
                    arrayToUpdate.push(draggedItem);
                } else {
                    arrayToUpdate.splice(targetIndex, 0, draggedItem);
                }
                
                saveToStorage();
                render();
            }
            
            e.target.classList.remove('drag-over');
        };

        const handleChecklistDragEnd = (e) => {
            draggedChecklistItem = null;
            draggedChecklistType = null;
            e.target.classList.remove('dragging');
            
            // Remove drag-over classes from all items
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        };

        // Make functions available globally
        window.handleChecklistDragStart = handleChecklistDragStart;
        window.handleChecklistDragOver = handleChecklistDragOver;
        window.handleChecklistDrop = handleChecklistDrop;
        window.handleChecklistDragEnd = handleChecklistDragEnd;

        const handleReceiptUpload = (dayIndex, event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                if (!DATA.days[dayIndex].receipts) {
                    DATA.days[dayIndex].receipts = [];
                }
                
                // Create receipt with empty fields (user will fill in description first)
                const newReceipt = {
                    image: e.target.result,
                    amount: '',
                    category: '',
                    description: '',
                    date: DATA.days[dayIndex].dt
                };
                
                DATA.days[dayIndex].receipts.push(newReceipt);
                saveToStorage();
                render();
                
                // Focus on the description input for the new receipt
                setTimeout(() => {
                    const receiptItems = document.querySelectorAll('.receipt-item');
                    const lastReceipt = receiptItems[receiptItems.length - 1];
                    if (lastReceipt) {
                        const descInput = lastReceipt.querySelector('input[placeholder="Description"]');
                        if (descInput) descInput.focus();
                    }
                }, 100);
            };
            reader.readAsDataURL(file);
        };
       
        const updateReceipt = (dayIndex, receiptIndex, field, value) => {
            if (field === 'amount') {
                DATA.days[dayIndex].receipts[receiptIndex][field] = parseFloat(value) || 0;
            } else {
                DATA.days[dayIndex].receipts[receiptIndex][field] = value;
                
                // Auto-categorize when description changes
                if (field === 'description' && value && !DATA.days[dayIndex].receipts[receiptIndex].category) {
                    const suggestedCategory = autoCategorizeReceipt(value);
                    if (suggestedCategory) {
                        DATA.days[dayIndex].receipts[receiptIndex].category = suggestedCategory;
                    }
                }
            }
            saveToStorage();
            showToast(' Receipt saved', 'success');
            render();
        };

        const deleteReceipt = (dayIndex, receiptIndex) => {
            showConfirmModal('Delete Receipt', 'Delete this receipt?', (confirmed) => {
                if (confirmed) {
                    DATA.days[dayIndex].receipts.splice(receiptIndex, 1);
                    saveToStorage();
                    render();
                }
            });
        };

        const autoCategorizeReceipt = (description) => {
            if (!description) return '';
            
            const desc = description.toLowerCase();
            
            // Accommodation keywords
            if (desc.includes('hotel') || desc.includes('hostel') || desc.includes('airbnb') || 
                desc.includes('booking') || desc.includes('stay') || desc.includes('lodge') ||
                desc.includes('inn') || desc.includes('motel') || desc.includes('resort')) {
                return 'acc';
            }
            
            // Transportation keywords
            if (desc.includes('train') || desc.includes('bus') || desc.includes('taxi') || 
                desc.includes('uber') || desc.includes('lyft') || desc.includes('flight') ||
                desc.includes('subway') || desc.includes('metro') || desc.includes('rail') ||
                desc.includes('ticket') || desc.includes('transport') || desc.includes('car rental') ||
                desc.includes('gas') || desc.includes('fuel') || desc.includes('parking')) {
                return 'trn';
            }
            
            // Food keywords
            if (desc.includes('restaurant') || desc.includes('cafe') || desc.includes('coffee') ||
                desc.includes('food') || desc.includes('pizza') || desc.includes('sushi') ||
                desc.includes('burger') || desc.includes('dinner') || desc.includes('lunch') ||
                desc.includes('breakfast') || desc.includes('bar') || desc.includes('pub') ||
                desc.includes('kitchen') || desc.includes('grill') || desc.includes('bakery') ||
                desc.includes('grocery') || desc.includes('market') || desc.includes('supermarket')) {
                return 'food';
            }
            
            // Activities keywords
            if (desc.includes('museum') || desc.includes('ticket') || desc.includes('tour') ||
                desc.includes('admission') || desc.includes('entry') || desc.includes('temple') ||
                desc.includes('shrine') || desc.includes('park') || desc.includes('attraction') ||
                desc.includes('show') || desc.includes('concert') || desc.includes('theater') ||
                desc.includes('cinema') || desc.includes('spa') || desc.includes('massage') ||
                desc.includes('activity') || desc.includes('experience')) {
                return 'act';
            }
            
            // Check custom categories
            for (const cat of DATA.categories) {
                if (cat.id !== 'acc' && cat.id !== 'trn' && cat.id !== 'food' && cat.id !== 'act') {
                    if (desc.includes(cat.name.toLowerCase()) || desc.includes(cat.id)) {
                        return cat.id;
                    }
                }
            }
            
            return ''; // No category matched
        };

        const calculateReceiptStats = () => {
            let totalReceipts = 0;
            let totalAmount = 0;
            const categoryTotals = {};
            
            DATA.days.forEach(day => {
                if (day.receipts && day.receipts.length > 0) {
                    day.receipts.forEach(receipt => {
                        totalReceipts++;
                        const amount = parseFloat(receipt.amount) || 0;
                        totalAmount += amount;
                        
                        if (receipt.category) {
                            if (!categoryTotals[receipt.category]) {
                                categoryTotals[receipt.category] = 0;
                            }
                            categoryTotals[receipt.category] += amount;
                        }
                    });
                }
            });
            
            return { totalReceipts, totalAmount, categoryTotals };
        };
       
        const createNewTrip = () => {
            // Step 1: Ask for trip name
            showInputModal(
                'Create New Trip',
                'Enter a name for your new trip',
                'My Amazing Trip',
                '',
                (tripName) => {
                    // Step 2: Ask for currency
                    let currencyModalHTML = `
                        <div style="margin-bottom:20px;">
                            <label style="display:block;margin-bottom:10px;font-weight:600;">Select Currency</label>
                            <select id="currencySelect" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;">
                                ${Object.keys(CURRENCIES).map(code => 
                                    `<option value="${code}">${CURRENCIES[code].symbol} ${CURRENCIES[code].name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:10px;font-weight:600;">Default Exchange Rate (per $1 USD)</label>
                            <div style="display:flex;gap:10px;align-items:center;">
                                <span style="font-size:20px;font-weight:600;">$1 USD =</span>
                                <input type="number" id="exchangeRateInput" value="155" step="0.01" style="flex:1;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;">
                                <span id="currencySymbolDisplay" style="font-size:20px;font-weight:600;"></span>
                            </div>
                        </div>
                    `;
                    
                    DATA.showModal = {
                        title: 'Select Currency',
                        message: currencyModalHTML,
                        type: 'custom',
                        confirmText: 'Next'
                    };
                    
                    window.modalCallback = () => {
                        const currency = document.getElementById('currencySelect').value;
                        const rate = parseFloat(document.getElementById('exchangeRateInput').value) || 155;
                        
                        // Step 3: Ask for dates
                        const today = new Date();
                        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                        
                        let dateModalHTML = `
                            <div style="margin-bottom:20px;">
                                <label style="display:block;margin-bottom:10px;font-weight:600;">Trip Start Date</label>
                                <input type="date" id="startDateInput" value="${today.toISOString().split('T')[0]}" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;">
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="display:block;margin-bottom:10px;font-weight:600;">Trip End Date</label>
                                <input type="date" id="endDateInput" value="${nextWeek.toISOString().split('T')[0]}" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;">
                            </div>
                            <div style="font-size:14px;color:#666;padding:10px;background:#f9fafb;border-radius:6px;">
                                 You can always adjust these dates later
                            </div>
                        `;
                        
                        DATA.showModal = {
                            title: 'Set Trip Dates',
                            message: dateModalHTML,
                            type: 'custom',
                            confirmText: 'Next'
                        };
                        
                        window.modalCallback = () => {
                            const startDate = document.getElementById('startDateInput').value;
                            const endDate = document.getElementById('endDateInput').value;
                            
                            // Validate dates
                            if (new Date(startDate) > new Date(endDate)) {
                                showAlertModal('Invalid Dates', 'End date must be after start date.');
                                return;
                            }
                            
                            // Step 4: Ask for budget with "not sure" option
                            let budgetModalHTML = `
                                <div style="margin-bottom:20px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                        <label style="font-weight:600;font-size:16px;">Total Budget (USD)</label>
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <input type="checkbox" id="notSureCheckbox" style="width:20px;height:20px;">
                                            <label for="notSureCheckbox" style="font-size:14px;color:#666;cursor:pointer;">Not sure yet</label>
                                        </div>
                                    </div>
                                    <input type="number" id="budgetInput" value="5000" step="100" min="0" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:18px;font-weight:600;">
                                </div>
                                <div style="font-size:14px;color:#666;padding:10px;background:#f9fafb;border-radius:6px;">
                                    <div style="margin-bottom:5px;"> Budget estimates:</div>
                                    <ul style="margin:0;padding-left:20px;">
                                        <li>Budget travel: $30-50 per day</li>
                                        <li>Comfort travel: $100-200 per day</li>
                                        <li>Luxury travel: $200-500+ per day</li>
                                    </ul>
                                </div>
                            `;
                            
                            DATA.showModal = {
                                title: 'Set Your Budget',
                                message: budgetModalHTML,
                                type: 'custom',
                                confirmText: 'Create Trip'
                            };
                            
                            window.modalCallback = () => {
                                const notSure = document.getElementById('notSureCheckbox').checked;
                                const budgetValue = notSure ? 0 : parseFloat(document.getElementById('budgetInput').value) || 5000;
                                
                                // Step 5: Create the trip
                                const tripId = 'trip_' + Date.now();
                                const currencySymbol = CURRENCIES[currency].symbol;
                                
                                // Calculate number of days
                                const start = new Date(startDate);
                                const end = new Date(endDate);
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                                
                                // Create days array based on date range
                                const days = [];
                                for (let i = 0; i < diffDays; i++) {
                                    const currentDate = new Date(start);
                                    currentDate.setDate(start.getDate() + i);
                                    const formattedDate = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()}`;
                                    
                                    const newDay = {
                                        d: i + 1,
                                        dt: formattedDate,
                                        loc: i === 0 ? 'Starting Location' : 
                                            i === diffDays - 1 ? 'Final Destination' : 
                                            'Day ' + (i + 1) + ' Destination',
                                        note: '',
                                        done: false,
                                        a: {},
                                        photos: [],
                                        journalNote: '',
                                        schedule: [],
                                        showSchedule: false,
                                        weather: null,
                                        weatherLoading: false,
                                        receipts: []
                                    };
                                    
                                    // Add default categories to the day
                                    DEFAULT_CATEGORIES.forEach(cat => {
                                        newDay[cat.id] = {d: '', p: 0};
                                        newDay.a[cat.id] = 0;
                                    });
                                    
                                    days.push(newDay);
                                }
                                
                                // Create a completely new empty trip
                                const newTrip = {
                                    // Basic trip info
                                    tripTitle: tripName,
                                    tripSubtitle: `${new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                                    tripNotes: '',
                                    
                                    // Budget in USD (this is the connecting factor)
                                    budget: budgetValue, // This is USD (0 if "not sure")
                                    
                                    // Currency settings for this specific trip
                                    rate: rate,
                                    currency: currency,
                                    currencySymbol: currencySymbol,
                                    liveRate: true,
                                    lastFetchedRate: null,
                                    
                                    // Dates
                                    tripStartDate: startDate,
                                    tripEndDate: endDate,
                                    
                                    // Categories (default set)
                                    categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
                                    categoryBudgets: {
                                        acc: 0,
                                        trn: 0,
                                        food: 0,
                                        act: 0
                                    },
                                    showCategoryManager: false,
                                    
                                    // Travelers
                                    travelers: ['Traveler 1'],
                                    travelerCount: 1,
                                    costSplitMode: 'total',
                                    
                                    // UI states (all false/empty)
                                    iconPickerOpen: false,
                                    iconPickerCategory: null,
                                    expanded: null,
                                    editing: null,
                                    editTitle: false,
                                    editPackingList: false,
                                    editTripChecklist: false,
                                    editBeforeChecklist: false,
                                    editCategoryBudget: null,
                                    showEst: false,
                                    editBudget: false,
                                    editRate: false,
                                    converterUSD: 100,
                                    converterYEN: 10000,
                                    searchQuery: '',
                                    searchResults: [],
                                    showSearchResults: false,
                                    searchMode: 'enter',
                                    chartView: 'planned',
                                    showDailyBudget: false,
                                    showChart: false,
                                    photoModal: null,
                                    activeTab: 'planning',
                                    showMap: false,
                                    mapInitialized: false,
                                    mapView: 'all',
                                    geocodedLocations: {},
                                    locationOrder: {},
                                    customWaypoints: [],
                                    mapEditMode: false,
                                    draggableMarkers: {},
                                    editingLocation: null,
                                    
                                    // Checklists (with some defaults)
                                    beforeChecklist: [
                                        {item: 'Book flights', checked: false},
                                        {item: 'Get travel insurance', checked: false},
                                        {item: 'Book accommodations', checked: false}
                                    ],
                                    tripChecklist: [
                                        {item: 'Charge electronics', checked: false},
                                        {item: 'Pack passport', checked: false},
                                        {item: 'Print tickets', checked: false}
                                    ],
                                    packingList: [],
                                    
                                    // Receipts (empty)
                                    receipts: [],
                                    showReceipts: false,
                                    
                                    // Days (created based on date range)
                                    days: days
                                };
                                
                                window.ALL_TRIPS[tripId] = newTrip;
                                window.CURRENT_TRIP_ID = tripId;
                                
                                // Clear current DATA and load the new empty trip
                                Object.keys(DATA).forEach(key => delete DATA[key]);
                                Object.assign(DATA, JSON.parse(JSON.stringify(newTrip)));
                                
                                saveToStorage();
                                
                                // Reset all UI states
                                const statesToReset = {
                                    editTripChecklist: false,
                                    editBeforeChecklist: false,
                                    editPackingList: false,
                                    showTravelers: false,
                                    showTravelerList: false,
                                    editing: null,
                                    expanded: null,
                                    editTitle: false,
                                    editBudget: false,
                                    editRate: false,
                                    showEst: false,
                                    showSearchResults: false,
                                    showDailyBudget: false,
                                    showChart: false,
                                    photoModal: null,
                                    iconPickerOpen: false,
                                    iconPickerCategory: null,
                                    editCategoryBudget: null,
                                    showSettings: false,
                                    showExportMenu: false,
                                    showAnalyticsPage: null,
                                    showTripManager: false,
                                    editingCategoryModal: null,
                                    editingNotesModal: null,
                                    showModal: null,
                                    showMap: false,
                                    showReceipts: false,
                                    settingsPage: 'main',
                                    activeTab: 'planning',
                                    mapView: 'all',
                                    chartView: 'planned',
                                    costSplitMode: 'total',
                                    searchMode: 'enter'
                                };
                                
                                Object.keys(statesToReset).forEach(key => {
                                    if (DATA[key] !== undefined) {
                                        DATA[key] = statesToReset[key];
                                    }
                                });
                                
                                render();
                            };
                            
                            // Add functionality for "not sure" checkbox
                            setTimeout(() => {
                                const notSureCheckbox = document.getElementById('notSureCheckbox');
                                const budgetInput = document.getElementById('budgetInput');
                                
                                notSureCheckbox.onchange = () => {
                                    if (notSureCheckbox.checked) {
                                        budgetInput.disabled = true;
                                        budgetInput.style.opacity = '0.6';
                                        budgetInput.style.backgroundColor = '#f9fafb';
                                        budgetInput.placeholder = 'Budget not set';
                                    } else {
                                        budgetInput.disabled = false;
                                        budgetInput.style.opacity = '1';
                                        budgetInput.style.backgroundColor = 'white';
                                        budgetInput.placeholder = '';
                                    }
                                };
                                
                                // Initialize based on default (not checked)
                                notSureCheckbox.checked = false;
                                notSureCheckbox.onchange();
                            }, 100);
                            
                            render();
                        };
                        
                        // Add date validation
                        setTimeout(() => {
                            const startDateInput = document.getElementById('startDateInput');
                            const endDateInput = document.getElementById('endDateInput');
                            
                            // Set minimum date to today
                            startDateInput.min = today.toISOString().split('T')[0];
                            endDateInput.min = today.toISOString().split('T')[0];
                            
                            // When start date changes, update end date min
                            startDateInput.onchange = () => {
                                endDateInput.min = startDateInput.value;
                                if (endDateInput.value < startDateInput.value) {
                                    endDateInput.value = startDateInput.value;
                                }
                            };
                        }, 100);
                        
                        render();
                    };
                    
                    // Update currency symbol when currency selection changes
                    setTimeout(() => {
                        const currencySelect = document.getElementById('currencySelect');
                        const rateInput = document.getElementById('exchangeRateInput');
                        const symbolDisplay = document.getElementById('currencySymbolDisplay');
                        
                        currencySelect.onchange = () => {
                            const selectedCurrency = currencySelect.value;
                            symbolDisplay.textContent = CURRENCIES[selectedCurrency].symbol;
                            
                            // Set default rates for common currencies
                            const defaultRates = {
                                'JPY': 155,
                                'EUR': 0.92,
                                'GBP': 0.79,
                                'CAD': 1.35,
                                'AUD': 1.52,
                                'CHF': 0.88,
                                'CNY': 7.25,
                                'KRW': 1330,
                                'MXN': 17.5,
                                'INR': 83
                            };
                            
                            if (defaultRates[selectedCurrency]) {
                                rateInput.value = defaultRates[selectedCurrency];
                            }
                        };
                        
                        // Trigger initial update
                        currencySelect.dispatchEvent(new Event('change'));
                    }, 100);
                    
                    render();
                }
            );
        };

        const switchTrip = (tripId) => {
            if (!window.ALL_TRIPS[tripId]) return;
            
            window.CURRENT_TRIP_ID = tripId;
            
            // Clear current DATA and load new trip
            Object.keys(DATA).forEach(key => delete DATA[key]);
            Object.assign(DATA, JSON.parse(JSON.stringify(window.ALL_TRIPS[tripId])));
            
            localStorage.setItem('currentTripId', tripId);
            render();
            
            // Auto-fetch weather for upcoming days in the new trip
            setTimeout(checkAndFetchUpcomingWeather, 1000);
        };

        const deleteTrip = (tripId) => {
            const tripCount = Object.keys(window.ALL_TRIPS).length;
            
            if (tripCount === 1) {
                alert('Cannot delete your only trip!');
                return;
            }
            
            const tripName = window.ALL_TRIPS[tripId].tripTitle;
            if (!confirm(`Delete trip "${tripName}"? This cannot be undone.`)) return;
            
            delete window.ALL_TRIPS[tripId];
            
            // If deleting current trip, switch to another
            if (tripId === window.CURRENT_TRIP_ID) {
                const remainingTrips = Object.keys(window.ALL_TRIPS);
                if (remainingTrips.length > 0) {
                    switchTrip(remainingTrips[0]);
                }
            }
            
            localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
            render();
        };

        const duplicateTrip = (tripId) => {
            const originalTrip = window.ALL_TRIPS[tripId];
            const newTripName = prompt('Enter name for duplicate trip:', originalTrip.tripTitle + ' (Copy)');
            if (!newTripName) return;
            
            const newTripId = 'trip_' + Date.now();
            
            // Deep copy the trip
            const duplicatedTrip = JSON.parse(JSON.stringify(originalTrip));
            duplicatedTrip.tripTitle = newTripName;
            
            // Reset some fields
            duplicatedTrip.days.forEach(day => {
                day.done = false;
                day.a = {};
                if (day.photos) day.photos = [];
                if (day.receipts) day.receipts = [];
                if (day.journalNote) day.journalNote = '';
                if (day.weather) day.weather = null;
            });
            
            window.ALL_TRIPS[newTripId] = duplicatedTrip;
            localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
            
            showConfirmModal('Switch Trip', 'Switch to duplicated trip now?', (confirmed) => {
                if (confirmed) {
                    switchTrip(newTripId);
                } else {
                    render();
                }
            });
        };

        const exportTripAsTemplate = () => {
            const template = {
                tripTitle: DATA.tripTitle + ' (Template)',
                budget: DATA.budget,
                currency: DATA.currency,
                currencySymbol: DATA.currencySymbol,
                rate: DATA.rate,
                categories: DATA.categories,
                categoryBudgets: DATA.categoryBudgets,
                travelerCount: DATA.travelerCount,
                days: DATA.days.map(day => ({
                    d: day.d,
                    dt: '',
                    loc: day.loc,
                    ...Object.fromEntries(
                        DATA.categories.map(cat => [
                            cat.id,
                            {
                                d: day[cat.id]?.d || '',
                                n: day[cat.id]?.n || '',
                                p: day[cat.id]?.p || 0
                            }
                        ])
                    ),
                    note: day.note || '',
                    done: false,
                    a: {},
                    photos: [],
                    receipts: [],
                    journalNote: '',
                    schedule: day.schedule ? JSON.parse(JSON.stringify(day.schedule)) : []
                }))
            };
            
            const jsonStr = JSON.stringify(template, null, 2);
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${DATA.tripTitle.replace(/[^a-z0-9]/gi, '_')}-template.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const importTripTemplate = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const template = JSON.parse(event.target.result);
                        const tripId = 'trip_' + Date.now();
                        
                        // Merge template with current defaults
                        const newTrip = {
                            ...JSON.parse(JSON.stringify(DATA)), // Copy current defaults
                            ...template,
                            tripStartDate: new Date().toISOString().split('T')[0],
                            tripEndDate: new Date(Date.now() + (template.days.length * 24 * 60 * 60 * 1000)).toISOString().split('T')[0]
                        };
                        
                        window.ALL_TRIPS[tripId] = newTrip;
                        localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
                        
                        showConfirmModal('Template Imported', 'Template imported! Switch to this trip now?', (confirmed) => {
                            if (confirmed) {
                                switchTrip(tripId);
                            } else {
                                render();
                            }
                        });
                    } catch (err) {
                        alert('Error importing template: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        const compareTripStats = () => {
            const trips = Object.entries(window.ALL_TRIPS).map(([id, trip]) => {
                const days = trip.days || [];
                
                // Calculate totals in local currency
                const totalPlannedLocal = days.reduce((sum, day) => {
                    return sum + (trip.categories || []).reduce((catSum, cat) => {
                        return catSum + (day[cat.id]?.p || 0);
                    }, 0);
                }, 0);
                
                const totalActualLocal = days.reduce((sum, day) => {
                    return sum + (trip.categories || []).reduce((catSum, cat) => {
                        return catSum + (day.a?.[cat.id] || 0);
                    }, 0);
                }, 0);
                
                // Convert to USD using this trip's exchange rate
                const exchangeRate = trip.rate || 155;
                const totalPlannedUSD = totalPlannedLocal / exchangeRate;
                const totalActualUSD = totalActualLocal / exchangeRate;
                const budgetUSD = trip.budget || 0; // Budget is already in USD
                
                return {
                    id,
                    name: trip.tripTitle,
                    budgetUSD: budgetUSD, // USD
                    budgetLocal: budgetUSD * exchangeRate, // Local currency
                    totalPlannedUSD: totalPlannedUSD, // USD
                    totalPlannedLocal: totalPlannedLocal, // Local currency
                    totalActualUSD: totalActualUSD, // USD
                    totalActualLocal: totalActualLocal, // Local currency
                    days: days.length,
                    completed: days.filter(d => d.done).length,
                    currency: trip.currencySymbol || '',
                    exchangeRate: exchangeRate
                };
            });
            
            return trips;
        };
       

        // ============================================
        // EXPORT & SHARE FUNCTIONS
        // ============================================

        const exportToPDF = () => {
            // Create a print-friendly version
            window.print();
        };

        const exportToCSV = () => {
            let csv = 'Day,Date,Location,Accommodation,Transportation,Food,Activities,Other,Total Planned,Total Actual,Done\n';
            
            DATA.days.forEach(day => {
                const planned = calc(day);
                const actual = calcA(day);
                
                const row = [
                    day.d,
                    day.dt,
                    `"${day.loc}"`,
                    day.acc?.p || 0,
                    day.trn?.p || 0,
                    day.food?.p || 0,
                    day.act?.p || 0,
                    day.misc?.p || 0,
                    planned,
                    actual,
                    day.done ? 'Yes' : 'No'
                ].join(',');
                
                csv += row + '\n';
            });
            
            // Add summary
            csv += '\n';
            csv += 'SUMMARY\n';
            csv += `Total Budget,${DATA.budget * DATA.rate}\n`;
            csv += `Total Planned,${DATA.days.reduce((sum, day) => sum + calc(day), 0)}\n`;
            csv += `Total Actual,${DATA.days.reduce((sum, day) => sum + calcA(day), 0)}\n`;
            csv += `Currency,${DATA.currency}\n`;
            csv += `Exchange Rate,${DATA.rate}\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${DATA.tripTitle.replace(/[^a-z0-9]/gi, '_')}_export.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const exportToICalendar = () => {
            let ical = 'BEGIN:VCALENDAR\n';
            ical += 'VERSION:2.0\n';
            ical += 'PRODID:-//Trip Budget Planner//EN\n';
            ical += `X-WR-CALNAME:${DATA.tripTitle}\n`;
            ical += 'X-WR-TIMEZONE:UTC\n';
            ical += 'CALSCALE:GREGORIAN\n';
            ical += 'METHOD:PUBLISH\n';
            
            DATA.days.forEach(day => {
                if (!day.dt) return; // Skip days without dates
                
                // Parse date
                const date = new Date(day.dt + 'T00:00:00');
                const dateStr = date.toISOString().replace(/[-:]/g, '').split('T')[0];
                
                // Main day event
                ical += 'BEGIN:VEVENT\n';
                ical += `UID:day-${day.d}-${Date.now()}@tripbudget\n`;
                ical += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
                ical += `DTSTART;VALUE=DATE:${dateStr}\n`;
                ical += `DTEND;VALUE=DATE:${dateStr}\n`;
                ical += `SUMMARY:Day ${day.d}: ${day.loc}\n`;
                
                // Description with details
                let description = `Location: ${day.loc}\\n`;
                if (day.acc?.n) description += `Accommodation: ${day.acc.n}\\n`;
                if (day.trn?.d) description += `Transport: ${day.trn.d}\\n`;
                if (day.food?.d) description += `Food: ${day.food.d}\\n`;
                if (day.act?.d) description += `Activities: ${day.act.d}\\n`;
                if (day.note) description += `Notes: ${day.note}\\n`;
                description += `Budget: ${DATA.currencySymbol}${calc(day).toLocaleString()}`;
                
                ical += `DESCRIPTION:${description}\n`;
                ical += `LOCATION:${day.loc}\n`;
                ical += 'END:VEVENT\n';
                
                // Add schedule items as separate events
                if (day.schedule && day.schedule.length > 0) {
                    day.schedule.forEach((item, idx) => {
                        if (!item.time || !item.activity) return;
                        
                        const [hours, minutes] = item.time.split(':');
                        const eventDate = new Date(day.dt + `T${item.time}:00`);
                        const startStr = eventDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        
                        // Assume 1 hour duration
                        const endDate = new Date(eventDate.getTime() + 60 * 60 * 1000);
                        const endStr = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        
                        ical += 'BEGIN:VEVENT\n';
                        ical += `UID:schedule-${day.d}-${idx}-${Date.now()}@tripbudget\n`;
                        ical += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
                        ical += `DTSTART:${startStr}\n`;
                        ical += `DTEND:${endStr}\n`;
                        ical += `SUMMARY:${item.activity}\n`;
                        ical += `DESCRIPTION:Day ${day.d} - ${day.loc}\n`;
                        ical += `LOCATION:${day.loc}\n`;
                        ical += 'END:VEVENT\n';
                    });
                }
            });
            
            ical += 'END:VCALENDAR\n';
            
            // Download
            const blob = new Blob([ical], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${DATA.tripTitle.replace(/[^a-z0-9]/gi, '_')}_calendar.ics`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const generateShareableHTML = () => {
            const s = stats();
            
            let html = `<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${DATA.tripTitle} - Trip Itinerary</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 40px 20px; background: #f5f5f5; }
                .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                h1 { color: #1f2937; margin-bottom: 10px; font-size: 32px; }
                .subtitle { color: #6b7280; margin-bottom: 30px; font-size: 16px; }
                .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
                .stat-card { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 20px; border-radius: 8px; }
                .stat-label { font-size: 12px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; }
                .stat-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
                .stat-sub { font-size: 13px; opacity: 0.8; }
                .day-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
                .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
                .day-title { font-size: 20px; font-weight: 600; color: #1f2937; }
                .day-date { font-size: 14px; color: #6b7280; }
                .day-cost { font-size: 18px; font-weight: 600; color: #3b82f6; }
                .section { margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border-left: 3px solid #3b82f6; }
                .section-label { font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 4px; text-transform: uppercase; }
                .section-content { font-size: 14px; color: #1f2937; }
                .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 13px; }
                @media print {
                    body { background: white; padding: 0; }
                    .container { box-shadow: none; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>${DATA.tripTitle}</h1>
                <div class="subtitle">${DATA.tripStartDate} to ${DATA.tripEndDate}  ${DATA.days.length} days</div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Budget</div>
                        <div class="stat-value">${DATA.currencySymbol}${(DATA.budget * DATA.rate).toLocaleString()}</div>
                        <div class="stat-sub">$${DATA.budget.toLocaleString()}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div class="stat-label">Actual Spent</div>
                        <div class="stat-value">${DATA.currencySymbol}${s.tA.toLocaleString()}</div>
                        <div class="stat-sub">${s.pct.toFixed(1)}% of budget</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <div class="stat-label">Remaining</div>
                        <div class="stat-value">${DATA.currencySymbol}${Math.round(s.rem).toLocaleString()}</div>
                        <div class="stat-sub">${s.done}/${DATA.days.length} days completed</div>
                    </div>
                </div>
                
                <h2 style="margin-bottom: 20px; color: #1f2937;">Day-by-Day Itinerary</h2>
                
                ${DATA.days.map(day => {
                    const dayTotal = day.done ? calcA(day) : calc(day);
                    return `
                        <div class="day-card">
                            <div class="day-header">
                                <div>
                                    <div class="day-title">Day ${day.d}: ${day.loc}</div>
                                    <div class="day-date">${day.dt}</div>
                                </div>
                                <div class="day-cost">${DATA.currencySymbol}${dayTotal.toLocaleString()}</div>
                            </div>
                            
                            ${DATA.categories.map(cat => {
                                const catData = day[cat.id] || {};
                                if (!catData.n && !catData.d) return '';
                                return `
                                    <div class="section">
                                        <div class="section-label">${cat.icon} ${cat.name}</div>
                                        <div class="section-content">${catData.n || catData.d}</div>
                                    </div>
                                `;
                            }).join('')}
                            
                            ${day.note ? `
                                <div class="section" style="border-left-color: #f59e0b;">
                                    <div class="section-label"> Notes</div>
                                    <div class="section-content">${day.note}</div>
                                </div>
                            ` : ''}
                            
                            ${day.schedule && day.schedule.length > 0 ? `
                                <div class="section" style="border-left-color: #8b5cf6;">
                                    <div class="section-label"> Schedule</div>
                                    ${day.schedule.sort((a, b) => a.time.localeCompare(b.time)).map(item => `
                                        <div style="display: flex; gap: 10px; margin-top: 6px;">
                                            <strong>${item.time}</strong>
                                            <span>${item.activity}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
                
                <div class="footer">
                    Generated by Trip Budget Planner  ${new Date().toLocaleDateString()}
                </div>
            </div>
        </body>
        </html>`;
            
            return html;
        };

        const exportToHTML = () => {
            const html = generateShareableHTML();
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${DATA.tripTitle.replace(/[^a-z0-9]/gi, '_')}_itinerary.html`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const emailItinerary = () => {
            const subject = encodeURIComponent(`${DATA.tripTitle} - Trip Itinerary`);
            const body = encodeURIComponent(`Check out my trip itinerary for ${DATA.tripTitle}!

        Trip Dates: ${DATA.tripStartDate} to ${DATA.tripEndDate}
        Total Days: ${DATA.days.length}
        Budget: ${DATA.currencySymbol}${(DATA.budget * DATA.rate).toLocaleString()}

        For the full detailed itinerary with day-by-day breakdown, schedule, and expenses, please download the attached HTML file or use the Trip Budget Planner app.

        Trip Overview:
        ${DATA.days.map(day => `Day ${day.d} (${day.dt}): ${day.loc}`).join('\n')}
        `);
            
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        };

        const copyShareableLink = async () => {
            // Generate a shareable JSON
            const shareData = {
                tripTitle: DATA.tripTitle,
                tripStartDate: DATA.tripStartDate,
                tripEndDate: DATA.tripEndDate,
                budget: DATA.budget,
                currency: DATA.currency,
                days: DATA.days.map(day => ({
                    d: day.d,
                    dt: day.dt,
                    loc: day.loc,
                    acc: day.acc,
                    trn: day.trn,
                    food: day.food,
                    act: day.act,
                    note: day.note,
                    schedule: day.schedule
                }))
            };
            
            const jsonStr = JSON.stringify(shareData);
            const base64 = btoa(jsonStr);
            
            // For now, just copy the base64 data
            // In a real app, you'd upload this to a server and get a short URL
            const shareText = `Trip: ${DATA.tripTitle}\nDates: ${DATA.tripStartDate} to ${DATA.tripEndDate}\nDays: ${DATA.days.length}\n\nTo import this trip, copy this data and use the "Import Template" feature:\n\n${base64}`;
            
            try {
                await navigator.clipboard.writeText(shareText);
                alert(' Shareable trip data copied to clipboard!\n\nYou can share this with others, and they can import it using the "Import Template" feature in Trip Manager.');
            } catch (err) {
                prompt('Copy this shareable data:', shareText);
            }
        };
       
        // Schedule event dragging
        let draggedEvent = null;
        let dragStartY = 0;
        let dragStartTime = null;
        let dragEdge = null;

        window.startEventDrag = (dayIndex, scheduleIndex, edge, event) => {
            event.stopPropagation();
            draggedEvent = { dayIndex, scheduleIndex };
            dragStartY = event.clientY;
            dragEdge = edge;
            
            const schedule = DATA.days[dayIndex].schedule[scheduleIndex];
            dragStartTime = schedule.time;
            
            document.body.style.cursor = 'ns-resize';
            
            // Get the time display element to update it directly (no re-render)
            const timeDisplay = event.target.closest('.timeline-event').querySelector('.timeline-event-time');
            
            const handleMove = (e) => {
                const deltaY = e.clientY - dragStartY;
                const minutesDelta = Math.round(deltaY / 2); // 2px = 1 minute
                
                const [hours, minutes] = dragStartTime.split(':').map(Number);
                let totalMinutes = hours * 60 + minutes + minutesDelta;
                
                // Clamp to 0-1439 (24 hours)
                totalMinutes = Math.max(0, Math.min(1439, totalMinutes));
                
                const newHours = Math.floor(totalMinutes / 60);
                const newMinutes = totalMinutes % 60;
                const newTime = `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
                
                // Update data without rendering
                DATA.days[dayIndex].schedule[scheduleIndex].time = newTime;
                
                // Update display directly
                if (timeDisplay) {
                    timeDisplay.textContent = newTime;
                }
            };
            
            const handleUp = () => {
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('mouseup', handleUp);
                document.body.style.cursor = 'default';
                draggedEvent = null;
                
                // Save and render once at the end
                saveToStorage();
                render();
            };
            
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleUp);
        };

        window.startEventResize = (dayIndex, scheduleIndex, edge, event) => {
            event.stopPropagation();
            startEventDrag(dayIndex, scheduleIndex, edge, event);
        };
       
        window.addEventInRange = (dayIndex, startHour, endHour) => {
        
            const formatHour = (h) => h === 0 ? '12 AM' : h < 12 ? h + ' AM' : h === 12 ? '12 PM' : (h - 12) + ' PM';
            
            showTimePickerModal(
                'Add Event',
                `Add an event during this time range (${formatHour(startHour)} - ${formatHour(endHour)})`,
                startHour,
                endHour,
                startHour.toString().padStart(2,'0') + ':00',
                (time) => {
                    if (!DATA.days[dayIndex].schedule) DATA.days[dayIndex].schedule = [];
                    DATA.days[dayIndex].schedule.push({
                        time: time,
                        activity: ''
                    });
                    saveToStorage();
                    render();
                }
            );
        };
       
        // Custom Modal System
        window.showInputModal = (title, message, placeholder, defaultValue, callback) => {
            DATA.showModal = {
                title,
                message,
                type: 'input',
                placeholder,
                defaultValue,
                confirmText: 'OK'
            };
            
            window.modalCallback = () => {
                const value = document.getElementById('modalInput').value;
                DATA.showModal = null;
                if (value) {
                    callback(value);
                } else {
                    render();
                }
            };
            
            render();
            setTimeout(() => {
                const input = document.getElementById('modalInput');
                if (input) input.focus();
            }, 100);
        };

        window.showTimePickerModal = (title, message, startHour, endHour, defaultTime, callback) => {
            const formatHour = (h) => h === 0 ? '12 AM' : h < 12 ? h + ' AM' : h === 12 ? '12 PM' : (h - 12) + ' PM';
            const rangeMessage = `Choose time between ${formatHour(startHour)} and ${formatHour(endHour)}`;
            
            DATA.showModal = {
                title,
                message,
                type: 'time',
                rangeMessage,
                confirmText: 'Add Event'
            };
            
            window.modalCallback = () => {
                const hour = parseInt(document.getElementById('modalHour').value);
                const minute = parseInt(document.getElementById('modalMinute').value);
                
                // Validate range
                if (hour < startHour || hour > endHour) {
                    DATA.showModal = null;
                    showAlertModal('Invalid Time', `Please choose a time between ${formatHour(startHour)} and ${formatHour(endHour)}`);
                    return;
                }
                
                const time = `${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}`;
                DATA.showModal = null;
                callback(time);
            };
            
            render();
            
            // Set default time
            setTimeout(() => {
                if (defaultTime) {
                    const [h, m] = defaultTime.split(':');
                    document.getElementById('modalHour').value = parseInt(h);
                    document.getElementById('modalMinute').value = parseInt(m);
                }
            }, 100);
        };

        window.showAlertModal = (title, message, callback) => {
            DATA.showModal = {
                title,
                message,
                type: 'alert',
                confirmText: 'OK'
            };
            
            window.modalCallback = () => {
                DATA.showModal = null;
                if (callback) {
                    callback();
                } else {
                    render();
                }
            };
            
            render();
        };

        window.showConfirmModal = (title, message, callback) => {
            DATA.showModal = {
                title,
                message,
                type: 'confirm',
                confirmText: 'Confirm'
            };
            
            window.modalCallback = () => {
                DATA.showModal = null;
                callback(true);
            };
            
            render();
        };

        const openCategoryModal = (dayIndex, categoryId) => {
            DATA.editingCategoryModal = { dayIndex, category: categoryId };
            render();
        };

        const closeCategoryModal = () => {
            DATA.editingCategoryModal = null;
            render();
        };

        const openNotesModal = (dayIndex) => {
            DATA.editingNotesModal = { dayIndex };
            render();
        };

        const closeNotesModal = () => {
            DATA.editingNotesModal = null;
            render();
        };

        const formatCurrency = (amount, currencySymbol, decimals = 0) => {
            const rounded = Math.round(amount);
            return `${currencySymbol}${rounded.toLocaleString()}`;
        };

        const getTodayDate = () => {
            const today = new Date();
            return today.toISOString().split('T')[0]; // Returns YYYY-MM-DD
        };

        const hapticFeedback = (type = 'light') => {
            // Check if haptics are disabled
            if (DATA.disableHaptics) return;
            
            if (navigator.vibrate) {
                const patterns = {
                    light: [10],
                    medium: [20],
                    heavy: [30],
                    success: [10, 50, 10],
                    error: [20, 100, 20]
                };
                navigator.vibrate(patterns[type] || patterns.light);
            }
        };

        // Sticky header scroll handler
        let lastScrollY = 0;
        let headerScrolled = false;

        const handleHeaderScroll = () => {
            const scrollY = window.scrollY;
            const header = document.querySelector('.header');
            
            if (!header) return;
            
            // Scrolled down more than 50px
            if (scrollY > 50 && !headerScrolled) {
                headerScrolled = true;
                header.classList.add('scrolled');
            }
            // Scrolled back to top
            else if (scrollY <= 50 && headerScrolled) {
                headerScrolled = false;
                header.classList.remove('scrolled');
            }
            
            lastScrollY = scrollY;
        };

        // Throttle scroll events for performance
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(handleHeaderScroll, 10);
        }, { passive: true });


        const render = () => {
            const s = stats();
            const app = document.getElementById('app');

              // Initialize h FIRST
            let h = '';

            // Custom Modal System - NOW THIS WORKS because h is already declared
            if (DATA.showModal) {
                h += `<div class="custom-modal-overlay" onclick="DATA.showModal=null;render()"></div>
                <div class="custom-modal">
                    <div class="custom-modal-header">
                        <h3 style="margin:0;font-size:18px;">${DATA.showModal.title}</h3>
                        <button onclick="DATA.showModal=null;render()" style="background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;"></button>
                    </div>
                    <div class="custom-modal-body">
                        ${DATA.showModal.message ? `<p style="margin-bottom:20px;color:#666;line-height:1.6;">${DATA.showModal.message}</p>` : ''}
                        
                        ${DATA.showModal.type === 'input' ? `
                            <input type="${DATA.showModal.inputType || 'text'}" 
                                id="modalInput" 
                                placeholder="${DATA.showModal.placeholder || ''}" 
                                value="${DATA.showModal.defaultValue || ''}"
                                style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;margin-bottom:15px;"
                                onkeydown="if(event.key==='Enter'){document.getElementById('modalConfirm').click();}">
                        ` : ''}
                        
                        ${DATA.showModal.type === 'textarea' ? `
                            <textarea id="modalInput" 
                                    placeholder="${DATA.showModal.placeholder || ''}" 
                                    style="width:100%;min-height:100px;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;margin-bottom:15px;resize:vertical;">${DATA.showModal.defaultValue || ''}</textarea>
                        ` : ''}
                        
                        ${DATA.showModal.type === 'time' ? `
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px;">Hour</label>
                                    <select id="modalHour" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;">
                                        ${Array.from({length: 24}, (_, i) => `<option value="${i}">${i.toString().padStart(2,'0')}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px;">Minute</label>
                                    <select id="modalMinute" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;">
                                        ${Array.from({length: 60}, (_, i) => `<option value="${i}">${i.toString().padStart(2,'0')}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            ${DATA.showModal.rangeMessage ? `<div style="font-size:13px;color:#6b7280;margin-bottom:15px;">${DATA.showModal.rangeMessage}</div>` : ''}
                        ` : ''}
                    </div>
                    <div class="custom-modal-footer">
                        <button onclick="DATA.showModal=null;render()" class="modal-btn modal-btn-cancel">Cancel</button>
                        <button id="modalConfirm" onclick="if(window.modalCallback){window.modalCallback();}" class="modal-btn modal-btn-confirm">${DATA.showModal.confirmText || 'OK'}</button>
                    </div>
                </div>`;
            }

            h += `<div class="header">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    ${DATA.editTitle ? 
                        `<input type="text" class="header-title-edit" value="${DATA.tripTitle}" onchange="DATA.tripTitle=this.value;saveToStorage();render()" onblur="DATA.editTitle=false;render()" autofocus>` :
                        `<h1 onclick="DATA.editTitle=true;render()" style="cursor:pointer;margin:0;">${DATA.tripTitle}</h1>`
                    }
                    
                    <div class="header-actions">
                        ${window.ALL_TRIPS && Object.keys(window.ALL_TRIPS).length > 1 ? `
                            <select onchange="switchTrip(this.value)" class="trip-selector">
                                ${Object.entries(window.ALL_TRIPS).map(([id, trip]) => 
                                    `<option value="${id}" ${id === window.CURRENT_TRIP_ID ? 'selected' : ''}>${trip.tripTitle}</option>`
                                ).join('')}
                            </select>
                        ` : ''}
                        
                        <div class="header-button-grid">
                            <button class="header-grid-btn" onclick="createNewTrip()" title="New Trip">
                                <span class="btn-icon"></span>
                                <span class="btn-label">New</span>
                            </button>
                            <button class="header-grid-btn" onclick="DATA.showTripManager=!DATA.showTripManager;render()" title="Manage Trips">
                                <span class="btn-icon"></span>
                                <span class="btn-label">Trips</span>
                            </button>
                            <button class="header-grid-btn" onclick="DATA.showExportMenu=!DATA.showExportMenu;render()" title="Export & Share">
                                <span class="btn-icon"></span>
                                <span class="btn-label">Export</span>
                            </button>
                            <button class="header-grid-btn" onclick="DATA.showSettings=!DATA.showSettings;DATA.settingsPage='main';render()" title="Settings">
                                <span class="btn-icon"></span>
                                <span class="btn-label">Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="subtitle">
                    <input type="date" value="${DATA.tripStartDate}" onchange="DATA.tripStartDate=this.value;updateTripDates();" style="padding:4px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;margin-right:5px;">
                    -
                    <input type="date" value="${DATA.tripEndDate}" onchange="DATA.tripEndDate=this.value;updateTripDates();" style="padding:4px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;margin-left:5px;">
                     ${s.done}/${DATA.days.length} days completed
                </div>
            </div>`;
            
            // Export & Share Full Page
            if (DATA.showExportMenu) {
                h += `<div class="settings-overlay" onclick="DATA.showExportMenu=false;render()"></div>
                <div class="export-page">
                    <div class="export-page-header">
                        <button class="back-button" onclick="DATA.showExportMenu=false;render()" style="background:rgba(255,255,255,0.2);color:white;margin:0;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:24px;color:white;"> Export & Share</h2>
                        <button class="btn" onclick="DATA.showExportMenu=false;render()" style="padding:8px 16px;background:rgba(255,255,255,0.2);color:white;">
                            
                        </button>
                    </div>
                    
                    <div class="export-page-content">
                        <p style="color:#666;margin-bottom:30px;font-size:15px;text-align:center;">
                            Choose how you'd like to export or share your trip itinerary
                        </p>
                        
                        <div class="export-grid">
                            <button class="export-option-card" onclick="exportToPDF();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">Print / PDF</div>
                                <div class="export-card-desc">Open print dialog for saving as PDF or printing</div>
                            </button>
                            
                            <button class="export-option-card" onclick="exportToHTML();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">HTML File</div>
                                <div class="export-card-desc">Download standalone webpage to share</div>
                            </button>
                            
                            <button class="export-option-card" onclick="exportToCSV();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">CSV Spreadsheet</div>
                                <div class="export-card-desc">Import into Excel or Google Sheets</div>
                            </button>
                            
                            <button class="export-option-card" onclick="exportToICalendar();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">Calendar (.ics)</div>
                                <div class="export-card-desc">Add to Google Calendar or Apple Calendar</div>
                            </button>
                            
                            <button class="export-option-card" onclick="emailItinerary();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">Email Itinerary</div>
                                <div class="export-card-desc">Send summary via your email app</div>
                            </button>
                            
                            <button class="export-option-card" onclick="copyShareableLink();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">Copy Share Data</div>
                                <div class="export-card-desc">Copy base64 data to share with others</div>
                            </button>
                        </div>
                        
                        <div class="info-box" style="margin-top:30px;">
                            <strong> Tips:</strong>
                            <ul style="margin:10px 0 0 20px;line-height:1.8;">
                                <li>Use <strong>Print/PDF</strong> for a clean, print-ready version</li>
                                <li>Use <strong>HTML File</strong> to create a shareable webpage</li>
                                <li>Use <strong>Calendar</strong> to sync your schedule with your device</li>
                                <li>Use <strong>CSV</strong> to analyze your budget in a spreadsheet</li>
                            </ul>
                        </div>
                    </div>
                </div>`;
            }
            
            // Settings Full Page
            if (DATA.showSettings) {
                h += `<div class="settings-overlay" onclick="DATA.showSettings=false;render()"></div>
                <div class="settings-page">
                    <div class="settings-header">
                        <h2 style="margin:0;font-size:28px;"> Settings</h2>
                        <button class="btn" onclick="DATA.showSettings=false;render()" style="padding:8px 16px;background:#ef4444;color:white;font-weight:600;">
                             Close
                        </button>
                    </div>
                    
                    ${DATA.settingsPage === 'main' ? `
                        <!-- Main Settings Menu -->
                        <div class="settings-menu-grid">
                            <button class="settings-menu-card" onclick="DATA.settingsPage='currency';render()">
                                <div class="settings-card-icon"></div>
                                <div class="settings-card-title">Currency</div>
                                <div class="settings-card-desc">Change currency and exchange rate</div>
                                <div class="settings-card-arrow"></div>
                            </button>
                            
                            <button class="settings-menu-card" onclick="DATA.settingsPage='converter';render()">
                                <div class="settings-card-icon"></div>
                                <div class="settings-card-title">Currency Converter</div>
                                <div class="settings-card-desc">Quick conversion calculator</div>
                                <div class="settings-card-arrow"></div>
                            </button>
                            
                            <button class="settings-menu-card" onclick="DATA.settingsPage='travelers';render()">
                                <div class="settings-card-icon"></div>
                                <div class="settings-card-title">Travelers</div>
                                <div class="settings-card-desc">Manage travelers and cost splitting</div>
                                <div class="settings-card-arrow"></div>
                            </button>
                            
                            <button class="settings-menu-card" onclick="DATA.settingsPage='categories';render()">
                                <div class="settings-card-icon"></div>
                                <div class="settings-card-title">Expense Categories</div>
                                <div class="settings-card-desc">Customize expense categories</div>
                                <div class="settings-card-arrow"></div>
                            </button>

                            <button class="settings-menu-card" onclick="DATA.settingsPage='appearance';render()">
                                <div class="settings-card-icon"></div>
                                <div class="settings-card-title">Appearance</div>
                                <div class="settings-card-desc">Customize look and feel</div>
                                <div class="settings-card-arrow"></div>
                            </button>
                        </div>
                    ` : ''}
                    
                    ${DATA.settingsPage === 'currency' ? `
                        <!-- Currency Settings Page -->
                        <button class="back-button" onclick="DATA.settingsPage='main';render()"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:24px;margin-bottom:20px;"> Currency Settings</h3>
                            
                            <div class="settings-form-group">
                                <label>Select Currency</label>
                                <select value="${DATA.currency}" onchange="changeCurrency(this.value)" class="settings-input">
                                    ${Object.keys(CURRENCIES).map(code => 
                                        `<option value="${code}" ${DATA.currency === code ? 'selected' : ''}>${CURRENCIES[code].symbol} ${CURRENCIES[code].name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div class="settings-form-group">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                    <label>Exchange Rate</label>
                                    <div class="rate-toggle">
                                        <label class="rate-toggle-label">Auto Update</label>
                                        <div class="toggle-switch ${DATA.liveRate ? 'on' : ''}" onclick="DATA.liveRate=!DATA.liveRate;if(DATA.liveRate){fetchLiveRate();}else{saveToStorage();render();}" style="width:50px;height:26px;cursor:pointer;">
                                            <div class="toggle-slider" style="width:20px;height:20px;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${DATA.liveRate ? 
                                    `<div class="info-box">
                                        <div style="font-size:20px;font-weight:700;margin-bottom:5px;">
                                            ${DATA.currencySymbol}${DATA.rate.toFixed(2)} per $1 USD
                                        </div>
                                        <div style="font-size:13px;color:#666;">
                                            Last updated: ${DATA.lastFetchedRate || 'Fetching...'}
                                        </div>
                                        <div style="margin-top:10px;font-size:12px;color:#3b82f6;">
                                             Rate updates automatically from live data
                                        </div>
                                    </div>` :
                                    `<input type="number" value="${DATA.rate}" onchange="DATA.rate=parseFloat(this.value)||155;saveToStorage();render()" class="settings-input" step="0.01" placeholder="Enter exchange rate">`
                                }
                            </div>
                            
                            <div class="info-box" style="background:#f0f9ff;border-color:#3b82f6;">
                                <strong> Tip:</strong> The exchange rate determines how USD values are converted to your selected currency throughout the app.
                            </div>
                        </div>
                    ` : ''}
                    
                    ${DATA.settingsPage === 'converter' ? `
                        <!-- Currency Converter Page -->
                        <button class="back-button" onclick="DATA.settingsPage='main';render()"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:24px;margin-bottom:20px;"> Currency Converter</h3>
                            
                            <div style="background:#f9fafb;padding:30px;border-radius:12px;border:2px solid #e5e7eb;">
                                <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:20px;align-items:center;">
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:10px;font-size:14px;color:#666;">US Dollar</label>
                                        <div style="position:relative;">
                                            <span style="position:absolute;left:15px;top:50%;transform:translateY(-50%);font-size:20px;font-weight:700;color:#6b7280;">$</span>
                                            <input type="number" id="settingsUsdInput" value="${DATA.converterUSD.toFixed(2)}" step="0.01" style="width:100%;padding:15px 15px 15px 35px;border:2px solid #e5e7eb;border-radius:8px;font-size:24px;font-weight:700;">
                                        </div>
                                    </div>
                                    
                                    <button onclick="const t=DATA.converterUSD;DATA.converterUSD=DATA.converterYEN/DATA.rate;DATA.converterYEN=t*DATA.rate;render();" style="background:#3b82f6;color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:24px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='rotate(180deg)'" onmouseout="this.style.transform='rotate(0deg)'">
                                        
                                    </button>
                                    
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:10px;font-size:14px;color:#666;">${CURRENCIES[DATA.currency].name}</label>
                                        <div style="position:relative;">
                                            <span style="position:absolute;left:15px;top:50%;transform:translateY(-50%);font-size:20px;font-weight:700;color:#6b7280;">${DATA.currencySymbol}</span>
                                            <input type="number" id="settingsYenInput" value="${DATA.converterYEN.toFixed(2)}" step="0.01" style="width:100%;padding:15px 15px 15px 35px;border:2px solid #e5e7eb;border-radius:8px;font-size:24px;font-weight:700;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:2px solid #e5e7eb;color:#666;font-size:14px;">
                                    Exchange Rate: <strong>${DATA.currencySymbol}${DATA.rate.toFixed(2)} per $1</strong>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${DATA.settingsPage === 'travelers' ? `
                        <!-- Travelers Page -->
                        <button class="back-button" onclick="DATA.settingsPage='main';render()"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:24px;margin-bottom:20px;"> Travelers</h3>
                            
                            <div class="settings-form-group">
                                <label>Number of Travelers</label>
                                <div class="traveler-count" style="justify-content:flex-start;">
                                    <button class="traveler-count-btn" onclick="event.stopPropagation();updateTravelerCount(-1)"></button>
                                    <div class="traveler-count-display">${DATA.travelerCount}</div>
                                    <button class="traveler-count-btn" onclick="event.stopPropagation();updateTravelerCount(1)">+</button>
                                    <span style="color:#666;font-size:16px;margin-left:15px;">${DATA.travelerCount} traveler${DATA.travelerCount > 1 ? 's' : ''}</span>
                                </div>
                            </div>
                            
                            ${DATA.travelerCount > 1 ? `
                                <div class="settings-form-group">
                                    <label>Traveler Names</label>
                                    <div class="traveler-list">
                                        ${DATA.travelers.map((name, idx) => `
                                            <div class="traveler-item" style="padding:15px;">
                                                <span style="font-size:24px;"></span>
                                                <input type="text" value="${name}" onchange="event.stopPropagation();updateTravelerName(${idx}, this.value)" placeholder="Traveler ${idx + 1}" style="flex:1;padding:12px;border:2px solid #e5e7eb;border-radius:6px;font-size:16px;">
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="settings-form-group">
                                    <label>Cost Display Mode</label>
                                    <div class="cost-split-toggle">
                                        <div class="cost-split-option" style="padding:15px;">
                                            <input type="radio" name="costSplit" id="costTotal" ${DATA.costSplitMode === 'total' ? 'checked' : ''} onchange="event.stopPropagation();setCostSplitMode('total')">
                                            <label for="costTotal" onclick="event.stopPropagation()" style="font-size:15px;">
                                                <strong>Total Only</strong>
                                                <div style="font-size:13px;color:#666;margin-top:4px;">Show only the total cost</div>
                                            </label>
                                        </div>
                                        <div class="cost-split-option" style="padding:15px;">
                                            <input type="radio" name="costSplit" id="costPerPerson" ${DATA.costSplitMode === 'perPerson' ? 'checked' : ''} onchange="event.stopPropagation();setCostSplitMode('perPerson')">
                                            <label for="costPerPerson" onclick="event.stopPropagation()" style="font-size:15px;">
                                                <strong>Total + Per Person</strong>
                                                <div style="font-size:13px;color:#666;margin-top:4px;">Show total and cost split per person</div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="info-box">
                                    <strong> Tip:</strong> Add more travelers to enable cost splitting and per-person breakdowns.
                                </div>
                            `}
                        </div>
                    ` : ''}
                    
                    ${DATA.settingsPage === 'categories' ? `
                        <!-- Categories Page -->
                        <button class="back-button" onclick="DATA.settingsPage='main';render()"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:24px;margin-bottom:20px;"> Expense Categories</h3>
                            
                            <div class="category-list" style="gap:15px;">
                                ${DATA.categories.map(cat => `
                                    <div class="category-item" style="padding:20px;border:2px solid #e5e7eb;">
                                        <div class="category-icon-picker" onclick="openIconPicker('${cat.id}')" style="font-size:32px;width:60px;height:60px;">${cat.icon}</div>
                                        <div style="flex:1;">
                                            <input type="text" value="${cat.name}" onchange="updateCategory('${cat.id}', 'name', this.value)" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:6px;font-size:16px;font-weight:600;margin-bottom:10px;">
                                            <div style="display:flex;gap:10px;align-items:center;">
                                                <span style="font-size:13px;color:#666;">Color:</span>
                                                <input type="color" class="category-color-picker" value="${cat.color}" onchange="updateCategory('${cat.id}', 'color', this.value)" style="width:60px;height:40px;">
                                                <span style="font-size:12px;color:#999;">ID: ${cat.id}</span>
                                            </div>
                                        </div>
                                        <button class="btn" onclick="deleteCategory('${cat.id}')" style="padding:10px 20px;background:#ef4444;color:white;font-weight:600;">
                                             Delete
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button class="add-category-btn" onclick="addCategory()" style="width:100%;padding:15px;font-size:16px;font-weight:600;">
                                + Add New Category
                            </button>
                            
                            <div class="info-box" style="margin-top:20px;">
                                <strong> Tip:</strong> Categories help organize your expenses. Each category can have its own icon, name, and color.
                            </div>
                        </div>
                    ` : ''}
               
                    ${DATA.settingsPage === 'appearance' ? `
                        <!-- Appearance Settings Page -->
                        <button class="back-button" onclick="DATA.settingsPage='main';render()"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:24px;margin-bottom:20px;"> Appearance Settings</h3>
                            
                            <!-- Toast Notifications -->
                            <div class="settings-form-group">
                                <label>Toast Notifications</label>
                                <div style="display:flex;align-items:center;justify-content:space-between;padding:15px;background:#f9fafb;border-radius:8px;">
                                    <div>
                                        <div style="font-weight:600;margin-bottom:4px;">Show Save Confirmations</div>
                                        <div style="font-size:13px;color:#666;">Display "Saved" toast when editing content</div>
                                    </div>
                                    <div class="toggle-switch ${!DATA.disableToasts ? 'on' : ''}" onclick="DATA.disableToasts=!DATA.disableToasts;saveToStorage();render()" style="width:50px;height:26px;cursor:pointer;">
                                        <div class="toggle-slider" style="width:20px;height:20px;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Haptic Feedback -->
                            <div class="settings-form-group">
                                <label>Haptic Feedback (Mobile)</label>
                                <div style="display:flex;align-items:center;justify-content:space-between;padding:15px;background:#f9fafb;border-radius:8px;">
                                    <div>
                                        <div style="font-weight:600;margin-bottom:4px;">Vibration on Actions</div>
                                        <div style="font-size:13px;color:#666;">Vibrate when saving or completing tasks</div>
                                    </div>
                                    <div class="toggle-switch ${!DATA.disableHaptics ? 'on' : ''}" onclick="DATA.disableHaptics=!DATA.disableHaptics;saveToStorage();render()" style="width:50px;height:26px;cursor:pointer;">
                                        <div class="toggle-slider" style="width:20px;height:20px;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Animation Speed -->
                            <div class="settings-form-group">
                                <label>Animation Speed</label>
                                <div style="padding:15px;background:#f9fafb;border-radius:8px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                        <span style="font-size:14px;color:#666;">Current: ${DATA.animationSpeed === 'fast' ? 'Fast' : DATA.animationSpeed === 'normal' ? 'Normal' : 'Slow'}</span>
                                    </div>
                                    <div style="display:flex;gap:8px;">
                                        <button class="btn ${DATA.animationSpeed === 'fast' ? '' : 'btn-secondary'}" onclick="DATA.animationSpeed='fast';saveToStorage();render();" style="flex:1;padding:8px;">Fast</button>
                                        <button class="btn ${!DATA.animationSpeed || DATA.animationSpeed === 'normal' ? '' : 'btn-secondary'}" onclick="DATA.animationSpeed='normal';saveToStorage();render();" style="flex:1;padding:8px;">Normal</button>
                                        <button class="btn ${DATA.animationSpeed === 'slow' ? '' : 'btn-secondary'}" onclick="DATA.animationSpeed='slow';saveToStorage();render();" style="flex:1;padding:8px;">Slow</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Style -->
                            <div class="settings-form-group">
                                <label>Card Style</label>
                                <div style="padding:15px;background:#f9fafb;border-radius:8px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                        <span style="font-size:14px;color:#666;">Current: ${DATA.cardStyle === 'modern' ? 'Modern (Elevated)' : 'Classic (Flat)'}</span>
                                    </div>
                                    <div style="display:flex;gap:8px;">
                                        <button class="btn ${!DATA.cardStyle || DATA.cardStyle === 'modern' ? '' : 'btn-secondary'}" onclick="DATA.cardStyle='modern';saveToStorage();render();" style="flex:1;padding:8px;">Modern</button>
                                        <button class="btn ${DATA.cardStyle === 'classic' ? '' : 'btn-secondary'}" onclick="DATA.cardStyle='classic';saveToStorage();render();" style="flex:1;padding:8px;">Classic</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Density -->
                            <div class="settings-form-group">
                                <label>Interface Density</label>
                                <div style="padding:15px;background:#f9fafb;border-radius:8px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                        <span style="font-size:14px;color:#666;">Current: ${DATA.density === 'compact' ? 'Compact' : DATA.density === 'comfortable' ? 'Comfortable' : 'Spacious'}</span>
                                    </div>
                                    <div style="display:flex;gap:8px;">
                                        <button class="btn ${DATA.density === 'compact' ? '' : 'btn-secondary'}" onclick="DATA.density='compact';saveToStorage();render();" style="flex:1;padding:8px;">Compact</button>
                                        <button class="btn ${!DATA.density || DATA.density === 'comfortable' ? '' : 'btn-secondary'}" onclick="DATA.density='comfortable';saveToStorage();render();" style="flex:1;padding:8px;">Comfortable</button>
                                        <button class="btn ${DATA.density === 'spacious' ? '' : 'btn-secondary'}" onclick="DATA.density='spacious';saveToStorage();render();" style="flex:1;padding:8px;">Spacious</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-box" style="margin-top:20px;">
                                <strong> Tip:</strong> These settings only affect the visual appearance and don't change any functionality. Customize to your preference!
                            </div>
                        </div>
                    ` : ''}
                 </div>`; 
            }
            
            // Analytics Full Page
            if (DATA.showAnalyticsPage) {
                h += `<div class="settings-overlay" onclick="DATA.showAnalyticsPage=null;render()"></div>
                <div class="analytics-page">
                    <div class="analytics-header">
                        <button class="back-button" onclick="DATA.showAnalyticsPage=null;render()" style="background:rgba(255,255,255,0.2);color:white;margin:0;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:24px;color:white;">
                            ${DATA.showAnalyticsPage === 'trends' ? ' Spending Trends' : ''}
                            ${DATA.showAnalyticsPage === 'breakdown' ? ' Expense Breakdown' : ''}
                            ${DATA.showAnalyticsPage === 'budget' ? ' Budget by Category' : ''}
                            ${DATA.showAnalyticsPage === 'receipts' ? ' Receipt Analytics' : ''}
                            ${DATA.showAnalyticsPage === 'comparison' ? ' Budget vs Actual' : ''}
                            ${DATA.showAnalyticsPage === 'timeline' ? ' Trip Timeline' : ''}
                            ${DATA.showAnalyticsPage === 'map' ? ' Trip Map' : ''}
                        </h2>
                        <button class="btn" onclick="DATA.showAnalyticsPage=null;render()" style="padding:8px 16px;background:rgba(255,255,255,0.2);color:white;">
                            
                        </button>
                    </div>
                    
                    <div class="analytics-content">
                        ${DATA.showAnalyticsPage === 'trends' ? `
                            <!-- Spending Trends Content -->
                            <div class="chart-toggle" style="margin-bottom:20px;">
                                <button class="${!DATA.trendsChartView || DATA.trendsChartView==='daily'?'active':''}" onclick="DATA.trendsChartView='daily';render()">Daily</button>
                                <button class="${DATA.trendsChartView==='cumulative'?'active':''}" onclick="DATA.trendsChartView='cumulative';render()">Cumulative</button>
                                <button class="${DATA.trendsChartView==='category'?'active':''}" onclick="DATA.trendsChartView='category';render()">By Category</button>
                            </div>
                            
                            ${(() => {
                                if (DATA.days.length === 0) {
                                    return '<div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No data yet</h3><p>Add trip days to see spending trends</p></div>';
                                }
                                
                                const view = DATA.trendsChartView || 'daily';
                                let chartData = [];
                                let maxValue = 0;
                                
                                if (view === 'daily') {
                                    chartData = DATA.days.map((day, idx) => {
                                        const total = day.done ? calcA(day) : 0;
                                        if (total > maxValue) maxValue = total;
                                        return { label: `D${day.d}`, value: total, day: day, type: 'actual' };
                                    });
                                } else if (view === 'cumulative') {
                                    let cumulativePlanned = 0;
                                    let cumulativeActual = 0;
                                    
                                    chartData = DATA.days.map((day, idx) => {
                                        cumulativePlanned += calc(day);
                                        cumulativeActual += day.done ? calcA(day) : 0;
                                        
                                        if (cumulativePlanned > maxValue) maxValue = cumulativePlanned;
                                        if (cumulativeActual > maxValue) maxValue = cumulativeActual;
                                        
                                        return { label: `D${day.d}`, planned: cumulativePlanned, actual: cumulativeActual, day: day };
                                    });
                                } else if (view === 'category') {
                                    const categoryTotals = {};
                                    DATA.categories.forEach(cat => {
                                        categoryTotals[cat.id] = DATA.days.reduce((sum, day) => {
                                            return sum + (day.done ? (day.a?.[cat.id] || 0) : 0);
                                        }, 0);
                                        if (categoryTotals[cat.id] > maxValue) maxValue = categoryTotals[cat.id];
                                    });
                                    
                                    chartData = DATA.categories.map(cat => ({
                                        label: cat.icon + ' ' + cat.name,
                                        value: categoryTotals[cat.id],
                                        color: cat.color
                                    }));
                                }
                                
                                let html = '<div class="trends-chart" style="padding:20px;">';
                                
                                if (view === 'cumulative') {
                                    html += '<svg width="100%" height="300" style="overflow:visible;">';
                                    
                                    const width = 100;
                                    const height = 250;
                                    const padding = 40;
                                    const stepX = (width - 10) / Math.max(chartData.length - 1, 1);
                                    
                                    for (let i = 0; i <= 5; i++) {
                                        const y = padding + (height - 2 * padding) * i / 5;
                                        const value = maxValue * (1 - i / 5);
                                        html += `<line x1="5%" y1="${y}" x2="95%" y2="${y}" stroke="#f0f0f0" stroke-width="1"/>`;
                                        html += `<text x="2%" y="${y + 4}" font-size="10" fill="#999">${DATA.currencySymbol}${Math.round(value/1000)}k</text>`;
                                    }
                                    
                                    let plannedPath = '';
                                    chartData.forEach((point, idx) => {
                                        const x = 5 + stepX * idx;
                                        const y = padding + (height - 2 * padding) * (1 - point.planned / maxValue);
                                        plannedPath += (idx === 0 ? 'M' : 'L') + x + ',' + y;
                                    });
                                    html += `<path d="${plannedPath}" stroke="#3b82f6" stroke-width="2" fill="none" stroke-dasharray="5,5"/>`;
                                    
                                    let actualPath = '';
                                    chartData.forEach((point, idx) => {
                                        const x = 5 + stepX * idx;
                                        const y = padding + (height - 2 * padding) * (1 - point.actual / maxValue);
                                        actualPath += (idx === 0 ? 'M' : 'L') + x + ',' + y;
                                    });
                                    html += `<path d="${actualPath}" stroke="#10b981" stroke-width="3" fill="none"/>`;
                                    
                                    chartData.forEach((point, idx) => {
                                        const x = 5 + stepX * idx;
                                        const yPlanned = padding + (height - 2 * padding) * (1 - point.planned / maxValue);
                                        const yActual = padding + (height - 2 * padding) * (1 - point.actual / maxValue);
                                        
                                        html += `<circle cx="${x}%" cy="${yPlanned}" r="3" fill="#3b82f6"/>`;
                                        if (point.actual > 0) {
                                            html += `<circle cx="${x}%" cy="${yActual}" r="4" fill="#10b981"/>`;
                                        }
                                        
                                        html += `<text x="${x}%" y="${height - 10}" font-size="10" text-anchor="middle" fill="#666">${point.label}</text>`;
                                    });
                                    
                                    html += '</svg>';
                                    html += `<div style="display:flex;justify-content:center;gap:30px;margin-top:15px;font-size:13px;">
                                        <div><span style="display:inline-block;width:20px;height:3px;background:#3b82f6;margin-right:8px;"></span>Planned</div>
                                        <div><span style="display:inline-block;width:20px;height:3px;background:#10b981;margin-right:8px;"></span>Actual</div>
                                    </div>`;
                                    
                                } else {
                                    chartData.forEach(item => {
                                        const width = maxValue > 0 ? (item.value / maxValue * 100) : 0;
                                        const color = item.color || (item.type === 'actual' ? '#10b981' : '#3b82f6');
                                        
                                        html += `<div style="margin-bottom:15px;">
                                            <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:13px;">
                                                <span style="font-weight:600;">${item.label}</span>
                                                <span style="color:#666;">${DATA.currencySymbol}${item.value.toLocaleString()}</span>
                                            </div>
                                            <div style="width:100%;height:30px;background:#f0f0f0;border-radius:6px;overflow:hidden;">
                                                <div style="width:${width}%;height:100%;background:${color};transition:width 0.3s;"></div>
                                            </div>
                                        </div>`;
                                    });
                                }
                                
                                html += '</div>';
                                return html;
                            })()}
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'breakdown' ? `
                            <!-- Expense Breakdown Content -->
                            <div class="chart-toggle" style="margin-bottom:20px;">
                                <button class="${DATA.chartView==='planned'?'active':''}" onclick="DATA.chartView='planned';render()">Planned</button>
                                <button class="${DATA.chartView==='actual'?'active':''}" onclick="DATA.chartView='actual';render()">Actual</button>
                            </div>
                            
                            ${(() => {
                                const cat = DATA.chartView === 'planned' ? s.catP : s.catA;
                                const items = DATA.chartView === 'planned' ? s.itemsP : s.itemsA;
                                let total = 0;
                                let maxVal = 0;

                                DATA.categories.forEach(c => {
                                    const val = cat[c.id] || 0;
                                    total += val;
                                    if (val > maxVal) maxVal = val;
                                });

                                let html = '<div style="padding:20px;">';
                                
                                DATA.categories.forEach(category => {
                                    const catVal = cat[category.id] || 0;
                                    const pct = total > 0 ? (catVal / total * 100) : 0;
                                    const width = maxVal > 0 ? (catVal / maxVal * 100) : 0;
                                    
                                    html += `<div class="chart-bar">
                                        <div class="chart-label">${category.icon} ${category.name}</div>
                                        <div class="chart-bar-bg">
                                            <div class="chart-bar-fill" style="width:${width}%;background:${category.color};color:white;">${pct.toFixed(1)}%</div>
                                        </div>
                                        <div class="chart-value">${DATA.currencySymbol}${catVal.toLocaleString()}</div>
                                    </div>`;
                                });
                                
                                // Category details
                                DATA.categories.forEach(category => {
                                    const catVal = cat[category.id] || 0;
                                    const catItems = items[category.id] || [];
                                    
                                    html += `<div class="chart-container" style="margin:20px 0;padding:15px;background:white;border-radius:8px;border:2px solid #e5e7eb;">
                                        <div class="chart-header" onclick="DATA['showChart${category.id}']=!DATA['showChart${category.id}'];render()" style="margin-bottom:0;cursor:pointer;">
                                            <div style="display:flex;align-items:center;gap:10px;">
                                                <span style="font-size:20px;">${category.icon}</span>
                                                <h3 style="margin:0;">${category.name}</h3>
                                            </div>
                                            <div style="display:flex;align-items:center;gap:15px;">
                                                <span style="font-weight:600;color:${category.color};">${DATA.currencySymbol}${catVal.toLocaleString()} (${total>0?((catVal/total)*100).toFixed(1):0}%)</span>
                                                <span class="chart-header-toggle ${DATA['showChart' + category.id]?'open':''}"></span>
                                            </div>
                                        </div>
                                        ${DATA['showChart' + category.id] ? `
                                            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #e0e0e0;">
                                                ${catItems.length > 0 ? catItems.map(item => `
                                                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0;">
                                                        <span style="color:#666;font-size:13px;">Day ${item.day}: ${item.name}</span>
                                                        <span style="font-weight:600;font-size:13px;">${DATA.currencySymbol}${item.value.toLocaleString()}</span>
                                                    </div>
                                                `).join('') : '<div style="color:#999;font-size:13px;padding:10px;">No expenses in this category yet</div>'}
                                            </div>
                                        ` : ''}
                                    </div>`;
                                });
                                
                                html += '</div>';
                                return html;
                            })()}
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'budget' ? `
                            <!-- Budget by Category Content -->
                            ${(() => {
                                let html = '<div style="padding:20px;">';
                                
                                DATA.categories.forEach(cat => {
                                    const spent = s.catA[cat.id] || 0;
                                    const budgeted = DATA.categoryBudgets[cat.id] || 0;
                                    const percentage = budgeted > 0 ? (spent / (budgeted * DATA.rate)) * 100 : 0;
                                    const status = percentage < 70 ? 'low' : percentage < 90 ? 'medium' : 'high';
                                    
                                    html += `
                                        <div class="category-budget-item" style="margin-bottom:20px;">
                                            <div class="category-budget-header">
                                                <div class="category-budget-label">
                                                    <span style="color:${cat.color};font-size:24px;">${cat.icon}</span> 
                                                    <span style="font-size:18px;font-weight:600;">${cat.name}</span>
                                                    ${DATA.editCategoryBudget === cat.id ? 
                                                        `<input type="number" class="category-budget-input" value="${budgeted}" onchange="DATA.categoryBudgets['${cat.id}']=parseFloat(this.value)||0;saveToStorage();render()" onblur="DATA.editCategoryBudget=null;render()" autofocus placeholder="$0" style="width:120px;margin-left:10px;">` :
                                                        `<button class="btn" onclick="DATA.editCategoryBudget='${cat.id}';render()" style="padding:6px 12px;font-size:13px;margin-left:10px;">${budgeted > 0 ? `$${budgeted}` : 'Set Budget'}</button>`
                                                    }
                                                </div>
                                                <div class="category-budget-amount" style="font-size:16px;">
                                                    ${DATA.currencySymbol}${spent.toLocaleString()} / ${budgeted > 0 ? `${DATA.currencySymbol}${(budgeted * DATA.rate).toLocaleString()}` : 'No limit'}
                                                    ${budgeted > 0 ? ` (${percentage.toFixed(0)}%)` : ''}
                                                </div>
                                            </div>
                                            ${budgeted > 0 ? `
                                                <div class="category-budget-bar">
                                                    <div class="category-budget-fill ${status}" style="width:${Math.min(percentage, 100)}%">
                                                        ${percentage >= 20 ? `${percentage.toFixed(0)}%` : ''}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                });
                                
                                html += '</div>';
                                return html;
                            })()}
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'receipts' ? `
                            <!-- Receipt Analytics Content -->
                            ${(() => {
                                const stats = calculateReceiptStats();
                                
                                let html = '<div style="padding:20px;">';
                                
                                html += `
                                    <div class="stats" style="margin-bottom:30px;">
                                        <div class="stat-card">
                                            <div class="stat-label">Total Receipts</div>
                                            <div class="stat-value">${stats.totalReceipts}</div>
                                        </div>
                                        <div class="stat-card blue">
                                            <div class="stat-label">Receipt Total</div>
                                            <div class="stat-value">${DATA.currencySymbol}${stats.totalAmount.toLocaleString()}</div>
                                            <div class="stat-sub">$${(stats.totalAmount/DATA.rate).toFixed(2)}</div>
                                        </div>
                                        <div class="stat-card green">
                                            <div class="stat-label">Avg per Receipt</div>
                                            <div class="stat-value">${stats.totalReceipts > 0 ? DATA.currencySymbol + (stats.totalAmount/stats.totalReceipts).toFixed(0) : 'N/A'}</div>
                                        </div>
                                    </div>
                                    
                                    ${Object.keys(stats.categoryTotals).length > 0 ? `
                                        <h4 style="font-size:18px;margin-bottom:15px;">Receipts by Category</h4>
                                        <div class="chart">
                                            ${DATA.categories.map(cat => {
                                                const catTotal = stats.categoryTotals[cat.id] || 0;
                                                const pct = stats.totalAmount > 0 ? (catTotal / stats.totalAmount * 100) : 0;
                                                const maxCatTotal = Math.max(...Object.values(stats.categoryTotals));
                                                const width = maxCatTotal > 0 ? (catTotal / maxCatTotal * 100) : 0;
                                                
                                                if (catTotal === 0) return '';
                                                
                                                return `
                                                    <div class="chart-bar">
                                                        <div class="chart-label">${cat.icon} ${cat.name}</div>
                                                        <div class="chart-bar-bg">
                                                            <div class="chart-bar-fill" style="width:${width}%;background:${cat.color};color:white;">${pct.toFixed(1)}%</div>
                                                        </div>
                                                        <div class="chart-value">${DATA.currencySymbol}${catTotal.toLocaleString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    ` : '<div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No receipts yet</h3><p>Start adding receipts to see analytics</p></div>'}
                                `;
                                
                                html += '</div>';
                                return html;
                            })()}
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'comparison' ? `
                            <!-- Budget vs Actual Comparison -->
                            ${(() => {
                                const totalBudget = DATA.budget * DATA.rate;
                                const totalPlanned = DATA.days.reduce((sum, day) => sum + calc(day), 0);
                                const totalActual = DATA.days.reduce((sum, day) => sum + calcA(day), 0);
                                const remaining = totalBudget - totalActual;
                                
                                return `
                                    <div style="padding:20px;">
                                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;">
                                            <div class="comparison-card" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;">
                                                <div class="comparison-label">Budget</div>
                                                <div class="comparison-value">${DATA.currencySymbol}${totalBudget.toLocaleString()}</div>
                                                <div class="comparison-sub">$${(totalBudget/DATA.rate).toFixed(2)}</div>
                                            </div>
                                            <div class="comparison-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;">
                                                <div class="comparison-label">Planned</div>
                                                <div class="comparison-value">${DATA.currencySymbol}${totalPlanned.toLocaleString()}</div>
                                                <div class="comparison-sub">${((totalPlanned/totalBudget)*100).toFixed(1)}% of budget</div>
                                            </div>
                                            <div class="comparison-card" style="background:linear-gradient(135deg,${totalActual > totalBudget ? '#ef4444,#dc2626' : '#10b981,#059669'});color:white;">
                                                <div class="comparison-label">Actual Spent</div>
                                                <div class="comparison-value">${DATA.currencySymbol}${totalActual.toLocaleString()}</div>
                                                <div class="comparison-sub">${((totalActual/totalBudget)*100).toFixed(1)}% of budget</div>
                                            </div>
                                            <div class="comparison-card" style="background:linear-gradient(135deg,${remaining < 0 ? '#ef4444,#dc2626' : '#10b981,#059669'});color:white;">
                                                <div class="comparison-label">Remaining</div>
                                                <div class="comparison-value">${remaining < 0 ? '-' : ''}${DATA.currencySymbol}${Math.abs(remaining).toLocaleString()}</div>
                                                <div class="comparison-sub">${remaining < 0 ? 'Over budget!' : 'Within budget'}</div>
                                            </div>
                                        </div>
                                        
                                        <div style="background:#f9fafb;padding:20px;border-radius:8px;">
                                            <h4 style="margin:0 0 15px 0;font-size:18px;">Category Breakdown</h4>
                                            ${DATA.categories.map(cat => {
                                                const catPlanned = DATA.days.reduce((sum, day) => sum + (day[cat.id]?.p || 0), 0);
                                                const catActual = DATA.days.reduce((sum, day) => sum + (day.a?.[cat.id] || 0), 0);
                                                const maxVal = Math.max(catPlanned, catActual, 1);
                                                
                                                return `
                                                    <div style="margin-bottom:20px;">
                                                        <div style="font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px;font-size:16px;">
                                                            <span style="font-size:20px;">${cat.icon}</span>
                                                            ${cat.name}
                                                        </div>
                                                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                                            <div>
                                                                <div style="font-size:11px;color:#666;margin-bottom:4px;">PLANNED</div>
                                                                <div style="height:28px;background:#e0e0e0;border-radius:6px;overflow:hidden;">
                                                                    <div style="width:${(catPlanned/maxVal*100)}%;height:100%;background:#3b82f6;display:flex;align-items:center;justify-content:end;padding:0 10px;color:white;font-size:13px;font-weight:600;">
                                                                        ${catPlanned > 0 ? DATA.currencySymbol + catPlanned.toLocaleString() : ''}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <div style="font-size:11px;color:#666;margin-bottom:4px;">ACTUAL</div>
                                                                <div style="height:28px;background:#e0e0e0;border-radius:6px;overflow:hidden;">
                                                                    <div style="width:${(catActual/maxVal*100)}%;height:100%;background:${catActual > catPlanned ? '#ef4444' : '#10b981'};display:flex;align-items:center;justify-content:end;padding:0 10px;color:white;font-size:13px;font-weight:600;">
                                                                        ${catActual > 0 ? DATA.currencySymbol + catActual.toLocaleString() : ''}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            })()}
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'timeline' ? `
                            <!-- Timeline Content -->
                            ${DATA.days.length > 0 ? `
                                <div class="timeline-container" style="padding:20px;">
                                    ${DATA.days.map((day, idx) => {
                                        const isCompleted = day.done;
                                        const spending = isCompleted ? calcA(day) : calc(day);
                                        const locationIcon = day.loc.includes('') ? '' : '';
                                        
                                        return `
                                            <div class="timeline-item ${isCompleted ? 'completed' : ''}">
                                                <div class="timeline-marker">
                                                    <div class="timeline-dot"></div>
                                                    ${idx < DATA.days.length - 1 ? '<div class="timeline-line"></div>' : ''}
                                                </div>
                                                <div class="timeline-content">
                                                    <div class="timeline-date">Day ${day.d}  ${day.dt || 'No date'}</div>
                                                    <div class="timeline-location">${locationIcon} ${day.loc}</div>
                                                    <div class="timeline-spending">
                                                        ${DATA.currencySymbol}${spending.toLocaleString()} 
                                                        <span style="font-size:11px;color:#999;">${isCompleted ? '(actual)' : '(planned)'}</span>
                                                    </div>
                                                    ${day.note ? `<div class="timeline-note">${day.note}</div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No timeline yet</h3><p>Add trip days to see your timeline</p></div>'}
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'map' ? `
                            <!-- Map Content -->
                            <div style="padding:20px;">
                                ${!DATA.showMap ? `
                                    <div class="empty-state">
                                        <div style="font-size:48px;margin-bottom:15px;"></div>
                                        <h3>Map not enabled</h3>
                                        <p>Enable the map feature in the Planning tab to see your route</p>
                                    </div>
                                ` : `
                                    <div style="text-align:center;color:#666;">
                                        <p>The map feature is already available in the Planning tab.</p>
                                        <button class="btn" onclick="DATA.showAnalyticsPage=null;DATA.activeTab='planning';render()" style="margin-top:15px;padding:12px 24px;">
                                            Go to Map
                                        </button>
                                    </div>
                                `}
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }
                   
            // Day Section Full Page
            if (DATA.days.some(d => d.showDaySection)) {
                const activeDayIndex = DATA.days.findIndex(d => d.showDaySection);
                const activeDay = DATA.days[activeDayIndex];
                const section = activeDay.showDaySection;
                
                h += `<div class="settings-overlay" onclick="DATA.days[${activeDayIndex}].showDaySection=null;render()"></div>
                <div class="day-section-page">
                    <div class="day-section-header">
                        <button class="back-button" onclick="DATA.days[${activeDayIndex}].showDaySection=null;render()" style="background:rgba(255,255,255,0.2);color:white;margin:0;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:20px;color:white;">
                            Day ${activeDay.d}: ${activeDay.loc}
                        </h2>
                        <button class="btn" onclick="DATA.days[${activeDayIndex}].showDaySection=null;render()" style="padding:8px 16px;background:rgba(255,255,255,0.2);color:white;">
                            
                        </button>
                    </div>
                    
                    <div class="day-section-content">
                        ${section === 'photos' ? `
                            <!-- Photos & Journal -->
                            <div style="padding:20px;">
                                <h3 style="font-size:20px;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                                     Photos & Journal
                                </h3>
                                
                                <div class="photo-upload" style="margin-bottom:20px;">
                                    <input type="file" accept="image/*" onchange="handlePhotoUpload(${activeDayIndex}, event)" id="photo-modal-${activeDayIndex}" style="display:none">
                                    <button class="btn" onclick="event.stopPropagation();document.getElementById('photo-modal-${activeDayIndex}').click()" style="padding:12px 24px;font-size:15px;">
                                         Add Photo
                                    </button>
                                </div>
                                
                                ${activeDay.photos && activeDay.photos.length > 0 ? `
                                    <div class="photo-gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-bottom:30px;">
                                        ${activeDay.photos.map((photo, pIdx) => `
                                            <div class="photo-item" onclick="event.stopPropagation();openPhotoModal('${photo}')" style="aspect-ratio:1;position:relative;border-radius:8px;overflow:hidden;cursor:pointer;">
                                                <img src="${photo}" style="width:100%;height:100%;object-fit:cover;">
                                                <button class="photo-delete" onclick="event.stopPropagation();deletePhoto(${activeDayIndex},${pIdx});render()" style="position:absolute;top:5px;right:5px;background:rgba(239,68,68,0.9);color:white;border:none;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px;"></button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div class="empty-state" style="margin:40px 0;"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No photos yet</h3><p>Add photos to remember this day</p></div>'}
                                
                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:10px;font-size:16px;">Journal Entry</label>
                                    <textarea placeholder="Write about your day..." style="width:100%;min-height:200px;padding:15px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;line-height:1.6;resize:vertical;" onchange="event.stopPropagation();updateJournal(${activeDayIndex},this.value)">${activeDay.journalNote || ''}</textarea>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${section === 'receipts' ? `
                            <!-- Receipts -->
                            <div style="padding:20px;">
                                <h3 style="font-size:20px;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                                     Receipts & Expenses
                                </h3>
                                
                                <div class="receipt-upload" style="margin-bottom:20px;">
                                    <input type="file" accept="image/*" onchange="handleReceiptUpload(${activeDayIndex}, event)" id="receipt-modal-${activeDayIndex}" style="display:none">
                                    <button class="btn" onclick="event.stopPropagation();document.getElementById('receipt-modal-${activeDayIndex}').click()" style="padding:12px 24px;font-size:15px;background:#10b981;color:white;">
                                         Add Receipt
                                    </button>
                                </div>
                                
                                ${activeDay.receipts && activeDay.receipts.length > 0 ? `
                                    <div class="receipt-list" style="display:flex;flex-direction:column;gap:15px;">
                                        ${activeDay.receipts.map((receipt, rIdx) => `
                                            <div class="receipt-item" style="padding:20px;background:white;border:2px solid #e5e7eb;border-radius:8px;">
                                                <div style="display:grid;grid-template-columns:100px 1fr;gap:20px;">
                                                    <div class="receipt-image" onclick="event.stopPropagation();openPhotoModal('${receipt.image}')" style="width:100px;height:100px;border-radius:8px;overflow:hidden;cursor:pointer;">
                                                        <img src="${receipt.image}" style="width:100%;height:100%;object-fit:cover;">
                                                    </div>
                                                    <div class="receipt-details">
                                                        <div style="display:grid;gap:10px;margin-bottom:10px;">
                                                            <input type="number" placeholder="Amount" value="${receipt.amount || ''}" onchange="event.stopPropagation();updateReceipt(${activeDayIndex},${rIdx},'amount',this.value)" style="padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:16px;font-weight:600;">
                                                            <select onchange="event.stopPropagation();updateReceipt(${activeDayIndex},${rIdx},'category',this.value)" style="padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;">
                                                                <option value="">Select category...</option>
                                                                ${DATA.categories.map(cat => 
                                                                    `<option value="${cat.id}" ${receipt.category === cat.id ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
                                                                ).join('')}
                                                            </select>
                                                        </div>
                                                        <input type="text" placeholder="Description (e.g., 'Tokyo Station Coffee')" value="${receipt.description || ''}" onchange="event.stopPropagation();updateReceipt(${activeDayIndex},${rIdx},'description',this.value)" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;margin-bottom:10px;font-size:14px;">
                                                        <div style="display:flex;gap:10px;justify-content:space-between;align-items:center;">
                                                            <input type="date" value="${receipt.date || activeDay.dt}" onchange="event.stopPropagation();updateReceipt(${activeDayIndex},${rIdx},'date',this.value)" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px;">
                                                            <button class="btn" onclick="event.stopPropagation();deleteReceipt(${activeDayIndex},${rIdx});render()" style="padding:8px 16px;background:#ef4444;color:white;">
                                                                 Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    
                                    <div style="margin-top:20px;padding:20px;background:#f0f9ff;border-radius:8px;border:2px solid #3b82f6;">
                                        <div style="display:flex;justify-content:space-between;align-items:center;">
                                            <span style="font-size:16px;font-weight:600;">Total:</span>
                                            <span style="font-size:20px;font-weight:700;color:#3b82f6;">
                                                ${DATA.currencySymbol}${activeDay.receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0).toLocaleString()}
                                            </span>
                                        </div>
                                    </div>
                                ` : '<div class="empty-state" style="margin:40px 0;"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No receipts yet</h3><p>Add receipts to track your expenses</p></div>'}
                            </div>
                        ` : ''}
                        
                        ${section === 'schedule' ? `
                            <!-- Schedule -->
                            <div style="padding:20px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                    <h3 style="font-size:20px;margin:0;display:flex;align-items:center;gap:10px;">
                                         Daily Schedule
                                    </h3>
                                    <div class="schedule-view-toggle" style="display:flex;gap:5px;">
                                        <button class="schedule-view-btn ${!activeDay.scheduleView || activeDay.scheduleView === 'list' ? 'active' : ''}" onclick="event.stopPropagation();DATA.days[${activeDayIndex}].scheduleView='list';render()"> List</button>
                                        <button class="schedule-view-btn ${activeDay.scheduleView === 'timeline' ? 'active' : ''}" onclick="event.stopPropagation();DATA.days[${activeDayIndex}].scheduleView='timeline';render()"> Timeline</button>
                                    </div>
                                </div>
                                
                                ${!activeDay.scheduleView || activeDay.scheduleView === 'list' ? `
                                    <div class="schedule-grid" style="display:flex;flex-direction:column;gap:10px;">
                                        ${(activeDay.schedule || []).sort((a, b) => a.time.localeCompare(b.time)).map((item, sIdx) => `
                                            <div class="schedule-hour" style="display:grid;grid-template-columns:120px 1fr auto;gap:15px;align-items:center;padding:15px;background:white;border:2px solid #e5e7eb;border-radius:8px;">
                                                <input type="time" value="${item.time}" onchange="event.stopPropagation();updateSchedule(${activeDayIndex},${sIdx},'time',this.value)" style="padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:15px;font-weight:600;">
                                                <input type="text" placeholder="Activity..." value="${item.activity}" onchange="event.stopPropagation();updateSchedule(${activeDayIndex},${sIdx},'activity',this.value)" style="padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:15px;">
                                                <button class="btn" onclick="event.stopPropagation();deleteSchedule(${activeDayIndex},${sIdx});render()" style="padding:8px 12px;background:#ef4444;color:white;"></button>
                                            </div>
                                        `).join('')}
                                        <button class="schedule-add-btn" onclick="event.stopPropagation();addScheduleItem(${activeDayIndex})" style="padding:15px;border:2px dashed #d1d5db;background:white;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;color:#6b7280;transition:all 0.2s;" onmouseover="this.style.borderColor='#3b82f6';this.style.color='#3b82f6'" onmouseout="this.style.borderColor='#d1d5db';this.style.color='#6b7280'">
                                            + Add Time Slot
                                        </button>
                                    </div>
                                ` : `
                                    <div class="schedule-timeline" style="background:white;padding:20px;border-radius:8px;border:2px solid #e5e7eb;max-height:none;">
                                        <div class="timeline-hours" style="display:flex;flex-direction:column;">
                                            ${(() => {
                                                const schedule = activeDay.schedule || [];
                                                const hours = [];
                                                let emptyStreak = [];
                                                
                                                for (let hour = 0; hour < 24; hour++) {
                                                    const events = schedule.filter(item => {
                                                        const itemHour = parseInt(item.time.split(':')[0]);
                                                        return itemHour === hour;
                                                    });
                                                    
                                                    if (events.length > 0) {
                                                        // If we had empty hours, render them as collapsed
                                                        if (emptyStreak.length > 0) {
                                                            const emptyStartHour = emptyStreak[0];
                                                            const emptyEndHour = emptyStreak[emptyStreak.length - 1];
                                                            
                                                            hours.push(`
                                                                <div class="timeline-empty-block" 
                                                                    style="display:grid;grid-template-columns:80px 1fr;gap:15px;border-bottom:1px solid #f0f0f0;min-height:35px;background:#fafafa;cursor:pointer;transition:background 0.2s;" 
                                                                    onmouseover="this.style.background='#f3f4f6'" 
                                                                    onmouseout="this.style.background='#fafafa'"
                                                                    onclick="event.stopPropagation();addEventInRange(${activeDayIndex}, ${emptyStartHour}, ${emptyEndHour});">
                                                                    <div style="padding:8px 0;font-size:12px;color:#9ca3af;font-weight:600;">
                                                                        ${emptyStartHour === 0 ? '12 AM' : emptyStartHour < 12 ? emptyStartHour + ' AM' : emptyStartHour === 12 ? '12 PM' : (emptyStartHour - 12) + ' PM'} - ${(emptyEndHour + 1) === 0 ? '12 AM' : (emptyEndHour + 1) < 12 ? (emptyEndHour + 1) + ' AM' : (emptyEndHour + 1) === 12 ? '12 PM' : ((emptyEndHour + 1) - 12) + ' PM'}
                                                                    </div>
                                                                    <div style="padding:8px 0;font-size:11px;color:#d1d5db;font-style:italic;display:flex;align-items:center;">
                                                                        No events (click to add)
                                                                    </div>
                                                                </div>
                                                            `);
                                                            emptyStreak = [];
                                                        }
                                                        
                                                        // Render hour with events
                                                        const hourLabel = hour === 0 ? '12 AM' : hour < 12 ? hour + ' AM' : hour === 12 ? '12 PM' : (hour - 12) + ' PM';
                                                        hours.push(`
                                                            <div class="timeline-hour-row has-events" style="display:grid;grid-template-columns:80px 1fr;gap:15px;border-bottom:1px solid #f0f0f0;min-height:60px;">
                                                                <div class="timeline-hour-label" style="padding:10px 0;font-size:13px;font-weight:600;color:#3b82f6;">${hourLabel}</div>
                                                                <div class="timeline-hour-cell" onclick="event.stopPropagation();const time='${hour.toString().padStart(2,'0')}:00';if(!DATA.days[${activeDayIndex}].schedule)DATA.days[${activeDayIndex}].schedule=[];DATA.days[${activeDayIndex}].schedule.push({time:time,activity:''});saveToStorage();render();" style="padding:10px 0;cursor:pointer;position:relative;">
                                                                    ${events.map((evt, evtIdx) => {
                                                                        const scheduleIdx = activeDay.schedule.findIndex(s => s.time === evt.time && s.activity === evt.activity);
                                                                        return `
                                                                            <div class="timeline-event" 
                                                                                style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;padding:10px;border-radius:6px;margin-bottom:5px;position:relative;cursor:move;" 
                                                                                onclick="event.stopPropagation();"
                                                                                onmousedown="event.preventDefault();">
                                                                                
                                                                                <div class="event-drag-handle event-drag-top" 
                                                                                    onmousedown="startEventResize(${activeDayIndex},${scheduleIdx},'top',event)"
                                                                                    style="position:absolute;top:0;left:0;right:0;height:8px;cursor:ns-resize;background:rgba(255,255,255,0.1);border-radius:6px 6px 0 0;">
                                                                                </div>
                                                                                
                                                                                <button class="timeline-event-delete" 
                                                                                        onclick="event.stopPropagation();deleteSchedule(${activeDayIndex},${scheduleIdx});render()" 
                                                                                        style="position:absolute;top:5px;right:5px;background:rgba(239,68,68,0.9);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px;z-index:10;">
                                                                                    
                                                                                </button>
                                                                                
                                                                                <div style="padding:8px 0;">
                                                                                    <div class="timeline-event-time" 
                                                                                        style="font-size:12px;opacity:0.9;margin-bottom:4px;user-select:none;">
                                                                                        ${evt.time}
                                                                                    </div>
                                                                                    <input type="text" 
                                                                                        class="timeline-event-title" 
                                                                                        placeholder="Add activity..." 
                                                                                        value="${evt.activity}" 
                                                                                        onchange="event.stopPropagation();updateSchedule(${activeDayIndex},${scheduleIdx},'activity',this.value)" 
                                                                                        onclick="event.stopPropagation();"
                                                                                        style="background:transparent;border:none;color:white;width:100%;font-size:14px;font-weight:600;">
                                                                                </div>
                                                                                
                                                                                <div class="event-drag-handle event-drag-bottom" 
                                                                                    onmousedown="startEventResize(${activeDayIndex},${scheduleIdx},'bottom',event)"
                                                                                    style="position:absolute;bottom:0;left:0;right:0;height:8px;cursor:ns-resize;background:rgba(255,255,255,0.1);border-radius:0 0 6px 6px;">
                                                                                </div>
                                                                            </div>
                                                                        `;
                                                                    }).join('')}
                                                                </div>
                                                            </div>
                                                        `);
                                                    } else {
                                                        // Add to empty streak
                                                        emptyStreak.push(hour);
                                                    }
                                                }
                                                
                                                // Handle any remaining empty hours at the end
                                                if (emptyStreak.length > 0) {
                                                    const emptyStartHour = emptyStreak[0];
                                                    const emptyEndHour = emptyStreak[emptyStreak.length - 1];
                                                    
                                                    hours.push(`
                                                        <div class="timeline-empty-block" 
                                                            style="display:grid;grid-template-columns:80px 1fr;gap:15px;border-bottom:1px solid #f0f0f0;min-height:35px;background:#fafaba;cursor:pointer;transition:background 0.2s;" 
                                                            onmouseover="this.style.background='#f3f4f6'" 
                                                            onmouseout="this.style.background='#fafafa'"
                                                            onclick="event.stopPropagation();addEventInRange(${activeDayIndex}, ${emptyStartHour}, ${emptyEndHour});">
                                                            <div style="padding:8px 0;font-size:12px;color:#9ca3af;font-weight:600;">
                                                                ${emptyStartHour === 0 ? '12 AM' : emptyStartHour < 12 ? emptyStartHour + ' AM' : emptyStartHour === 12 ? '12 PM' : (emptyStartHour - 12) + ' PM'} - ${(emptyEndHour + 1) % 24 === 0 ? '12 AM' : (emptyEndHour + 1) < 12 ? (emptyEndHour + 1) + ' AM' : (emptyEndHour + 1) === 12 ? '12 PM' : ((emptyEndHour + 1) - 12) + ' PM'}
                                                            </div>
                                                            <div style="padding:8px 0;font-size:11px;color:#d1d5db;font-style:italic;display:flex;align-items:center;">
                                                                No events (click to add)
                                                            </div>
                                                        </div>
                                                    `);
                                                }
                                                
                                                return hours.join('');
                                            })()}
                                        </div>
                                    </div>
                                `}
                            </div>
                        ` : ''}
                        
                        ${section === 'weather' ? `
                            <!-- Weather -->
                            <div style="padding:20px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                    <h3 style="font-size:20px;margin:0;display:flex;align-items:center;gap:10px;">
                                         Weather Forecast
                                    </h3>
                                    <button class="btn" onclick="event.stopPropagation();fetchWeather(${activeDayIndex})" ${activeDay.weatherLoading ? 'disabled' : ''} style="padding:10px 20px;">
                                        ${activeDay.weatherLoading ? ' Loading...' : activeDay.weather ? ' Refresh' : ' Fetch Weather'}
                                    </button>
                                </div>
                                
                                ${activeDay.weatherLoading ? `
                                    <div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>Loading weather...</h3></div>
                                ` : activeDay.weather ? (activeDay.weather.error ? `
                                    <div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>Could not load weather</h3><p>${activeDay.weather.error}</p></div>
                                ` : `
                                    <div style="margin-bottom:15px;color:#666;font-size:14px;">
                                         ${activeDay.weather.location} on ${activeDay.dt}
                                    </div>
                                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;">
                                        <div class="weather-card" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:30px;border-radius:12px;text-align:center;">
                                            <div class="weather-icon" style="font-size:48px;margin-bottom:15px;">${activeDay.weather.icon}</div>
                                            <div class="weather-temp" style="font-size:32px;font-weight:700;margin-bottom:5px;">${activeDay.weather.tempMin} - ${activeDay.weather.temp}F</div>
                                            <div style="font-size:14px;opacity:0.9;margin-bottom:10px;">${activeDay.weather.tempMinC} - ${activeDay.weather.tempC}C</div>
                                            <div class="weather-desc" style="font-size:16px;font-weight:600;">${activeDay.weather.condition}</div>
                                        </div>
                                        <div class="weather-card" style="background:linear-gradient(135deg,#06b6d4,#0891b2);color:white;padding:30px;border-radius:12px;text-align:center;">
                                            <div style="font-size:36px;margin-bottom:15px;"></div>
                                            <div class="weather-temp" style="font-size:32px;font-weight:700;margin-bottom:10px;">${activeDay.weather.precipitation}mm</div>
                                            <div class="weather-desc" style="font-size:16px;font-weight:600;">Precipitation</div>
                                        </div>
                                        <div class="weather-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:30px;border-radius:12px;text-align:center;">
                                            <div style="font-size:36px;margin-bottom:15px;"></div>
                                            <div class="weather-temp" style="font-size:32px;font-weight:700;margin-bottom:10px;">${activeDay.weather.windSpeed}</div>
                                            <div class="weather-desc" style="font-size:16px;font-weight:600;">mph wind</div>
                                        </div>
                                    </div>
                                `) : `
                                    <div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No weather data</h3><p>Click "Fetch Weather" to load forecast for ${activeDay.loc.split('')[0].trim()} on ${activeDay.dt}</p></div>
                                `}
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }
           
            // Trip Manager Modal
            if (DATA.showTripManager) {
                h += `<div class="trip-manager-overlay" onclick="DATA.showTripManager=false;render()"></div>
                <div class="trip-manager-modal">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e0e0e0;">
                        <h2 style="margin:0;font-size:24px;"> Trip Manager</h2>
                        <button class="btn" onclick="DATA.showTripManager=false;render()" style="padding:6px 12px;background:#ef4444;color:white;"> Close</button>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-bottom:20px;">
                        <button class="btn" onclick="createNewTrip()" style="flex:1;padding:12px;background:#10b981;color:white;">
                             Create New Trip
                        </button>
                        <button class="btn" onclick="importTripTemplate()" style="flex:1;padding:12px;background:#3b82f6;color:white;">
                             Import Template
                        </button>
                        <button class="btn" onclick="exportTripAsTemplate()" style="flex:1;padding:12px;background:#f59e0b;color:white;">
                             Export as Template
                        </button>
                    </div>
                    
                    <div class="trip-comparison-section" style="margin-bottom:30px;">
                        <h3 style="font-size:18px;margin-bottom:15px;"> Trip Comparison</h3>
                        <div class="trip-comparison-table">
                            <div class="trip-comparison-header">
                                <div>Trip Name</div>
                                <div>Days</div>
                                <div>Budget</div>
                                <div>Planned</div>
                                <div>Actual</div>
                                <div>Progress</div>
                            </div>
                                ${compareTripStats().map(trip => `
                                    <div class="trip-comparison-row ${trip.id === window.CURRENT_TRIP_ID ? 'current' : ''}">
                                        <div style="font-weight:600;">${trip.name}</div>
                                        <div>${trip.completed}/${trip.days}</div>
                                        <div>
                                            <strong>${formatCurrency(trip.budgetUSD, '$')}</strong><br>
                                            <small style="color:#666;font-size:11px;">
                                                ${formatCurrency(trip.budgetLocal, trip.currency)}
                                            </small>
                                        </div>
                                        <div>
                                            <strong>${formatCurrency(trip.totalPlannedUSD, '$')}</strong><br>
                                            <small style="color:#666;font-size:11px;">
                                                ${formatCurrency(trip.totalPlannedLocal, trip.currency)}
                                            </small>
                                        </div>
                                        <div>
                                            <strong>${formatCurrency(trip.totalActualUSD, '$')}</strong><br>
                                            <small style="color:#666;font-size:11px;">
                                                ${formatCurrency(trip.totalActualLocal, trip.currency)}
                                            </small>
                                        </div>
                                        <div>
                                            <div style="width:100px;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;">
                                                <div style="width:${trip.days > 0 ? (trip.completed/trip.days*100) : 0}%;height:100%;background:#10b981;"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <h3 style="font-size:18px;margin-bottom:15px;"> All Trips</h3>
                    <div class="trip-list">
                        ${Object.entries(window.ALL_TRIPS || {}).map(([id, trip]) => `
                            <div class="trip-card ${id === window.CURRENT_TRIP_ID ? 'current-trip' : ''}">
                                <div class="trip-card-header">
                                    <h4 style="margin:0;font-size:16px;">${trip.tripTitle}</h4>
                                    ${id === window.CURRENT_TRIP_ID ? '<span class="current-badge">Current</span>' : ''}
                                </div>
                                <div class="trip-card-info">
                                    <div><strong>${trip.days?.length || 0}</strong> days</div>
                                    <div><strong>${trip.currencySymbol}${((trip.budget || 0) * (trip.rate || 1)).toLocaleString()}</strong> budget</div>
                                    <div><strong>${trip.days?.filter(d => d.done).length || 0}</strong> completed</div>
                                </div>
                                <div class="trip-card-dates">
                                    ${trip.tripStartDate || 'No dates'}  ${trip.tripEndDate || 'No dates'}
                                </div>
                                <div class="trip-card-actions">
                                    ${id !== window.CURRENT_TRIP_ID ? `
                                        <button class="btn" onclick="event.stopPropagation();switchTrip('${id}')" style="padding:6px 12px;background:#3b82f6;color:white;">
                                            Switch
                                        </button>
                                    ` : ''}
                                    <button class="btn" onclick="event.stopPropagation();duplicateTrip('${id}')" style="padding:6px 12px;">
                                         Duplicate
                                    </button>
                                    <button class="btn" onclick="event.stopPropagation();deleteTrip('${id}')" style="padding:6px 12px;background:#ef4444;color:white;">
                                         Delete
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
           
            // Category Editing Modal (front-and-center)
            if (DATA.editingCategoryModal) {
                const { dayIndex, category } = DATA.editingCategoryModal;
                const day = DATA.days[dayIndex];
                const cat = DATA.categories.find(c => c.id === category);
                const catData = day[category] || { n: '', d: '', p: 0 };
                const actualValue = day.a?.[category] || 0;
                
                h += `<div class="custom-modal-overlay" onclick="closeCategoryModal()"></div>
                <div class="custom-modal" style="max-width: 600px;">
                    <div class="custom-modal-header">
                        <h3 style="margin:0;">${cat.icon} ${cat.name} - Day ${day.d}</h3>
                        <button onclick="closeCategoryModal()" style="background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;"></button>
                    </div>
                    <div class="custom-modal-body">
                        <div style="display:grid;gap:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Name/Description</label>
                                <input type="text" value="${catData.n || ''}" onchange="update(${dayIndex}, '${category}', 'n', this.value)" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;" placeholder="e.g., ARK Hotel Okayama (3n)">
                            </div>
                            
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Details</label>
                                <input type="text" value="${catData.d || ''}" onchange="update(${dayIndex}, '${category}', 'd', this.value)" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;" placeholder="e.g., Bullet train ~8:30">
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Planned Cost (${DATA.currencySymbol})</label>
                                    <input type="number" value="${catData.p || 0}" onchange="update(${dayIndex}, '${category}', 'p', this.value)" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;font-weight:600;">
                                </div>
                                
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Actual Cost (${DATA.currencySymbol})</label>
                                    <input type="number" value="${actualValue}" onchange="update(${dayIndex}, 'base', 'a.${category}', this.value)" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;font-weight:600;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="custom-modal-footer">
                        <button onclick="closeCategoryModal()" class="modal-btn modal-btn-cancel">Close</button>
                    </div>
                </div>`;
            }

            // Notes Editing Modal (front-and-center)
            if (DATA.editingNotesModal) {
                const { dayIndex } = DATA.editingNotesModal;
                const day = DATA.days[dayIndex];
                
                h += `<div class="custom-modal-overlay" onclick="closeNotesModal()"></div>
                <div class="custom-modal" style="max-width: 600px;">
                    <div class="custom-modal-header">
                        <h3 style="margin:0;"> Notes - Day ${day.d}: ${day.loc}</h3>
                        <button onclick="closeNotesModal()" style="background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;"></button>
                    </div>
                    <div class="custom-modal-body">
                        <textarea placeholder="Add notes for this day..." style="width:100%;min-height:200px;padding:15px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;line-height:1.6;resize:vertical;" onchange="update(${dayIndex}, 'base', 'note', this.value)">${day.note || ''}</textarea>
                    </div>
                    <div class="custom-modal-footer">
                        <button onclick="closeNotesModal()" class="modal-btn modal-btn-cancel">Close</button>
                    </div>
                </div>`;
            }
          
            // Checklist Pages (Full Page Modals)
            if (DATA.showChecklistPage === 'packing') {
                h += `<div class="settings-overlay" onclick="DATA.showChecklistPage=null;render()"></div>
                <div class="day-section-page">
                    <div class="day-section-header" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <button class="back-button" onclick="DATA.showChecklistPage=null;render()" style="background:rgba(255,255,255,0.2);color:white;margin:0;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:20px;color:white;display:flex;align-items:center;gap:10px;">
                             Packing List
                        </h2>
                        <button class="btn" onclick="DATA.showChecklistPage=null;render()" style="padding:8px 16px;background:rgba(255,255,255,0.2);color:white;">
                            
                        </button>
                    </div>
                    
                    <div class="day-section-content" style="padding:30px;">
                        ${DATA.packingList && DATA.packingList.length > 0 ? `
                            <div style="margin-bottom:30px;padding:20px;background:#fffbeb;border-radius:8px;border:2px solid #fbbf24;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div class="packing-progress-text" style="font-size:32px;font-weight:700;color:#d97706;">
                                            ${DATA.packingList.filter(i => i.packed).length}/${DATA.packingList.length}
                                        </div>
                                        <div style="font-size:14px;color:#92400e;margin-top:4px;">Items Packed</div>
                                    </div>
                                    <div style="width:120px;height:120px;">
                                        <svg viewBox="0 0 100 100">
                                            <circle cx="50" cy="50" r="45" fill="none" stroke="#fef3c7" stroke-width="10"/>
                                            <circle class="packing-progress-circle" cx="50" cy="50" r="45" fill="none" stroke="#f59e0b" stroke-width="10"
                                                stroke-dasharray="${(DATA.packingList.filter(i => i.packed).length / DATA.packingList.length) * 283} 283"
                                                stroke-linecap="round" transform="rotate(-90 50 50)" style="transition: stroke-dasharray 0.3s ease;"/>
                                            <text class="packing-progress-pct" x="50" y="55" text-anchor="middle" font-size="20" font-weight="bold" fill="#d97706">
                                                ${Math.round((DATA.packingList.filter(i => i.packed).length / DATA.packingList.length) * 100)}%
                                            </text>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="checklist-items" style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
                            ${(() => {
                                // Sort: unchecked first, then checked
                                const unchecked = DATA.packingList.filter(item => !item.packed);
                                const checked = DATA.packingList.filter(item => item.packed);
                                const sorted = [...unchecked, ...checked];
                                
                                return sorted.map((item) => {
                                    const originalIdx = DATA.packingList.indexOf(item);
                                    return `
                                    <div class="checklist-item" id="packing-item-${originalIdx}" draggable="true" 
                                        ondragstart="handleChecklistDragStart(event, 'packing', ${originalIdx})"
                                        ondragover="handleChecklistDragOver(event)"
                                        ondrop="handleChecklistDrop(event, 'packing', ${originalIdx})"
                                        ondragend="handleChecklistDragEnd(event)"
                                        style="display:flex;gap:12px;align-items:center;padding:15px;background:${item.packed ? '#f9fafb' : 'white'};border:2px solid #e5e7eb;border-radius:8px;transition:all 0.2s;">
                                        <span class="drag-handle" style="cursor:grab;padding:0 8px;opacity:0.5;font-size:18px;"></span>
                                        <input type="checkbox" ${item.packed ? 'checked' : ''} 
                                            onchange="event.stopPropagation();
                                                     DATA.packingList[${originalIdx}].packed = this.checked; 
                                                     saveToStorage(); 
                                                     
                                                     // Update progress
                                                     const newCount = DATA.packingList.filter(i => i.packed).length;
                                                     const total = DATA.packingList.length;
                                                     const progressDiv = document.querySelector('.packing-progress-text');
                                                     if(progressDiv) progressDiv.textContent = newCount + '/' + total;
                                                     const progressCircle = document.querySelector('.packing-progress-circle');
                                                     if(progressCircle) progressCircle.setAttribute('stroke-dasharray', ((newCount / total) * 283) + ' 283');
                                                     const progressPct = document.querySelector('.packing-progress-pct');
                                                     if(progressPct) progressPct.textContent = Math.round((newCount / total) * 100) + '%';
                                                     
                                                     // Update card progress
                                                     const cardProgress = document.querySelector('.packing-card-progress');
                                                     if(cardProgress) cardProgress.textContent = newCount + '/' + total + ' packed';
                                                     
                                                     // Visual update only - move item smoothly
                                                     const itemEl = document.getElementById('packing-item-${originalIdx}');
                                                     if(itemEl) {
                                                         itemEl.style.background = this.checked ? '#f9fafb' : 'white';
                                                         const textInput = itemEl.querySelector('input[type=text]');
                                                         if(textInput) {
                                                             textInput.style.textDecoration = this.checked ? 'line-through' : 'none';
                                                             textInput.style.opacity = this.checked ? '0.6' : '1';
                                                         }
                                                         
                                                         // Smooth reorder after a delay
                                                         setTimeout(() => {
                                                             const container = itemEl.parentElement;
                                                             if(this.checked) {
                                                                 container.appendChild(itemEl);
                                                             } else {
                                                                 const firstChecked = Array.from(container.children).find(child => {
                                                                     const checkbox = child.querySelector('input[type=checkbox]');
                                                                     return checkbox && checkbox.checked;
                                                                 });
                                                                 if(firstChecked) {
                                                                     container.insertBefore(itemEl, firstChecked);
                                                                 }
                                                             }
                                                         }, 300);
                                                     }" 
                                            style="width:24px;height:24px;cursor:pointer;">
                                        <input type="text" 
                                            value="${item.item}" 
                                            onchange="event.stopPropagation();DATA.packingList[${originalIdx}].item = this.value; saveToStorage();" 
                                            onblur="saveToStorage();"
                                            placeholder="Enter item name..."
                                            style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:6px;font-size:15px;
                                                   ${item.packed ? 'text-decoration:line-through;opacity:0.6;' : ''}
                                                   ${!item.item ? 'color:#999;font-style:italic;' : ''}"
                                            ${!item.item ? 'class="empty-item-input"' : ''}>
                                        <button class="btn" style="padding:8px 16px;background:#fee2e2;color:#dc2626;border:none;" 
                                            onclick="event.stopPropagation(); DATA.packingList.splice(${originalIdx}, 1); saveToStorage(); render()">
                                            
                                        </button>
                                    </div>
                                `}).join('');
                            })()}
                        </div>
                        
                        <button class="btn" onclick="event.stopPropagation(); 
                            DATA.packingList.push({item: '', packed: false}); 
                            saveToStorage(); 
                            render();
                            setTimeout(() => {
                                const newInput = document.querySelector('.empty-item-input:last-of-type');
                                if (newInput) { newInput.focus(); newInput.select(); }
                            }, 10);"
                            style="width:100%;padding:15px;background:#f59e0b;color:white;font-size:16px;font-weight:600;">
                             Add Item
                        </button>
                        
                        ${DATA.packingList.length === 0 ? `
                            <div style="text-align:center;padding:60px 20px;color:#999;">
                                <div style="font-size:64px;margin-bottom:20px;"></div>
                                <h3 style="color:#666;margin-bottom:10px;">No items yet</h3>
                                <p style="font-size:14px;">Click "Add Item" to start building your packing list</p>
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }
            
            if (DATA.showChecklistPage === 'before') {
                h += `<div class="settings-overlay" onclick="DATA.showChecklistPage=null;render()"></div>
                <div class="day-section-page">
                    <div class="day-section-header" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <button class="back-button" onclick="DATA.showChecklistPage=null;render()" style="background:rgba(255,255,255,0.2);color:white;margin:0;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:20px;color:white;display:flex;align-items:center;gap:10px;">
                             Before Trip Checklist
                        </h2>
                        <button class="btn" onclick="DATA.showChecklistPage=null;render()" style="padding:8px 16px;background:rgba(255,255,255,0.2);color:white;">
                            
                        </button>
                    </div>
                    
                    <div class="day-section-content" style="padding:30px;">
                        ${DATA.beforeChecklist && DATA.beforeChecklist.length > 0 ? `
                            <div style="margin-bottom:30px;padding:20px;background:#ecfdf5;border-radius:8px;border:2px solid #10b981;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div class="before-progress-text" style="font-size:32px;font-weight:700;color:#059669;">
                                            ${DATA.beforeChecklist.filter(i => i.checked).length}/${DATA.beforeChecklist.length}
                                        </div>
                                        <div style="font-size:14px;color:#065f46;margin-top:4px;">Tasks Completed</div>
                                    </div>
                                    <div style="width:120px;height:120px;">
                                        <svg viewBox="0 0 100 100">
                                            <circle cx="50" cy="50" r="45" fill="none" stroke="#d1fae5" stroke-width="10"/>
                                            <circle class="before-progress-circle" cx="50" cy="50" r="45" fill="none" stroke="#10b981" stroke-width="10"
                                                stroke-dasharray="${(DATA.beforeChecklist.filter(i => i.checked).length / DATA.beforeChecklist.length) * 283} 283"
                                                stroke-linecap="round" transform="rotate(-90 50 50)" style="transition: stroke-dasharray 0.3s ease;"/>
                                            <text class="before-progress-pct" x="50" y="55" text-anchor="middle" font-size="20" font-weight="bold" fill="#059669">
                                                ${Math.round((DATA.beforeChecklist.filter(i => i.checked).length / DATA.beforeChecklist.length) * 100)}%
                                            </text>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="checklist-items" style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
                            ${(() => {
                                // Sort: unchecked first, then checked
                                const unchecked = DATA.beforeChecklist.filter(item => !item.checked);
                                const checked = DATA.beforeChecklist.filter(item => item.checked);
                                const sorted = [...unchecked, ...checked];
                                
                                return sorted.map((checklistItem) => {
                                    const originalIdx = DATA.beforeChecklist.indexOf(checklistItem);
                                    const itemText = checklistItem.item || (typeof checklistItem === 'string' ? checklistItem : '');
                                    const isChecked = checklistItem.checked || false;
                                    return `
                                    <div class="checklist-item" id="before-item-${originalIdx}" draggable="true" 
                                        ondragstart="handleChecklistDragStart(event, 'before', ${originalIdx})"
                                        ondragover="handleChecklistDragOver(event)"
                                        ondrop="handleChecklistDrop(event, 'before', ${originalIdx})"
                                        ondragend="handleChecklistDragEnd(event)"
                                        style="display:flex;gap:12px;align-items:center;padding:15px;background:${isChecked ? '#f9fafb' : 'white'};border:2px solid #e5e7eb;border-radius:8px;transition:all 0.2s;">
                                        <span class="drag-handle" style="cursor:grab;padding:0 8px;opacity:0.5;font-size:18px;"></span>
                                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                                            onchange="event.stopPropagation();
                                                     DATA.beforeChecklist[${originalIdx}].checked = this.checked; 
                                                     saveToStorage(); 
                                                     
                                                     // Update progress
                                                     const newCount = DATA.beforeChecklist.filter(i => i.checked).length;
                                                     const total = DATA.beforeChecklist.length;
                                                     const progressDiv = document.querySelector('.before-progress-text');
                                                     if(progressDiv) progressDiv.textContent = newCount + '/' + total;
                                                     const progressCircle = document.querySelector('.before-progress-circle');
                                                     if(progressCircle) progressCircle.setAttribute('stroke-dasharray', ((newCount / total) * 283) + ' 283');
                                                     const progressPct = document.querySelector('.before-progress-pct');
                                                     if(progressPct) progressPct.textContent = Math.round((newCount / total) * 100) + '%';
                                                     
                                                     // Update card progress
                                                     const cardProgress = document.querySelector('.before-card-progress');
                                                     if(cardProgress) cardProgress.textContent = newCount + '/' + total + ' done';
                                                     
                                                     // Visual update only - move item smoothly
                                                     const itemEl = document.getElementById('before-item-${originalIdx}');
                                                     if(itemEl) {
                                                         itemEl.style.background = this.checked ? '#f9fafb' : 'white';
                                                         const textInput = itemEl.querySelector('input[type=text]');
                                                         if(textInput) {
                                                             textInput.style.textDecoration = this.checked ? 'line-through' : 'none';
                                                             textInput.style.opacity = this.checked ? '0.6' : '1';
                                                         }
                                                         
                                                         // Smooth reorder after a delay
                                                         setTimeout(() => {
                                                             const container = itemEl.parentElement;
                                                             if(this.checked) {
                                                                 container.appendChild(itemEl);
                                                             } else {
                                                                 const firstChecked = Array.from(container.children).find(child => {
                                                                     const checkbox = child.querySelector('input[type=checkbox]');
                                                                     return checkbox && checkbox.checked;
                                                                 });
                                                                 if(firstChecked) {
                                                                     container.insertBefore(itemEl, firstChecked);
                                                                 }
                                                             }
                                                         }, 300);
                                                     }" 
                                            style="width:24px;height:24px;cursor:pointer;">
                                        <input type="text" 
                                            value="${itemText}" 
                                            onchange="event.stopPropagation();DATA.beforeChecklist[${originalIdx}].item = this.value; saveToStorage();"
                                            onblur="saveToStorage();" 
                                            placeholder="Enter checklist item..."
                                            style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:6px;font-size:15px;
                                                   ${isChecked ? 'text-decoration:line-through;opacity:0.6;' : ''}
                                                   ${!itemText ? 'color:#999;font-style:italic;' : ''}"
                                            ${!itemText ? 'class="empty-before-input"' : ''}>
                                        <button class="btn" style="padding:8px 16px;background:#fee2e2;color:#dc2626;border:none;" 
                                            onclick="event.stopPropagation(); DATA.beforeChecklist.splice(${originalIdx}, 1); saveToStorage(); render()">
                                            
                                        </button>
                                    </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                        
                        <button class="btn" onclick="event.stopPropagation(); 
                            DATA.beforeChecklist.push({item: '', checked: false}); 
                            saveToStorage(); 
                            render();
                            setTimeout(() => {
                                const newInputs = document.querySelectorAll('.empty-before-input');
                                const lastInput = newInputs[newInputs.length - 1];
                                if (lastInput) { lastInput.focus(); lastInput.select(); }
                            }, 10);"
                            style="width:100%;padding:15px;background:#10b981;color:white;font-size:16px;font-weight:600;">
                             Add Item
                        </button>
                        
                        ${DATA.beforeChecklist.length === 0 ? `
                            <div style="text-align:center;padding:60px 20px;color:#999;">
                                <div style="font-size:64px;margin-bottom:20px;"></div>
                                <h3 style="color:#666;margin-bottom:10px;">No tasks yet</h3>
                                <p style="font-size:14px;">Click "Add Item" to start your pre-trip checklist</p>
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }

            if (DATA.showChecklistPage === 'trip') {
                h += `<div class="settings-overlay" onclick="DATA.showChecklistPage=null;render()"></div>
                <div class="day-section-page">
                    <div class="day-section-header" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                        <button class="back-button" onclick="DATA.showChecklistPage=null;render()" style="background:rgba(255,255,255,0.2);color:white;margin:0;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:20px;color:white;display:flex;align-items:center;gap:10px;">
                             On Trip Checklist
                        </h2>
                        <button class="btn" onclick="DATA.showChecklistPage=null;render()" style="padding:8px 16px;background:rgba(255,255,255,0.2);color:white;">
                            
                        </button>
                    </div>
                    
                    <div class="day-section-content" style="padding:30px;">
                        ${DATA.tripChecklist && DATA.tripChecklist.length > 0 ? `
                            <div style="margin-bottom:30px;padding:20px;background:#eff6ff;border-radius:8px;border:2px solid #3b82f6;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div class="trip-progress-text" style="font-size:32px;font-weight:700;color:#2563eb;">
                                            ${DATA.tripChecklist.filter(i => i.checked).length}/${DATA.tripChecklist.length}
                                        </div>
                                        <div style="font-size:14px;color:#1e40af;margin-top:4px;">Items Completed</div>
                                    </div>
                                    <div style="width:120px;height:120px;">
                                        <svg viewBox="0 0 100 100">
                                            <circle cx="50" cy="50" r="45" fill="none" stroke="#dbeafe" stroke-width="10"/>
                                            <circle class="trip-progress-circle" cx="50" cy="50" r="45" fill="none" stroke="#3b82f6" stroke-width="10"
                                                stroke-dasharray="${(DATA.tripChecklist.filter(i => i.checked).length / DATA.tripChecklist.length) * 283} 283"
                                                stroke-linecap="round" transform="rotate(-90 50 50)" style="transition: stroke-dasharray 0.3s ease;"/>
                                            <text class="trip-progress-pct" x="50" y="55" text-anchor="middle" font-size="20" font-weight="bold" fill="#2563eb">
                                                ${Math.round((DATA.tripChecklist.filter(i => i.checked).length / DATA.tripChecklist.length) * 100)}%
                                            </text>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="checklist-items trip-items-container" style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
                            ${(() => {
                                const unchecked = DATA.tripChecklist.filter(item => !item.checked);
                                const checked = DATA.tripChecklist.filter(item => item.checked);
                                const sorted = [...unchecked, ...checked];
                                
                                return sorted.map((item) => {
                                    const originalIdx = DATA.tripChecklist.indexOf(item);
                                    return `
                                    <div class="checklist-item" id="trip-item-${originalIdx}" draggable="true" 
                                        ondragstart="handleChecklistDragStart(event, 'trip', ${originalIdx})"
                                        ondragover="handleChecklistDragOver(event)"
                                        ondrop="handleChecklistDrop(event, 'trip', ${originalIdx})"
                                        ondragend="handleChecklistDragEnd(event)"
                                        style="display:flex;gap:12px;align-items:center;padding:15px;background:${item.checked ? '#f9fafb' : 'white'};border:2px solid #e5e7eb;border-radius:8px;transition:all 0.2s;">
                                        <span class="drag-handle" style="cursor:grab;padding:0 8px;opacity:0.5;font-size:18px;"></span>
                                        <input type="checkbox" ${item.checked ? 'checked' : ''} 
                                            onchange="event.stopPropagation();
                                                    DATA.tripChecklist[${originalIdx}].checked = this.checked; 
                                                    saveToStorage(); 
                                                    
                                                    const newCount = DATA.tripChecklist.filter(i => i.checked).length;
                                                    const total = DATA.tripChecklist.length;
                                                    const progressDiv = document.querySelector('.trip-progress-text');
                                                    if(progressDiv) progressDiv.textContent = newCount + '/' + total;
                                                    const progressCircle = document.querySelector('.trip-progress-circle');
                                                    if(progressCircle) progressCircle.setAttribute('stroke-dasharray', ((newCount / total) * 283) + ' 283');
                                                    const progressPct = document.querySelector('.trip-progress-pct');
                                                    if(progressPct) progressPct.textContent = Math.round((newCount / total) * 100) + '%';
                                                    
                                                    const cardProgress = document.querySelector('.trip-card-progress');
                                                    if(cardProgress) cardProgress.textContent = newCount + '/' + total + ' done';
                                                    
                                                    const itemEl = document.getElementById('trip-item-${originalIdx}');
                                                    if(itemEl) {
                                                        itemEl.style.background = this.checked ? '#f9fafb' : 'white';
                                                        const textInput = itemEl.querySelector('input[type=text]');
                                                        if(textInput) {
                                                            textInput.style.textDecoration = this.checked ? 'line-through' : 'none';
                                                            textInput.style.opacity = this.checked ? '0.6' : '1';
                                                        }
                                                        
                                                        setTimeout(() => {
                                                            const container = itemEl.parentElement;
                                                            if(this.checked) {
                                                                container.appendChild(itemEl);
                                                            } else {
                                                                const firstChecked = Array.from(container.children).find(child => {
                                                                    const checkbox = child.querySelector('input[type=checkbox]');
                                                                    return checkbox && checkbox.checked;
                                                                });
                                                                if(firstChecked) {
                                                                    container.insertBefore(itemEl, firstChecked);
                                                                }
                                                            }
                                                        }, 300);
                                                    }" 
                                            style="width:24px;height:24px;cursor:pointer;">
                                        <input type="text" 
                                            value="${item.item}" 
                                            onchange="event.stopPropagation();DATA.tripChecklist[${originalIdx}].item = this.value; saveToStorage();" 
                                            onblur="saveToStorage();"
                                            placeholder="Enter item name..."
                                            style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:6px;font-size:15px;
                                                ${item.checked ? 'text-decoration:line-through;opacity:0.6;' : ''}
                                                ${!item.item ? 'color:#999;font-style:italic;' : ''}"
                                            ${!item.item ? 'class="empty-item-input"' : ''}>
                                        <button class="btn" style="padding:8px 16px;background:#fee2e2;color:#dc2626;border:none;" 
                                            onclick="event.stopPropagation();DATA.tripChecklist.splice(${originalIdx}, 1);saveToStorage();render();">
                                            
                                        </button>
                                    </div>
                                `}).join('');
                            })()}
                        </div>
                        
                        <button class="btn" onclick="event.stopPropagation();DATA.tripChecklist.push({item: '', checked: false});saveToStorage();render();setTimeout(() => {const newInputs = document.querySelectorAll('.empty-item-input');const lastInput = newInputs[newInputs.length - 1];if (lastInput) {lastInput.focus();lastInput.select();}}, 10);"
                            style="width:100%;padding:15px;background:#3b82f6;color:white;font-size:16px;font-weight:600;">
                             Add Item
                        </button>
                        
                        ${DATA.tripChecklist.length === 0 ? `
                            <div style="text-align:center;padding:60px 20px;color:#999;">
                                <div style="font-size:64px;margin-bottom:20px;"></div>
                                <h3 style="color:#666;margin-bottom:10px;">No items yet</h3>
                                <p style="font-size:14px;">Click "Add Item" to create your on-trip checklist</p>
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }

            // TAB NAVIGATION
            h += `<div class="tab-navigation">
                ${(() => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tripStart = new Date(DATA.tripStartDate);
                    tripStart.setHours(0, 0, 0, 0);
                    const tripEnd = new Date(DATA.tripEndDate);
                    tripEnd.setHours(0, 0, 0, 0);
                    
                    const isBeforeTrip = today < tripStart;
                    const isAfterTrip = today > tripEnd;
                    const isDuringTrip = !isBeforeTrip && !isAfterTrip;
                    
                    // Determine tab name and whether to show
                    let todayTabName = ' Today';
                    let showTodayTab = DATA.tripStartDate && DATA.tripEndDate;
                    
                    if (isBeforeTrip) todayTabName = ' Countdown';
                    else if (isAfterTrip) todayTabName = ' Memories';
                    
                    // Build tabs in smart order
                    let tabs = [];
                    
                    if (isDuringTrip && showTodayTab) {
                        // During trip: Today FIRST
                        tabs.push(`<button class="tab-btn ${DATA.activeTab === 'today' ? 'active' : ''}" onclick="switchTab('today')">${todayTabName}</button>`);
                        tabs.push(`<button class="tab-btn ${DATA.activeTab === 'planning' ? 'active' : ''}" onclick="switchTab('planning')"> Planning & Budget</button>`);
                        tabs.push(`<button class="tab-btn ${DATA.activeTab === 'itinerary' ? 'active' : ''}" onclick="switchTab('itinerary')"> Day-by-Day Itinerary</button>`);
                        tabs.push(`<button class="tab-btn ${DATA.activeTab === 'gallery' ? 'active' : ''}" onclick="switchTab('gallery')"> Photo Gallery</button>`);
                    } else {
                        // Before/After trip: Today LAST
                        tabs.push(`<button class="tab-btn ${DATA.activeTab === 'planning' ? 'active' : ''}" onclick="switchTab('planning')"> Planning & Budget</button>`);
                        tabs.push(`<button class="tab-btn ${DATA.activeTab === 'itinerary' ? 'active' : ''}" onclick="switchTab('itinerary')"> Day-by-Day Itinerary</button>`);
                        tabs.push(`<button class="tab-btn ${DATA.activeTab === 'gallery' ? 'active' : ''}" onclick="switchTab('gallery')"> Photo Gallery</button>`);
                        if (showTodayTab) {
                            tabs.push(`<button class="tab-btn ${DATA.activeTab === 'today' ? 'active' : ''}" onclick="switchTab('today')">${todayTabName}</button>`);
                        }
                    }
                    
                    return tabs.join('');
                })()}
            </div>`;
            
            // PHOTO MODAL (shows on both tabs)
            if(DATA.photoModal) h += `<div class="photo-modal show" onclick="closePhotoModal()"><div class="photo-modal-content" onclick="event.stopPropagation()"><button class="photo-modal-close" onclick="closePhotoModal()"></button><img src="${DATA.photoModal}"></div></div>`;
            
            // ICON PICKER MODAL (shows on both tabs)
            if (DATA.iconPickerOpen) {
                h += `<div class="icon-picker-overlay show" onclick="closeIconPicker()"></div>
                <div class="icon-picker-modal show">
                    <h3 style="margin:0 0 15px 0;">Choose an Icon</h3>
                    <div class="icon-grid">
                        ${ICON_OPTIONS.map(icon => `
                            <div class="icon-option" onclick="event.stopPropagation();selectIcon('${icon}')">${icon}</div>
                        `).join('')}
                    </div>
                </div>`;
            }
            
            // ============================================
            // PLANNING TAB
            // ============================================
            h += `<div class="tab-content ${DATA.activeTab === 'planning' ? 'active' : ''}">`;
           
            // Trip notes
            h += `<div class="trip-notes-section">
                <h3>
                     Trip Notes
                    <span style="font-size:12px;font-weight:400;color:#666;">General notes, tips, and reminders</span>
                </h3>
                <textarea placeholder="Add general trip notes here... (travel tips, important info, things to remember, etc.)" onchange="DATA.tripNotes=this.value;saveToStorage();">${DATA.tripNotes}</textarea>
            </div>`;
          
            //data cards
            h += `<div class="stats">
                <div class="stat-card blue">
                    <div class="stat-label">Target Budget</div>
                    ${DATA.editBudget ? 
                        `<input type="number" class="edit-input" value="${DATA.budget}" 
                        onchange="DATA.budget=parseFloat(this.value)||5000;saveToStorage();showToast(' Budget updated', 'success');render()" 
                        onblur="DATA.editBudget=false;render()" autofocus>` : 
                        `<div class="stat-value" onclick="DATA.editBudget=true;render()">$${DATA.budget.toLocaleString()}</div>`
                    }
                    <div class="stat-sub">${DATA.currencySymbol}${(DATA.budget * DATA.rate).toLocaleString()}</div>
                    ${DATA.travelerCount > 1 && DATA.costSplitMode === 'perPerson' ? `<div class="stat-sub" style="margin-top:4px;">$${(DATA.budget/DATA.travelerCount).toFixed(0)}/person</div>` : ''}
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Actually Spent</div>
                    <div class="stat-value">${(s.tA / DATA.rate).toFixed(2)}</div>
                    <div class="stat-sub">${DATA.currencySymbol}${s.tA.toLocaleString()}</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Remaining</div>
                    <div class="stat-value">${(s.rem / DATA.rate).toFixed(2)}</div>
                    <div class="stat-sub">${DATA.currencySymbol}${Math.round(s.rem).toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Days Completed</div>
                    <div class="stat-value">${s.done}/55</div>
                    <div class="stat-sub">${((s.done/DATA.days.length)*100).toFixed(0)}% done</div>
                </div>
            </div>`;
           
            //estimated costs
            h += `<div class="toggle" onclick="DATA.showEst=!DATA.showEst;render()">
                <span> Show Estimated Costs</span>
                <div class="toggle-switch ${DATA.showEst?'on':''}">
                    <div class="toggle-slider"></div>
                </div>
            </div>`;
            if(DATA.showEst) {
                h += `<div class="stats">
                    <div class="stat-card ${s.over?'red':'blue'}">
                        <div class="stat-label">Estimated Total</div>
                        <div class="stat-value">${(s.tP/DATA.rate).toFixed(2)}</div>
                        <div class="stat-sub">${DATA.currencySymbol}${s.tP.toLocaleString()}</div>
                    </div>
                    <div class="stat-card ${s.over?'red':'blue'}">
                        <div class="stat-label">Estimated Remaining</div>
                        <div class="stat-value">${s.over?'-':''}${Math.abs(s.estRem/DATA.rate).toFixed(2)}</div>
                        <div class="stat-sub">${s.over?'-':''}${DATA.currencySymbol}${Math.abs(s.estRem).toLocaleString()}</div>
                    </div>
                    <div class="stat-card ${s.over?'red':'blue'}">
                        <div class="stat-label">Budget Status</div>
                        <div class="stat-value">${s.estPct.toFixed(1)}%</div>
                        <div class="stat-sub">${s.over?' Over':' Within'}</div>
                    </div>
                </div>`;
            }
        
            // Preparation Cards - Side by Side
            h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px;">
                <!-- Packing List Card -->
                <button class="analytics-card" onclick="DATA.showChecklistPage='packing';render()" style="padding:30px;text-align:left;border:2px solid #e5e7eb;">
                    <div class="analytics-card-icon" style="font-size:48px;"></div>
                    <div class="analytics-card-title" style="font-size:20px;">Packing List</div>
                    <div class="analytics-card-desc" style="margin-bottom:15px;">What to bring</div>
                    ${DATA.packingList && DATA.packingList.length > 0 ? `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f0f9ff;border-radius:6px;margin-top:15px;">
                            <span style="font-size:13px;color:#666;">Progress</span>
                            <span class="packing-card-progress" style="font-size:14px;font-weight:600;color:#3b82f6;">
                                ${DATA.packingList.filter(i => i.packed).length}/${DATA.packingList.length} packed
                            </span>
                        </div>
                    ` : `
                        <div style="font-size:13px;color:#999;font-style:italic;margin-top:15px;">No items yet</div>
                    `}
                    <div class="analytics-card-arrow" style="margin-top:15px;"></div>
                </button>
                
                <!-- Before Trip Checklist Card -->
                <button class="analytics-card" onclick="DATA.showChecklistPage='before';render()" style="padding:30px;text-align:left;border:2px solid #e5e7eb;">
                    <div class="analytics-card-icon" style="font-size:48px;"></div>
                    <div class="analytics-card-title" style="font-size:20px;">Before Trip Checklist</div>
                    <div class="analytics-card-desc" style="margin-bottom:15px;">Preparation tasks</div>
                    ${DATA.beforeChecklist && DATA.beforeChecklist.length > 0 ? `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f0fdf4;border-radius:6px;margin-top:15px;">
                            <span style="font-size:13px;color:#666;">Progress</span>
                            <span class="before-card-progress" style="font-size:14px;font-weight:600;color:#10b981;">
                                ${DATA.beforeChecklist.filter(i => i.checked).length}/${DATA.beforeChecklist.length} done
                            </span>
                        </div>
                    ` : `
                        <div style="font-size:13px;color:#999;font-style:italic;margin-top:15px;">No items yet</div>
                    `}
                    <div class="analytics-card-arrow" style="margin-top:15px;"></div>
                </button>
            </div>`;
          
            //map
            h += `<div class="map-section">
                <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;margin-bottom:15px;" onclick="toggleMap()">
                    <h3 style="margin:0;"> Trip Map & Route Planning</h3>
                    <span style="font-size:20px;transition:transform 0.3s;${DATA.showMap ? 'transform:rotate(180deg);' : ''}"></span>
                </div>
                
                ${DATA.showMap ? `
                    <div class="map-controls">
                        <button class="map-btn ${DATA.mapView === 'all' ? 'active' : ''}" onclick="switchMapView('all')"> All Locations</button>
                        <button class="map-btn ${DATA.mapView === 'route' ? 'active' : ''}" onclick="switchMapView('route')"> Show Route</button>
                        <button class="map-btn" id="geocodeBtn" onclick="geocodeAllLocations()"> Refresh Map</button>
                        <button class="map-btn ${DATA.mapEditMode ? 'active' : ''}" onclick="toggleMapEditMode()">
                            ${DATA.mapEditMode ? ' Done Editing' : ' Edit Map'}
                        </button>
                        <button class="map-btn" onclick="addCustomWaypoint()"> Add Waypoint</button>
                        <button class="map-btn" onclick="clearMapCache()" style="background:#fee;color:#dc2626;"> Clear Cache</button>
                    </div>
                    
                    <div id="tripMap" class="map-container"></div>
                    
                    <div class="route-stats">
                        <div class="route-stat-card">
                            <div class="route-stat-label">Total Locations</div>
                            <div class="route-stat-value" id="mapTotalLocations">0</div>
                        </div>
                        <div class="route-stat-card">
                            <div class="route-stat-label">Total Distance</div>
                            <div class="route-stat-value" id="mapTotalDistance">Calculating...</div>
                        </div>
                        <div class="route-stat-card">
                            <div class="route-stat-label">Trip Duration</div>
                            <div class="route-stat-value" id="mapTotalDays">${DATA.days.length} days</div>
                        </div>
                    </div>
                    
                ${DATA.mapEditMode ? `
                    <div class="location-list">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h4 style="font-size:14px;margin:0;"> Route Order</h4>
                            <div style="display:flex;gap:8px;">
                                <button class="btn" onclick="addManualLocation()" style="padding:4px 12px;font-size:12px;background:#10b981;">
                                     Add Location
                                </button>
                                <button class="btn" onclick="addCustomWaypoint()" style="padding:4px 12px;font-size:12px;background:#8b5cf6;">
                                     Add Waypoint
                                </button>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#666;margin-bottom:10px;">
                             Drag to reorder your route. Locations and waypoints in order from top to bottom.
                        </div>
                        ${getAllMapLocations().map(loc => `
                            <div class="location-item ${DATA.editingLocation === loc.id ? 'being-edited' : ''}"
                                draggable="true" 
                                data-location-id="${loc.id}"
                                ondragstart="handleDragStart(event, '${loc.id}')"
                                ondragover="handleDragOver(event)"
                                ondrop="handleDrop(event, '${loc.id}')"
                                ondragend="handleDragEnd(event)">
                                <span class="location-drag-handle"></span>
                                <div style="flex:1;">
                                    <div style="font-weight:600;font-size:13px;display:flex;align-items:center;gap:8px;">
                                        ${loc.type === 'waypoint' ? '' : ''} 
                                        <span data-location="${loc.id}">${loc.name}</span>
                                        ${loc.type === 'waypoint' ? '<span style="font-size:10px;background:#8b5cf6;color:white;padding:2px 6px;border-radius:4px;">WAYPOINT</span>' : ''}
                                    </div>
                                    <div class="location-coords">${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}</div>
                                </div>
                                <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `editWaypointInfo(${loc.waypointIndex})` : `editLocation('${loc.name}')`}" style="padding:4px 10px;font-size:11px;"> Edit Name</button>
                                <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `editWaypointCoords(${loc.waypointIndex})` : `editLocationCoords('${loc.name}')`}" style="padding:4px 10px;font-size:11px;background:#3b82f6;"> Edit Coords</button>
                                <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `deleteWaypointFromList(${loc.waypointIndex})` : `deleteLocationFromCache('${loc.name}')`}" style="padding:4px 10px;font-size:11px;background:#ef4444;"> Delete</button>
                            </div>
                        `).join('')}
                        ${getAllMapLocations().length === 0 ? `
                            <div style="padding:20px;text-align:center;color:#999;font-size:13px;">
                                No locations yet. Add locations or waypoints to plan your route.
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                    
                    <div style="margin-top:15px;padding:10px;background:#f0f9ff;border-radius:6px;font-size:13px;color:#1e40af;">
                         <strong>Tip:</strong> Click "Edit Map" to drag markers and adjust locations. Add custom waypoints for stops along the way.
                    </div>
                ` : ''}
            </div>`;

            // Analytics & Tools Cards
            h += `<div class="analytics-cards-section">
                <h3 style="font-size:20px;margin-bottom:20px;color:#1f2937;"> Analytics & Tools</h3>
                
                <div class="analytics-cards-grid">
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='trends';render()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Spending Trends</div>
                        <div class="analytics-card-desc">Daily, cumulative & category trends</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                    
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='breakdown';render()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Expense Breakdown</div>
                        <div class="analytics-card-desc">Category spending analysis</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                    
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='budget';render()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Budget by Category</div>
                        <div class="analytics-card-desc">Set & track category budgets</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                    
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='receipts';render()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Receipt Analytics</div>
                        <div class="analytics-card-desc">Receipt totals & breakdown</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                    
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='comparison';render()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Budget vs Actual</div>
                        <div class="analytics-card-desc">Compare planned vs spent</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                    
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='timeline';render()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Trip Timeline</div>
                        <div class="analytics-card-desc">Visual trip progression</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                </div>
            </div>`; 
           

            h += `</div>`;  
            // Before trip checklist
            // On trip checklist
            
            // [PUT ALL YOUR PLANNING CONTENT HERE - everything except search bar, progress bar, daily budget, show estimated toggle, and day cards]
            
            h += `</div>`; // Close planning tab
            

            // ============================================
            // ITINERARY TAB
            // ============================================

            h += `<div class="tab-content ${DATA.activeTab === 'itinerary' ? 'active' : ''}">`;
            
            h += `<div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder=" Search by location, date, activity, notes..." value="${DATA.searchQuery}" style="padding-right:60px;">
                <div style="position:absolute;top:50%;right:15px;transform:translateY(-50%);font-size:16px;color:#666;cursor:pointer;user-select:none;padding:4px 8px;background:#f5f5f5;border-radius:4px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;" 
                     onmouseover="this.style.background='#e5e5e5';this.style.color='#333'" 
                     onmouseout="this.style.background='#f5f5f5';this.style.color='#666'"
                     onclick="DATA.searchMode=DATA.searchMode==='enter'?'auto':'enter';render()" 
                     title="${DATA.searchMode === 'enter' ? 'Press Enter to search' : 'Auto-search (400ms)'}">
                    ${DATA.searchMode === 'enter' ? '' : ''}
                </div>
                ${DATA.showSearchResults ? `
                    <div class="search-dropdown show">
                        ${DATA.searchResults.length > 0 ? 
                            DATA.searchResults.map(result => `
                                <div class="search-result-item" onclick="jumpToDay(${result.dayIndex})">
                                    <div class="search-result-day">Day ${result.day.d} - ${result.day.dt}</div>
                                    <div class="search-result-location">${result.day.loc}</div>
                                    ${result.matches.map(match => `
                                        <div class="search-result-match">
                                            <strong>${match.field}:</strong> ${highlightText(match.value, DATA.searchQuery)}
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('') 
                            : '<div class="search-no-results">No results found</div>'
                        }
                    </div>
                ` : ''}
            </div>`;
            // Search bar
            h += `<div class="progress">
                <div class="progress-label">
                    <span>Budget Progress</span>
                    <span>${s.pct.toFixed(1)}% spent</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${s.pct>100?'over':''}" style="width:${Math.min(s.pct,100)}%"></div>
                </div>
            </div>`;
            // Progress bar

            h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px;">
                <button class="analytics-card" onclick="DATA.showChecklistPage='trip';render()" style="padding:30px;text-align:left;border:2px solid #e5e7eb;">
                    <div class="analytics-card-icon" style="font-size:48px;"></div>
                    <div class="analytics-card-title" style="font-size:20px;">On Trip Checklist</div>
                    <div class="analytics-card-desc" style="margin-bottom:15px;">Daily reminders</div>
                    ${DATA.tripChecklist && DATA.tripChecklist.length > 0 ? `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#eff6ff;border-radius:6px;margin-top:15px;">
                            <span style="font-size:13px;color:#666;">Progress</span>
                            <span class="trip-card-progress" style="font-size:14px;font-weight:600;color:#3b82f6;">
                                ${DATA.tripChecklist.filter(i => i.checked).length}/${DATA.tripChecklist.length} done
                            </span>
                        </div>
                    ` : `
                        <div style="font-size:13px;color:#999;font-style:italic;margin-top:15px;">No items yet</div>
                    `}
                    <div class="analytics-card-arrow" style="margin-top:15px;"></div>
                </button>
            </div>`;

            DATA.days.forEach((day, realIndex) => {
                const pT = calc(day), aT = calcA(day);
                const exp = DATA.expanded === realIndex;
                const edit = DATA.editing === realIndex;
                
            h += `<div class="day-card ${day.done?'done':''}" data-day="${realIndex}">
                <div class="day-header" onclick="DATA.expanded=DATA.expanded===${realIndex}?null:${realIndex};render()">
                    <div class="day-info">
                        <input type="checkbox" class="day-check" ${day.done?'checked':''} onclick="event.stopPropagation();DATA.days[${realIndex}].done=!DATA.days[${realIndex}].done;saveToStorage();render()">
                        <div class="day-num">${day.d}</div>
                        <div class="day-title">
                            ${DATA.editing === realIndex ? 
                                `<div style="display:flex;flex-direction:column;gap:8px;" onclick="event.stopPropagation();">
                                    <div style="display:flex;gap:8px;align-items:center;">
                                        <input type="number" value="${day.d}" onchange="update(${realIndex},'base','d',this.value)" onclick="event.stopPropagation();" placeholder="Day" style="width:60px;padding:6px 8px;border:2px solid #3b82f6;border-radius:4px;">
                                        <input type="text" value="${day.dt}" onchange="update(${realIndex},'base','dt',this.value)" onclick="event.stopPropagation();" placeholder="Date" style="width:100px;padding:6px 8px;border:2px solid #3b82f6;border-radius:4px;">
                                        <button class="save-edit-btn" onclick="event.stopPropagation();DATA.editing=null;render()">Save</button>
                                    </div>
                                    <input type="text" value="${day.loc}" onchange="update(${realIndex},'base','loc',this.value)" onclick="event.stopPropagation();" placeholder="Location" style="padding:8px 12px;border:2px solid #3b82f6;border-radius:4px;">
                                </div>` :
                                `<div style="display:flex;flex-direction:column;gap:2px;">
                                    <h3>${day.loc}</h3>
                                    <div class="date" style="display:flex;align-items:center;gap:10px;">
                                        <span>${day.dt}  Day ${day.d}</span>
                                        ${exp ? `<span class="edit-day-link" onclick="event.stopPropagation();DATA.editing=${realIndex};render()">Edit</span>` : ''}
                                    </div>
                                </div>`
                            }
                        </div>
                    </div>
                    <div class="day-cost">
                        <div class="amount">${formatCostWithSplit(day.done?aT:pT)} ${day.done?'(actual)':'(planned)'}</div>
                        <div class="usd">$${((day.done?aT:pT)/DATA.rate).toFixed(2)}${DATA.costSplitMode === 'perPerson' && DATA.travelerCount > 1 ? ` ($${(((day.done?aT:pT)/DATA.rate)/DATA.travelerCount).toFixed(2)}/person)` : ''}</div>
                    </div>
                </div>`;
                
                if(exp) {
                    h += `<div class="details show">`;  // Start details
                    
                    // NO EDIT FORM HERE - editing happens in header
                    
                    // Just show the actual spending section
                    h += `<div class="section yellow">
                        <h4 style="font-size:14px;font-weight:600;margin-bottom:10px"> Actual Spending</h4>
                        <div class="grid">
                            ${DATA.categories.map(cat => {
                                const actualValue = day.a?.[cat.id] || 0;
                                return `<input type="number" placeholder="${cat.icon} ${DATA.currencySymbol}" value="${actualValue || ''}" onchange="update(${realIndex},'${cat.id}','',this.value)" style="border-left:3px solid ${cat.color};">`;
                            }).join('')}
                        </div>
                    </div>`;
    
                    

                h += `<div class="day-activities-grid">
                        <!-- Categories Grid (2x2) -->
                        <div class="category-card-grid">
                            ${DATA.categories.map(cat => {
                                const catData = day[cat.id] || {d: '', n: '', p: 0};
                                const actualSpent = day.a?.[cat.id] || 0;
                                const description = catData.n || catData.d || 'No details';
                                const plannedAmount = catData.p || 0;
                                
                                return `
                                    <div class="category-card" onclick="openCategoryModal(${realIndex}, '${cat.id}')">
                                        <div class="category-card-header">
                                            <span class="category-card-icon" style="background: ${cat.color}20; color: ${cat.color}">${cat.icon}</span>
                                            <span class="category-card-title">${cat.name}</span>
                                        </div>
                                        <div class="category-card-content">
                                            ${description}
                                        </div>
                                        <div class="category-card-cost">
                                            <div class="planned-cost">
                                                Planned: ${DATA.currencySymbol}${plannedAmount.toLocaleString()}
                                            </div>
                                            ${actualSpent > 0 ? `
                                                <div class="actual-cost">
                                                    Actual: ${DATA.currencySymbol}${actualSpent.toLocaleString()}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="notes-card ${day.note ? '' : 'empty'}" onclick="openNotesModal(${realIndex})">
                            <div class="category-card-header">
                                <span class="category-card-icon" style="background:#ffffff;color:#d97706;"></span>
                                <span class="category-card-title">Notes</span>
                            </div>
                            <div class="category-card-content">
                                ${day.note && day.note.trim()
                                    ? day.note
                                    : '<span class="muted">Click to add notes</span>'}
                            </div>
                        </div>
                    </div>`;
                    
                    // Day Activities & Media Cards
                    h += `<div class="day-activities-cards">
                        <button class="day-activity-card" onclick="event.stopPropagation();DATA.days[${realIndex}].showDaySection='photos';render()">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Photos & Journal</div>
                            <div class="day-card-badge">${day.photos && day.photos.length > 0 ? day.photos.length + ' photo' + (day.photos.length > 1 ? 's' : '') : 'No photos'}</div>
                        </button>
                        
                        <button class="day-activity-card" onclick="event.stopPropagation();DATA.days[${realIndex}].showDaySection='receipts';render()">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Receipts</div>
                            <div class="day-card-badge">${day.receipts && day.receipts.length > 0 ? DATA.currencySymbol + day.receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0).toLocaleString() : 'No receipts'}</div>
                        </button>
                        
                        <button class="day-activity-card" onclick="event.stopPropagation();DATA.days[${realIndex}].showDaySection='schedule';render()">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Schedule</div>
                            <div class="day-card-badge">${day.schedule && day.schedule.length > 0 ? day.schedule.length + ' event' + (day.schedule.length > 1 ? 's' : '') : 'No schedule'}</div>
                        </button>
                        
                        <button class="day-activity-card" onclick="event.stopPropagation();DATA.days[${realIndex}].showDaySection='weather';render()">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Weather</div>
                            <div class="day-card-badge">${day.weather && !day.weather.error ? day.weather.temp + 'F' : 'Not loaded'}</div>
                        </button>
                    </div>`;

                    h += `<div class="day-card-controls">
                        <button class="day-control-btn" onclick="event.stopPropagation();duplicateDay(${realIndex})"> Duplicate Day</button>
                        <button class="day-control-btn danger" onclick="event.stopPropagation();deleteDay(${realIndex})"> Delete Day</button>
                    </div>`;
                    
                    h += `</div>`;
                }
                
                h += `</div>`;
            });
            h += `<div style="margin-top:20px;text-align:center;">
                <button class="header-btn" onclick="addDay()"> Add New Day</button>
            </div>`;

            h += `<button class="fab" onclick="addDay()" title="Add Day"></button>`;

                        
            h += `</div>`; // Close itinerary tab
            
            // ============================================
            // GALLERY TAB
            // ============================================

            h += `<div class="tab-content ${DATA.activeTab === 'gallery' ? 'active' : ''}">`;

            h += `<div class="gallery-controls">
                <button class="gallery-view-btn ${!DATA.galleryView || DATA.galleryView === 'timeline' ? 'active' : ''}" onclick="DATA.galleryView='timeline';render()">
                     Timeline View
                </button>
                <button class="gallery-view-btn ${DATA.galleryView === 'grid' ? 'active' : ''}" onclick="DATA.galleryView='grid';render()">
                     Grid View
                </button>
                <button class="gallery-view-btn ${DATA.galleryView === 'map' ? 'active' : ''}" onclick="DATA.galleryView='map';render()">
                     Map View
                </button>
            </div>`;

            // Timeline View
            if (!DATA.galleryView || DATA.galleryView === 'timeline') {
                const daysWithPhotos = DATA.days.filter(day => day.photos && day.photos.length > 0);
                
                if (daysWithPhotos.length === 0) {
                    h += `<div style="text-align:center;padding:60px 20px;color:#999;">
                        <div style="font-size:60px;margin-bottom:20px;"></div>
                        <h3>No photos yet</h3>
                        <p>Start adding photos to your trip days to see them here!</p>
                    </div>`;
                } else {
                    h += `<div class="gallery-timeline">`;
                    daysWithPhotos.forEach(day => {
                        const photoCount = day.photos.length;
                        h += `<div class="gallery-day-section">
                            <div class="gallery-day-header">
                                <h3>Day ${day.d} - ${day.dt}</h3>
                                <div class="gallery-day-location">${day.loc}</div>
                                <div class="gallery-photo-count">${photoCount} photo${photoCount > 1 ? 's' : ''}</div>
                            </div>
                            <div class="gallery-grid">
                                ${day.photos.map(photo => `
                                    <div class="gallery-photo-item" onclick="openPhotoModal('${photo}')">
                                        <img src="${photo}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    });
                    h += `</div>`;
                }
            }

            // Grid View
            if (DATA.galleryView === 'grid') {
                const allPhotos = [];
                DATA.days.forEach(day => {
                    if (day.photos && day.photos.length > 0) {
                        day.photos.forEach(photo => {
                            allPhotos.push({ photo, day });
                        });
                    }
                });
                
                if (allPhotos.length === 0) {
                    h += `<div style="text-align:center;padding:60px 20px;color:#999;">
                        <div style="font-size:60px;margin-bottom:20px;"></div>
                        <h3>No photos yet</h3>
                        <p>Start adding photos to your trip days to see them here!</p>
                    </div>`;
                } else {
                    h += `<div class="gallery-stats">
                        <div class="stat-card">
                            <div class="stat-label">Total Photos</div>
                            <div class="stat-value">${allPhotos.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Days with Photos</div>
                            <div class="stat-value">${DATA.days.filter(d => d.photos && d.photos.length > 0).length}</div>
                        </div>
                    </div>`;
                    
                    h += `<div class="gallery-grid-all">
                        ${allPhotos.map(item => `
                            <div class="gallery-photo-item" onclick="openPhotoModal('${item.photo}')">
                                <img src="${item.photo}">
                                <div class="gallery-photo-overlay">
                                    <div class="gallery-photo-day">Day ${item.day.d}</div>
                                    <div class="gallery-photo-location">${item.day.loc}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }
            }

            // Map View
            if (DATA.galleryView === 'map') {
                h += `<div style="padding:20px;text-align:center;color:#666;">
                    <p> Map view coming soon! This will show photos on a map based on their location.</p>
                    <p style="font-size:13px;margin-top:10px;">Tip: Take photos with location services enabled for automatic placement.</p>
                </div>`;
            }

            h += `</div>`; // Close gallery tab

            // ============================================
            // TODAY TAB
            // ============================================

            h += `<div class="tab-content ${DATA.activeTab === 'today' ? 'active' : ''}">`;

            // Get today's date and trip status
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tripStart = new Date(DATA.tripStartDate);
            tripStart.setHours(0, 0, 0, 0);
            const tripEnd = new Date(DATA.tripEndDate);
            tripEnd.setHours(0, 0, 0, 0);

            const isBeforeTrip = today < tripStart;
            const isAfterTrip = today > tripEnd;
            const isDuringTrip = !isBeforeTrip && !isAfterTrip;

            // Find today's day
            const todayDay = DATA.days.find(day => {
                if (!day.dt) return false;
                
                // Parse "YYYY-M-D" format manually
                const [year, month, dayNum] = day.dt.split('-').map(num => parseInt(num, 10));
                const dayDate = new Date(year, month - 1, dayNum); // Month is 0-indexed in JS
                dayDate.setHours(0, 0, 0, 0);
                
                return dayDate.getTime() === today.getTime();
            });

            if (isBeforeTrip) {
                // BEFORE TRIP - Countdown View
                const daysUntil = Math.ceil((tripStart - today) / (1000 * 60 * 60 * 24));
                const totalPlanned = DATA.days.reduce((sum, day) => sum + calc(day), 0);
                const packedItems = DATA.packingList.filter(item => item.packed).length;
                const totalPackingItems = DATA.packingList.length;
                const beforeChecklistDone = DATA.beforeChecklist.filter((item, idx) => {
                    const checkbox = document.querySelector(`#beforeCheck${idx}`);
                    return checkbox && checkbox.checked;
                }).length;
                
                h += `
                    <div class="today-hero" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:60px 40px;border-radius:12px;text-align:center;margin-bottom:30px;">
                        <div style="font-size:64px;margin-bottom:20px;"></div>
                        <h1 style="margin:0 0 15px 0;font-size:36px;">Trip Countdown</h1>
                        <p style="font-size:20px;margin:0 0 10px 0;opacity:0.9;">Your trip starts in <strong>${daysUntil} day${daysUntil !== 1 ? 's' : ''}</strong>!</p>
                        <p style="font-size:16px;margin:0;opacity:0.8;">Departure: ${new Date(DATA.tripStartDate).toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;">
                        <div class="today-card">
                            <h3 style="margin:0 0 15px 0;font-size:18px;display:flex;align-items:center;gap:10px;">
                                <span style="font-size:28px;"></span> Pre-Trip Checklist
                            </h3>
                            ${DATA.beforeChecklist && DATA.beforeChecklist.length > 0 ? `
                                <div style="margin-bottom:15px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                        <span style="font-size:14px;color:#666;">Items</span>
                                        <span style="font-size:14px;font-weight:600;">${DATA.beforeChecklist.length} item${DATA.beforeChecklist.length !== 1 ? 's' : ''}</span>
                                    </div>
                                </div>
                                <a href="#" onclick="DATA.activeTab='itinerary';DATA.editBeforeChecklist=true;render();return false;" style="color:#3b82f6;font-size:13px;">
                                    View checklist 
                                </a>
                            ` : `
                                <p style="color:#999;font-style:italic;font-size:14px;">
                                    No checklist items yet. 
                                    <a href="#" onclick="DATA.activeTab='itinerary';DATA.editBeforeChecklist=true;render();return false;" style="color:#3b82f6;">
                                        Create checklist 
                                    </a>
                                </p>
                            `}
                        </div>
                        
                        <div class="today-card">
                            <h3 style="margin:0 0 15px 0;font-size:18px;display:flex;align-items:center;gap:10px;">
                                <span style="font-size:28px;"></span> Packing List Progress
                            </h3>
                            ${DATA.packingList && DATA.packingList.length > 0 ? `
                                <div style="margin-bottom:15px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                        <span style="font-size:14px;color:#666;">Packed</span>
                                        <span style="font-size:14px;font-weight:600;">${packedItems} / ${totalPackingItems}</span>
                                    </div>
                                    <div style="width:100%;height:12px;background:#f0f0f0;border-radius:6px;overflow:hidden;">
                                        <div style="width:${totalPackingItems > 0 ? (packedItems/totalPackingItems*100) : 0}%;height:100%;background:#10b981;transition:width 0.3s;"></div>
                                    </div>
                                </div>
                                <a href="#" onclick="DATA.activeTab='planning';render();return false;" style="color:#3b82f6;font-size:13px;">
                                    View packing list 
                                </a>
                            ` : `
                                <p style="color:#999;font-style:italic;font-size:14px;">
                                    No packing list yet. 
                                    <a href="#" onclick="DATA.activeTab='planning';render();return false;" style="color:#3b82f6;">
                                        Create packing list 
                                    </a>
                                </p>
                            `}
                        </div>
                        
                        <div class="today-card">
                            <h3 style="margin:0 0 15px 0;font-size:18px;display:flex;align-items:center;gap:10px;">
                                <span style="font-size:28px;"></span> Budget Summary
                            </h3>
                            <div style="display:grid;gap:10px;">
                                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0;">
                                    <span style="font-size:14px;color:#666;">Budget</span>
                                    <span style="font-size:14px;font-weight:600;">${DATA.currencySymbol}${Math.round(DATA.budget * DATA.rate).toLocaleString()}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0;">
                                    <span style="font-size:14px;color:#666;">Planned</span>
                                    <span style="font-size:14px;font-weight:600;">${DATA.currencySymbol}${Math.round(totalPlanned).toLocaleString()}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:8px 0;">
                                    <span style="font-size:14px;color:#666;">Budget Usage</span>
                                    <span style="font-size:14px;font-weight:600;color:${totalPlanned > (DATA.budget * DATA.rate) ? '#ef4444' : '#10b981'}">
                                        ${totalPlanned > 0 && (DATA.budget * DATA.rate) > 0 ? ((totalPlanned / (DATA.budget * DATA.rate)) * 100).toFixed(1) : '0'}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } else if (isAfterTrip) {
                // AFTER TRIP - Memories View
                const daysAgo = Math.ceil((today - tripEnd) / (1000 * 60 * 60 * 24));
                const totalActual = DATA.days.reduce((sum, day) => sum + calcA(day), 0);
                const totalBudget = DATA.budget * DATA.rate;
                const budgetDiff = totalBudget - totalActual;
                const totalPhotos = DATA.days.reduce((sum, day) => sum + (day.photos?.length || 0), 0);
                
                h += `
                    <div class="today-hero" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;padding:60px 40px;border-radius:12px;text-align:center;margin-bottom:30px;">
                        <div style="font-size:64px;margin-bottom:20px;"></div>
                        <h1 style="margin:0 0 15px 0;font-size:36px;">Trip Completed!</h1>
                        <p style="font-size:20px;margin:0 0 10px 0;opacity:0.9;">Your ${DATA.tripTitle} ended ${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago</p>
                        <p style="font-size:16px;margin:0;opacity:0.8;">${new Date(DATA.tripStartDate).toLocaleDateString()} - ${new Date(DATA.tripEndDate).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="today-card" style="margin-bottom:30px;">
                        <h3 style="margin:0 0 20px 0;font-size:24px;text-align:center;"> Final Stats</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;text-align:center;">
                            <div>
                                <div style="font-size:32px;font-weight:700;color:#3b82f6;margin-bottom:5px;">
                                    ${DATA.currencySymbol}${totalActual.toLocaleString()}
                                </div>
                                <div style="font-size:14px;color:#666;">Total Spent</div>
                                <div style="font-size:12px;color:#999;margin-top:4px;">$${(totalActual/DATA.rate).toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size:32px;font-weight:700;color:${budgetDiff >= 0 ? '#10b981' : '#ef4444'};margin-bottom:5px;">
                                    ${budgetDiff >= 0 ? 'Under' : 'Over'} ${DATA.currencySymbol}${Math.abs(budgetDiff).toLocaleString()}
                                </div>
                                <div style="font-size:14px;color:#666;">Budget Status</div>
                                <div style="font-size:12px;color:#999;margin-top:4px;">${((totalActual/totalBudget)*100).toFixed(1)}% of budget</div>
                            </div>
                            <div>
                                <div style="font-size:32px;font-weight:700;color:#8b5cf6;margin-bottom:5px;">
                                    ${totalPhotos}
                                </div>
                                <div style="font-size:14px;color:#666;">Photos Captured</div>
                            </div>
                            <div>
                                <div style="font-size:32px;font-weight:700;color:#f59e0b;margin-bottom:5px;">
                                    Priceless
                                </div>
                                <div style="font-size:14px;color:#666;">Memories Created</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;">
                        <button class="today-action-card" onclick="DATA.activeTab='gallery';render()">
                            <div style="font-size:48px;margin-bottom:10px;"></div>
                            <div style="font-size:18px;font-weight:600;margin-bottom:5px;">View Gallery</div>
                            <div style="font-size:13px;color:#666;">Relive your memories</div>
                        </button>
                        
                        <button class="today-action-card" onclick="DATA.showAnalyticsPage='comparison';render()">
                            <div style="font-size:48px;margin-bottom:10px;"></div>
                            <div style="font-size:18px;font-weight:600;margin-bottom:5px;">Budget Report</div>
                            <div style="font-size:13px;color:#666;">View detailed analytics</div>
                        </button>
                    </div>
                    
                    <div class="today-card">
                        <h3 style="margin:0 0 15px 0;font-size:18px;"> Trip Reflection</h3>
                        <textarea placeholder="How was your trip? What were the highlights? Any lessons learned?" 
                                style="width:100%;min-height:150px;padding:15px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;line-height:1.6;resize:vertical;"
                                onchange="DATA.tripReflection=this.value;saveToStorage();">${DATA.tripReflection || ''}</textarea>
                    </div>
                `;
                
            } else if (isDuringTrip) {
                // DURING TRIP - Today View
                if (!todayDay) {
                    h += `
                        <div class="today-hero" style="background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);color:white;padding:60px 40px;border-radius:12px;text-align:center;">
                            <div style="font-size:64px;margin-bottom:20px;"></div>
                            <h1 style="margin:0 0 15px 0;font-size:36px;">No Day Scheduled</h1>
                            <p style="font-size:18px;margin:0;opacity:0.9;">You don't have a day planned for today (${today.toLocaleDateString()})</p>
                            <button class="btn" onclick="DATA.activeTab='itinerary';render()" style="margin-top:20px;padding:12px 24px;background:white;color:#4b5563;">
                                Go to Itinerary
                            </button>
                        </div>
                    `;
                } else {
                    const dayIndex = DATA.days.indexOf(todayDay);
                    const dayTotal = todayDay.done ? calcA(todayDay) : calc(todayDay);
                    // Parse "YYYY-M-D" format manually
                    const [year, month, dayNum] = todayDay.dt.split('-').map(num => parseInt(num, 10));
                    const todayDate = new Date(year, month - 1, dayNum); // Month is 0-indexed in JS
                    const dayName = todayDate.toLocaleDateString('en-US', {weekday: 'long'});
                    const fullDate = todayDate.toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
                    
                    h += `
                        <div class="today-hero" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:40px;border-radius:12px;margin-bottom:30px;">
                            <div style="font-size:48px;margin-bottom:15px;"></div>
                            <h1 style="margin:0 0 10px 0;font-size:32px;">Day ${todayDay.d} of ${DATA.days.length}</h1>
                            <h2 style="margin:0 0 10px 0;font-size:24px;font-weight:600;">${todayDay.loc}</h2>
                            <p style="margin:0;font-size:16px;opacity:0.9;">${dayName}, ${fullDate}</p>
                        </div>
                        
                        <div style="display:grid;gap:25px;">
                            <!-- Today's Schedule -->
                            <div class="today-card">
                                <h3 style="margin:0 0 15px 0;font-size:20px;display:flex;align-items:center;gap:10px;">
                                    <span style="font-size:28px;"></span> Today's Schedule
                                </h3>
                                ${todayDay.schedule && todayDay.schedule.length > 0 ? `
                                    <div style="display:flex;flex-direction:column;gap:12px;">
                                        ${todayDay.schedule.sort((a, b) => a.time.localeCompare(b.time)).map((item, idx) => `
                                            <div style="display:flex;gap:15px;align-items:start;padding:12px;background:#f9fafb;border-radius:8px;">
                                                <input type="checkbox" style="width:20px;height:20px;margin-top:2px;">
                                                <div style="flex:1;">
                                                    <div style="font-weight:600;margin-bottom:4px;">${item.time} - ${item.activity}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="color:#999;font-style:italic;">No schedule for today. <a href="#" onclick="DATA.days[' + dayIndex + '].showDaySection=\'schedule\';render();return false;" style="color:#3b82f6;">Add schedule </a></p>'}
                            </div>
                            
                            <!-- Today's Budget -->
                            <div class="today-card">
                                <h3 style="margin:0 0 15px 0;font-size:20px;display:flex;align-items:center;gap:10px;">
                                    <span style="font-size:28px;"></span> Today's Budget: ${DATA.currencySymbol}${dayTotal.toLocaleString()}
                                </h3>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;">
                                    ${DATA.categories.map(cat => {
                                        const planned = todayDay[cat.id]?.p || 0;
                                        const actual = todayDay.a?.[cat.id] || 0;
                                        return `
                                            <div style="padding:12px;background:#f9fafb;border-radius:8px;border-left:3px solid ${cat.color};">
                                                <div style="font-size:12px;color:#666;margin-bottom:4px;">${cat.icon} ${cat.name}</div>
                                                <div style="font-weight:600;">${DATA.currencySymbol}${(actual || planned).toLocaleString()}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                                <button class="today-action-card" onclick="DATA.days[${dayIndex}].showDaySection='receipts';render()">
                                    <div style="font-size:36px;margin-bottom:8px;"></div>
                                    <div style="font-size:16px;font-weight:600;">Add Receipt</div>
                                    ${todayDay.receipts && todayDay.receipts.length > 0 ? `<div style="font-size:12px;color:#666;margin-top:4px;">${todayDay.receipts.length} receipt${todayDay.receipts.length > 1 ? 's' : ''} today</div>` : ''}
                                </button>
                                
                                <button class="today-action-card" onclick="DATA.days[${dayIndex}].showDaySection='photos';render()">
                                    <div style="font-size:36px;margin-bottom:8px;"></div>
                                    <div style="font-size:16px;font-weight:600;">Add Photo</div>
                                    ${todayDay.photos && todayDay.photos.length > 0 ? `<div style="font-size:12px;color:#666;margin-top:4px;">${todayDay.photos.length} photo${todayDay.photos.length > 1 ? 's' : ''} today</div>` : ''}
                                </button>
                                
                                <button class="today-action-card" onclick="DATA.days[${dayIndex}].showDaySection='weather';render()">
                                    <div style="font-size:36px;margin-bottom:8px;"></div>
                                    <div style="font-size:16px;font-weight:600;">Check Weather</div>
                                    ${todayDay.weather && !todayDay.weather.error ? `<div style="font-size:12px;color:#666;margin-top:4px;">${todayDay.weather.temp}F</div>` : ''}
                                </button>
                            </div>
                            
                            <!-- Journal Entry -->
                            <div class="today-card">
                                <h3 style="margin:0 0 15px 0;font-size:20px;display:flex;align-items:center;gap:10px;">
                                    <span style="font-size:28px;"></span> Quick Journal Entry
                                </h3>
                                <textarea placeholder="How's your day going? Jot down thoughts, experiences, or things you don't want to forget..." 
                                        style="width:100%;min-height:120px;padding:15px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;line-height:1.6;resize:vertical;"
                                        onchange="updateJournal(${dayIndex}, this.value)">${todayDay.journalNote || ''}</textarea>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Fallback - no dates set
                h += `
                    <div class="today-hero" style="background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);color:white;padding:60px 40px;border-radius:12px;text-align:center;">
                        <div style="font-size:64px;margin-bottom:20px;"></div>
                        <h1 style="margin:0 0 15px 0;font-size:36px;">Set Your Trip Dates</h1>
                        <p style="font-size:18px;margin:0;opacity:0.9;">Set your trip start and end dates to see your daily view</p>
                    </div>
                `;
            }

            h += `</div>`; // Close today tab
            
            // Continue with rest of render (currency converter listeners, search listeners, etc.)
    
            app.innerHTML = h;
            
            // Set up currency converter listeners (NO RENDER on input)
            const usdInput = document.getElementById('usdInput');
            if(usdInput) {
                usdInput.addEventListener('input', (e) => {
                    DATA.converterUSD = parseFloat(e.target.value) || 0;
                    DATA.converterYEN = DATA.converterUSD * DATA.rate;
                    const yenInput = document.getElementById('yenInput');
                    if(yenInput) yenInput.value = DATA.converterYEN.toFixed(0);
                    saveToStorage();
                });
            }
            
            const yenInput = document.getElementById('yenInput');
            if(yenInput) {
                yenInput.addEventListener('input', (e) => {
                    DATA.converterYEN = parseFloat(e.target.value) || 0;
                    DATA.converterUSD = DATA.converterYEN / DATA.rate;
                    const usdInput = document.getElementById('usdInput');
                    if(usdInput) usdInput.value = DATA.converterUSD.toFixed(2);
                    saveToStorage();
                });
            }
            
            // Set up search input listener
            const searchInput = document.getElementById('searchInput');
            if(searchInput) {
                const performSearch = (query) => {
                    if (!query || query.trim().length === 0) {
                        DATA.showSearchResults = false;
                        DATA.searchResults = [];
                        render();
                        return;
                    }
                    
                    const searchLower = query.toLowerCase().trim();
                    const results = [];
                    
                    DATA.days.forEach((day, idx) => {
                        const matches = [];
                        
                        if (day.loc.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Location', value: day.loc });
                        }
                        if (day.dt.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Date', value: day.dt });
                        }
                        if (day.acc.n.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Accommodation', value: day.acc.n });
                        }
                        if (day.trn.d.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Transportation', value: day.trn.d });
                        }
                        if (day.food.d.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Food', value: day.food.d });
                        }
                        if (day.act.d.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Activities', value: day.act.d });
                        }
                        if (day.note.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Note', value: day.note });
                        }
                        if (day.journalNote && day.journalNote.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Journal', value: day.journalNote.substring(0, 100) });
                        }
                        
                        if (matches.length > 0) {
                            results.push({ dayIndex: idx, day: day, matches: matches });
                        }
                    });
                    
                    DATA.searchResults = results;
                    DATA.showSearchResults = query.length > 0;
                    render();
                };
                
                // Enter-based search
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && DATA.searchMode === 'enter') {
                        performSearch(e.target.value);
                    }
                });
                
                // Input listener for both modes
                searchInput.addEventListener('input', (e) => {
                    DATA.searchQuery = e.target.value;
                    
                    // Auto mode with debounce
                    if (DATA.searchMode === 'auto') {
                        clearTimeout(window.searchTimer);
                        if (!e.target.value || e.target.value.trim().length === 0) {
                            DATA.showSearchResults = false;
                            DATA.searchResults = [];
                            render();
                        } else {
                            window.searchTimer = setTimeout(() => {
                                performSearch(e.target.value);
                            }, 400);
                        }
                    } 
                    // Enter mode - only clear when empty
                    else if (!e.target.value || e.target.value.trim().length === 0) {
                        DATA.showSearchResults = false;
                        DATA.searchResults = [];
                        render();
                    }
                });
            }
        };
        
        loadFromStorage();

        if (DATA.liveRate) {
            fetchLiveRate();
        } else {
            render();
        }

        // Always init map if it's open AND we're on planning tab
        if (DATA.showMap && DATA.activeTab === 'planning') {
            setTimeout(() => {
                const mapElement = document.getElementById('tripMap');
                if (mapElement) {
                    console.log(' Initializing map on page load');
                    initMap();
                }
            }, 100);
        }
        
        document.addEventListener('click', (e) => {
            if (DATA.showSearchResults && !e.target.closest('.search-bar')) {
                DATA.showSearchResults = false;
                render();
            }
        });
        </script>

        <!-- PWA Service Worker Registration - ADD BEFORE </body> -->
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(reg => console.log(' Service Worker registered:', reg.scope))
                        .catch(err => console.log(' Service Worker registration failed:', err));
                });
            }
        </script>
        
    </body>
</html>
                
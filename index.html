<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Trip Budget">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Trip Budget & Itinerary Planner</title>
    <!-- Prevent white flash: apply dark mode class BEFORE any CSS or rendering -->
    <script>
        (function() {
            try {
                var stored = localStorage.getItem('tripPlannerData');
                if (stored) {
                    var data = JSON.parse(stored);
                    if (data && data.darkMode) {
                        document.documentElement.classList.add('dark-mode-pending');
                        document.documentElement.style.background = '#0f172a';
                        document.documentElement.style.colorScheme = 'dark';
                    }
                }
            } catch(e) {}
        })();
    </script>

 
    <style>
        :root {
            /* Animation speeds */
            --transition-speed: 0.3s;
            
            /* Card styles */
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --card-hover-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            --card-radius: 12px;
            
            /* Density */
            --spacing-card: 24px;
            --spacing-section: 20px;
        }

        /* Fast animations */
        body.animation-fast {
            --transition-speed: 0.15s;
        }

        /* Slow animations */
        body.animation-slow {
            --transition-speed: 0.5s;
        }

        /* Classic card style */
        body.card-classic .day-card,
        body.card-classic .stat-card,
        body.card-classic .analytics-card {
            --card-shadow: none;
            --card-hover-shadow: none;
            border: 1px solid #e0e0e0 !important;
            box-shadow: none !important;
        }

        body.card-classic .day-card:hover,
        body.card-classic .analytics-card:hover {
            box-shadow: none !important;
            transform: none !important;
            border-color: #000 !important;
        }

        /* Compact density */
        body.density-compact {
            --spacing-card: 16px;
            --spacing-section: 12px;
        }

        body.density-compact .day-card,
        body.density-compact .stat-card,
        body.density-compact .analytics-card {
            padding: 16px !important;
        }

        body.density-compact .stats {
            gap: 12px !important;
        }

        /* Spacious density */
        body.density-spacious {
            --spacing-card: 32px;
            --spacing-section: 32px;
        }

        body.density-spacious .day-card,
        body.density-spacious .stat-card,
        body.density-spacious .analytics-card {
            padding: 32px !important;
        }

        body.density-spacious .stats {
            gap: 24px !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* ========================================== */
        /* UTILITY CLASSES - Reusable Components */
        /* ========================================== */
        
        /* Card Styles */
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 3px solid #000;
        }
        
        .card-bold {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 3px solid #000;
        }
        
        .card-green {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 3px solid #22c55e;
        }
        
        .card-blue {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 3px solid #000;
        }
        
        /* Flex Layouts */
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flex-row {
            display: flex;
            gap: 10px;
        }
        
        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Text Styles */
        .label-sm {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .label-xs {
            font-size: 12px;
            color: #666;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 900;
            color: #000;
        }
        
        .subsection-title {
            font-size: 18px;
            font-weight: 700;
            color: #000;
        }
        
        /* Grid Layouts */
        .grid-auto {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        /* Button Row */
        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* ========================================== */
        
        /* App Shell Layout */
        .app-shell {
            display: flex;
            min-height: 100vh;
            background: #fafafa;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: #fff;
            border-right: 2px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar.collapsed {
            width: 70px;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 80px;
        }
        
        .sidebar.collapsed .sidebar-header {
            justify-content: center; /* Center button when collapsed */
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar.collapsed .sidebar-logo {
            display: none; /* Hide logo when collapsed */
        }
        
        .sidebar-logo-icon {
            font-size: 28px;
            min-width: 28px;
        }
        
        .sidebar-logo-text {
            font-size: 20px;
            font-weight: 700;
            color: #000;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .sidebar.collapsed .sidebar-logo-text {
            display: none;
        }
        
        .sidebar-toggle {
            background: #f5f5f5;
            border: none;
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        
        .sidebar-toggle:hover {
            background: #e5e5e5;
        }
        
        .sidebar.collapsed .sidebar-toggle {
            margin: 0 auto;
            width: 40px;
            height: 40px;
        }
        
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
            font-weight: 600;
            font-size: 15px;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }
        
        .nav-item:hover {
            background: #f5f5f5;
            color: #000;
        }
        
        .nav-item.active {
            background: #0d9488 !important;
            color: white !important;
            background: #000;
            color: #fff;
        }
        
        .nav-item-icon {
            font-size: 20px;
            min-width: 20px;
        }
        
        .nav-item-text {
            white-space: nowrap;
            overflow: hidden;
        }
        
        .sidebar.collapsed .nav-item-text {
            display: none;
        }
        
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 14px 8px;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .content-header {
            background: #fff;
            border-bottom: 2px solid #e5e7eb;
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 80px;
            position: sticky;
            top: 0;
            z-index: 50;
            transition: all 0.3s ease;
        }
        
        .content-header.scrolled {
            padding: 12px 32px;
            min-height: 60px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .content-header.scrolled h1 {
            font-size: 20px;
        }
        
        .content-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #000;
        }
        
        .content-body {
            padding: 24px 24px; /* Reduced from 80px to 24px for minimal padding */
        }
        
        .content-body > .tab-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .days-container {
            /* No extra padding - content fills naturally */
            padding: 0;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }
        
        .welcome-icon {
            font-size: 72px;
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        .welcome-title {
            font-size: 32px;
            font-weight: 800;
            color: #000;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 32px;
            max-width: 500px;
            line-height: 1.5;
        }
        
        .welcome-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .welcome-btn {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .welcome-btn-primary {
            background: #000;
            color: #fff;
            border: 3px solid #000;
        }
        
        .welcome-btn-primary:hover {
            background: #333;
            transform: translateY(-2px);
        }
        
        .welcome-btn-secondary {
            background: #fff;
            color: #000;
            border: 3px solid #000;
        }
        
        .welcome-btn-secondary:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }
        
        /* Base grid layouts for desktop */
        .hero-stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .quick-actions-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        
        .checklist-quickjump-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .day-cards-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .day-cards-grid > * {
            min-width: 0;
        }
        
        /* ========================================== */
        /* MOBILE STYLES - PRIMARY LAYOUT */
        /* Sidebar, tab bar, main layout, navigation */
        /* Lines 467-936 */
        /*
        NOTE: Multiple @media (max-width: 768px) blocks exist intentionally
        for organizational purposes:
        - Block 1 (Lines 467-936): Core layout & navigation
        - Block 2 (Lines 4675-6002): Extended components & overrides
        This separation helps maintain readability in a large codebase.
        They could be consolidated into one block, but the current structure
        makes it easier to find and modify specific mobile styles.
        */
        /* ========================================== */
        /* Mobile Bottom Tab Bar Navigation */
        @media (max-width: 768px) {
            /* Hide desktop sidebar on mobile */
            .sidebar {
                display: none !important;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
            
            /* Mobile bottom tab bar */
            .mobile-tab-bar {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: white;
                border-top: 2px solid #e5e7eb;
                z-index: 100;
                justify-content: space-around;
                align-items: center;
                padding: 0 8px;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }
            
            .mobile-tab-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                flex: 1;
                height: 100%;
                border: none;
                background: none;
                color: #666;
                font-size: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                padding: 4px;
                gap: 2px;
            }
            
            .mobile-tab-btn.active {
                color: #000;
            }
            
            .mobile-tab-icon {
                font-size: 22px;
            }
            
            .mobile-tab-btn.active .mobile-tab-icon {
                transform: scale(1.1);
            }
            
            /* Adjust content to account for bottom bar */
            .main-content {
                padding-bottom: 60px;
            }
            
            .content-body {
                padding-bottom: 80px;  /* Space for 60px tab bar + 20px margin */
            }
            
            /* Hide content-header when fullscreen modals are open */
            body:has(.settings-overlay) .content-header {
                display: none !important;
            }
            
            /* Hide header and tabs when day detail modal is open on mobile */
            body:has(.day-detail-modal) .content-header {
                display: none !important;
            }
            
            body:has(.day-detail-modal) .mobile-tab-bar {
                display: none !important;
            }
            
            /* MOBILE DAY CATEGORY CARDS - 2x2, Icon only, compact */
            .category-card-grid {
                gap: 8px !important;
            }
            
            .category-card, .notes-card {
                padding: 10px 6px !important;
                min-height: 70px !important;
            }
            
            .category-card-title {
                display: none !important;
            }
            
            .category-card-icon {
                font-size: 26px !important;
                width: 38px !important;
                height: 38px !important;
                margin: 0 auto 4px auto !important;
            }
            
            .category-card-header {
                justify-content: center !important;
                flex-direction: column !important;
            }
            
            .category-card-content {
                font-size: 10px !important;
                text-align: center !important;
                line-height: 1.3 !important;
            }
            
            /* Analytics cards - smaller */
            .analytics-card {
                padding: 12px 8px !important;
            }
            
            .analytics-card-icon {
                font-size: 28px !important;
            }
            
            .analytics-card-title {
                font-size: 12px !important;
                line-height: 1.2 !important;
            }
            
            /* On-trip checklist - smaller */
            button.analytics-card[onclick*="showChecklistPage='trip'"] {
                padding: 10px 8px !important;
                min-height: 100px !important;
                max-height: 120px !important;
            }
            
            button.analytics-card[onclick*="showChecklistPage='trip'"] .analytics-card-icon {
                font-size: 24px !important;
                margin-bottom: 4px !important;
            }
            
            button.analytics-card[onclick*="showChecklistPage='trip'"] .analytics-card-title {
                font-size: 12px !important;
                margin-bottom: 4px !important;
            }
            
            button.analytics-card[onclick*="showChecklistPage='trip'"] .analytics-card-desc {
                font-size: 9px !important;
                margin-bottom: 4px !important;
            }
            
            button.analytics-card[onclick*="showChecklistPage='trip'"] div[style*="padding:12px"] {
                padding: 6px !important;
                font-size: 10px !important;
            }
            
            /* Prep cards - prevent overflow */
            button.prep-card {
                padding: 10px 6px !important;
                min-height: 120px !important;
                overflow: hidden !important;
            }
            
            button.prep-card span[style*="font-size:36px"] {
                font-size: 20px !important;
            }
            
            button.prep-card span[style*="font-size:17px"] {
                font-size: 11px !important;
                line-height: 1.1 !important;
            }
            
            button.prep-card .packing-card-progress,
            button.prep-card .before-card-progress {
                font-size: 9px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
            }
            
            button.prep-card div[style*="padding:12px"] {
                padding: 4px 2px !important;
            }
            
            button.prep-card .analytics-card-desc {
                font-size: 9px !important;
            }
            
            /* Hide Add Day button in mobile list view */
            .mobile-hide-add-day {
                display: none !important;
            }
            
            /* Day detail modal - force 2x2 grid on mobile */
            .day-detail-modal [style*="grid-template-columns:repeat(auto-fit,minmax(280px,1fr))"] {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .day-detail-modal [style*="grid-template-columns:repeat(auto-fit,minmax(280px,1fr))"] > div {
                padding: 12px !important;
                font-size: 12px !important;
            }
            
            .day-detail-modal [style*="grid-template-columns:repeat(auto-fit,minmax(280px,1fr))"] h3 {
                font-size: 13px !important;
            }
            
            /* Trip overview - better mobile layout */
            div[style*="Trip Overview"] {
                padding: 15px !important;
            }
            
            div[style*="Trip Overview"] h2 {
                font-size: 16px !important;
                margin-bottom: 12px !important;
            }
            
            div[style*="Trip Overview"] > div > div {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 6px !important;
                padding: 12px !important;
            }
            
            div[style*="Trip Overview"] span[style*="color:#666"] {
                font-size: 11px !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
                color: #999 !important;
            }
            
            div[style*="Trip Overview"] span[style*="font-weight:700"] {
                font-size: 14px !important;
                color: #000 !important;
                font-weight: 800 !important;
            }
            
            /* Daily schedule - time smaller, details prominent */
            .schedule-hour {
                grid-template-columns: 60px 1fr auto !important;
                gap: 8px !important;
                padding: 10px !important;
            }
            
            .schedule-hour input[type="time"] {
                font-size: 11px !important;
                padding: 6px !important;
            }
            
            .schedule-hour input[type="text"] {
                font-size: 13px !important;
                padding: 8px !important;
            }
            
            /* Timeline - make more compact on mobile */
            .timeline-date {
                font-size: 11px !important;
            }
            
            .timeline-location {
                font-size: 13px !important;
                font-weight: 600 !important;
            }
            
            /* Hide Add Day button on mobile in calendar/list view */
            .calendar-add-day-btn {
                display: none !important;
            }
            
            /* Back to top button for mobile */
            .scroll-to-top {
                display: flex !important;
                position: fixed !important;
                bottom: 70px !important;
                right: 15px !important;
                width: 50px !important;
                height: 50px !important;
                border-radius: 50% !important;
                background: #0d9488 !important;
                color: white !important;
                border: none !important;
                font-size: 24px !important;
                cursor: pointer !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
                z-index: 90 !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            /* Center wrapped text in cards and buttons */
            .analytics-card-title,
            .prep-card span,
            button span {
                text-align: center !important;
            }
            
            /* Currency converter - stack on mobile */
            div[style*="grid-template-columns:1fr auto 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            div[style*="grid-template-columns:1fr auto 1fr"] button {
                margin: 0 auto;
            }
            
            /* Currency input fields - prevent overflow */
            #settingsUsdInput,
            #settingsYenInput {
                max-width: 100% !important;
                font-size: 20px !important;
            }
            
            /* ========================================== */
            /* Mobile Spacing - Fixed */
            /* ========================================== */
            
            /* Remove horizontal padding from days-container on mobile */
            .days-container {
                padding: 0 12px !important;  /* Match content-body side padding */
            }
            
            /* REMOVED - These were causing grey space at top:
            
            /* Mobile menu button - hide it */
            .mobile-menu-btn {
                display: none !important;
            }
            
            /* Adjust header for mobile */
            .content-header {
                padding: 10px 12px;
            }
            
            /* Hide hamburger menu - we have bottom tabs now */
            .content-header .mobile-menu-btn {
                display: none !important;
            }
            
            /* Move Add Day button up from bottom */
            .content-header .btn {
                margin-bottom: 0;
            }
            
            /* FAB positioning for mobile */
            .fab {
                bottom: 80px !important; /* Above bottom tab bar */
            }
            
            /* Make graphics more square on mobile */
            .day-card {
                margin-bottom: 6px;  /* Reduced from 8px */
                border-radius: 8px;
            }
            
            .day-header {
                padding: 8px;        /* Reduced from 10px */
            }
            
            .day-num {
                width: 22px;         /* Reduced from 24px */
                height: 22px;
                font-size: 11px;     /* Reduced from 12px */
            }
            
            .day-title h3 {
                font-size: 14px !important;  /* Reduced */
            }
            
            .day-title .date {
                font-size: 11px !important;  /* Reduced */
            }
            
            .day-cost .amount {
                font-size: 13px !important;  /* Reduced */
            }
            
            .day-cost .usd {
                font-size: 10px !important;  /* Reduced */
            }
            
            /* Compact expanded day content on mobile */
            .day-card-wrapper .details {
                padding: 10px !important;    /* Reduced from 12px */
            }
            
            .day-card .category-card,
            .day-card .notes-card {
                padding: 10px !important;    /* Even more compact */
                min-height: 90px !important; /* Reduced from 120px */
            }
            
            .day-card-wrapper .category-card-icon {
                font-size: 16px !important;
                width: 26px !important;
                height: 26px !important;
            }
            
            .day-card-wrapper .category-card-title {
                font-size: 12px !important;
            }
            
            .day-card-wrapper .category-card-content {
                font-size: 11px !important;
                height: 32px !important;
            }
            
            /* Calendar modal activity details - force 2x2 grid on mobile */
            .day-detail-modal div[style*="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))"] {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .day-detail-modal div[style*="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))"] > div {
                padding: 10px !important;
                overflow: hidden !important;
            }
            
            .day-detail-modal div[style*="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))"] > div > div:nth-child(1) {
                font-size: 20px !important;  /* Icon size */
                margin-bottom: 4px !important;
            }
            
            .day-detail-modal div[style*="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))"] > div > div:nth-child(2) {
                font-size: 10px !important;  /* Category name */
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .day-detail-modal div[style*="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))"] > div > div:nth-child(3) {
                font-size: 11px !important;  /* Activity name */
                overflow: hidden !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
                word-wrap: break-word !important;
                max-width: 100% !important;
                line-height: 1.3 !important;
                max-height: 28px !important;  /* 2 lines at 14px line-height */
            }
            
            .day-detail-modal div[style*="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))"] > div > div:nth-child(4) {
                font-size: 12px !important;  /* Cost */
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* Hero stat cards - compact */
            .stats > div {
                padding: 14px;
            }
            
            /* Calendar cells - scale down but keep ratio */
            .tab-content [style*="grid-auto-rows"] {
                grid-auto-rows: 85px !important;
            }
            
            /* Calendar text smaller */
            .content-body [style*="grid-template-columns:repeat(7"] > div {
                font-size: 11px !important;
            }
            
            .content-body [style*="grid-template-columns:repeat(7"] > div > div:first-child {
                font-size: 16px !important;
            }
            
            /* Welcome icon smaller */
            .welcome-icon {
                font-size: 40px;
            }
        }
        
        /* DESKTOP CALENDAR - Card pop on hover without shifting grid */
        @media (min-width: 769px) {
            /* Calendar cells expand on hover */
            #calendarGrid > div[style*="height:90px"] {
                transition: all 0.3s ease;
            }
            
            #calendarGrid > div[style*="height:90px"]:hover {
                transform: scale(1.03);  /* Subtle pop - no page shift */
                z-index: 10;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }
        }
        
        /* Hide mobile tab bar on desktop */
        .mobile-tab-bar {
            display: none;
        }
        
        /* Mobile More Menu */
        .mobile-more-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            animation: fadeIn 0.2s;
        }
        
        .mobile-more-menu {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            animation: slideUp 0.3s ease-out;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .mobile-more-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .mobile-more-content {
            padding: 10px;
        }
        
        .mobile-more-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border: 3px solid #000;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .mobile-more-item:hover {
            background: #f9fafb;
            border-color: #000;
        }
        
        .mobile-more-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 12px;
            flex-shrink: 0;
        }
        
        .mobile-more-text {
            flex: 1;
        }
        
        .mobile-more-title {
            font-size: 16px;
            font-weight: 700;
            color: #111;
            margin-bottom: 4px;
        }
        
        .mobile-more-desc {
            font-size: 13px;
            color: #666;
        }
        
        /* Mobile Responsive - COMPLETE FIX */
        @media (max-width: 768px) {
            * {
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Hide mobile header and bottom tabs when fullscreen modals are open */
            body:has(.settings-overlay) .mobile-header,
            body:has(.settings-overlay) .mobile-tab-bar,
            body:has(.day-detail-modal) .content-header,
            body:has(.day-detail-modal) .mobile-tab-bar {
                display: none !important;
            }
            
            /* Make fullscreen modals truly fullscreen on mobile */
            .settings-overlay + div[style*="position:fixed"][style*="z-index:2001"] {
                top: 0 !important;
                bottom: 0 !important;
            }
            
            /* Hide Add Day button in calendar view on mobile (already in header) */
            .calendar-add-day-btn {
                display: none !important;
            }
            
            html, body {
                /* FIXED: Allow scrolling on mobile! */
                overflow: auto;
                height: 100%;
                width: 100%;
                position: relative;
                margin: 0;
                padding: 0;
            }
            
            .app-shell {
                min-height: 100vh;
                min-height: 100dvh;
                overflow: visible;
                display: flex;
                flex-direction: column;
            }
            
            /* CRITICAL FIX: Remove body padding on mobile */
            body {
                padding: 0 !important;
            }
            
            /* Sidebar - Fixed overlay */
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                width: 70vw !important;
                max-width: 280px;
                height: 100vh;
                height: 100dvh;
                z-index: 1001;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 4px 0 12px rgba(0,0,0,0.3);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .sidebar-header {
                padding: 12px;
                border-bottom: 2px solid #e5e7eb;
            }
            
            .sidebar-logo {
                gap: 8px;
            }
            
            .sidebar-logo-icon {
                font-size: 20px;
                width: 32px;
                height: 32px;
            }
            
            .sidebar-logo-text {
                font-size: 15px;
            }
            
            .sidebar-toggle {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }
            
            .nav-item {
                padding: 10px 12px;
                font-size: 14px;
                min-height: 44px; /* Touch target */
            }
            
            .nav-item-icon {
                font-size: 18px;
                width: 24px;
            }
            
            .nav-item-text {
                font-size: 14px;
            }
            
            /* Main content */
            .main-content {
                flex: 1;
                width: 100%;
                display: flex;
                flex-direction: column;
                overflow: visible;
            }
            
            /* Header */
            .content-header {
                padding: 8px 12px;
                min-height: 48px;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .content-header h1 {
                font-size: 15px;
                flex: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .content-header > div {
                display: flex;
                gap: 4px;
                flex-shrink: 0;
            }
            
            .content-header .btn,
            .content-header .btn-secondary {
                padding: 5px 8px;
                font-size: 11px;
                min-height: 28px;
                white-space: nowrap;
            }
            
            .mobile-menu-btn {
                display: flex !important;
                width: 32px;
                height: 32px;
                font-size: 16px;
                flex-shrink: 0;
            }
            
            /* Route Editor Mobile - Make it fit on small screens */
            #routeEditorContent > div[style*="grid-template-columns"] {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            /* Route editor location cards: constrain to screen width */
            #routeEditorContent > div[style*="grid-template-columns"] > div {
                min-width: 0 !important;
                overflow: hidden !important;
            }
            
            #routeEditorContent .btn-secondary,
            #routeEditorContent button {
                padding: 5px 8px !important;
                font-size: 11px !important;
                white-space: nowrap !important;
            }
            
            /* Route editor header buttons: 2x2 grid */
            .route-editor-btns {
                grid-template-columns: 1fr 1fr !important;
                width: 100% !important;
            }
            
            /* Route editor location cards on mobile */
            div[style*="border:2px solid #0d9488"][style*="background:#f0fdfa"] {
                padding: 10px !important;
            }
            
            div[style*="border:2px solid #0d9488"] input[type="text"],
            div[style*="border:2px solid #0d9488"] input[type="number"] {
                font-size: 11px !important;
                padding: 4px !important;
            }
            
            /* Content body - CRITICAL */
            .content-body {
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                padding: 0; /* Removed padding - tabs have their own spacing */
                margin-top: 0 !important; /* No top margin */
            }
            
            /* Reset days-container padding on mobile */
            .days-container {
                padding: 0 !important;
                margin-top: 0 !important; /* No top margin */
            }
            
            /* Tab content */
            .tab-content {
                width: 100%;
                max-width: 100%;
                display: none !important;
                padding: 20px 12px 12px 12px; /* 20px top for breathing room, 12px sides/bottom */
                background: white; /* Add white background to prevent grey showing through */
                margin-top: 0 !important; /* Explicitly no top margin */
                height: auto !important; /* Override desktop height: 100% - let content determine height */
                overflow-y: visible !important; /* Override desktop overflow */
            }
            
            .tab-content.active {
                display: block !important;
            }
            
            /* Welcome */
            .welcome-screen {
                padding: 16px;
            }
            
            .welcome-icon {
                font-size: 48px;
                margin-bottom: 12px;
            }
            
            .welcome-title {
                font-size: 22px;
                margin-bottom: 8px;
            }
            
            .welcome-subtitle {
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            .welcome-btn {
                padding: 10px 20px;
                font-size: 14px;
                width: 100%;
                max-width: 300px;
            }
            
            /* Stats */
            .stats {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            /* Day cards - 70% of desktop size */
            .day-card {
                margin-bottom: 4px;  /* Reduced from 6px */
                border-radius: 6px;
            }
            
            .day-header {
                padding: 8px 10px !important;
            }
            
            .day-info {
                gap: 8px !important;
            }
            
            .day-check {
                width: 14px;
                height: 14px;
            }
            
            .day-num {
                width: 24px !important;
                height: 24px !important;
                font-size: 10px !important;
                border-radius: 5px;
            }
            
            .day-title h3 {
                font-size: 10px !important;
                font-weight: 600 !important;
            }
            
            .day-title .date {
                font-size: 8px !important;
            }
            
            .day-cost .amount {
                font-size: 10px !important;
            }
            
            .day-cost .usd {
                font-size: 7px !important;
            }
            
            /* Compact expanded details for mobile */
            .day-card-wrapper .details {
                padding: 8px !important;
            }
            
            .day-card .section {
                margin-top: 8px !important;
                padding: 8px !important;
            }
            
            .day-card .section h4 {
                font-size: 10px !important;
                margin-bottom: 4px !important;
            }
            
            .day-card .section-content {
                font-size: 10px !important;
                line-height: 1.4 !important;
            }
            
            .day-card .section-cost {
                font-size: 10px !important;
                margin-top: 3px !important;
            }
            
            .category-grid {
                gap: 4px !important;
            }
            
            .category-item {
                padding: 6px !important;
                font-size: 9px !important;
            }
            
            .day-card textarea {
                min-height: 50px !important;
                font-size: 10px !important;
                padding: 6px !important;
            }
            
            .day-card input[type="text"],
            .day-card input[type="number"],
            .day-card input[type="time"] {
                font-size: 10px !important;
                padding: 5px !important;
            }
            
            .day-activity-card {
                padding: 8px !important;
                min-height: 50px !important;
            }
            
            .day-card-icon {
                font-size: 20px !important;
            }
            
            .day-card-title {
                font-size: 11px !important;
            }
            
            .day-card-badge {
                font-size: 9px !important;
            }
            
            /* MOBILE - Force 2x2 grid for all large card layouts */
            [style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }
            
            /* Make 3rd card in home hero stats span full width (Locations card) */
            .tab-content.active > div:first-child[style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] > div:nth-child(3) {
                grid-column: 1 / -1 !important;  /* Span both columns */
            }
            
            /* Scale down cards in 2x2 grid to prevent overflow */
            [style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] > * {
                min-width: 0 !important;
                overflow: hidden !important;
            }
            
            /* Budget cards - specific fixes */
            [style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] > div[style*="padding:24px"] {
                padding: 12px 8px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            /* Big numbers in budget cards - smaller and truly centered */
            [style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] div[style*="font-size:36px"] {
                font-size: 22px !important;
                text-align: center !important;
                word-break: break-word !important;
                width: 100% !important;
            }
            
            /* Labels in budget cards */
            [style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] div[style*="font-size:12px"][style*="text-transform:uppercase"] {
                font-size: 9px !important;
                text-align: center !important;
                width: 100% !important;
            }
            
            /* Secondary text */
            [style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] div[style*="font-size:13px"] {
                font-size: 10px !important;
                text-align: center !important;
                width: 100% !important;
            }
            
            /* Analytics cards - add black borders on mobile */
            .analytics-card {
                border: 3px solid #000 !important;
                aspect-ratio: 1 / 1 !important;  /* Force square */
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
            }
            
            /* Prep cards (packing/before trip) - AGGRESSIVE mobile overrides */
            button.prep-card[style*="padding:24px"] {
                padding: 10px 8px !important;
                min-height: 120px !important;
            }
            
            button.prep-card span[style*="font-size:36px"] {
                font-size: 22px !important;
            }
            
            button.prep-card span[style*="font-size:17px"] {
                font-size: 12px !important;
                line-height: 1.1 !important;
            }
            
            /* Progress numbers - FORCE smaller */
            button.prep-card .packing-card-progress,
            button.prep-card .before-card-progress {
                font-size: 13px !important;
            }
            
            /* Progress label - FORCE smaller */
            button.prep-card div[style*="padding:12px"] > div[style*="font-size:12px"]:first-child {
                font-size: 8px !important;
                margin-bottom: 3px !important;
            }
            
            button.prep-card .analytics-card-desc {
                font-size: 9px !important;
                margin-bottom: 6px !important;
            }
            
            /* Progress container - FORCE smaller padding */
            button.prep-card div[style*="padding:12px"][style*="background:#fafafa"],
            button.prep-card div[style*="padding:12px"][style*="background:#fafafa"] {
                padding: 6px 4px !important;
            }
            
            /* MOBILE CALENDAR - NUCLEAR OVERRIDE */
            /* Force grid to use 45px rows */
            #calendarGrid {
                grid-auto-rows: 45px !important;
                grid-template-rows: repeat(auto-fill, 45px) !important;
                gap: 1px !important;
                column-gap: 1px !important;
                row-gap: 1px !important;
            }
            
            div[style*="grid-auto-rows:110px"] {
                grid-auto-rows: 45px !important;
                grid-template-rows: repeat(auto-fill, 45px) !important;
                gap: 1px !important;
                column-gap: 1px !important;
                row-gap: 1px !important;
            }
            
            /* Mobile calendar cells - hide all text, just show day number */
            .calendar-cell-location,
            .calendar-cell-cost {
                display: none !important;
            }
            
            /* Force ALL calendar cells and empty cells to exact 45px */
            div[style*="grid-auto-rows:110px"] > div,
            #calendarGrid > div {
                height: 45px !important;
                min-height: 45px !important;
                max-height: 45px !important;
                padding: 2px !important;
                margin: 0 !important;
                box-sizing: border-box !important;
            }
            
            /* Date number positioning - top right corner */
            div[style*="grid-auto-rows:110px"] div[style*="justify-content:space-between"]:first-child {
                position: relative;
                height: 100%;
            }
            
            /* Day number (D1, D2) - left side */
            div[style*="grid-auto-rows:110px"] div[style*="justify-content:space-between"] > div:first-child {
                font-size: 14px !important;
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
            }
            
            /* Date number (15, 28) - top right corner with grey background */
            div[style*="grid-auto-rows:110px"] div[style*="justify-content:space-between"] > div:last-child {
                font-size: 8px !important;
                position: absolute !important;
                top: 1px !important;
                right: 1px !important;
                background: rgba(0,0,0,0.08) !important;
                padding: 2px 3px !important;
                border-radius: 3px !important;
                font-weight: 700 !important;
                color: #666 !important;
                line-height: 1 !important;
            }
            
            /* Remove expansion on mobile */
            .calendar-cell.expanded {
                height: 45px !important;
                padding: 2px !important;
                transform: none !important;
                box-shadow: none !important;
            }
            
            /* Hide calendar add day button on mobile */
            .calendar-add-day-btn {
                display: none !important;
            }
            
            /* Hide mobile header and tabs when full-page modals are open */
            body:has(.settings-overlay) .mobile-header,
            body:has(.settings-overlay) .mobile-tab-bar {
                display: none !important;
            }
            
            /* Make full-page modals truly full screen on mobile */
            .settings-overlay + div[style*="position:fixed"][style*="z-index:2001"] {
                top: 0 !important;
                bottom: 0 !important;
            }
            
            }
            /* Modals */
            .custom-modal {
                width: 90vw;
                min-width: 90vw;
                max-width: 90vw;
            }
            
            .day-detail-content {
                width: 95vw;
                max-width: 95vw;
                max-height: 90vh;
            }
            
            .settings-page,
            .export-page {
                width: 100vw !important;
                max-width: 100vw !important;
            }
            
            .analytics-page {
                width: 95vw !important;
                max-width: 95vw;
            }
            
            /* Search */
            .search-bar {
                padding: 8px;
            }
            
            .search-input {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            /* Buttons */
            .btn, .btn-secondary {
                min-height: 44px; /* Touch target */
            }
        }
        
        /* Sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .sidebar-overlay {
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
        }
        
        /* Mobile overlay for sidebar */
        @media (max-width: 768px) {
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
        }
        
        .mobile-menu-btn {
            display: none;
            background: #f5f5f5;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }
        
        .mobile-menu-btn:hover {
            background: #e5e5e5;
        }
        
        /* Hide old container padding when using app shell */
        body.app-mode {
            padding: 0;
            /* overflow: hidden; REMOVED - was blocking all scrolling! */
        }
        
        body.app-mode .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        /* Add to your root styles - SIMPLE: LET WINDOW SCROLL */
        html, body {
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: #fafafa;
            color: #1f2937;
            line-height: 1.6;
            font-size: 15px;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px; /* Tighter */
            line-height: 1.2;
        }
        h2 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.3px;
            line-height: 1.3;
        }
        h3 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.2px;
            line-height: 1.4;
        }
        /* Small caps for labels */
        .stat-label,
        .section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px; /* Wider spacing */
            font-weight: 700; /* Bolder */
            color: #6b7280;
        }        
        .container { max-width: 900px; margin: 0 auto; }
        
        :root {
            /* Primary Colors */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #0d9488;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            
            /* Gray Scale */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
            
            /* Success */
            --success-50: #f0fdf4;
            --success-500: #10b981;
            --success-600: #059669;
            
            /* Error */
            --error-50: #fef2f2;
            --error-500: #ef4444;
            --error-600: #dc2626;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        .header { 
            background: #ffffff;
            padding: 40px; 
            margin-bottom: 30px; 
            border-radius: 16px; 
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border-left: 6px solid #000;
            position: relative;
        }
        .header h1 { 
            font-size: 32px; 
            font-weight: 700; 
            margin-bottom: 8px; 
            color: #000;
            position: relative;
            letter-spacing: -0.5px;
        }
        .header .subtitle { 
            color: #666; 
            font-size: 16px;
            position: relative;
        }
        .header-title-edit { 
            border: 3px solid #000; 
            border-radius: 8px; 
            padding: 12px 16px; 
            font-size: 32px; 
            font-weight: 700; 
            width: 100%;
            background: white;
            color: #000;
        }
        .header-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; position: relative; }
        .header-btn {
            background: #000;
            color: white;
            border: 3px solid #000;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }       
        .header-btn:hover {
            background: #333;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .header-btn.danger { 
            background: #ef4444;
            border-color: #ef4444;
        }
        .header-btn.danger:hover { 
            background: #dc2626;
            border-color: #dc2626;
        }

        .currency-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .currency-selector label { font-size: 14px; font-weight: 600; color: #374151; }
        .currency-selector select { padding: 8px 12px; border: 3px solid #cbd5e1; border-radius: 4px; font-size: 14px; background: white; cursor: pointer; }
        .currency-selector select:focus { outline: none; border-color: #000; }
        .rate-toggle { display: flex; align-items: center; gap: 8px; }
        .rate-toggle-label { font-size: 13px; color: #666; }

        .day-card-controls { display: flex; gap: 5px; margin-top: 5px; padding-top: 5px; border-top: 1px solid #f0f0f0; flex-wrap: wrap; }
        .day-control-btn { background: #f3f4f6; color: #374151; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500; transition: all var(--transition-speed); }
        .day-control-btn:hover { background: #e5e7eb; }
        .day-control-btn.danger { background: #fee2e2; color: #dc2626; }
        .day-control-btn.danger:hover { background: #fecaca; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { 
            background: white; 
            padding: 24px; 
            border-radius: 12px; 
            border: 3px solid #000;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            border-color: #000;
        }
        .stat-card.blue { 
            border-left: 4px solid #0d9488;
        }
        .stat-card.red { 
            border-left: 4px solid #ef4444;
        }
        .stat-card.green { 
            border-left: 4px solid #22c55e;
        }
        .stat-label { 
            font-size: 11px; 
            text-transform: uppercase; 
            color: #666; 
            letter-spacing: 0.8px; 
            margin-bottom: 8px; 
            font-weight: 700;
        }
        .stat-value { 
            font-size: 28px; 
            font-weight: 700; 
            color: #000; 
            cursor: pointer; 
            padding: 4px; 
            border-radius: 6px; 
            transition: background 0.2s;
            letter-spacing: -0.5px;
        }
        .stat-value:hover { background: #f5f5f5; }
        .stat-card.green .stat-value { color: #22c55e; }
        .stat-card.red .stat-value { color: #ef4444; }
        .stat-card.blue .stat-value { color: #0d9488; }
        .stat-sub { 
            font-size: 13px; 
            color: #666; 
            margin-top: 6px;
            font-weight: 500;
        }
        .edit-input { width: 100%; max-width: 150px; padding: 4px 8px; border: 3px solid #000; border-radius: 4px; font-size: 24px; font-weight: 600; text-align: center; }
        
        .search-bar { 
            background: white; 
            padding: 15px 20px; 
            border-radius: 12px; 
            border: 3px solid #000;
            margin-bottom: 20px; 
            position: relative;
            transition: all 0.2s ease;
        }
        .search-bar:focus-within {
            border-color: #000;
        }
        .search-input { 
            width: 100%; 
            padding: 12px 15px; 
            border: 3px solid #000; 
            border-radius: 8px; 
            font-size: 15px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .search-input:focus { 
            outline: none; 
            border-color: #000;
        }
        .search-dropdown { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 3px solid #000; 
            border-radius: 8px; 
            margin-top: 5px; 
            max-height: 60vh; 
            overflow-y: auto; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.15); 
            z-index: 100; 
            display: none; 
        }
        .search-dropdown.show { display: block; }
        .search-result-item { 
            padding: 12px 15px; 
            border-bottom: 1px solid #e5e7eb; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .search-result-item:hover { background: #fafafa; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-day { font-weight: 700; color: #000; font-size: 14px; margin-bottom: 4px; }
        .search-result-location { color: #666; font-size: 13px; margin-bottom: 4px; }
        .search-result-match { color: #000; font-size: 12px; font-weight: 600; }
        .search-result-highlight { background: #fef08a; padding: 0 2px; border-radius: 2px; }
        .search-no-results { padding: 20px; text-align: center; color: #666; font-size: 14px; }
        
        .control-bar { background: white; padding: 15px 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .control-bar .rate { font-size: 14px; color: #666; }
        .control-bar .rate-value { font-size: 16px; font-weight: 600; cursor: pointer; padding: 6px 10px; border-radius: 4px; }
        .control-bar .rate-value:hover { background: #f0f0f0; }
        /* Primary Button */
        .btn {
            background: #000;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.3px;
        }
        .btn:hover {
            background: #333;
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        /* Secondary Button */
        .btn-secondary {
            background: white;
            color: #000;
            border: 3px solid #000;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
        }
        .btn-secondary:active {
            transform: translateY(0);
        }
        /* Danger Button */
        .btn-danger {
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .converter { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        
        /* ============================================
           DARK MODE STYLES
           ============================================ */
        /* Prevent white flash on load */
        html.dark-mode-pending,
        html.dark-mode-pending body {
            background: #0f172a !important;
            color: #e2e8f0 !important;
        }
        body {
            background: #ffffff;
            transition: background 0s; /* No transition to prevent flash */
        }
        
        body.dark-mode {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        body.dark-mode .app-shell {
            background: #1e293b;
            border-color: #000;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-bottom-color: #475569;
        }
        
        body.dark-mode .sidebar {
            background: #1e293b;
            border-right-color: #000;
        }
        
        body.dark-mode .main-content {
            background: #0f172a;
        }
        
        body.dark-mode .day-card {
            background: #1e293b;
            border-color: #000;
            color: #e2e8f0;
        }
        
        body.dark-mode .day-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        body.dark-mode .day-card[data-expanded="true"] {
            border-color: #14b8a6;
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
        }
        
        body.dark-mode .day-card-wrapper .details.show {
            background: #1e293b;
            border-color: #14b8a6;
        }
        
        body.dark-mode .day-header:hover {
            background: #334155;
        }
        
        body.dark-mode .day-title h3,
        body.dark-mode .day-cost .amount {
            color: #f1f5f9;
        }
        
        body.dark-mode .day-title .date,
        body.dark-mode .day-cost .usd {
            color: #94a3b8;
        }
        
        body.dark-mode .analytics-card {
            background: #1e293b;
            border-color: #000;
        }
        
        body.dark-mode .analytics-card:hover {
            background: #334155;
        }
        
        /* Teal accent in light mode */
        .btn {
            background: #0d9488;
        }
        
        .btn:hover {
            background: #0f766e;
        }
        
        .nav-item.active {
            background: #0d9488 !important;
            color: white !important;
            background: #0d9488 !important;
        }
        
        /* Teal accent in dark mode (lighter for visibility) */
        body.dark-mode .btn {
            background: #14b8a6 !important;
        }
        
        body.dark-mode .btn:hover {
            background: #0d9488 !important;
        }
        
        body.dark-mode .nav-item.active {
            background: #0d9488 !important;
            color: white !important;
            background: #14b8a6 !important;
        }
        
        body.dark-mode .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }
        
        body.dark-mode .btn-secondary:hover {
            background: #475569;
        }
        
        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: #64748b;
        }
        
        body.dark-mode .modal-overlay {
            background: rgba(15, 23, 42, 0.9);
        }
        
        body.dark-mode .modal {
            background: #1e293b;
            border-color: #000;
        }
        
        body.dark-mode .search-bar,
        body.dark-mode .search-input {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        body.dark-mode .category-card,
        body.dark-mode .notes-card {
            background: #334155;
            border-color: #475569;
        }
        
        body.dark-mode .mobile-tab-bar {
            background: #1e293b;
            border-top-color: #000;
        }
        
        body.dark-mode .mobile-tab-btn {
            color: #94a3b8;
        }
        
        body.dark-mode .mobile-tab-btn.active {
            color: #0d9488;
        }
        
        /* Additional comprehensive dark mode coverage */
        body.dark-mode .nav-item {
            color: #94a3b8;
        }
        
        body.dark-mode .nav-item:hover {
            background: #334155;
            color: #e2e8f0;
        }
        
        body.dark-mode .nav-item.active {
            background: #0d9488 !important;
            color: white !important;
            background: #0d9488;
            color: white;
        }
        
        body.dark-mode .sidebar-header {
            background: #0f172a;
            border-bottom-color: #000;
        }
        
        body.dark-mode .sidebar-logo-text {
            color: #f1f5f9;
        }
        
        body.dark-mode .content-body {
            background: #0f172a;
        }
        
        /* Comprehensive card and content coverage */
        body.dark-mode .settings-menu-card,
        body.dark-mode .settings-full-page,
        body.dark-mode .analytics-page,
        body.dark-mode .welcome-screen,
        body.dark-mode .tab-content {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        body.dark-mode .settings-menu-card {
            background: #1e293b;
            border-color: #000;
        }
        
        body.dark-mode .settings-menu-card:hover {
            background: #334155;
        }
        
        body.dark-mode .settings-card-title,
        body.dark-mode .analytics-card-title,
        body.dark-mode .category-card-title {
            color: #f1f5f9;
        }
        
        body.dark-mode .settings-card-desc,
        body.dark-mode .analytics-card-desc,
        body.dark-mode .category-card-desc {
            color: #94a3b8;
        }
        
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode h5 {
            color: #f1f5f9;
        }
        
        body.dark-mode .modal-content,
        body.dark-mode .modal-header,
        body.dark-mode .modal-body {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        body.dark-mode .search-dropdown {
            background: #1e293b;
            border-color: #000;
        }
        
        body.dark-mode .search-result-item {
            border-bottom-color: #000;
            color: #e2e8f0;
        }
        
        body.dark-mode .search-result-item:hover {
            background: #334155;
        }
        
        body.dark-mode .progress {
            background: #1e293b;
            border-color: #000;
        }
        
        body.dark-mode .progress-bar {
            background: #334155;
        }
        
        body.dark-mode .day-card-wrapper .details {
            background: #1e293b;
        }
        
        /* Ensure all inline white backgrounds are overridden */
        body.dark-mode [style*="background:white"],
        body.dark-mode [style*="background: white"],
        body.dark-mode [style*="background:#fff"],
        body.dark-mode [style*="background: #fff"] {
            background: #1e293b !important;
        }
        
        body.dark-mode [style*="color:#000"],
        body.dark-mode [style*="color: #000"],
        body.dark-mode [style*="color:black"],
        body.dark-mode [style*="color: black"] {
            color: #e2e8f0 !important;
        }
        
        /* Navy blue accent color for dark mode */
        body.dark-mode .btn {
            background: #0d9488 !important;
        }
        
        body.dark-mode .btn:hover {
            background: #1e3a8a !important;
        }
        
        /* Comprehensive white background overrides */
        body.dark-mode [style*="background:white"],
        body.dark-mode [style*="background: white"],
        body.dark-mode [style*="background:#fff"],
        body.dark-mode [style*="background: #fff"],
        body.dark-mode [style*="background:#ffffff"],
        body.dark-mode [style*="background: #ffffff"] {
            background: #1e293b !important;
        }
        
        body.dark-mode [style*="background:#fafafa"],
        body.dark-mode [style*="background:#f5f5f5"],
        body.dark-mode [style*="background:#f0f0f0"] {
            background: #0f172a !important;
        }
        
        /* Border overrides */
        body.dark-mode [style*="border:3px solid #000"],
        body.dark-mode [style*="border: 3px solid #000"],
        body.dark-mode [style*="border:3px solid #000"],
        body.dark-mode [style*="border: 3px solid #000"] {
            border-color: #475569 !important;
        }
        
        body.dark-mode [style*="border-left:4px solid #000"] {
            border-left-color: #0d9488 !important;
        }
        
        body.dark-mode .tab-content {
            background: #0f172a;
        }
        
        body.dark-mode .content-header {
            background: #1e293b !important;
            border-bottom-color: #475569 !important;
        }
        
        body.dark-mode .content-header h1 {
            color: #f1f5f9 !important;
        }
        
        /* Analytics and modal pages */
        body.dark-mode .analytics-page {
            background: #0f172a !important;
        }
        
        body.dark-mode .analytics-header {
            background: #1e293b !important;
            border-bottom-color: #475569 !important;
        }
        
        body.dark-mode .analytics-content {
            background: #0f172a !important;
        }
        
        body.dark-mode .settings-overlay {
            background: rgba(0, 0, 0, 0.7) !important;
        }
        
        /* All hover states - override inline styles */
        body.dark-mode [onmouseover*="background"] {
            transition: background 0.2s !important;
        }
        
        body.dark-mode [style*="background:#fafafa"]:hover,
        body.dark-mode [style*="background: #fafafa"]:hover {
            background: #334155 !important;
        }
        
        /* Navy blue accent for buttons */
        body.dark-mode .btn,
        body.dark-mode [style*="background:#0d9488"],
        body.dark-mode [style*="background: #0d9488"] {
            background: #0d9488 !important;
        }
        
        body.dark-mode .btn:hover {
            background: #1e3a8a !important;
        }
        
        /* Checklist items */
        body.dark-mode .checklist-item {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        
        body.dark-mode .checklist-item:hover {
            background: #334155 !important;
        }
        
        /* Sidebar toggle button dark mode */
        body.dark-mode .sidebar-toggle {
            background: #334155;
            color: #e2e8f0;
        }
        
        body.dark-mode .sidebar-toggle:hover {
            background: #475569;
        }
        
        /* Analytics & Tools section dark mode */
        body.dark-mode .analytics-cards-section {
            background: #0f172a !important;
        }
        
        body.dark-mode .analytics-cards-section h3 {
            color: #f1f5f9 !important;
        }
        
        body.dark-mode .analytics-cards-grid {
            background: #0f172a !important;
        }
        
        /* Make all white backgrounds dark */
        body.dark-mode [style*="background:white"],
        body.dark-mode [style*="background: white"] {
            background: #1e293b !important;
        }
        
        body.dark-mode .analytics-card-title,
        body.dark-mode .settings-card-title {
            color: #f1f5f9;
        }
        
        body.dark-mode .analytics-card-desc,
        body.dark-mode .settings-card-desc {
            color: #94a3b8;
        }
        
        body.dark-mode .settings-menu-card {
            background: #1e293b;
            border-color: #000;
            color: #e2e8f0;
        }
        
        body.dark-mode .settings-menu-card:hover {
            background: #334155;
        }
        
        body.dark-mode .settings-full-page,
        body.dark-mode .analytics-page {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        body.dark-mode .welcome-screen {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        body.dark-mode .welcome-title,
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 {
            color: #f1f5f9;
        }
        
        body.dark-mode .details {
            background: #1e293b;
            border-top-color: #000;
        }
        
        body.dark-mode .btn-secondary {
            border-color: #475569;
        }
        
        body.dark-mode .app-shell {
            background: #0f172a;
        }

        /* ============================================ */
        /* DARK MODE FIXES - Trip Manager, Export, Back Button, */
        /* Appearance/Animation Settings, Gallery Header        */
        /* ============================================ */

        /* Teal-tinted (#f0fdfa) backgrounds go dark in dark mode */
        body.dark-mode [style*="background:#f0fdfa"],
        body.dark-mode [style*="background: #f0fdfa"] {
            background: #0c2420 !important;
        }
        body.dark-mode [style*="border:2px solid #99f6e4"],
        body.dark-mode [style*="border: 2px solid #99f6e4"] {
            border-color: #134e4a !important;
        }
        body.dark-mode [style*="background:rgba(13,148,136,0.08)"],
        body.dark-mode [style*="background: rgba(13,148,136,0.08)"],
        body.dark-mode [style*="background:rgba(13,148,136,0.06)"] {
            background: rgba(13,148,136,0.15) !important;
        }
        /* Route editor dark mode */
        body.dark-mode [style*="border:2px solid #0d9488"] {
            border-color: #0d9488 !important;
        }
        /* Location cards in route editor */
        body.dark-mode [style*="background:#f0fdfa"][style*="border-radius:8px"] {
            background: #0c2420 !important;
        }
        /* Section yellow override */
        body.dark-mode .section.yellow,
        body.dark-mode .section {
            background: #1e293b !important;
            border-left-color: #0d9488 !important;
        }
        /* Track actual spending dark */
        body.dark-mode [style*="background:#f0fdfa"][style*="border-left:4px solid #0d9488"] {
            background: #0c2420 !important;
        }
        
        /* ============================================ */
        /* DARK MODE: Analytics & Prep Cards          */
        /* ============================================ */
        
        /* Analytics cards section */
        body.dark-mode .analytics-cards-section {
            background: #1e293b !important;
            box-shadow: none !important;
        }
        
        /* Analytics cards - keep black border, white text on dark bg */
        body.dark-mode .analytics-card {
            background: #0f172a !important;
            border-color: #475569 !important; /* Gray border in dark mode, not black */
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .analytics-card:hover {
            border-color: #0d9488 !important; /* Teal on hover */
            box-shadow: 0 6px 16px rgba(13, 148, 136, 0.3) !important;
        }
        
        body.dark-mode .analytics-card-title {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .analytics-card-desc {
            color: #94a3b8 !important;
        }
        
        body.dark-mode .analytics-card-arrow {
            color: #0d9488 !important;
        }
        
        /* Prep cards (packing, before trip) - dark mode */
        body.dark-mode button.prep-card {
            background: #0f172a !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode button.prep-card:hover {
            border-color: #0d9488 !important;
        }
        
        /* Prep card internal elements */
        body.dark-mode button.prep-card .analytics-card-desc {
            color: #94a3b8 !important;
        }
        
        body.dark-mode button.prep-card div[style*="background:#fafafa"] {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        
        body.dark-mode .packing-card-progress,
        body.dark-mode .before-card-progress {
            color: #e2e8f0 !important;
        }
        
        /* Show Estimated Costs toggle dark mode */
        body.dark-mode div[onclick*="showEst"] {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        
        /* ============================================ */
        /* DARK MODE: Day Activity Cards              */
        /* ============================================ */
        
        /* Day activity cards (Photos, Receipts, Schedule, Map, Weather) */
        body.dark-mode .day-activity-card {
            background: #1e293b !important;
            border-color: #475569 !important; /* Gray border, not white */
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-activity-card:hover {
            border-color: #0d9488 !important;
            background: #0f172a !important;
        }
        
        body.dark-mode .day-card-title {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-card-badge {
            color: #94a3b8 !important; /* Gray badge text */
            background: #334155 !important;
        }
        
        body.dark-mode .day-card-icon {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-section-page {
            background: #0f172a !important;
        }
        
        body.dark-mode .day-section-header {
            background: #1e293b !important;
            border-bottom-color: #334155 !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-section-header h2,
        body.dark-mode .day-section-header h3,
        body.dark-mode .day-section-header span {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-section-content {
            background: #0f172a !important;
        }
        
        body.dark-mode .day-card-controls {
            border-top-color: #334155 !important;
        }
        
        body.dark-mode .day-control-btn {
            background: #1e293b !important;
            color: #e2e8f0 !important;
            border: 1px solid #475569 !important;
        }
        
        body.dark-mode .day-control-btn:hover {
            background: #334155 !important;
        }
        
        body.dark-mode .day-control-btn.danger {
            background: #450a0a !important;
            color: #fca5a5 !important;
            border-color: #7f1d1d !important;
        }
        
        body.dark-mode .day-control-btn.danger:hover {
            background: #7f1d1d !important;
        }
        
        /* ============================================ */
        /* DARK MODE: Quick Jump Grid                 */
        /* ============================================ */
        
        body.dark-mode .day-jump-grid {
            background: #0f172a !important;
        }
        
        body.dark-mode .day-jump-box {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-jump-box.completed {
            background: #064e3b !important;
            border-color: #22c55e !important;
            color: #22c55e !important;
        }
        
        body.dark-mode .day-jump-box.current {
            background: #0c2420 !important;
            border-color: #0d9488 !important;
            color: #0d9488 !important;
        }
        
        /* ============================================ */
        /* DARK MODE: Calendar Cells                  */
        /* ============================================ */
        
        /* Calendar day cells need white border for contrast in dark mode */
        body.dark-mode .calendar-cell,
        body.dark-mode div[style*="cursor:pointer"][style*="border-radius:8px"] {
            border: 2px solid #e2e8f0 !important;
        }
        
        body.dark-mode .calendar-cell:hover {
            border-color: #0d9488 !important;
        }
        
        /* Calendar cells - base styles */
        .calendar-cell {
            background: white !important;
        }
        
        /* Day Detail Modal - Dark Mode */
        body.dark-mode .day-detail-content {
            background: #0f172a !important;
        }
        
        body.dark-mode .day-detail-header {
            background: #1e293b !important;
            border-bottom-color: #334155 !important;
        }
        
        body.dark-mode .day-detail-header h2 {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-detail-header button {
            background: #334155 !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-detail-modal div[style*="background:#f9fafb"],
        body.dark-mode .day-detail-modal div[style*="background:#fafafa"],
        body.dark-mode .day-detail-modal div[style*="background:#f3f4f6"],
        body.dark-mode .day-detail-modal div[style*="background:white"] {
            background: #1e293b !important;
        }
        
        body.dark-mode .day-detail-modal div[style*="color:#000"],
        body.dark-mode .day-detail-modal h3,
        body.dark-mode .day-detail-modal h2 {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-detail-modal div[style*="color:#666"] {
            color: #94a3b8 !important;
        }
        
        body.dark-mode .day-detail-modal textarea,
        body.dark-mode .day-detail-modal input[type="text"],
        body.dark-mode .day-detail-modal input[type="number"],
        body.dark-mode .day-detail-modal input[type="date"] {
            background: #0f172a !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-detail-modal button {
            background: #334155 !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-detail-modal .btn,
        body.dark-mode .day-detail-modal .btn-secondary {
            background: #334155 !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .day-detail-close {
            background: #334155 !important;
            color: #e2e8f0 !important;
        }
        
        /* Calendar cell content - override inline styles */
        body.dark-mode .calendar-cell {
            background: #1e293b !important;
        }
        
        body.dark-mode .calendar-cell[style*="background:white"] {
            background: #1e293b !important;
        }
        
        body.dark-mode .calendar-cell div[style*="color:#000"] {
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .calendar-cell .calendar-cell-location div {
            color: #94a3b8 !important;
        }
        
        body.dark-mode .calendar-cell .calendar-cell-cost {
            background: #334155 !important;
            color: #0d9488 !important;
        }
        
        /* Force all calendar cells with white background */
        body.dark-mode div[style*="background:white"][style*="height:90px"] {
            background: #1e293b !important;
        }
        
        /* Target calendar cells by structure */
        body.dark-mode .calendar-cell,
        body.dark-mode [id^="cal-cell-"] {
            background: #1e293b !important;
        }
        
        /* Force override any inline white background in calendar area */
        body.dark-mode div[style*="grid-template-columns"][style*="80px"] > div[style*="background:white"] {
            background: #1e293b !important;
        }
        
        /* Calendar empty cells */
        body.dark-mode div[style*="background:#fafafa"][style*="height:90px"] {
            background: #0f172a !important;
            border-color: #334155 !important;
        }
        
        body.dark-mode div[style*="background:#fafafa"][style*="height:90px"] div {
            color: #475569 !important;
        }
        
        /* ============================================ */
        /* DARK MODE: Mobile-Specific Overrides       */
        /* ============================================ */
        
        @media (max-width: 768px) {
            /* Mobile header in dark mode */
            body.dark-mode .content-header {
                background: #1e293b !important;
                border-bottom-color: #475569 !important;
            }
            
            body.dark-mode .content-header h1 {
                color: #e2e8f0 !important;
            }
            
            /* Mobile buttons in dark mode */
            body.dark-mode .content-header .btn-secondary {
                background: #334155 !important;
                border-color: #475569 !important;
                color: #e2e8f0 !important;
            }
            
            body.dark-mode .content-header .btn-secondary:hover {
                background: #475569 !important;
            }
            
            /* Mobile menu button */
            body.dark-mode .mobile-menu-btn {
                color: #e2e8f0 !important;
            }
            
            /* Tab content background */
            body.dark-mode .tab-content {
                background: #0f172a !important;
            }
            
            /* Mobile category cards */
            body.dark-mode .category-card,
            body.dark-mode .notes-card {
                background: #1e293b !important;
                border-color: #475569 !important;
            }
            
            /* Route editor on mobile dark mode */
            body.dark-mode div[style*="background:white"][style*="border:3px solid #000"] {
                background: #1e293b !important;
                border-color: #475569 !important;
            }
            
            /* Map controls in dark mode mobile */
            body.dark-mode div[style*="background:#f0fdfa"][style*="border:2px solid #99f6e4"] {
                background: #0c2420 !important;
                border-color: #134e4a !important;
            }
            
            /* Force 1 column grid for day cards on mobile */
            .day-cards-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            /* Make day cards content smaller for 2 column mobile layout */
            .day-cards-grid .day-card {
                padding: 8px !important;
                min-height: auto !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Mobile day card - complete restructure */
            .day-cards-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .day-cards-grid .day-card {
                padding: 6px !important;
                min-height: auto !important;
                display: flex !important;
                flex-direction: column !important;
                cursor: pointer !important;
                gap: 0 !important;
            }
            
            /* Day header - minimal padding, NO margin */
            .day-cards-grid .day-header {
                padding: 0 !important;
                padding-top: 28px !important;
                margin: 0 !important;
            }
            
            .day-cards-grid .day-info {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
                line-height: 0 !important;
            }
            
            .day-cards-grid .day-info > * {
                line-height: normal !important;
            }
            
            .day-cards-grid .day-num {
                display: none !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .day-cards-grid div[id^="transit-info-"] {
                display: none !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .day-cards-grid .day-title {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1 !important;
            }
            
            /* Force inner wrapper to have no spacing */
            .day-cards-grid .day-title > div {
                margin: 0 !important;
                padding: 0 !important;
                gap: 0 !important;
            }
            
            .day-cards-grid .day-title h3 {
                font-size: 12px !important;
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1.1 !important;
            }
            
            .day-cards-grid .date {
                font-size: 9px !important;
                margin: 1px 0 0 0 !important;
                padding: 0 !important;
                line-height: 1.1 !important;
            }
            
            .day-cards-grid .edit-day-link {
                display: none !important;
            }
            
            /* Cost - NO margin-top, just border */
            .day-cards-grid .day-cost {
                margin: 0 !important;
                padding: 3px 0 0 0 !important;
                border-top: 1px solid #e5e7eb !important;
                cursor: default !important;
                pointer-events: none !important;
                text-align: center !important;
            }
            
            .day-cards-grid .day-cost .amount {
                font-size: 9px !important;
                font-weight: 600 !important;
                display: block !important;
                line-height: 1.2 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* MOBILE ONLY: Details panel styling */
            @media (max-width: 768px) {
                /* Backdrop behind bottom sheet */
                .mobile-panel-backdrop {
                    display: none;
                }
                .day-cards-grid .details.show ~ .mobile-panel-backdrop,
                .mobile-panel-backdrop.active {
                    display: block;
                    position: fixed;
                    inset: 0;
                    background: rgba(0,0,0,0.4);
                    z-index: 4999;
                }
                
                /* Pull handle at top of bottom sheet */
                .day-cards-grid .details.show::before {
                    content: '';
                    display: block;
                    width: 40px;
                    height: 4px;
                    background: #d1d5db;
                    border-radius: 2px;
                    margin: 0 auto 12px auto;
                }
                
                /* Mobile-only edit button in panel */
                .mobile-panel-edit-row {
                    display: flex !important;
                }
                
                /* Tab bar sits below the panel when panel is open */
                .mobile-tab-bar {
                    z-index: 4997 !important;
                }
                
                /* Map header quick buttons - compact on mobile */
                .map-quick-btns {
                    flex-wrap: wrap !important;
                    gap: 4px !important;
                }
                .map-quick-btns button {
                    font-size: 11px !important;
                    padding: 5px 8px !important;
                }
                
                /* Card stays in its 2-column position, highlighted when expanded */
                .day-cards-grid .day-card-wrapper .day-card[data-expanded="true"] {
                    border-color: #0d9488 !important;
                    border-width: 3px !important;
                    box-shadow: 0 0 0 2px rgba(13,148,136,0.3) !important;
                    z-index: 2 !important;
                }
                
                /* Details panel: fixed to bottom of screen, full width, scrollable */
                .day-cards-grid .day-card-wrapper .details.show {
                    position: fixed !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    top: auto !important;
                    width: 100% !important;
                    max-height: 70vh !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch !important;
                    margin: 0 !important;
                    padding: 16px !important;
                    background: white !important;
                    border: none !important;
                    border-top: 3px solid #0d9488 !important;
                    border-radius: 16px 16px 0 0 !important;
                    box-shadow: 0 -4px 24px rgba(0,0,0,0.18) !important;
                    pointer-events: auto !important;
                    z-index: 5000 !important;
                    display: block !important;
                }
                
                body.dark-mode .day-cards-grid .details.show {
                    background: #0f172a !important;
                }
                
                /* Dark mode */
                body.dark-mode .details.show {
                    background: #0f172a !important;
                    color: #e2e8f0 !important;
                }
                
                body.dark-mode .details.show .section {
                    background: #1e293b !important;
                }
                
                /* Mobile-specific content sizing */
                .day-cards-grid .details.show .section {
                    padding: 10px !important;
                    margin-bottom: 8px !important;
                }
                
                .day-cards-grid .details.show h4 {
                    font-size: 12px !important;
                }
                
                .day-cards-grid .details.show p {
                    font-size: 10px !important;
                }
                
                /* Category cards smaller on mobile */
                .day-cards-grid .details.show .category-card {
                    padding: 8px !important;
                    margin-bottom: 6px !important;
                }
                
                .day-cards-grid .details.show .category-card-header {
                    font-size: 11px !important;
                    margin-bottom: 4px !important;
                }
                
                .day-cards-grid .details.show .category-card-icon {
                    font-size: 14px !important;
                    width: 24px !important;
                    height: 24px !important;
                }
                
                .day-cards-grid .details.show .category-card-title {
                    font-size: 11px !important;
                }
                
                .day-cards-grid .details.show .category-card-content {
                    font-size: 10px !important;
                    line-height: 1.3 !important;
                }
                
                .day-cards-grid .details.show .category-card-cost {
                    font-size: 10px !important;
                }
                
                /* Day activity cards smaller */
                .day-cards-grid .details.show .day-activities-cards {
                    display: grid !important;
                    grid-template-columns: repeat(3, 1fr) !important;
                    gap: 6px !important;
                }
                
                .day-cards-grid .details.show .day-activity-card {
                    padding: 8px 4px !important;
                }
                
                .day-cards-grid .details.show .day-card-icon {
                    font-size: 16px !important;
                }
                
                .day-cards-grid .details.show .day-card-title {
                    font-size: 9px !important;
                }
                
                .day-cards-grid .details.show .day-card-badge {
                    font-size: 8px !important;
                }
                
                /* Input fields smaller */
                .day-cards-grid .details.show input[type="number"],
                .day-cards-grid .details.show input[type="text"] {
                    font-size: 11px !important;
                    padding: 6px !important;
                }
                
                /* Buttons smaller */
                .day-cards-grid .details.show button {
                    font-size: 11px !important;
                    padding: 8px 12px !important;
                }
                
                /* Grid layouts more compact */
                .day-cards-grid .details.show .grid {
                    gap: 6px !important;
                }
            }
            
            .day-cards-grid .day-badge {
                font-size: 9px !important;
                padding: 2px 5px !important;
            }
            
            /* Day number circle smaller */
            .day-cards-grid div[style*="width:32px;height:32px"] {
                width: 24px !important;
                height: 24px !important;
                font-size: 11px !important;
                top: 8px !important;
                left: 8px !important;
            }
            
            /* Day activity cards smaller */
            .day-cards-grid .day-activities-cards {
                gap: 6px !important;
            }
            
            .day-cards-grid .day-activity-card {
                padding: 8px 6px !important;
            }
            
            .day-cards-grid .day-card-icon {
                font-size: 16px !important;
            }
            
            .day-cards-grid .day-card-title {
                font-size: 10px !important;
            }
            
            .day-cards-grid .day-card-badge {
                font-size: 9px !important;
            }
            
            /* Home page hero stats - 2x2 grid on mobile */
            .hero-stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }
            
            .hero-stats-grid > div {
                padding: 16px 12px !important;
            }
            
            /* Quick actions - 2x2 grid on mobile */
            .quick-actions-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .quick-actions-grid button {
                font-size: 12px !important;
                padding: 10px 8px !important;
            }
            
            /* Quick Jump - limit height on mobile */
            .day-jump-grid {
                max-height: 150px !important;
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)) !important;
            }
            
            .analytics-card {
                padding: 14px !important;
            }
            
            /* Checklist and Quick Jump - side by side on mobile, compact */
            .checklist-quickjump-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }
            
            /* Both QJ cards: uniform sizing */
            .checklist-quickjump-grid .checklist-qj-card {
                min-width: 0 !important;
                box-sizing: border-box !important;
                width: 100% !important;
            }
            
            .checklist-quickjump-grid .analytics-card-title {
                font-size: 13px !important;
                font-weight: 700 !important;
            }
            
            .checklist-quickjump-grid .analytics-card-desc {
                font-size: 11px !important;
            }
            
            /* Mobile More Menu - Dark Mode */
            body.dark-mode .mobile-more-menu {
                background: #1e293b !important;
                border-color: #475569 !important;
            }
            
            body.dark-mode .mobile-more-header {
                border-bottom-color: #475569 !important;
            }
            
            body.dark-mode .mobile-more-header h3 {
                color: #e2e8f0 !important;
            }
            
            body.dark-mode .mobile-more-item {
                background: #0f172a !important;
                border-color: #475569 !important;
            }
            
            body.dark-mode .mobile-more-item:hover {
                background: #334155 !important;
            }
            
            body.dark-mode .mobile-more-icon {
                background: #334155 !important;
                color: #0d9488 !important;
            }
            
            body.dark-mode .mobile-more-title {
                color: #e2e8f0 !important;
            }
            
            body.dark-mode .mobile-more-desc {
                color: #94a3b8 !important;
            }
            
            /* Planning Page - Trip Notes smaller on mobile */
            #tripNotesTextarea {
                min-height: 80px !important;
                font-size: 13px !important;
                padding: 12px !important;
            }
            
            div[style*="Trip Notes"] {
                padding: 16px !important;
            }
            
            div[style*="Trip Notes"] h3 {
                font-size: 16px !important;
                margin-bottom: 6px !important;
            }
            
            div[style*="Trip Notes"] p {
                font-size: 12px !important;
                margin-bottom: 10px !important;
            }
            
            /* Planning Page - Budget cards bigger but still 2x2 */
            div[style*="Target Budget"],
            div[style*="Actually Spent"],
            div[style*="Remaining"],
            div[style*="Days Completed"] {
                padding: 18px 14px !important;
            }
            
            div[style*="Target Budget"] > div[style*="font-size:36px"],
            div[style*="Actually Spent"] > div[style*="font-size:36px"],
            div[style*="Remaining"] > div[style*="font-size:36px"],
            div[style*="Days Completed"] > div[style*="font-size:36px"] {
                font-size: 28px !important;
            }
            
            div[style*="Target Budget"] > div[style*="font-size:12px"],
            div[style*="Actually Spent"] > div[style*="font-size:12px"],
            div[style*="Remaining"] > div[style*="font-size:12px"],
            div[style*="Days Completed"] > div[style*="font-size:12px"] {
                font-size: 11px !important;
            }
            
            /* Map Page - Make header and controls collapsible/smaller */
            div[style*=" Trip Map"] {
                padding: 14px !important;
                margin-bottom: 12px !important;
            }
            
            div[style*=" Trip Map"] h2 {
                font-size: 16px !important;
                margin-bottom: 12px !important;
            }
            
            /* Map controls - make them fit on mobile */
            div[style*="ANIMATION"],
            div[style*="ROUTE TRANSPORT PRIORITY"] {
                padding: 12px !important;
                margin-bottom: 12px !important;
            }
            
            div[style*="ANIMATION"] > div[style*="font-size:13px"] {
                font-size: 11px !important;
            }
            
            div[style*="ANIMATION"] button,
            div[style*="VIEW MODE"] button {
                padding: 8px 12px !important;
                font-size: 11px !important;
                white-space: nowrap !important;
            }
            
            /* Transport priority items */
            div[style*="transportPriority"] div[style*="padding:6px 10px"] {
                padding: 4px 8px !important;
                font-size: 10px !important;
            }
            
            /* Map view mode section */
            div[style*="VIEW MODE"] {
                margin-bottom: 12px !important;
            }
            
            div[style*="VIEW MODE"] > div[style*="font-size:13px"] {
                font-size: 11px !important;
            }
            
            /* Route Editor - 1 column grid on mobile */
            #routeEditorContent h3 {
                font-size: 14px !important;
            }
        }

        /* Trip Manager Modal */
        body.dark-mode .trip-manager-modal {
            background: #1e293b !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .trip-manager-modal h2,
        body.dark-mode .trip-manager-modal h3,
        body.dark-mode .trip-manager-modal h4 {
            color: #f1f5f9 !important;
        }
        body.dark-mode .trip-manager-modal [style*="border-bottom:2px solid #e0e0e0"],
        body.dark-mode .trip-manager-modal [style*="border-bottom: 2px solid #e0e0e0"] {
            border-bottom-color: #475569 !important;
        }
        body.dark-mode .trip-comparison-table {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        body.dark-mode .trip-comparison-header {
            background: #0f172a !important;
            color: #94a3b8 !important;
        }
        body.dark-mode .trip-comparison-row {
            border-bottom-color: #334155 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .trip-comparison-row:hover {
            background: #334155 !important;
        }
        body.dark-mode .trip-comparison-row.current {
            background: #0f2940 !important;
            border-left-color: #0d9488 !important;
        }
        body.dark-mode .trip-comparison-section {
            background: #0f172a !important;
        }
        body.dark-mode .trip-card {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .trip-card:hover {
            border-color: #64748b !important;
        }
        body.dark-mode .trip-card.current-trip {
            background: #0f2940 !important;
            border-color: #0d9488 !important;
        }
        body.dark-mode .trip-card-info,
        body.dark-mode .trip-card-dates {
            color: #94a3b8 !important;
        }
        body.dark-mode .trip-card-actions {
            border-top-color: #475569 !important;
        }
        body.dark-mode .trip-manager-overlay {
            background: rgba(0, 0, 0, 0.7) !important;
        }
        /* [style*="color:#666"] inside trip manager */
        body.dark-mode .trip-manager-modal [style*="color:#666"],
        body.dark-mode .trip-manager-modal [style*="color: #666"] {
            color: #94a3b8 !important;
        }

        /* Export & Share Page */
        body.dark-mode .export-page {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        body.dark-mode .export-page-header {
            background: #0f172a !important;
            border-bottom-color: #475569 !important;
        }
        body.dark-mode .export-page-header h2 {
            color: #f1f5f9 !important;
        }
        body.dark-mode .export-page-content {
            background: #0f172a !important;
        }
        body.dark-mode .export-option-card {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .export-option-card:hover {
            background: #334155 !important;
            border-color: #64748b !important;
        }
        body.dark-mode .export-card-title {
            color: #f1f5f9 !important;
        }
        body.dark-mode .export-card-desc {
            color: #94a3b8 !important;
        }
        body.dark-mode .info-box {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .export-menu {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        body.dark-mode .export-btn {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .export-btn:hover {
            background: #334155 !important;
        }

        /*  Back to Settings button */
        body.dark-mode .back-button {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .back-button:hover {
            background: #334155 !important;
            border-color: #64748b !important;
        }

        /* Settings Full Page - background and content areas */
        body.dark-mode .settings-full-page {
            background: #0f172a !important;
            color: #e2e8f0 !important;
        }
        /* Don't override the gradient header - it looks good in dark mode too */
        body.dark-mode .settings-full-page > div:nth-child(2) {
            background: #0f172a !important;
        }
        /* Appearance settings sub-cards (animation, card style, density, font) */
        body.dark-mode .settings-content-page > div[style*="background:white"],
        body.dark-mode .settings-content-page > div[style*="background: white"] {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        body.dark-mode .settings-content-page label,
        body.dark-mode .settings-content-page h3 {
            color: #f1f5f9 !important;
        }
        body.dark-mode .settings-content-page p {
            color: #94a3b8 !important;
        }
        body.dark-mode .settings-content-page [style*="background:#fafafa"],
        body.dark-mode .settings-content-page [style*="background: #fafafa"] {
            background: #0f172a !important;
        }

        body.dark-mode .settings-full-page [style*="background:#fafafa"],
        body.dark-mode .settings-full-page [style*="background: #fafafa"] {
            background: #0f172a !important;
        }
        body.dark-mode .settings-full-page [style*="background:white"],
        body.dark-mode .settings-full-page [style*="background: white"] {
            background: #1e293b !important;
        }
        body.dark-mode .settings-full-page [style*="border:3px solid #000"],
        body.dark-mode .settings-full-page [style*="border: 3px solid #000"] {
            border-color: #475569 !important;
        }
        body.dark-mode .settings-full-page [style*="color:#000"],
        body.dark-mode .settings-full-page [style*="color: #000"] {
            color: #f1f5f9 !important;
        }
        body.dark-mode .settings-full-page [style*="color:#666"],
        body.dark-mode .settings-full-page [style*="color: #666"],
        body.dark-mode .settings-full-page [style*="color:#374151"],
        body.dark-mode .settings-full-page [style*="color: #374151"] {
            color: #94a3b8 !important;
        }
        /* Settings form inputs dark mode */
        body.dark-mode .settings-full-page input,
        body.dark-mode .settings-full-page select,
        body.dark-mode .settings-full-page textarea {
            background: #0f172a !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }


        body.dark-mode .gallery-controls {
            background: #1e293b !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4) !important;
        }
        body.dark-mode .gallery-view-btn {
            background: #1e293b !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .gallery-view-btn:hover {
            background: #334155 !important;
            border-color: #64748b !important;
        }
        body.dark-mode .gallery-view-btn.active {
            background: #0d9488 !important;
            border-color: #0d9488 !important;
            color: white !important;
        }
        body.dark-mode .gallery-day-section {
            background: #1e293b !important;
            box-shadow: none !important;
        }
        body.dark-mode .gallery-day-header {
            border-bottom-color: #334155 !important;
        }
        body.dark-mode .gallery-day-header h3 {
            color: #f1f5f9 !important;
        }
        body.dark-mode .gallery-day-location {
            color: #94a3b8 !important;
        }
        body.dark-mode .gallery-photo-count {
            color: #64748b !important;
        }
        body.dark-mode .gallery-stats .stat-card {
            background: #1e293b !important;
        }

        /* ============================================ */
        /* PLANNING PAGE - Light Mode Accents           */
        /* ============================================ */

        /* Day card left accent stripe on hover */
        .day-card:not(.done):hover {
            border-left: 4px solid #0d9488;
        }

        /* Day number badge - teal gradient for planning page */
        .planning-view .day-num {
            background: linear-gradient(135deg, #0d9488 0%, #2563eb 100%) !important;
        }

        /* Stat cards - teal top border accent */
        .stat-card {
            border-top: 3px solid #0d9488;
            position: relative;
        }

        /* Search bar - teal focus ring */
        .search-input:focus {
            border-color: #0d9488 !important;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.15) !important;
            outline: none;
        }

        /* Day jump container accent */
        .day-jump-container {
            border-left: 3px solid #0d9488;
        }

        /* Category card hover - teal border */
        .category-card:hover {
            border-color: #0d9488 !important;
            box-shadow: 0 12px 24px rgba(13, 148, 136, 0.15) !important;
        }

        /* Planning page section headers accent */
        .planning-section-header {
            border-left: 4px solid #0d9488;
            padding-left: 12px;
        }
        
        .converter h3 { font-size: 16px; margin-bottom: 15px; }
        .converter-inputs { display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; }
        .converter-input { display: flex; flex-direction: column; }
        .converter-input label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .converter-input input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 18px; font-weight: 600; }
        .converter-swap { font-size: 24px; cursor: pointer; user-select: none; }
        
        .daily-budget { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .daily-budget-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .daily-budget h3 { font-size: 16px; margin: 0; }
        .daily-budget-toggle { font-size: 20px; transition: transform 0.3s; }
        .daily-budget-toggle.open { transform: rotate(180deg); }
        .daily-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; display: none; }
        .daily-stats.show { display: grid; }
        .daily-stat { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; }
        .daily-stat-label { font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 5px; }
        .daily-stat-value { font-size: 22px; font-weight: 600; }
        .daily-stat-note { font-size: 10px; opacity: 0.7; margin-top: 4px; }
        
        .toggle { background: white; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; cursor: pointer; }
        .toggle:hover { background: #f9f9f9; }
        .toggle-switch { width: 50px; height: 26px; background: #ddd; border-radius: 13px; position: relative; transition: background 0.3s; }
        .toggle-switch.on { background: #22c55e; }
        .toggle-slider { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch.on .toggle-slider { transform: translateX(18px); }
        
        .progress { 
            background: white; 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            margin-bottom: 30px;
        }
        .progress-label { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 12px; 
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        .progress-bar {
            width: 100%;
            height: 16px;
            background: #f3f4f6;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 8px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }
        
        /* Add shimmer effect */
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            to {
                left: 100%;
            }
        }
        .progress-fill.over {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .chart-container { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .chart-container h3 { font-size: 16px; margin: 0; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 15px; }
        .chart-header-toggle { font-size: 20px; transition: transform 0.3s; }
        .chart-header-toggle.open { transform: rotate(180deg); }
        .chart-content { display: none; }
        .chart-content.show { display: block; }
        .chart-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .chart-toggle button { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .chart-toggle button.active { background: #111; color: white; border-color: #111; }
        
        .chart-toggle-btn {
            padding: 10px 18px;
            border: 3px solid #000;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .chart-toggle-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .chart-toggle-btn.active {
            background: #000;
            color: white;
            border-color: #000;
        }
        .chart { display: grid; gap: 10px; }
        .chart-bar { display: flex; align-items: center; gap: 10px; }
        .chart-label { min-width: 120px; font-size: 13px; font-weight: 600; }
        .chart-bar-bg { flex: 1; height: 30px; background: #f0f0f0; border-radius: 4px; overflow: hidden; position: relative; }
        .chart-bar-fill { height: 100%; display: flex; align-items: center; padding: 0 10px; color: white; font-size: 12px; font-weight: 600; transition: width 0.3s; }
        .chart-bar-fill.acc { background: linear-gradient(90deg, #0d9488, #2563eb); }
        .chart-bar-fill.trn { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        .chart-bar-fill.food { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .chart-bar-fill.act { background: linear-gradient(90deg, #10b981, #059669); }
        .chart-value { min-width: 100px; text-align: right; font-size: 13px; font-weight: 600; }
        
        .day-card { 
            background: white; 
            margin-bottom: 12px; 
            border-radius: 12px; 
            border: 3px solid #000;
            transition: all 0.3s ease;
            overflow: visible; /* Allow shadow to show */
            align-self: start; /* Prevent cards from stretching to match tallest card */
            min-height: 140px; /* Increased from 120px to match largest cards */
            position: relative;
            z-index: 1;
        }
        
        /* Expanded card stays in place but gets highlighted with teal accent */
        .day-card[data-expanded="true"] {
            border-color: #0d9488;
            border-width: 3px;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
            z-index: 10;
        }
        
        /* Wrapper provides the positioning context for the absolute details panel */
        .day-card-wrapper {
            position: relative;
            min-width: 0;
            overflow: visible;
        }
        
        /* When expanded, the details section overlays full width below the card */
        .day-card-wrapper .details.show {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 8px);
            width: calc(200% + 20px);
            background: white;
            border: 3px solid #0d9488;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.2);
            z-index: 10;
        }
        
        /* If wrapper is in the right column, expand leftward */
        .day-card-wrapper:nth-child(even) .details.show {
            left: auto;
            right: 0;
            width: calc(200% + 20px);
        }
        .day-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        .day-card.done { 
            opacity: 0.75; 
            border-left: 4px solid #22c55e;
            background: linear-gradient(to right, #f0fdf4 0%, white 50%);
        }
        .day-header { 
            padding: 16px 20px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            transition: background 0.2s;
            gap: 8px;
        }
        .day-header:hover { background: #f9fafb; }
        .day-info { display: flex; align-items: flex-start; gap: 16px; flex: 1; }
        .day-check { 
            width: 20px; 
            height: 20px; 
            cursor: pointer;
            border-radius: 4px;
        }
        .day-num { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%); 
            color: white; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .day-card.done .day-num { 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        .day-title { 
            flex: 1;
            min-width: 0; /* Allow text to shrink and ellipsis to work */
        }
        .day-title h3 { 
            font-size: 16px; 
            font-weight: 700; 
            margin-bottom: 4px;
            color: #111827;
            letter-spacing: -0.2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 300px;
        }
        .day-title .date { 
            font-size: 13px; 
            color: #6b7280;
            font-weight: 500;
        }
        .day-cost {
            text-align: right;
            flex-shrink: 0;
        }
        .day-cost .amount { 
            font-size: 14px; 
            font-weight: 700;
            color: #111827;
            white-space: nowrap;
        }
        .day-cost .usd { 
            font-size: 11px; 
            color: #6b7280;
            margin-top: 1px;
        }
        
        .details { padding: 6px 12px; border-top: 1px solid #f0f0f0; display: none; }
        .day-card-wrapper .details.show { display: block; }
        .details.show { display: block; }
        .edit-btn { background: #111; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; margin-bottom: 15px; }
        .edit-btn:hover { background: #333; }
        .edit-btn.save { background: #28a745; }
        .section { margin-top: 15px; padding: 15px; background: #fafafa; border-radius: 4px; }
        .section.blue { background: #f0f9ff; border-left: 3px solid #0d9488; }
        .section.yellow { background: #fffbf0; border-left: 3px solid #ffc107; }
        .section-label { font-size: 12px; text-transform: uppercase; color: #999; margin-bottom: 8px; }
        .section-content { font-size: 14px; color: #333; }
        .section-cost { font-weight: 600; color: #111; margin-top: 8px; }
        .section-cost.actual { color: #ef4444; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        input[type="text"], input[type="number"], input[type="time"], textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; }
        textarea { min-height: 60px; resize: vertical; }
        
        .photo-section { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px; }
        .photo-upload { display: flex; gap: 10px; margin-bottom: 10px; }
        .photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .photo-item { position: relative; aspect-ratio: 1; border-radius: 4px; overflow: hidden; cursor: pointer; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-delete { position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; z-index: 10; }
        
        .photo-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .photo-modal.show { display: flex; }
        .photo-modal-content { max-width: 90%; max-height: 90%; position: relative; }
        .photo-modal-content img { max-width: 100%; max-height: 90vh; border-radius: 8px; }
        .photo-modal-close { position: absolute; top: -40px; right: 0; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; }
        
        .schedule-section { margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #0d9488; }
        .schedule-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 10px; }
        .schedule-header h4 { font-size: 14px; font-weight: 600; margin: 0; }
        .schedule-toggle { font-size: 16px; }
        .schedule-grid { display: grid; gap: 2px; margin-top: 15px; }
	    .schedule-hour { display: grid; grid-template-columns: 130px 1fr auto; gap: 0; align-items: stretch; background: white; border-radius: 4px; overflow: hidden; border: 1px solid #e5e7eb; transition: all var(--transition-speed); }
        .schedule-hour:hover { border-color: #000; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1); }
        .schedule-time { display: flex; align-items: center; justify-content: center; background: #f9fafb; border-right: 2px solid #e5e7eb; padding: 12px 8px; }
        .schedule-time input { border: none; background: transparent; font-size: 13px; font-weight: 600; color: #374151; text-align: center; width: 100%; cursor: pointer; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .schedule-time input:focus { outline: none; }
        .schedule-activity { padding: 12px 15px; display: flex; align-items: center; }
        .schedule-activity input { border: none; background: transparent; font-size: 14px; color: #111827; width: 100%; }
        .schedule-activity input:focus { outline: none; }
        .schedule-activity input::placeholder { color: #9ca3af; }
        .schedule-actions { display: flex; align-items: center; padding: 0 10px; }
        .schedule-delete { background: transparent; color: #ef4444; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 16px; transition: all var(--transition-speed); }
        .schedule-delete:hover { background: #fee; }
        .schedule-add-btn { width: 100%; padding: 12px; background: white; border: 2px dashed #cbd5e1; border-radius: 4px; color: #64748b; cursor: pointer; font-size: 14px; font-weight: 500; transition: all var(--transition-speed);	margin-top: 10px; }
        .schedule-add-btn:hover { border-color: #000; color: #0d9488; background: #f0f9ff; }
        .schedule-timeline { background: white; border-radius: 6px; border: 1px solid #e5e7eb; overflow: hidden; margin-top: 15px; }
        .timeline-hours { display: grid; grid-template-columns: 80px 1fr; }
        .timeline-hour-row { display: contents; }
        .timeline-hour-label { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; border-right: 2px solid #e5e7eb; background: #f9fafb; font-size: 12px; font-weight: 600; color: #6b7280; text-align: right; }
        .timeline-hour-cell { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; position: relative; min-height: 50px; cursor: pointer; transition: background 0.2s; }
        .timeline-hour-cell:hover { background: #f0f9ff; }
        .timeline-event { position: absolute; left: 5px; right: 5px; background: linear-gradient(135deg, #0d9488 0%, #2563eb 100%); color: white; padding: 8px 10px; border-radius: 4px; font-size: 13px; cursor: pointer; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); transition: all var(--transition-speed); z-index: 1; }        .timeline-event:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4); }
        .timeline-event-time { font-weight: 600; font-size: 11px; opacity: 0.9; margin-bottom: 2px; }
        .timeline-event-title { font-size: 13px; line-height: 1.3; }
        .timeline-event-delete { position: absolute; top: 4px; right: 4px; background: rgba(255, 255, 255, 0.3); border: none; border-radius: 3px; padding: 2px 6px; font-size: 11px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .timeline-event:hover .timeline-event-delete { opacity: 1; }
        .timeline-event-delete:hover { background: rgba(255, 255, 255, 0.5); }
        .schedule-view-toggle { display: flex; gap: 8px; margin-bottom: 10px; }
        .schedule-view-btn { padding: 6px 14px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; color: #64748b; transition: all var(--transition-speed); }
        .schedule-view-btn.active { background: #0d9488; color: white; border-color: #000; }
        .schedule-view-btn:hover:not(.active) { border-color: #000; color: #0d9488; }

	    .subtitle-edit { border: 3px solid #000; border-radius: 4px; padding: 6px 10px; font-size: 15px; width: 100%; margin-top: 8px; }
        .trip-notes-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .trip-notes-section h3 { font-size: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .trip-notes-section textarea { width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical; }

        .category-budget-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .category-budget-section h3 { font-size: 16px; margin-bottom: 15px; }
        .category-budget-item { margin-bottom: 20px; }
        .category-budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .category-budget-label { font-size: 14px; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 8px; }
        .category-budget-amount { font-size: 14px; color: #6b7280; }
        .category-budget-input { width: 120px; padding: 4px 8px; border: 3px solid #000; border-radius: 4px; font-size: 14px; font-weight: 600; }
        .category-budget-bar { width: 100%; height: 24px; background: #f3f4f6; border-radius: 12px; overflow: hidden; position: relative; }
        .category-budget-fill { height: 100%; transition: width 0.3s; position: relative; display: flex; align-items: center; padding: 0 10px; font-size: 12px; font-weight: 600; color: white; }
        .category-budget-fill.low { background: linear-gradient(90deg, #10b981, #059669); }
        .category-budget-fill.medium { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .category-budget-fill.high { background: linear-gradient(90deg, #ef4444, #dc2626); }

        .travelers-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .travelers-section h3 { font-size: 16px; margin-bottom: 15px; }
        .traveler-count { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .traveler-count-btn { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #000; background: white; color: #0d9488; font-size: 20px; font-weight: 600; cursor: pointer; transition: all var(--transition-speed); }
        .traveler-count-btn:hover { background: #0d9488; color: white; }
        .traveler-count-display { font-size: 24px; font-weight: 600; min-width: 60px; text-align: center; }
        .traveler-list { display: grid; gap: 10px; margin-top: 15px; }
        .traveler-item { display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; }
        .traveler-item input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .cost-split-toggle { margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 6px; }
        .cost-split-option { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
        .cost-split-option input[type="radio"] { width: 18px; height: 18px; cursor: pointer; }
        .cost-split-option label { font-size: 14px; color: #374151; cursor: pointer; }
        .per-person-cost { display: inline-block; margin-left: 8px; padding: 2px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 12px; font-weight: 600; }
       
        .weather-section { background: white; padding: 15px; border-radius: 6px; border-left: 3px solid #0d9488; margin-top: 15px; }
        .weather-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .weather-header h4 { font-size: 14px; font-weight: 600; margin: 0; }
        .weather-fetch-btn { background: #0d9488; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s; }
        .weather-fetch-btn:hover { background: #2563eb; }
        .weather-fetch-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .weather-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .weather-card { background: linear-gradient(135deg, #0d9488 0%, #2563eb 100%); color: white; padding: 12px; border-radius: 6px; text-align: center; }
        .weather-icon { font-size: 32px; margin-bottom: 5px; }
        .weather-temp { font-size: 20px; font-weight: 600; }
        .weather-desc { font-size: 11px; opacity: 0.9; margin-top: 4px; text-transform: capitalize; }
        .weather-error { color: #ef4444; font-size: 13px; padding: 10px; background: #fee2e2; border-radius: 4px; }
        .weather-loading { color: #666; font-size: 13px; font-style: italic; }

        .category-manager { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .category-manager h3 { font-size: 16px; margin-bottom: 15px; }
        .category-list { display: grid; gap: 10px; margin-bottom: 15px; }
        .category-item { display: grid; grid-template-columns: 50px 1fr 80px 100px auto; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; }
        .category-icon-picker { width: 40px; height: 40px; font-size: 20px; text-align: center; line-height: 40px; border: 3px solid #000; border-radius: 6px; cursor: pointer; background: white; }
        .category-color-picker { width: 60px; height: 30px; border: 3px solid #000; border-radius: 4px; cursor: pointer; }
        .add-category-btn { width: 100%; padding: 12px; background: white; border: 2px dashed #cbd5e1; border-radius: 6px; color: #64748b; cursor: pointer; font-size: 14px; font-weight: 500; transition: all var(--transition-speed); }
        .add-category-btn:hover { border-color: #000; color: #0d9488; background: #f0f9ff; }
        .icon-picker-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; max-height: 500px; overflow-y: auto; }
        .icon-picker-modal.show { display: block; }
        .icon-picker-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; }
        .icon-picker-overlay.show { display: block; }
        .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 15px; }
        .icon-option { width: 50px; height: 50px; font-size: 24px; display: flex; align-items: center; justify-content: center; border: 3px solid #000; border-radius: 6px; cursor: pointer; transition: all var(--transition-speed); }
        .icon-option:hover { border-color: #000; background: #f0f9ff; transform: scale(1.1); }

        .tab-navigation { 
            background: white; 
            border-radius: 12px; 
            border: 3px solid #000;
            margin-bottom: 20px; 
            display: flex; 
            overflow: hidden;
            padding: 6px;
        }
        .tab-btn { 
            flex: 1; 
            padding: 14px 20px; 
            background: transparent; 
            border: none; 
            border-radius: 8px;
            cursor: pointer; 
            font-size: 15px; 
            font-weight: 600; 
            color: #666; 
            transition: all 0.2s ease;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            position: relative;
        }
        .tab-btn:hover { 
            background: #f5f5f5; 
            color: #000;
        }
        .tab-btn.active { 
            color: white; 
            background: #000;
        }
        /* Day Jump Navigator */
        .day-jump-container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px 20px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 90;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .day-jump-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .day-jump-close-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .day-jump-close-btn:hover {
            background: #fecaca;
            transform: scale(1.1);
        }
        .day-jump-toggle {
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.3s;
            padding: 4px;
        }
        .day-jump-toggle.collapsed {
            transform: rotate(-90deg);
        }
        .day-jump-content {
            display: block;
        }
        .day-jump-content.collapsed {
            display: none;
        }
        .day-jump-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .day-jump-label {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }
        .day-jump-input {
            width: 80px;
            padding: 8px 12px;
            border: 3px solid #000;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }
        .day-jump-input:focus {
            outline: none;
            border-color: #000;
        }
        .day-jump-go-btn {
            padding: 8px 20px;
            background: #0d9488;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .day-jump-go-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .day-jump-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
            gap: 6px;
            max-width: 100%;
        }
        .day-jump-box {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 3px solid #000;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }
        .day-jump-box:hover {
            border-color: #000;
            background: #eff6ff;
            color: #0d9488;
            transform: translateY(-2px);
        }
        .day-jump-box.completed {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        .day-jump-box.completed:hover {
            background: #059669;
            border-color: #059669;
        }
        .day-jump-box.current {
            border-color: #000;
            background: #0d9488;
            color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .tab-content { 
            display: none;
            height: 100%;
            overflow-y: auto;
        }
        .tab-content.active { 
            display: block;
        }

        .map-section { background: white; padding: 28px; border-radius: 12px; border: 3px solid #000; margin-bottom: 24px; }
        .map-section h3 { font-size: 16px; margin-bottom: 15px; }
        .map-container { width: 100%; height: 500px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; }
        .map-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .map-btn { padding: 8px 16px; background: white; border: 3px solid #000; color: #0d9488; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all var(--transition-speed); }
        .map-btn:hover { background: #0d9488; color: white; }
        .map-btn.active { background: #0d9488; color: white; }
        .route-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .route-stat-card { background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 3px solid #0d9488; }
        .route-stat-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .route-stat-value { font-size: 20px; font-weight: 600; color: #111; }
        .location-marker-popup { font-size: 13px; }
        .location-marker-popup strong { display: block; margin-bottom: 5px; font-size: 14px; }
        .map-loading { padding: 20px; text-align: center; color: #666; font-style: italic; }
        .route-arrow { 
            background: none !important; 
            border: none !important; 
            font-size: 20px; 
            color: #0d9488; 
            text-shadow: 0 0 3px white;
        }

        .location-item { display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #0d9488; cursor: move; }
        .location-item.dragging { opacity: 0.5; }
        .location-item.drag-over { border-top: 3px solid #0d9488; }

        .checklist-item {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .checklist-item.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        .checklist-item.drag-over {
            background-color: #e3f2fd;
            border-top: 2px solid #0d9488;
        }

        /* Reduce spacing between checklist items */
        .checklist-items,
        .checklist-items.trip-items-container {
            gap: 6px !important;
            margin-bottom: 15px !important;
        }
        
        .checklist-item {
            margin: 0 !important; /* Remove any margin between items */
        }

        @media print {
            /* Hide everything by default */
            body > *:not(#printContainer) {
                display: none !important;
            }

            @page {
                margin: 0.4in;
                size: letter portrait;
            }
            
            body {
                margin: 0;
                padding: 0;
                font-size: 11pt;
            }
            
            #printContainer {
                display: block !important;
                visibility: visible !important;
                position: static !important;
                width: 100% !important;
            }
            
            .container {
                display: none !important;
            }
            
            /* Compact print pages */
            .print-page {
                page-break-after: always;
                page-break-inside: avoid;
                padding: 20px;
                background: white !important;
                width: 100%;
            }
            
            .print-page:last-child {
                page-break-after: avoid;
            }
            
            /* Print header - compact */
            .print-page h1 {
                font-size: 20pt;
                margin: 0 0 8px 0;
                border-bottom: 2px solid #000;
                padding-bottom: 8px;
            }
            
            .print-page h2 {
                font-size: 14pt;
                margin: 12px 0 6px 0;
            }
            
            .print-page h3 {
                font-size: 12pt;
                margin: 8px 0 4px 0;
            }
            
            /* Compact tables */
            .print-page table {
                width: 100%;
                border-collapse: collapse;
                font-size: 10pt;
                margin: 8px 0;
            }
            
            .print-page table th,
            .print-page table td {
                padding: 6px 8px;
                border: 1px solid #333;
                text-align: left;
            }
            
            .print-page table th {
                background: #f0f0f0;
                font-weight: 700;
            }
            
            /* Compact day entries */
            .print-day {
                margin: 8px 0;
                padding: 10px;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            
            .print-footer {
                display: none !important;
            }
            
            /* Ensure colors print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* Category cards in print - larger and clearer */
            .print-page div[style*="padding:15px"][style*="background:#f9fafb"] {
                padding: 18px !important;
                margin-bottom: 12px !important;
                background: #f9fafb !important;
                border: 2px solid #e5e7eb !important;
            }
            
            .print-page div[style*="padding:15px"] h3 {
                font-size: 13pt !important;
                margin-bottom: 8px !important;
            }
            
            .print-page div[style*="padding:15px"] div[style*="font-size:15px"] {
                font-size: 12pt !important;
                margin-bottom: 6px !important;
            }
            
            .print-page div[style*="padding:15px"] div[style*="font-size:14px"] {
                font-size: 11pt !important;
                line-height: 1.5 !important;
            }
            
            /* Force light mode for print */
            .print-page,
            .print-page * {
                background: white !important;
                color: #000 !important;
            }
            
            .print-page div[style*="background:#f9fafb"],
            .print-page div[style*="background:#f0fdfa"],
            .print-page div[style*="background:#fafafa"] {
                background: #f9fafb !important;
            }
            
            .print-page div[style*="border-left:4px solid"] {
                border-left-width: 4px !important;
            }
            
            #printContainer,
            #printContainer * {
                visibility: visible;
            }
            
            #printContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            /* Hide all non-print elements */
            .header, .tab-navigation, .stats, .search-bar, .control-bar, 
            .toggle, .converter, .daily-budget, .btn, .edit-btn, 
            .photo-upload, .photo-delete, .day-control-btn, .map-section,
            .analytics-cards-section, .day-jump-container, .fab, .scroll-to-top,
            .settings-overlay, .custom-modal-overlay, .export-menu { 
                display: none !important; 
            }
            
            /* Print-specific styles - LARGER TEXT */
            .print-page {
                page-break-after: always;
                padding: 40px;
                background: white;
                font-size: 14pt; /* INCREASED */
            }
            
            .print-page:last-child {
                page-break-after: avoid;
            }
            
            .print-header {
                margin-bottom: 30px;
                border-bottom: 2px solid #333;
                padding-bottom: 15px;
            }
            
            .print-title {
                font-size: 28pt; /* INCREASED from 24px */
                font-weight: 700;
                color: #111;
                margin-bottom: 5px;
            }
            
            .print-subtitle {
                font-size: 16pt; /* INCREASED from 14px */
                color: #666;
            }
            
            .print-day-header {
                background: #f5f5f5;
                padding: 20px; /* INCREASED from 15px */
                border-radius: 8px;
                margin-bottom: 25px; /* INCREASED */
            }
            
            .print-day-title {
                font-size: 24pt; /* INCREASED from 20px */
                font-weight: 700;
                margin-bottom: 8px;
            }
            
            .print-day-meta {
                font-size: 14pt; /* INCREASED from 12px */
                color: #666;
            }
            
            .print-section {
                margin-bottom: 25px; /* INCREASED */
                padding: 20px; /* INCREASED */
                border-left: 4px solid #0d9488; /* THICKER */
                background: #f9fafb;
            }
            
            .print-section-title {
                font-size: 14pt; /* INCREASED from 12px */
                text-transform: uppercase;
                color: #666;
                font-weight: 700;
                margin-bottom: 10px;
            }
            
            .print-section-content {
                font-size: 16pt; /* INCREASED from 14px */
                color: #111;
                line-height: 1.8; /* INCREASED for readability */
            }
            
            .print-cost {
                font-weight: 700;
                color: #111;
                margin-top: 8px;
                font-size: 16pt; /* INCREASED */
            }
            
            /* SCHEDULE SPECIFIC - MAKE IT BIG */
            .print-section.schedule-section {
                page-break-inside: avoid;
            }
            
            .print-schedule-item {
                display: grid;
                grid-template-columns: 120px 1fr;
                gap: 20px;
                padding: 15px;
                border-bottom: 2px solid #e5e7eb;
                font-size: 16pt; /* INCREASED */
            }
            
            .print-schedule-time {
                font-weight: 700;
                font-size: 18pt; /* INCREASED */
                color: #0d9488;
            }
            
            .print-schedule-activity {
                font-size: 16pt; /* INCREASED */
                line-height: 1.6;
            }
            
            .print-footer {
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #ddd;
                font-size: 12pt; /* INCREASED from 11px */
                color: #999;
                text-align: center;
            }
        }

        /* Print Settings Modal */
        .print-settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .print-settings-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .print-settings-body {
            padding: 25px;
        }

        .print-settings-section {
            margin-bottom: 25px;
        }

        .print-settings-section h4 {
            font-size: 14px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .print-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .print-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .print-checkbox-item:hover {
            background: #f9fafb;
        }

        .print-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .print-checkbox-item label {
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .print-radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .print-radio-item {
            display: flex;
            align-items: start;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .print-radio-item:hover {
            background: #f9fafb;
        }

        .print-radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
        }

        .print-radio-item label {
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .print-radio-item .radio-desc {
            font-size: 12px;
            color: #6b7280;
            margin-top: 3px;
        }

        .print-settings-footer {
            padding: 20px 25px;
            border-top: 2px solid #e5e7eb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /*Recipt stuff*/
        .receipt-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .receipt-upload {
            margin-bottom: 15px;
        }
        .receipt-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .receipt-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .receipt-details {
            flex: 1;
        }
        .receipt-details input,
        .receipt-details select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .receipt-analytics {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .receipt-header:hover {
            background: #f3f4f6;
        }
        .receipt-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }


        .gallery-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f0fdfa 0%, white 100%);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(13,148,136,0.1);
            border: 2px solid #99f6e4;
        }
        .gallery-view-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            color: #6b7280;
        }
        .gallery-view-btn:hover {
            border-color: #0d9488;
            color: #0d9488;
            background: #f0fdfa;
        }
        .gallery-view-btn.active {
            border-color: #0d9488;
            background: linear-gradient(135deg, #0d9488 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(13,148,136,0.3);
        }
        .gallery-timeline {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .gallery-day-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 2px solid #e5e7eb;
        }
        .gallery-day-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0fdfa;
            padding-left: 12px;
            border-left: 4px solid #0d9488;
        }
        .gallery-day-header h3 {
            margin: 0 0 5px 0;
            font-size: 20px;
            color: #0d9488;
            font-weight: 700;
        }
        .gallery-day-location {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .gallery-photo-count {
            font-size: 12px;
            color: #9ca3af;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .gallery-grid-all {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .gallery-photo-item {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .gallery-photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .gallery-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gallery-photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 15px 10px 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .gallery-photo-item:hover .gallery-photo-overlay {
            opacity: 1;
        }
        .gallery-photo-day {
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .gallery-photo-location {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
        }
        .gallery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .photo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .photo-header:hover {
            background: #f3f4f6;
        }
        .photo-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }


        .trip-manager-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .trip-manager-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .trip-comparison-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        .trip-comparison-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr 1.5fr 1.5fr 1fr;
            gap: 15px;
            padding: 12px 15px;
            background: #f9fafb;
            font-weight: 600;
            font-size: 13px;
            color: #6b7280;
            text-transform: uppercase;
        }
        .trip-comparison-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr 1.5fr 1.5fr 1fr;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: background 0.2s;
        }
        .trip-comparison-row:hover {
            background: #f9fafb;
        }
        .trip-comparison-row.current {
            background: #eff6ff;
            border-left: 4px solid #0d9488;
        }
        .trip-list {
            display: grid;
            gap: 15px;
        }
        .trip-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: all var(--transition-speed);
        }
        .trip-card:hover {
            border-color: #000;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        .trip-card.current-trip {
            border-color: #000;
            background: #eff6ff;
        }
        .trip-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .current-badge {
            background: #0d9488;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .trip-card-info {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        .trip-card-dates {
            font-size: 13px;
            color: #999;
            margin-bottom: 15px;
        }
        .trip-card-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .trip-comparison-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
        }

        .trends-chart {
            min-height: 200px;
        }
        .comparison-card {
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .comparison-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .comparison-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .comparison-sub {
            font-size: 13px;
            opacity: 0.8;
        }
        .timeline-container {
            padding: 20px 10px;
        }
        .timeline-item {
            display: grid;
            grid-template-columns: 40px 1fr;
            gap: 20px;
            margin-bottom: 10px;
        }
        .timeline-marker {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .timeline-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #e0e0e0;
            z-index: 1;
            transition: all var(--transition-speed);
        }
        .timeline-item.completed .timeline-dot {
            background: #10b981;
            box-shadow: 0 0 0 2px #10b981;
        }
        .timeline-line {
            width: 2px;
            flex: 1;
            background: #e0e0e0;
            margin-top: 4px;
        }
        .timeline-item.completed .timeline-line {
            background: linear-gradient(to bottom, #10b981, #e0e0e0);
        }
        .timeline-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #e0e0e0;
            transition: all var(--transition-speed);
        }
        .timeline-item.completed .timeline-content {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .timeline-content:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }
        .timeline-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .timeline-location {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 6px;
        }
        .timeline-spending {
            font-size: 14px;
            color: #0d9488;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .timeline-note {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }


        .export-menu {
            margin-top: 15px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 3px solid #000;
        }
        .export-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 15px;
            background: white;
            border: 3px solid #000;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed);
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }
        .export-btn:hover {
            border-color: #000;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        .export-btn:active {
            transform: translateY(0);
        }
        @media print {
            body * {
                visibility: hidden;
            }
            
            #app, #app * {
                visibility: visible;
            }
            
            #app {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .header-btn, .btn, .edit-btn, .tab-navigation, 
            .control-bar, .export-menu, .map-section,
            .photo-modal, .search-bar {
                display: none !important;
            }
            
            .day-card {
                background: white;
                margin-bottom: 15px;
                border-radius: 12px; /* Rounder corners */
                border: none; /* Remove border */
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); /* Subtle shadow */
                transition: all 0.2s ease;
                overflow: hidden;
            }

            .day-card:hover {
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12); /* Lift on hover */
                transform: translateY(-2px);
            }

            .day-card.done {
                opacity: 0.8;
                border-left: 4px solid #10b981;
                background: linear-gradient(to right, #f0fdf4 0%, white 10%); /* Subtle green tint */
            }
            
            .stats {
                page-break-after: avoid;
            }
        }
        

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .trip-selector {
            padding: 8px 12px;
            border: 3px solid #000;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            max-width: 200px;
        }
        .header-button-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .header-grid-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 10px;
            background: white;
            border: 3px solid #000;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed);
            min-width: 70px;
            height: 70px;
        }
        .header-grid-btn:hover {
            border-color: #000;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }
        .header-grid-btn .btn-icon {
            font-size: 24px;
        }
        .header-grid-btn .btn-label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
        }

        /* Settings Full Page */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5099;
            animation: fadeIn 0.2s;
        }
        .settings-page {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(700px, 90%);
            max-height: 85vh;
            background: white;
            border: 3px solid #000;
            border-radius: 12px;
            z-index: 2001;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.2s;
            overflow: hidden;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -45%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 3px solid #000;
            background: white;
            flex-shrink: 0;
        }
        .settings-header h2 {
            color: #000;
            font-weight: 800;
            font-size: 20px;
        }
        .settings-menu-grid {
            display: grid;
            gap: 15px;
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        .settings-menu-card {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
            padding: 25px;
            background: white;
            border: 3px solid #000;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .settings-menu-card:hover {
            border-color: #000;
            background: #fafafa;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .settings-card-icon {
            font-size: 28px;
        }
        .settings-card-title {
            font-size: 18px;
            font-weight: 700;
            color: #000;
            margin-bottom: 4px;
        }
        .settings-card-desc {
            font-size: 13px;
            color: #666;
        }
        .settings-card-arrow {
            font-size: 24px;
            color: #000;
            font-weight: 700;
        }
        .settings-content-page {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            margin: 20px 30px 0;
            background: white;
            border: 2px solid #0d9488;
            color: #0d9488;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .back-button:hover {
            background: #0d9488;
            color: white;
        }

        .settings-form-group {
            margin-bottom: 30px;
        }
        .settings-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
            color: #374151;
        }
        .settings-input {
            width: 100%;
            padding: 12px;
            border: 3px solid #000;
            border-radius: 8px;
            font-size: 16px;
            transition: all var(--transition-speed);
        }
        .settings-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .info-box {
            padding: 15px;
            background: #f9fafb;
            border: 3px solid #000;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            line-height: 1.6;
        }

        /* Analytics Cards Section */
        .analytics-cards-section {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .analytics-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .analytics-card {
            background: white;
            border: 3px solid #000;
            border-left: 5px solid #0d9488;  /* Teal accent */
            border-radius: 10px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .analytics-card:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
            border-color: #000;
            border-left-color: #0d9488;
        }
        
        .analytics-card-icon {
            font-size: 32px;       /* Reduced from 40px */
            margin-bottom: 10px;   /* Reduced from 14px */
        }
        .analytics-card-title {
            font-size: 15px;       /* Reduced from 17px */
            font-weight: 900;
            color: #000;
            margin-bottom: 6px;    /* Reduced from 8px */
            letter-spacing: -0.3px;
        }
        .analytics-card-desc {
            font-size: 12px;       /* Reduced from 13px */
            color: #6b7280;
            font-weight: 600;
            line-height: 1.4;      /* Reduced from 1.5 */
        }
        .analytics-card-arrow {
            font-size: 20px;       /* Reduced from 24px */
            color: #000;
            font-weight: 900;
        }

        /* Analytics Page - Centered Modal */
        .analytics-page {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(1000px, 90vw);
            max-height: 85vh;
            background: white;
            border: 3px solid #000;
            z-index: 2001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            animation: modalZoomIn 0.3s;
            overflow: hidden;
        }

        @keyframes modalZoomIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: white;
            border-bottom: 3px solid #000;
            gap: 20px;
        }
        
        .analytics-header h2 {
            color: #000;
            font-weight: 800;
        }

        .analytics-content {
            flex: 1;
            overflow-y: auto;
            background: #fafafa;
        }
        
        /* Prevent body scroll when ANY modal is open */
        body:has(.analytics-page),
        body:has(.settings-full-page),
        body:has(.day-detail-modal),
        body:has(.custom-modal),
        body:has(.day-section-page) {
            overflow: hidden !important;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #666;
        }
        .empty-state h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #000;
            font-weight: 700;
        }
        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* Export Page */
        .export-page {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(800px, 90%);
            max-height: 85vh;
            background: white;
            border: 3px solid #000;
            border-radius: 12px;
            z-index: 2001;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.2s;
            overflow: hidden;
        }

        .export-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: linear-gradient(135deg, #0d9488 0%, #2563eb 100%);
            border-bottom: none;
            gap: 20px;
            flex-shrink: 0;
        }
        
        .export-page-header h2 {
            color: white;
            font-weight: 800;
            font-size: 20px;
        }

        .export-page-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fafafa;
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .export-option-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 30px 20px;
            background: white;
            border: 3px solid #000;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .export-option-card:hover {
            border-color: #000;
            background: #fafafa;
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
        }

        .export-card-icon {
            font-size: 48px;
        }

        .export-card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .export-card-desc {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        /* Day Activities Cards */
        .day-activities-cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin: 6px 0;
        }

        .day-activity-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 7px 6px;
            background: white;
            border: 3px solid #000;
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-align: center;
        }

        .day-activity-card:hover {
            border-color: #000;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .day-card-icon {
            font-size: 18px;
        }

        .day-card-title {
            font-size: 11px;
            font-weight: 600;
            color: #1f2937;
        }

        .day-card-badge {
            font-size: 10px;
            color: #6b7280;
            padding: 2px 6px;
            background: #f3f4f6;
            border-radius: 10px;
        }

        /* Day Section Page */
        .day-section-page {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: min(900px, 100%);
            background: white;
            z-index: 5100;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            animation: slideInRight 0.3s;
        }

        .day-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-bottom: 2px solid #e5e7eb;
            color: #1f2937;
            gap: 15px;
        }

        .day-section-content {
            flex: 1;
            overflow-y: auto;
            background: #f9fafb;
        }

        .timeline-hour-row {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 15px;
            border-bottom: 1px solid #f0f0f0;
            min-height: 60px;
        }

        .timeline-hour-row:last-child {
            border-bottom: none;
        }

        .timeline-hour-label {
            padding: 10px 0;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }

        .timeline-hour-cell {
            padding: 10px 0;
            cursor: pointer;
            position: relative;
            min-height: 60px;
        }

        .timeline-hour-cell:hover {
            background: #f9fafb;
        }

        .timeline-hours {
            display: flex;
            flex-direction: column;
        }

        .event-drag-handle {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .timeline-event:hover .event-drag-handle {
            opacity: 1;
        }

        .event-drag-handle:hover {
            background: rgba(255,255,255,0.3) !important;
        }

        .timeline-event {
            user-select: none;
        }

        /* Custom Modal System */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999999; /* Very high to ensure it's on top */
            animation: fadeIn 0.2s;
        }

        .custom-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            border: 3px solid #000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 99999999; /* Even higher than overlay */
            min-width: 400px;
            max-width: 500px;
            animation: slideUp 0.3s;
        }

        .custom-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 2px solid #e5e7eb;
        }

        .custom-modal-body {
            padding: 25px;
        }

        .custom-modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px 25px;
            border-top: 2px solid #e5e7eb;
            background: #fafafa;
            border-radius: 0 0 10px 10px;
        }

        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: white;
            color: #000;
            border: 3px solid #000;
        }

        .modal-btn-cancel:hover {
            background: #f5f5f5;
        }

        .modal-btn-confirm {
            background: #000;
            color: white;
            border: 3px solid #000;
        }

        .modal-btn-confirm:hover {
            background: #333;
        }

        /* Day Activities Grid */
        .day-activities-grid {
            margin: 4px 0;
        }

        .category-card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .category-card, .notes-card {
            background: white;
            border: 3px solid #000;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            flex-direction: column;
            min-height: 180px;
        }

        .category-card:hover, .notes-card:hover {
            border-color: #000;
            background: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .notes-card {
            grid-column: 1 / -1; /* Makes notes card span full width */
            background: #ffffff;
            border-color: #f59e0b;
        }

        .category-card-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .category-card-icon {
            font-size: 20px;     /* Reduced from 24px */
            width: 32px;         /* Reduced from 40px */
            height: 32px;        /* Reduced from 40px */
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;  /* Reduced from 8px */
        }

        .category-card-title {
            font-size: 14px;     /* Reduced from 16px */
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;  /* Reduced from 6px */
            letter-spacing: -0.3px;
        }

        .category-card-content {
            flex: 1;
            font-size: 13px;     /* Reduced from 14px */
            color: #6b7280;
            line-height: 1.4;    /* Reduced from 1.5 */
            margin-bottom: 10px; /* Reduced from 15px */
            height: 48px;        /* Reduced from 60px */
            white-space: pre-line;  /* Preserve line breaks but collapse spaces */
            word-wrap: break-word;  /* Break long words */
            
            /* Modern line clamping */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            
            /* Standard property for future browsers */
            line-clamp: 3;
            max-lines: 3;
            
            /* Fallback for very old browsers */
            max-height: 4.5em;
            position: relative;
        }

        /* Optional: Add gradient fade for browsers without proper ellipsis */
        @supports not ((-webkit-line-clamp: 3) or (line-clamp: 3)) {
            .category-card-content::after {
                content: '';
                position: absolute;
                bottom: 0;
                right: 0;
                width: 40px;
                height: 1.5em;
                background: linear-gradient(to right, transparent, #f9fafb 70%);
                pointer-events: none;
            }
        }

        .category-card-cost {
            font-size: 13px;     /* Reduced from 14px */
        }

        .planned-cost {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 3px;  /* Reduced from 4px */
        }

        .actual-cost {
            font-size: 12px;     /* Reduced from 13px */
            color: #10b981;
            font-weight: 600;
        }
        
        /* COMPREHENSIVE COMPACT MODE - Reduce all spacings */
        .day-card-wrapper .details {
            padding: 12px 16px !important;  /* Reduced from default larger padding */
        }
        
        .day-card-wrapper .section {
            margin-bottom: 4px !important;
        }
        
        .day-card-wrapper .category-card-grid {
            gap: 6px !important;
            margin-bottom: 6px !important;
        }
        
        .day-card-wrapper .category-card,
        .day-card-wrapper .notes-card {
            padding: 7px 9px !important;
            min-height: 0 !important;
        }
        
        /* Reduce text sizes in expanded content */
        .day-card-wrapper .category-card-title {
            font-size: 13px !important;      /* Even smaller in day cards */
        }
        
        .day-card-wrapper .category-card-content {
            font-size: 11px !important;
            height: 24px !important;
            overflow: hidden !important;
            margin-bottom: 2px !important;
        }
        
        .day-card-wrapper .category-card-icon {
            font-size: 18px !important;
            width: 30px !important;
            height: 30px !important;
        }
        
        /* Compact actual spending section */
        .day-card-wrapper .section.yellow {
            margin-top: 10px !important;
        }
        
        .day-card-wrapper .section.yellow h4 {
            font-size: 13px !important;
        }
        
        .day-card-wrapper .section.yellow p {
            font-size: 10px !important;
        }
        
        /* Compact day activities grid */
        .day-activities-grid {
            gap: 10px !important;
        }
        
        /* Custom tooltip for truncated text */
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10000;
            pointer-events: none;
            margin-bottom: 5px;
        }
        
        [title] {
            position: relative;
        }
        
        /* GLOBAL COMPACT RULES - Reduce spacing everywhere */
        
        /* Hero stats on home page */
        div[style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] {
            gap: 15px !important;             /* Reduced from 20px */
            margin-bottom: 20px !important;   /* Reduced from 30px */
        }
        
        div[style*="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))"] > div {
            padding: 16px !important;         /* Reduced from 20px */
            border-radius: 10px !important;   /* Reduced from 12px */
        }
        
        /* Reduce all h2/h3 margins */
        h2 {
            margin-bottom: 14px !important;   /* Reduced */
        }
        
        h3 {
            margin-bottom: 10px !important;   /* Reduced */
        }
        
        /* Checklist cards */
        .analytics-cards-section {
            margin-bottom: 20px !important;
        }
        
        /* Compact progress bars */
        .progress {
            margin-bottom: 15px !important;
        }
        
        /* Search bar */
        .search-bar {
            margin-bottom: 12px !important;
        }
        
        /* Day jump container */
        .day-jump-container {
            margin-bottom: 15px !important;
            padding: 12px !important;
        }

        /* Today Tab Styles */
        .today-hero {
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .today-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .today-action-card {
            background: white;
            padding: 25px;
            border: 3px solid #000;
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-align: center;
        }

        .today-action-card:hover {
            border-color: #000;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }


        /* Edit Link Style */
        .edit-day-link {
            color: #0d9488;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            transition: all var(--transition-speed);
            text-decoration: none;
            border: 1px solid transparent;
        }
        .edit-day-link:hover {
            background: #f0f9ff;
            border-color: #dbeafe;
        }

        /* Save Button Style */
        .save-edit-btn {
            color: #0d9488;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
        }
        .save-edit-btn:hover {
            background: #f0f9ff;
            border-color: #dbeafe;      
        }

        /* Toast Notifications - Professional Feedback */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10001;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
        }

        .toast.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
        }

        .toast.info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
        }

        /* Floating Action Button - Professional Pattern */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0d9488, #2563eb);
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            z-index: 4996; /* Below mobile panel (5000) */
            display: none;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed);
            -webkit-tap-highlight-color: transparent; /* Remove iOS tap highlight */
            touch-action: manipulation; /* Prevent double-tap zoom */
        }

        .fab:active {
            transform: scale(0.9);
            background: linear-gradient(135deg, #2563eb, #1d4ed8); /* Darker on tap */
        }

        /* Scroll to Top Button */
        .scroll-to-top {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            color: #0d9488;
            border: 3px solid #000;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            cursor: pointer;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed);
            opacity: 0;
        }

        .scroll-to-top.show {
            display: flex;
            opacity: 1;
        }

        .scroll-to-top:hover {
            background: #0d9488;
            color: white;
            transform: translateY(-2px);
        }

        .scroll-to-top:active {
            transform: scale(0.9);
        }

        /* Day Detail Modal */
        .day-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s;
        }

        .day-detail-content {
            background: white;
            border-radius: 12px;
            border: 3px solid #000;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        .day-detail-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 20px 30px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-radius: 10px 10px 0 0;
        }

        .day-detail-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f5f5f5;
            border: 3px solid #000;
            font-size: 24px;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .day-detail-close:hover {
            background: #000;
            color: white;
            border-color: #000;
            transform: rotate(90deg);
        }

        .day-detail-body {
            padding: 30px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .day-detail-modal {
                padding: 0;
            }
            
            .day-detail-content {
                max-height: 100vh;
                border-radius: 0;
                height: 100%;
            }
            
            .day-detail-header {
                border-radius: 0;
            }
            
            .day-detail-body {
                padding: 20px;
            }
        }

        /* Pull to Refresh - Native-like Loading */
        .pull-to-refresh {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: top 0.3s;
            z-index: 9999;
        }

        .pull-to-refresh.pulling {
            top: 20px;
        }

        .pull-to-refresh-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f0f0f0;
            border-top-color: #0d9488;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .fab {
                display: flex; /* Show on mobile */
            }
        }

        /* Swipeable Cards - iOS-style Interaction */
        .swipeable-card {
            position: relative;
            touch-action: pan-y;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .swipeable-card.swiping {
            transition: none;
        }

        .category-card {
            background: white;
            border: 3px solid #000;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            min-height: 180px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
            border-color: currentColor;
        }

        .category-card-content {
            flex: 1;
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 15px;
            height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        /* ============================================ */
        /* ========================================== */
        /* MOBILE STYLES - EXTENDED COMPONENTS */
        /* Modals, forms, specialized components, responsive overrides */
        /* Lines 4670-5997 (Main consolidated mobile CSS) */
        /* ========================================== */
        @media (max-width: 768px) {
            /* Force everything to respect viewport */
            body {
                padding: 10px !important;
                overflow-x: hidden !important;
            }
            
            .container {
                max-width: 900px;
                margin: 0 auto;
                padding: 0 20px; /* Add horizontal padding */
            }

            /* Better section spacing */
            .stats,
            .chart-container,
            .category-budget-section,
            .map-section {
                margin-bottom: 32px; /* More breathing room */
            }
            /* Card internal spacing */
            .stat-card,
            .day-card,
            .analytics-card {
                padding: 24px; /* Consistent padding */
            }
            /* Better gap in grids */
            .stats,
            .analytics-cards-grid {
                gap: 20px; /* More space between cards */
            }
            
            /* ===== HEADER ===== */
            .header {
                position: sticky !important;
                top: 0 !important;
                z-index: 102 !important; /* Highest - on top of everything */
                margin-bottom: 15px;
                border-radius: 0 0 12px 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                padding: 12px 15px !important; /* Compact on mobile */
                background: white !important;
            }
            
            .header h1 {
                font-size: 32px;
                font-weight: 700;
                margin-bottom: 8px;
                color: #111 !important; /* Black title */
            }
            
            .header .subtitle {
                color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
                font-size: 15px;
            }
            
            .header > div:first-child {
                flex-direction: row !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 10px !important;
            }

            .header-actions {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                gap: 4px !important;
                flex-shrink: 0 !important;
            }

            .trip-selector {
                display: none !important; /* Hide on mobile to save space */
            }

            .header-button-grid {
                display: flex !important;
                flex-direction: row !important;
                gap: 4px !important;
            }

            .header-grid-btn {
                padding: 6px 4px !important;
                min-width: 0 !important;
                width: 40px !important;
                height: 40px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
            }

            .header-grid-btn .btn-icon {
                font-size: 16px !important;
            }

            .header-grid-btn .btn-label {
                font-size: 8px !important;
                text-align: center !important;
                line-height: 1 !important;
                margin-top: 2px !important;
            }

            .header {
                position: sticky;
                top: 0;
                z-index: 101;
                margin-bottom: 15px;
                border-radius: 0 0 12px 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                padding: 20px 15px;
                transition: padding 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .header h1 {
                transition: font-size 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
                
                
            /* Title - show/hide elements based on scroll */
            .header h1 {
                font-size: 20px !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                margin-bottom: 8px;
            }
                
            /* Subtitle - hide when scrolled */
            .header .subtitle {
                color: #666 !important; /* Grey subtitle */
                opacity: 1;
                max-height: 60px; /* More space for wrapping */
                font-size: 14px !important; /* Bigger text */
                line-height: 1.5 !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                overflow: hidden;
                white-space: normal; /* Allow wrapping */
            } 

                
                /* Header actions - hide when scrolled */
                .header-actions {
                    opacity: 1;
                    max-height: 200px;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    overflow: hidden;
                }

                
                /* Container for title that stays visible */
                .header > div:first-child {
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }

                .header::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 40px;
                    height: 4px;
                    background: rgba(0, 0, 0, 0.1);
                    border-radius: 2px 2px 0 0;
                    transition: opacity 0.3s;
                }
            

            /* Make date inputs smaller to fit on one line */
            .header .subtitle input[type="date"] {
                padding: 4px 6px !important;
                font-size: 11px !important;
                max-width: 110px;
                border: 1px solid #ddd !important; /* Grey border */
                background: white !important; /* White background */
                color: #333 !important; /* Dark text */
                border-radius: 4px;
                    }
            
            .header .subtitle {
                display: flex;
                align-items: center;
                gap: 6px;
                flex-wrap: nowrap; /* Don't wrap */
            }
            
            /* ===== STATS CARDS ===== */
            .stats {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .stat-card {
                background: white;
                padding: 24px;
                border-radius: 16px;
                border: none; /* Remove border */
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                position: relative;
                overflow: hidden;
            }

            .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                width: 60px; /* Much smaller */
                height: 60px;
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), transparent); /* More subtle */
                border-radius: 0 16px 0 50%;
            }
            
            .stat-card.blue {
                background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                border: 1px solid #bfdbfe;
            }

            .stat-card.red {
                background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
                border: 1px solid #fecaca;
            }

            .stat-card.green {
                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                border: 1px solid #bbf7d0;
            }

            .stat-value {
                font-size: 32px; /* Bigger */
                font-weight: 700; /* Bolder */
                background: linear-gradient(135deg, #1f2937, #0d9488); /* Gradient text */
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            /* ===== DAY CARDS - THE BIG FIX ===== */
            .day-card {
                margin-bottom: 15px;
                overflow: hidden;
            }
            
            .day-header {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                justify-content: flex-start !important;
                gap: 10px !important;
                padding: 12px !important;
            }
            
            .day-info {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                gap: 10px !important;
                width: 100% !important;
            }
            
            .day-title {
                flex: 1;
                min-width: 0;
            }
            
            .day-title h3 {
                font-size: 15px !important;
                margin: 0 !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .day-title .date {
                font-size: 12px !important;
            }
            
            .day-cost {
                width: 100% !important;
                text-align: left !important;
                padding-top: 10px !important;
                border-top: 1px solid #e0e0e0 !important;
            }
            
            .day-cost .amount {
                font-size: 16px !important;
            }
            
            .day-cost .usd {
                font-size: 12px !important;
            }
            
            /* ===== CATEGORY CARDS IN DAY DETAILS ===== */
            .day-activities-grid {
                display: block !important;
            }
            
            .category-card-grid {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .category-card,
            .notes-card {
                width: 100% !important;
                min-height: auto !important;
            }
            
            .day-activities-cards {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }
            
            .day-activity-card {
                padding: 12px 8px !important;
                min-width: 0 !important;
            }
            
            .day-card-icon {
                font-size: 20px !important;
            }
            
            .day-card-title {
                font-size: 11px !important;
            }
            
            .day-card-badge {
                font-size: 9px !important;
                padding: 2px 6px !important;
            }
            
            /* ===== TAB NAVIGATION ===== */
            .tab-navigation-wrapper {
                position: sticky !important;
                top: 70px !important; /* Below header (header is ~70px tall on mobile) */
                z-index: 90 !important; /* Middle layer */
                margin-bottom: 15px;
            }

            .tab-navigation {
                background: white;
                border-radius: 8px;
                border: 1px solid #e0e0e0;
                display: flex;
                justify-content: center; /* CENTER THE TABS */
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .tab-navigation::-webkit-scrollbar {
                display: none;
            }

            .tab-btn {
                flex: 0 0 auto !important;
                min-width: 110px !important;
                font-size: 12px !important;
                padding: 10px 12px !important;
                white-space: nowrap !important;
            }


            /* ===== ANALYTICS CARDS SECTION ===== */
            .analytics-cards-section {
                margin: 20px 0 !important;
                padding: 15px !important;
            }
            
            .analytics-cards-section h3 {
                font-size: 18px !important;
                margin-bottom: 15px !important;
            }
            
            .analytics-cards-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
                margin-bottom: 20px !important;
            }
            
            .analytics-card {
                display: flex !important;
                flex-direction: column !important;
                padding: 12px 10px !important;
                min-height: 120px !important;
                max-width: 100% !important;
                gap: 12px !important;
                padding: 15px !important;
            }
            
            .analytics-card-icon {
                font-size: 28px !important;
                grid-row: 1 / 2;
            }
            
            .analytics-card-title {
                font-size: 15px !important;
                grid-row: 1;
                grid-column: 2;
            }
            
            .analytics-card-desc {
                font-size: 12px !important;
                grid-row: 2;
                grid-column: 1 / -1;
            }
            
            .analytics-card-arrow {
                display: none !important;
            }
            
            /* ===== ALL GRIDS ===== */
            .grid,
            .export-grid,
            .route-stats,
            .converter-inputs {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .converter-swap {
                transform: rotate(90deg);
            }
            
            .gallery-grid,
            .gallery-grid-all {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .gallery-controls {
                flex-direction: column !important;
                gap: 8px !important;
                padding: 12px !important;
            }
            
            .gallery-view-btn {
                width: 100% !important;
                padding: 10px !important;
                font-size: 13px !important;
            }
            
            .photo-gallery {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            
            /* ===== MAP ===== */
            .map-section {
                overflow: hidden;
            }
            
            .map-container {
                width: 100% !important;
                height: 250px !important;
                touch-action: pan-y !important;
            }
            
            /* Schedule timeline mobile fixes */
            .schedule-timeline {
                overflow-x: hidden !important;
            }
            .timeline-hours {
                width: 100% !important;
            }
            .timeline-hour-row.has-events,
            .timeline-empty-block {
                grid-template-columns: 52px 1fr !important;
                gap: 6px !important;
            }
            .timeline-hour-label {
                font-size: 10px !important;
                padding: 6px 4px !important;
                word-break: break-word !important;
            }
            .timeline-hour-cell {
                padding: 6px 4px !important;
                min-height: 40px !important;
            }
            .timeline-event {
                padding: 6px 8px !important;
                font-size: 12px !important;
            }
            .timeline-event-title {
                font-size: 12px !important;
            }
            /* Schedule view toggle */
            .schedule-view-toggle {
                flex-wrap: nowrap !important;
            }
            
            /* Map tab page: shrink the full-page map */
            .google-map-div {
                height: 55vw !important;
                min-height: 240px !important;
                max-height: 400px !important;
            }
            
            /* Map tab: remove large min-widths that cause overflow */
            .tab-content [style*="min-width:300px"] {
                min-width: 0 !important;
            }
            
            /* Map controls card: stack columns vertically */
            .tab-content [style*="flex-wrap:wrap-reverse"] {
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            /* Map control cards: full width, compact padding */
            .tab-content [style*="padding:20px;background:#f0fdfa"] {
                padding: 12px !important;
            }
            
            /* Route editor grid: single column */
            /* route editor grid handled by #routeEditorContent rule */
            
            /* Map page top card: compact */
            .tab-content [style*="padding:20px;border-radius:12px;border:3px solid #000;margin-bottom:20px"] {
                padding: 12px !important;
            }
            
            /* Animation buttons: stack/wrap nicely */
            .tab-content [style*="flex:1;min-width:300px"] {
                flex: 1 1 100% !important;
                min-width: 0 !important;
            }
            
            .map-controls {
                display: flex !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                gap: 5px !important;
            }
            
            .map-btn {
                flex: 0 0 auto !important;
                white-space: nowrap !important;
                font-size: 11px !important;
                padding: 6px 10px !important;
            }
            
            /* ===== MODALS - CRITICAL FIX FOR POSITION ===== */
            
            /* Small centered modals */
            .custom-modal::before {
                content: '';
                position: absolute;
                top: 12px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: #cbd5e1;
                border-radius: 2px;
            }
            
            .custom-modal-header {
                padding-top: 28px !important; /* Make room for handle */
            }

            .custom-modal::before {
                content: '';
                position: absolute;
                top: 12px;
                left: 50%; 
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: #cbd5e1;
                border-radius: 2px;
            }
            
            .custom-modal-header {
                padding-top: 28px !important; /* Make room for handle */
            }

            
            .custom-modal-body {
                max-height: 50vh !important;
                overflow-y: auto !important;
            }
            
            /* Side sliding modals - Full screen */
            .settings-page,
            .day-section-page,
            .export-page {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                max-width: 100vw !important;
                height: 100vh !important;
                transform: translateX(0) !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* Centered modals - Full screen with scroll */
            .analytics-page {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 90vh !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .analytics-header,
            .export-page-header,
            .day-section-header,
            .settings-header {
                flex-shrink: 0 !important;
                padding: 15px 20px !important;
            }
            
            .analytics-header h2,
            .export-page-header h2,
            .day-section-header h2,
            .settings-header h2 {
                font-size: 18px !important;
            }
            
            .analytics-content,
            .export-page-content,
            .day-section-content,
            .settings-menu-grid,
            .settings-content-page {
                flex: 1 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 15px !important;
            }
            
            /* Trip manager modal */
            .trip-manager-modal {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
                margin: 0 !important;
                padding: 20px !important;
            }
            
            /* Back buttons in modals */
            .back-button {
                margin: 10px 20px !important;
                padding: 8px 16px !important;
                font-size: 13px !important;
            }
            
            /* ===== SCHEDULE ===== */
            .schedule-hour {
                grid-template-columns: 100px 1fr auto !important;
                gap: 8px;
            }
            
            .schedule-time input {
                font-size: 12px;
            }
            
            /* ===== SEARCH ===== */
            .search-bar {
                padding: 10px 15px;
            }
            
            .search-input {
                font-size: 14px;
                padding: 10px 50px 10px 12px;
            }
            
            /* ===== TODAY TAB ===== */
            .today-hero {
                padding: 30px 20px;
            }
            
            .today-hero h1 {
                font-size: 24px;
            }
            
            .today-hero p {
                font-size: 16px;
            }
            
            /* ===== TRIP MANAGER ===== */
            .trip-comparison-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .trip-comparison-header,
            .trip-comparison-row {
                min-width: 600px;
                font-size: 11px;
                gap: 8px;
                padding: 10px;
            }
            
            /* ===== RECEIPTS ===== */
            .receipt-item {
                grid-template-columns: 1fr !important;
                flex-direction: column;
            }
            
            .receipt-details {
                grid-template-columns: 1fr !important;
            }
            
            /* ===== WEATHER ===== */
            .weather-display {
                grid-template-columns: 1fr !important;
            }
            
            /* ===== CHECKLISTS ===== */
            .checklist-item {
                flex-direction: column;
                align-items: stretch !important;
                gap: 8px;
            }
            
            .checklist-item input[type="text"] {
                width: 100% !important;
            }
            
            /* ===== CHARTS & TRENDS ===== */
            .trends-chart,
            .chart,
            .chart-bar {
                width: 100% !important;
                overflow-x: auto !important;
            }
            
            .chart-label {
                min-width: 80px !important;
                font-size: 11px !important;
            }
            
            .chart-value {
                min-width: 70px !important;
                font-size: 11px !important;
            }
            
            /* ===== PREVENT INPUT ZOOM ON iOS ===== */
            input,
            select,
            textarea {
                font-size: 16px !important;
            }
            
            /* ===== TOUCH TARGETS ===== */
            .btn,
            .header-btn,
            .edit-btn,
            .modal-btn {
                min-height: 44px;
                padding: 10px 16px;
                font-size: 14px !important;
            }
            
            .day-check,
            input[type="checkbox"] {
                min-width: 24px;
                min-height: 24px;
            }
            
            /* ===== PREVENT OVERFLOW ===== */
            .section-content {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            input[type="text"],
            input[type="number"],
            textarea {
                max-width: 100%;
            }
            
            /* ===== CATEGORY/NOTES MODAL FIX ===== */
            .custom-modal .custom-modal-body input,
            .custom-modal .custom-modal-body textarea {
                width: 100% !important;
                max-width: 100% !important;
            }
            /* ===== APP-LIKE IMPROVEMENTS ===== */

            /* Smooth scrolling everywhere */
            * {
                -webkit-overflow-scrolling: touch !important;
            }

            /* Remove tap highlight */
            * {
                -webkit-tap-highlight-color: transparent !important;
            }

            /* Better button press feedback */
            .btn:active,
            .header-btn:active,
            .analytics-card:active,
            .day-activity-card:active,
            .tab-btn:active {
                transform: scale(0.97) !important;
                transition: transform 0.1s !important;
            }

            /* Sticky header on scroll */
            .header {
                position: sticky !important;
                top: 0 !important;
                z-index: 100 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }

            /* Pull-to-refresh hint */
            body::before {
                content: '';
                position: fixed;
                top: -50px;
                left: 0;
                right: 0;
                height: 50px;
                background: linear-gradient(180deg, rgba(59,130,246,0.1), transparent);
                pointer-events: none;
            }

            /* Better card shadows on mobile */
            .day-card,
            .stat-card,
            .analytics-card,
            .today-card {
                box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
            }

            .day-card:active,
            .analytics-card:active {
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            }

            /* iOS-style swipe indicators */
            .tab-navigation::after {
                content: '';
                position: relative;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to left, white, transparent);
                pointer-events: none;
            }

            /* Safe area insets for iPhone notch */
            @supports (padding: max(0px)) {
                body {
                    padding-left: max(10px, env(safe-area-inset-left)) !important;
                    padding-right: max(10px, env(safe-area-inset-right)) !important;
                    padding-bottom: max(10px, env(safe-area-inset-bottom)) !important;
                }
            }
                .custom-modal-overlay {
                    background: rgba(0,0,0,0.35) !important;
                }
                
                .custom-modal {
                position: fixed !important;
                top: auto !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                transform: none !important;
                border-radius: 20px 20px 0 0 !important;
                max-height: 85vh !important;
                overflow-y: auto !important;
                min-width: 100% !important;
                max-width: 100% !important;
                animation: slideUpFromBottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }


            @keyframes slideUpFromBottom {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }

            .btn:active,
            .header-btn:active,
            .modal-btn:active,
            .analytics-card:active,
            .day-activity-card:active,
            .tab-btn:active {
                transform: scale(0.97) !important;
                opacity: 0.8;
                transition: transform 0.1s, opacity 0.1s !important;
            }
            
            /* Remove tap highlight color */
            * {
                -webkit-tap-highlight-color: transparent !important;
            }
            
            /* Better card interactions */
            .day-card,
            .analytics-card,
            .category-card {
                background: white;
                border: 3px solid #000;
                border-radius: 12px;
                padding: 20px;
                cursor: pointer;
                transition: all var(--transition-speed);
                display: flex;
                flex-direction: column;
                min-height: 180px;
                overflow: hidden; /* CRITICAL - prevents overflow */
            }

            .category-card-content {
                flex: 1;
                font-size: 14px;
                color: #6b7280;
                line-height: 1.5;
                margin-bottom: 15px;
                height: 60px;
                overflow: hidden;
                text-overflow: ellipsis;
                word-wrap: break-word; /* Break long words */
                overflow-wrap: break-word; /* Break long words */
                word-break: break-all; /* Break URLs */
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
            }
            /* Add gradient overlay based on category color */
            .category-card::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, var(--category-color), transparent);
            }
            .category-card:hover {
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
                transform: translateY(-2px);
            }
            .category-card-icon {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            /* Scale down notes card text */
            .category-card,
            .notes-card {
                width: 100% !important;
                min-height: 120px !important;
                overflow: hidden !important; /* Force overflow hidden */
                max-width: 100% !important;
            }
            
            .category-card-content {
                height: 50px !important;
                font-size: 12px !important;
                line-height: 1.4 !important;
                -webkit-line-clamp: 3 !important;
                word-break: break-all !important; /* Break long URLs */
                overflow-wrap: break-word !important;
            }
            
            .category-card-title {
                font-size: 14px !important;
            }

            /* Stat cards - 2 columns instead of 1 */
            .stats {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }
            
            .stat-card {
                padding: 16px !important;
            }
            
            .stat-value {
                font-size: 24px !important; /* Smaller */
            }
            
            .stat-label {
                font-size: 10px !important;
            }
            
            .stat-sub {
                font-size: 11px !important;
            }

            /* Compact day cards */
            .day-card {
                margin-bottom: 10px !important;
                border-radius: 10px !important;
            }
            
            .day-header {
                padding: 12px !important;
            }
            
            .day-num {
                width: 32px !important;
                height: 32px !important;
                font-size: 14px !important;
            }
            
            .day-title h3 {
                font-size: 14px !important;
            }
            
            .day-title .date {
                font-size: 11px !important;
            }
            
            .day-cost .amount {
                font-size: 15px !important;
            }
            
            .day-cost .usd {
                font-size: 11px !important;
            }

            /* Analytics cards - 2 per row */
            .analytics-cards-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }
            
            .analytics-card {
                padding: 16px !important;
            }
            
            .analytics-card-icon {
                font-size: 32px !important;
            }
            
            .analytics-card-title {
                font-size: 13px !important;
            }
            
            .analytics-card-desc {
                font-size: 11px !important;
            }

            /* Tighter overall spacing */
            body {
                padding: 12px !important;
            }
            
            .container {
                padding: 0 !important;
            }
            
            /* Reduce gaps between sections */
            .stats,
            .chart-container,
            .category-budget-section,
            .map-section,
            .analytics-cards-section {
                margin-bottom: 20px !important;
            }
            
            /* Compact section cards */
            .today-card,
            .chart-container,
            .category-budget-section {
                padding: 16px !important;
            }

            /* Category cards in day details - 2 columns */
            .category-card-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .category-card,
            .notes-card {
                padding: 14px !important;
                min-height: 120px !important;
            }
            
            .category-card-icon {
                width: 36px !important;
                height: 36px !important;
                font-size: 20px !important;
            }
            
            .category-card-title {
                font-size: 13px !important;
            }
            
            .category-card-content {
            font-size: 12px !important;
            display: -webkit-box !important;
            -webkit-box-orient: vertical !important;
            -webkit-line-clamp: 2 !important;
            line-clamp: 2 !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            }
            
            .category-card-cost {
                font-size: 12px !important;
            }

            /* Day activity cards - smaller */
            .day-activities-cards {
                gap: 10px !important;
            }
            
            .day-activity-card {
                padding: 12px 10px !important;
            }
            
            .day-card-icon {
                font-size: 24px !important;
            }
            
            .day-card-title {
                font-size: 12px !important;
            }
            
            .day-card-badge {
                font-size: 10px !important;
                padding: 3px 8px !important;
            }
            
            /* Fix category card title overflow */
            .category-card-title {
                font-size: 12px !important;
                word-break: break-word;
                hyphens: auto;
                line-height: 1.3;
            }
            
            .category-card-content {
                height: 50px !important; /* Fixed smaller height on mobile */
                font-size: 12px !important;
                line-height: 1.4 !important;
                -webkit-line-clamp: 3 !important;
            }
            
            .category-card-title {
                font-size: 12px !important;
                word-break: break-word;
                hyphens: auto;
            }

            .export-option-card {
                padding: 16px 12px !important;
            }
            
            .export-card-icon {
                font-size: 32px !important;
            }
            
            .export-card-title {
                font-size: 14px !important;
            }
            
            .export-card-desc {
                font-size: 11px !important;
            }

            .export-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
            }
            
            .export-option-card {
                padding: 16px 10px !important;
                min-height: 100px;
            }
            
            .export-card-icon {
                font-size: 28px !important;
                margin-bottom: 8px;
            }
            
            .export-card-title {
                font-size: 12px !important;
                line-height: 1.2;
            }
            
            .export-card-desc {
                font-size: 10px !important;
                display: none; /* Hide descriptions on mobile for space */
            }

            .checklist-item {
                padding: 6px !important;
                gap: 4px !important;
                flex-direction: row !important; /* Force horizontal */
                align-items: center !important;
            }
            
            .checklist-item .drag-handle {
                font-size: 10px !important;
                padding: 0 2px !important;
            }
            
            .checklist-item input[type="checkbox"] {
                width: 16px !important;
                height: 16px !important;
                flex-shrink: 0 !important;
            }
            
            .checklist-item input[type="text"] {
                font-size: 12px !important;
                padding: 4px 6px !important;
                min-width: 0 !important;
            }
            
            .checklist-item .btn {
                padding: 4px 6px !important;
                font-size: 14px !important;
            }


                /* Force progress sections to stack vertically on mobile */
            .day-section-content > div[style*="background:#fffbeb"],
            .day-section-content > div[style*="background:#ecfdf5"],
            .day-section-content > div[style*="background:#fafafa"] {
                padding: 15px !important;
            }
            
            /* Make progress circles smaller on mobile */
            .packing-progress-text,
            .before-progress-text,
            .trip-progress-text {
                font-size: 24px !important;
            }
            
            /* Ensure the flex container stacks properly */
            [style*="display:flex;flex-direction:column;align-items:center"] {
                width: 100% !important;
            }

            /* Keep prep cards side-by-side but make them smaller */
            .prep-card {
                min-height: 150px !important;
                padding: 10px 6px !important;
            }
            
            /* Smaller icons and titles */
            .prep-card > div:first-child {
                gap: 6px !important;
                margin-bottom: 6px !important;
            }
            
            .prep-card > div:first-child span:first-child {
                font-size: 22px !important; /* Smaller emoji */
            }
            
            .prep-card > div:first-child span:last-child {
                font-size: 11px !important; /* Smaller title */
                line-height: 1.1 !important;
            }
            
            /* Description */
            .prep-card .analytics-card-desc {
                font-size: 9px !important;
                margin-bottom: 8px !important;
            }
            
            /* Progress box - make it more compact */
            .prep-card > div[style*="background:#fafafa"],
            .prep-card > div[style*="background:#fafafa"] {
                padding: 5px 6px !important;
                margin-top: 6px !important;
            }
            
            .prep-card > div[style*="background:#fafafa"] > div:first-child,
            .prep-card > div[style*="background:#fafafa"] > div:first-child {
                font-size: 8px !important; /* "Progress" label */
                margin-bottom: 2px !important;
            }
            
            .packing-card-progress,
            .before-card-progress {
                font-size: 10px !important; /* Progress numbers */
            }
            
            /* Arrow */
            .prep-card .analytics-card-arrow {
                margin-top: 6px !important;
                font-size: 12px !important;
            }

            .day-jump-container {
                top: 120px !important; /* Below header (70px) + tabs (50px) */
                padding: 12px 15px;
                z-index: 88 !important; /* Bottom layer of sticky elements */
            }
            
            .day-jump-grid {
                grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
                gap: 4px;
            }
            
            .day-jump-box {
                width: 32px;
                height: 32px;
                font-size: 11px;
            }

            .day-jump-container {
                background: white;
                border-radius: 8px;
                border: 1px solid #e0e0e0;
                padding: 15px 20px;
                margin-bottom: 20px;
                position: sticky;
                top: 80px;  /* Below the minimized header */
                z-index: 90;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }


            .header.scrolled {
                padding: 12px 15px !important;
            }

            .header.scrolled h1 {
                font-size: 16px !important;
            }

            .header.scrolled .subtitle {
                opacity: 0;
                max-height: 0;
                margin: 0 !important;
            }

            /* CRITICAL: Keep the flex layout working */
            .header.scrolled > div:first-child {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 0 !important;
            }

            /* Keep title on left */
            .header.scrolled h1 {
                margin: 0 !important;
                flex: 0 1 auto !important;
            }

            /* Keep actions on right */
            .header.scrolled .header-actions {
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                flex: 0 0 auto !important;
            }

            .header.scrolled .trip-selector {
                display: none !important;
            }

            /* Make buttons icon-only */
            .header.scrolled .header-grid-btn {
                min-width: 0 !important;
                width: 32px !important;
                height: 32px !important;
                padding: 4px !important;
            }

            .header.scrolled .header-grid-btn .btn-label {
                display: none !important;
            }

            .header.scrolled .header-grid-btn .btn-icon {
                font-size: 16px !important;
            }

        }

        /* Google Places Autocomplete Dropdown */
        .pac-container {
            z-index: 10001 !important;
            font-family: inherit;
            border-radius: 8px;
            margin-top: 4px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        
        .pac-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .pac-item:hover {
            background-color: #f3f4f6;
        }

        /* Draggable POI Items */
        [draggable="true"] {
            transition: all 0.2s;
        }
        
        [draggable="true"]:active {
            cursor: grabbing !important;
        }
        
        [draggable="true"]:hover {
            background: #f8fafc !important;
        }

    
        /* Comprehensive Dark Mode - All Modals, Settings, Pages */
        body.dark-mode .modal,
        body.dark-mode .modal-content,
        body.dark-mode .settings-full-page,
        body.dark-mode .analytics-page,
        body.dark-mode .checklist-full-page,
        body.dark-mode [class*="page"],
        body.dark-mode [class*="modal"] {
            background: #0f172a !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .settings-full-page > div:first-child,
        body.dark-mode .modal-header,
        body.dark-mode .analytics-header,
        body.dark-mode [class*="header"] {
            background: #1e293b !important;
            border-bottom-color: #475569 !important;
        }
        
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, 
        body.dark-mode h4, body.dark-mode h5, body.dark-mode h6 {
            color: #f1f5f9 !important;
        }
        
        body.dark-mode [style*="color:#666"] {
            color: #94a3b8 !important;
        }
        
        body.dark-mode [style*="color:#0d9488"] {
            color: #14b8a6 !important; /* Lighter teal for dark mode */
        }
        
        body.dark-mode textarea,
        body.dark-mode [type="text"],
        body.dark-mode [type="number"],
        body.dark-mode [type="date"] {
            background: #334155 !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }
        
        body.dark-mode .settings-menu-card,
        body.dark-mode .prep-card,
        body.dark-mode [class*="card"] {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        
        body.dark-mode .settings-menu-card:hover,
        body.dark-mode .prep-card:hover {
            background: #334155 !important;
        }

        </style>
</head>
<body>
    <div class="container" id="app"></div>
    
    <!-- Persistent Map Container (Outside Render Loop) -->
    <div id="persistentMapTab" style="display:none;"></div>
    
    <script>
        let renderTimeout = null;
        const debouncedRender = () => {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(render, 50);
        };

        const DEFAULT_CATEGORIES = [
            {id: 'acc', name: 'Accommodation', icon: '', color: '#ef4444'},
            {id: 'trn', name: 'Transportation', icon: '', color: '#0d9488'},
            {id: 'food', name: 'Food', icon: '', color: '#10b981'},
            {id: 'act', name: 'Activities', icon: '', color: '#f59e0b'}
        ];

        const DATA = {
            sidebarCollapsed: false,
            sidebarOpen: false, // for mobile
            mobileMenuOpen: false, // for mobile "More" submenu
            showWelcome: true, // Show welcome screen on first load
            recentlyViewed: [], // Track recently viewed/edited days [dayIndex, timestamp]
            darkMode: false, // Dark mode toggle
            budget: 0,
            rate: 1,
            currency: 'USD',
            currencySymbol: '$',
            liveRate: false,
            lastFetchedRate: null,
            tripStartDate: '',
            tripEndDate: '',
            categories: [
                {id: 'acc', name: 'Accommodation', icon: '', color: '#0d9488'},
                {id: 'trn', name: 'Transportation', icon: '', color: '#8b5cf6'},
                {id: 'food', name: 'Food', icon: '', color: '#f59e0b'},
                {id: 'act', name: 'Activities', icon: '', color: '#10b981'}
            ],
            categoryBudgets: {},
            showCategoryManager: false,
            iconPickerOpen: false,
            iconPickerCategory: null,
            expanded: null,
            editing: null,
            editTitle: false,
            tripTitle: 'My Trip',
            tripSubtitle: '',
            tripNotes: '',
            packingList: [],
            editPackingList: false,
            categoryBudgets: {
                acc: 0,
                trn: 0,
                food: 0,
                act: 0
            },
            travelers: ['Traveler 1'],
            travelerCount: 1,
            costSplitMode: 'total', // 'total', 'perPerson', or 'shared'
            showTravelers: false,
            showTravelerList: false,
            editCategoryBudget: null,
            showEst: false,
            editBudget: false,
            editRate: false,
            editBeforeChecklist: false,
            editTripChecklist: false,
            converterUSD: 100,
            converterYEN: 15500,
            searchQuery: '',
            searchResults: [],
            showSearchResults: false,
            searchMode: 'auto',
            chartView: 'planned',
            showDailyBudget: false,
            showChart: false,
            showChartAcc: false,
            showChartTrn: false,
            showChartFood: false,
            showChartAct: false,
            photoModal: null,
            activeTab: 'home', // home, planning, itinerary, gallery
            expandedCalendarCell: null, // Track which calendar cell is expanded on mobile
            showMap: false,
            mapInitialized: false,
            mapView: 'all', // 'all', 'route', or 'clusters'
            geocodedLocations: {}, // Cache geocoded locations
            locationOrder: {},
            beforeChecklist: [],
            tripChecklist: [],
            receipts: [], // Array of receipt objects per day
            showReceipts: false,
            photoSelectMode: false, // For multi-select photo export
            selectedPhotos: [], // Array of {dayIndex, photoIndex}
            mapViewMode: 'markers', // 'markers' or 'route'
            mapRouteStyle: 'segments', // Always 'segments' now
            mapTravelMode: 'TRANSIT', // 'DRIVING', 'TRANSIT', 'WALKING', 'BICYCLING'
            transportPriority: ['TRANSIT', 'DRIVING', 'WALKING'], // Fallback order for route finding
            markersLocked: false, // Lock/unlock markers
            googleMap: null, // Google Map instance
            mapMarkers: [], // Array of marker objects
            mapRoute: [], // Independent route storage: [{name, lat, lng, type: 'day' or 'waypoint'}]
            routeInitialized: false, // Track if route was initialized from days
            directionsRenderer: null, // Google Directions renderer
            directionsRenderers: [], // Multiple renderers for segments
            animationMarker: null, // Marker for animation
            routeCache: {
                main: null,           // Main map cached route: { segments: [...], transportMode, transportPriority, timestamp }
                daily: {}             // Daily map caches: { dayIndex: { segments: [...], transportMode, timestamp } }
            },
            isAnimating: false, // Animation state
            animationFollowRoute: false, // Whether to follow actual route during animation
            editingLocationName: null, // Index of location being name-edited
            showDailyMap: null, // Day index for daily itinerary map
            dailyMapPoints: {}, // {dayIndex: [{name, lat, lng, notes}]}
            editingCategoryModal: null, // e.g., {dayIndex: 0, category: 'acc'}
            editingNotesModal: null, // e.g., {dayIndex: 0}
            // Add to your DATA object initialization
            customWaypoints: [],
            mapEditMode: false,
            draggableMarkers: {},
            editingLocation: null,
            locationOrder: {},
            showDayJump: true,
            dayJumpCollapsed: false,
            showPrintSettings: false,
            printOptions: {
                act: 0
            },
            travelers: ['Traveler 1'],
            travelerCount: 1,
            costSplitMode: 'total', // 'total', 'perPerson', or 'shared'
            showTravelers: false,
            showTravelerList: false,
            editCategoryBudget: null,
            showEst: false,
            editBudget: false,
            editRate: false,
            editBeforeChecklist: false,
            editTripChecklist: false,
            converterUSD: 100,
            converterYEN: 15500,
            searchQuery: '',
            searchResults: [],
            showSearchResults: false,
            searchMode: 'auto',
            chartView: 'planned',
            showDailyBudget: false,
            showChart: false,
            showChartAcc: false,
            showChartTrn: false,
            showChartFood: false,
            showChartAct: false,
            photoModal: null,
            activeTab: 'home', // home, planning, itinerary, gallery
            expandedCalendarCell: null, // Track which calendar cell is expanded on mobile
            showMap: false,
            mapInitialized: false,
            mapView: 'all', // 'all', 'route', or 'clusters'
            geocodedLocations: {}, // Cache geocoded locations
            locationOrder: {},
            beforeChecklist: [{item: 'Book flights', checked: false}, {item: 'Get travel insurance', checked: false}],
            tripChecklist: [{item: 'Charge electronics', checked: false}, {item: 'Pack passport', checked: false}],
            receipts: [], // Array of receipt objects per day
            showReceipts: false,
            editingCategoryModal: null, // e.g., {dayIndex: 0, category: 'acc'}
            editingNotesModal: null, // e.g., {dayIndex: 0}
            // Add to your DATA object initialization
            customWaypoints: [],
            mapEditMode: false,
            draggableMarkers: {},
            editingLocation: null,
            locationOrder: {},
            showDayJump: true,
            dayJumpCollapsed: false,
            showPrintSettings: false,
            printOptions: {
                includeBudget: true,
                includeCategories: true,
                includeNotes: true,
                includePhotos: false,
                includeReceipts: false,
                includeJournal: false,
                includeSchedule: true,
                layout: 'detailed' // 'detailed' or 'compact'
            },
            whatIfDate: null, // ADD THIS - stores the simulated date
            showWhatIfModal: false, // ADD THIS - controls the modal
            itineraryView: 'calendar',  // Default to calendar view
            currentCalendarMonth: new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0'), // Default to current month
            showDayDetailModal: null, // Track which day detail modal is open
            comparisonView: 'comparison', // 'comparison' or 'breakdown'
            
            // Appearance Settings - Global variables
            animationSpeed: 'normal', // 'fast', 'normal', 'slow'
            cardStyle: 'modern', // 'modern', 'classic'  
            density: 'comfortable', // 'compact', 'comfortable', 'spacious'
            fontSize: 'medium', // 'small', 'medium', 'large'

            days: []
        };
        
        const CURRENCIES = {
            'JPY': { name: 'Japanese Yen', symbol: '' },
            'EUR': { name: 'Euro', symbol: '' },
            'GBP': { name: 'British Pound', symbol: '' },
            'CAD': { name: 'Canadian Dollar', symbol: 'CA$' },
            'AUD': { name: 'Australian Dollar', symbol: 'A$' },
            'CHF': { name: 'Swiss Franc', symbol: 'CHF' },
            'CNY': { name: 'Chinese Yuan', symbol: '' },
            'KRW': { name: 'South Korean Won', symbol: '' },
            'MXN': { name: 'Mexican Peso', symbol: 'MX$' },
            'INR': { name: 'Indian Rupee', symbol: '' }
        };

        const fetchLiveRate = async () => {
            if (!DATA.liveRate) return;
            
            try {
                const response = await fetch(`https://open.exchangerate-api.com/v6/latest/USD`);
                const data = await response.json();
                
                if (data.rates && data.rates[DATA.currency]) {
                    DATA.rate = data.rates[DATA.currency];
                    DATA.lastFetchedRate = new Date().toLocaleString();
                    saveToStorage();
                    renderWithoutFlash();
                }
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
            }
        };

        const changeCurrency = (newCurrency) => {
            DATA.currency = newCurrency;
            DATA.currencySymbol = CURRENCIES[newCurrency].symbol;
            if (DATA.liveRate) {
                fetchLiveRate();
            } else {
                saveToStorage();
                renderWithoutFlash();
            }
        };

       const updateTravelerCount = (change) => {
            const newCount = Math.max(1, DATA.travelerCount + change);
            DATA.travelerCount = newCount;
            
            // Adjust travelers array
            if (newCount > DATA.travelers.length) {
                for (let i = DATA.travelers.length; i < newCount; i++) {
                    DATA.travelers.push(`Traveler ${i + 1}`);
                }
            } else {
                DATA.travelers = DATA.travelers.slice(0, newCount);
            }
            
            saveToStorage();
            renderWithoutFlash();
        };

        const updateTravelerName = (idx, name) => {
            DATA.travelers[idx] = name;
            saveToStorage();
        };

        const setCostSplitMode = (mode) => {
            DATA.costSplitMode = mode;
            saveToStorage();
            debouncedRender(); // Changed from render()

        };

        const getWeatherIcon = (condition) => {
            const icons = {
                'clear': '',
                'clouds': '',
                'rain': '',
                'drizzle': '',
                'thunderstorm': '',
                'snow': '',
                'mist': '',
                'fog': '',
                'haze': ''
            };
            
            const conditionLower = condition.toLowerCase();
            for (let key in icons) {
                if (conditionLower.includes(key)) {
                    return icons[key];
                }
            }
            return '';
        };

        const fetchWeather = async (dayIndex) => {
            const day = DATA.days[dayIndex];
            const location = day.loc.split('')[0].trim().split(',')[0].trim();
            
            DATA.days[dayIndex].weatherLoading = true;
            renderWithoutFlash();
            
            try {
                // First, get coordinates for the location
                const geoResponse = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1&language=en&format=json`
                );
                const geoData = await geoResponse.json();
                
                if (!geoData.results || geoData.results.length === 0) {
                    DATA.days[dayIndex].weatherLoading = false;
                    alert(` No weather data found for "${location}"\n\nPlease check the location name and try again.`);
                    renderWithoutFlash();
                    return;
                }
                
                const { latitude, longitude, name } = geoData.results[0];
                
                // Parse the date from the day
                const now = new Date();
                const targetDate = new Date(day.dt);
                
                // Check if date is in the future
                const daysInFuture = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
                
                if (daysInFuture > 14) {
                    DATA.days[dayIndex].weatherLoading = false;
                    alert(` Too far in advance\n\nWeather forecasts are only available for dates within 14 days.\n"${day.dt}" is ${daysInFuture} days away.`);
                    renderWithoutFlash();
                    return;
                }
                
                if (daysInFuture < 0) {
                    DATA.days[dayIndex].weatherLoading = false;
                    alert(`Historical data\n\n"${day.dt}" is in the past. Historical weather data is not available.`);
                    renderWithoutFlash();
                    return;
                }
                
                // Date is within forecast range
                const dateStr = targetDate.toISOString().split('T')[0];
                
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode,windspeed_10m_max&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`
                );
                const weatherData = await weatherResponse.json();
                
                if (weatherData.daily && weatherData.daily.time[0] === dateStr) {
                    const tempMax = Math.round(weatherData.daily.temperature_2m_max[0]);
                    const tempMin = Math.round(weatherData.daily.temperature_2m_min[0]);
                    const tempMaxF = Math.round((tempMax * 9/5) + 32);
                    const tempMinF = Math.round((tempMin * 9/5) + 32);
                    const weatherCode = weatherData.daily.weathercode[0];
                    const windSpeed = Math.round(weatherData.daily.windspeed_10m_max[0]);
                    const precipitation = weatherData.daily.precipitation_sum[0];
                    
                    // Simple weather code to condition mapping
                    const getWeatherCondition = (code) => {
                        if (code === 0) return { condition: 'Clear sky', icon: '' };
                        if (code <= 3) return { condition: 'Partly cloudy', icon: '' };
                        if (code <= 48) return { condition: 'Foggy', icon: '' };
                        if (code <= 67) return { condition: 'Rain', icon: '' };
                        if (code <= 77) return { condition: 'Snow', icon: '' };
                        if (code <= 99) return { condition: 'Thunderstorm', icon: '' };
                        return { condition: 'Unknown', icon: '' };
                    };
                    
                    const { condition, icon } = getWeatherCondition(weatherCode);
                    
                    DATA.days[dayIndex].weather = {
                        temp: tempMaxF,
                        tempMin: tempMinF,
                        tempC: tempMax,
                        tempMinC: tempMin,
                        condition: condition,
                        icon: icon,
                        windSpeed: windSpeed,
                        precipitation: precipitation,
                        location: name
                    };
                } else {
                    throw new Error('Weather data not available');
                }
                
            } catch (error) {
                console.error('Weather fetch failed:', error);
                DATA.days[dayIndex].weather = { 
                    error: 'Weather data unavailable',
                    icon: '',
                    condition: 'Error'
                };
            }
            
            DATA.days[dayIndex].weatherLoading = false;
            saveToStorage();
            renderWithoutFlash();
        };

        const checkAndFetchUpcomingWeather = () => {
            const now = new Date();
            
            DATA.days.forEach((day, index) => {
                // Skip if weather is already loaded or loading
                if (day.weather || day.weatherLoading) return;
                
                // Parse the day's date
                const dayDate = new Date(day.dt);
                
                // Check if date is within 2 weeks in the future
                const daysInFuture = Math.ceil((dayDate - now) / (1000 * 60 * 60 * 24));
                
                // Only auto-fetch if date is within 0-14 days in the future
                if (daysInFuture >= 0 && daysInFuture <= 14) {
                    // Add a small delay to avoid hitting API rate limits
                    setTimeout(() => {
                        fetchWeather(index);
                    }, index * 1000); // Stagger requests by 1 second each
                }
            });
        };

        const formatCostWithSplit = (amount) => {
            if (DATA.costSplitMode === 'perPerson' && DATA.travelerCount > 1) {
                const perPerson = amount / DATA.travelerCount;
                return `${DATA.currencySymbol}${amount.toLocaleString()} <span class="per-person-cost">${DATA.currencySymbol}${perPerson.toFixed(0)}/person</span>`;
            }
            return `${DATA.currencySymbol}${amount.toLocaleString()}`;
        };
        
        /* ========================================== */
        /* HELPER FUNCTIONS - Reduce Repetition */
        /* ========================================== */
        
        // NOTE: switchTab is defined later with map state handling
        
        // Modal Management
        function closeModal() {
            DATA.showModal = null;
            renderWithoutFlash();
        }
        
        function closeSettings() {
            DATA.showSettings = false;
            renderWithoutFlash();
        }
        
        function closeExportMenu() {
            DATA.showExportMenu = false;
            renderWithoutFlash();
        }
        
        // Checklist Management
        function closeChecklist() {
            DATA.showChecklistPage = null;
            renderWithoutFlash();
        }
        
        function openChecklist(type) {
            DATA.activeTab = 'planning';
            DATA.showChecklistPage = type;
            renderWithoutFlash();
        }
        
        // Analytics
        function closeAnalytics() {
            DATA.showAnalyticsPage = null;
            renderWithoutFlash();
        }
        
        function openAnalytics(page) {
            DATA.showAnalyticsPage = page;
            renderWithoutFlash();
        }
        
        // What-If Calculator
        function closeWhatIf() {
            DATA.showWhatIfModal = false;
            renderWithoutFlash();
        }
        
        function clearWhatIfDate() {
            DATA.whatIfDate = null;
            saveToStorage();
            renderWithoutFlash();
        }
        
        // Settings Pages
        function switchSettingsPage(page) {
            DATA.settingsPage = page;
            renderWithoutFlash();
        }
        
        // Trip Manager
        function closeTripManager() {
            DATA.showTripManager = false;
            renderWithoutFlash();
        }
        
        // NOTE: closeDaySection is defined later (line ~10201)
        
        // Trip Dates Editing
        function editTripDates() {
            const currentStart = DATA.tripStartDate || new Date().toISOString().split('T')[0];
            const currentEnd = DATA.tripEndDate || new Date().toISOString().split('T')[0];
            
            const modalHTML = `
                <div style="margin-bottom:20px;">
                    <label style="display:block;margin-bottom:10px;font-weight:600;">Trip Start Date</label>
                    <input type="date" id="editStartDate" value="${currentStart}" 
                        style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block;margin-bottom:10px;font-weight:600;">Trip End Date</label>
                    <input type="date" id="editEndDate" value="${currentEnd}" 
                        style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;">
                </div>
                <div style="padding:12px;background:#fafafa;border-radius:6px;border:3px solid #000;margin-bottom:15px;">
                    <div style="font-weight:700;margin-bottom:6px;color:#92400e;">Important:</div>
                    <div style="font-size:14px;color:#78350f;">Changing dates will recalculate all day numbers and dates. Your locations and expenses will be preserved.</div>
                </div>
            `;
            
            DATA.showModal = {
                title: ' Edit Trip Dates',
                message: modalHTML,
                type: 'custom',
                confirmText: 'Save Dates'
            };
            
            window.modalCallback = () => {
                const newStart = document.getElementById('editStartDate').value;
                const newEnd = document.getElementById('editEndDate').value;
                
                if (!newStart || !newEnd) {
                    showToast(' Please select both dates', 'error');
                    return;
                }
                
                if (new Date(newStart) > new Date(newEnd)) {
                    showToast(' Start date must be before end date', 'error');
                    return;
                }
                
                // Calculate new number of days
                const start = new Date(newStart);
                const end = new Date(newEnd);
                const diffTime = Math.abs(end - start);
                const newDayCount = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                // Update trip dates
                DATA.tripStartDate = newStart;
                DATA.tripEndDate = newEnd;
                DATA.tripSubtitle = `${new Date(newStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(newEnd).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                
                // Recalculate days
                const oldDays = DATA.days.length;
                
                if (newDayCount > oldDays) {
                    // Add more days
                    for (let i = oldDays; i < newDayCount; i++) {
                        const currentDate = new Date(start);
                        currentDate.setDate(start.getDate() + i);
                        const formattedDate = `${currentDate.getMonth() + 1}-${currentDate.getDate()}-${currentDate.getFullYear()}`;
                        
                        const newDay = {
                            d: i + 1,
                            dt: formattedDate,
                            loc: `Day ${i + 1} Destination`,
                            note: '',
                            done: false,
                            a: {},
                            photos: [],
                            journalNote: '',
                            schedule: [],
                            showSchedule: false,
                            receipts: []
                        };
                        
                        DATA.categories.forEach(cat => {
                            newDay[cat.id] = {d: '', p: 0};
                            newDay.a[cat.id] = 0;
                        });
                        
                        DATA.days.push(newDay);
                    }
                } else if (newDayCount < oldDays) {
                    // Remove excess days
                    DATA.days = DATA.days.slice(0, newDayCount);
                }
                
                // Recalculate dates for all existing days
                DATA.days.forEach((day, idx) => {
                    const currentDate = new Date(start);
                    currentDate.setDate(start.getDate() + idx);
                    day.dt = `${currentDate.getMonth() + 1}-${currentDate.getDate()}-${currentDate.getFullYear()}`;
                    day.d = idx + 1;
                });
                
                saveToStorage();
                showToast(` Trip dates updated! Now ${newDayCount} days`, 'success');
                closeModal();
                renderWithoutFlash();
            };
            
            renderWithoutFlash();
        }
        
        // ========================================
        // GOOGLE MAPS INTEGRATION
        // ========================================
        
        // Load Google Maps API
        function loadGoogleMapsAPI() {
            if (window.google && window.google.maps) {
                return Promise.resolve();
            }
            
            return new Promise((resolve, reject) => {
                // Check if script is already loading
                const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
                if (existingScript) {
                    const checkGoogle = setInterval(() => {
                        if (window.google && window.google.maps) {
                            clearInterval(checkGoogle);
                            resolve();
                        }
                    }, 100);
                    return;
                }
                
                // Create callback function
                window.initGoogleMaps = () => {
                    delete window.initGoogleMaps;
                    resolve();
                };
                
                const script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyA7Sc-6ldPX-5XrZbGMQK3IOWvOg5tfOgc&libraries=geometry,places&callback=initGoogleMaps';
                script.async = true;
                script.defer = true;
                script.onerror = () => reject(new Error('Failed to load Google Maps API'));
                document.head.appendChild(script);
            });
        }
        
        // Initialize Google Map
        async function initializeMap() {
            if (DATA.activeTab !== 'map') return;
            
            const mapContainer = document.getElementById('googleMap');
            if (!mapContainer) {
                console.error('Map container not found!');
                return;
            }
            
            // If map exists but container is empty, we need to recreate
            if (DATA.googleMap && !mapContainer.firstChild) {
                console.log('Map exists but container empty - recreating map in container');
                DATA.googleMap = null;
                DATA.mapMarkers = [];
            }
            
            // If map already initialized and visible, just ensure it's displayed
            if (DATA.googleMap && mapContainer.firstChild) {
                console.log('Map already initialized and visible');
                return;
            }
            
            try {
                // Load API if not loaded
                await loadGoogleMapsAPI();
                
                // Initialize route from days ONLY ONCE
                if (!DATA.routeInitialized && DATA.days.length > 0) {
                    const rawRoute = DATA.days
                        .map((d, originalIdx) => ({
                            day: d,
                            originalIndex: originalIdx
                        }))
                        .filter(item => item.day.loc) // Filter AFTER capturing original index
                        .map(item => ({
                            name: item.day.loc,
                            lat: item.day.latitude || null,
                            lng: item.day.longitude || null,
                            type: 'day',
                            dayIndex: item.originalIndex,  // Use the captured original index!
                            dayNumber: item.day.d
                        }));
                    
                    // Combine ONLY consecutive same locations
                    DATA.mapRoute = [];
                    let i = 0;
                    
                    while (i < rawRoute.length) {
                        const current = rawRoute[i];
                        let consecutiveCount = 1;
                        
                        // Look ahead ONLY at the immediately following days
                        while (i + consecutiveCount < rawRoute.length) {
                            const next = rawRoute[i + consecutiveCount];
                            
                            // Check if next day is the SAME location
                            const sameName = next.name.toLowerCase().trim() === current.name.toLowerCase().trim();
                            const sameCoords = current.lat && next.lat && 
                                Math.abs(current.lat - next.lat) < 0.0001 && 
                                Math.abs(current.lng - next.lng) < 0.0001;
                            
                            // If same location, continue counting
                            if (sameName || sameCoords) {
                                consecutiveCount++;
                            } else {
                                // Different location - stop here
                                break;
                            }
                        }
                        
                        // Create marker for this location (single or multi-day)
                        if (consecutiveCount > 1) {
                            // Multiple consecutive days - create ONE combined marker
                            const startDay = rawRoute[i].dayNumber;
                            const endDay = rawRoute[i + consecutiveCount - 1].dayNumber;
                            
                            DATA.mapRoute.push({
                                name: current.name,
                                displayName: `${current.name} (Days ${startDay}-${endDay})`,
                                lat: current.lat,
                                lng: current.lng,
                                type: 'day',
                                dayIndex: rawRoute[i].dayIndex,
                                endDayIndex: rawRoute[i + consecutiveCount - 1].dayIndex,
                                dayCount: consecutiveCount,
                                dayRange: `${startDay}-${endDay}`,
                                allDayIndices: Array.from({length: consecutiveCount}, (_, idx) => rawRoute[i + idx].dayIndex)
                            });
                            
                            console.log(` Combined: ${current.name} Days ${startDay}-${endDay} (${consecutiveCount} days)`);
                        } else {
                            // Single day - regular marker
                            DATA.mapRoute.push({
                                name: current.name,
                                displayName: `${current.name} (Day ${current.dayNumber})`,
                                lat: current.lat,
                                lng: current.lng,
                                type: 'day',
                                dayIndex: current.dayIndex,
                                dayCount: 1,
                                dayNumber: current.dayNumber,
                                allDayIndices: [current.dayIndex]
                            });
                            
                            console.log(` Single: ${current.name} Day ${current.dayNumber}`);
                        }
                        
                        // Move forward by the number of days we just processed
                        i += consecutiveCount;
                    }
                    
                    console.log(' Route built:', DATA.mapRoute.map(r => `${r.displayName} (${r.dayCount} day${r.dayCount > 1 ? 's' : ''})`));
                    
                    DATA.routeInitialized = true;
                    saveToStorage();
                }
                
                // Only create map if not already created
                if (!DATA.googleMap) {
                    // Create map centered on first route location or default
                    const firstLoc = DATA.mapRoute[0];
                    const centerLat = firstLoc?.lat || 35.6762; // Default: Tokyo
                    const centerLng = firstLoc?.lng || 139.6503;
                    
                    DATA.googleMap = new google.maps.Map(mapContainer, {
                        center: { lat: centerLat, lng: centerLng },
                        zoom: 6,
                        mapTypeControl: true,
                        streetViewControl: true,
                        fullscreenControl: true,
                        zoomControl: true
                    });
                    
                    // Initialize directions renderer for route mode
                    DATA.directionsRenderer = new google.maps.DirectionsRenderer({
                        map: DATA.googleMap,
                        suppressMarkers: true, // We'll use our own markers
                        polylineOptions: {
                            strokeColor: '#0d9488',
                            strokeWeight: 4,
                            strokeOpacity: 0.8
                        }
                    });
                }
                
                // Geocode any locations without coordinates (only once)
                await geocodeRouteLocations();
                
                // Add markers for route locations
                await addRouteMarkersToMap();
                
                // Draw route if in route mode
                if (DATA.mapViewMode === 'route') {
                    await drawDirectionsRoute();
                }
                
            } catch (error) {
                console.error('Map initialization error:', error);
                showToast(' Map failed to load. Check API key.', 'error');
            }
        }
        
        // Geocode route locations that don't have coordinates
        async function geocodeRouteLocations() {
            for (let i = 0; i < DATA.mapRoute.length; i++) {
                const loc = DATA.mapRoute[i];
                
                // Skip if already has coordinates
                if (loc.lat && loc.lng) continue;
                
                // Clean location name - remove parentheses and content
                let cleanName = loc.name.replace(/\([^)]*\)/g, '').trim();
                
                // Skip generic/invalid location names
                const genericNames = [
                    'flight home', 'flying home', 'travel day', 'flight', 
                    'transit', 'driving', 'travel', 'rest day', 'zero day',
                    /^day \d+$/i  // "Day 1", "Day 2", etc.
                ];
                
                const isGeneric = genericNames.some(pattern => {
                    if (typeof pattern === 'string') {
                        return cleanName.toLowerCase().includes(pattern);
                    }
                    return pattern.test(cleanName);
                });
                
                if (isGeneric) {
                    console.log(`Skipping geocoding for generic location: ${loc.name}`);
                    continue;
                }
                
                // Skip very short names (likely incomplete)
                if (cleanName.length < 3) continue;
                
                try {
                    const coords = await geocodeLocation(cleanName);
                    loc.lat = coords.lat;
                    loc.lng = coords.lng;
                    
                    // Update day object if it's a day location
                    if (loc.type === 'day' && loc.dayIndex !== undefined) {
                        DATA.days[loc.dayIndex].latitude = coords.lat;
                        DATA.days[loc.dayIndex].longitude = coords.lng;
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.log(`Failed to geocode: ${cleanName}`, error);
                    // Don't break the loop, continue with other locations
                }
            }
            saveToStorage();
        }
        
        // Add markers for each route location
        async function addRouteMarkersToMap() {
            if (!DATA.googleMap) return;
            
            // Clear existing markers
            DATA.mapMarkers.forEach(marker => marker.setMap(null));
            DATA.mapMarkers = [];
            
            const bounds = new google.maps.LatLngBounds();
            
            // Group CONSECUTIVE locations by coordinates
            const consecutiveGroups = [];
            let currentGroup = null;
            
            for (let i = 0; i < DATA.mapRoute.length; i++) {
                const loc = DATA.mapRoute[i];
                
                if (!loc.lat || !loc.lng) continue;
                
                const coordKey = `${loc.lat.toFixed(4)},${loc.lng.toFixed(4)}`;
                
                // Check if this continues the current group (same coords as previous)
                if (currentGroup && currentGroup.coordKey === coordKey) {
                    // Continue existing group
                    currentGroup.indices.push(i);
                    if (!currentGroup.names.includes(loc.name)) {
                        currentGroup.names.push(loc.name);
                    }
                    currentGroup.types.push(loc.type);
                    if (loc.dayIndex !== undefined) {
                        currentGroup.dayIndices.push(loc.dayIndex);
                    }
                } else {
                    // Start new group
                    if (currentGroup) {
                        consecutiveGroups.push(currentGroup);
                    }
                    
                    currentGroup = {
                        coordKey: coordKey,
                        lat: loc.lat,
                        lng: loc.lng,
                        indices: [i],
                        names: [loc.name],
                        types: [loc.type],
                        dayIndices: loc.dayIndex !== undefined ? [loc.dayIndex] : []
                    };
                }
            }
            
            // Don't forget the last group
            if (currentGroup) {
                consecutiveGroups.push(currentGroup);
            }
            
            // Track how many groups we've created at each coordinate for offsetting
            const coordGroupCounts = new Map();
            
            // Create markers for each consecutive group
            for (const group of consecutiveGroups) {
                const firstIndex = group.indices[0];
                const loc = DATA.mapRoute[firstIndex];
                const isMultiple = group.indices.length > 1;
                
                // Get day numbers from the actual DATA.days array
                const dayNumbers = group.dayIndices.map(di => DATA.days[di].d);
                
                // Create day range string (e.g., "34-37" or just "34")
                let dayRangeStr = '';
                if (dayNumbers.length > 0) {
                    const minDay = Math.min(...dayNumbers);
                    const maxDay = Math.max(...dayNumbers);
                    dayRangeStr = minDay === maxDay ? String(minDay) : `${minDay}-${maxDay}`;
                }
                
                // Determine display name
                const displayName = isMultiple 
                    ? `${group.names[0]} (Days ${dayRangeStr})`
                    : (loc.displayName || loc.name);
                
                // Calculate offset if there are multiple groups at same coords
                let offsetLat = group.lat;
                let offsetLng = group.lng;
                
                if (!coordGroupCounts.has(group.coordKey)) {
                    coordGroupCounts.set(group.coordKey, 0);
                } else {
                    // This is a return visit - offset it slightly
                    const offsetCount = coordGroupCounts.get(group.coordKey);
                    // Offset by ~500 meters per group (0.005 degrees  500m)
                    const offsetAmount = 0.005 * (offsetCount + 1);
                    offsetLat += offsetAmount;
                    offsetLng += offsetAmount;
                }
                coordGroupCounts.set(group.coordKey, coordGroupCounts.get(group.coordKey) + 1);
                
                // Create marker
                const marker = new google.maps.Marker({
                    position: { lat: offsetLat, lng: offsetLng },
                    map: DATA.googleMap,
                    title: displayName,
                    label: {
                        text: isMultiple ? dayRangeStr : String(firstIndex + 1),
                        color: 'white',
                        fontSize: isMultiple ? '11px' : '14px', // Smaller font for combo markers
                        fontWeight: 'bold'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: isMultiple ? 18 : 16, // 10% larger than normal (16 * 1.1  18)
                        fillColor: '#0d9488',
                        fillOpacity: 1,
                        strokeColor: '#065f46',
                        strokeWeight: 2
                    },
                    draggable: !DATA.markersLocked
                });
                
                // Drag listener to update all locations in this group
                marker.addListener('dragend', (e) => {
                    const newLat = e.latLng.lat();
                    const newLng = e.latLng.lng();
                    
                    // Update all locations in this group
                    group.indices.forEach(idx => {
                        DATA.mapRoute[idx].lat = newLat;
                        DATA.mapRoute[idx].lng = newLng;
                        
                        const routeLoc = DATA.mapRoute[idx];
                        if (routeLoc.type === 'day' && routeLoc.dayIndex !== undefined) {
                            DATA.days[routeLoc.dayIndex].latitude = newLat;
                            DATA.days[routeLoc.dayIndex].longitude = newLng;
                        }
                    });
                    
                    saveToStorage();
                    showToast(` Updated ${group.indices.length} location(s)`, 'success');
                    
                    if (DATA.mapViewMode === 'route') {
                        drawDirectionsRoute();
                    }
                });
                
                // Info window
                const daysList = group.dayIndices.length > 0 
                    ? `<p style="margin:6px 0;font-size:13px;color:#666;">Days ${dayRangeStr}</p>`
                    : '';
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding:10px;max-width:300px;">
                            <h3 style="margin:0 0 8px 0;font-size:16px;font-weight:700;">
                                ${isMultiple ? ' Days ' + dayRangeStr : (loc.type === 'waypoint' ? ' Waypoint' : 'Stop ' + (firstIndex + 1))}
                            </h3>
                            <div style="margin-bottom:8px;">
                                <p style="margin:0 0 6px 0;font-size:14px;font-weight:600;">${group.names.join(', ')}</p>
                                ${daysList}
                                ${isMultiple ? `<p style="margin:6px 0;font-size:11px;color:#0d9488;"><strong>Consecutive days</strong> at this location</p>` : ''}
                            </div>
                        </div>
                    `,
                    maxWidth: 350
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(DATA.googleMap, marker);
                });
                
                DATA.mapMarkers.push(marker);
                bounds.extend({ lat: offsetLat, lng: offsetLng });
            }
            
            // Fit map to show all markers
            if (DATA.mapMarkers.length > 0) {
                DATA.googleMap.fitBounds(bounds);
                
                // Don't zoom in too much if only one marker
                if (DATA.mapMarkers.length === 1) {
                    DATA.googleMap.setZoom(12);
                }
            }
        }
        
        // Geocode a location string to lat/lng
        function geocodeLocation(locationString) {
            return new Promise((resolve, reject) => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: locationString }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            lat: location.lat(),
                            lng: location.lng()
                        });
                    } else {
                        reject(new Error(`Geocoding failed: ${status}`));
                    }
                });
            });
        }
        
        // Draw route using Google Directions API (follows roads)
        async function drawDirectionsRoute() {
            console.log('drawDirectionsRoute called', {
                mapExists: !!DATA.googleMap,
                routeLength: DATA.mapRoute.length,
                hasCachedData: !!DATA.routeCache.main
            });
            
            // Always use segments mode
            DATA.mapRouteStyle = 'segments';
            
            if (!DATA.googleMap || DATA.mapRoute.length < 2) {
                showToast(' Need at least 2 locations for route', 'error');
                return;
            }
            
            // Clear old renderers
            DATA.directionsRenderers.forEach(renderer => renderer.setMap(null));
            DATA.directionsRenderers = [];
            if (DATA.directionsRenderer) {
                DATA.directionsRenderer.setMap(null);
            }
            
            // Filter out locations without coordinates and duplicates
            const validLocations = DATA.mapRoute.filter(loc => loc.lat && loc.lng);
            
            console.log('Valid locations:', validLocations.length);
            
            // Remove duplicate coordinates (within 0.001 degree tolerance)
            const uniqueLocations = [];
            for (const loc of validLocations) {
                const isDuplicate = uniqueLocations.some(existing => 
                    Math.abs(existing.lat - loc.lat) < 0.001 && 
                    Math.abs(existing.lng - loc.lng) < 0.001
                );
                if (!isDuplicate) {
                    uniqueLocations.push(loc);
                }
            }
            
            console.log('Unique locations:', uniqueLocations.length);
            
            if (uniqueLocations.length < 2) {
                showToast(' Need at least 2 unique locations', 'error');
                return;
            }
            
            // CHECK CACHE FIRST
            if (DATA.routeCache.main && 
                DATA.routeCache.main.transportMode === DATA.mapTravelMode &&
                JSON.stringify(DATA.routeCache.main.transportPriority) === JSON.stringify(DATA.transportPriority)) {
                console.log('Using cached route data');
                showToast('Using cached route', 'info');
                await drawCachedSegmentedRoute(DATA.routeCache.main.segments);
                return;
            }
            
            // NO CACHE OR SETTINGS CHANGED - Fetch from API
            console.log('No cache - fetching from API...');
            await drawAndCacheSegmentedRoute(uniqueLocations);
        }
        
        // Draw route from cached data
        async function drawCachedSegmentedRoute(cachedSegments) {
            let successCount = 0;
            
            for (const segmentData of cachedSegments) {
                if (segmentData.success && segmentData.result) {
                    try {
                        const renderer = new google.maps.DirectionsRenderer({
                            map: DATA.googleMap,
                            suppressMarkers: true,
                            preserveViewport: true,
                            polylineOptions: {
                                strokeColor: '#0d9488',
                                strokeWeight: 3,
                                strokeOpacity: 0.7
                            }
                        });
                        
                        renderer.setDirections(segmentData.result);
                        DATA.directionsRenderers.push(renderer);
                        successCount++;
                    } catch (error) {
                        console.error('Error rendering cached segment:', error);
                    }
                }
            }
            
            console.log(`Rendered ${successCount} cached segments`);
        }
        
        // Draw day-by-day segmented route
        // Fetch from API and cache result
        async function drawAndCacheSegmentedRoute(locations) {
            let successCount = 0;
            let failCount = 0;
            const failures = [];
            const cachedSegments = [];
            
            console.log(`Drawing ${locations.length - 1} segments...`);
            
            // For TRANSIT mode, try to find nearest stations
            let processedLocations = locations;
            if (DATA.mapTravelMode === 'TRANSIT') {
                console.log('TRANSIT mode: Finding nearest stations...');
                processedLocations = [];
                for (const loc of locations) {
                    const station = await findNearestStation(loc.name, loc.lat, loc.lng);
                    processedLocations.push({
                        ...loc,
                        lat: station.lat,
                        lng: station.lng,
                        stationName: station.name
                    });
                }
            }
            
            // Draw each segment (location i to i+1)
            for (let i = 0; i < processedLocations.length - 1; i++) {
                try {
                    const fromLoc = processedLocations[i];
                    const toLoc = processedLocations[i + 1];
                    
                    const fromName = fromLoc.stationName || fromLoc.name;
                    const toName = toLoc.stationName || toLoc.name;
                    
                    console.log(`Segment ${i+1}${i+2}: ${fromName}  ${toName}`);
                    
                    const renderer = new google.maps.DirectionsRenderer({
                        map: DATA.googleMap,
                        suppressMarkers: true,
                        preserveViewport: true,
                        polylineOptions: {
                            strokeColor: '#0d9488',
                            strokeWeight: 3,
                            strokeOpacity: 0.7
                        }
                    });
                    
                    const result = await drawSingleSegment(fromLoc, toLoc);
                    renderer.setDirections(result);
                    DATA.directionsRenderers.push(renderer);
                    
                    // CACHE THIS SEGMENT
                    cachedSegments.push({
                        from: { name: fromName, lat: fromLoc.lat, lng: fromLoc.lng },
                        to: { name: toName, lat: toLoc.lat, lng: toLoc.lng },
                        success: true,
                        result: result
                    });
                    
                    successCount++;
                    console.log(`Segment ${i+1}${i+2} succeeded and cached`);
                } catch (error) {
                    const fromName = processedLocations[i].stationName || processedLocations[i].name;
                    const toName = processedLocations[i + 1].stationName || processedLocations[i + 1].name;
                    console.log(` Segment ${i+1}${i+2} failed: ${error.message}`);
                    failures.push(`${i+1}${i+2}: ${fromName}  ${toName}`);
                    
                    // CACHE THE FAILURE
                    cachedSegments.push({
                        from: { name: fromName },
                        to: { name: toName },
                        success: false,
                        error: error.message
                    });
                    
                    failCount++;
                }
            }
            
            // SAVE TO CACHE
            DATA.routeCache.main = {
                segments: cachedSegments,
                transportMode: DATA.mapTravelMode,
                transportPriority: [...DATA.transportPriority],
                timestamp: new Date().toISOString()
            };
            saveToStorage();
            renderWithoutFlash(); // Update UI to show cached state
            
            console.log(`Route cached: ${successCount} succeeded, ${failCount} failed`);
            
            if (successCount > 0) {
                const msg = failCount > 0 
                    ? ` Drew ${successCount} segments (${failCount} failed - highlighted in red)` 
                    : ` Drew ${successCount} segments`;
                showToast(msg, 'success');
            } else {
                showToast(` All ${failCount} segments failed. Try DRIVING mode or check coordinates.`, 'error');
                console.error('Failed segments:', failures);
            }
        }
        
        // Backward compatibility alias
        async function drawSegmentedRoute(locations) {
            await drawAndCacheSegmentedRoute(locations);
        }
        
        // Find nearest transit station for a location (for TRANSIT mode)
        async function findNearestStation(locationName, lat, lng) {
            // For TRANSIT mode, try to find nearest train station
            if (DATA.mapTravelMode !== 'TRANSIT') {
                return { lat, lng, name: locationName };
            }
            
            try {
                // Try searching for "[location] station" or "[location] train station"
                const stationQuery = `${locationName} station japan`;
                const coords = await geocodeLocation(stationQuery);
                
                console.log(`Found station: ${stationQuery} at (${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)})`);
                return { lat: coords.lat, lng: coords.lng, name: `${locationName} Station` };
            } catch (error) {
                console.log(` No specific station found for ${locationName}, using city center`);
                return { lat, lng, name: locationName };
            }
        }
        
        // Draw single segment between two locations
        async function drawSingleSegment(fromLoc, toLoc) {
            // Create cache key based on coordinates and transport priorities
            const cacheKey = `${fromLoc.lat.toFixed(4)},${fromLoc.lng.toFixed(4)}-${toLoc.lat.toFixed(4)},${toLoc.lng.toFixed(4)}-${DATA.transportPriority.join(',')}`;
            
            // Check if we have cached data for this route
            if (DATA.routeCache && DATA.routeCache[cacheKey]) {
                console.log('Using cached route:', cacheKey);
                return DATA.routeCache[cacheKey];
            }
            
            const directionsService = new google.maps.DirectionsService();
            
            // Try each transport mode in priority order
            for (let i = 0; i < DATA.transportPriority.length; i++) {
                const mode = DATA.transportPriority[i];
                
                try {
                    const result = await new Promise((resolve, reject) => {
                        const request = {
                            origin: new google.maps.LatLng(fromLoc.lat, fromLoc.lng),
                            destination: new google.maps.LatLng(toLoc.lat, toLoc.lng),
                            travelMode: google.maps.TravelMode[mode]
                        };
                        
                        directionsService.route(request, (result, status) => {
                            if (status === 'OK') {
                                resolve(result);
                            } else {
                                reject(new Error(status));
                            }
                        });
                    });
                    
                    // Success! Cache this result and return it
                    console.log('Caching new route:', cacheKey);
                    if (!DATA.routeCache) {
                        DATA.routeCache = {};
                    }
                    
                    // Limit cache size - keep only last 50 segments
                    const cacheKeys = Object.keys(DATA.routeCache).filter(k => k !== 'main' && k !== 'daily');
                    if (cacheKeys.length > 50) {
                        // Remove oldest entries
                        cacheKeys.slice(0, cacheKeys.length - 50).forEach(k => delete DATA.routeCache[k]);
                        console.log(' Cleaned old cache entries');
                    }
                    
                    DATA.routeCache[cacheKey] = result;
                    
                    // Try to save, but don't fail if storage is full
                    try {
                        saveToStorage();
                    } catch (e) {
                        console.warn('Could not save route cache:', e.message);
                    }
                    return result;
                    
                } catch (error) {
                    // If this is the last option, throw the error
                    if (i === DATA.transportPriority.length - 1) {
                        throw error;
                    }
                    // Otherwise, continue to next transport mode
                }
            }
        }
        
        // Clear all cached routes
        function clearRouteCache() {
            if (confirm('Clear all cached routes? This will require new API calls next time you draw routes.')) {
                DATA.routeCache = {};
                saveToStorage();
                showToast(' Route cache cleared', 'success');
            }
        }
        
        // Draw full route (original behavior)
        async function drawFullRoute(uniqueLocations) {
            // Google allows max 25 waypoints + origin + destination = 27 total
            if (uniqueLocations.length > 27) {
                showToast(` Too many stops (${uniqueLocations.length}). Using simplified route with 27 key stops.`, 'error');
                
                // Keep first, last, and evenly distributed middle points
                const simplified = [uniqueLocations[0]];
                const step = Math.floor((uniqueLocations.length - 2) / 25);
                for (let i = step; i < uniqueLocations.length - 1; i += step) {
                    if (simplified.length >= 26) break;
                    simplified.push(uniqueLocations[i]);
                }
                simplified.push(uniqueLocations[uniqueLocations.length - 1]);
                
                await drawDirectionsRouteInternal(simplified);
            } else {
                await drawDirectionsRouteInternal(uniqueLocations);
            }
        }
        
        // Internal function to draw route with multi-modal fallback
        async function drawDirectionsRouteInternal(locations) {
            const directionsService = new google.maps.DirectionsService();
            
            // Get waypoints (all locations except first and last)
            const waypoints = locations.slice(1, -1).map(loc => ({
                location: new google.maps.LatLng(loc.lat, loc.lng),
                stopover: true
            }));
            
            const origin = new google.maps.LatLng(locations[0].lat, locations[0].lng);
            const destination = new google.maps.LatLng(
                locations[locations.length - 1].lat,
                locations[locations.length - 1].lng
            );
            
            console.log('Drawing route with:', {
                origin: `${locations[0].name} (${locations[0].lat}, ${locations[0].lng})`,
                destination: `${locations[locations.length - 1].name} (${locations[locations.length - 1].lat}, ${locations[locations.length - 1].lng})`,
                waypoints: locations.slice(1, -1).map(l => `${l.name} (${l.lat.toFixed(2)}, ${l.lng.toFixed(2)})`),
                totalStops: locations.length
            });
            
            // Try each transport mode in priority order
            for (let i = 0; i < DATA.transportPriority.length; i++) {
                const mode = DATA.transportPriority[i];
                
                try {
                    showToast(` Trying ${mode.toLowerCase()} route...`, 'info');
                    
                    const result = await new Promise((resolve, reject) => {
                        directionsService.route({
                            origin: origin,
                            destination: destination,
                            waypoints: waypoints,
                            travelMode: google.maps.TravelMode[mode],
                            optimizeWaypoints: false // Keep our order
                        }, (result, status) => {
                            if (status === 'OK') {
                                resolve(result);
                            } else {
                                reject(new Error(`${mode} failed: ${status}`));
                            }
                        });
                    });
                    
                    // Success! Use this route
                    DATA.directionsRenderer.setDirections(result);
                    
                    // Calculate total distance and duration
                    let totalDistance = 0;
                    let totalDuration = 0;
                    result.routes[0].legs.forEach(leg => {
                        totalDistance += leg.distance.value; // meters
                        totalDuration += leg.duration.value; // seconds
                    });
                    
                    const hours = Math.floor(totalDuration / 3600);
                    const minutes = Math.floor((totalDuration % 3600) / 60);
                    const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    
                    // Determine the icon based on mode
                    let modeIcon = '';
                    if (mode === 'TRANSIT') modeIcon = '';
                    else if (mode === 'WALKING') modeIcon = '';
                    else if (mode === 'BICYCLING') modeIcon = '';
                    else if (mode === 'DRIVING') modeIcon = '';
                    
                    showToast(`${modeIcon} ${mode}: ${(totalDistance / 1000).toFixed(1)} km, ${timeStr} (${locations.length} stops)`, 'success');
                    
                    // Update the current travel mode to the one that worked
                    DATA.mapTravelMode = mode;
                    saveToStorage();
                    
                    return; // Success, exit function
                    
                } catch (error) {
                    console.log(`${mode} route failed:`, error.message);
                    
                    // If this is the last option, show error
                    if (i === DATA.transportPriority.length - 1) {
                        showToast(` No route found with any transport mode`, 'error');
                    }
                    // Otherwise, continue to next transport mode
                }
            }
        }
        
        // Simple wait helper
        const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
        
        // Smooth zoom function - let Google Maps handle its own easing
        async function smoothZoomTo(position, targetZoom) {
            if (!DATA.googleMap) return;
            DATA.googleMap.panTo(position);
            if (window.animationMarker) window.animationMarker.setPosition(position);
            DATA.googleMap.setZoom(Math.round(targetZoom));
            // Wait for Maps to finish its native pan+zoom animation
            await new Promise(resolve => setTimeout(resolve, 600));
        }
        
        // Animate route from start to end
        async function animateRoute() {
            if (DATA.isAnimating) {
                stopAnimation();
                return;
            }
            
            if (!DATA.googleMap || DATA.mapRoute.length < 2) {
                showToast(' Need at least 2 locations to animate', 'error');
                return;
            }
            
            // Filter valid locations
            const validLocations = DATA.mapRoute.filter(loc => loc.lat && loc.lng);
            
            if (validLocations.length < 2) {
                showToast(' Need at least 2 valid locations', 'error');
                return;
            }
            
            DATA.isAnimating = true;
            renderWithoutFlash(); // Update button to show "Stop"

            // Create moving marker with transport icon
            if (!window.animationMarker) {
                window.animationMarker = new google.maps.Marker({
                    map: DATA.googleMap,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#ef4444',
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 4
                    },
                    zIndex: 999999
                });
            }
            
            // Function to update marker icon based on transport mode
            const updateMarkerIcon = (mode) => {
                if (!window.animationMarker) return;
                
                const icons = {
                    TRANSIT: '',
                    DRIVING: '',
                    WALKING: '',
                    BICYCLING: ''
                };
                
                if (DATA.animationFollowRoute && mode) {
                    // Show emoji icon with larger size for visibility
                    window.animationMarker.setIcon({
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50">
                                <circle cx="25" cy="25" r="22" fill="white" stroke="#0d9488" stroke-width="3"/>
                                <text x="25" y="38" font-size="28" text-anchor="middle">${icons[mode] || ''}</text>
                            </svg>
                        `),
                        anchor: new google.maps.Point(25, 25),
                        scaledSize: new google.maps.Size(50, 50)
                    });
                } else {
                    // Show larger colored dot for direct mode
                    window.animationMarker.setIcon({
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#ef4444',
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 4
                    });
                }
            };
            
            // Set initial icon based on mode
            updateMarkerIcon(DATA.animationFollowRoute ? DATA.transportPriority[0] : null);
            
            // Create overlay for destination announcement
            let overlayDiv = document.getElementById('animation-overlay');
            if (!overlayDiv) {
                overlayDiv = document.createElement('div');
                overlayDiv.id = 'animation-overlay';
                overlayDiv.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.85);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 12px;
                    font-size: 24px;
                    font-weight: 700;
                    z-index: 2147483647;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    display: none;
                    transition: opacity 0.5s;
                `;
                document.body.appendChild(overlayDiv);
            }
            
            // Function to show destination name
            const showDestination = (name, dayInfo) => {
                overlayDiv.textContent = dayInfo ? `${name} (${dayInfo})` : name;
                overlayDiv.style.display = 'block';
                overlayDiv.style.opacity = '1';
            };
            
            const hideDestination = () => {
                overlayDiv.style.opacity = '0';
                setTimeout(() => {
                    overlayDiv.style.display = 'none';
                }, 500);
            };
            
            // Create consecutive location groups for animation (same logic as markers)
            const animationGroups = [];
            let currentAnimGroup = null;
            
            for (let i = 0; i < validLocations.length; i++) {
                const loc = validLocations[i];
                const coordKey = `${loc.lat.toFixed(4)},${loc.lng.toFixed(4)}`;
                
                if (currentAnimGroup && currentAnimGroup.coordKey === coordKey) {
                    // Same location - add to group
                    currentAnimGroup.locations.push(loc);
                    if (loc.dayNumber) {
                        currentAnimGroup.dayNumbers.push(loc.dayNumber);
                    }
                } else {
                    // New location - save previous group and start new one
                    if (currentAnimGroup) {
                        animationGroups.push(currentAnimGroup);
                    }
                    currentAnimGroup = {
                        coordKey: coordKey,
                        lat: loc.lat,
                        lng: loc.lng,
                        name: loc.displayName || loc.name,
                        locations: [loc],
                        dayNumbers: loc.dayNumber ? [loc.dayNumber] : []
                    };
                }
            }
            if (currentAnimGroup) {
                animationGroups.push(currentAnimGroup);
            }
            
            // Check we have groups to animate
            if (animationGroups.length === 0) {
                showToast(' No valid locations to animate', 'error');
                DATA.isAnimating = false;
                return;
            }
            
            // Snapshot the mode NOW so it can't change mid-animation
            const followRoute = DATA.animationFollowRoute;
            console.log('[ANIMATION] Starting. followRoute=' + followRoute + ', DATA.animationFollowRoute=' + DATA.animationFollowRoute);
            
            // Move marker to start and zoom in
            const firstPos = new google.maps.LatLng(animationGroups[0].lat, animationGroups[0].lng);
            if (window.animationMarker) window.animationMarker.setPosition(firstPos);
            DATA.googleMap.setCenter(firstPos);
            DATA.googleMap.setZoom(12);
            await wait(700);
            
            // Animate through each grouped location
            for (let i = 0; i < animationGroups.length; i++) {
                if (!DATA.isAnimating) break;
                
                const group = animationGroups[i];
                const position = new google.maps.LatLng(group.lat, group.lng);
                
                // Arrive at this city: zoom in, show label
                DATA.googleMap.setCenter(position);
                DATA.googleMap.setZoom(12);
                if (window.animationMarker) window.animationMarker.setPosition(position);
                
                let dayInfo = '';
                if (group.dayNumbers.length > 0) {
                    const minDay = Math.min(...group.dayNumbers);
                    const maxDay = Math.max(...group.dayNumbers);
                    dayInfo = minDay === maxDay ? `Day ${minDay}` : `Days ${minDay}-${maxDay}`;
                }
                showDestination(group.name, dayInfo);
                await wait(i === 0 ? 2500 : 2000);
                if (!DATA.isAnimating) break;
                
                // Travel to next location
                if (i < animationGroups.length - 1) {
                    hideDestination();
                    const nextGroup = animationGroups[i + 1];
                    const nextPosition = new google.maps.LatLng(nextGroup.lat, nextGroup.lng);
                    const dist = google.maps.geometry.spherical.computeDistanceBetween(position, nextPosition) / 1000;
                    
                    if (followRoute) {
                        //  FOLLOW ROUTE MODE 
                        // Try to get directions, fall back to straight line
                        let path = null;
                        for (const mode of DATA.transportPriority) {
                            if (!DATA.isAnimating) break;
                            try {
                                const svc = new google.maps.DirectionsService();
                                const res = await new Promise((ok, fail) => {
                                    svc.route({ origin: position, destination: nextPosition, travelMode: google.maps.TravelMode[mode] }, (r, s) => s === 'OK' ? ok(r) : fail(s));
                                });
                                path = [];
                                res.routes[0].legs.forEach(leg => leg.steps.forEach(step => step.path.forEach(pt => path.push(pt))));
                                updateMarkerIcon(mode);
                                break;
                            } catch(e) { continue; }
                        }
                        
                        if (!path) {
                            // Straight-line fallback: build synthetic path
                            path = [];
                            const steps = 40;
                            for (let s = 0; s <= steps; s++) {
                                path.push(new google.maps.LatLng(
                                    position.lat() + (nextPosition.lat() - position.lat()) * s / steps,
                                    position.lng() + (nextPosition.lng() - position.lng()) * s / steps
                                ));
                            }
                        }
                        
                        // Pick zoom level for this segment based on distance
                        const travelZoom = dist > 500 ? 6 : dist > 200 ? 7 : dist > 80 ? 9 : 11;
                        
                        // Follow the path at 20fps
                        const duration = dist > 300 ? 12000 : dist > 100 ? 9000 : 6000;
                        const frameDelay = 50;
                        const totalFrames = Math.round(duration / frameDelay);
                        const zoomTransitionFrames = 20; // Gradually zoom out over first 20 frames
                        const startZoom = 12;
                        
                        for (let f = 0; f <= totalFrames; f++) {
                            if (!DATA.isAnimating) break;
                            const t = f / totalFrames;
                            const pt = path[Math.min(Math.floor(t * (path.length - 1)), path.length - 1)];
                            DATA.googleMap.setCenter(pt);
                            if (window.animationMarker) window.animationMarker.setPosition(pt);
                            // Smoothly transition zoom during first N frames
                            if (f <= zoomTransitionFrames) {
                                const zoomT = f / zoomTransitionFrames;
                                DATA.googleMap.setZoom(Math.round(startZoom + (travelZoom - startZoom) * zoomT));
                            }
                            await wait(frameDelay);
                        }
                        
                    } else {
                        //  DIRECT JUMP MODE 
                        const zoomOut = dist > 500 ? 5 : dist > 200 ? 7 : dist > 80 ? 9 : 11;
                        
                        const duration = dist > 300 ? 8000 : dist > 100 ? 6000 : 4000;
                        const frameDelay = 50;
                        const totalFrames = Math.round(duration / frameDelay);
                        const zoomTransitionFramesDirect = 15;
                        
                        for (let f = 0; f <= totalFrames; f++) {
                            if (!DATA.isAnimating) break;
                            const t = f / totalFrames;
                            const lat = position.lat() + (nextPosition.lat() - position.lat()) * t;
                            const lng = position.lng() + (nextPosition.lng() - position.lng()) * t;
                            const pt = new google.maps.LatLng(lat, lng);
                            DATA.googleMap.setCenter(pt);
                            if (window.animationMarker) window.animationMarker.setPosition(pt);
                            // Gradually zoom out at start, back in at end
                            if (f <= zoomTransitionFramesDirect) {
                                const zT = f / zoomTransitionFramesDirect;
                                DATA.googleMap.setZoom(Math.round(12 + (zoomOut - 12) * zT));
                            } else if (f >= totalFrames - zoomTransitionFramesDirect) {
                                const zT = (totalFrames - f) / zoomTransitionFramesDirect;
                                DATA.googleMap.setZoom(Math.round(12 + (zoomOut - 12) * zT));
                            }
                            await wait(frameDelay);
                        }
                    }
                }
            }
            
            // Done - zoom out to show full trip
            hideDestination();
            if (window.animationMarker) { window.animationMarker.setMap(null); window.animationMarker = null; }
            DATA.isAnimating = false;
            renderWithoutFlash();
            const bounds = new google.maps.LatLngBounds();
            validLocations.forEach(loc => bounds.extend(new google.maps.LatLng(loc.lat, loc.lng)));
            DATA.googleMap.fitBounds(bounds, 40);
            showToast(' Animation complete', 'success');
        }
        
        // Smooth pan between two positions
        async function smoothPanBetween(from, to) {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(from, to);
            const kmDistance = distance / 1000;
            
            // Zoom out for long distances using native Maps easing
            let targetZoom = DATA.googleMap.getZoom();
            if (kmDistance > 500) targetZoom = 5;
            else if (kmDistance > 200) targetZoom = 7;
            else if (kmDistance > 50) targetZoom = 9;
            
            if (targetZoom < DATA.googleMap.getZoom()) {
                await smoothZoomTo(from, targetZoom);
            }
            
            // Smooth direct pan at 20fps over ~8 seconds
            const totalFrames = 160;
            const frameDelay = 50;
            const latStep = (to.lat() - from.lat()) / totalFrames;
            const lngStep = (to.lng() - from.lng()) / totalFrames;
            
            for (let i = 1; i <= totalFrames; i++) {
                if (!DATA.isAnimating) break;
                const pos = new google.maps.LatLng(
                    from.lat() + latStep * i,
                    from.lng() + lngStep * i
                );
                DATA.googleMap.setCenter(pos);
                if (window.animationMarker) window.animationMarker.setPosition(pos);
                await new Promise(resolve => setTimeout(resolve, frameDelay));
            }
        }
        
        // Stop animation
        function stopAnimation() {
            DATA.isAnimating = false;
            if (DATA.animationMarker) {
                DATA.animationMarker.setMap(null);
            }
            
            // Hide destination overlay if it exists
            const overlayDiv = document.getElementById('animation-overlay');
            if (overlayDiv) {
                overlayDiv.style.display = 'none';
            }
            
            renderWithoutFlash(); // Update button state
        }
        
        // Reset route cache
        function resetRouteCache(type, dayIndex) {
            if (type === 'main') {
                DATA.routeCache.main = null;
                showToast(' Main route cache cleared - will fetch fresh data', 'success');
            } else if (type === 'daily' && dayIndex !== undefined) {
                delete DATA.routeCache.daily[dayIndex];
                showToast(` Day ${dayIndex + 1} route cache cleared`, 'success');
            }
            saveToStorage();
            
            // Immediately redraw if in route mode
            if (type === 'main' && DATA.mapViewMode === 'route') {
                drawDirectionsRoute();
            }
        }
        
        // Add location to route
        function addRouteLocation() {
            showInputModal(
                'Add Location',
                'Enter location name (city, address, landmark)',
                'New York, NY',
                '',
                async (locationName) => {
                    if (!locationName.trim()) return;
                    
                    try {
                        const coords = await geocodeLocation(locationName);
                        DATA.mapRoute.push({
                            name: locationName,
                            lat: coords.lat,
                            lng: coords.lng,
                            type: 'waypoint'
                        });
                        saveToStorage();
                        initializeMap();
                        showToast(' Location added', 'success');
                    } catch (error) {
                        showToast(' Could not find location', 'error');
                    }
                }
            );
        }
        
        // Remove location from route
        function removeRouteLocation(index) {
            if (DATA.mapRoute[index].type === 'day') {
                showToast(' Cannot remove day locations. Edit in itinerary.', 'error');
                return;
            }
            
            DATA.mapRoute.splice(index, 1);
            saveToStorage();
            initializeMap();
            showToast(' Location removed', 'success');
        }
        
        // Reinitialize route from days
        function reinitializeRoute() {
            if (!confirm('Reset route from itinerary days? Custom waypoints will be lost.')) return;
            
            const rawRoute = DATA.days
                .map((d, originalIdx) => ({
                    day: d,
                    originalIndex: originalIdx
                }))
                .filter(item => item.day.loc) // Filter AFTER capturing original index
                .map(item => ({
                    name: item.day.loc,
                    lat: item.day.latitude || null,
                    lng: item.day.longitude || null,
                    type: 'day',
                    dayIndex: item.originalIndex,  // Use the captured original index!
                    dayNumber: item.day.d
                }));
            
            // Combine ONLY consecutive same locations (same as initialization)
            DATA.mapRoute = [];
            let i = 0;
            
            while (i < rawRoute.length) {
                const current = rawRoute[i];
                let consecutiveCount = 1;
                
                // Look ahead ONLY at the immediately following days
                while (i + consecutiveCount < rawRoute.length) {
                    const next = rawRoute[i + consecutiveCount];
                    
                    // Check if next day is the SAME location
                    const sameName = next.name.toLowerCase().trim() === current.name.toLowerCase().trim();
                    const sameCoords = current.lat && next.lat && 
                        Math.abs(current.lat - next.lat) < 0.0001 && 
                        Math.abs(current.lng - next.lng) < 0.0001;
                    
                    // If same location, continue counting
                    if (sameName || sameCoords) {
                        consecutiveCount++;
                    } else {
                        break;
                    }
                }
                
                // Create marker for this location (single or multi-day)
                if (consecutiveCount > 1) {
                    // Multiple consecutive days
                    const startDay = rawRoute[i].dayNumber;
                    const endDay = rawRoute[i + consecutiveCount - 1].dayNumber;
                    
                    DATA.mapRoute.push({
                        name: current.name,
                        displayName: `${current.name} (Days ${startDay}-${endDay})`,
                        lat: current.lat,
                        lng: current.lng,
                        type: 'day',
                        dayIndex: rawRoute[i].dayIndex,
                        endDayIndex: rawRoute[i + consecutiveCount - 1].dayIndex,
                        dayCount: consecutiveCount,
                        dayRange: `${startDay}-${endDay}`,
                        allDayIndices: Array.from({length: consecutiveCount}, (_, idx) => rawRoute[i + idx].dayIndex)
                    });
                } else {
                    // Single day
                    DATA.mapRoute.push({
                        name: current.name,
                        displayName: `${current.name} (Day ${current.dayNumber})`,
                        lat: current.lat,
                        lng: current.lng,
                        type: 'day',
                        dayIndex: current.dayIndex,
                        dayCount: 1,
                        dayNumber: current.dayNumber,
                        allDayIndices: [current.dayIndex]
                    });
                }
                
                i += consecutiveCount;
            }
            
            DATA.routeInitialized = true;
            saveToStorage();
            initializeMap();
            showToast(' Route reinitialized with ' + DATA.mapRoute.length + ' stops', 'success');
        }
        
        // Clean duplicate locations
        function cleanDuplicateLocations() {
            const before = DATA.mapRoute.length;
            
            // Remove locations without coordinates
            let cleaned = DATA.mapRoute.filter(loc => loc.lat && loc.lng);
            
            // Remove duplicates (within 0.001 degree tolerance)
            const unique = [];
            for (const loc of cleaned) {
                const isDuplicate = unique.some(existing => 
                    Math.abs(existing.lat - loc.lat) < 0.001 && 
                    Math.abs(existing.lng - loc.lng) < 0.001
                );
                if (!isDuplicate) {
                    unique.push(loc);
                }
            }
            
            DATA.mapRoute = unique;
            const after = DATA.mapRoute.length;
            const removed = before - after;
            
            saveToStorage();
            
            // Re-add markers without destroying map
            DATA.mapMarkers.forEach(marker => marker.setMap(null));
            DATA.mapMarkers = [];
            addRouteMarkersToMap();
            
            showToast(` Cleaned ${removed} duplicate/invalid locations. Now ${after} stops.`, 'success');
        }
        
        // Load and display transit info for a day
        async function loadTransitInfo(dayIndex) {
            const infoEl = document.getElementById(`transit-info-${dayIndex}`);
            if (!infoEl) return;
            
            // Show loading
            infoEl.innerHTML = '<span style="opacity:0.5;"> Calculating...</span>';
            
            const info = await getTransitInfo(dayIndex);
            
            if (info) {
                const icons = {TRANSIT: '', DRIVING: '', WALKING: '', BICYCLING: ''};
                infoEl.innerHTML = `
                    <span>${icons[info.mode]} ${info.distance}, ${info.duration}</span>
                    <span style="opacity:0.6;"> ${info.to}</span>
                `;
            } else {
                infoEl.innerHTML = '<span style="opacity:0.5;"> No route found</span>';
            }
        }
        
        // Debug route order
        function debugRouteOrder() {
            console.log('=== ROUTE DEBUG ===');
            console.log('Total locations:', DATA.mapRoute.length);
        
        // Get transit info between current day and next day
        async function getTransitInfo(dayIndex) {
            if (dayIndex >= DATA.days.length - 1) return null; // Last day, no next
            
            const currentDay = DATA.days[dayIndex];
            const nextDay = DATA.days[dayIndex + 1];
            
            // Check if we already have cached transit info
            if (currentDay.transitInfo && currentDay.transitInfo.to === nextDay.loc) {
                return currentDay.transitInfo;
            }
            
            // Both need coordinates
            if (!currentDay.latitude || !currentDay.longitude || !nextDay.latitude || !nextDay.longitude) {
                return null;
            }
            
            // Same location = no transit
            if (Math.abs(currentDay.latitude - nextDay.latitude) < 0.0001 && 
                Math.abs(currentDay.longitude - nextDay.longitude) < 0.0001) {
                return null;
            }
            
            try {
                const directionsService = new google.maps.DirectionsService();
                
                // Try transit modes in priority order
                for (const mode of DATA.transportPriority) {
                    try {
                        const result = await new Promise((resolve, reject) => {
                            directionsService.route({
                                origin: new google.maps.LatLng(currentDay.latitude, currentDay.longitude),
                                destination: new google.maps.LatLng(nextDay.latitude, nextDay.longitude),
                                travelMode: google.maps.TravelMode[mode]
                            }, (result, status) => {
                                if (status === 'OK') {
                                    resolve(result);
                                } else {
                                    reject(new Error(status));
                                }
                            });
                        });
                        
                        // Success! Extract info
                        const leg = result.routes[0].legs[0];
                        const info = {
                            to: nextDay.loc,
                            mode: mode,
                            distance: leg.distance.text,
                            duration: leg.duration.text,
                            distanceValue: leg.distance.value, // meters
                            durationValue: leg.duration.value // seconds
                        };
                        
                        // Cache it
                        currentDay.transitInfo = info;
                        saveToStorage();
                        
                        return info;
                    } catch (err) {
                        continue; // Try next mode
                    }
                }
                
                return null; // No route found
            } catch (error) {
                console.error('Transit info error:', error);
                return null;
            }
        }
            console.log('\nRoute order:');
            DATA.mapRoute.forEach((loc, i) => {
                const latStr = loc.lat ? loc.lat.toFixed(4) : 'NO LAT';
                const lngStr = loc.lng ? loc.lng.toFixed(4) : 'NO LNG';
                console.log(`${i + 1}. ${loc.name} (${latStr}, ${lngStr}) [${loc.type}]`);
            });
            console.log('\n=== END DEBUG ===');
            showToast('Route order logged to console (F12)', 'info');
        }
        
        // Toggle marker lock state
        // Transport priority management functions
        function moveTransportPriority(fromIndex, toIndex) {
            const item = DATA.transportPriority.splice(fromIndex, 1)[0];
            DATA.transportPriority.splice(toIndex, 0, item);
            saveToStorage();
            renderWithoutFlash();
        }
        
        function removeTransportPriority(index) {
            if (DATA.transportPriority.length <= 1) {
                showToast(' Must have at least one transport mode', 'error');
                return;
            }
            DATA.transportPriority.splice(index, 1);
            saveToStorage();
            renderWithoutFlash();
        }
        
        function addTransportPriority(mode) {
            if (!DATA.transportPriority.includes(mode)) {
                DATA.transportPriority.push(mode);
                saveToStorage();
                renderWithoutFlash();
                showToast(` Added ${mode} to priority list`, 'success');
            }
        }
        
        function toggleMarkerLock() {
            DATA.markersLocked = !DATA.markersLocked;
            saveToStorage();
            
            // Update all markers
            DATA.mapMarkers.forEach(marker => marker.setDraggable(!DATA.markersLocked));
            
            // Update button
            const btn = document.getElementById('markerLockButton');
            if (btn) {
                btn.innerHTML = DATA.markersLocked ? ' Locked' : ' Unlocked';
                btn.style.background = DATA.markersLocked ? '#ef4444' : '';
                btn.style.color = DATA.markersLocked ? 'white' : '';
            }
            
            showToast(DATA.markersLocked ? ' Markers locked' : ' Markers unlocked', 'info');
        }
        
        // Update button colors without full re-render
        function updateButtonColors() {
            // Update travel mode buttons
            document.querySelectorAll('[data-travel-mode]').forEach(btn => {
                const mode = btn.getAttribute('data-travel-mode');
                if (mode === DATA.mapTravelMode) {
                    btn.style.background = '#0d9488';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                }
            });
            
            // Update route style buttons
            document.querySelectorAll('[data-route-style]').forEach(btn => {
                const style = btn.getAttribute('data-route-style');
                if (style === DATA.mapRouteStyle) {
                    btn.style.background = '#22c55e';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                }
            });
            
            // Update view mode buttons
            document.querySelectorAll('[data-view-mode]').forEach(btn => {
                const mode = btn.getAttribute('data-view-mode');
                if (mode === DATA.mapViewMode) {
                    btn.style.background = '#0d9488';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                }
            });
        }
        
        // Toggle route editor without destroying map
        function toggleRouteEditor() {
            DATA.showRouteEditor = !DATA.showRouteEditor;
            saveToStorage();
            
            // Just toggle visibility of the editor section
            const editorContent = document.getElementById('routeEditorContent');
            if (editorContent) {
                editorContent.style.display = DATA.showRouteEditor ? 'block' : 'none';
            }
            
            // Update arrow direction
            const arrow = document.getElementById('routeEditorArrow');
            if (arrow) {
                arrow.style.transform = DATA.showRouteEditor ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }
        
        // Open daily itinerary map for a specific day

        // Initialize today's embedded map
        async function initializeTodayMap(dayIndex) {
            console.log('initializeTodayMap called for day', dayIndex);
            const day = DATA.days[dayIndex];
            if (!day) {
                console.error('No day found at index', dayIndex);
                return;
            }
            
            const mapContainer = document.getElementById(`todayMap${dayIndex}`);
            if (!mapContainer) {
                console.error('Map container not found:', `todayMap${dayIndex}`);
                return;
            }
            
            // Ensure container is visible and has dimensions
            if (mapContainer.offsetHeight === 0) {
                console.warn('Map container has no height, setting minimum height');
                mapContainer.style.minHeight = '400px';
                mapContainer.style.height = '400px';
            }
            
            console.log('Map container found with dimensions:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
            
            try {
                await loadGoogleMapsAPI();
                
                console.log('Google Maps API loaded, creating map...');
                
                // Always clear existing instance to force fresh render
                if (window.todayMapInstance) {
                    console.log('Clearing old today map instance');
                    window.todayMapInstance = null;
                }
                
                // Clear container content
                mapContainer.innerHTML = '';
                
                // Get center from day location or default
                const centerLat = day.latitude || 35.6762;
                const centerLng = day.longitude || 139.6503;
                
                console.log('Creating map at', centerLat, centerLng);
                
                // Create today map with a small delay to ensure container is ready
                await new Promise(resolve => setTimeout(resolve, 100));
                
                window.todayMapInstance = new google.maps.Map(mapContainer, {
                    center: { lat: centerLat, lng: centerLng },
                    zoom: 13,
                    mapTypeControl: true,
                    streetViewControl: true
                });
                
                console.log('Map created successfully');
                
                // Create bounds to fit all markers
                const bounds = new google.maps.LatLngBounds();
                let hasMarkers = false;
                
                // Add marker for day location
                if (day.latitude && day.longitude) {
                    new google.maps.Marker({
                        position: { lat: day.latitude, lng: day.longitude },
                        map: window.todayMapInstance,
                        title: day.loc || 'Today',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#10b981',
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 2
                        }
                    });
                    bounds.extend({ lat: day.latitude, lng: day.longitude });
                    hasMarkers = true;
                    console.log('Day marker added');
                }
                
                // Add existing POIs
                if (DATA.dailyMapPoints[dayIndex] && DATA.dailyMapPoints[dayIndex].length > 0) {
                    DATA.dailyMapPoints[dayIndex].forEach((poi, idx) => {
                        new google.maps.Marker({
                            position: { lat: poi.lat, lng: poi.lng },
                            map: window.todayMapInstance,
                            title: poi.name,
                            label: {
                                text: (idx + 1).toString(),
                                color: 'white',
                                fontSize: '12px',
                                fontWeight: 'bold'
                            },
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 16,
                                fillColor: '#0d9488',
                                fillOpacity: 1,
                                strokeColor: 'white',
                                strokeWeight: 2
                            }
                        });
                        bounds.extend({ lat: poi.lat, lng: poi.lng });
                        hasMarkers = true;
                    });
                    console.log('POI markers added:', DATA.dailyMapPoints[dayIndex].length);
                }
                
                // Fit map to show all markers if we have POIs, otherwise center on day location
                if (hasMarkers && DATA.dailyMapPoints[dayIndex] && DATA.dailyMapPoints[dayIndex].length > 0) {
                    console.log('Fitting map to all markers');
                    window.todayMapInstance.fitBounds(bounds);
                    
                    // Don't zoom in too much if only one POI
                    google.maps.event.addListenerOnce(window.todayMapInstance, 'bounds_changed', () => {
                        if (DATA.dailyMapPoints[dayIndex].length === 1 && window.todayMapInstance.getZoom() > 15) {
                            window.todayMapInstance.setZoom(15);
                        }
                    });
                } else {
                    console.log('No POIs, keeping default center and zoom');
                }
                
                // Button to open full planning map
                const openPlanningBtn = document.createElement('button');
                openPlanningBtn.innerHTML = ' Plan Day';
                openPlanningBtn.style.cssText = 'position:absolute;top:10px;right:10px;padding:10px 20px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:1000;';
                openPlanningBtn.onclick = () => openDailyMap(dayIndex);
                mapContainer.style.position = 'relative';
                mapContainer.appendChild(openPlanningBtn);
                
                console.log('Today map initialization complete');
                
            } catch (error) {
                console.error('Today map error:', error);
                mapContainer.innerHTML = `<div style="padding:20px;text-align:center;color:#000;">
                    <p style="font-weight:600;">Failed to load map</p>
                    <p style="font-size:12px;margin-top:8px;">${error.message}</p>
                    <p style="font-size:11px;margin-top:4px;color:#666;">Check console for details</p>
                </div>`;
            }
        }
        
        function openDailyMap(dayIndex) {
            DATA.showDailyMap = dayIndex;
            
            // Initialize dailyMapPoints if not exists
            if (!DATA.dailyMapPoints[dayIndex]) {
                DATA.dailyMapPoints[dayIndex] = [];
            }
            
            saveToStorage();
            renderWithoutFlash();
        }
        
        // Close daily map
        function closeDailyMap() {
            // Clean up daily map instance
            if (window.currentDailyMap) {
                window.currentDailyMap = null;
            }
            if (window.dailyMapMarkers) {
                window.dailyMapMarkers = [];
            }
            
            DATA.showDailyMap = null;
            saveToStorage();
            renderWithoutFlash();
        }
        
        // Initialize daily map
        async function initializeDailyMap(dayIndex) {
            const day = DATA.days[dayIndex];
            if (!day) return;
            
            const mapContainer = document.getElementById(`dailyMap${dayIndex}`);
            if (!mapContainer) return;
            
            try {
                await loadGoogleMapsAPI();
                
                // Get center from day location or default
                const centerLat = day.latitude || 35.6762;
                const centerLng = day.longitude || 139.6503;
                
                // Create daily map
                window.currentDailyMap = new google.maps.Map(mapContainer, {
                    center: { lat: centerLat, lng: centerLng },
                    zoom: 13, // Zoomed in for city exploration
                    mapTypeControl: true,
                    streetViewControl: true
                });
                
                // Add click listener to add POI
                window.currentDailyMap.addListener('click', (e) => {
                    const lat = e.latLng.lat();
                    const lng = e.latLng.lng();
                    addPoiAtLocation(dayIndex, lat, lng);
                });
                
                // Initialize markers array
                window.dailyMapMarkers = [];
                
                // Add existing POIs
                if (DATA.dailyMapPoints[dayIndex]) {
                    DATA.dailyMapPoints[dayIndex].forEach((poi, idx) => {
                        addDailyMarker(poi, idx);
                    });
                }
                
                // Set up search with location bias
                const searchInput = document.getElementById(`dailyPoiSearch${dayIndex}`);
                if (searchInput && window.google && window.google.maps && window.google.maps.places) {
                    // Create bias circle around day location
                    const circle = new google.maps.Circle({
                        center: { lat: centerLat, lng: centerLng },
                        radius: 50000 // 50km radius
                    });
                    
                    const autocomplete = new google.maps.places.Autocomplete(searchInput, {
                        bounds: circle.getBounds(),
                        strictBounds: false,
                        fields: ['name', 'geometry', 'formatted_address', 'types', 'place_id']
                        // Removed types restriction to allow all place types (restaurants, attractions, parks, etc.)
                        // This will exclude transit stations by default while showing all other POIs
                    });
                    
                    // Update bounds as map moves
                    window.currentDailyMap.addListener('bounds_changed', () => {
                        autocomplete.setBounds(window.currentDailyMap.getBounds());
                    });
                    
                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        
                        if (!place.geometry || !place.geometry.location) {
                            showToast(' No location found for: ' + (place.name || 'this place'), 'error');
                            return;
                        }
                        
                        // Add POI
                        const poi = {
                            name: place.name,
                            lat: place.geometry.location.lat(),
                            lng: place.geometry.location.lng(),
                            category: place.types ? place.types[0] : '',
                            notes: place.formatted_address || ''
                        };
                        
                        if (!DATA.dailyMapPoints[dayIndex]) {
                            DATA.dailyMapPoints[dayIndex] = [];
                        }
                        DATA.dailyMapPoints[dayIndex].push(poi);
                        saveToStorage();
                        
                        // Add marker
                        addDailyMarker(poi, DATA.dailyMapPoints[dayIndex].length - 1);
                        
                        // Pan to location and zoom
                        window.currentDailyMap.panTo(place.geometry.location);
                        window.currentDailyMap.setZoom(15);
                        
                        // Clear search box
                        searchInput.value = '';
                        
                        // Update list
                        renderWithoutFlash();
                        
                        showToast(` Added: ${place.name}`, 'success');
                    });
                }
                
            } catch (error) {
                console.error('Daily map error:', error);
                showToast(' Could not load map', 'error');
            }
        }
        
        // Add POI at clicked location
        function addPoiAtLocation(dayIndex, lat, lng) {
            const name = prompt('Name this place:');
            if (!name) return;
            
            const poi = {
                name: name.trim(),
                lat: lat,
                lng: lng,
                category: 'Custom',
                notes: ''
            };
            
            if (!DATA.dailyMapPoints[dayIndex]) {
                DATA.dailyMapPoints[dayIndex] = [];
            }
            DATA.dailyMapPoints[dayIndex].push(poi);
            saveToStorage();
            
            addDailyMarker(poi, DATA.dailyMapPoints[dayIndex].length - 1);
            renderWithoutFlash();
        }
        
        // Add custom POI via button
        function addCustomDailyPoi(dayIndex) {
            const name = prompt('Place name:');
            if (!name) return;
            
            const day = DATA.days[dayIndex];
            const lat = day.latitude || 35.6762;
            const lng = day.longitude || 139.6503;
            
            const poi = {
                name: name.trim(),
                lat: lat,
                lng: lng,
                category: 'Custom',
                notes: ''
            };
            
            if (!DATA.dailyMapPoints[dayIndex]) {
                DATA.dailyMapPoints[dayIndex] = [];
            }
            DATA.dailyMapPoints[dayIndex].push(poi);
            saveToStorage();
            
            if (window.currentDailyMap) {
                addDailyMarker(poi, DATA.dailyMapPoints[dayIndex].length - 1);
            }
            renderWithoutFlash();
        }
        
        // Add marker to daily map
        function addDailyMarker(poi, index) {
            if (!window.currentDailyMap) return;
            
            const marker = new google.maps.Marker({
                position: { lat: poi.lat, lng: poi.lng },
                map: window.currentDailyMap,
                title: poi.name,
                label: {
                    text: String(index + 1),
                    color: 'white',
                    fontSize: '12px',
                    fontWeight: 'bold'
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 16,
                    fillColor: '#10b981',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                }
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `<div style="padding:8px;"><strong>${poi.name}</strong><br/>${poi.notes || ''}</div>`
            });
            
            marker.addListener('click', () => {
                infoWindow.open(window.currentDailyMap, marker);
            });
            
            if (!window.dailyMapMarkers) window.dailyMapMarkers = [];
            window.dailyMapMarkers.push(marker);
        }
        
        // POI drag and drop handlers
        let draggedPoiIndex = null;
        
        function handlePoiDragStart(event, dayIndex, poiIndex) {
            draggedPoiIndex = poiIndex;
            event.currentTarget.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handlePoiDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.style.borderColor = '#0d9488';
            event.currentTarget.style.borderStyle = 'dashed';
        }
        
        function handlePoiDrop(event, dayIndex, dropIndex) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#e5e7eb';
            event.currentTarget.style.borderStyle = 'solid';
            
            if (draggedPoiIndex === null || draggedPoiIndex === dropIndex) return;
            
            // Reorder the POIs
            const pois = DATA.dailyMapPoints[dayIndex];
            const [movedPoi] = pois.splice(draggedPoiIndex, 1);
            pois.splice(dropIndex, 0, movedPoi);
            
            saveToStorage();
            
            // Refresh markers with new order
            if (window.dailyMapMarkers) {
                window.dailyMapMarkers.forEach(m => m.setMap(null));
                window.dailyMapMarkers = [];
                
                pois.forEach((poi, idx) => {
                    addDailyMarker(poi, idx);
                });
            }
            
            renderWithoutFlash();
            showToast(' POI order updated', 'success');
        }
        
        function handlePoiDragEnd(event) {
            event.currentTarget.style.opacity = '1';
            event.currentTarget.style.borderColor = '#e5e7eb';
            event.currentTarget.style.borderStyle = 'solid';
            draggedPoiIndex = null;
        }
        
        // Remove POI
        function removeDailyPoi(dayIndex, poiIndex) {
            if (!DATA.dailyMapPoints[dayIndex]) return;
            
            DATA.dailyMapPoints[dayIndex].splice(poiIndex, 1);
            saveToStorage();
            
            // Refresh map
            if (window.dailyMapMarkers) {
                window.dailyMapMarkers.forEach(m => m.setMap(null));
                window.dailyMapMarkers = [];
                
                DATA.dailyMapPoints[dayIndex].forEach((poi, idx) => {
                    addDailyMarker(poi, idx);
                });
            }
            
            renderWithoutFlash();
        }
        
        // Draw route between POIs
        async function drawDailyRoute(dayIndex) {
            if (!window.currentDailyMap || !DATA.dailyMapPoints[dayIndex] || DATA.dailyMapPoints[dayIndex].length < 2) {
                showToast(' Need at least 2 places for route', 'error');
                return;
            }
            
            const pois = DATA.dailyMapPoints[dayIndex];
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                map: window.currentDailyMap,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#10b981',
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });
            
            // Use WALKING mode for daily routes
            const waypoints = pois.slice(1, -1).map(poi => ({
                location: new google.maps.LatLng(poi.lat, poi.lng),
                stopover: true
            }));
            
            try {
                const result = await new Promise((resolve, reject) => {
                    directionsService.route({
                        origin: new google.maps.LatLng(pois[0].lat, pois[0].lng),
                        destination: new google.maps.LatLng(pois[pois.length - 1].lat, pois[pois.length - 1].lng),
                        waypoints: waypoints.length > 8 ? waypoints.slice(0, 8) : waypoints, // Max 8 waypoints for walking
                        travelMode: google.maps.TravelMode.WALKING
                    }, (result, status) => {
                        if (status === 'OK') {
                            resolve(result);
                        } else {
                            reject(new Error(status));
                        }
                    });
                });
                
                directionsRenderer.setDirections(result);
                
                // Calculate total distance and time
                let totalDistance = 0;
                let totalTime = 0;
                result.routes[0].legs.forEach(leg => {
                    totalDistance += leg.distance.value;
                    totalTime += leg.duration.value;
                });
                
                const km = (totalDistance / 1000).toFixed(1);
                const hours = Math.floor(totalTime / 3600);
                const mins = Math.floor((totalTime % 3600) / 60);
                const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                
                showToast(` Route: ${km} km, ~${timeStr} walking`, 'success');
                
            } catch (error) {
                console.error('Route error:', error);
                showToast(` Could not create walking route`, 'error');
            }
        }
        
        // Save edited location name without destroying map
        function saveLocationNameWithoutRender(index) {
            const input = document.getElementById(`editLocationName${index}`);
            if (input && input.value.trim()) {
                DATA.mapRoute[index].name = input.value.trim();
                DATA.mapRoute[index].displayName = input.value.trim();
                DATA.editingLocationName = null;
                saveToStorage();
                showToast(' Name updated! Click "Re-geocode" to get new coordinates.', 'success');
                
                // Refresh markers without destroying map
                DATA.mapMarkers.forEach(m => m.setMap(null));
                DATA.mapMarkers = [];
                addRouteMarkersToMap();
            }
        }
        
        // Start editing location name
        function startEditLocationName(index) {
            DATA.editingLocationName = index;
            // Refresh markers without destroying map
            DATA.mapMarkers.forEach(m => m.setMap(null));
            DATA.mapMarkers = [];
            addRouteMarkersToMap();
        }
        
        // Cancel editing location name
        function cancelEditLocationName(index) {
            DATA.editingLocationName = null;
            // Refresh markers without destroying map
            DATA.mapMarkers.forEach(m => m.setMap(null));
            DATA.mapMarkers = [];
            addRouteMarkersToMap();
        }
        
        // Remove waypoint without destroying map
        function removeRouteLocationWithoutRender(index) {
            DATA.mapRoute.splice(index, 1);
            saveToStorage();
            showToast(' Waypoint removed', 'success');
            
            // Refresh markers without destroying map
            DATA.mapMarkers.forEach(m => m.setMap(null));
            DATA.mapMarkers = [];
            addRouteMarkersToMap();
        }
        
        // Save edited location name
        function saveLocationName(index) {
            const input = document.getElementById(`editLocationName${index}`);
            if (input && input.value.trim()) {
                DATA.mapRoute[index].name = input.value.trim();
                DATA.mapRoute[index].displayName = input.value.trim();
                DATA.editingLocationName = null;
                saveToStorage();
                showToast(' Name updated! Click "Re-geocode" to get new coordinates.', 'success');
                addRouteMarkersToMap();
            }
        }
        
        // Re-geocode a specific location
        async function regeocodeLocation(index) {
            const loc = DATA.mapRoute[index];
            if (!loc) return;
            
            try {
                showToast(` Geocoding ${loc.name}...`, 'info');
                const coords = await geocodeLocation(loc.name);
                loc.lat = coords.lat;
                loc.lng = coords.lng;
                
                // Update day object if it's a day location
                if (loc.type === 'day' && loc.dayIndex !== undefined) {
                    DATA.days[loc.dayIndex].latitude = coords.lat;
                    DATA.days[loc.dayIndex].longitude = coords.lng;
                }
                
                saveToStorage();
                showToast(` ${loc.name} re-geocoded!`, 'success');
                
                // Re-add markers
                addRouteMarkersToMap();
                
            } catch (error) {
                showToast(` Could not geocode ${loc.name}`, 'error');
            }
        }
        
        // Clear all geocoded coordinates (forces re-geocoding)
        function clearAllCoordinates() {
            if (!confirm('Clear all coordinates? This will remove bad geocoding data. You will need to re-geocode locations.')) return;
            
            // Clear coordinates from route
            DATA.mapRoute.forEach(loc => {
                loc.lat = null;
                loc.lng = null;
            });
            
            // Clear coordinates from days
            DATA.days.forEach(day => {
                day.latitude = null;
                day.longitude = null;
            });
            
            // Clear map objects
            DATA.mapMarkers.forEach(marker => marker.setMap(null));
            DATA.mapMarkers = [];
            DATA.googleMap = null;
            DATA.directionsRenderer = null;
            
            // Reset initialization flag
            DATA.routeInitialized = false;
            
            saveToStorage();
            showToast(' All coordinates cleared! Map will re-geocode on next load.', 'success');
            renderWithoutFlash();
        }
        
        // Center map on all trip locations

        function updateButtonColors() {
            // Update animation style buttons
            document.querySelectorAll('[data-animation-mode]').forEach(btn => {
                const mode = btn.getAttribute('data-animation-mode');
                if ((mode === 'direct' && !DATA.animationFollowRoute) || 
                    (mode === 'follow' && DATA.animationFollowRoute)) {
                    btn.style.background = '#0d9488';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                }
            });
            
            // Update view mode buttons
            document.querySelectorAll('[data-view-mode]').forEach(btn => {
                const mode = btn.getAttribute('data-view-mode');
                if (mode === DATA.mapViewMode) {
                    btn.style.background = '#0d9488';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                }
            });
        }

        function centerMapOnTrip() {
            if (!DATA.googleMap || DATA.mapMarkers.length === 0) return;
            
            const bounds = new google.maps.LatLngBounds();
            DATA.mapMarkers.forEach(marker => {
                bounds.extend(marker.getPosition());
            });
            
            DATA.googleMap.fitBounds(bounds);
        }
        
        // ========================================
        
        // Photo Export Functions
        function exportAllPhotos() {
            const allPhotos = [];
            DATA.days.forEach((day, dayIndex) => {
                if (day.photos && day.photos.length > 0) {
                    day.photos.forEach((photo, photoIndex) => {
                        allPhotos.push({
                            dayIndex,
                            photoIndex,
                            dayNum: day.d,
                            location: day.loc,
                            date: day.dt,
                            src: photo.src
                        });
                    });
                }
            });
            
            if (allPhotos.length === 0) {
                showToast(' No photos to export', 'error');
                return;
            }
            
            // Download each photo
            allPhotos.forEach((photo, idx) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = photo.src;
                    link.download = `Day${photo.dayNum}_${photo.location}_Photo${photo.photoIndex + 1}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, idx * 200); // Stagger downloads
            });
            
            showToast(`Exporting ${allPhotos.length} photos...`, 'success');
        }
        
        function exportSelectedPhotos() {
            if (!DATA.selectedPhotos || DATA.selectedPhotos.length === 0) {
                showToast(' No photos selected', 'error');
                return;
            }
            
            DATA.selectedPhotos.forEach((selection, idx) => {
                const day = DATA.days[selection.dayIndex];
                const photo = day.photos[selection.photoIndex];
                
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = photo.src;
                    link.download = `Day${day.d}_${day.loc}_Photo${selection.photoIndex + 1}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, idx * 200);
            });
            
            showToast(`Exporting ${DATA.selectedPhotos.length} photos...`, 'success');
            DATA.photoSelectMode = false;
            DATA.selectedPhotos = [];
            renderWithoutFlash();
        }
        
        function togglePhotoSelection(dayIndex, photoIndex) {
            if (!DATA.selectedPhotos) DATA.selectedPhotos = [];
            
            const existingIndex = DATA.selectedPhotos.findIndex(
                p => p.dayIndex === dayIndex && p.photoIndex === photoIndex
            );
            
            if (existingIndex >= 0) {
                DATA.selectedPhotos.splice(existingIndex, 1);
            } else {
                DATA.selectedPhotos.push({ dayIndex, photoIndex });
            }
            
            renderWithoutFlash();
        }
        
        function isPhotoSelected(dayIndex, photoIndex) {
            if (!DATA.selectedPhotos) return false;
            return DATA.selectedPhotos.some(
                p => p.dayIndex === dayIndex && p.photoIndex === photoIndex
            );
        }
        
        // Sidebar
        function toggleSidebar() {
            DATA.sidebarOpen = !DATA.sidebarOpen;
            renderWithoutFlash();
        }
        
        function closeSidebar() {
            DATA.sidebarOpen = false;
            renderWithoutFlash();
        }
        
        /* ========================================== */
        
        const calc = (d) => {
            let total = 0;
            DATA.categories.forEach(cat => {
                total += d[cat.id]?.p || 0;
            });
            return total;
        };

        const calcA = (d) => {
            let total = 0;
            DATA.categories.forEach(cat => {
                total += d.a?.[cat.id] || 0;
            });
            return total;
        };


        const copyToClipboard = async (text, successMessage = 'Copied to clipboard!') => {
            try {
                await navigator.clipboard.writeText(text);
                
                // Create and show toast notification (same style as save notification)
                const toast = document.createElement('div');
                toast.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="font-size:20px;"></span>
                        <span>${successMessage}</span>
                    </div>
                `;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #10b981;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    font-size: 15px;
                    font-weight: 600;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: slideUp 0.3s ease-out;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideDown 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Failed to copy to clipboard. Please try again.');
            }
        };
        
        // ========================================
        // TOOLTIP SYSTEM FOR TRUNCATED TEXT
        // ========================================
        let activeTooltip = null;
        let tooltipTimeout = null;
        
        const showTooltip = (element, text) => {
            if (!text || text.trim() === '') return;
            
            // Remove any existing tooltip
            hideTooltip();
            
            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'truncate-tooltip';
            tooltip.textContent = text;
            tooltip.style.cssText = `
                position: fixed;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 10px 14px;
                border-radius: 8px;
                font-size: 13px;
                max-width: 320px;
                word-wrap: break-word;
                z-index: 10001;
                pointer-events: none;
                box-shadow: 0 4px 16px rgba(0,0,0,0.4);
                line-height: 1.4;
            `;
            
            document.body.appendChild(tooltip);
            activeTooltip = tooltip;
            
            // Position tooltip near the element
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            // Calculate position (try to show above, if not enough space show below)
            let top = rect.top - tooltipRect.height - 10;
            if (top < 10) {
                top = rect.bottom + 10;
            }
            
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            
            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
            tooltip.style.opacity = '0';
            tooltip.style.transition = 'opacity 0.2s';
            
            // Fade in
            setTimeout(() => {
                tooltip.style.opacity = '1';
            }, 10);
        };
        
        const hideTooltip = () => {
            if (activeTooltip) {
                activeTooltip.style.opacity = '0';
                setTimeout(() => {
                    if (activeTooltip) {
                        activeTooltip.remove();
                        activeTooltip = null;
                    }
                }, 200);
            }
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = null;
            }
        };
        
        const setupTruncateTooltips = () => {
            // Find all elements that might have truncated text
            // Exclude elements that already have interactive hovers (like day-jump-box)
            const selectors = [
                '[style*="text-overflow"][style*="ellipsis"]',
                '[style*="text-overflow:ellipsis"]',
                '.calendar-cell-location div'
            ];
            
            const elements = document.querySelectorAll(selectors.join(','));
            
            elements.forEach(element => {
                // Skip if already has tooltip listener
                if (element.hasAttribute('data-tooltip-ready')) return;
                
                // Skip elements that have interactive hovers (day-jump-box, buttons, etc.)
                if (element.closest('.day-jump-box, button, .analytics-card, .search-result-item')) return;
                
                element.setAttribute('data-tooltip-ready', 'true');
                
                // Get text from title attribute if available, otherwise from textContent
                const getText = () => {
                    if (element.hasAttribute('title')) {
                        return element.getAttribute('title');
                    }
                    return element.textContent.trim();
                };
                
                // Check if text is actually truncated
                const isTruncated = () => {
                    // If element has title attribute, it's meant to show tooltip
                    if (element.hasAttribute('title')) return true;
                    // Otherwise check if content is actually truncated
                    return element.scrollWidth > element.clientWidth || element.scrollHeight > element.clientHeight;
                };
                
                let hoverTimeout;
                
                // Hover tooltip for desktop - with delay to integrate with card hover
                element.addEventListener('mouseenter', () => {
                    if (!isTruncated()) return;
                    const text = getText();
                    if (text) {
                        // Delay tooltip to let card hover activate first
                        hoverTimeout = setTimeout(() => {
                            showTooltip(element, text);
                        }, 300); // 300ms delay - quick but not instant
                    }
                });
                
                element.addEventListener('mouseleave', () => {
                    clearTimeout(hoverTimeout);
                    hideTooltip();
                });
                
                // Long-press tooltip for mobile (500ms)
                let pressTimer;
                let touchMoved = false;
                
                element.addEventListener('touchstart', (e) => {
                    if (!isTruncated()) return;
                    touchMoved = false;
                    const text = getText();
                    if (text) {
                        pressTimer = setTimeout(() => {
                            if (!touchMoved) {
                                e.preventDefault();
                                showTooltip(element, text);
                            }
                        }, 500);
                    }
                });
                
                element.addEventListener('touchmove', () => {
                    touchMoved = true;
                    clearTimeout(pressTimer);
                    hideTooltip();
                });
                
                element.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                    // Don't hide immediately on touchend - let user read tooltip
                    if (activeTooltip) {
                        setTimeout(() => hideTooltip(), 2000);
                    }
                });
                
                element.addEventListener('touchcancel', () => {
                    clearTimeout(pressTimer);
                    hideTooltip();
                });
            });
        };
        
        const addDay = () => {
            let newDayNumber = DATA.days.length + 1;
            let newDate = '';
            
            if (DATA.days.length === 0) {
                // First day - use trip start date
                newDate = DATA.tripStartDate;
            } else {
                // Add to end
                const lastDay = DATA.days[DATA.days.length - 1];
                newDayNumber = lastDay.d + 1;
                newDate = ''; // Will be calculated
            }
            
            const newDay = {
                d: newDayNumber,
                dt: newDate,
                loc: 'New Location', // Always use "New Location" for new days
                note: '',
                done: false,
                a: {},
                photos: [],
                receipts: [],
                journalNote: '',
                schedule: [],
                showSchedule: false,
                weather: null,
                weatherLoading: false,
            };
            
            // Add all category fields
            DATA.categories.forEach(cat => {
                newDay[cat.id] = {d: '', p: 0};
                newDay.a[cat.id] = 0;
            });
            
            DATA.days.push(newDay);
            recalculateDates();
            saveToStorage();
            renderWithoutFlash();
        };

        const deleteDay = (idx) => {
            showConfirmModal('Delete Day', `Delete Day ${DATA.days[idx].d} - ${DATA.days[idx].loc}?`, (confirmed) => {
                if (confirmed) {
                    DATA.days.splice(idx, 1);
                    // Renumber remaining days
                    DATA.days.forEach((day, i) => {
                        day.d = i + 1;
                    });
                    
                    // Recalculate all dates
                    recalculateDates();
                    
                    if (DATA.expanded === idx) DATA.expanded = null;
                    saveToStorage();
                    renderWithoutFlash();
                }
            });
        };

        const duplicateDay = (idx) => {
            const original = DATA.days[idx];
            const duplicate = {
                ...original,
                d: DATA.days.length + 1,
                done: false,
                a: {acc: 0, trn: 0, food: 0, act: 0},
                photos: [],
                journalNote: '',
                schedule: [...original.schedule],
                acc: {...original.acc},
                trn: {...original.trn},
                food: {...original.food},
                act: {...original.act}
            };
            DATA.days.push(duplicate);
            saveToStorage();
            renderWithoutFlash();
        };
    
        const insertDayAfter = (idx) => {
            const insertPosition = idx + 1;
            
            const newDay = {
                d: insertPosition + 1, // Temporary, will be renumbered
                dt: '', // Will be calculated
                loc: 'New Location',
                note: '',
                done: false,
                a: {},
                photos: [],
                receipts: [],
                journalNote: '',
                schedule: [],
                showSchedule: false,
                weather: null,
                weatherLoading: false,
            };
            
            // Add all category fields
            DATA.categories.forEach(cat => {
                newDay[cat.id] = {d: '', p: 0};
                newDay.a[cat.id] = 0;
            });
            
            // Insert the new day
            DATA.days.splice(insertPosition, 0, newDay);
            
            // Renumber all days
            DATA.days.forEach((day, i) => {
                day.d = i + 1;
            });
            
            // Recalculate all dates based on first day
            recalculateDates();
            
            saveToStorage();
            showToast(' Day inserted', 'success');
            renderWithoutFlash();
        };

        const stats = () => {
            let tP = 0, tA = 0, done = 0;
            let catP = {};
            let catA = {};
            let itemsP = {};
            let itemsA = {};
            
            // Initialize categories
            DATA.categories.forEach(cat => {
                catP[cat.id] = 0;
                catA[cat.id] = 0;
                itemsP[cat.id] = [];
                itemsA[cat.id] = [];
            });
            
            let fixedCosts = 0;
            
            DATA.days.forEach(d => {
                if(d.done) done++;
                
                DATA.categories.forEach(cat => {
                    const pVal = d[cat.id]?.p || 0;
                    const aVal = d.a?.[cat.id] || 0;
                    
                    tP += pVal;
                    tA += aVal;
                    catP[cat.id] += pVal;
                    catA[cat.id] += aVal;
                    
                    // For fixed costs, use first two categories
                    if (DATA.categories.indexOf(cat) < 2) {
                        fixedCosts += pVal;
                    }
                    
                    if(pVal > 0) {
                        itemsP[cat.id].push({
                            day: d.d, 
                            name: (d[cat.id]?.n || d[cat.id]?.d || 'Item').substring(0,40), 
                            value: pVal
                        });
                    }
                    
                    if(aVal > 0) {
                        itemsA[cat.id].push({
                            day: d.d, 
                            name: (d[cat.id]?.n || d[cat.id]?.d || 'Item').substring(0,40), 
                            value: aVal
                        });
                    }
                });
            });
            
            // Convert local currency amounts to USD for calculations
            const tP_USD = tP / DATA.rate;
            const tA_USD = tA / DATA.rate;
            const tBudget_USD = DATA.budget; // Budget is already in USD
            
            // Calculate remaining in local currency first
            const remaining = tBudget_USD - tA_USD;
            
            // Convert remaining back to local currency for display
            const remainingLocal = remaining * DATA.rate;
            
            const daysLeft = DATA.days.length - done;
            const avgDailySpent = done > 0 ? tA / done : 0;
            const avgDailyBudget = tP / DATA.days.length;
            const variableRemaining = remainingLocal - (fixedCosts - (catA[DATA.categories[0]?.id || 'acc'] + catA[DATA.categories[1]?.id || 'trn']));
            const canSpendPerDay = daysLeft > 0 ? variableRemaining / daysLeft : 0;
            
            return { 
                tP, tA, done, 
                rem: remainingLocal, // Show in local currency
                pct: (tA_USD / tBudget_USD * 100), // Calculate percentage in USD
                estRem: (tBudget_USD - tP_USD) * DATA.rate, // Convert back to local currency!
                estPct: (tP_USD / tBudget_USD * 100), // Estimated percentage in USD
                over: tP_USD > tBudget_USD, // Compare in USD
                daysLeft, 
                avgDailySpent, 
                avgDailyBudget, 
                canSpendPerDay, 
                catP, 
                catA,
                itemsP,
                itemsA,
                tBudget_USD, // Budget in USD
                tP_USD, // Planned in USD
                tA_USD // Actual in USD
            };
        };
        
        const update = (i, cat, k, v) => {
            if(k === 'p') {
                DATA.days[i][cat][k] = parseFloat(v) || 0;
            } else if(k === 'd' || k === 'n') {
                DATA.days[i][cat][k] = v;
            } else if(cat === 'base') {
                DATA.days[i][k] = k === 'd' ? parseInt(v) : v;
            } else if(DATA.days[i].a && ['acc','trn','food','act'].includes(cat)) {
                DATA.days[i].a[cat] = parseFloat(v) || 0;
            }
            saveToStorage();
            showToast('Saved', 'success');
            renderWithoutFlash();
        };
        
        const updateJournal = (i, v) => { 
            DATA.days[i].journalNote = v; 
            saveToStorage(); 
            showToast(' Journal saved', 'success');
        };
        
        const addPhoto = (i, dataUrl) => { 
            if (!DATA.days[i].photos) DATA.days[i].photos = []; 
            DATA.days[i].photos.push(dataUrl); 
            saveToStorage(); 
            renderWithoutFlash(); 
        };
        
        const deletePhoto = (i, photoIdx) => { 
            DATA.days[i].photos.splice(photoIdx, 1); 
            saveToStorage(); 
            renderWithoutFlash(); 
        };
        
        const handlePhotoUpload = (i, e) => { 
            const file = e.target.files[0]; 
            if (file) { 
                const reader = new FileReader(); 
                reader.onload = (event) => { 
                    addPhoto(i, event.target.result); 
                }; 
                reader.readAsDataURL(file); 
            } 
        };
        
        const addScheduleItem = (i) => { 
            if (!DATA.days[i].schedule) DATA.days[i].schedule = []; 
            DATA.days[i].schedule.push({time: '09:00', activity: ''}); 
            saveToStorage(); 
            renderWithoutFlash(); 
        };
        
        const updateSchedule = (i, idx, field, value) => { 
            DATA.days[i].schedule[idx][field] = value; 
            saveToStorage(); 
            if (field === 'activity') {
                showToast(' Schedule updated', 'success');
            }
        };
        
        const deleteSchedule = (i, idx) => { 
            DATA.days[i].schedule.splice(idx, 1); 
            saveToStorage(); 
            renderWithoutFlash(); 
        };
        
        const openPhotoModal = (photo) => { 
            DATA.photoModal = photo; 
            renderWithoutFlash(); 
        };
        
        const closePhotoModal = () => { 
            DATA.photoModal = null; 
            renderWithoutFlash(); 
        };
        
        const highlightText = (text, query) => {
            if (!query) return text;
            const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escaped})`, 'gi');
            return text.replace(regex, '<span class="search-result-highlight">$1</span>');
        };
        
        const trackDayView = (dayIndex) => {
            if (!DATA.recentlyViewed) DATA.recentlyViewed = [];
            
            // Remove if already exists
            DATA.recentlyViewed = DATA.recentlyViewed.filter(item => item.dayIndex !== dayIndex);
            
            // Add to front with timestamp
            DATA.recentlyViewed.unshift({
                dayIndex: dayIndex,
                timestamp: Date.now()
            });
            
            // Keep only last 10
            DATA.recentlyViewed = DATA.recentlyViewed.slice(0, 10);
            
            saveToStorage();
        };
        
        const jumpToDay = (dayIndex) => {
            DATA.expanded = dayIndex;
            DATA.showSearchResults = false;
            DATA.searchQuery = '';
            trackDayView(dayIndex);
            renderWithoutFlash();
            setTimeout(() => {
                const dayCard = document.querySelector(`.day-card[data-day="${dayIndex}"]`);
                if (dayCard) {
                    dayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        };
        
        const saveToStorage = () => {
            if (window.CURRENT_TRIP_ID) {
                try {
                    // Clone DATA but exclude non-serializable objects
                    const dataToSave = JSON.parse(JSON.stringify(DATA, (key, value) => {
                        // Exclude Google Maps objects and transient animation state
                        if (key === 'googleMap' || 
                            key === 'directionsRenderer' ||
                            key === 'directionsRenderers' ||
                            key === 'animationMarker' || 
                            key === 'mapMarkers' ||
                            key === 'isAnimating' ||
                            key === 'animationFollowRoute') {
                            return undefined;
                        }
                        // Save ONLY main route cache, not individual segment caches
                        if (key === 'routeCache' && value) {
                            return {
                                main: value.main || null,
                                daily: value.daily || {}
                            };
                        }
                        return value;
                    }));
                    
                    window.ALL_TRIPS[window.CURRENT_TRIP_ID] = dataToSave;
                    localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
                    localStorage.setItem('currentTripId', window.CURRENT_TRIP_ID);
                    hapticFeedback('success');
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.warn(' Storage quota exceeded. Clearing cache...');
                        // Clear route cache and try again
                        DATA.routeCache = {};
                        try {
                            const dataToSave = JSON.parse(JSON.stringify(DATA, (key, value) => {
                                if (key === 'googleMap' || key === 'directionsRenderer' || 
                                    key === 'directionsRenderers' || key === 'animationMarker' || 
                                    key === 'mapMarkers' || key === 'routeCache') {
                                    return undefined;
                                }
                                return value;
                            }));
                            window.ALL_TRIPS[window.CURRENT_TRIP_ID] = dataToSave;
                            localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
                            localStorage.setItem('currentTripId', window.CURRENT_TRIP_ID);
                        } catch (e2) {
                            console.warn('Storage still full - data not saved');
                        }
                    } else {
                        console.error('Save error:', e);
                    }
                }
            }
        };
        
        const saveTripNotesHeight = (textarea) => {
            DATA.tripNotesHeight = textarea.offsetHeight;
            saveToStorage();
        };

        const showToast = (message, type = 'info') => {
            // Check if toasts are disabled
            if (DATA.disableToasts) return;
            
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(t => t.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Use animation speed setting
            const speed = DATA.animationSpeed === 'fast' ? 150 : DATA.animationSpeed === 'slow' ? 500 : 300;
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), speed);
            }, 2000); // Show for 2 seconds
        };
        
        const loadFromStorage = () => {
            const saved = localStorage.getItem('tripData');
            
            // Check if we have the new multi-trip structure
            const multiTripData = localStorage.getItem('allTrips');
            const currentTripId = localStorage.getItem('currentTripId');
            
            if (multiTripData) {
                // New multi-trip structure
                window.ALL_TRIPS = JSON.parse(multiTripData);
                window.CURRENT_TRIP_ID = currentTripId || Object.keys(window.ALL_TRIPS)[0];
                
                // Load current trip
                if (window.ALL_TRIPS[window.CURRENT_TRIP_ID]) {
                    Object.assign(DATA, window.ALL_TRIPS[window.CURRENT_TRIP_ID]);
                }
            } else if (saved) {
                // Migrate old single-trip data to new structure
                const oldData = JSON.parse(saved);
                const tripId = 'trip_' + Date.now();
                
                // Check if we already have trips (don't overwrite!)
                const existingTrips = localStorage.getItem('allTrips');
                if (existingTrips) {
                    // Already migrated, just load existing
                    window.ALL_TRIPS = JSON.parse(existingTrips);
                    window.CURRENT_TRIP_ID = localStorage.getItem('currentTripId') || Object.keys(window.ALL_TRIPS)[0];
                } else {
                    // First time migration
                    window.ALL_TRIPS = {
                        [tripId]: oldData
                    };
                    window.CURRENT_TRIP_ID = tripId;
                    
                    // Save in new format
                    localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
                    localStorage.setItem('currentTripId', window.CURRENT_TRIP_ID);
                }
                
                Object.assign(DATA, window.ALL_TRIPS[window.CURRENT_TRIP_ID]);
                localStorage.removeItem('tripData'); // Remove old format after successful migration
            } else {
                // No data - initialize with empty state
                window.ALL_TRIPS = {};
                window.CURRENT_TRIP_ID = null;
            }
            
            if (DATA.liveRate && window.CURRENT_TRIP_ID) {
                fetchLiveRate();
            } else {
                renderWithoutFlash();
            }
            
            // Apply saved appearance settings
            if (DATA.animationSpeed) {
                const speeds = { fast: '0.15s', normal: '0.3s', slow: '0.6s' };
                document.documentElement.style.setProperty('--transition-speed', speeds[DATA.animationSpeed] || '0.3s');
            }
            if (DATA.fontSize) {
                const sizes = { small: '14px', medium: '16px', large: '18px' };
                document.documentElement.style.fontSize = sizes[DATA.fontSize] || '16px';
            }
            
                const modalStatesToClear = [
                    'editingCategoryModal',
                    'editingNotesModal',
                    'showModal',
                    'editing',
                    'expanded',
                    'showSettings',
                    'showExportMenu',
                    'showAnalyticsPage',
                    'showTripManager',
                    'editPackingList',
                    'editTripChecklist',
                    'editBeforeChecklist',
                    'showTravelers',
                    'showTravelerList'
                ];
                
                modalStatesToClear.forEach(state => {
                    if (DATA[state] !== undefined) {
                        DATA[state] = false;
                    }
                });
                
                // Also clear day-specific states
                if (DATA.days) {
                    DATA.days.forEach(day => {
                        day.showDaySection = null;
                        day.showSchedule = false;
                    });
                }
                setTimeout(checkAndFetchUpcomingWeather, 2000);
        };

        const ICON_OPTIONS = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
       
        const addCategory = () => {
            const newId = 'cat_' + Date.now();
            DATA.categories.push({
                id: newId,
                name: 'New Category',
                icon: '',
                color: '#6b7280'
            });
            DATA.categoryBudgets[newId] = 0;
            
            // Add to all existing days
            DATA.days.forEach(day => {
                day[newId] = {d: '', p: 0};
                day.a[newId] = 0;
            });
            
            saveToStorage();
            renderWithoutFlash();
        };

        const deleteCategory = (catId) => {
            if (DATA.categories.length <= 1) {
                alert("You must have at least one category!");
                return;
            }
            
            showConfirmModal('Delete Category', 'Delete this category? This will remove it from all days.', (confirmed) => {
                if (confirmed) {
                    DATA.categories = DATA.categories.filter(c => c.id !== catId);
                    delete DATA.categoryBudgets[catId];
                    
                    // Remove from all days
                    DATA.days.forEach(day => {
                        delete day[catId];
                        delete day.a[catId];
                    });
                    
                    saveToStorage();
                    renderWithoutFlash();
                }
            });
        };

        const updateCategory = (catId, field, value) => {
            const cat = DATA.categories.find(c => c.id === catId);
            if (cat) {
                cat[field] = value;
                saveToStorage();
                debouncedRender(); // Changed from render()

            }
        };

        const openIconPicker = (catId) => {
            DATA.iconPickerOpen = true;
            DATA.iconPickerCategory = catId;
            renderWithoutFlash();
        };

        const closeIconPicker = () => {
            DATA.iconPickerOpen = false;
            DATA.iconPickerCategory = null;
            renderWithoutFlash();
        };

        const selectIcon = (icon) => {
            if (DATA.iconPickerCategory) {
                updateCategory(DATA.iconPickerCategory, 'icon', icon);
            }
            closeIconPicker();
        };

        const calculateTripDays = () => {
            const start = new Date(DATA.tripStartDate);
            const end = new Date(DATA.tripEndDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end
            return diffDays;
        };

        const updateTripDates = () => {
            const expectedDays = calculateTripDays();
            const currentDays = DATA.days.length;
            
            if (expectedDays !== currentDays) {
                showConfirmModal('Adjust Trip Length', `Trip length changed to ${expectedDays} days. Current itinerary has ${currentDays} days. Adjust number of days?`, (confirmed) => {
                    if (confirmed) {
                        if (expectedDays > currentDays) {
                            // Add days
                            for (let i = currentDays; i < expectedDays; i++) {
                                const newDay = {
                                    d: i + 1,
                                    dt: 'MM-DD-YYYY',
                                    loc: 'New Location',
                                    note: '',
                                    done: false,
                                    a: {},
                                    photos: [],
                                    journalNote: '',
                                    schedule: [],
                                    showSchedule: false,
                                    scheduleView: 'list',
                                    weather: null,
                                    weatherLoading: false
                                };
                                
                                // Add all category fields
                                DATA.categories.forEach(cat => {
                                    newDay[cat.id] = {d: '', p: 0};
                                    newDay.a[cat.id] = 0;
                                });
                                
                                DATA.days.push(newDay);
                            }
                        } else {
                            // Remove days
                            DATA.days = DATA.days.slice(0, expectedDays);
                        }
                        
                        saveToStorage();
                        renderWithoutFlash();
                    } 
                });
            } else {
                saveToStorage();
                renderWithoutFlash();
            }
        };
        
        const exp = () => { 
            let csv = 'Day,Date,Location,Category,Planned,Actual,Diff,Planned$,Actual$,Done\n'; 
            DATA.days.forEach(d => { 
                ['acc','trn','food','act'].forEach(c => { 
                    const p = d[c].p, a = d.a[c]; 
                    csv += `${d.d},${d.dt},${d.loc},${c},${p},${a},${a-p},${(p/DATA.rate).toFixed(2)},${(a/DATA.rate).toFixed(2)},${d.done}\n`; 
                }); 
            }); 
            const blob = new Blob([csv], {type:'text/csv'}); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = 'japan_trip_55days.csv'; 
            a.click(); 
        };
        
        const downloadHTML = () => { 
            const htmlContent = document.documentElement.outerHTML; 
            const updatedHTML = htmlContent.replace(/const DATA = \{[\s\S]*?\};/, `const DATA = ${JSON.stringify(DATA, null, 4)};`); 
            const blob = new Blob([updatedHTML], {type:'text/html'}); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = 'japan_trip_updated.html'; 
            a.click(); 
            URL.revokeObjectURL(url); 
        };

        const switchTab = (tab) => {
            // Save scroll position BEFORE tab switch
            savedScrollPosition = window.scrollY;
            
            // Save map state if needed
            const mapState = saveMapState();
            
            DATA.activeTab = tab;
            saveToStorage();
            renderWithoutFlash(); // Use flash-free render
            
            restoreMapState(mapState);
        };
        // Make functions globally accessible

        let mapInstance = null;
        let markersLayer = null;
        let routeLayer = null;

        const createNewTrip = () => {
            // Step 1: Ask for trip name
            showInputModal(
                'Create New Trip',
                'Enter a name for your new trip',
                'My Amazing Trip',
                '',
                (tripName) => {
                    // Step 2: Ask for currency
                    let currencyModalHTML = `
                        <div style="margin-bottom:20px;">
                            <label style="display:block;margin-bottom:10px;font-weight:600;">Select Currency</label>
                            <select id="currencySelect" style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;">
                                ${Object.keys(CURRENCIES).map(code => 
                                    `<option value="${code}">${CURRENCIES[code].symbol} ${CURRENCIES[code].name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:10px;font-weight:600;">Default Exchange Rate (per $1 USD)</label>
                            <div style="display:flex;gap:10px;align-items:center;">
                                <span style="font-size:20px;font-weight:600;">$1 USD =</span>
                                <input type="number" id="exchangeRateInput" value="155" step="0.01" style="flex:1;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;">
                                <span id="currencySymbolDisplay" style="font-size:20px;font-weight:600;"></span>
                            </div>
                        </div>
                    `;
                    
                    DATA.showModal = {
                        title: 'Select Currency',
                        message: currencyModalHTML,
                        type: 'custom',
                        confirmText: 'Next'
                    };
                    
                    window.modalCallback = () => {
                        const currency = document.getElementById('currencySelect').value;
                        const rate = parseFloat(document.getElementById('exchangeRateInput').value) || 155;
                        
                        // Step 3: Ask for dates
                        const today = new Date();
                        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                        
                        let dateModalHTML = `
                            <div style="margin-bottom:20px;">
                                <label style="display:block;margin-bottom:10px;font-weight:600;">Trip Start Date</label>
                                <input type="date" id="startDateInput" value="${today.toISOString().split('T')[0]}" style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;">
                            </div>
                            <div style="margin-bottom:15px;">
                                <label style="display:block;margin-bottom:10px;font-weight:600;">Trip End Date</label>
                                <input type="date" id="endDateInput" value="${nextWeek.toISOString().split('T')[0]}" style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;">
                            </div>
                            <div style="font-size:14px;color:#666;padding:10px;background:#f9fafb;border-radius:6px;">
                                 You can always adjust these dates later
                            </div>
                        `;
                        
                        DATA.showModal = {
                            title: 'Set Trip Dates',
                            message: dateModalHTML,
                            type: 'custom',
                            confirmText: 'Next'
                        };
                        
                        window.modalCallback = () => {
                            const startDate = document.getElementById('startDateInput').value;
                            const endDate = document.getElementById('endDateInput').value;
                            
                            // Validate dates
                            if (new Date(startDate) > new Date(endDate)) {
                                showAlertModal('Invalid Dates', 'End date must be after start date.');
                                return;
                            }
                            
                            // Step 4: Ask for budget with "not sure" option
                            let budgetModalHTML = `
                                <div style="margin-bottom:20px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                        <label style="font-weight:600;font-size:16px;">Total Budget (USD)</label>
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <input type="checkbox" id="notSureCheckbox" style="width:20px;height:20px;">
                                            <label for="notSureCheckbox" style="font-size:14px;color:#666;cursor:pointer;">Not sure yet</label>
                                        </div>
                                    </div>
                                    <input type="number" id="budgetInput" value="5000" step="100" min="0" style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:18px;font-weight:600;">
                                </div>
                                <div style="font-size:14px;color:#666;padding:10px;background:#f9fafb;border-radius:6px;">
                                    <div style="margin-bottom:5px;"> Budget estimates:</div>
                                    <ul style="margin:0;padding-left:20px;">
                                        <li>Budget travel: $30-50 per day</li>
                                        <li>Comfort travel: $100-200 per day</li>
                                        <li>Luxury travel: $200-500+ per day</li>
                                    </ul>
                                </div>
                            `;
                            
                            DATA.showModal = {
                                title: 'Set Your Budget',
                                message: budgetModalHTML,
                                type: 'custom',
                                confirmText: 'Create Trip'
                            };
                            
                            window.modalCallback = () => {
                                const notSure = document.getElementById('notSureCheckbox').checked;
                                const budgetValue = notSure ? 0 : parseFloat(document.getElementById('budgetInput').value) || 5000;
                                
                                // Step 5: Create the trip
                                const tripId = 'trip_' + Date.now();
                                const currencySymbol = CURRENCIES[currency].symbol;
                                
                                // Calculate number of days
                                const start = new Date(startDate);
                                const end = new Date(endDate);
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                                
                                // Create days array based on date range
                                const days = [];
                                for (let i = 0; i < diffDays; i++) {
                                    const currentDate = new Date(start);
                                    currentDate.setDate(start.getDate() + i);
                                    const formattedDate = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()}`;
                                    
                                    const newDay = {
                                        d: i + 1,
                                        dt: formattedDate,
                                        loc: i === 0 ? 'Starting Location' : 
                                            i === diffDays - 1 ? 'Final Destination' : 
                                            'Day ' + (i + 1) + ' Destination',
                                        note: '',
                                        done: false,
                                        a: {},
                                        photos: [],
                                        journalNote: '',
                                        schedule: [],
                                        showSchedule: false,
                                        weather: null,
                                        weatherLoading: false,
                                        receipts: []
                                    };
                                    
                                    // Add default categories to the day
                                    DEFAULT_CATEGORIES.forEach(cat => {
                                        newDay[cat.id] = {d: '', p: 0};
                                        newDay.a[cat.id] = 0;
                                    });
                                    
                                    days.push(newDay);
                                }
                                
                                // Create a completely new empty trip
                                const newTrip = {
                                    // Basic trip info
                                    tripTitle: tripName,
                                    tripSubtitle: `${new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                                    tripNotes: '',
                                    
                                    // Budget in USD (this is the connecting factor)
                                    budget: budgetValue, // This is USD (0 if "not sure")
                                    
                                    // Currency settings for this specific trip
                                    rate: rate,
                                    currency: currency,
                                    currencySymbol: currencySymbol,
                                    liveRate: true,
                                    lastFetchedRate: null,
                                    
                                    // Dates
                                    tripStartDate: startDate,
                                    tripEndDate: endDate,
                                    
                                    // Categories (default set)
                                    categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
                                    categoryBudgets: {
                                        acc: 0,
                                        trn: 0,
                                        food: 0,
                                        act: 0
                                    },
                                    showCategoryManager: false,
                                    
                                    // Travelers
                                    travelers: ['Traveler 1'],
                                    travelerCount: 1,
                                    costSplitMode: 'total',
                                    
                                    // UI states (all false/empty)
                                    iconPickerOpen: false,
                                    iconPickerCategory: null,
                                    expanded: null,
                                    editing: null,
                                    editTitle: false,
                                    editPackingList: false,
                                    editTripChecklist: false,
                                    editBeforeChecklist: false,
                                    editCategoryBudget: null,
                                    showEst: false,
                                    editBudget: false,
                                    editRate: false,
                                    converterUSD: 100,
                                    converterYEN: 10000,
                                    searchQuery: '',
                                    searchResults: [],
                                    showSearchResults: false,
                                    searchMode: 'enter',
                                    chartView: 'planned',
                                    showDailyBudget: false,
                                    showChart: false,
                                    photoModal: null,
                                    activeTab: 'planning',
                                    showMap: false,
                                    mapInitialized: false,
                                    mapView: 'all',
                                    geocodedLocations: {},
                                    locationOrder: {},
                                    customWaypoints: [],
                                    mapEditMode: false,
                                    draggableMarkers: {},
                                    editingLocation: null,
                                    
                                    // Checklists (with some defaults)
                                    beforeChecklist: [
                                        {item: 'Book flights', checked: false},
                                        {item: 'Get travel insurance', checked: false},
                                        {item: 'Book accommodations', checked: false}
                                    ],
                                    tripChecklist: [
                                        {item: 'Charge electronics', checked: false},
                                        {item: 'Pack passport', checked: false},
                                        {item: 'Print tickets', checked: false}
                                    ],
                                    packingList: [],
                                    
                                    // Receipts (empty)
                                    receipts: [],
                                    showReceipts: false,
                                    
                                    // Days (created based on date range)
                                    days: days
                                };
                                
                                window.ALL_TRIPS[tripId] = newTrip;
                                window.CURRENT_TRIP_ID = tripId;
                                
                                // Clear current DATA and load the new empty trip
                                Object.keys(DATA).forEach(key => delete DATA[key]);
                                Object.assign(DATA, JSON.parse(JSON.stringify(newTrip)));
                                
                                saveToStorage();
                                
                                // Reset all UI states
                                const statesToReset = {
                                    editTripChecklist: false,
                                    editBeforeChecklist: false,
                                    editPackingList: false,
                                    showTravelers: false,
                                    showTravelerList: false,
                                    editing: null,
                                    expanded: null,
                                    editTitle: false,
                                    editBudget: false,
                                    editRate: false,
                                    showEst: false,
                                    showSearchResults: false,
                                    showDailyBudget: false,
                                    showChart: false,
                                    photoModal: null,
                                    iconPickerOpen: false,
                                    iconPickerCategory: null,
                                    editCategoryBudget: null,
                                    showSettings: false,
                                    showExportMenu: false,
                                    showAnalyticsPage: null,
                                    showTripManager: false,
                                    editingCategoryModal: null,
                                    editingNotesModal: null,
                                    showModal: null,
                                    showMap: false,
                                    showReceipts: false,
                                    showWelcome: false, // Hide welcome screen after creating trip
                                    settingsPage: 'main',
                                    activeTab: 'planning',
                                    mapView: 'all',
                                    chartView: 'planned',
                                    costSplitMode: 'total',
                                    searchMode: 'enter'
                                };
                                
                                Object.keys(statesToReset).forEach(key => {
                                    if (DATA[key] !== undefined) {
                                        DATA[key] = statesToReset[key];
                                    }
                                });
                                
                                renderWithoutFlash();
                            };
                            
                            // Add functionality for "not sure" checkbox
                            setTimeout(() => {
                                const notSureCheckbox = document.getElementById('notSureCheckbox');
                                const budgetInput = document.getElementById('budgetInput');
                                
                                notSureCheckbox.onchange = () => {
                                    if (notSureCheckbox.checked) {
                                        budgetInput.disabled = true;
                                        budgetInput.style.opacity = '0.6';
                                        budgetInput.style.backgroundColor = '#f9fafb';
                                        budgetInput.placeholder = 'Budget not set';
                                    } else {
                                        budgetInput.disabled = false;
                                        budgetInput.style.opacity = '1';
                                        budgetInput.style.backgroundColor = 'white';
                                        budgetInput.placeholder = '';
                                    }
                                };
                                
                                // Initialize based on default (not checked)
                                notSureCheckbox.checked = false;
                                notSureCheckbox.onchange();
                            }, 100);
                            
                            renderWithoutFlash();
                        };
                        
                        // Add date validation
                        setTimeout(() => {
                            const startDateInput = document.getElementById('startDateInput');
                            const endDateInput = document.getElementById('endDateInput');
                            
                            // Set minimum date to today
                            startDateInput.min = today.toISOString().split('T')[0];
                            endDateInput.min = today.toISOString().split('T')[0];
                            
                            // When start date changes, update end date min
                            startDateInput.onchange = () => {
                                endDateInput.min = startDateInput.value;
                                if (endDateInput.value < startDateInput.value) {
                                    endDateInput.value = startDateInput.value;
                                }
                            };
                        }, 100);
                        
                        renderWithoutFlash();
                    };
                    
                    // Update currency symbol when currency selection changes
                    setTimeout(() => {
                        const currencySelect = document.getElementById('currencySelect');
                        const rateInput = document.getElementById('exchangeRateInput');
                        const symbolDisplay = document.getElementById('currencySymbolDisplay');
                        
                        currencySelect.onchange = () => {
                            const selectedCurrency = currencySelect.value;
                            symbolDisplay.textContent = CURRENCIES[selectedCurrency].symbol;
                            
                            // Set default rates for common currencies
                            const defaultRates = {
                                'JPY': 155,
                                'EUR': 0.92,
                                'GBP': 0.79,
                                'CAD': 1.35,
                                'AUD': 1.52,
                                'CHF': 0.88,
                                'CNY': 7.25,
                                'KRW': 1330,
                                'MXN': 17.5,
                                'INR': 83
                            };
                            
                            if (defaultRates[selectedCurrency]) {
                                rateInput.value = defaultRates[selectedCurrency];
                            }
                        };
                        
                        // Trigger initial update
                        currencySelect.dispatchEvent(new Event('change'));
                    }, 100);
                    
                    renderWithoutFlash();
                }
            );
        };

        const switchTrip = (tripId) => {
            if (!window.ALL_TRIPS[tripId]) return;
            
            window.CURRENT_TRIP_ID = tripId;
            
            // Clear current DATA and load new trip
            Object.keys(DATA).forEach(key => delete DATA[key]);
            Object.assign(DATA, JSON.parse(JSON.stringify(window.ALL_TRIPS[tripId])));
            
            localStorage.setItem('currentTripId', tripId);
            renderWithoutFlash();
            
            // Auto-fetch weather for upcoming days in the new trip
            setTimeout(checkAndFetchUpcomingWeather, 1000);
        };

        const deleteTrip = (tripId) => {
            const tripCount = Object.keys(window.ALL_TRIPS).length;
            
            if (tripCount === 1) {
                alert('Cannot delete your only trip!');
                return;
            }
            
            const tripName = window.ALL_TRIPS[tripId].tripTitle;
            if (!confirm(`Delete trip "${tripName}"? This cannot be undone.`)) return;
            
            delete window.ALL_TRIPS[tripId];
            
            // If deleting current trip, switch to another
            if (tripId === window.CURRENT_TRIP_ID) {
                const remainingTrips = Object.keys(window.ALL_TRIPS);
                if (remainingTrips.length > 0) {
                    switchTrip(remainingTrips[0]);
                }
            }
            
            localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
            renderWithoutFlash();
        };

        const duplicateTrip = (tripId) => {
            const originalTrip = window.ALL_TRIPS[tripId];
            const newTripName = prompt('Enter name for duplicate trip:', originalTrip.tripTitle + ' (Copy)');
            if (!newTripName) return;
            
            const newTripId = 'trip_' + Date.now();
            
            // Deep copy the trip
            const duplicatedTrip = JSON.parse(JSON.stringify(originalTrip));
            duplicatedTrip.tripTitle = newTripName;
            
            // Reset some fields
            duplicatedTrip.days.forEach(day => {
                day.done = false;
                day.a = {};
                if (day.photos) day.photos = [];
                if (day.receipts) day.receipts = [];
                if (day.journalNote) day.journalNote = '';
                if (day.weather) day.weather = null;
            });
            
            window.ALL_TRIPS[newTripId] = duplicatedTrip;
            localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
            
            showConfirmModal('Switch Trip', 'Switch to duplicated trip now?', (confirmed) => {
                if (confirmed) {
                    switchTrip(newTripId);
                } else {
                    renderWithoutFlash();
                }
            });
        };

        const exportTripAsTemplate = () => {
            const template = {
                tripTitle: DATA.tripTitle + ' (Template)',
                budget: DATA.budget,
                currency: DATA.currency,
                currencySymbol: DATA.currencySymbol,
                rate: DATA.rate,
                categories: DATA.categories,
                categoryBudgets: DATA.categoryBudgets,
                travelerCount: DATA.travelerCount,
                days: DATA.days.map(day => ({
                    d: day.d,
                    dt: '',
                    loc: day.loc,
                    ...Object.fromEntries(
                        DATA.categories.map(cat => [
                            cat.id,
                            {
                                d: day[cat.id]?.d || '',
                                n: day[cat.id]?.n || '',
                                p: day[cat.id]?.p || 0
                            }
                        ])
                    ),
                    note: day.note || '',
                    done: false,
                    a: {},
                    photos: [],
                    receipts: [],
                    journalNote: '',
                    schedule: day.schedule ? JSON.parse(JSON.stringify(day.schedule)) : []
                }))
            };
            
            const jsonStr = JSON.stringify(template, null, 2);
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${DATA.tripTitle.replace(/[^a-z0-9]/gi, '_')}-template.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const importTripTemplate = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const template = JSON.parse(event.target.result);
                        const tripId = 'trip_' + Date.now();
                        
                        // Merge template with current defaults
                        const newTrip = {
                            ...JSON.parse(JSON.stringify(DATA)), // Copy current defaults
                            ...template,
                            tripStartDate: new Date().toISOString().split('T')[0],
                            tripEndDate: new Date(Date.now() + (template.days.length * 24 * 60 * 60 * 1000)).toISOString().split('T')[0]
                        };
                        
                        window.ALL_TRIPS[tripId] = newTrip;
                        localStorage.setItem('allTrips', JSON.stringify(window.ALL_TRIPS));
                        
                        showConfirmModal('Template Imported', 'Template imported! Switch to this trip now?', (confirmed) => {
                            if (confirmed) {
                                switchTrip(tripId);
                            } else {
                                renderWithoutFlash();
                            }
                        });
                    } catch (err) {
                        alert('Error importing template: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        const compareTripStats = () => {
            const trips = Object.entries(window.ALL_TRIPS).map(([id, trip]) => {
                const days = trip.days || [];
                
                // Calculate totals in local currency
                const totalPlannedLocal = days.reduce((sum, day) => {
                    return sum + (trip.categories || []).reduce((catSum, cat) => {
                        return catSum + (day[cat.id]?.p || 0);
                    }, 0);
                }, 0);
                
                const totalActualLocal = days.reduce((sum, day) => {
                    return sum + (trip.categories || []).reduce((catSum, cat) => {
                        return catSum + (day.a?.[cat.id] || 0);
                    }, 0);
                }, 0);
                
                // Convert to USD using this trip's exchange rate
                const exchangeRate = trip.rate || 155;
                const totalPlannedUSD = totalPlannedLocal / exchangeRate;
                const totalActualUSD = totalActualLocal / exchangeRate;
                const budgetUSD = trip.budget || 0; // Budget is already in USD
                
                return {
                    id,
                    name: trip.tripTitle,
                    budgetUSD: budgetUSD, // USD
                    budgetLocal: budgetUSD * exchangeRate, // Local currency
                    totalPlannedUSD: totalPlannedUSD, // USD
                    totalPlannedLocal: totalPlannedLocal, // Local currency
                    totalActualUSD: totalActualUSD, // USD
                    totalActualLocal: totalActualLocal, // Local currency
                    days: days.length,
                    completed: days.filter(d => d.done).length,
                    currency: trip.currencySymbol || '',
                    exchangeRate: exchangeRate
                };
            });
            
            return trips;
        };
       

        // ============================================
        // EXPORT & SHARE FUNCTIONS
        // ============================================

        const exportToPDF = () => {
            DATA.showPrintSettings = true;
            DATA.showExportMenu = false; // ADD THIS LINE
            renderWithoutFlash();
        };

        const executePrint = () => {
            // Generate print layout
            generatePrintLayout();
            
            // Close modal
            DATA.showPrintSettings = false;
            renderWithoutFlash();
            
            // Small delay to ensure layout is rendered
            setTimeout(() => {
                // Debug: Check if print container exists and has content
                const printContainer = document.getElementById('printContainer');
                
                // Make sure it's visible for printing
                if (printContainer) {
                    printContainer.style.display = 'block';
                }
                
                window.print();
                
                // Hide it again after printing
                setTimeout(() => {
                    if (printContainer) {
                        printContainer.style.display = 'none';
                    }
                }, 1000);
            }, 200);
        };

        const generatePrintLayout = () => {
            const opts = DATA.printOptions;
            let printHTML = '';
            
            // Cover Page with Budget Summary
            const s = stats();
            printHTML += `
                <div class="print-page">
                    <div style="text-align:center;padding:80px 40px;">
                        <h1 style="font-size:42px;margin-bottom:15px;color:#111;">${DATA.tripTitle}</h1>
                        <p style="font-size:20px;color:#666;margin-bottom:60px;">${DATA.tripSubtitle}</p>
                        
                        ${opts.includeBudget ? `
                            <div style="margin-top:80px;">
                                <h2 style="font-size:24px;margin-bottom:30px;color:#111;">Trip Overview</h2>
                                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:30px;text-align:center;max-width:600px;margin:0 auto;">
                                    <div style="padding:20px;background:#f9fafb;border-radius:8px;">
                                        <div style="font-size:14px;color:#999;margin-bottom:8px;text-transform:uppercase;">Total Budget</div>
                                        <div style="font-size:32px;font-weight:700;color:#0d9488;">${DATA.currencySymbol}${(DATA.budget * DATA.rate).toLocaleString()}</div>
                                        <div style="font-size:14px;color:#666;margin-top:5px;">$${DATA.budget.toLocaleString()} USD</div>
                                    </div>
                                    <div style="padding:20px;background:#f9fafb;border-radius:8px;">
                                        <div style="font-size:14px;color:#999;margin-bottom:8px;text-transform:uppercase;">Total Days</div>
                                        <div style="font-size:32px;font-weight:700;color:#111;">${DATA.days.length}</div>
                                        <div style="font-size:14px;color:#666;margin-top:5px;">${DATA.days.filter(d => d.done).length} completed</div>
                                    </div>
                                    <div style="padding:20px;background:#f9fafb;border-radius:8px;">
                                        <div style="font-size:14px;color:#999;margin-bottom:8px;text-transform:uppercase;">Actual Spent</div>
                                        <div style="font-size:32px;font-weight:700;color:#000;">${DATA.currencySymbol}${s.tA.toLocaleString()}</div>
                                        <div style="font-size:14px;color:#666;margin-top:5px;">${s.pct.toFixed(1)}% of budget</div>
                                    </div>
                                    <div style="padding:20px;background:#f9fafb;border-radius:8px;">
                                        <div style="font-size:14px;color:#999;margin-bottom:8px;text-transform:uppercase;">Remaining</div>
                                        <div style="font-size:32px;font-weight:700;color:${s.rem < 0 ? '#ef4444' : '#10b981'};">${DATA.currencySymbol}${Math.abs(s.rem).toLocaleString()}</div>
                                        <div style="font-size:14px;color:#666;margin-top:5px;">${s.rem < 0 ? 'Over budget' : 'Under budget'}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                </div>
            `;
            
            // Budget Breakdown Page (if selected)
            if (opts.includeBudget) {
                printHTML += `
                    <div class="print-page">
                        <h2 style="font-size:28px;margin-bottom:30px;color:#111;border-bottom:3px solid #0d9488;padding-bottom:10px;">Budget Breakdown by Category</h2>
                        
                        <div style="display:grid;gap:25px;">
                            ${DATA.categories.map(cat => {
                                const planned = s.catP[cat.id] || 0;
                                const actual = s.catA[cat.id] || 0;
                                const maxVal = Math.max(planned, actual, 1);
                                
                                return `
                                    <div>
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                            <h3 style="font-size:18px;margin:0;display:flex;align-items:center;gap:10px;">
                                                <span style="font-size:24px;">${cat.icon}</span>
                                                ${cat.name}
                                            </h3>
                                            <span style="font-size:16px;font-weight:700;color:${cat.color};">
                                                ${DATA.currencySymbol}${actual.toLocaleString()} / ${DATA.currencySymbol}${planned.toLocaleString()}
                                            </span>
                                        </div>
                                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                            <div>
                                                <div style="font-size:11px;color:#999;margin-bottom:5px;text-transform:uppercase;">Planned</div>
                                                <div style="height:30px;background:#e5e7eb;border-radius:6px;overflow:hidden;position:relative;">
                                                    <div style="width:${(planned/maxVal*100)}%;height:100%;background:#0d9488;"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div style="font-size:11px;color:#999;margin-bottom:5px;text-transform:uppercase;">Actual</div>
                                                <div style="height:30px;background:#e5e7eb;border-radius:6px;overflow:hidden;position:relative;">
                                                    <div style="width:${(actual/maxVal*100)}%;height:100%;background:${actual > planned ? '#ef4444' : '#10b981'};"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                    </div>
                `;
            }
            
            // Day Pages (one per page in detailed mode)
            if (opts.layout === 'detailed') {
                DATA.days.forEach((day, idx) => {
                    const dayTotal = day.done ? calcA(day) : calc(day);
                    
                    printHTML += `
                        <div class="print-page">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:25px;border-bottom:3px solid #0d9488;padding-bottom:15px;">
                                <div>
                                    <h2 style="font-size:28px;margin:0 0 8px 0;color:#111;">Day ${day.d}: ${day.loc}</h2>
                                    <p style="font-size:14px;color:#666;margin:0;">${day.dt}${day.done ? '   Completed' : ''}</p>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:12px;color:#999;text-transform:uppercase;margin-bottom:5px;">Total Cost</div>
                                    <div style="font-size:24px;font-weight:700;color:#0d9488;">${DATA.currencySymbol}${dayTotal.toLocaleString()}</div>
                                    <div style="font-size:12px;color:#666;">$${(dayTotal/DATA.rate).toFixed(2)} USD</div>
                                </div>
                            </div>
                            
                            ${opts.includeCategories ? `
                                <div style="display:grid;gap:20px;margin-bottom:25px;">
                                    ${DATA.categories.map(cat => {
                                        const catData = day[cat.id] || {};
                                        const name = catData.n || '';
                                        const cost = catData.p || 0;
                                        const description = catData.d || '';
                                        const actualCost = day.a?.[cat.id] || 0;
                                        
                                        // Skip if no data
                                        if (!name && !cost && !actualCost) return '';
                                        
                                        return `
                                            <div style="padding:15px;background:#f9fafb;border-left:4px solid ${cat.color};border-radius:4px;">
                                                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                                    <h3 style="font-size:14px;margin:0;color:#666;text-transform:uppercase;letter-spacing:0.5px;">
                                                        ${cat.icon} ${cat.name}
                                                    </h3>
                                                    ${cost > 0 ? `<span style="font-size:16px;font-weight:700;color:#111;">${DATA.currencySymbol}${cost.toLocaleString()}</span>` : ''}
                                                </div>
                                                ${name ? `<div style="font-size:15px;font-weight:600;margin-bottom:5px;color:#111;">${name}</div>` : ''}
                                                ${description ? `<div style="font-size:14px;color:#374151;line-height:1.6;">${description}</div>` : ''}
                                                ${actualCost > 0 ? `<div style="font-size:13px;color:#000;font-weight:600;margin-top:8px;">Actual: ${DATA.currencySymbol}${actualCost.toLocaleString()}</div>` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                            
                            ${opts.includeNotes && day.note ? `
                                <div style="padding:15px;background:#fffbeb;border-left:4px solid #f59e0b;border-radius:4px;margin-bottom:20px;">
                                    <h3 style="font-size:14px;margin:0 0 10px 0;color:#92400e;text-transform:uppercase;letter-spacing:0.5px;">Notes</h3>
                                    <div style="font-size:14px;color:#111;line-height:1.7;">${day.note}</div>
                                </div>
                            ` : ''}
                            
                            ${opts.includeSchedule && day.schedule && day.schedule.length > 0 ? `
                                <div class="print-section schedule-section" style="padding:20px;background:#fafafa;border-left:4px solid #0d9488;border-radius:4px;margin-bottom:25px;page-break-inside:avoid;">
                                    <h3 style="font-size:18pt;margin:0 0 15px 0;color:#1e40af;text-transform:uppercase;letter-spacing:0.5px;">Schedule</h3>
                                    <div style="display:grid;gap:0;">
                                        ${day.schedule.sort((a, b) => a.time.localeCompare(b.time)).map(item => `
                                            <div class="print-schedule-item" style="display:grid;grid-template-columns:120px 1fr;gap:20px;padding:15px;border-bottom:2px solid #dbeafe;">
                                                <span class="print-schedule-time" style="font-weight:700;font-size:18pt;color:#0d9488;">${item.time}</span>
                                                <span class="print-schedule-activity" style="font-size:16pt;color:#111;line-height:1.6;">${item.activity}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${opts.includeJournal && day.journalNote ? `
                                <div style="padding:15px;background:#fafafa;border-left:4px solid #10b981;border-radius:4px;">
                                    <h3 style="font-size:14px;margin:0 0 10px 0;color:#065f46;text-transform:uppercase;letter-spacing:0.5px;"> Journal Entry</h3>
                                    <div style="font-size:14px;color:#111;line-height:1.7;font-style:italic;">${day.journalNote}</div>
                                </div>
                            ` : ''}
                            
                        </div>
                    `;
                });
            } else {
                // Compact mode - multiple days per page
                let pageHTML = '';
                let daysOnPage = 0;
                const maxDaysPerPage = 9;
                
                DATA.days.forEach((day, idx) => {
                    const dayTotal = day.done ? calcA(day) : calc(day);
                    
                    if (daysOnPage === 0) {
                        pageHTML += `<div class="print-page"><div style="display:grid;gap:30px;">`;
                    }
                    
                    pageHTML += `
                        <div style="padding:12px 15px;background:#f9fafb;border-radius:6px;border-left:3px solid #0d9488;margin-bottom:10px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                <h3 style="font-size:16px;margin:0;color:#111;">Day ${day.d}: ${day.loc}</h3>
                                <span style="font-size:14px;font-weight:700;color:#0d9488;">${DATA.currencySymbol}${dayTotal.toLocaleString()}</span>
                            </div>
                            ${opts.includeCategories ? DATA.categories.map(cat => {
                                const catData = day[cat.id] || {};
                                const description = catData.n;
                                if (!description) return '';
                                return `<div style="font-size:12px;color:#374151;margin:4px 0;"><strong>${cat.icon}</strong> ${description}</div>`;
                            }).join('') : ''}
                            ${opts.includeNotes && day.note ? `<div style="font-size:11px;color:#666;margin-top:8px;font-style:italic;">${day.note}</div>` : ''}
                        </div>
                    `;
                    
                    daysOnPage++;
                    
                    if (daysOnPage === maxDaysPerPage || idx === DATA.days.length - 1) {
                        pageHTML += `</div><div class="print-footer">Days ${idx - daysOnPage + 2} - ${idx + 1}</div></div>`;
                        printHTML += pageHTML;
                        pageHTML = '';
                        daysOnPage = 0;
                    }
                });
            }
            
            // Insert or update print container
                let printContainer = document.getElementById('printContainer');
                if (!printContainer) {
                    printContainer = document.createElement('div');
                    printContainer.id = 'printContainer';
                    document.body.appendChild(printContainer);
                }
                
                // Set styles
                printContainer.style.display = 'none';
                printContainer.style.position = 'absolute';
                printContainer.style.top = '0';
                printContainer.style.left = '0';
                printContainer.style.width = '100%';
                printContainer.style.zIndex = '99999';
                
                printContainer.innerHTML = printHTML;
                
            };

        const exportToCSV = () => {
            let csv = 'Day,Date,Location,Accommodation,Transportation,Food,Activities,Other,Total Planned,Total Actual,Done\n';
            
            DATA.days.forEach(day => {
                const planned = calc(day);
                const actual = calcA(day);
                
                const row = [
                    day.d,
                    day.dt,
                    `"${day.loc}"`,
                    day.acc?.p || 0,
                    day.trn?.p || 0,
                    day.food?.p || 0,
                    day.act?.p || 0,
                    day.misc?.p || 0,
                    planned,
                    actual,
                    day.done ? 'Yes' : 'No'
                ].join(',');
                
                csv += row + '\n';
            });
            
            // Add summary
            csv += '\n';
            csv += 'SUMMARY\n';
            csv += `Total Budget,${DATA.budget * DATA.rate}\n`;
            csv += `Total Planned,${DATA.days.reduce((sum, day) => sum + calc(day), 0)}\n`;
            csv += `Total Actual,${DATA.days.reduce((sum, day) => sum + calcA(day), 0)}\n`;
            csv += `Currency,${DATA.currency}\n`;
            csv += `Exchange Rate,${DATA.rate}\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${DATA.tripTitle.replace(/[^a-z0-9]/gi, '_')}_export.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const exportToICalendar = () => {
            let ical = 'BEGIN:VCALENDAR\n';
            ical += 'VERSION:2.0\n';
            ical += 'PRODID:-//Trip Budget Planner//EN\n';
            ical += `X-WR-CALNAME:${DATA.tripTitle}\n`;
            ical += 'X-WR-TIMEZONE:UTC\n';
            ical += 'CALSCALE:GREGORIAN\n';
            ical += 'METHOD:PUBLISH\n';
            
            DATA.days.forEach(day => {
                if (!day.dt) return; // Skip days without dates
                
                // Parse date
                const date = new Date(day.dt + 'T00:00:00');
                const dateStr = date.toISOString().replace(/[-:]/g, '').split('T')[0];
                
                // Main day event
                ical += 'BEGIN:VEVENT\n';
                ical += `UID:day-${day.d}-${Date.now()}@tripbudget\n`;
                ical += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
                ical += `DTSTART;VALUE=DATE:${dateStr}\n`;
                ical += `DTEND;VALUE=DATE:${dateStr}\n`;
                ical += `SUMMARY:Day ${day.d}: ${day.loc}\n`;
                
                // Description with details
                let description = `Location: ${day.loc}\\n`;
                if (day.acc?.n) description += `Accommodation: ${day.acc.n}\\n`;
                if (day.trn?.d) description += `Transport: ${day.trn.d}\\n`;
                if (day.food?.d) description += `Food: ${day.food.d}\\n`;
                if (day.act?.d) description += `Activities: ${day.act.d}\\n`;
                if (day.note) description += `Notes: ${day.note}\\n`;
                description += `Budget: ${DATA.currencySymbol}${calc(day).toLocaleString()}`;
                
                ical += `DESCRIPTION:${description}\n`;
                ical += `LOCATION:${day.loc}\n`;
                ical += 'END:VEVENT\n';
                
                // Add schedule items as separate events
                if (day.schedule && day.schedule.length > 0) {
                    day.schedule.forEach((item, idx) => {
                        if (!item.time || !item.activity) return;
                        
                        const [hours, minutes] = item.time.split(':');
                        const eventDate = new Date(day.dt + `T${item.time}:00`);
                        const startStr = eventDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        
                        // Assume 1 hour duration
                        const endDate = new Date(eventDate.getTime() + 60 * 60 * 1000);
                        const endStr = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        
                        ical += 'BEGIN:VEVENT\n';
                        ical += `UID:schedule-${day.d}-${idx}-${Date.now()}@tripbudget\n`;
                        ical += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
                        ical += `DTSTART:${startStr}\n`;
                        ical += `DTEND:${endStr}\n`;
                        ical += `SUMMARY:${item.activity}\n`;
                        ical += `DESCRIPTION:Day ${day.d} - ${day.loc}\n`;
                        ical += `LOCATION:${day.loc}\n`;
                        ical += 'END:VEVENT\n';
                    });
                }
            });
            
            ical += 'END:VCALENDAR\n';
            
            // Download
            const blob = new Blob([ical], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${DATA.tripTitle.replace(/[^a-z0-9]/gi, '_')}_calendar.ics`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const generateShareableHTML = () => {
            const s = stats();
            
            let html = `<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${DATA.tripTitle} - Trip Itinerary</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 40px 20px; background: #f5f5f5; }
                .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                h1 { color: #1f2937; margin-bottom: 10px; font-size: 32px; }
                .subtitle { color: #6b7280; margin-bottom: 30px; font-size: 16px; }
                .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
                .stat-card { background: linear-gradient(135deg, #0d9488, #2563eb); color: white; padding: 20px; border-radius: 8px; }
                .stat-label { font-size: 12px; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; }
                .stat-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
                .stat-sub { font-size: 13px; opacity: 0.8; }
                .day-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
                .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
                .day-title { font-size: 20px; font-weight: 600; color: #1f2937; }
                .day-date { font-size: 14px; color: #6b7280; }
                .day-cost { font-size: 18px; font-weight: 600; color: #0d9488; }
                .section { margin-top: 15px; padding: 12px; background: white; border-radius: 6px; border-left: 3px solid #0d9488; }
                .section-label { font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 4px; text-transform: uppercase; }
                .section-content { font-size: 14px; color: #1f2937; }
                .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 13px; }
                @media print {
                    body { background: white; padding: 0; }
                    .container { box-shadow: none; }
                }
            
        /* Comprehensive Dark Mode - All Modals, Settings, Pages */
        body.dark-mode .modal,
        body.dark-mode .modal-content,
        body.dark-mode .settings-full-page,
        body.dark-mode .analytics-page,
        body.dark-mode .checklist-full-page,
        body.dark-mode [class*="page"],
        body.dark-mode [class*="modal"] {
            background: #0f172a !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .settings-full-page > div:first-child,
        body.dark-mode .modal-header,
        body.dark-mode .analytics-header,
        body.dark-mode [class*="header"] {
            background: #1e293b !important;
            border-bottom-color: #475569 !important;
        }
        
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, 
        body.dark-mode h4, body.dark-mode h5, body.dark-mode h6 {
            color: #f1f5f9 !important;
        }
        
        body.dark-mode [style*="color:#666"] {
            color: #94a3b8 !important;
        }
        
        body.dark-mode [style*="color:#0d9488"] {
            color: #14b8a6 !important; /* Lighter teal for dark mode */
        }
        
        body.dark-mode textarea,
        body.dark-mode [type="text"],
        body.dark-mode [type="number"],
        body.dark-mode [type="date"] {
            background: #334155 !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }
        
        body.dark-mode .settings-menu-card,
        body.dark-mode .prep-card,
        body.dark-mode [class*="card"] {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        
        body.dark-mode .settings-menu-card:hover,
        body.dark-mode .prep-card:hover {
            background: #334155 !important;
        }

        </style>
        </head>
        <body>
            <div class="container">
                <h1>${DATA.tripTitle}</h1>
                <div class="subtitle">${DATA.tripStartDate} to ${DATA.tripEndDate}  ${DATA.days.length} days</div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Budget</div>
                        <div class="stat-value">${DATA.currencySymbol}${(DATA.budget * DATA.rate).toLocaleString()}</div>
                        <div class="stat-sub">$${DATA.budget.toLocaleString()}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div class="stat-label">Actual Spent</div>
                        <div class="stat-value">${DATA.currencySymbol}${s.tA.toLocaleString()}</div>
                        <div class="stat-sub">${s.pct.toFixed(1)}% of budget</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <div class="stat-label">Remaining</div>
                        <div class="stat-value">${DATA.currencySymbol}${Math.round(s.rem).toLocaleString()}</div>
                        <div class="stat-sub">${s.done}/${DATA.days.length} days completed</div>
                    </div>
                </div>
                
                <h2 style="margin-bottom: 20px; color: #1f2937;">Day-by-Day Itinerary</h2>
                
                ${DATA.days.map(day => {
                    const dayTotal = day.done ? calcA(day) : calc(day);
                    return `
                        <div class="day-card">
                            <div class="day-header">
                                <div>
                                    <div class="day-title">Day ${day.d}: ${day.loc}</div>
                                    <div class="day-date">${day.dt}</div>
                                </div>
                                <div class="day-cost">${DATA.currencySymbol}${dayTotal.toLocaleString()}</div>
                            </div>
                            
                            ${DATA.categories.map(cat => {
                                const catData = day[cat.id] || {};
                                if (!catData.n) return '';
                                return `
                                    <div class="section">
                                        <div class="section-label">${cat.icon} ${cat.name}</div>
                                        <div class="section-content" title="${catData.n}">${catData.n}</div>
                                    </div>
                                `;
                            }).join('')}
                            
                            ${day.note ? `
                                <div class="section" style="border-left-color: #f59e0b;">
                                    <div class="section-label">Notes</div>
                                    <div class="section-content" title="${day.note}">${day.note}</div>
                                </div>
                            ` : ''}
                            
                            ${day.schedule && day.schedule.length > 0 ? `
                                <div class="section" style="border-left-color: #8b5cf6;">
                                    <div class="section-label">Schedule</div>
                                    ${day.schedule.sort((a, b) => a.time.localeCompare(b.time)).map(item => `
                                        <div style="display: flex; gap: 10px; margin-top: 6px;">
                                            <strong>${item.time}</strong>
                                            <span>${item.activity}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
                
                <div class="footer">
                    Generated by Trip Budget Planner  ${new Date().toLocaleDateString()}
                </div>
            </div>
        </body>
        </html>`;
            
            return html;
        };

        const exportToHTML = () => {
            const html = generateShareableHTML();
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${DATA.tripTitle.replace(/[^a-z0-9]/gi, '_')}_itinerary.html`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const emailItinerary = () => {
            const subject = encodeURIComponent(`${DATA.tripTitle} - Trip Itinerary`);
            const body = encodeURIComponent(`Check out my trip itinerary for ${DATA.tripTitle}!

        Trip Dates: ${DATA.tripStartDate} to ${DATA.tripEndDate}
        Total Days: ${DATA.days.length}
        Budget: ${DATA.currencySymbol}${(DATA.budget * DATA.rate).toLocaleString()}

        For the full detailed itinerary with day-by-day breakdown, schedule, and expenses, please download the attached HTML file or use the Trip Budget Planner app.

        Trip Overview:
        ${DATA.days.map(day => `Day ${day.d} (${day.dt}): ${day.loc}`).join('\n')}
        `);
            
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        };

        const copyShareableLink = async () => {
            const shareData = {
                tripTitle: DATA.tripTitle,
                tripStartDate: DATA.tripStartDate,
                tripEndDate: DATA.tripEndDate,
                budget: DATA.budget,
                currency: DATA.currency,
                days: DATA.days.map(day => ({
                    d: day.d,
                    dt: day.dt,
                    loc: day.loc,
                    acc: day.acc,
                    trn: day.trn,
                    food: day.food,
                    act: day.act,
                    note: day.note,
                    schedule: day.schedule
                }))
            };
            
            const jsonStr = JSON.stringify(shareData);
            let base64;
            
            // Fix for special characters - use proper encoding
            try {
                base64 = btoa(unescape(encodeURIComponent(jsonStr)));
            } catch (e) {
                base64 = btoa(jsonStr);
            }
            
            const shareText = `Trip: ${DATA.tripTitle}\nDates: ${DATA.tripStartDate} to ${DATA.tripEndDate}\nDays: ${DATA.days.length}\n\nTo import this trip, copy this data and use the "Import Template" feature:\n\n${base64}`;
            
            try {
                await navigator.clipboard.writeText(shareText);
                showToast('Copied to clipboard!', 'success');
                DATA.showExportMenu = false;
                renderWithoutFlash();
            } catch (err) {
                // Fallback for iOS/Safari
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showToast('Copied to clipboard!', 'success');
                    DATA.showExportMenu = false;
                    renderWithoutFlash();
                } catch (err2) {
                    alert('Could not copy automatically. Please copy manually:\n\n' + shareText);
                }
                
                document.body.removeChild(textArea);
            }
        };
       
        // Schedule event dragging
        let draggedEvent = null;
        let dragStartY = 0;
        let dragStartTime = null;
        let dragEdge = null;

        window.startEventDrag = (dayIndex, scheduleIndex, edge, event) => {
            event.stopPropagation();
            draggedEvent = { dayIndex, scheduleIndex };
            dragStartY = event.clientY;
            dragEdge = edge;
            
            const schedule = DATA.days[dayIndex].schedule[scheduleIndex];
            dragStartTime = schedule.time;
            
            document.body.style.cursor = 'ns-resize';
            
            // Get the time display element to update it directly (no re-render)
            const timeDisplay = event.target.closest('.timeline-event').querySelector('.timeline-event-time');
            
            const handleMove = (e) => {
                const deltaY = e.clientY - dragStartY;
                const minutesDelta = Math.round(deltaY / 2); // 2px = 1 minute
                
                const [hours, minutes] = dragStartTime.split(':').map(Number);
                let totalMinutes = hours * 60 + minutes + minutesDelta;
                
                // Clamp to 0-1439 (24 hours)
                totalMinutes = Math.max(0, Math.min(1439, totalMinutes));
                
                const newHours = Math.floor(totalMinutes / 60);
                const newMinutes = totalMinutes % 60;
                const newTime = `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
                
                // Update data without rendering
                DATA.days[dayIndex].schedule[scheduleIndex].time = newTime;
                
                // Update display directly
                if (timeDisplay) {
                    timeDisplay.textContent = newTime;
                }
            };
            
            const handleUp = () => {
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('mouseup', handleUp);
                document.body.style.cursor = 'default';
                draggedEvent = null;
                
                // Save and render once at the end
                saveToStorage();
                renderWithoutFlash();
            };
            
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleUp);
        };

        window.startEventResize = (dayIndex, scheduleIndex, edge, event) => {
            event.stopPropagation();
            startEventDrag(dayIndex, scheduleIndex, edge, event);
        };
       
        window.addEventInRange = (dayIndex, startHour, endHour) => {
        
            const formatHour = (h) => h === 0 ? '12 AM' : h < 12 ? h + ' AM' : h === 12 ? '12 PM' : (h - 12) + ' PM';
            
            showTimePickerModal(
                'Add Event',
                `Add an event during this time range (${formatHour(startHour)} - ${formatHour(endHour)})`,
                startHour,
                endHour,
                startHour.toString().padStart(2,'0') + ':00',
                (time) => {
                    if (!DATA.days[dayIndex].schedule) DATA.days[dayIndex].schedule = [];
                    DATA.days[dayIndex].schedule.push({
                        time: time,
                        activity: ''
                    });
                    saveToStorage();
                    renderWithoutFlash();
                }
            );
        };
       
        // Custom Modal System
        window.showInputModal = (title, message, placeholder, defaultValue, callback) => {
            DATA.showModal = {
                title,
                message,
                type: 'input',
                placeholder,
                defaultValue,
                confirmText: 'OK'
            };
            
            window.modalCallback = () => {
                const value = document.getElementById('modalInput').value;
                DATA.showModal = null;
                if (value) {
                    callback(value);
                } else {
                    renderWithoutFlash();
                }
            };
            
            renderWithoutFlash();
            setTimeout(() => {
                const input = document.getElementById('modalInput');
                if (input) input.focus();
            }, 100);
        };

        window.showTimePickerModal = (title, message, startHour, endHour, defaultTime, callback) => {
            const formatHour = (h) => h === 0 ? '12 AM' : h < 12 ? h + ' AM' : h === 12 ? '12 PM' : (h - 12) + ' PM';
            const rangeMessage = `Choose time between ${formatHour(startHour)} and ${formatHour(endHour)}`;
            
            DATA.showModal = {
                title,
                message,
                type: 'time',
                rangeMessage,
                confirmText: 'Add Event'
            };
            
            window.modalCallback = () => {
                const hour = parseInt(document.getElementById('modalHour').value);
                const minute = parseInt(document.getElementById('modalMinute').value);
                
                // Validate range
                if (hour < startHour || hour > endHour) {
                    DATA.showModal = null;
                    showAlertModal('Invalid Time', `Please choose a time between ${formatHour(startHour)} and ${formatHour(endHour)}`);
                    return;
                }
                
                const time = `${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}`;
                DATA.showModal = null;
                callback(time);
            };
            
            renderWithoutFlash();
            
            // Set default time
            setTimeout(() => {
                if (defaultTime) {
                    const [h, m] = defaultTime.split(':');
                    document.getElementById('modalHour').value = parseInt(h);
                    document.getElementById('modalMinute').value = parseInt(m);
                }
            }, 100);
        };

        window.showAlertModal = (title, message, callback) => {
            DATA.showModal = {
                title,
                message,
                type: 'alert',
                confirmText: 'OK'
            };
            
            window.modalCallback = () => {
                DATA.showModal = null;
                if (callback) {
                    callback();
                } else {
                    renderWithoutFlash();
                }
            };
            
            renderWithoutFlash();
        };

        window.showConfirmModal = (title, message, callback) => {
            DATA.showModal = {
                title,
                message,
                type: 'confirm',
                confirmText: 'Confirm'
            };
            
            window.modalCallback = () => {
                DATA.showModal = null;
                callback(true);
            };
            
            renderWithoutFlash();
        };

        const openCategoryModal = (dayIndex, categoryId) => {
            DATA.editingCategoryModal = { dayIndex, category: categoryId };
            renderWithoutFlash();
        };

        const closeCategoryModal = () => {
            DATA.editingCategoryModal = null;
            renderWithoutFlash();
        };

        const openNotesModal = (dayIndex) => {
            DATA.editingNotesModal = { dayIndex };
            renderWithoutFlash();
        };

        const closeNotesModal = () => {
            DATA.editingNotesModal = null;
            renderWithoutFlash();
        };

        const openDayDetailModal = (dayIndex) => {
            DATA.showDayDetailModal = dayIndex;
            DATA.editingInModal = null; // Reset editing state
            trackDayView(dayIndex);
            renderWithoutFlash();
        };
        
        // Calendar cell hover handler - adjusts gap dynamically
        const handleCalendarCellHover = (cell, isHovering) => {
            // Only handle mobile expanded state opacity
            if (window.innerWidth > 768) return; // Desktop doesn't need this anymore
            
            if (!isHovering && !cell.classList.contains('expanded')) {
                // On mobile, hide text when not hovering and not expanded
                const location = cell.querySelector('.calendar-cell-location');
                const cost = cell.querySelector('.calendar-cell-cost');
                if (location) location.style.opacity = '0';
                if (cost) cost.style.opacity = '0';
            }
        };
        
        // Calendar cell click handler
        const handleCalendarCellClick = (event, dayIndex) => {
            event.stopPropagation();
            
            // Mobile and Desktop: always open modal directly
            openDayDetailModal(dayIndex);
        };

        const viewDayInList = (dayIndex) => {
            DATA.showDayDetailModal = null;
            DATA.itineraryView = 'list';
            DATA.expanded = dayIndex;
            DATA.activeTab = 'itinerary';
            saveToStorage();
            renderWithoutFlash();
            
            // Scroll to the day card after render
            setTimeout(() => {
                const dayCard = document.querySelector(`.day-card[data-day="${dayIndex}"]`);
                if (dayCard) {
                    // Scroll the window/body to the card
                    const cardRect = dayCard.getBoundingClientRect();
                    const absoluteTop = window.pageYOffset + cardRect.top;
                    window.scrollTo({ 
                        top: absoluteTop - 100, 
                        behavior: 'smooth' 
                    });
                }
            }, 300);
        };

        const formatCurrency = (amount, currencySymbol, decimals = 0) => {
            const rounded = Math.round(amount);
            return `${currencySymbol}${rounded.toLocaleString()}`;
        };

        const getTodayDate = () => {
            const today = new Date();
            return today.toISOString().split('T')[0]; // Returns YYYY-MM-DD
        };

        const hapticFeedback = (type = 'light') => {
            // Haptic feedback disabled - was causing browser intervention warnings
            return;
        };

        const handleHeaderScroll = () => {
            const scrollY = window.scrollY;
            const header = document.querySelector('.header');
            const h1 = header?.querySelector('h1');
            
            if (!header || !h1) return;
            
            // Check if mobile
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Simple class toggle on mobile - no inline style animations
                if (scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            } else {
                // Smooth animations on desktop (original behavior)
                const titleHeight = h1.scrollHeight;
                const isTwoLines = titleHeight > 30;
                
                const maxScroll = 100;
                const progress = Math.min(scrollY / maxScroll, 1);
                
                const basePadding = isTwoLines ? 36 : 32;
                const minPadding = isTwoLines ? 16 : 12;
                const padding = basePadding - ((basePadding - minPadding) * progress);
                
                header.style.paddingTop = `${padding}px`;
                header.style.paddingBottom = `${padding}px`;
                
                const baseFontSize = isTwoLines ? 20 : 22;
                const minFontSize = isTwoLines ? 15 : 16;
                const fontSize = baseFontSize - ((baseFontSize - minFontSize) * progress);
                h1.style.fontSize = `${fontSize}px`;
                
                const subtitle = header.querySelector('.subtitle');
                if (subtitle) {
                    subtitle.style.opacity = 1 - progress;
                    subtitle.style.maxHeight = `${70 * (1 - progress)}px`;
                }
            }
        };

        // Use requestAnimationFrame for smooth 60fps
        let ticking = false;
        window.addEventListener('scroll', () => {
            if (!ticking) {
                requestAnimationFrame(() => {
                    handleHeaderScroll();
                    
                    // Show/hide scroll to top button
                    const scrollBtn = document.getElementById('scrollToTop');
                    if (scrollBtn) {
                        if (window.scrollY > 300) {
                            scrollBtn.classList.add('show');
                        } else {
                            scrollBtn.classList.remove('show');
                        }
                    }
                    
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });

        // Throttle scroll events for performance
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(handleHeaderScroll, 10);
        }, { passive: true });

        window.editLocation = (locationName) => {
            const newName = prompt('Enter new name for this location:', locationName);
            if (newName && newName !== locationName) {
                // Update in geocoded locations
                const coords = DATA.geocodedLocations[locationName];
                if (coords) {
                    delete DATA.geocodedLocations[locationName];
                    DATA.geocodedLocations[newName] = {
                        ...coords,
                        name: newName
                    };
                    
                    // Update in location order
                    if (DATA.locationOrder && DATA.locationOrder[locationName] !== undefined) {
                        DATA.locationOrder[newName] = DATA.locationOrder[locationName];
                        delete DATA.locationOrder[locationName];
                    }
                    
                    saveToStorage();
                    showToast(' Location renamed', 'success');
                    renderMapFromCache();
                }
            }
        };

        // Prevent scroll jump and flash on render
        let isRendering = false;
        let savedScrollPosition = 0;
        let savedModalScrolls = {}; // Track scroll for each modal
        let savedTabScrolls = {}; // Track scroll position per tab
        
        const renderWithoutFlash = () => {
            if (!isRendering) {
                // Save main window scroll for current tab
                savedScrollPosition = window.scrollY;
                if (DATA.activeTab) {
                    savedTabScrolls[DATA.activeTab] = window.scrollY;
                }
                
                // Save panel scroll (mobile bottom sheet)
                const detailsPanel = document.querySelector('.details.show');
                if (detailsPanel) {
                    savedModalScrolls.detailsPanel = detailsPanel.scrollTop;
                }
                
                // Save all modal scrolls
                const dayDetailModal = document.querySelector('.day-detail-content');
                if (dayDetailModal) {
                    savedModalScrolls.dayDetail = dayDetailModal.scrollTop;
                }
                
                const settingsModal = document.querySelector('.settings-page');
                if (settingsModal) {
                    savedModalScrolls.settings = settingsModal.scrollTop;
                }
                
                const exportModal = document.querySelector('.export-page');
                if (exportModal) {
                    savedModalScrolls.export = exportModal.scrollTop;
                }
                
                const analyticsModal = document.querySelector('.analytics-fullscreen');
                if (analyticsModal) {
                    savedModalScrolls.analytics = analyticsModal.scrollTop;
                }
                
                // Track checklist page scrolls (they're full-page modals with scrollable content divs)
                if (DATA.showChecklistPage) {
                    const checklistContent = document.querySelector('[style*="position:fixed"][style*="z-index:2001"] > div[style*="overflow-y:auto"]');
                    if (checklistContent) {
                        savedModalScrolls[`checklist_${DATA.showChecklistPage}`] = checklistContent.scrollTop;
                    }
                }
                
                isRendering = true;
            }
            render();
        };
        
        // Restore scroll after render completes
        const restoreScrollPosition = () => {
            if (isRendering) {
                requestAnimationFrame(() => {
                    // Restore window scroll - use tab-specific if available
                    const scrollToRestore = savedTabScrolls[DATA.activeTab] !== undefined 
                        ? savedTabScrolls[DATA.activeTab] 
                        : savedScrollPosition;
                    window.scrollTo(0, scrollToRestore);
                    
                    // Restore panel scroll (mobile bottom sheet)
                    const detailsPanel = document.querySelector('.details.show');
                    if (detailsPanel && savedModalScrolls.detailsPanel !== undefined) {
                        detailsPanel.scrollTop = savedModalScrolls.detailsPanel;
                    }
                    
                    // Restore all modal scrolls
                    const dayDetailModal = document.querySelector('.day-detail-content');
                    if (dayDetailModal && savedModalScrolls.dayDetail !== undefined) {
                        dayDetailModal.scrollTop = savedModalScrolls.dayDetail;
                    }
                    
                    const settingsModal = document.querySelector('.settings-page');
                    if (settingsModal && savedModalScrolls.settings !== undefined) {
                        settingsModal.scrollTop = savedModalScrolls.settings;
                    }
                    
                    const exportModal = document.querySelector('.export-page');
                    if (exportModal && savedModalScrolls.export !== undefined) {
                        exportModal.scrollTop = savedModalScrolls.export;
                    }
                    
                    const analyticsModal = document.querySelector('.analytics-fullscreen');
                    if (analyticsModal && savedModalScrolls.analytics !== undefined) {
                        analyticsModal.scrollTop = savedModalScrolls.analytics;
                    }
                    
                    // Restore checklist page scroll
                    if (DATA.showChecklistPage) {
                        const checklistContent = document.querySelector('[style*="position:fixed"][style*="z-index:2001"] > div[style*="overflow-y:auto"]');
                        if (checklistContent && savedModalScrolls[`checklist_${DATA.showChecklistPage}`] !== undefined) {
                            checklistContent.scrollTop = savedModalScrolls[`checklist_${DATA.showChecklistPage}`];
                        }
                    }
                    
                    // Scroll so the expanded card(s) sit directly above the panel
                    if (window._scrollToCard !== undefined && window._scrollToCard !== null) {
                        const cardIndex = window._scrollToCard;
                        window._scrollToCard = null;
                        const isMobile = window.innerWidth <= 768;
                        
                        // Find both cards in the row (the clicked card and its grid partner)
                        const clickedWrapper = document.querySelector(`.day-card[data-day="${cardIndex}"]`)?.closest('.day-card-wrapper');
                        if (clickedWrapper) {
                            // Find the grid container and figure out which row the card is in
                            const grid = clickedWrapper.closest('.day-cards-grid');
                            const wrappers = grid ? Array.from(grid.children).filter(c => c.classList.contains('day-card-wrapper')) : [];
                            const clickedIdx = wrappers.indexOf(clickedWrapper);
                            // Get the partner card (same row in 2-col grid)
                            const rowStart = Math.floor(clickedIdx / 2) * 2;
                            const rowCards = wrappers.slice(rowStart, rowStart + 2).filter(Boolean);
                            
                            // Use the topmost card in the row for scroll calculation
                            const topCard = rowCards[0] || clickedWrapper;
                            const rect = topCard.getBoundingClientRect();
                            
                            if (isMobile) {
                                // Mobile: panel is fixed at bottom (70vh), put card row just above it
                                const panelHeight = window.innerHeight * 0.70;
                                const cardRowHeight = rect.height + 10; // card height + gap
                                const desiredCardTop = window.innerHeight - panelHeight - cardRowHeight - 8;
                                const scrollDelta = rect.top - desiredCardTop;
                                window.scrollTo({ top: window.scrollY + scrollDelta, behavior: 'smooth' });
                            } else {
                                // Desktop: panel is absolute below the card, scroll so card row
                                // is near the top with a small offset for the sticky header
                                const headerHeight = document.querySelector('.header')?.offsetHeight || 60;
                                const desiredCardTop = headerHeight + 16;
                                const scrollDelta = rect.top - desiredCardTop;
                                window.scrollTo({ top: window.scrollY + scrollDelta, behavior: 'smooth' });
                            }
                        }
                    }
                    
                    // Initialize Google Map if on map tab
                    if (DATA.activeTab === 'map') {
                        setTimeout(() => {
                            initializeMap();
                        }, 100);
                    }
                    
                    // Initialize Daily Planner Map if modal is open
                    if (DATA.showDailyMap !== null) {
                        setTimeout(() => {
                            initializeDailyMap(DATA.showDailyMap);
                        }, 100);
                    }
                    
                    isRendering = false;
                });
            }
        };

        // Restore scroll after render completes

        const linkifyText = (text) => {
            if (!text) return text;
            
            // First, handle markdown-style links: [text](url)
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" style="color:#0d9488;text-decoration:underline;" onclick="event.stopPropagation()">$1</a>');
            
            // Then, handle plain URLs
            const urlPattern = /(https?:\/\/[^\s]+)/g;
            text = text.replace(urlPattern, (url) => {
                // Don't linkify if already inside an anchor tag
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color:#0d9488;text-decoration:underline;" onclick="event.stopPropagation()">${url}</a>`;
            });
            
            return text;
        };

        const openDaySection = (dayIndex) => {
            DATA.daySectionOpen = dayIndex;
            saveToStorage();
            renderWithoutFlash();
        };

        const closeDaySection = () => {
            DATA.daySectionOpen = null;
            saveToStorage();
            renderWithoutFlash();
        };

        const recalculateDates = () => {
            if (DATA.days.length === 0) return;
            
            // Get the first day's date as the anchor
            const firstDay = DATA.days[0];
            if (!firstDay.dt) return;
            
            // Parse first day's date
            const parts = firstDay.dt.split('-');
            let startDate;
            
            if (parts[0].length === 4) {
                // Format: YYYY-MM-DD
                const [year, month, day] = parts;
                startDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            } else {
                // Format: M-D-YYYY
                const [month, day, year] = parts;
                startDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            }
            
            // Update all subsequent days
            DATA.days.forEach((day, idx) => {
                if (idx === 0) return; // Skip first day
                
                // Calculate date based on day number offset from first day
                const dayOffset = day.d - 1; // day.d is 1-indexed
                const newDate = new Date(startDate);
                newDate.setDate(startDate.getDate() + dayOffset);
                
                // Format as M-D-YYYY to match your existing format
                const month = newDate.getMonth() + 1;
                const dayNum = newDate.getDate();
                const year = newDate.getFullYear();
                day.dt = `${month}-${dayNum}-${year}`;
            });
        };

        // Let browser handle scroll restoration automatically
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }
        
        // Initialize scroll tracking

        const render = () => {
            
            const s = stats();
            const app = document.getElementById('app');

            const adjustCategoryTitleFontSize = () => {
                setTimeout(() => {
                    document.querySelectorAll('.category-card-title').forEach(title => {
                        const text = title.textContent;
                        const length = text.length;
                        
                        if (length <= 10) {
                            title.style.fontSize = '16px';
                        } else if (length <= 15) {
                            title.style.fontSize = '14px';
                        } else if (length <= 20) {
                            title.style.fontSize = '12px';
                        } else {
                            title.style.fontSize = '11px';
                        }
                    });
                }, 50);
            };

            // Initialize h FIRST
            let h = '';

            // Apply app-mode class to body
            document.body.className = 'app-mode';
            if (DATA.animationSpeed) {
                document.body.classList.add(`animation-${DATA.animationSpeed}`);
            }
            if (DATA.cardStyle) {
                document.body.classList.add(`card-${DATA.cardStyle}`);
            }
            if (DATA.density) {
                document.body.classList.add(`density-${DATA.density}`);
            }

            // Start App Shell
            h += `<div class="app-shell">`;
            
            // Mobile sidebar overlay
            h += `<div class="sidebar-overlay ${DATA.sidebarOpen ? 'show' : ''}" onclick="DATA.sidebarOpen=false;renderWithoutFlash();"></div>`;
            
            // Sidebar Navigation
            h += `<div class="sidebar ${DATA.sidebarCollapsed ? 'collapsed' : ''} ${DATA.sidebarOpen ? 'open' : ''}">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <div class="sidebar-logo-icon"></div>
                        <div class="sidebar-logo-text">Trip Planner</div>
                    </div>
                    <button class="sidebar-toggle" onclick="DATA.sidebarCollapsed=!DATA.sidebarCollapsed;saveToStorage();renderWithoutFlash();">
                        <span style="font-weight:700;">${DATA.sidebarCollapsed ? '' : ''}</span>
                    </button>
                </div>
                
                <div class="sidebar-nav">
                    ${(() => {
                        // Check if currently on trip
                        if (DATA.tripStartDate && DATA.tripEndDate) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const tripStart = new Date(DATA.tripStartDate);
                            tripStart.setHours(0, 0, 0, 0);
                            const tripEnd = new Date(DATA.tripEndDate);
                            tripEnd.setHours(0, 0, 0, 0);
                            const isDuringTrip = today >= tripStart && today <= tripEnd;
                            
                            if (isDuringTrip) {
                                return `<button class="nav-item ${DATA.activeTab === 'today' ? 'active' : ''}" onclick="event.preventDefault();event.stopPropagation();DATA.activeTab='today';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                                    <span class="nav-item-icon"></span>
                                    <span class="nav-item-text">Today</span>
                                </button>`;
                            }
                        }
                        return '';
                    })()}
                    <button class="nav-item ${DATA.activeTab === 'home' ? 'active' : ''}" onclick="event.preventDefault();event.stopPropagation();DATA.activeTab='home';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">Home</span>
                    </button>
                    <button class="nav-item ${DATA.activeTab === 'planning' ? 'active' : ''}" onclick="event.preventDefault();event.stopPropagation();DATA.activeTab='planning';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">Planning</span>
                    </button>
                    <button class="nav-item ${DATA.activeTab === 'itinerary' ? 'active' : ''}" onclick="event.preventDefault();event.stopPropagation();DATA.activeTab='itinerary';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">Itinerary</span>
                    </button>
                    <button class="nav-item ${DATA.activeTab === 'map' ? 'active' : ''}" onclick="event.preventDefault();event.stopPropagation();DATA.activeTab='map';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">Map</span>
                    </button>
                    <button class="nav-item ${DATA.activeTab === 'gallery' ? 'active' : ''}" onclick="event.preventDefault();event.stopPropagation();DATA.activeTab='gallery';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">Gallery</span>
                    </button>
                    
                    <div style="height:1px;background:#e5e7eb;margin:12px 0;"></div>
                    
                    <button class="nav-item" onclick="DATA.showSettings=true;renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">Settings</span>
                    </button>
                    <button class="nav-item" onclick="DATA.showWhatIfModal=true;renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">What If...</span>
                    </button>
                    <button class="nav-item" onclick="DATA.showTripManager=true;renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">Manage Trips</span>
                    </button>
                    <button class="nav-item" onclick="DATA.showExportMenu=true;renderWithoutFlash();">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">Export</span>
                    </button>
                    
                    <div style="height:1px;background:#e5e7eb;margin:12px 0;"></div>
                    
                    <button class="nav-item ${DATA.darkMode ? 'active' : ''}" onclick="DATA.darkMode=!DATA.darkMode;saveToStorage();applyAppearanceSettings();" title="${DATA.darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}">
                        <span class="nav-item-icon"></span>
                        <span class="nav-item-text">${DATA.darkMode ? 'Light Mode' : 'Dark Mode'}</span>
                    </button>
                </div>
            </div>`;
            
            // Main Content Area
            h += `<div class="main-content">`;
            
            // Content Header - page title and action buttons (NOT for welcome screen)
            if (!DATA.showWelcome) {
                const pageTitle = DATA.activeTab === 'home' ? 'Home' :
                                 DATA.activeTab === 'planning' ? 'Planning' :
                                 DATA.activeTab === 'itinerary' ? 'Itinerary' :
                                 DATA.activeTab === 'map' ? 'Map' :
                                 DATA.activeTab === 'gallery' ? 'Gallery' :
                                 DATA.activeTab === 'today' ? 'Today' : 'Trip Planner';
                
                h += `<div class="content-header">
                    <button class="mobile-menu-btn" onclick="DATA.sidebarOpen=!DATA.sidebarOpen;renderWithoutFlash();"></button>
                    <h1>${pageTitle}</h1>
                    <div style="display:flex;gap:12px;align-items:center;">
                        ${DATA.activeTab !== 'home' ? `<button class="btn-secondary" onclick="DATA.activeTab='home';renderWithoutFlash();" style="padding:8px 16px;">Home</button>` : ''}
                        <button class="btn" onclick="addDay()" style="padding:8px 16px;">Add Day</button>
                        <button class="btn-secondary" onclick="DATA.darkMode=!DATA.darkMode;saveToStorage();applyAppearanceSettings();" style="padding:8px 16px;" title="Toggle Dark Mode">
                            
                        </button>
                    </div>
                </div>`;
                
                // Content Body - Now wrap all existing tab content
                h += `<div class="content-body">`;
            }

            // Welcome Screen (full page)
            if (DATA.showWelcome) {
                const hasTrip = DATA.days.length > 0;
                h += `<div class="welcome-screen">
                    <div class="welcome-icon"></div>
                    <h1 class="welcome-title">${hasTrip ? 'Welcome Back!' : 'Welcome to Trip Planner'}</h1>
                    <p class="welcome-subtitle">${hasTrip ? 'Continue planning your amazing trip.' : 'Plan your perfect trip with budget tracking, day-by-day itineraries, and beautiful photo galleries.'}</p>
                    <div class="welcome-actions">
                        ${hasTrip ? `
                            <button class="welcome-btn welcome-btn-primary" onclick="DATA.showWelcome=false;DATA.activeTab='home';saveToStorage();renderWithoutFlash();">
                                <span></span>
                                <span>Get Started</span>
                            </button>
                            <button class="welcome-btn welcome-btn-secondary" onclick="DATA.showWelcome=false;DATA.activeTab='planning';saveToStorage();renderWithoutFlash();">
                                <span></span>
                                <span>Continue Planning</span>
                            </button>
                        ` : `
                            <button class="welcome-btn welcome-btn-primary" onclick="createNewTrip();">
                                <span></span>
                                <span>Create New Trip</span>
                            </button>
                            <p style="margin-top:20px;font-size:14px;color:#666;">Start fresh and plan your next adventure</p>
                        `}
                    </div>
                </div>`;
            } else {
                // Content Header
                const pageTitle = DATA.activeTab === 'today' ? 'Today' :
                                 DATA.activeTab === 'home' ? `Dashboard - ${DATA.tripTitle}` : 
                                 DATA.activeTab === 'planning' ? 'Planning & Budget' :
                                 DATA.activeTab === 'itinerary' ? 'Day-by-Day Itinerary' :
                                 DATA.activeTab === 'map' ? 'Trip Map' :
                                 DATA.activeTab === 'gallery' ? 'Photo Gallery' : 'Trip Planner';
                
                
                // Content Body - Now wrap all existing tab content
                h += `<div class="content-body">`;
            }


            // Print Settings Modal
            if (DATA.showPrintSettings) {
                h += `<div class="settings-overlay" onclick="if(event.target === this){DATA.showPrintSettings=false;renderWithoutFlash();}"></div>
                <div class="analytics-page">
                    <div class="analytics-header">
                        <button class="back-button" onclick="DATA.showPrintSettings=false;renderWithoutFlash()" style="background:#0d9488 !important;color:white !important;margin:0;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:24px;color:#1f2937;">Print Settings</h2>
                        <button class="btn" onclick="DATA.showPrintSettings=false;renderWithoutFlash()" style="padding:8px 16px;background:#000;color:white;border:none;cursor:pointer;">
                             Close
                        </button>
                    </div>
                    
                    <div class="analytics-content">
                        <div style="padding:30px;">
                            <div style="padding:12px;background:#fafafa;border-left:3px solid #0d9488;border-radius:6px;margin-bottom:20px;">
                                <div style="font-size:13px;color:#1e40af;line-height:1.6;">
                                    <strong> Tip:</strong> In the print dialog, disable "Headers and footers" for a cleaner printout.
                                </div>
                            </div>

                            <div class="print-settings-section" style="background:white;padding:25px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin:0 0 15px 0;font-size:16px;font-weight:700;">Include in Printout</h4>
                                <div class="print-checkbox-group">
                                    <div class="print-checkbox-item">
                                        <input type="checkbox" id="printBudget" ${DATA.printOptions.includeBudget ? 'checked' : ''} onchange="event.stopPropagation();DATA.printOptions.includeBudget=this.checked;saveToStorage();">
                                        <label for="printBudget">Budget Summary</label>
                                    </div>
                                    <div class="print-checkbox-item">
                                        <input type="checkbox" id="printCategories" ${DATA.printOptions.includeCategories ? 'checked' : ''} onchange="event.stopPropagation();DATA.printOptions.includeCategories=this.checked;saveToStorage();">
                                        <label for="printCategories">Category Details (Accommodation, Transport, etc.)</label>
                                    </div>
                                    <div class="print-checkbox-item">
                                        <input type="checkbox" id="printNotes" ${DATA.printOptions.includeNotes ? 'checked' : ''} onchange="event.stopPropagation();DATA.printOptions.includeNotes=this.checked;saveToStorage();">
                                        <label for="printNotes">Day Notes</label>
                                    </div>
                                    <div class="print-checkbox-item">
                                        <input type="checkbox" id="printSchedule" ${DATA.printOptions.includeSchedule ? 'checked' : ''} onchange="event.stopPropagation();DATA.printOptions.includeSchedule=this.checked;saveToStorage();">
                                        <label for="printSchedule">Daily Schedule</label>
                                    </div>
                                    <div class="print-checkbox-item">
                                        <input type="checkbox" id="printJournal" ${DATA.printOptions.includeJournal ? 'checked' : ''} onchange="event.stopPropagation();DATA.printOptions.includeJournal=this.checked;saveToStorage();">
                                        <label for="printJournal">Journal Entries</label>
                                    </div>
                                    <div class="print-checkbox-item">
                                        <input type="checkbox" id="printPhotos" ${DATA.printOptions.includePhotos ? 'checked' : ''} onchange="event.stopPropagation();DATA.printOptions.includePhotos=this.checked;saveToStorage();">
                                        <label for="printPhotos">Photos (increases file size)</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="print-settings-section" style="background:white;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin:0 0 15px 0;font-size:16px;font-weight:700;">Layout Style</h4>
                                <div class="print-radio-group">
                                    <div class="print-radio-item">
                                        <input type="radio" id="layoutDetailed" name="layout" value="detailed" ${DATA.printOptions.layout === 'detailed' ? 'checked' : ''} onchange="event.stopPropagation();DATA.printOptions.layout=this.value;saveToStorage();">
                                        <label for="layoutDetailed">
                                            <div><strong>Detailed</strong></div>
                                            <div class="radio-desc">One day per page with all information</div>
                                        </label>
                                    </div>
                                    <div class="print-radio-item">
                                        <input type="radio" id="layoutCompact" name="layout" value="compact" ${DATA.printOptions.layout === 'compact' ? 'checked' : ''} onchange="event.stopPropagation();DATA.printOptions.layout=this.value;saveToStorage();">
                                        <label for="layoutCompact">
                                            <div><strong>Compact</strong></div>
                                            <div class="radio-desc">Multiple days per page, summary only</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top:30px;display:flex;gap:15px;justify-content:flex-end;">
                                <button onclick="event.stopPropagation();DATA.showPrintSettings=false;renderWithoutFlash()" class="btn-secondary" style="padding:12px 24px;">Cancel</button>
                                <button onclick="event.stopPropagation();executePrint()" class="btn" style="padding:12px 24px;">Print</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            // Export & Share Full Page
            if (DATA.showExportMenu) {
                h += `<div class="settings-overlay" onclick="closeExportMenu()"></div>
                <div class="export-page">
                    <div class="export-page-header">
                        <button class="back-button" onclick="closeExportMenu()" style="background:rgba(255,255,255,0.2);color:white;margin:0;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:24px;color:white;">Export & Share</h2>
                        <button class="btn" onclick="closeExportMenu()" style="padding:8px 16px;background:rgba(255,255,255,0.2);color:white;">
                            
                        </button>
                    </div>
                    
                    <div class="export-page-content">
                        <p style="color:#666;margin-bottom:30px;font-size:15px;text-align:center;">
                            Choose how you'd like to export or share your trip itinerary
                        </p>
                        
                        <div class="export-grid" style="grid-template-columns:repeat(3,1fr);gap:12px;">
                            <button class="export-option-card" onclick="exportToPDF();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">Print / PDF</div>
                                <div class="export-card-desc">Open print dialog for saving as PDF or printing</div>
                            </button>
                            
                            <button class="export-option-card" onclick="exportToHTML();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">HTML File</div>
                                <div class="export-card-desc">Download standalone webpage to share</div>
                            </button>
                            
                            <button class="export-option-card" onclick="exportToCSV();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">CSV Spreadsheet</div>
                                <div class="export-card-desc">Import into Excel or Google Sheets</div>
                            </button>
                            
                            <button class="export-option-card" onclick="exportToICalendar();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">Calendar (.ics)</div>
                                <div class="export-card-desc">Add to Google Calendar or Apple Calendar</div>
                            </button>
                            
                            <button class="export-option-card" onclick="emailItinerary();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">Email Itinerary</div>
                                <div class="export-card-desc">Send summary via your email app</div>
                            </button>
                            
                            <button class="export-option-card" onclick="copyShareableLink();DATA.showExportMenu=false;">
                                <div class="export-card-icon"></div>
                                <div class="export-card-title">Copy Share Data</div>
                                <div class="export-card-desc">Copy base64 data to share with others</div>
                            </button>
                        </div>
                        
                        <div class="info-box" style="margin-top:30px;">
                            <strong> Tips:</strong>
                            <ul style="margin:10px 0 0 20px;line-height:1.8;">
                                <li>Use <strong>Print/PDF</strong> for a clean, print-ready version</li>
                                <li>Use <strong>HTML File</strong> to create a shareable webpage</li>
                                <li>Use <strong>Calendar</strong> to sync your schedule with your device</li>
                                <li>Use <strong>CSV</strong> to analyze your budget in a spreadsheet</li>
                            </ul>
                        </div>
                    </div>
                </div>`;
            }
            
            //settings modal
            if (DATA.showSettings) {
                h += `<div class="settings-full-page" style="position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:2000;display:flex;flex-direction:column;">
                    <div style="padding:20px 30px;border-bottom:3px solid #000;flex-shrink:0;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#0d9488 0%,#2563eb 100%);z-index:10;">
                        <h2 style="margin:0;font-size:28px;font-weight:900;color:white;"> Settings</h2>
                        <button onclick="if(DATA.mobileMenuSource){DATA.mobileMenuOpen=true;DATA.mobileMenuSource=false;}DATA.showSettings=false;renderWithoutFlash()" style="padding:10px 20px;background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.4);border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;backdrop-filter:blur(4px);">
                             Back
                        </button>
                    </div>
                    
                    <div style="flex:1;padding:30px;background:#fafafa;overflow-y:auto;-webkit-overflow-scrolling:touch;">
                        <div style="max-width:1000px;margin:0 auto;">
                    ${DATA.settingsPage === 'main' ? `
                        <!-- Main Settings Menu -->
                        <div class="settings-menu-grid">
                            <button class="settings-menu-card" onclick="DATA.settingsPage='currency';renderWithoutFlash()">
                                <div class="settings-card-icon"></div>
                                <div>
                                    <div class="settings-card-title">Currency & Exchange Rate</div>
                                    <div class="settings-card-desc">Current: ${DATA.currencySymbol} ${CURRENCIES[DATA.currency].name}</div>
                                </div>
                                <div class="settings-card-arrow"></div>
                            </button>
                            
                            <button class="settings-menu-card" onclick="DATA.darkMode=!DATA.darkMode;saveToStorage();applyAppearanceSettings();">
                                <div class="settings-card-icon"></div>
                                <div>
                                    <div class="settings-card-title">Dark Mode</div>
                                    <div class="settings-card-desc">Toggle theme</div>
                                </div>
                                <div class="settings-card-arrow">${DATA.darkMode ? 'ON' : 'OFF'}</div>
                            </button>
                            
                            <button class="settings-menu-card" onclick="DATA.settingsPage='converter';renderWithoutFlash()">
                                <div class="settings-card-icon"></div>
                                <div>
                                    <div class="settings-card-title">Currency Converter</div>
                                    <div class="settings-card-desc">Quick conversion calculator</div>
                                </div>
                                <div class="settings-card-arrow"></div>
                            </button>
                            
                            <button class="settings-menu-card" onclick="DATA.settingsPage='travelers';renderWithoutFlash()">
                                <div class="settings-card-icon"></div>
                                <div>
                                    <div class="settings-card-title">Travelers</div>
                                    <div class="settings-card-desc">${DATA.travelerCount} traveler${DATA.travelerCount > 1 ? 's' : ''}  ${DATA.costSplitMode === 'perPerson' ? 'Per person' : 'Total'} mode</div>
                                </div>
                                <div class="settings-card-arrow"></div>
                            </button>
                            
                            <button class="settings-menu-card" onclick="DATA.settingsPage='categories';renderWithoutFlash()">
                                <div class="settings-card-icon"></div>
                                <div>
                                    <div class="settings-card-title">Expense Categories</div>
                                    <div class="settings-card-desc">${DATA.categories.length} categories</div>
                                </div>
                                <div class="settings-card-arrow"></div>
                            </button>

                            <button class="settings-menu-card" onclick="DATA.settingsPage='appearance';renderWithoutFlash()">
                                <div class="settings-card-icon"></div>
                                <div>
                                    <div class="settings-card-title">Appearance</div>
                                    <div class="settings-card-desc">Customize look and feel</div>
                                </div>
                                <div class="settings-card-arrow"></div>
                            </button>
                        </div>
                    ` : ''}
                    
                    ${DATA.settingsPage === 'currency' ? `
                        <!-- Currency Settings Page -->
                        <button class="back-button" onclick="switchSettingsPage('main')"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:24px;margin-bottom:20px;color:#1f2937;"> Currency Settings</h3>
                            
                            <div style="background:white;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px;">
                                <label style="display:block;font-weight:600;margin-bottom:12px;font-size:16px;color:#374151;">Select Currency</label>
                                <select value="${DATA.currency}" onchange="changeCurrency(this.value)" style="width:100%;padding:14px;border:3px solid #000;border-radius:8px;font-size:16px;background:white;cursor:pointer;">
                                    ${Object.keys(CURRENCIES).map(code => 
                                        `<option value="${code}" ${DATA.currency === code ? 'selected' : ''}>${CURRENCIES[code].symbol} ${CURRENCIES[code].name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div style="background:white;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                                    <label style="font-weight:600;font-size:16px;color:#374151;">Exchange Rate</label>
                                    <div class="rate-toggle">
                                        <label class="rate-toggle-label" style="font-size:14px;">Auto Update</label>
                                        <div class="toggle-switch ${DATA.liveRate ? 'on' : ''}" onclick="DATA.liveRate=!DATA.liveRate;if(DATA.liveRate){fetchLiveRate();}else{saveToStorage();renderWithoutFlash();}" style="width:50px;height:26px;cursor:pointer;">
                                            <div class="toggle-slider" style="width:20px;height:20px;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${DATA.liveRate ? 
                                    `<div style="padding:20px;background:#fafafa;border-radius:8px;border:3px solid #000;">
                                        <div style="font-size:24px;font-weight:700;margin-bottom:8px;color:#1f2937;">
                                            ${DATA.currencySymbol}${DATA.rate.toFixed(2)} per $1 USD
                                        </div>
                                        <div style="font-size:14px;color:#6b7280;">
                                            Last updated: ${DATA.lastFetchedRate || 'Fetching...'}
                                        </div>
                                        <div style="margin-top:12px;font-size:13px;color:#0d9488;">
                                            Rate updates automatically from live data
                                        </div>
                                    </div>` :
                                    `<input type="number" value="${DATA.rate}" onchange="DATA.rate=parseFloat(this.value)||155;saveToStorage();renderWithoutFlash()" style="width:100%;padding:14px;border:3px solid #000;border-radius:8px;font-size:18px;font-weight:600;" step="0.01" placeholder="Enter exchange rate">`
                                }
                            </div>
                        </div>
                    ` : ''}
                    
                    ${DATA.settingsPage === 'converter' ? `
                        <!-- Currency Converter Page -->
                        <button class="back-button" onclick="switchSettingsPage('main')"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:24px;margin-bottom:20px;color:#1f2937;"> Currency Converter</h3>
                            
                            <div style="background:white;padding:30px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:20px;align-items:center;">
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:10px;font-size:14px;color:#6b7280;">US Dollar</label>
                                        <div style="position:relative;">
                                            <span style="position:absolute;left:15px;top:50%;transform:translateY(-50%);font-size:20px;font-weight:700;color:#6b7280;">$</span>
                                            <input type="number" id="settingsUsdInput" value="${DATA.converterUSD.toFixed(2)}" step="0.01" 
                                                oninput="DATA.converterUSD=parseFloat(this.value)||0;DATA.converterYEN=DATA.converterUSD*DATA.rate;document.getElementById('settingsYenInput').value=DATA.converterYEN.toFixed(2);saveToStorage();"
                                                style="width:100%;padding:15px 15px 15px 40px;border:3px solid #000;border-radius:8px;font-size:24px;font-weight:700;">
                                        </div>
                                    </div>
                                    
                                    <button onclick="const t=DATA.converterUSD;DATA.converterUSD=DATA.converterYEN/DATA.rate;DATA.converterYEN=t*DATA.rate;document.getElementById('settingsUsdInput').value=DATA.converterUSD.toFixed(2);document.getElementById('settingsYenInput').value=DATA.converterYEN.toFixed(2);saveToStorage();" style="background:#0d9488;color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:24px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='rotate(180deg)'" onmouseout="this.style.transform='rotate(0deg)'">
                                        
                                    </button>
                                    
                                    <div>
                                        <label style="display:block;font-weight:600;margin-bottom:10px;font-size:14px;color:#6b7280;">${CURRENCIES[DATA.currency].name}</label>
                                        <div style="position:relative;">
                                            <span style="position:absolute;left:15px;top:50%;transform:translateY(-50%);font-size:20px;font-weight:700;color:#6b7280;">${DATA.currencySymbol}</span>
                                            <input type="number" id="settingsYenInput" value="${DATA.converterYEN.toFixed(2)}" step="0.01" 
                                                oninput="DATA.converterYEN=parseFloat(this.value)||0;DATA.converterUSD=DATA.converterYEN/DATA.rate;document.getElementById('settingsUsdInput').value=DATA.converterUSD.toFixed(2);saveToStorage();"
                                                style="width:100%;padding:15px 15px 15px 40px;border:3px solid #000;border-radius:8px;font-size:24px;font-weight:700;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="text-align:center;margin-top:25px;padding-top:20px;border-top:2px solid #e5e7eb;color:#6b7280;font-size:14px;">
                                    Exchange Rate: <strong>${DATA.currencySymbol}${DATA.rate.toFixed(2)} per $1</strong>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${DATA.settingsPage === 'travelers' ? `
                        <!-- Travelers Page -->
                        <button class="back-button" onclick="switchSettingsPage('main')"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:24px;margin-bottom:20px;color:#1f2937;"> Travelers</h3>
                            
                            <div style="background:white;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px;">
                                <label style="display:block;font-weight:600;margin-bottom:15px;font-size:16px;color:#374151;">Number of Travelers</label>
                                <div class="traveler-count" style="justify-content:flex-start;">
                                    <button class="traveler-count-btn" onclick="event.stopPropagation();updateTravelerCount(-1)"></button>
                                    <div class="traveler-count-display">${DATA.travelerCount}</div>
                                    <button class="traveler-count-btn" onclick="event.stopPropagation();updateTravelerCount(1)">+</button>
                                    <span style="color:#6b7280;font-size:16px;margin-left:15px;">${DATA.travelerCount} traveler${DATA.travelerCount > 1 ? 's' : ''}</span>
                                </div>
                            </div>
                            
                            ${DATA.travelerCount > 1 ? `
                                <div style="background:white;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px;">
                                    <label style="display:block;font-weight:600;margin-bottom:15px;font-size:16px;color:#374151;">Traveler Names</label>
                                    <div class="traveler-list">
                                        ${DATA.travelers.map((name, idx) => `
                                            <div class="traveler-item" style="padding:15px;">
                                                <span style="font-size:24px;"></span>
                                                <input type="text" value="${name}" onchange="event.stopPropagation();updateTravelerName(${idx}, this.value)" placeholder="Traveler ${idx + 1}" style="flex:1;padding:12px;border:3px solid #000;border-radius:6px;font-size:16px;">
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div style="background:white;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                    <label style="display:block;font-weight:600;margin-bottom:15px;font-size:16px;color:#374151;">Cost Display Mode</label>
                                    <div class="cost-split-toggle">
                                        <div class="cost-split-option" style="padding:15px;">
                                            <input type="radio" name="costSplit" id="costTotal" ${DATA.costSplitMode === 'total' ? 'checked' : ''} onchange="event.stopPropagation();setCostSplitMode('total')">
                                            <label for="costTotal" onclick="event.stopPropagation()" style="font-size:15px;">
                                                <strong>Total Only</strong>
                                                <div style="font-size:13px;color:#6b7280;margin-top:4px;">Show only the total cost</div>
                                            </label>
                                        </div>
                                        <div class="cost-split-option" style="padding:15px;">
                                            <input type="radio" name="costSplit" id="costPerPerson" ${DATA.costSplitMode === 'perPerson' ? 'checked' : ''} onchange="event.stopPropagation();setCostSplitMode('perPerson')">
                                            <label for="costPerPerson" onclick="event.stopPropagation()" style="font-size:15px;">
                                                <strong>Total + Per Person</strong>
                                                <div style="font-size:13px;color:#6b7280;margin-top:4px;">Show total and cost split per person</div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${DATA.settingsPage === 'categories' ? `
                        <!-- Categories Page -->
                        <button class="back-button" onclick="switchSettingsPage('main')"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:20px;margin-bottom:20px;color:#000;font-weight:700;">Expense Categories</h3>
                            
                            <div style="display:grid;gap:12px;margin-bottom:20px;">
                                ${DATA.categories.map(cat => `
                                    <div style="background:white;padding:16px;border-radius:8px;border:3px solid #000;display:flex;gap:12px;align-items:center;transition:all 0.2s;" onmouseover="this.style.borderColor='#000'" onmouseout="this.style.borderColor='#e5e7eb'">
                                        <div class="category-icon-picker" onclick="openIconPicker('${cat.id}')" style="font-size:24px;width:48px;height:48px;cursor:pointer;border:3px solid #000;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;" onmouseover="this.style.borderColor='#000'" onmouseout="this.style.borderColor='#e5e7eb'">${cat.icon}</div>
                                        <div style="flex:1;min-width:0;">
                                            <input type="text" value="${cat.name}" onchange="updateCategory('${cat.id}', 'name', this.value)" style="width:100%;padding:8px 10px;border:3px solid #000;border-radius:6px;font-size:14px;font-weight:600;margin-bottom:6px;">
                                            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                                                <div style="display:flex;align-items:center;gap:6px;padding:4px 10px;background:#fafafa;border-radius:6px;border:1px solid #e5e7eb;">
                                                    <span style="font-size:11px;color:#666;font-weight:600;">Color</span>
                                                    <div style="width:20px;height:20px;border-radius:4px;background:${cat.color};border:3px solid #000;cursor:pointer;" onclick="this.nextElementSibling.click()"></div>
                                                    <input type="color" class="category-color-picker" value="${cat.color}" onchange="updateCategory('${cat.id}', 'color', this.value)" style="width:0;height:0;opacity:0;position:absolute;">
                                                </div>
                                                <span style="font-size:11px;color:#999;font-family:monospace;">ID: ${cat.id}</span>
                                            </div>
                                        </div>
                                        <button class="btn-secondary" onclick="deleteCategory('${cat.id}')" style="padding:8px 16px;font-size:13px;border-color:#000;color:#000;flex-shrink:0;" onmouseover="this.style.background='#ef4444';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='#ef4444'">
                                            
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button class="btn" onclick="addCategory()" style="width:100%;padding:12px;font-size:14px;font-weight:600;">
                                + Add New Category
                            </button>
                        </div>
                    ` : ''}
            
                    ${DATA.settingsPage === 'appearance' ? `
                        <!-- Appearance Settings Page -->
                        <button class="back-button" onclick="switchSettingsPage('main')"> Back to Settings</button>
                        
                        <div class="settings-content-page">
                            <h3 style="font-size:20px;margin-bottom:20px;color:#000;font-weight:700;">Appearance</h3>
                            
                            <!-- Animation Speed - WORKING -->
                            <div style="background:white;padding:25px;border-radius:12px;border:3px solid #000;margin-bottom:20px;">
                                <label style="display:block;font-weight:700;margin-bottom:15px;font-size:16px;color:#000;"> Animation Speed</label>
                                <p style="color:#666;font-size:13px;margin-bottom:15px;">Controls how fast transitions and animations play throughout the app</p>
                                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
                                    <button class="btn ${DATA.animationSpeed === 'fast' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.animationSpeed='fast';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;">
                                         Fast<br><small style="opacity:0.7;">0.15s</small>
                                    </button>
                                    <button class="btn ${!DATA.animationSpeed || DATA.animationSpeed === 'normal' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.animationSpeed='normal';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;">
                                         Normal<br><small style="opacity:0.7;">0.3s</small>
                                    </button>
                                    <button class="btn ${DATA.animationSpeed === 'slow' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.animationSpeed='slow';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;">
                                         Slow<br><small style="opacity:0.7;">0.6s</small>
                                    </button>
                                </div>
                                <div style="padding:20px;background:#fafafa;border-radius:8px;text-align:center;">
                                    <div style="width:80px;height:80px;margin:0 auto 15px;background:linear-gradient(135deg,#0d9488,#8b5cf6);border-radius:12px;transition:all var(--transition-speed);transform:translateX(0) rotate(0deg) scale(1);" 
                                         id="animPreview"></div>
                                    <button class="btn" 
                                            onclick="const el=document.getElementById('animPreview');el.style.transform='translateX(80px) rotate(180deg) scale(1.2)';setTimeout(()=>el.style.transform='translateX(0) rotate(0deg) scale(1)',100);" 
                                            style="padding:10px 20px;">
                                        Test Animation
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Card Style - ACTUALLY APPLIES -->
                            <div style="background:white;padding:25px;border-radius:12px;border:3px solid #000;margin-bottom:20px;">
                                <label style="display:block;font-weight:700;margin-bottom:15px;font-size:16px;color:#000;">Card Style</label>
                                <p style="color:#666;font-size:13px;margin-bottom:15px;">Choose between modern elevated cards or classic flat borders</p>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
                                    <button class="btn ${!DATA.cardStyle || DATA.cardStyle === 'modern' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.cardStyle='modern';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;">
                                         Modern<br><small style="opacity:0.7;">Shadows & depth</small>
                                    </button>
                                    <button class="btn ${DATA.cardStyle === 'classic' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.cardStyle='classic';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;">
                                        Classic<br><small style="opacity:0.7;">Flat & minimal</small>
                                    </button>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div style="padding:20px;${DATA.cardStyle === 'modern' ? 'background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:3px solid #000;' : 'background:white;border:3px solid #000;border-radius:8px;'}">
                                        <div style="font-weight:700;margin-bottom:8px;"> Modern</div>
                                        <div style="font-size:12px;color:#666;">Elevated with shadows</div>
                                    </div>
                                    <div style="padding:20px;${DATA.cardStyle === 'classic' ? 'background:white;border:3px solid #000;border-radius:8px;' : 'background:white;border:3px solid #000;border-radius:8px;'}">
                                        <div style="font-weight:700;margin-bottom:8px;">Classic</div>
                                        <div style="font-size:12px;color:#666;">Flat with borders</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interface Density - LIVE UPDATE -->
                            <div style="background:white;padding:25px;border-radius:12px;border:3px solid #000;margin-bottom:20px;">
                                <label style="display:block;font-weight:700;margin-bottom:15px;font-size:16px;color:#000;">Interface Density</label>
                                <p style="color:#666;font-size:13px;margin-bottom:15px;">Adjust spacing throughout the interface to show more or less content</p>
                                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
                                    <button class="btn ${DATA.density === 'compact' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.density='compact';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;">
                                        Compact<br><small style="opacity:0.7;">12px padding</small>
                                    </button>
                                    <button class="btn ${!DATA.density || DATA.density === 'comfortable' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.density='comfortable';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;">
                                        Comfortable<br><small style="opacity:0.7;">20px padding</small>
                                    </button>
                                    <button class="btn ${DATA.density === 'spacious' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.density='spacious';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;">
                                        Spacious<br><small style="opacity:0.7;">28px padding</small>
                                    </button>
                                </div>
                                <div style="background:#fafafa;padding:15px;border-radius:8px;">
                                    <div class="day-card" style="padding:${DATA.density === 'compact' ? '12px' : DATA.density === 'spacious' ? '28px' : '20px'};margin:0 0 12px 0;">
                                        <div style="font-weight:700;margin-bottom:8px;font-size:${DATA.density === 'compact' ? '13px' : DATA.density === 'spacious' ? '16px' : '14px'};">Day 1 - Sample Location</div>
                                        <div style="font-size:${DATA.density === 'compact' ? '11px' : DATA.density === 'spacious' ? '13px' : '12px'};color:#666;line-height:1.5;">
                                            ${DATA.density === 'compact' ? ' Compact mode shows more content in less space' : DATA.density === 'spacious' ? 'Spacious mode provides extra breathing room for easier reading' : 'Comfortable mode balances content density with readability'}
                                        </div>
                                    </div>
                                    <div style="display:grid;grid-template-columns:repeat(${DATA.density === 'compact' ? '3' : DATA.density === 'spacious' ? '1' : '2'},1fr);gap:${DATA.density === 'compact' ? '8px' : DATA.density === 'spacious' ? '16px' : '12px'};">
                                        <div style="padding:${DATA.density === 'compact' ? '8px' : DATA.density === 'spacious' ? '16px' : '12px'};background:white;border-radius:8px;border:1px solid #e5e7eb;">
                                            <div style="font-size:11px;color:#666;">Accommodation</div>
                                            <div style="font-weight:600;font-size:${DATA.density === 'compact' ? '11px' : '12px'};margin-top:4px;">Hotel Name</div>
                                        </div>
                                        <div style="padding:${DATA.density === 'compact' ? '8px' : DATA.density === 'spacious' ? '16px' : '12px'};background:white;border-radius:8px;border:1px solid #e5e7eb;">
                                            <div style="font-size:11px;color:#666;">Food</div>
                                            <div style="font-weight:600;font-size:${DATA.density === 'compact' ? '11px' : '12px'};margin-top:4px;">Restaurant</div>
                                        </div>
                                        <div style="padding:${DATA.density === 'compact' ? '8px' : DATA.density === 'spacious' ? '16px' : '12px'};background:white;border-radius:8px;border:1px solid #e5e7eb;">
                                            <div style="font-size:11px;color:#666;">Activities</div>
                                            <div style="font-weight:600;font-size:${DATA.density === 'compact' ? '11px' : '12px'};margin-top:4px;">Sightseeing</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Font Size -->
                            <div style="background:white;padding:25px;border-radius:12px;border:3px solid #000;">
                                <label style="display:block;font-weight:700;margin-bottom:15px;font-size:16px;color:#000;">Font Size</label>
                                <p style="color:#666;font-size:13px;margin-bottom:15px;">Adjust base font size for better readability</p>
                                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
                                    <button class="btn ${DATA.fontSize === 'small' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.fontSize='small';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;font-size:13px;">
                                        Small<br><small style="opacity:0.7;">14px</small>
                                    </button>
                                    <button class="btn ${!DATA.fontSize || DATA.fontSize === 'medium' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.fontSize='medium';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;font-size:14px;">
                                        Medium<br><small style="opacity:0.7;">16px</small>
                                    </button>
                                    <button class="btn ${DATA.fontSize === 'large' ? '' : 'btn-secondary'}" 
                                            onclick="DATA.fontSize='large';applyAppearanceSettings();saveToStorage();renderWithoutFlash();" 
                                            style="padding:12px;font-size:15px;">
                                        Large<br><small style="opacity:0.7;">18px</small>
                                    </button>
                                </div>
                                <div style="padding:20px;background:#fafafa;border-radius:8px;">
                                    <p style="margin:0;line-height:1.6;">This is a sample paragraph showing how your selected font size looks. The quick brown fox jumps over the lazy dog.</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                        </div>
                    </div>
                </div>`;
            }
            
            // Analytics Full Page
            if (DATA.showAnalyticsPage) {
                h += `<div class="settings-overlay" onclick="closeAnalytics()"></div>
                <div class="analytics-page">
                    <div class="analytics-header">
                        <button class="back-button" onclick="closeAnalytics()" style="background:white !important;color:#000 !important;margin:0;border:3px solid #000;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:24px;color:#000 !important;">
                            ${DATA.showAnalyticsPage === 'trends' ? ' Spending Trends' : ''}
                            ${DATA.showAnalyticsPage === 'receipts' ? ' Receipt Analytics' : ''}
                            ${DATA.showAnalyticsPage === 'comparison' ? ' Budget vs Actual' : ''}
                            ${DATA.showAnalyticsPage === 'timeline' ? ' Trip Timeline' : ''}
                            ${DATA.showAnalyticsPage === 'map' ? ' Trip Map' : ''}
                        </h2>
                    </div>
                    
                    <div class="analytics-content">
                        ${DATA.showAnalyticsPage === 'trends' ? `
                            <!-- SPENDING TRENDS - Completely Redesigned -->
                            <div style="margin-bottom:24px;">
                                <div style="display:flex;gap:10px;margin-bottom:20px;">
                                    <button class="chart-toggle-btn ${!DATA.trendsChartView || DATA.trendsChartView==='daily'?'active':''}" onclick="DATA.trendsChartView='daily';renderWithoutFlash()">
                                        Daily
                                    </button>
                                    <button class="chart-toggle-btn ${DATA.trendsChartView==='cumulative'?'active':''}" onclick="DATA.trendsChartView='cumulative';renderWithoutFlash()">
                                         Cumulative
                                    </button>
                                    <button class="chart-toggle-btn ${DATA.trendsChartView==='category'?'active':''}" onclick="DATA.trendsChartView='category';renderWithoutFlash()">
                                        Categories
                                    </button>
                                </div>
                                
                                ${(() => {
                                    if (DATA.days.length === 0) {
                                        return '<div class="empty-state"><div style="font-size:64px;margin-bottom:20px;opacity:0.5;"></div><h3 style="font-size:20px;margin-bottom:10px;">No Data Available</h3><p style="color:#666;">Add trip days with actual spending to see trends</p></div>';
                                    }
                                    
                                    const view = DATA.trendsChartView || 'daily';
                                    const completedDays = DATA.days.filter(d => d.done);
                                    
                                    if (completedDays.length === 0 && view !== 'category') {
                                        return '<div class="empty-state"><div style="font-size:64px;margin-bottom:20px;opacity:0.5;"></div><h3 style="font-size:20px;margin-bottom:10px;">No Completed Days</h3><p style="color:#666;">Mark days as complete to track actual spending</p></div>';
                                    }
                                    
                                    let html = '<div style="background:white;border:3px solid #000;border-radius:12px;padding:24px;">';
                                    
                                    if (view === 'daily') {
                                        // DAILY VIEW - Simple bar chart
                                        const maxSpend = Math.max(...completedDays.map(d => calcA(d)));
                                        
                                        html += '<h4 style="margin:0 0 20px 0;font-size:16px;color:#000;">Daily Actual Spending</h4>';
                                        html += '<div style="display:grid;gap:12px;">';
                                        
                                        completedDays.forEach(day => {
                                            const amount = calcA(day);
                                            const percent = (amount / maxSpend) * 100;
                                            
                                            html += `
                                                <div style="display:flex;align-items:center;gap:12px;">
                                                    <div style="min-width:80px;font-size:13px;font-weight:600;color:#666;">
                                                        Day ${day.d}
                                                    </div>
                                                    <div style="flex:1;position:relative;height:32px;background:#f5f5f5;border-radius:6px;overflow:hidden;">
                                                        <div style="position:absolute;top:0;left:0;bottom:0;width:${percent}%;background:#10b981;transition:width 0.3s;"></div>
                                                        <div style="position:absolute;top:50%;left:12px;transform:translateY(-50%);font-size:13px;font-weight:600;color:${percent > 50 ? 'white' : '#000'};">
                                                            ${DATA.currencySymbol}${amount.toLocaleString()}
                                                        </div>
                                                    </div>
                                                    <div style="min-width:100px;font-size:13px;color:#666;text-align:right;">
                                                        $${(amount / DATA.rate).toFixed(2)}
                                                    </div>
                                                </div>
                                            `;
                                        });
                                        
                                        html += '</div>';
                                        
                                        // Stats summary
                                        const totalSpent = completedDays.reduce((sum, d) => sum + calcA(d), 0);
                                        const avgDaily = totalSpent / completedDays.length;
                                        
                                        html += `
                                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-top:24px;padding-top:24px;border-top:2px solid #f5f5f5;">
                                                <div>
                                                    <div style="font-size:12px;color:#666;margin-bottom:4px;">TOTAL SPENT</div>
                                                    <div style="font-size:20px;font-weight:700;color:#000;">${DATA.currencySymbol}${totalSpent.toLocaleString()}</div>
                                                </div>
                                                <div>
                                                    <div style="font-size:12px;color:#666;margin-bottom:4px;">DAILY AVERAGE</div>
                                                    <div style="font-size:20px;font-weight:700;color:#000;">${DATA.currencySymbol}${Math.round(avgDaily).toLocaleString()}</div>
                                                </div>
                                                <div>
                                                    <div style="font-size:12px;color:#666;margin-bottom:4px;">DAYS TRACKED</div>
                                                    <div style="font-size:20px;font-weight:700;color:#000;">${completedDays.length}</div>
                                                </div>
                                            </div>
                                        `;
                                        
                                    } else if (view === 'cumulative') {
                                        // CUMULATIVE VIEW - Line chart
                                        html += '<h4 style="margin:0 0 20px 0;font-size:16px;color:#000;">Cumulative Spending Progress</h4>';
                                        
                                        let cumulativePlanned = 0;
                                        let cumulativeActual = 0;
                                        const points = [];
                                        
                                        DATA.days.forEach((day, idx) => {
                                            cumulativePlanned += calc(day);
                                            cumulativeActual += day.done ? calcA(day) : 0;
                                            points.push({
                                                day: day.d,
                                                planned: cumulativePlanned,
                                                actual: cumulativeActual,
                                                done: day.done
                                            });
                                        });
                                        
                                        const maxValue = Math.max(cumulativePlanned, cumulativeActual);
                                        const chartHeight = 300;
                                        
                                        html += `
                                            <div style="position:relative;height:${chartHeight}px;margin-bottom:20px;">
                                                <svg width="100%" height="${chartHeight}" viewBox="0 0 600 ${chartHeight}" preserveAspectRatio="none" style="position:absolute;top:0;left:0;">
                                                    <!-- Grid lines -->
                                                    ${[0,1,2,3,4].map(i => {
                                                        const y = (chartHeight - 40) * (i / 4) + 20;
                                                        const value = maxValue * (1 - i / 4);
                                                        return `
                                                            <line x1="50" y1="${y}" x2="570" y2="${y}" stroke="#f0f0f0" stroke-width="1"/>
                                                            <text x="20" y="${y + 4}" font-size="11" fill="#999" text-anchor="end">${DATA.currencySymbol}${Math.round(value/1000)}k</text>
                                                        `;
                                                    }).join('')}
                                                    
                                                    <!-- Planned line (dashed) -->
                                                    <path d="${points.map((p, i) => {
                                                        const x = 50 + (520 * i / (points.length - 1));
                                                        const y = 20 + ((chartHeight - 60) * (1 - p.planned / maxValue));
                                                        return (i === 0 ? 'M' : 'L') + x + ',' + y;
                                                    }).join(' ')}" 
                                                    stroke="#0d9488" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                                                    
                                                    <!-- Actual line (solid) -->
                                                    <path d="${points.filter(p => p.done).map((p, i, arr) => {
                                                        const originalIdx = points.indexOf(p);
                                                        const x = 50 + (520 * originalIdx / (points.length - 1));
                                                        const y = 20 + ((chartHeight - 60) * (1 - p.actual / maxValue));
                                                        return (i === 0 ? 'M' : 'L') + x + ',' + y;
                                                    }).join(' ')}" 
                                                    stroke="#10b981" stroke-width="3" fill="none"/>
                                                    
                                                    <!-- Data points -->
                                                    ${points.map((p, i) => {
                                                        const x = 50 + (520 * i / (points.length - 1));
                                                        const yPlanned = 20 + ((chartHeight - 60) * (1 - p.planned / maxValue));
                                                        const yActual = 20 + ((chartHeight - 60) * (1 - p.actual / maxValue));
                                                        return `
                                                            <circle cx="${x}" cy="${yPlanned}" r="3" fill="#0d9488"/>
                                                            ${p.done ? `<circle cx="${x}" cy="${yActual}" r="4" fill="#10b981"/>` : ''}
                                                        `;
                                                    }).join('')}
                                                </svg>
                                            </div>
                                            
                                            <div style="display:flex;justify-content:center;gap:30px;font-size:13px;">
                                                <div style="display:flex;align-items:center;gap:8px;">
                                                    <div style="width:24px;height:3px;background:#0d9488;border:1px dashed #0d9488;"></div>
                                                    <span>Planned</span>
                                                </div>
                                                <div style="display:flex;align-items:center;gap:8px;">
                                                    <div style="width:24px;height:3px;background:#10b981;"></div>
                                                    <span>Actual</span>
                                                </div>
                                            </div>
                                        `;
                                        
                                    } else if (view === 'category') {
                                        // CATEGORY VIEW - Horizontal bars
                                        html += '<h4 style="margin:0 0 20px 0;font-size:16px;color:#000;">Spending by Category</h4>';
                                        
                                        const categoryTotals = DATA.categories.map(cat => ({
                                            ...cat,
                                            amount: DATA.days.reduce((sum, day) => sum + (day.done ? (day.a?.[cat.id] || 0) : 0), 0)
                                        })).sort((a, b) => b.amount - a.amount);
                                        
                                        const maxAmount = Math.max(...categoryTotals.map(c => c.amount), 1);
                                        const totalSpent = categoryTotals.reduce((sum, c) => sum + c.amount, 0);
                                        
                                        html += '<div style="display:grid;gap:16px;">';
                                        
                                        categoryTotals.forEach(cat => {
                                            const percent = (cat.amount / maxAmount) * 100;
                                            const percentOfTotal = totalSpent > 0 ? (cat.amount / totalSpent) * 100 : 0;
                                            
                                            html += `
                                                <div>
                                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                                        <div style="display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600;">
                                                            <span style="font-size:20px;">${cat.icon}</span>
                                                            <span>${cat.name}</span>
                                                        </div>
                                                        <div style="display:flex;align-items:center;gap:12px;">
                                                            <span style="font-size:14px;font-weight:700;">${DATA.currencySymbol}${cat.amount.toLocaleString()}</span>
                                                            <span style="font-size:12px;color:#666;min-width:45px;text-align:right;">${percentOfTotal.toFixed(1)}%</span>
                                                        </div>
                                                    </div>
                                                    <div style="height:32px;background:#f5f5f5;border-radius:6px;overflow:hidden;position:relative;">
                                                        <div style="position:absolute;top:0;left:0;bottom:0;width:${percent}%;background:${cat.color};transition:width 0.3s;"></div>
                                                    </div>
                                                </div>
                                            `;
                                        });
                                        
                                        html += '</div>';
                                    }
                                    
                                    html += '</div>';
                                    return html;
                                })()}
                            </div>
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'comparison' ? `
                            <!-- BUDGET VS ACTUAL WITH TABS -->
                            <div style="margin-bottom:20px;">
                                <div style="display:flex;gap:10px;">
                                    <button class="chart-toggle-btn ${DATA.comparisonView === 'comparison' ? 'active' : ''}" onclick="DATA.comparisonView='comparison';renderWithoutFlash()">
                                         Comparison
                                    </button>
                                    <button class="chart-toggle-btn ${DATA.comparisonView === 'breakdown' ? 'active' : ''}" onclick="DATA.comparisonView='breakdown';renderWithoutFlash()">
                                        Breakdown
                                    </button>
                                </div>
                            </div>
                            
                            ${DATA.comparisonView === 'comparison' ? `
                                <!-- COMPARISON VIEW -->
                                <div style="background:white;border:3px solid #000;border-radius:12px;padding:24px;">
                                    ${(() => {
                                        if (DATA.days.length === 0) {
                                            return '<div class="empty-state"><div style="font-size:64px;margin-bottom:20px;opacity:0.5;"></div><h3 style="font-size:20px;margin-bottom:10px;">No Data Available</h3><p style="color:#666;">Add trip days to compare budgets</p></div>';
                                        }
                                        
                                        const completedDays = DATA.days.filter(d => d.done);
                                        
                                        if (completedDays.length === 0) {
                                            return '<div class="empty-state"><div style="font-size:64px;margin-bottom:20px;opacity:0.5;"></div><h3 style="font-size:20px;margin-bottom:10px;">No Completed Days</h3><p style="color:#666;">Mark days as complete to see comparisons</p></div>';
                                        }
                                        
                                        const totalPlanned = completedDays.reduce((sum, d) => sum + calc(d), 0);
                                        const totalActual = completedDays.reduce((sum, d) => sum + calcA(d), 0);
                                        const difference = totalActual - totalPlanned;
                                        const percentDiff = totalPlanned > 0 ? (difference / totalPlanned * 100) : 0;
                                        const isOver = difference > 0;
                                        
                                        let html = `
                                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px;">
                                                <div style="padding:24px;background:#fafafa;border-radius:12px;text-align:center;">
                                                    <div style="font-size:12px;color:#0369a1;margin-bottom:8px;">PLANNED BUDGET</div>
                                                    <div style="font-size:28px;font-weight:700;color:#0d9488;">${DATA.currencySymbol}${totalPlanned.toLocaleString()}</div>
                                                </div>
                                                <div style="padding:24px;background:#fafafa;border-radius:12px;text-align:center;">
                                                    <div style="font-size:12px;color:#15803d;margin-bottom:8px;">ACTUAL SPENT</div>
                                                    <div style="font-size:28px;font-weight:700;color:#000;">${DATA.currencySymbol}${totalActual.toLocaleString()}</div>
                                                </div>
                                                <div style="padding:24px;background:${isOver ? '#fef2f2' : '#f0fdf4'};border-radius:12px;text-align:center;">
                                                    <div style="font-size:12px;color:${isOver ? '#991b1b' : '#15803d'};margin-bottom:8px;">${isOver ? 'OVER BUDGET' : 'UNDER BUDGET'}</div>
                                                    <div style="font-size:28px;font-weight:700;color:${isOver ? '#ef4444' : '#10b981'};">
                                                        ${isOver ? '+' : ''}${DATA.currencySymbol}${Math.abs(difference).toLocaleString()}
                                                    </div>
                                                    <div style="font-size:13px;color:#666;margin-top:4px;">${isOver ? '+' : ''}${percentDiff.toFixed(1)}%</div>
                                                </div>
                                            </div>
                                            
                                            <div style="margin-bottom:32px;">
                                                <h5 style="font-size:14px;margin-bottom:16px;color:#666;">DAY-BY-DAY COMPARISON</h5>
                                                <div style="display:grid;gap:12px;">
                                        `;
                                        
                                        completedDays.forEach(day => {
                                            const planned = calc(day);
                                            const actual = calcA(day);
                                            const diff = actual - planned;
                                            const dayOver = diff > 0;
                                            
                                            html += `
                                                <div style="border:3px solid #000;border-radius:8px;padding:16px;">
                                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                                        <div style="font-size:14px;font-weight:700;">Day ${day.d} - ${day.loc}</div>
                                                        <div style="padding:4px 12px;background:${dayOver ? '#fef2f2' : '#f0fdf4'};border-radius:20px;font-size:12px;font-weight:600;color:${dayOver ? '#dc2626' : '#16a34a'};">
                                                            ${dayOver ? '+' : ''}${DATA.currencySymbol}${Math.abs(diff).toLocaleString()}
                                                        </div>
                                                    </div>
                                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                                        <div>
                                                            <div style="font-size:11px;color:#666;margin-bottom:4px;">PLANNED</div>
                                                            <div style="font-size:16px;font-weight:600;color:#0d9488;">${DATA.currencySymbol}${planned.toLocaleString()}</div>
                                                        </div>
                                                        <div>
                                                            <div style="font-size:11px;color:#666;margin-bottom:4px;">ACTUAL</div>
                                                            <div style="font-size:16px;font-weight:600;color:#000;">${DATA.currencySymbol}${actual.toLocaleString()}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        });
                                        
                                        html += '</div></div>';
                                        return html;
                                    })()}
                                </div>
                            ` : `
                                <!-- BREAKDOWN VIEW (formerly standalone) -->
                                <div style="background:white;border:3px solid #000;border-radius:12px;padding:24px;">
                                    ${(() => {
                                        if (DATA.days.length === 0) {
                                            return '<div class="empty-state"><div style="font-size:64px;margin-bottom:20px;opacity:0.5;"></div><h3 style="font-size:20px;margin-bottom:10px;">No Data Available</h3><p style="color:#666;">Add trip days to see expense breakdown</p></div>';
                                        }
                                        
                                        // Calculate totals
                                        const categoryBreakdown = DATA.categories.map(cat => {
                                            const planned = DATA.days.reduce((sum, day) => sum + (day[cat.id]?.p || 0), 0);
                                            const actual = DATA.days.reduce((sum, day) => sum + (day.done ? (day.a?.[cat.id] || 0) : 0), 0);
                                            return { ...cat, planned, actual };
                                        });
                                        
                                        const totalPlanned = categoryBreakdown.reduce((sum, c) => sum + c.planned, 0);
                                        const totalActual = categoryBreakdown.reduce((sum, c) => sum + c.actual, 0);
                                        const hasActual = DATA.days.some(d => d.done);
                                        
                                        let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-bottom:32px;">';
                                        
                                        // Planned Pie
                                        html += `
                                            <div>
                                                <h5 style="text-align:center;font-size:14px;color:#666;margin-bottom:16px;">PLANNED</h5>
                                                <div style="position:relative;width:200px;height:200px;margin:0 auto;">
                                                    <svg width="200" height="200" style="transform:rotate(-90deg);">
                                                        ${(() => {
                                                            let currentAngle = 0;
                                                            return categoryBreakdown.map(cat => {
                                                                const percent = totalPlanned > 0 ? cat.planned / totalPlanned : 0;
                                                                const angle = percent * 360;
                                                                const largeArc = angle > 180 ? 1 : 0;
                                                                
                                                                const x1 = 100 + 90 * Math.cos((currentAngle * Math.PI) / 180);
                                                                const y1 = 100 + 90 * Math.sin((currentAngle * Math.PI) / 180);
                                                                currentAngle += angle;
                                                                const x2 = 100 + 90 * Math.cos((currentAngle * Math.PI) / 180);
                                                                const y2 = 100 + 90 * Math.sin((currentAngle * Math.PI) / 180);
                                                                
                                                                if (percent === 0) return '';
                                                                
                                                                return '<path d="M 100 100 L ' + x1 + ' ' + y1 + ' A 90 90 0 ' + largeArc + ' 1 ' + x2 + ' ' + y2 + ' Z" fill="' + cat.color + '"/>';
                                                            }).join('');
                                                        })()}
                                                        <circle cx="100" cy="100" r="50" fill="white"/>
                                                    </svg>
                                                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
                                                        <div style="font-size:20px;font-weight:700;">${DATA.currencySymbol}${totalPlanned.toLocaleString()}</div>
                                                        <div style="font-size:11px;color:#666;">TOTAL</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                        
                                        // Actual Pie
                                        html += `
                                            <div style="${!hasActual ? 'opacity:0.3;' : ''}">
                                                <h5 style="text-align:center;font-size:14px;color:#666;margin-bottom:16px;">ACTUAL</h5>
                                                <div style="position:relative;width:200px;height:200px;margin:0 auto;">
                                                    ${hasActual ? `
                                                        <svg width="200" height="200" style="transform:rotate(-90deg);">
                                                            ${(() => {
                                                                let currentAngle = 0;
                                                                return categoryBreakdown.map(cat => {
                                                                    const percent = totalActual > 0 ? cat.actual / totalActual : 0;
                                                                    const angle = percent * 360;
                                                                    const largeArc = angle > 180 ? 1 : 0;
                                                                    
                                                                    const x1 = 100 + 90 * Math.cos((currentAngle * Math.PI) / 180);
                                                                    const y1 = 100 + 90 * Math.sin((currentAngle * Math.PI) / 180);
                                                                    currentAngle += angle;
                                                                    const x2 = 100 + 90 * Math.cos((currentAngle * Math.PI) / 180);
                                                                    const y2 = 100 + 90 * Math.sin((currentAngle * Math.PI) / 180);
                                                                    
                                                                    if (percent === 0) return '';
                                                                    
                                                                    return '<path d="M 100 100 L ' + x1 + ' ' + y1 + ' A 90 90 0 ' + largeArc + ' 1 ' + x2 + ' ' + y2 + ' Z" fill="' + cat.color + '"/>';
                                                                }).join('');
                                                            })()}
                                                            <circle cx="100" cy="100" r="50" fill="white"/>
                                                        </svg>
                                                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
                                                            <div style="font-size:20px;font-weight:700;">${DATA.currencySymbol}${totalActual.toLocaleString()}</div>
                                                            <div style="font-size:11px;color:#666;">TOTAL</div>
                                                        </div>
                                                    ` : `
                                                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#999;">
                                                            <div style="font-size:32px;margin-bottom:8px;"></div>
                                                            <div style="font-size:12px;">No data yet</div>
                                                        </div>
                                                    `}
                                                </div>
                                            </div>
                                        `;
                                        
                                        html += '</div>';
                                        
                                        // Legend and details
                                        html += '<div style="display:grid;gap:12px;">';
                                        categoryBreakdown.forEach(cat => {
                                            const plannedPercent = totalPlanned > 0 ? (cat.planned / totalPlanned * 100) : 0;
                                            const actualPercent = totalActual > 0 ? (cat.actual / totalActual * 100) : 0;
                                            
                                            html += `
                                                <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:16px;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;">
                                                    <div style="display:flex;align-items:center;gap:8px;">
                                                        <div style="width:16px;height:16px;background:${cat.color};border-radius:3px;"></div>
                                                        <span style="font-size:18px;">${cat.icon}</span>
                                                        <span style="font-size:13px;font-weight:600;">${cat.name}</span>
                                                    </div>
                                                    <div>
                                                        <div style="font-size:15px;font-weight:700;">${DATA.currencySymbol}${cat.planned.toLocaleString()}</div>
                                                        <div style="font-size:11px;color:#666;">${plannedPercent.toFixed(1)}% of planned</div>
                                                    </div>
                                                    <div style="${!hasActual ? 'opacity:0.4;' : ''}">
                                                        <div style="font-size:15px;font-weight:700;">${DATA.currencySymbol}${cat.actual.toLocaleString()}</div>
                                                        <div style="font-size:11px;color:#666;">${hasActual ? actualPercent.toFixed(1) + '% of actual' : 'Pending'}</div>
                                                    </div>
                                                </div>
                                            `;
                                        });
                                        html += '</div>';
                                        
                                        return html;
                                    })()}
                                </div>
                            `}
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'receipts' ? `
                            <div style="background:white;border:3px solid #000;border-radius:12px;padding:24px;">
                                <div class="empty-state">
                                    <div style="font-size:64px;margin-bottom:20px;opacity:0.5;"></div>
                                    <h3 style="font-size:20px;margin-bottom:10px;">Receipt Tracking</h3>
                                    <p style="color:#666;">Upload receipts in the itinerary to track expenses</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'timeline' ? `
                            <!-- TRIP TIMELINE - Completely Redesigned -->
                            <div style="background:white;border:3px solid #000;border-radius:12px;padding:24px;">
                                <h4 style="margin:0 0 24px 0;font-size:16px;color:#000;">Trip Timeline Overview</h4>
                                
                                ${(() => {
                                    if (DATA.days.length === 0) {
                                        return '<div class="empty-state"><div style="font-size:64px;margin-bottom:20px;opacity:0.5;"></div><h3 style="font-size:20px;margin-bottom:10px;">No Days Added</h3><p style="color:#666;">Add trip days to see your timeline</p></div>';
                                    }
                                    
                                    let html = `
                                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:32px;">
                                            <div style="padding:20px;background:#fafafa;border-radius:8px;text-align:center;">
                                                <div style="font-size:12px;color:#0369a1;margin-bottom:8px;">TRIP LENGTH</div>
                                                <div style="font-size:32px;font-weight:700;color:#000;">${DATA.days.length}</div>
                                                <div style="font-size:11px;color:#666;">days</div>
                                            </div>
                                            <div style="padding:20px;background:#fafafa;border-radius:8px;text-align:center;">
                                                <div style="font-size:12px;color:#15803d;margin-bottom:8px;">COMPLETED</div>
                                                <div style="font-size:32px;font-weight:700;color:#000;">${DATA.days.filter(d => d.done).length}</div>
                                                <div style="font-size:11px;color:#666;">days</div>
                                            </div>
                                            <div style="padding:20px;background:#fafafa;border-radius:8px;text-align:center;">
                                                <div style="font-size:12px;color:#92400e;margin-bottom:8px;">REMAINING</div>
                                                <div style="font-size:32px;font-weight:700;color:#000;">${DATA.days.filter(d => !d.done).length}</div>
                                                <div style="font-size:11px;color:#666;">days</div>
                                            </div>
                                        </div>
                                        
                                        <div style="position:relative;padding-left:32px;">
                                    `;
                                    
                                    DATA.days.forEach((day, idx) => {
                                        const isLast = idx === DATA.days.length - 1;
                                        const cost = day.done ? calcA(day) : calc(day);
                                        
                                        html += `
                                            <div style="position:relative;padding-bottom:${isLast ? '0' : '24px'};">
                                                ${!isLast ? `<div style="position:absolute;left:-20px;top:24px;bottom:0;width:2px;background:#e5e7eb;"></div>` : ''}
                                                <div style="position:absolute;left:-26px;top:0;width:12px;height:12px;border-radius:50%;background:${day.done ? '#10b981' : '#e5e7eb'};border:3px solid white;box-shadow:0 0 0 2px #e5e7eb;"></div>
                                                
                                                <div style="background:${day.done ? '#f0fdf4' : '#f9fafb'};border:3px solid ${day.done ? '#10b981' : '#e5e7eb'};border-radius:8px;padding:16px;">
                                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                                        <div>
                                                            <div style="font-size:15px;font-weight:700;">Day ${day.d}: ${day.loc}</div>
                                                            <div style="font-size:12px;color:#666;">${day.dt}</div>
                                                        </div>
                                                        <div style="text-align:right;">
                                                            <div style="font-size:15px;font-weight:700;">${DATA.currencySymbol}${cost.toLocaleString()}</div>
                                                            ${day.done ? `<div style="font-size:11px;color:#16a34a;">Completed</div>` : `<div style="font-size:11px;color:#666;">Planned</div>`}
                                                        </div>
                                                    </div>
                                                    ${day.note ? `<div style="font-size:12px;color:#666;margin-top:8px;padding-top:8px;border-top:1px solid #e5e7eb;">${day.note.substring(0, 100)}${day.note.length > 100 ? '...' : ''}</div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    });
                                    
                                    html += '</div>';
                                    return html;
                                })()}
                            </div>
                        ` : ''}
                        
                        ${DATA.showAnalyticsPage === 'map' ? `
                            <!-- Map Content -->
                            <div style="padding:20px;">
                                ${!DATA.showMap ? `
                                    <div class="empty-state">
                                        <div style="font-size:48px;margin-bottom:15px;"></div>
                                        <h3>Map not enabled</h3>
                                        <p>Enable the map feature in the Planning tab to see your route</p>
                                    </div>
                                ` : `
                                    <div style="text-align:center;color:#666;">
                                        <p>The map feature is already available in the Planning tab.</p>
                                        <button class="btn" onclick="DATA.showAnalyticsPage=null;DATA.activeTab='planning';renderWithoutFlash()" style="margin-top:15px;padding:12px 24px;">
                                            Go to Map
                                        </button>
                                    </div>
                                `}
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }
                   
            // Day Section Full Page
            if (DATA.days.some(d => d.showDaySection)) {
                const activeDayIndex = DATA.days.findIndex(d => d.showDaySection);
                const activeDay = DATA.days[activeDayIndex];
                const section = activeDay.showDaySection;
                
                h += `<div class="settings-overlay" onclick="DATA.days[${activeDayIndex}].showDaySection=null;renderWithoutFlash()"></div>
                <div class="day-section-page">
                    <div class="day-section-header">
                        <button class="back-button" onclick="DATA.days[${activeDayIndex}].showDaySection=null;renderWithoutFlash()">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:20px;">
                            Day ${activeDay.d}: ${activeDay.loc}
                        </h2>
                    </div>
                    
                    <div class="day-section-content">
                        ${section === 'photos' ? `
                            <!-- Photos & Journal -->
                            <div style="padding:20px;">
                                <h3 style="font-size:20px;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                                     Photos & Journal
                                </h3>
                                
                                <div class="photo-upload" style="margin-bottom:20px;">
                                    <input type="file" accept="image/*" onchange="handlePhotoUpload(${activeDayIndex}, event)" id="photo-modal-${activeDayIndex}" style="display:none">
                                    <button class="btn" onclick="event.stopPropagation();document.getElementById('photo-modal-${activeDayIndex}').click()" style="padding:12px 24px;font-size:15px;">
                                         Add Photo
                                    </button>
                                </div>
                                
                                ${activeDay.photos && activeDay.photos.length > 0 ? `
                                    <div class="photo-gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-bottom:30px;">
                                        ${activeDay.photos.map((photo, pIdx) => `
                                            <div class="photo-item" onclick="event.stopPropagation();openPhotoModal('${photo}')" style="aspect-ratio:1;position:relative;border-radius:8px;overflow:hidden;cursor:pointer;">
                                                <img src="${photo}" style="width:100%;height:100%;object-fit:cover;">
                                                <button class="photo-delete" onclick="event.stopPropagation();deletePhoto(${activeDayIndex},${pIdx});renderWithoutFlash()" style="position:absolute;top:5px;right:5px;background:rgba(239,68,68,0.9);color:white;border:none;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px;"></button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div class="empty-state" style="margin:40px 0;"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No photos yet</h3><p>Add photos to remember this day</p></div>'}
                                
                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:10px;font-size:16px;">Journal Entry</label>
                                    <textarea placeholder="Write about your day..." style="width:100%;min-height:200px;padding:15px;border:3px solid #000;border-radius:8px;font-size:15px;line-height:1.6;resize:vertical;" onchange="event.stopPropagation();updateJournal(${activeDayIndex},this.value)" onblur="this.onchange()">${activeDay.journalNote || ''}</textarea>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${section === 'receipts' ? `
                            <!-- Receipts -->
                            <div style="padding:20px;">
                                <h3 style="font-size:20px;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                                     Receipts & Expenses
                                </h3>
                                
                                <div class="receipt-upload" style="margin-bottom:20px;">
                                    <input type="file" accept="image/*" onchange="handleReceiptUpload(${activeDayIndex}, event)" id="receipt-modal-${activeDayIndex}" style="display:none">
                                    <button class="btn" onclick="event.stopPropagation();document.getElementById('receipt-modal-${activeDayIndex}').click()" style="padding:12px 24px;font-size:15px;background:#10b981;color:white;">
                                         Add Receipt
                                    </button>
                                </div>
                                
                                ${activeDay.receipts && activeDay.receipts.length > 0 ? `
                                    <div class="receipt-list" style="display:flex;flex-direction:column;gap:15px;">
                                        ${activeDay.receipts.map((receipt, rIdx) => `
                                            <div class="receipt-item" style="padding:20px;background:white;border:3px solid #000;border-radius:8px;">
                                                <div style="display:grid;grid-template-columns:100px 1fr;gap:20px;">
                                                    <div class="receipt-image" onclick="event.stopPropagation();openPhotoModal('${receipt.image}')" style="width:100px;height:100px;border-radius:8px;overflow:hidden;cursor:pointer;">
                                                        <img src="${receipt.image}" style="width:100%;height:100%;object-fit:cover;">
                                                    </div>
                                                    <div class="receipt-details">
                                                        <div style="display:grid;gap:10px;margin-bottom:10px;">
                                                            <input type="number" placeholder="Amount" value="${receipt.amount || ''}" onchange="event.stopPropagation();updateReceipt(${activeDayIndex},${rIdx},'amount',this.value)" style="padding:10px;border:3px solid #000;border-radius:6px;font-size:16px;font-weight:600;">
                                                            <select onchange="event.stopPropagation();updateReceipt(${activeDayIndex},${rIdx},'category',this.value)" style="padding:10px;border:3px solid #000;border-radius:6px;font-size:14px;">
                                                                <option value="">Select category...</option>
                                                                ${DATA.categories.map(cat => 
                                                                    `<option value="${cat.id}" ${receipt.category === cat.id ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
                                                                ).join('')}
                                                            </select>
                                                        </div>
                                                        <input type="text" placeholder="Description (e.g., 'Tokyo Station Coffee')" value="${receipt.description || ''}" onchange="event.stopPropagation();updateReceipt(${activeDayIndex},${rIdx},'description',this.value)" style="width:100%;padding:10px;border:3px solid #000;border-radius:6px;margin-bottom:10px;font-size:14px;">
                                                        <div style="display:flex;gap:10px;justify-content:space-between;align-items:center;">
                                                            <input type="date" value="${receipt.date || activeDay.dt}" onchange="event.stopPropagation();updateReceipt(${activeDayIndex},${rIdx},'date',this.value)" style="padding:8px;border:3px solid #000;border-radius:6px;font-size:13px;">
                                                            <button class="btn" onclick="event.stopPropagation();deleteReceipt(${activeDayIndex},${rIdx});renderWithoutFlash()" style="padding:8px 16px;background:#000;color:white;">
                                                                 Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    
                                    <div style="margin-top:20px;padding:20px;background:#fafafa;border-radius:8px;border:3px solid #000;">
                                        <div style="display:flex;justify-content:space-between;align-items:center;">
                                            <span style="font-size:16px;font-weight:600;">Total:</span>
                                            <span style="font-size:20px;font-weight:700;color:#0d9488;">
                                                ${DATA.currencySymbol}${activeDay.receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0).toLocaleString()}
                                            </span>
                                        </div>
                                    </div>
                                ` : '<div class="empty-state" style="margin:40px 0;"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No receipts yet</h3><p>Add receipts to track your expenses</p></div>'}
                            </div>
                        ` : ''}
                        
                        ${section === 'schedule' ? `
                            <!-- Schedule -->
                            <div style="padding:20px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:10px;">
                                    <h3 style="font-size:20px;margin:0;display:flex;align-items:center;gap:10px;">
                                         Daily Schedule
                                    </h3>
                                    <div style="display:flex;gap:10px;align-items:center;">
                                        ${(activeDay.schedule && activeDay.schedule.length > 0) ? `
                                            <button class="btn-secondary" onclick="event.stopPropagation();(() => {
                                                const day = DATA.days[${activeDayIndex}];
                                                if (!day.schedule || day.schedule.length === 0) return;
                                                const sortedSchedule = day.schedule.sort((a, b) => a.time.localeCompare(b.time));
                                                let text = 'Day ${activeDay.d} - ${activeDay.loc}\\n${activeDay.dt}\\n\\nSchedule:\\n\\n';
                                                sortedSchedule.forEach(item => {
                                                    text += item.time + ' - ' + item.activity + '\\n';
                                                });
                                                copyToClipboard(text, 'Schedule copied!');
                                            })();" style="padding:8px 16px;">
                                                Copy
                                            </button>
                                        ` : ''}
                                        <div class="schedule-view-toggle" style="display:flex;gap:5px;">
                                            <button class="schedule-view-btn ${!activeDay.scheduleView || activeDay.scheduleView === 'list' ? 'active' : ''}" onclick="event.stopPropagation();DATA.days[${activeDayIndex}].scheduleView='list';renderWithoutFlash()">List</button>
                                            <button class="schedule-view-btn ${activeDay.scheduleView === 'timeline' ? 'active' : ''}" onclick="event.stopPropagation();DATA.days[${activeDayIndex}].scheduleView='timeline';renderWithoutFlash()">Timeline</button>
                                        </div>
                                    </div>
                                </div>
                                
                                ${!activeDay.scheduleView || activeDay.scheduleView === 'list' ? `
                                    <div class="schedule-grid" style="display:flex;flex-direction:column;gap:10px;">
                                        ${(activeDay.schedule || []).sort((a, b) => a.time.localeCompare(b.time)).map((item, sIdx) => `
                                            <div class="schedule-hour" style="display:flex;flex-direction:column;gap:8px;padding:12px;background:white;border:3px solid #000;border-radius:8px;">
                                                <div style="display:flex;align-items:center;gap:8px;">
                                                    <input type="text" placeholder="Activity..." value="${item.activity}" onchange="event.stopPropagation();updateSchedule(${activeDayIndex},${sIdx},'activity',this.value)" style="flex:1;padding:8px 10px;border:3px solid #000;border-radius:6px;font-size:15px;font-weight:600;">
                                                    <button class="btn" onclick="event.stopPropagation();deleteSchedule(${activeDayIndex},${sIdx});renderWithoutFlash()" style="padding:8px 12px;background:#000;color:white;flex-shrink:0;"></button>
                                                </div>
                                                <input type="time" value="${item.time}" onchange="event.stopPropagation();updateSchedule(${activeDayIndex},${sIdx},'time',this.value)" style="padding:8px 10px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px;font-weight:600;color:#6b7280;width:fit-content;">
                                            </div>
                                        `).join('')}
                                        <button class="schedule-add-btn" onclick="event.stopPropagation();addScheduleItem(${activeDayIndex})" style="padding:15px;border:2px dashed #d1d5db;background:white;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;color:#6b7280;transition:all 0.2s;" onmouseover="this.style.borderColor='#0d9488';this.style.color='#0d9488'" onmouseout="this.style.borderColor='#d1d5db';this.style.color='#6b7280'">
                                            + Add Time Slot
                                        </button>
                                    </div>
                                ` : `
                                    <div class="schedule-timeline" style="background:white;padding:20px;border-radius:8px;border:3px solid #000;max-height:none;">
                                        <div class="timeline-hours" style="display:flex;flex-direction:column;">
                                            ${(() => {
                                                const schedule = activeDay.schedule || [];
                                                const hours = [];
                                                let emptyStreak = [];
                                                
                                                for (let hour = 0; hour < 24; hour++) {
                                                    const events = schedule.filter(item => {
                                                        const itemHour = parseInt(item.time.split(':')[0]);
                                                        return itemHour === hour;
                                                    });
                                                    
                                                    if (events.length > 0) {
                                                        // If we had empty hours, render them as collapsed
                                                        if (emptyStreak.length > 0) {
                                                            const emptyStartHour = emptyStreak[0];
                                                            const emptyEndHour = emptyStreak[emptyStreak.length - 1];
                                                            
                                                            hours.push(`
                                                                <div class="timeline-empty-block" 
                                                                    style="display:grid;grid-template-columns:80px 1fr;gap:15px;border-bottom:1px solid #f0f0f0;min-height:35px;background:#fafafa;cursor:pointer;transition:background 0.2s;" 
                                                                    onmouseover="this.style.background='#f3f4f6'" 
                                                                    onmouseout="this.style.background='#fafafa'"
                                                                    onclick="event.stopPropagation();addEventInRange(${activeDayIndex}, ${emptyStartHour}, ${emptyEndHour});">
                                                                    <div style="padding:8px 0;font-size:12px;color:#9ca3af;font-weight:600;">
                                                                        ${emptyStartHour === 0 ? '12 AM' : emptyStartHour < 12 ? emptyStartHour + ' AM' : emptyStartHour === 12 ? '12 PM' : (emptyStartHour - 12) + ' PM'} - ${(emptyEndHour + 1) === 0 ? '12 AM' : (emptyEndHour + 1) < 12 ? (emptyEndHour + 1) + ' AM' : (emptyEndHour + 1) === 12 ? '12 PM' : ((emptyEndHour + 1) - 12) + ' PM'}
                                                                    </div>
                                                                    <div style="padding:8px 0;font-size:11px;color:#d1d5db;font-style:italic;display:flex;align-items:center;">
                                                                        No events (click to add)
                                                                    </div>
                                                                </div>
                                                            `);
                                                            emptyStreak = [];
                                                        }
                                                        
                                                        // Render hour with events
                                                        const hourLabel = hour === 0 ? '12 AM' : hour < 12 ? hour + ' AM' : hour === 12 ? '12 PM' : (hour - 12) + ' PM';
                                                        hours.push(`
                                                            <div class="timeline-hour-row has-events" style="display:grid;grid-template-columns:80px 1fr;gap:15px;border-bottom:1px solid #f0f0f0;min-height:60px;">
                                                                <div class="timeline-hour-label" style="padding:10px 0;font-size:13px;font-weight:600;color:#0d9488;">${hourLabel}</div>
                                                                <div class="timeline-hour-cell" onclick="event.stopPropagation();const time='${hour.toString().padStart(2,'0')}:00';if(!DATA.days[${activeDayIndex}].schedule)DATA.days[${activeDayIndex}].schedule=[];DATA.days[${activeDayIndex}].schedule.push({time:time,activity:''});saveToStorage();renderWithoutFlash();" style="padding:10px 0;cursor:pointer;position:relative;">
                                                                    ${events.map((evt, evtIdx) => {
                                                                        const scheduleIdx = activeDay.schedule.findIndex(s => s.time === evt.time && s.activity === evt.activity);
                                                                        return `
                                                                            <div class="timeline-event" 
                                                                                style="background:linear-gradient(135deg,#0d9488,#2563eb);color:white;padding:10px;border-radius:6px;margin-bottom:5px;position:relative;cursor:move;" 
                                                                                onclick="event.stopPropagation();"
                                                                                onmousedown="event.preventDefault();">
                                                                                
                                                                                <div class="event-drag-handle event-drag-top" 
                                                                                    onmousedown="startEventResize(${activeDayIndex},${scheduleIdx},'top',event)"
                                                                                    style="position:absolute;top:0;left:0;right:0;height:8px;cursor:ns-resize;background:rgba(255,255,255,0.1);border-radius:6px 6px 0 0;">
                                                                                </div>
                                                                                
                                                                                <button class="timeline-event-delete" 
                                                                                        onclick="event.stopPropagation();deleteSchedule(${activeDayIndex},${scheduleIdx});renderWithoutFlash()" 
                                                                                        style="position:absolute;top:5px;right:5px;background:rgba(239,68,68,0.9);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px;z-index:10;">
                                                                                    
                                                                                </button>
                                                                                
                                                                                <div style="padding:8px 0;">
                                                                                    <div class="timeline-event-time" 
                                                                                        style="font-size:12px;opacity:0.9;margin-bottom:4px;user-select:none;">
                                                                                        ${evt.time}
                                                                                    </div>
                                                                                    <input type="text" 
                                                                                        class="timeline-event-title" 
                                                                                        placeholder="Add activity..." 
                                                                                        value="${evt.activity}" 
                                                                                        onchange="event.stopPropagation();updateSchedule(${activeDayIndex},${scheduleIdx},'activity',this.value)" 
                                                                                        onclick="event.stopPropagation();"
                                                                                        style="background:transparent;border:none;color:white;width:100%;font-size:14px;font-weight:600;">
                                                                                </div>
                                                                                
                                                                                <div class="event-drag-handle event-drag-bottom" 
                                                                                    onmousedown="startEventResize(${activeDayIndex},${scheduleIdx},'bottom',event)"
                                                                                    style="position:absolute;bottom:0;left:0;right:0;height:8px;cursor:ns-resize;background:rgba(255,255,255,0.1);border-radius:0 0 6px 6px;">
                                                                                </div>
                                                                            </div>
                                                                        `;
                                                                    }).join('')}
                                                                </div>
                                                            </div>
                                                        `);
                                                    } else {
                                                        // Add to empty streak
                                                        emptyStreak.push(hour);
                                                    }
                                                }
                                                
                                                // Handle any remaining empty hours at the end
                                                if (emptyStreak.length > 0) {
                                                    const emptyStartHour = emptyStreak[0];
                                                    const emptyEndHour = emptyStreak[emptyStreak.length - 1];
                                                    
                                                    hours.push(`
                                                        <div class="timeline-empty-block" 
                                                            style="display:grid;grid-template-columns:80px 1fr;gap:15px;border-bottom:1px solid #f0f0f0;min-height:35px;background:#fafaba;cursor:pointer;transition:background 0.2s;" 
                                                            onmouseover="this.style.background='#f3f4f6'" 
                                                            onmouseout="this.style.background='#fafafa'"
                                                            onclick="event.stopPropagation();addEventInRange(${activeDayIndex}, ${emptyStartHour}, ${emptyEndHour});">
                                                            <div style="padding:8px 0;font-size:12px;color:#9ca3af;font-weight:600;">
                                                                ${emptyStartHour === 0 ? '12 AM' : emptyStartHour < 12 ? emptyStartHour + ' AM' : emptyStartHour === 12 ? '12 PM' : (emptyStartHour - 12) + ' PM'} - ${(emptyEndHour + 1) % 24 === 0 ? '12 AM' : (emptyEndHour + 1) < 12 ? (emptyEndHour + 1) + ' AM' : (emptyEndHour + 1) === 12 ? '12 PM' : ((emptyEndHour + 1) - 12) + ' PM'}
                                                            </div>
                                                            <div style="padding:8px 0;font-size:11px;color:#d1d5db;font-style:italic;display:flex;align-items:center;">
                                                                No events (click to add)
                                                            </div>
                                                        </div>
                                                    `);
                                                }
                                                
                                                return hours.join('');
                                            })()}
                                        </div>
                                    </div>
                                `}
                            </div>
                        ` : ''}
                        
                        ${section === 'weather' ? `
                            <!-- Weather -->
                            <div style="padding:20px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                    <h3 style="font-size:20px;margin:0;display:flex;align-items:center;gap:10px;">
                                         Weather Forecast
                                    </h3>
                                    <button class="btn" onclick="event.stopPropagation();fetchWeather(${activeDayIndex})" ${activeDay.weatherLoading ? 'disabled' : ''} style="padding:10px 20px;">
                                        ${activeDay.weatherLoading ? ' Loading...' : activeDay.weather ? ' Refresh' : ' Fetch Weather'}
                                    </button>
                                </div>
                                
                                ${activeDay.weatherLoading ? `
                                    <div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>Loading weather...</h3></div>
                                ` : activeDay.weather ? (activeDay.weather.error ? `
                                    <div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>Could not load weather</h3><p>${activeDay.weather.error}</p></div>
                                ` : `
                                    <div style="margin-bottom:15px;color:#666;font-size:14px;">
                                         ${activeDay.weather.location} on ${activeDay.dt}
                                    </div>
                                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;">
                                        <div class="weather-card" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:30px;border-radius:12px;text-align:center;">
                                            <div class="weather-icon" style="font-size:48px;margin-bottom:15px;">${activeDay.weather.icon}</div>
                                            <div class="weather-temp" style="font-size:32px;font-weight:700;margin-bottom:5px;">${activeDay.weather.tempMin} - ${activeDay.weather.temp}F</div>
                                            <div style="font-size:14px;opacity:0.9;margin-bottom:10px;">${activeDay.weather.tempMinC} - ${activeDay.weather.tempC}C</div>
                                            <div class="weather-desc" style="font-size:16px;font-weight:600;">${activeDay.weather.condition}</div>
                                        </div>
                                        <div class="weather-card" style="background:linear-gradient(135deg,#06b6d4,#0891b2);color:white;padding:30px;border-radius:12px;text-align:center;">
                                            <div style="font-size:36px;margin-bottom:15px;"></div>
                                            <div class="weather-temp" style="font-size:32px;font-weight:700;margin-bottom:10px;">${activeDay.weather.precipitation}mm</div>
                                            <div class="weather-desc" style="font-size:16px;font-weight:600;">Precipitation</div>
                                        </div>
                                        <div class="weather-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:30px;border-radius:12px;text-align:center;">
                                            <div style="font-size:36px;margin-bottom:15px;"></div>
                                            <div class="weather-temp" style="font-size:32px;font-weight:700;margin-bottom:10px;">${activeDay.weather.windSpeed}</div>
                                            <div class="weather-desc" style="font-size:16px;font-weight:600;">mph wind</div>
                                        </div>
                                    </div>
                                `) : `
                                    <div class="empty-state"><div style="font-size:48px;margin-bottom:15px;"></div><h3>No weather data</h3><p>Click "Fetch Weather" to load forecast for ${activeDay.loc.split('')[0].trim()} on ${activeDay.dt}</p></div>
                                `}
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }
           
            // Trip Manager Modal
            if (DATA.showTripManager) {
                h += `<div class="trip-manager-overlay" onclick="closeTripManager()"></div>
                <div class="trip-manager-modal">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin:-30px -30px 20px -30px;padding:20px 30px;background:linear-gradient(135deg,#0d9488 0%,#2563eb 100%);border-radius:12px 12px 0 0;">
                        <h2 style="margin:0;font-size:24px;color:white;">Trip Manager</h2>
                        <button class="btn" onclick="closeTripManager()" style="padding:6px 16px;background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.4);"> Close</button>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
                        <button class="btn-secondary" onclick="createNewTrip()" style="padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;">
                            <span style="font-size:24px;"></span>
                            <span style="font-size:12px;">New Trip</span>
                        </button>
                        <button class="btn-secondary" onclick="importTripTemplate()" style="padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;">
                            <span style="font-size:24px;"></span>
                            <span style="font-size:12px;">Import</span>
                        </button>
                        <button class="btn-secondary" onclick="exportTripAsTemplate()" style="padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;">
                            <span style="font-size:24px;"></span>
                            <span style="font-size:12px;">Export</span>
                        </button>
                    </div>
                    
                    <div class="trip-comparison-section" style="margin-bottom:30px;">
                        <h3 style="font-size:18px;margin-bottom:15px;">Trip Comparison</h3>
                        <div class="trip-comparison-table">
                            <div class="trip-comparison-header">
                                <div>Trip Name</div>
                                <div>Days</div>
                                <div>Budget</div>
                                <div>Planned</div>
                                <div>Actual</div>
                                <div>Progress</div>
                            </div>
                                ${compareTripStats().map(trip => `
                                    <div class="trip-comparison-row ${trip.id === window.CURRENT_TRIP_ID ? 'current' : ''}">
                                        <div style="font-weight:600;">${trip.name}</div>
                                        <div>${trip.completed}/${trip.days}</div>
                                        <div>
                                            <strong>${formatCurrency(trip.budgetUSD, '$')}</strong><br>
                                            <small style="color:#666;font-size:11px;">
                                                ${formatCurrency(trip.budgetLocal, trip.currency)}
                                            </small>
                                        </div>
                                        <div>
                                            <strong>${formatCurrency(trip.totalPlannedUSD, '$')}</strong><br>
                                            <small style="color:#666;font-size:11px;">
                                                ${formatCurrency(trip.totalPlannedLocal, trip.currency)}
                                            </small>
                                        </div>
                                        <div>
                                            <strong>${formatCurrency(trip.totalActualUSD, '$')}</strong><br>
                                            <small style="color:#666;font-size:11px;">
                                                ${formatCurrency(trip.totalActualLocal, trip.currency)}
                                            </small>
                                        </div>
                                        <div>
                                            <div style="width:100px;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;">
                                                <div style="width:${trip.days > 0 ? (trip.completed/trip.days*100) : 0}%;height:100%;background:#10b981;"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <h3 style="font-size:18px;margin-bottom:15px;">All Trips</h3>
                    <div class="trip-list">
                        ${Object.entries(window.ALL_TRIPS || {}).map(([id, trip]) => `
                            <div class="trip-card ${id === window.CURRENT_TRIP_ID ? 'current-trip' : ''}">
                                <div class="trip-card-header">
                                    <h4 style="margin:0;font-size:16px;">${trip.tripTitle}</h4>
                                    ${id === window.CURRENT_TRIP_ID ? '<span class="current-badge">Current</span>' : ''}
                                </div>
                                <div class="trip-card-info">
                                    <div><strong>${trip.days?.length || 0}</strong> days</div>
                                    <div><strong>${trip.currencySymbol}${((trip.budget || 0) * (trip.rate || 1)).toLocaleString()}</strong> budget</div>
                                    <div><strong>${trip.days?.filter(d => d.done).length || 0}</strong> completed</div>
                                </div>
                                <div class="trip-card-dates">
                                    ${trip.tripStartDate || 'No dates'}  ${trip.tripEndDate || 'No dates'}
                                </div>
                                <div class="trip-card-actions">
                                    ${id === window.CURRENT_TRIP_ID ? `
                                        <button class="btn-secondary" onclick="event.stopPropagation();editTripDates()" style="padding:6px 12px;">
                                             Edit Dates
                                        </button>
                                    ` : ''}
                                    ${id !== window.CURRENT_TRIP_ID ? `
                                        <button class="btn" onclick="event.stopPropagation();switchTrip('${id}')" style="padding:6px 12px;background:#0d9488;color:white;">
                                            Switch
                                        </button>
                                    ` : ''}
                                    <button class="btn" onclick="event.stopPropagation();duplicateTrip('${id}')" style="padding:6px 12px;">
                                        Duplicate
                                    </button>
                                    <button class="btn" onclick="event.stopPropagation();deleteTrip('${id}')" style="padding:6px 12px;background:#000;color:white;">
                                         Delete
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
           
            // Category Editing Modal (front-and-center)
            if (DATA.editingCategoryModal) {
                const { dayIndex, category } = DATA.editingCategoryModal;
                const day = DATA.days[dayIndex];
                const cat = DATA.categories.find(c => c.id === category);
                const catData = day[category] || { n: '', d: '', p: 0 };
                const actualValue = day.a?.[category] || 0;
                
                h += `<div class="custom-modal-overlay" onclick="closeCategoryModal()"></div>
                <div class="custom-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                    <div class="custom-modal-header">
                        <h3 style="margin:0;">${cat.icon} ${cat.name} - Day ${day.d}</h3>
                        <button onclick="closeCategoryModal()" style="background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;"></button>
                    </div>
                    <div class="custom-modal-body">
                        <div style="display:grid;gap:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Name/Description</label>
                                <div style="padding:6px 10px;background:#fafafa;border-radius:4px;margin-bottom:8px;font-size:11px;color:#1e40af;">
                                     Add links: <code>[text](url)</code> or paste URLs directly. Formatting is preserved.
                                </div>
                                <textarea onchange="update(${dayIndex}, '${category}', 'n', this.value)" onblur="this.onchange()" 
                                          style="width:100%;min-height:120px;padding:12px;border:3px solid #000;border-radius:8px;font-size:15px;resize:vertical;white-space:pre-line;font-family:inherit;line-height:1.5;" 
                                          placeholder="e.g., ARK Hotel Okayama (3n)
Bullet train ~8:30
Check-in after 3pm">${catData.n || ''}</textarea>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Planned Cost (${DATA.currencySymbol})</label>
                                    <input type="number" value="${catData.p || 0}" onchange="update(${dayIndex}, '${category}', 'p', this.value)" style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;font-weight:600;">
                                </div>
                                
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Actual Cost (${DATA.currencySymbol})</label>
                                    <input type="number" value="${actualValue}" onchange="update(${dayIndex}, 'base', 'a.${category}', this.value)" style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;font-weight:600;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="custom-modal-footer">
                        <button onclick="closeCategoryModal()" class="modal-btn modal-btn-cancel">Close</button>
                    </div>
                </div>`;
            }

            // Notes Editing Modal (front-and-center)
            if (DATA.editingNotesModal) {
                const { dayIndex } = DATA.editingNotesModal;
                const day = DATA.days[dayIndex];
                
                h += `<div class="custom-modal-overlay" onclick="closeNotesModal()"></div>
                <div class="custom-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                    <div class="custom-modal-header">
                        <h3 style="margin:0;">Notes - Day ${day.d}: ${day.loc}</h3>
                        <button onclick="closeNotesModal()" style="background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;"></button>
                    </div>
                    <div class="custom-modal-body">
                        <div style="padding:8px 12px;background:#fafafa;border-radius:6px;margin-bottom:15px;font-size:12px;color:#1e40af;">
                             <strong>Tip:</strong> Add links like this: <code>[Click here](https://example.com)</code> or paste URLs directly
                        </div>
                        <textarea placeholder="Add notes for this day..." style="width:100%;min-height:200px;padding:15px;border:3px solid #000;border-radius:8px;font-size:15px;line-height:1.6;resize:vertical;" onchange="update(${dayIndex}, 'base', 'note', this.value)" onblur="this.onchange()">${day.note || ''}</textarea>
                    </div>
                    <div class="custom-modal-footer">
                        <button onclick="closeNotesModal()" class="modal-btn modal-btn-cancel">Close</button>
                    </div>
                </div>`;
            }
          
            // Checklist Pages (Full Page Modals)
            // ============================================
            // PACKING LIST PAGE (Full Page)
            // ============================================
            if (DATA.showChecklistPage === 'packing') {
                h += `<div class="settings-overlay" onclick="closeChecklist()"></div>
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:2001;display:flex;flex-direction:column;">
                    <!-- Header -->
                    <div style="padding:20px 30px;border-bottom:3px solid #000;flex-shrink:0;display:flex;justify-content:space-between;align-items:center;">
                        <button onclick="closeChecklist()" 
                            style="padding:10px 20px;background:#000;color:white;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;">
                             Back
                        </button>
                        <h2 style="margin:0;font-size:28px;font-weight:900;color:#000;">Packing List</h2>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <button onclick="event.stopPropagation();copyToClipboard(DATA.packingList.map((item,i)=>(i+1)+'. '+(item.checked?'':' ')+item.item).join('\\n'),'Packing list copied!')" 
                                style="padding:10px 20px;background:#0d9488;color:white;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;">
                                Copy
                            </button>
                            <button onclick="closeChecklist()" 
                                style="padding:10px 16px;background:transparent;color:#000;border:3px solid #000;border-radius:6px;font-size:20px;font-weight:700;cursor:pointer;">
                                
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content Area -->
                    <div style="flex:1;overflow-y:auto;padding:30px;background:#fafafa;">
                        <div style="max-width:900px;margin:0 auto;">
                            ${DATA.packingList && DATA.packingList.length > 0 ? `
                                <!-- Compact Progress Card with Color -->
                                <div style="background:white;padding:20px 30px;border-radius:12px;margin-bottom:30px;border:3px solid #000;display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:6px;">Progress</div>
                                        <div style="font-size:40px;font-weight:900;color:#000;">
                                            ${DATA.packingList.filter(i => i.packed).length}/${DATA.packingList.length}
                                        </div>
                                    </div>
                                    <div style="width:200px;">
                                        <div style="height:12px;background:#e5e7eb;border-radius:6px;overflow:hidden;">
                                            <div style="height:100%;background:#f59e0b;width:${(DATA.packingList.filter(i => i.packed).length / DATA.packingList.length * 100)}%;transition:width 0.3s;"></div>
                                        </div>
                                        <div style="text-align:right;margin-top:6px;font-size:12px;font-weight:700;color:#000;">
                                            ${Math.round((DATA.packingList.filter(i => i.packed).length / DATA.packingList.length * 100))}% Complete
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Items List -->
                                <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:30px;">
                                    ${DATA.packingList.map((item, idx) => `
                                        <div style="display:flex;gap:12px;align-items:start;padding:16px;background:white;border:3px solid ${item.packed ? '#f59e0b' : '#e5e7eb'};border-radius:10px;transition:all 0.2s;">
                                            <input type="checkbox" 
                                                ${item.packed ? 'checked' : ''} 
                                                onchange="DATA.packingList[${idx}].packed=this.checked;saveToStorage();renderWithoutFlash()"
                                                style="width:24px;height:24px;cursor:pointer;flex-shrink:0;accent-color:#000;margin-top:8px;">
                                            <textarea 
                                                onchange="DATA.packingList[${idx}].item=this.value;saveToStorage()" onblur="this.onchange()"
                                                placeholder="Item name..."
                                                rows="${Math.max(1, Math.ceil((item.item || '').length / 40))}"
                                                style="flex:1;padding:10px 12px;border:3px solid #000;border-radius:6px;font-size:15px;font-weight:500;font-family:inherit;resize:vertical;min-height:24px;${item.packed ? 'text-decoration:line-through;opacity:0.5;' : ''}">${item.item}</textarea>
                                            <button onclick="DATA.packingList.splice(${idx},1);saveToStorage();renderWithoutFlash()"
                                                style="padding:8px 12px;background:#000;color:white;border:none;border-radius:6px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;">
                                                
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align:center;padding:80px 40px;background:white;border-radius:12px;border:3px solid #000;">
                                    <div style="font-size:100px;margin-bottom:20px;"></div>
                                    <h3 style="font-size:28px;font-weight:900;margin-bottom:12px;color:#000;">Start Packing</h3>
                                    <p style="color:#666;font-size:16px;margin-bottom:0;">Add items you need to bring on your trip</p>
                                </div>
                            `}
                            
                            <!-- Add Button -->
                            <button onclick="DATA.packingList.push({item:'',packed:false});saveToStorage();renderWithoutFlash();setTimeout(()=>{const inputs=document.querySelectorAll('input[type=text]');inputs[inputs.length-1].focus()},10)"
                                style="width:100%;padding:18px;background:#000;color:white;border:none;border-radius:10px;font-size:16px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;">
                                 Add Item
                            </button>
                        </div>
                    </div>
                </div>`;
            }
            
            // ============================================
            // BEFORE TRIP CHECKLIST PAGE (Full Page)
            // ============================================
            if (DATA.showChecklistPage === 'before') {
                h += `<div class="settings-overlay" onclick="closeChecklist()"></div>
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:2001;display:flex;flex-direction:column;overflow:hidden;">
                    <div style="padding:20px 30px;border-bottom:3px solid #000;flex-shrink:0;display:flex;justify-content:space-between;align-items:center;">
                        <button onclick="closeChecklist()" 
                            style="padding:10px 20px;background:#000;color:white;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;"> Back</button>
                        <h2 style="margin:0;font-size:28px;font-weight:900;color:#000;">Before Trip</h2>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <button onclick="event.stopPropagation();copyToClipboard(DATA.beforeChecklist.map((item,i)=>(i+1)+'. '+(item.checked?'':' ')+item.item).join('\\n'),'Before trip list copied!')" 
                                style="padding:10px 20px;background:#0d9488;color:white;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;">
                                Copy
                            </button>
                            <button onclick="closeChecklist()" 
                                style="padding:10px 16px;background:transparent;color:#000;border:3px solid #000;border-radius:6px;font-size:20px;font-weight:700;cursor:pointer;"></button>
                        </div>
                    </div>
                    <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:40px;background:#fafafa;">
                        <div style="max-width:900px;margin:0 auto;">
                            ${DATA.beforeChecklist && DATA.beforeChecklist.length > 0 ? `
                                <!-- Compact Progress Card with Color -->
                                <div style="background:white;padding:20px 30px;border-radius:12px;margin-bottom:30px;border:3px solid #000;display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:6px;">Progress</div>
                                        <div style="font-size:40px;font-weight:900;color:#000;">
                                            ${DATA.beforeChecklist.filter(i => i.checked).length}/${DATA.beforeChecklist.length}
                                        </div>
                                    </div>
                                    <div style="width:200px;">
                                        <div style="height:12px;background:#e5e7eb;border-radius:6px;overflow:hidden;">
                                            <div style="height:100%;background:#10b981;width:${(DATA.beforeChecklist.filter(i => i.checked).length / DATA.beforeChecklist.length * 100)}%;transition:width 0.3s;"></div>
                                        </div>
                                        <div style="text-align:right;margin-top:6px;font-size:12px;font-weight:700;color:#000;">
                                            ${Math.round((DATA.beforeChecklist.filter(i => i.checked).length / DATA.beforeChecklist.length * 100))}% Complete
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:30px;">
                                    ${DATA.beforeChecklist.map((item, idx) => `
                                        <div style="display:flex;gap:12px;align-items:start;padding:16px;background:white;border:3px solid ${item.checked ? '#10b981' : '#e5e7eb'};border-radius:10px;">
                                            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="DATA.beforeChecklist[${idx}].checked=this.checked;saveToStorage();renderWithoutFlash()" style="width:24px;height:24px;cursor:pointer;flex-shrink:0;accent-color:#000;margin-top:8px;">
                                            <textarea onchange="DATA.beforeChecklist[${idx}].item=this.value;saveToStorage()" onblur="this.onchange()" placeholder="Task..." rows="${Math.max(1, Math.ceil((item.item || '').length / 40))}" style="flex:1;padding:10px 12px;border:3px solid #000;border-radius:6px;font-size:15px;font-weight:500;font-family:inherit;resize:vertical;min-height:24px;${item.checked ? 'text-decoration:line-through;opacity:0.5;' : ''}">${item.item}</textarea>
                                            <button onclick="DATA.beforeChecklist.splice(${idx},1);saveToStorage();renderWithoutFlash()" style="padding:8px 12px;background:#000;color:white;border:none;border-radius:6px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;"></button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align:center;padding:100px 40px;background:white;border-radius:12px;border:3px solid #000;">
                                    <div style="font-size:120px;margin-bottom:30px;"></div>
                                    <h3 style="font-size:32px;font-weight:900;margin-bottom:15px;color:#000;">Plan Ahead</h3>
                                    <p style="color:#666;font-size:18px;">Add tasks to complete before you leave</p>
                                </div>
                            `}
                            <button onclick="DATA.beforeChecklist.push({item:'',checked:false});saveToStorage();renderWithoutFlash();setTimeout(()=>{const inputs=document.querySelectorAll('input[type=text]');inputs[inputs.length-1].focus()},10)" style="width:100%;padding:22px;background:#000;color:white;border:none;border-radius:10px;font-size:18px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;"> Add Task</button>
                        </div>
                    </div>
                </div>`;
            }

            // ============================================
            // ON TRIP CHECKLIST PAGE (Full Page)
            // ============================================
            if (DATA.showChecklistPage === 'trip') {
                h += `<div class="settings-overlay" onclick="closeChecklist()"></div>
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:2001;display:flex;flex-direction:column;overflow:hidden;">
                    <div style="padding:20px 30px;border-bottom:3px solid #000;flex-shrink:0;display:flex;justify-content:space-between;align-items:center;">
                        <button onclick="closeChecklist()" style="padding:10px 20px;background:#000;color:white;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;"> Back</button>
                        <h2 style="margin:0;font-size:28px;font-weight:900;color:#000;">On Trip</h2>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <button onclick="event.stopPropagation();copyToClipboard(DATA.tripChecklist.map((item,i)=>(i+1)+'. '+(item.checked?'':' ')+item.item).join('\\n'),'On trip list copied!')" 
                                style="padding:10px 20px;background:#0d9488;color:white;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;">
                                Copy
                            </button>
                            <button onclick="closeChecklist()" style="padding:10px 16px;background:transparent;color:#000;border:3px solid #000;border-radius:6px;font-size:20px;font-weight:700;cursor:pointer;"></button>
                        </div>
                    </div>
                    <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:40px;background:#fafafa;">
                        <div style="max-width:900px;margin:0 auto;">
                            ${DATA.tripChecklist && DATA.tripChecklist.length > 0 ? `
                                <div style="background:white;padding:20px 30px;border-radius:12px;margin-bottom:30px;border:3px solid #000;display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:6px;">Progress</div>
                                        <div style="font-size:40px;font-weight:900;color:#0d9488;">${DATA.tripChecklist.filter(i => i.checked).length}/${DATA.tripChecklist.length}</div>
                                    </div>
                                    <div style="width:200px;">
                                        <div style="height:12px;background:#e5e7eb;border-radius:6px;overflow:hidden;">
                                            <div style="height:100%;background:#0d9488;width:${(DATA.tripChecklist.filter(i => i.checked).length / DATA.tripChecklist.length * 100)}%;transition:width 0.3s;"></div>
                                        </div>
                                        <div style="text-align:right;margin-top:6px;font-size:12px;font-weight:700;color:#0d9488;">
                                            ${Math.round((DATA.tripChecklist.filter(i => i.checked).length / DATA.tripChecklist.length * 100))}% Complete
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:30px;">
                                    ${DATA.tripChecklist.map((item, idx) => `
                                        <div style="display:flex;gap:12px;align-items:start;padding:16px;background:white;border:3px solid ${item.checked ? '#0d9488' : '#e5e7eb'};border-radius:10px;">
                                            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="DATA.tripChecklist[${idx}].checked=this.checked;saveToStorage();renderWithoutFlash()" style="width:24px;height:24px;cursor:pointer;flex-shrink:0;accent-color:#0d9488;margin-top:8px;">
                                            <textarea onchange="DATA.tripChecklist[${idx}].item=this.value;saveToStorage()" onblur="this.onchange()" placeholder="Daily reminder..." rows="${Math.max(1, Math.ceil((item.item || '').length / 40))}" style="flex:1;padding:10px 12px;border:3px solid #000;border-radius:6px;font-size:15px;font-weight:500;font-family:inherit;resize:vertical;min-height:24px;${item.checked ? 'text-decoration:line-through;opacity:0.5;' : ''}">${item.item}</textarea>
                                            <button onclick="DATA.tripChecklist.splice(${idx},1);saveToStorage();renderWithoutFlash()" style="padding:8px 12px;background:#000;color:white;border:none;border-radius:6px;cursor:pointer;font-size:18px;font-weight:700;flex-shrink:0;"></button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align:center;padding:100px 40px;background:white;border-radius:12px;border:3px solid #000;">
                                    <div style="font-size:120px;margin-bottom:30px;"></div>
                                    <h3 style="font-size:32px;font-weight:900;margin-bottom:15px;color:#000;">Daily Reminders</h3>
                                    <p style="color:#666;font-size:18px;">Add tasks to do each day while traveling</p>
                                </div>
                            `}
                            <button onclick="DATA.tripChecklist.push({item:'',checked:false});saveToStorage();renderWithoutFlash();setTimeout(()=>{const inputs=document.querySelectorAll('input[type=text]');inputs[inputs.length-1].focus()},10)" style="width:100%;padding:22px;background:#000;color:white;border:none;border-radius:10px;font-size:18px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;"> Add Reminder</button>
                        </div>
                    </div>
                </div>`;
            }

            
            // ============================================
            // HOME TAB - Dashboard Overview
            // ============================================
            h += `<div class="tab-content ${DATA.activeTab === 'home' ? 'active' : ''}">`;
            
            // Hero Stats - Big overview cards at top
            h += `<div class="hero-stats-grid" style="display:grid;gap:20px;margin-bottom:30px;">`;
            
            // Days card
            const totalDays = DATA.days.length;
            const completedDays = DATA.days.filter(d => d.done).length;
            h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;text-align:center;">
                <div style="font-size:32px;font-weight:800;color:#000;margin-bottom:6px;">${totalDays}</div>
                <div style="font-size:12px;color:#0d9488;text-transform:uppercase;letter-spacing:0.8px;font-weight:700;">Total Days</div>
                <div style="margin-top:8px;font-size:12px;color:#666;">${completedDays} completed</div>
            </div>`;
            
            // Budget card
            h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;text-align:center;">
                <div style="font-size:32px;font-weight:800;color:#000;margin-bottom:6px;">$${(DATA.budget).toLocaleString()}</div>
                <div style="font-size:12px;color:#0d9488;text-transform:uppercase;letter-spacing:0.8px;font-weight:700;">Budget</div>
                <div style="margin-top:8px;font-size:12px;color:#666;">${s.pct.toFixed(1)}% used</div>
            </div>`;
            
            // Location count card
            const uniqueLocations = [...new Set(DATA.days.map(d => d.loc).filter(Boolean))].length;
            h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;text-align:center;">
                <div style="font-size:32px;font-weight:800;color:#000;margin-bottom:6px;">${uniqueLocations}</div>
                <div style="font-size:12px;color:#0d9488;text-transform:uppercase;letter-spacing:0.8px;font-weight:700;">Locations</div>
                <div style="margin-top:8px;font-size:12px;color:#666;">to explore</div>
            </div>`;
            
            // Trip Countdown - Add as 4th card in grid
            if (DATA.tripStartDate && DATA.tripEndDate) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tripStart = new Date(DATA.tripStartDate);
                tripStart.setHours(0, 0, 0, 0);
                const tripEnd = new Date(DATA.tripEndDate);
                tripEnd.setHours(0, 0, 0, 0);
                
                const daysUntilStart = Math.ceil((tripStart - today) / (1000 * 60 * 60 * 24));
                const daysSinceEnd = Math.ceil((today - tripEnd) / (1000 * 60 * 60 * 24));
                const isBeforeTrip = today < tripStart;
                const isAfterTrip = today > tripEnd;
                
                if (isBeforeTrip) {
                    h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;text-align:center;">
                        <div style="font-size:32px;font-weight:800;color:#000;margin-bottom:6px;">${daysUntilStart}</div>
                        <div style="font-size:12px;color:#0d9488;text-transform:uppercase;letter-spacing:0.8px;font-weight:700;">Countdown</div>
                        <div style="margin-top:8px;font-size:12px;color:#666;">days until trip!</div>
                    </div>`;
                } else if (isAfterTrip) {
                    h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;text-align:center;">
                        <div style="font-size:32px;font-weight:800;color:#000;margin-bottom:6px;"></div>
                        <div style="font-size:12px;color:#0d9488;text-transform:uppercase;letter-spacing:0.8px;font-weight:700;">Completed</div>
                        <div style="margin-top:8px;font-size:12px;color:#666;">${daysSinceEnd} days ago</div>
                    </div>`;
                }
            }
            
            h += `</div>`;
            
            
            // Checklists Summary
            const packingItems = DATA.packingList ? DATA.packingList.length : 0;
            const packingDone = DATA.packingList ? DATA.packingList.filter(i => i.checked).length : 0;
            const beforeItems = DATA.beforeChecklist ? DATA.beforeChecklist.length : 0;
            const beforeDone = DATA.beforeChecklist ? DATA.beforeChecklist.filter(i => i.checked).length : 0;
            const tripItems = DATA.tripChecklist ? DATA.tripChecklist.length : 0;
            const tripDone = DATA.tripChecklist ? DATA.tripChecklist.filter(i => i.checked).length : 0;
            
            if (packingItems > 0 || beforeItems > 0 || tripItems > 0) {
                h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;margin-bottom:20px;">
                    <h2 style="margin:0 0 16px 0;font-size:18px;font-weight:700;">Checklist Progress</h2>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                        ${packingItems > 0 ? `
                            <div style="padding:16px;background:#fafafa;border-radius:8px;border-left:4px solid #000;cursor:pointer;transition:all 0.2s;" onclick="event.stopPropagation();DATA.showChecklistPage='packing';renderWithoutFlash();" >
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                    <span style="font-weight:600;font-size:14px;">Packing</span>
                                    <span style="font-weight:700;color:#000">${packingDone}/${packingItems}</span>
                                </div>
                                <div style="width:100%;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;">
                                    <div style="width:${(packingDone/packingItems*100).toFixed(0)}%;height:100%;background:#000;transition:width 0.3s;"></div>
                                </div>
                            </div>
                        ` : ''}
                        ${beforeItems > 0 ? `
                            <div style="padding:16px;background:#fafafa;border-radius:8px;border-left:4px solid #000;cursor:pointer;transition:all 0.2s;" onclick="event.stopPropagation();DATA.showChecklistPage='before';renderWithoutFlash();" >
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                    <span style="font-weight:600;font-size:14px;">Before Trip</span>
                                    <span style="font-weight:700;color:#000">${beforeDone}/${beforeItems}</span>
                                </div>
                                <div style="width:100%;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;">
                                    <div style="width:${(beforeDone/beforeItems*100).toFixed(0)}%;height:100%;background:#000;transition:width 0.3s;"></div>
                                </div>
                            </div>
                        ` : ''}
                        ${tripItems > 0 ? `
                            <div style="padding:16px;background:#fafafa;border-radius:8px;border-left:4px solid #000;cursor:pointer;transition:all 0.2s;" onclick="event.stopPropagation();DATA.showChecklistPage='trip';renderWithoutFlash();" >
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                    <span style="font-weight:600;font-size:14px;">On Trip</span>
                                    <span style="font-weight:700;color:#000">${tripDone}/${tripItems}</span>
                                </div>
                                <div style="width:100%;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;">
                                    <div style="width:${(tripDone/tripItems*100).toFixed(0)}%;height:100%;background:#000;transition:width 0.3s;"></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }
            
            // Quick Actions
            h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;margin-bottom:20px;">
                <h2 style="margin:0 0 16px 0;font-size:18px;font-weight:700;">Quick Actions</h2>
                <div class="quick-actions-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
                    <button class="btn" onclick="addDay()"> Add New Day</button>
                    <button class="btn-secondary" onclick="DATA.activeTab='planning';renderWithoutFlash()">View Planning</button>
                    <button class="btn-secondary" onclick="switchTab('itinerary')">View Itinerary</button>
                    <button class="btn-secondary" onclick="DATA.showSettings=true;renderWithoutFlash()">Settings</button>
                </div>
            </div>`;
            
            
            // Recently Viewed Days - Shows days you've recently opened/edited
            if (DATA.days.length > 0 && DATA.recentlyViewed && DATA.recentlyViewed.length > 0) {
                const recentDays = DATA.recentlyViewed
                    .slice(0, 3)
                    .map(item => DATA.days[item.dayIndex])
                    .filter(day => day); // Filter out any undefined days
                    
                if (recentDays.length > 0) {
                h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;margin-bottom:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h2 style="margin:0;font-size:18px;font-weight:700;">Recently Viewed</h2>
                        <button class="btn-secondary" onclick="switchTab('itinerary')" style="padding:6px 12px;font-size:13px;">View All </button>
                    </div>
                    <div style="display:grid;gap:12px;">
                        ${recentDays.map((day, idx) => {
                            const dayIndex = DATA.days.indexOf(day);
                            const dayTotal = day.done ? calcA(day) : calc(day);
                            return `<div style="padding:16px;background:#fafafa;border-radius:8px;border-left:4px solid ${day.done ? '#22c55e' : '#000'};cursor:pointer;transition:all 0.2s;" 
                                        onclick="DATA.activeTab='itinerary';DATA.itineraryView='list';DATA.expanded=${dayIndex};renderWithoutFlash();"
                                        >
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-weight:700;font-size:16px;margin-bottom:4px;">Day ${day.d} - ${day.loc}</div>
                                        <div style="font-size:13px;color:#666;">${day.dt}</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-weight:700;font-size:16px;">${formatCostWithSplit(dayTotal)}</div>
                                        <div style="font-size:12px;color:#666;">$${(dayTotal/DATA.rate).toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
                }
            }
            
            
            h += `</div>`; // Close home tab
            
            // ============================================
            // PLANNING TAB
            // ============================================
            h += `<div class="tab-content ${DATA.activeTab === 'planning' ? 'active' : ''}">`;
           
            // Trip notes - BOLD BLACK DESIGN with teal accent
            h += `<div style="background:white;padding:28px;border-radius:12px;border:3px solid #000;border-left:5px solid #0d9488;margin-bottom:24px;">
                <h3 style="margin:0 0 10px 0;font-size:22px;font-weight:900;color:#0d9488;display:flex;align-items:center;gap:10px;">
                    Trip Notes
                </h3>
                <p style="font-size:14px;color:#666;margin:0 0 16px 0;font-weight:500;">General notes, tips, and reminders</p>
                <textarea id="tripNotesTextarea" placeholder="Add general trip notes here... (travel tips, important info, things to remember, etc.)" 
                    onchange="DATA.tripNotes=this.value;saveToStorage();" onblur="this.onchange()"
                    oninput="saveTripNotesHeight(this)"
                    style="width:100%;min-height:${DATA.tripNotesHeight || 140}px;padding:16px;border:3px solid #e5e7eb;border-radius:10px;font-size:15px;resize:vertical;font-weight:500;transition:border-color 0.2s;" onfocus="this.style.borderColor='#0d9488'" onblur="this.onchange();this.style.borderColor='#e5e7eb'">${DATA.tripNotes}</textarea>
            </div>`;
          
            // Budget cards - BOLD BLACK DESIGN with teal accents only
            h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px;">
                <div style="background:white;padding:24px;border-radius:12px;border:3px solid #000;border-left:5px solid #0d9488;position:relative;overflow:hidden;">
                    <div style="position:absolute;top:0;right:0;width:60px;height:60px;background:rgba(13,148,136,0.06);border-radius:0 12px 0 60px;"></div>
                    <div style="font-size:12px;color:#0d9488;margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Target Budget</div>
                    ${DATA.editBudget ? 
                        `<input type="number" class="edit-input" value="${DATA.budget}" 
                        onchange="DATA.budget=parseFloat(this.value)||5000;saveToStorage();showToast('Budget updated', 'success');renderWithoutFlash()" 
                        onblur="DATA.editBudget=false;renderWithoutFlash()" autofocus>` : 
                        `<div style="font-size:36px;font-weight:900;margin-bottom:6px;cursor:pointer;color:#0d9488;" onclick="DATA.editBudget=true;renderWithoutFlash()">$${DATA.budget.toLocaleString()}</div>`
                    }
                    <div style="font-size:13px;color:#666;font-weight:600;">${DATA.currencySymbol}${(DATA.budget * DATA.rate).toLocaleString()}</div>
                    ${DATA.travelerCount > 1 && DATA.costSplitMode === 'perPerson' ? `<div style="font-size:13px;color:#666;margin-top:4px;font-weight:600;">$${(DATA.budget/DATA.travelerCount).toFixed(0)}/person</div>` : ''}
                </div>
                <div style="background:white;padding:24px;border-radius:12px;border:3px solid #000;border-left:5px solid #000;position:relative;overflow:hidden;">
                    <div style="position:absolute;top:0;right:0;width:60px;height:60px;background:rgba(0,0,0,0.04);border-radius:0 12px 0 60px;"></div>
                    <div style="font-size:12px;color:#0d9488;margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Actually Spent</div>
                    <div style="font-size:36px;font-weight:900;margin-bottom:6px;color:#000;">$${(s.tA / DATA.rate).toFixed(2)}</div>
                    <div style="font-size:13px;color:#666;font-weight:600;">${DATA.currencySymbol}${s.tA.toLocaleString()}</div>
                </div>
                <div style="background:white;padding:24px;border-radius:12px;border:3px solid #000;border-left:5px solid ${s.rem < 0 ? '#000' : '#0d9488'};position:relative;overflow:hidden;">
                    <div style="position:absolute;top:0;right:0;width:60px;height:60px;background:rgba(13,148,136,0.06);border-radius:0 12px 0 60px;"></div>
                    <div style="font-size:12px;color:#0d9488;margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">${s.rem < 0 ? 'Over Budget' : 'Remaining'}</div>
                    <div style="font-size:36px;font-weight:900;margin-bottom:6px;color:${s.rem < 0 ? '#000' : '#0d9488'};">$${(s.rem / DATA.rate).toFixed(2)}</div>
                    <div style="font-size:13px;color:#666;font-weight:600;">${DATA.currencySymbol}${Math.round(s.rem).toLocaleString()}</div>
                </div>
                <div style="background:white;padding:24px;border-radius:12px;border:3px solid #000;border-left:5px solid #0d9488;position:relative;overflow:hidden;">
                    <div style="position:absolute;top:0;right:0;width:60px;height:60px;background:rgba(13,148,136,0.06);border-radius:0 12px 0 60px;"></div>
                    <div style="font-size:12px;color:#0d9488;margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Days Completed</div>
                    <div style="font-size:36px;font-weight:900;margin-bottom:6px;color:#000;">${s.done}/${DATA.days.length}</div>
                    <div style="font-size:13px;color:#666;font-weight:600;">${((s.done/DATA.days.length)*100).toFixed(0)}% done</div>
                </div>
            </div>`;
            
            // Trip Dates Card - Editable
            h += `<div style="background:white;padding:24px;border-radius:12px;border:3px solid #000;border-left:5px solid #0d9488;margin-bottom:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 style="margin:0;font-size:18px;font-weight:700;color:#0d9488;">Trip Dates</h3>
                    <button class="btn-secondary" onclick="editTripDates()" style="padding:8px 16px;font-size:14px;">Edit Dates</button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
                    <div style="padding:16px;background:#f0fdfa;border-radius:8px;border:2px solid #99f6e4;">
                        <div style="font-size:11px;color:#0d9488;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Start Date</div>
                        <div style="font-size:20px;font-weight:800;color:#000;">${DATA.tripStartDate ? new Date(DATA.tripStartDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'Not set'}</div>
                    </div>
                    <div style="padding:16px;background:#f0fdfa;border-radius:8px;border:2px solid #99f6e4;">
                        <div style="font-size:11px;color:#0d9488;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">End Date</div>
                        <div style="font-size:20px;font-weight:800;color:#000;">${DATA.tripEndDate ? new Date(DATA.tripEndDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'Not set'}</div>
                    </div>
                    <div style="padding:16px;background:#f0fdfa;border-radius:8px;border:2px solid #0d9488;">
                        <div style="font-size:11px;color:#0d9488;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Duration</div>
                        <div style="font-size:20px;font-weight:800;color:#0d9488;">${DATA.days.length} Days</div>
                    </div>
                </div>
            </div>`;
           
            // Estimated costs toggle - BOLD
            h += `<div style="background:white;padding:20px 24px;border-radius:10px;border:3px solid #000;border-left:5px solid #0d9488;margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;position:relative;overflow:hidden;" onclick="DATA.showEst=!DATA.showEst;renderWithoutFlash()">
                <div style="position:absolute;top:0;right:0;width:60px;height:60px;background:rgba(13,148,136,0.04);border-radius:0 10px 0 60px;"></div>
                <span style="font-weight:800;color:#000;font-size:16px;position:relative;">Show Estimated Costs</span>
                <div class="toggle-switch ${DATA.showEst?'on':''}" style="position:relative;">
                    <div class="toggle-slider"></div>
                </div>
            </div>`;
            if(DATA.showEst) {
                h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px;">
                    <div style="background:white;padding:24px;border-radius:12px;border:3px solid #000;">
                        <div style="font-size:12px;color:#666;margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Estimated Total</div>
                        <div style="font-size:36px;font-weight:900;margin-bottom:6px;color:#000;">$${(s.tP/DATA.rate).toFixed(2)}</div>
                        <div style="font-size:13px;color:#666;font-weight:600;">${DATA.currencySymbol}${s.tP.toLocaleString()}</div>
                    </div>
                    <div style="background:white;padding:24px;border-radius:12px;border:3px solid #000;">
                        <div style="font-size:13px;color:#666;margin-bottom:8px;font-weight:600;">Estimated Remaining</div>
                        <div style="font-size:28px;font-weight:700;margin-bottom:4px;color:#000;">${s.over?'-':''}$${Math.abs(s.estRem/DATA.rate).toFixed(2)}</div>
                        <div style="font-size:12px;color:#999;">${s.over?'-':''}${DATA.currencySymbol}${Math.abs(s.estRem).toLocaleString()}</div>
                    </div>
                    <div style="background:white;padding:20px;border-radius:12px;border-left:4px solid ${s.over?'#ef4444':'#22c55e'};">
                        <div style="font-size:13px;color:#666;margin-bottom:8px;font-weight:600;">Budget Status</div>
                        <div style="font-size:28px;font-weight:700;margin-bottom:4px;color:#000;">${s.estPct.toFixed(1)}%</div>
                        <div style="font-size:12px;color:${s.over?'#ef4444':'#22c55e'};">${s.over?' Over Budget':'Within Budget'}</div>
                    </div>
                </div>`;
            }
            
            // Preparation Cards - Side by Side - BOLD BLACK STYLE
            h += `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:24px;">
                <!-- Packing List Card -->
                <button class="analytics-card prep-card" onclick="DATA.showChecklistPage='packing';renderWithoutFlash()" style="padding:24px 20px;text-align:left;border:3px solid #000;border-left:5px solid #0d9488;background:white;border-radius:12px;min-height:180px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;">
                    <div style="position:absolute;top:0;right:0;width:50px;height:50px;background:rgba(13,148,136,0.06);border-radius:0 12px 0 50px;"></div>
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;position:relative;">
                        <span style="font-size:17px;font-weight:900;line-height:1.2;color:#000;">Packing List</span>
                    </div>
                    <div class="analytics-card-desc" style="margin-bottom:16px;font-size:13px;color:#666;font-weight:600;position:relative;">What to bring</div>
                    ${DATA.packingList && DATA.packingList.length > 0 ? `
                        <div style="padding:12px;background:#fafafa;border-radius:8px;margin-top:auto;border:3px solid #000;position:relative;">
                            <div style="font-size:12px;color:#666;margin-bottom:6px;text-align:center;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Progress</div>
                            <div class="packing-card-progress" style="font-size:20px;font-weight:900;color:#000;text-align:center;">
                                ${DATA.packingList.filter(i => i.packed).length}/${DATA.packingList.length}
                            </div>
                        </div>
                    ` : `
                        <div style="font-size:14px;color:#999;font-weight:600;margin-top:auto;text-align:center;">No items yet</div>
                    `}
                </button>
                
                <!-- Before Trip Checklist Card -->
                <button class="analytics-card prep-card" onclick="DATA.showChecklistPage='before';renderWithoutFlash()" style="padding:24px 20px;text-align:left;border:3px solid #000;border-left:5px solid #0d9488;background:white;border-radius:12px;min-height:180px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;">
                    <div style="position:absolute;top:0;right:0;width:50px;height:50px;background:rgba(13,148,136,0.06);border-radius:0 12px 0 50px;"></div>
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;position:relative;">
                        <span style="font-size:17px;font-weight:900;line-height:1.2;color:#000;">Before Trip</span>
                    </div>
                    <div class="analytics-card-desc" style="margin-bottom:16px;font-size:13px;color:#666;font-weight:600;position:relative;">Preparation tasks</div>
                    ${DATA.beforeChecklist && DATA.beforeChecklist.length > 0 ? `
                        <div style="padding:12px;background:#fafafa;border-radius:8px;margin-top:auto;border:3px solid #000;position:relative;">
                            <div style="font-size:12px;color:#666;margin-bottom:6px;text-align:center;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Progress</div>
                            <div class="before-card-progress" style="font-size:20px;font-weight:900;color:#000;text-align:center;">
                                ${DATA.beforeChecklist.filter(i => i.checked).length}/${DATA.beforeChecklist.length}
                            </div>
                        </div>
                    ` : `
                        <div style="font-size:14px;color:#999;font-weight:600;margin-top:auto;text-align:center;">No items yet</div>
                    `}
                </button>
            </div>`;
          

            // Analytics & Tools Cards
            h += `<div class="analytics-cards-section">
                <h3 style="font-size:20px;margin-bottom:20px;color:#000;font-weight:700;">Analytics & Tools</h3>
                
                <div class="analytics-cards-grid">
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='trends';renderWithoutFlash()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Spending Trends</div>
                        <div class="analytics-card-desc">Daily, cumulative & category trends</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                    
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='receipts';renderWithoutFlash()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Receipt Analytics</div>
                        <div class="analytics-card-desc">Track receipts & expenses</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                    
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='comparison';renderWithoutFlash()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Budget vs Actual</div>
                        <div class="analytics-card-desc">Comparison & breakdown analysis</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                    
                    <button class="analytics-card" onclick="DATA.showAnalyticsPage='timeline';renderWithoutFlash()">
                        <div class="analytics-card-icon"></div>
                        <div class="analytics-card-title">Trip Timeline</div>
                        <div class="analytics-card-desc">Visual trip progression</div>
                        <div class="analytics-card-arrow"></div>
                    </button>
                </div>
            </div>`; 
           

            h += `</div>`;  
            // Before trip checklist
            // On trip checklist
            
            // [PUT ALL YOUR PLANNING CONTENT HERE - everything except search bar, progress bar, daily budget, show estimated toggle, and day cards]
            
            h += `</div>`; // Close planning tab
            

            // ============================================
            // ITINERARY TAB
            // ============================================

            h += `<div class="tab-content ${DATA.activeTab === 'itinerary' ? 'active' : ''}">`;

            //  VIEW TOGGLE:
            h += `<div class="days-container">`; // Start wrapper HERE to include everything
            
            h += `<div style="display:flex;gap:10px;margin-bottom:${DATA.itineraryView === 'calendar' ? '15px' : '30px'};background:white;padding:15px;border-radius:8px;border:1px solid #e0e0e0;">
                <button class="${DATA.itineraryView === 'calendar' ? 'btn' : 'btn-secondary'}" 
                        onclick="DATA.itineraryView='calendar';saveToStorage();renderWithoutFlash();" 
                        style="flex:1;padding:12px;display:flex;align-items:center;justify-content:center;gap:8px;">
                    <span style="font-size:20px;"></span>
                    <span>Calendar View</span>
                </button>
                <button class="${DATA.itineraryView === 'list' ? 'btn' : 'btn-secondary'}" 
                        onclick="DATA.itineraryView='list';saveToStorage();renderWithoutFlash();" 
                        style="flex:1;padding:12px;display:flex;align-items:center;justify-content:center;gap:8px;">
                    <span style="font-size:20px;"></span>
                    <span>List View</span>
                </button>
            </div>`;

            // Search bar - only in list view
            if (DATA.itineraryView === 'list') {
            h += `<div class="search-bar" style="position:relative;margin-bottom:15px;">
                <input type="text" class="search-input" id="searchInput" placeholder=" Search by location, date, activity, notes..." value="${DATA.searchQuery || ''}" style="padding-right:60px;">
                <div style="position:absolute;top:50%;right:15px;transform:translateY(-50%);font-size:16px;color:#666;cursor:pointer;user-select:none;padding:4px 8px;background:#f5f5f5;border-radius:4px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;" 
                     onmouseover="this.style.background='#e5e5e5';this.style.color='#333'" 
                     onmouseout="this.style.background='#f5f5f5';this.style.color='#666'"
                     onclick="DATA.searchMode=DATA.searchMode==='enter'?'auto':'enter';renderWithoutFlash()" 
                     title="${DATA.searchMode === 'enter' ? 'Press Enter to search' : 'Auto-search (400ms)'}">
                    ${DATA.searchMode === 'enter' ? '' : ''}
                </div>
                ${DATA.showSearchResults ? `
                    <div class="search-dropdown show" style="display:block !important;">
                        ${DATA.searchResults && DATA.searchResults.length > 0 ? 
                            DATA.searchResults.map(result => `
                                <div class="search-result-item" onclick="jumpToDay(${result.dayIndex})">
                                    <div class="search-result-day">Day ${result.day.d} - ${result.day.dt}</div>
                                    <div class="search-result-location">${result.day.loc}</div>
                                    ${result.matches && result.matches.map(match => `
                                        <div class="search-result-match">
                                            <strong>${match.field}:</strong> ${highlightText(match.value, DATA.searchQuery || '')}
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('') 
                            : '<div class="search-no-results">No results found for "' + (DATA.searchQuery || '') + '"</div>'
                        }
                    </div>
                ` : ''}
            </div>`;
            } // Close search bar list view condition

            // On Trip Checklist and Day Jump - Side by side in list view
            if (DATA.itineraryView === 'list') {
                h += `<div style="display:grid;gap:20px;margin-bottom:20px;" class="checklist-quickjump-grid">
                
                <!-- On Trip Checklist Card -->
                <button class="analytics-card checklist-qj-card" onclick="DATA.showChecklistPage='trip';renderWithoutFlash()" 
                    style="padding:16px;text-align:left;border:3px solid #000;display:flex;flex-direction:column;gap:8px;width:100%;box-sizing:border-box;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;width:100%;">
                        <div>
                            <div class="analytics-card-title" style="font-size:16px;margin-bottom:2px;font-weight:700;">On Trip Checklist</div>
                            <div class="analytics-card-desc" style="font-size:12px;color:#666;">Daily reminders</div>
                        </div>
                        <div style="text-align:right;flex-shrink:0;">
                            ${DATA.tripChecklist && DATA.tripChecklist.length > 0 ? `
                                <div style="font-size:20px;font-weight:700;color:#0d9488;line-height:1;">${DATA.tripChecklist.filter(i => i.checked).length}/${DATA.tripChecklist.length}</div>
                                <div style="font-size:10px;color:#666;text-transform:uppercase;letter-spacing:0.5px;">Done</div>
                            ` : `<div style="font-size:11px;color:#999;">No items</div>`}
                        </div>
                    </div>
                </button>
                
                <!-- Quick Jump Card with Grid -->
                <div class="analytics-card checklist-qj-card" style="padding:16px;border:3px solid #000;display:flex;flex-direction:column;gap:8px;box-sizing:border-box;">
                    <div style="cursor:pointer;display:flex;justify-content:space-between;align-items:flex-start;width:100%;" onclick="DATA.showDayJumpGrid=!DATA.showDayJumpGrid;renderWithoutFlash()">
                        <div>
                            <div class="analytics-card-title" style="font-size:16px;margin-bottom:2px;font-weight:700;">Quick Jump</div>
                            <div class="analytics-card-desc" style="font-size:12px;color:#666;">Jump to any day</div>
                        </div>
                        <span style="font-size:16px;transition:transform 0.3s;flex-shrink:0;${DATA.showDayJumpGrid ? 'transform:rotate(180deg);' : ''}"></span>
                    </div>
                    
                    ${!DATA.showDayJumpGrid ? `
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="number" 
                                class="day-jump-input" 
                                id="dayJumpInput" 
                                placeholder="Day #" 
                                min="1" 
                                max="${DATA.days.length}"
                                style="flex:1;padding:8px 12px;border:3px solid #000;border-radius:6px;font-size:14px;">
                            <button class="btn" id="dayJumpGoBtn" style="padding:8px 16px;white-space:nowrap;">
                                Go
                            </button>
                        </div>
                    ` : ''}
                </div>
                
            </div>`;
            
            // Quick Jump Grid - Show BELOW the cards grid, full width
            if (DATA.showDayJumpGrid) {
                h += `<div class="day-jump-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(45px,1fr));gap:6px;max-height:200px;overflow-y:auto;padding:15px;background:white;border:3px solid #000;border-radius:8px;margin-bottom:20px;">
                    ${DATA.days.map((day, idx) => {
                        const isCompleted = day.done;
                        const isCurrent = DATA.expanded === idx;
                        return `
                            <div class="day-jump-box ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}" 
                                 title="Day ${day.d}: ${day.loc}"
                                 onclick="DATA.expanded=${idx};DATA.itineraryView='list';trackDayView(${idx});window._scrollToCard=${idx};renderWithoutFlash();"
                                 style="aspect-ratio:1;display:flex;align-items:center;justify-content:center;border:2px solid ${isCompleted ? '#22c55e' : isCurrent ? '#0d9488' : '#cbd5e1'};background:${isCompleted ? '#f0fdf4' : isCurrent ? '#f0fdfa' : 'white'};border-radius:8px;font-size:13px;font-weight:700;color:${isCompleted ? '#22c55e' : isCurrent ? '#0d9488' : '#000'};cursor:pointer;transition:all 0.2s;"
                                 onmouseover="this.style.borderColor='#0d9488';this.style.transform='scale(1.05)'"
                                 onmouseout="this.style.borderColor='${isCompleted ? '#22c55e' : isCurrent ? '#0d9488' : '#cbd5e1'}';this.style.transform='scale(1)'">
                                ${day.d}
                            </div>
                        `;
                    }).join('')}
                </div>`;
            }
            
            h += `</div>`;  // Close checklist-quickjump-grid container div
            } // Close On Trip Checklist and Day Jump

            if (DATA.itineraryView === 'list') {
            
            // Day cards in 2-column grid (1 column on mobile)
            h += `<div style="display:grid;gap:20px;margin-bottom:30px;" class="day-cards-grid">`;

            DATA.days.forEach((day, realIndex) => {
                const pT = calc(day), aT = calcA(day);
                const exp = DATA.expanded === realIndex;
                const edit = DATA.editing === realIndex;
                
                // Remove alternating backgrounds - all cards uniform
                
            h += `<div class="day-card-wrapper" style="position:relative;">
            <div class="day-card ${day.done?'done':''}" data-day="${realIndex}" data-expanded="${exp ? 'true' : 'false'}" style="position:relative;" 
                onclick="
                    const opening = DATA.expanded !== ${realIndex};
                    DATA.expanded = DATA.expanded === ${realIndex} ? null : ${realIndex};
                    if(DATA.expanded === ${realIndex}) trackDayView(${realIndex});
                    if(opening) window._scrollToCard = ${realIndex};
                    renderWithoutFlash();
                "
            >
                <div style="position:absolute;top:12px;left:12px;width:32px;height:32px;background:#0d9488;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;box-shadow:0 2px 6px rgba(13,148,136,0.4);z-index:2;pointer-events:none;">
                    ${day.d}
                </div>
                <input type="checkbox" id="day-check-${realIndex}" name="day-check-${realIndex}" class="day-check" ${day.done?'checked':''} onclick="event.stopPropagation();DATA.days[${realIndex}].done=!DATA.days[${realIndex}].done;saveToStorage();renderWithoutFlash()" style="position:absolute;top:12px;right:12px;width:18px;height:18px;cursor:pointer;z-index:2;accent-color:#0d9488;pointer-events:auto;">
                <div class="day-header">
                    <div class="day-info">
                        <div class="day-num" style="display:none;">${day.d}</div>
                        <div class="day-title">
                            ${DATA.editing === realIndex ? 
                                `<div style="display:flex;flex-direction:column;gap:8px;" onclick="event.stopPropagation();">
                                    <div style="display:flex;gap:8px;align-items:center;">
                                        <input type="number" value="${day.d}" onchange="update(${realIndex},'base','d',this.value)" onclick="event.stopPropagation();" placeholder="Day" style="width:60px;padding:6px 8px;border:3px solid #000;border-radius:4px;">
                                        <input type="text" value="${day.dt}" onchange="update(${realIndex},'base','dt',this.value)" onclick="event.stopPropagation();" placeholder="Date" style="width:100px;padding:6px 8px;border:3px solid #000;border-radius:4px;">
                                        <button class="save-edit-btn" onclick="event.stopPropagation();DATA.editing=null;renderWithoutFlash()">Save</button>
                                    </div>
                                    <input type="text" value="${day.loc}" onchange="update(${realIndex},'base','loc',this.value)" onclick="event.stopPropagation();" placeholder="Location" style="padding:8px 12px;border:3px solid #000;border-radius:4px;">
                                </div>` :
                                `<div style="display:flex;flex-direction:column;margin:0;padding:0;">
                                    <h3 style="margin:0;padding:0;line-height:1.1;">${day.loc}</h3>
                                    <div class="date" style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;margin:0;padding:0;line-height:1.2;">
                                        <span>${day.dt}  Day ${day.d}</span>
                                        ${exp ? `<span class="edit-day-link" onclick="event.stopPropagation();DATA.editing=${realIndex};renderWithoutFlash()">Edit</span>` : ''}
                                    </div>
                                </div>`
                            }
                        </div>
                    </div>
                    <div class="day-cost">
                        <div class="amount">${formatCostWithSplit(day.done?aT:pT)} ${day.done?'(actual)':'(planned)'}  $${((day.done?aT:pT)/DATA.rate).toFixed(2)}${DATA.costSplitMode === 'perPerson' && DATA.travelerCount > 1 ? ` ($${(((day.done?aT:pT)/DATA.rate)/DATA.travelerCount).toFixed(2)}/pp)` : ''}</div>
                    </div>
                </div>`;
                
                h += `</div>`; // Close day-card (header only)
                
                if(exp) {
                    // Details is a SIBLING of day-card, inside the wrapper
                    h += `<div class="details show" onclick="event.stopPropagation();">`;
                    
                    // Mobile-only edit button at top of panel
                    h += `<div class="mobile-panel-edit-row" style="display:none;justify-content:flex-end;margin-bottom:4px;">
                        <button class="edit-day-link" onclick="event.stopPropagation();DATA.editing=${realIndex};renderWithoutFlash();" style="font-size:13px;padding:4px 10px;border:1px solid #0d9488;border-radius:6px;background:white;cursor:pointer;"> Edit Day</button>
                    </div>`;
                    
                    // NO EDIT FORM HERE - editing happens in header
                    //actual spending 
                    h += `<div class="section" style="margin-top:2px;padding:6px 8px;background:#f0fdfa;border-radius:6px;border-left:3px solid #0d9488;">
                        <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:7px 10px;background:rgba(13,148,136,0.08);border-radius:6px;margin-bottom:6px;" onclick="event.stopPropagation();DATA.days[${realIndex}].showActualSpending=!DATA.days[${realIndex}].showActualSpending;renderWithoutFlash()">
                            <div>
                                <h4 style="font-size:14px;font-weight:700;margin:0;color:#0d9488;"> Track Actual Spending</h4>
                                <p style="font-size:11px;color:#0d9488;margin:4px 0 0 0;opacity:0.8;">Click to record what you actually spent</p>
                            </div>
                            <span style="font-size:20px;transition:transform 0.3s;color:#0d9488;${day.showActualSpending ? 'transform:rotate(180deg);' : ''}"></span>
                        </div>
                        ${day.showActualSpending ? `
                            <div class="grid">
                                ${DATA.categories.map(cat => {
                                    const actualValue = day.a?.[cat.id] || 0;
                                    return `<input type="number" placeholder="${cat.icon} ${DATA.currencySymbol}" value="${actualValue || ''}" onchange="event.stopPropagation();update(${realIndex},'${cat.id}','',this.value)" onclick="event.stopPropagation();" onfocus="event.stopPropagation();" style="border-left:3px solid ${cat.color};">`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>`;
    
                    

                h += `<div class="day-activities-grid">
                        <!-- Categories Grid (2x2) -->
                        <div class="category-card-grid">
                            ${DATA.categories.map(cat => {
                                const catData = day[cat.id] || {n: '', p: 0};
                                const actualSpent = day.a?.[cat.id] || 0;
                                const description = catData.n || 'No details';
                                const plannedAmount = catData.p || 0;
                                
                                return `
                                    <div class="category-card" onclick="event.stopPropagation();openCategoryModal(${realIndex}, '${cat.id}')">
                                        <div class="category-card-header">
                                            <span class="category-card-icon" style="background: ${cat.color}20; color: ${cat.color}">${cat.icon}</span>
                                            <span class="category-card-title">${cat.name}</span>
                                        </div>
                                        <div class="category-card-content" title="${description}">
                                            ${linkifyText(description)}
                                        </div>
                                        <div class="category-card-cost">
                                            <div class="planned-cost">
                                                Planned: ${DATA.currencySymbol}${plannedAmount.toLocaleString()}
                                            </div>
                                            ${actualSpent > 0 ? `
                                                <div class="actual-cost">
                                                    Actual: ${DATA.currencySymbol}${actualSpent.toLocaleString()}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="notes-card ${day.note ? '' : 'empty'}" onclick="event.stopPropagation();openNotesModal(${realIndex})">
                            <div class="category-card-header">
                                <span class="category-card-icon" style="background:#ffffff;color:#d97706;"></span>
                                <span class="category-card-title">Notes</span>
                            </div>
                            <div class="category-card-content" title="${day.note || 'Click to add notes'}">
                                ${day.note && day.note.trim()
                                    ? linkifyText(day.note)
                                    : '<span class="muted">Click to add notes</span>'}
                            </div>
                        </div>
                    </div>`;
                    
                    // Day Activities & Media Cards
                    h += `<div class="day-activities-cards">
                        <button class="day-activity-card" onclick="event.stopPropagation();DATA.days[${realIndex}].showDaySection='photos';renderWithoutFlash()">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Photos</div>
                            <div class="day-card-badge">${day.photos && day.photos.length > 0 ? day.photos.length : '0'}</div>
                        </button>
                        
                        <button class="day-activity-card" onclick="event.stopPropagation();DATA.days[${realIndex}].showDaySection='receipts';renderWithoutFlash()">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Receipts</div>
                            <div class="day-card-badge">${day.receipts && day.receipts.length > 0 ? DATA.currencySymbol + day.receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0).toLocaleString() : '0'}</div>
                        </button>
                        
                        <button class="day-activity-card" onclick="event.stopPropagation();DATA.days[${realIndex}].showDaySection='schedule';renderWithoutFlash()">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Schedule</div>
                            <div class="day-card-badge">${day.schedule && day.schedule.length > 0 ? day.schedule.length : '0'}</div>
                        </button>
                        
                        <button class="day-activity-card" onclick="event.stopPropagation();openDailyMap(${realIndex})">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Map</div>
                            <div class="day-card-badge">${(DATA.dailyMapPoints && DATA.dailyMapPoints[realIndex]) ? DATA.dailyMapPoints[realIndex].length + ' POI' + (DATA.dailyMapPoints[realIndex].length !== 1 ? 's' : '') : '0 POIs'}</div>
                        </button>
                        
                        <button class="day-activity-card" onclick="event.stopPropagation();DATA.days[${realIndex}].showDaySection='weather';renderWithoutFlash()">
                            <div class="day-card-icon"></div>
                            <div class="day-card-title">Weather</div>
                            <div class="day-card-badge">${day.weather && !day.weather.error ? day.weather.temp + 'F' : 'N/A'}</div>
                        </button>
                    </div>`;

                    h += `<div class="day-card-controls">
                        <button class="day-control-btn" onclick="event.stopPropagation();openDailyMap(${realIndex})" style="background:#10b981;color:white;">Plan Day</button>
                        <button class="day-control-btn" onclick="event.stopPropagation();insertDayAfter(${realIndex})"> Insert Day After</button>
                        <button class="day-control-btn" onclick="event.stopPropagation();duplicateDay(${realIndex})">Duplicate Day</button>
                        <button class="day-control-btn danger" onclick="event.stopPropagation();deleteDay(${realIndex})"> Delete Day</button>
                    </div>`;
                    
                    h += `</div>`; // Close details
                }
                
                h += `</div>`; // Close day-card-wrapper
            });
            
            // Close the final grid
            h += `</div>`;
            
            // If a card is expanded on mobile, add backdrop overlay
            if (DATA.expanded !== null && DATA.expanded !== undefined) {
                h += `<div id="mobile-panel-backdrop" onclick="DATA.expanded=null;renderWithoutFlash();" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:4998;pointer-events:auto;"></div>`;
                h += `<script>if(window.innerWidth<=768){var bd=document.getElementById('mobile-panel-backdrop');if(bd)bd.style.display='block';}<\/script>`;
            }
            
            h += `<div style="margin-top:20px;text-align:center;">
                <button class="header-btn" onclick="addDay()"> Add New Day</button>
            </div>`;
            
            } else if (DATA.itineraryView === 'calendar') {
                // CALENDAR VIEW - Monthly Calendar
                
                // Wrapper already opened at top of tab
                
                // Group days by month
                const daysByMonth = {};
                DATA.days.forEach((day, idx) => {
                    if (!day.dt) return;
                    const parts = day.dt.split('-');
                    let year, month, dayNum;
                    
                    // Parse date properly - handle different formats
                    if (parts[0].length === 4) {
                        // Format: YYYY-MM-DD
                        [year, month, dayNum] = parts;
                    } else {
                        // Format: M-D-YYYY or MM-DD-YYYY
                        [month, dayNum, year] = parts;
                    }
                    
                    // MONTH FIX: JavaScript months are 0-indexed
                    const monthNum = parseInt(month) - 1;
                    const dateObj = new Date(year, monthNum, dayNum);
                    
                    // Get month key in YYYY-MM format
                    const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                    const parsedDay = dateObj.getDate();
                    
                    if (!daysByMonth[monthKey]) {
                        daysByMonth[monthKey] = [];
                    }
                    daysByMonth[monthKey].push({...day, originalIndex: idx, parsedDay: parsedDay});
                });
                
                // Sort months chronologically
                const sortedMonths = Object.keys(daysByMonth).sort();
                
                // If no days exist, show message instead of calendar
                if (sortedMonths.length === 0) {
                    h += `<div style="background:white;padding:60px 20px;border-radius:12px;border:3px solid #000;margin-bottom:20px;text-align:center;">
                        <div style="font-size:48px;margin-bottom:20px;"></div>
                        <h3 style="margin:0 0 10px 0;color:#000;">No Days Added Yet</h3>
                        <p style="color:#666;margin-bottom:20px;">Start planning your trip by adding your first day!</p>
                        <button class="btn-primary" onclick="addDay();renderWithoutFlash();" style="padding:12px 24px;">
                             Add First Day
                        </button>
                    </div>`;
                } else {
                    // Current month selector
                    if (!DATA.currentCalendarMonth || !sortedMonths.includes(DATA.currentCalendarMonth)) {
                        DATA.currentCalendarMonth = sortedMonths[0];
                    }
                    
                    const currentMonthIdx = sortedMonths.indexOf(DATA.currentCalendarMonth);
                
                h += `<div style="background:white;padding:20px;border-radius:12px;border:3px solid #000;margin-bottom:20px;margin-top:0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <button class="btn-secondary" 
                            onclick="event.stopPropagation();
                                const months = ['${sortedMonths.join("','")}'];
                                const idx = months.indexOf('${DATA.currentCalendarMonth}');
                                if(idx > 0) {
                                    DATA.currentCalendarMonth = months[idx - 1];
                                    saveToStorage();
                                    renderWithoutFlash();
                                }" 
                            ${currentMonthIdx === 0 ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}
                            style="padding:8px 16px;font-size:14px;">
                             Prev
                        </button>
                        
                        <h2 title="${new Date(parseInt(DATA.currentCalendarMonth.split('-')[0]), parseInt(DATA.currentCalendarMonth.split('-')[1]) - 1, 1).toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}" style="margin:0;font-size:clamp(14px,4vw,20px);font-weight:700;color:#000;text-align:center;min-width:120px;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            ${new Date(parseInt(DATA.currentCalendarMonth.split('-')[0]), parseInt(DATA.currentCalendarMonth.split('-')[1]) - 1, 1).toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}
                        </h2>
                        
                        <button class="btn-secondary" 
                            onclick="event.stopPropagation();
                                const months = ['${sortedMonths.join("','")}'];
                                const idx = months.indexOf('${DATA.currentCalendarMonth}');
                                if(idx < months.length - 1) {
                                    DATA.currentCalendarMonth = months[idx + 1];
                                    saveToStorage();
                                    renderWithoutFlash();
                                }" 
                            ${currentMonthIdx === sortedMonths.length - 1 ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}
                            style="padding:8px 16px;font-size:14px;">
                            Next 
                        </button>
                    </div>
                    
                    <!-- Calendar Header -->
                    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:12px;font-size:11px;">
                        <div style="text-align:center;font-weight:700;color:#666;padding:8px 0;text-transform:uppercase;letter-spacing:0.5px;">Sun</div>
                        <div style="text-align:center;font-weight:700;color:#666;padding:8px 0;text-transform:uppercase;letter-spacing:0.5px;">Mon</div>
                        <div style="text-align:center;font-weight:700;color:#666;padding:8px 0;text-transform:uppercase;letter-spacing:0.5px;">Tue</div>
                        <div style="text-align:center;font-weight:700;color:#666;padding:8px 0;text-transform:uppercase;letter-spacing:0.5px;">Wed</div>
                        <div style="text-align:center;font-weight:700;color:#666;padding:8px 0;text-transform:uppercase;letter-spacing:0.5px;">Thu</div>
                        <div style="text-align:center;font-weight:700;color:#666;padding:8px 0;text-transform:uppercase;letter-spacing:0.5px;">Fri</div>
                        <div style="text-align:center;font-weight:700;color:#666;padding:8px 0;text-transform:uppercase;letter-spacing:0.5px;">Sat</div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;grid-auto-rows:110px;transition:gap 0.2s;">`;
                
                // Calculate calendar days
                const [year, month] = DATA.currentCalendarMonth.split('-');
                const firstDay = new Date(parseInt(year), parseInt(month) - 1, 1);
                const lastDay = new Date(parseInt(year), parseInt(month), 0);
                const startPadding = firstDay.getDay();
                const daysInMonth = lastDay.getDate();
                
                // Empty cells before month starts
                for (let i = 0; i < startPadding; i++) {
                    h += `<div style="background:#fafafa;border-radius:6px;min-height:90px;border:1px solid #e5e7eb;"></div>`;
                }
                
                // Actual days
                const monthDays = daysByMonth[DATA.currentCalendarMonth] || [];
                for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
                    const tripDay = monthDays.find(d => d.parsedDay === dayNum);
                    
                    if (tripDay) {
                        const dayTotal = tripDay.done ? calcA(tripDay) : calc(tripDay);
                        const borderColor = tripDay.done ? '#22c55e' : '#000';
                        const cellId = `cal-cell-${tripDay.originalIndex}`;
                        const isExpanded = DATA.expandedCalendarCell === tripDay.originalIndex;
                        
                        // Desktop: click opens modal, hover expands
                        // Mobile: first click expands, second click opens modal
                        h += `<div id="${cellId}" 
                            class="calendar-cell ${isExpanded ? 'expanded' : ''}"
                            onclick="handleCalendarCellClick(event, ${tripDay.originalIndex});"  
                            style="height:90px;border:3px solid ${borderColor};border-radius:6px;padding:8px;cursor:pointer;transition:all 0.3s;position:relative;display:flex;flex-direction:column;overflow:hidden;${isExpanded ? 'transform:scale(1.05);z-index:10;box-shadow:0 4px 12px rgba(0,0,0,0.15);' : ''}"
                            onmouseenter="handleCalendarCellHover(this, true)"
                            onmouseleave="handleCalendarCellHover(this, false)"
                            title="Day ${tripDay.d}: ${tripDay.loc}">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div style="font-weight:800;font-size:24px;color:#000;line-height:1;">D${tripDay.d}</div>
                                <div style="font-size:11px;font-weight:600;color:#999;opacity:0.7;">${dayNum}</div>
                            </div>
                            <div class="calendar-cell-location" style="font-size:10px;font-weight:600;color:#000;margin-top:6px;margin-bottom:auto;flex:1;overflow:hidden;line-height:1.2;transition:opacity 0.3s;">
                                <div title="${tripDay.loc}" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${tripDay.loc}</div>
                            </div>
                            <div class="calendar-cell-cost" style="font-size:11px;font-weight:700;color:#000;background:#f5f5f5;padding:4px 6px;border-radius:4px;display:inline-block;align-self:flex-start;transition:opacity 0.3s;">${DATA.currencySymbol}${dayTotal.toLocaleString()}</div>
                            ${tripDay.done ? `<div style="position:absolute;top:6px;right:6px;background:#000;color:white;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;"></div>` : ''}
                            ${dayNum === new Date().getDate() && parseInt(year) === new Date().getFullYear() && parseInt(month) === new Date().getMonth() + 1 ? `<div style="position:absolute;bottom:6px;right:6px;width:5px;height:5px;border-radius:50%;background:#000;"></div>` : ''}
                        </div>`;
                    } else {
                        h += `<div style="height:90px;background:#fafafa;border:1px solid #e5e7eb;border-radius:6px;padding:8px;display:flex;flex-direction:column;justify-content:center;align-items:center;">
                            <div style="font-weight:600;font-size:18px;color:#d1d5db;">${dayNum}</div>
                            ${dayNum === new Date().getDate() && parseInt(year) === new Date().getFullYear() && parseInt(month) === new Date().getMonth() + 1 ? `<div style="margin-top:6px;width:5px;height:5px;border-radius:50%;background:#000;"></div>` : ''}
                        </div>`;
                    }
                }
                
                h += `</div></div>`;
                } // End else block (has days)
                
                // Don't close days-container here - it closes at end of tab
                
                h += `<div class="calendar-add-day-btn" style="margin-top:20px;text-align:center;">
                    <button class="header-btn" onclick="addDay()"> Add New Day</button>
                </div>`;
            }

            

            // Also, make sure the day jump is only shown in list view
            // In your code where you render the day jump, wrap it with:
            if (DATA.itineraryView === 'list') {
                // Day jump code here...
            }

            // Day Detail Modal (for calendar view)
            if (DATA.showDayDetailModal !== null && DATA.showDayDetailModal !== undefined) {
                const dayIndex = DATA.showDayDetailModal;
                const day = DATA.days[dayIndex];
                if (day) {
                    const pT = calc(day);
                    const aT = calcA(day);
                    
                    h += `<div class="day-detail-modal" onclick="if(event.target===this){DATA.showDayDetailModal=null;renderWithoutFlash();}">
                        <div class="day-detail-content" onclick="event.stopPropagation();">
                            <div class="day-detail-header">
                                <div style="flex:1;">
                                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px;">
                                        ${dayIndex > 0 ? `<button onclick="event.stopPropagation();DATA.showDayDetailModal=${dayIndex - 1};renderWithoutFlash();" style="padding:6px 12px;font-size:13px;background:#f0f0f0;border:1px solid #e0e0e0;border-radius:6px;cursor:pointer;font-weight:600;color:#666;transition:all 0.2s;" onmouseover="this.style.background='#e5e5e5'" onmouseout="this.style.background='#f0f0f0'" title="Previous Day"> Prev</button>` : ''}
                                        <h2 style="margin:0;flex:1;">Day ${day.d} - ${day.loc}</h2>
                                        ${dayIndex < DATA.days.length - 1 ? `<button onclick="event.stopPropagation();DATA.showDayDetailModal=${dayIndex + 1};renderWithoutFlash();" style="padding:6px 12px;font-size:13px;background:#f0f0f0;border:1px solid #e0e0e0;border-radius:6px;cursor:pointer;font-weight:600;color:#666;transition:all 0.2s;" onmouseover="this.style.background='#e5e5e5'" onmouseout="this.style.background='#f0f0f0'" title="Next Day">Next </button>` : ''}
                                    </div>
                                    <div style="color:#666;font-size:14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                                        <span>${day.dt}</span>
                                        ${day.done ? '<span style="background:#10b981;color:white;padding:4px 10px;border-radius:4px;font-size:12px;font-weight:600;">Completed</span>' : ''}
                                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;background:#f3f4f6;padding:6px 12px;border-radius:6px;font-size:13px;">
                                            <input type="checkbox" 
                                                ${day.done ? 'checked' : ''} 
                                                onchange="event.stopPropagation();DATA.days[${dayIndex}].done=!DATA.days[${dayIndex}].done;saveToStorage();renderWithoutFlash();"
                                                style="width:18px;height:18px;cursor:pointer;">
                                            <span>Mark done</span>
                                        </label>
                                    </div>
                                </div>
                                <button class="day-detail-close" onclick="event.stopPropagation();DATA.showDayDetailModal=null;renderWithoutFlash();" title="Close"></button>
                            </div>
                            <div class="day-detail-body">`;
                    
                    // 2x2 Grid for main info cards
                    h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin-bottom:20px;">`;
                    
                    // Card 1: Day Information
                    h += `<div style="background:#f9fafb;padding:18px;border-radius:8px;border:3px solid #000;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h3 style="margin:0;font-size:16px;"> Day Info</h3>
                            <button class="btn-secondary" onclick="event.stopPropagation();DATA.editingInModal=${dayIndex};renderWithoutFlash();" style="padding:4px 10px;font-size:12px;">
                                ${DATA.editingInModal === dayIndex ? 'Done' : ' Edit'}
                            </button>
                        </div>
                        ${DATA.editingInModal === dayIndex ? `
                            <div style="display:grid;gap:8px;" onclick="event.stopPropagation();">
                                <input type="number" value="${day.d}" onchange="update(${dayIndex},'base','d',this.value)" placeholder="Day #" style="width:100%;padding:8px;border:3px solid #000;border-radius:6px;font-size:13px;">
                                <input type="text" value="${day.dt}" onchange="update(${dayIndex},'base','dt',this.value)" placeholder="Date" style="width:100%;padding:8px;border:3px solid #000;border-radius:6px;font-size:13px;">
                                <input type="text" value="${day.loc}" onchange="update(${dayIndex},'base','loc',this.value)" placeholder="Location" style="width:100%;padding:8px;border:3px solid #000;border-radius:6px;font-size:13px;">
                            </div>
                        ` : `
                            <div style="display:grid;gap:6px;font-size:13px;">
                                <div><strong>Day:</strong> ${day.d}</div>
                                <div><strong>Date:</strong> ${day.dt}</div>
                                <div><strong>Location:</strong> ${day.loc}</div>
                            </div>
                        `}
                    </div>`;
                    
                    // Card 2: Budget Summary
                    h += `<div style="background:#fafafa;padding:18px;border-radius:8px;border:3px solid #000;">
                        <h3 style="margin:0 0 12px 0;font-size:16px;">Budget</h3>
                        <div style="display:grid;grid-template-columns:${day.done ? '1fr 1fr' : '1fr'};gap:12px;">
                            <div>
                                <div style="font-size:11px;color:#666;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Planned</div>
                                <div style="font-size:20px;font-weight:700;color:#0d9488;">${formatCostWithSplit(pT)}</div>
                                <div style="font-size:12px;color:#666;">$${(pT/DATA.rate).toFixed(2)}</div>
                            </div>
                            ${day.done ? `
                                <div>
                                    <div style="font-size:11px;color:#666;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Actual</div>
                                    <div style="font-size:20px;font-weight:700;color:#000;">${formatCostWithSplit(aT)}</div>
                                    <div style="font-size:12px;color:#666;">$${(aT/DATA.rate).toFixed(2)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>`;
                    
                    // Card 3: Notes
                    h += `<div style="background:#f0fdfa;padding:18px;border-radius:8px;border:2px solid #99f6e4;cursor:pointer;" onclick="openNotesModal(${dayIndex})">
                        <h3 style="margin:0 0 12px 0;font-size:16px;color:#0d9488;">Notes</h3>
                        <div title="${day.note || ''}" style="font-size:13px;line-height:1.5;max-height:60px;overflow:hidden;text-overflow:ellipsis;white-space:pre-line;word-wrap:break-word;">
                            ${day.note || '<span style="color:#0d9488;font-style:italic;opacity:0.7;">Click to add notes...</span>'}
                        </div>
                    </div>`;
                    
                    // Card 4: Journal
                    h += `<div style="background:#fafafa;padding:18px;border-radius:8px;border:3px solid #000;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h3 style="margin:0;font-size:16px;"> Journal</h3>
                            <button class="btn-secondary" onclick="event.stopPropagation();DATA.days[${dayIndex}].showJournalInModal=!DATA.days[${dayIndex}].showJournalInModal;renderWithoutFlash();" style="padding:4px 10px;font-size:12px;">
                                ${day.showJournalInModal ? 'Hide' : 'Show'}
                            </button>
                        </div>
                        ${day.showJournalInModal ? `
                            <textarea 
                                placeholder="Write about your day..."
                                onchange="event.stopPropagation();DATA.days[${dayIndex}].journalNote=this.value;saveToStorage();" onblur="this.onchange()"
                                onclick="event.stopPropagation();"
                                style="width:100%;min-height:80px;padding:10px;border:3px solid #000;border-radius:6px;font-family:inherit;font-size:13px;line-height:1.5;resize:vertical;"
                            >${day.journalNote || ''}</textarea>
                        ` : `
                            <div title="${day.journalNote || ''}" style="font-size:13px;line-height:1.5;max-height:60px;overflow:hidden;text-overflow:ellipsis;">
                                ${day.journalNote || '<span style="color:#065f46;font-style:italic;">Click Show to write...</span>'}
                            </div>
                        `}
                    </div>`;
                    
                    h += `</div>`; // Close 2x2 grid
                    
                    // Actual spending section - collapsible
                    h += `<div style="background:#f0fdfa;padding:18px;border-radius:8px;border-left:4px solid #0d9488;margin-bottom:15px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="event.stopPropagation();DATA.days[${dayIndex}].showActualSpending=!DATA.days[${dayIndex}].showActualSpending;renderWithoutFlash()">
                            <div>
                                <h3 style="margin:0;color:#0d9488;"> Track Actual Spending</h3>
                                <p style="font-size:12px;color:#0d9488;margin:5px 0 0 0;opacity:0.8;">Record what you actually spent</p>
                            </div>
                            <span style="font-size:20px;transition:transform 0.3s;color:#0d9488;${day.showActualSpending ? 'transform:rotate(180deg);' : ''}"></span>
                        </div>
                        ${day.showActualSpending ? `
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:15px;" onclick="event.stopPropagation();">
                                ${DATA.categories.map(cat => {
                                    const actualValue = day.a?.[cat.id] || 0;
                                    return `<div>
                                        <label style="display:block;margin-bottom:5px;font-size:12px;font-weight:600;color:#0d9488;">${cat.icon} ${cat.name}</label>
                                        <input type="number" placeholder="${DATA.currencySymbol}" value="${actualValue || ''}" onchange="update(${dayIndex},'${cat.id}','',this.value)" style="width:100%;padding:8px;border:2px solid #0d9488;border-radius:6px;font-size:13px;">
                                    </div>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>`;
                    
                    // Activities Grid - Compact
                    h += `<h3 style="margin:0 0 12px 0;font-size:16px;">Activity Details</h3>`;
                    h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:15px;">`;
                    
                    DATA.categories.forEach(cat => {
                        const catData = day[cat.id];
                        const pCost = catData.p || 0;
                        const aCost = day.a?.[cat.id] || 0;
                        const displayCost = day.done ? aCost : pCost;
                        
                        h += `<div style="background:white;padding:12px;border-radius:8px;border-left:4px solid ${cat.color};cursor:pointer;transition:all 0.2s;" onclick="openCategoryModal(${dayIndex},'${cat.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="font-size:24px;margin-bottom:6px;">${cat.icon}</div>
                            <div style="font-size:11px;font-weight:700;color:#666;margin-bottom:4px;text-transform:uppercase;">${cat.name}</div>
                            <div title="${catData.n || 'Not set'}" style="font-size:12px;color:#111;margin-bottom:4px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${catData.n || 'Not set'}</div>
                            <div style="font-size:13px;font-weight:700;color:${cat.color};">${formatCostWithSplit(displayCost)}</div>
                        </div>`;
                    });
                    
                    h += `</div>`; // Close activities grid
                    
                    // Photos section - only if photos exist
                    if (day.photos && day.photos.length > 0) {
                        h += `<div style="margin-bottom:15px;">
                            <h3 style="margin:0 0 12px 0;font-size:16px;">Photos (${day.photos.length})</h3>
                            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;">
                                ${day.photos.map(photo => `
                                    <div onclick="openPhotoModal('${photo}')" style="aspect-ratio:1;border-radius:8px;overflow:hidden;cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                        <img src="${photo}" style="width:100%;height:100%;object-fit:cover;">
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }
                    
                    // Schedule section - collapsible
                    if (day.schedule && day.schedule.length > 0) {
                        h += `<div style="background:#fafafa;padding:18px;border-radius:8px;border:3px solid #000;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;margin-bottom:${day.showScheduleInModal ? '15px' : '0'};" onclick="event.stopPropagation();DATA.days[${dayIndex}].showScheduleInModal=!DATA.days[${dayIndex}].showScheduleInModal;renderWithoutFlash()">
                                <div>
                                    <h3 style="margin:0;">Daily Schedule</h3>
                                    <p style="font-size:12px;color:#1e40af;margin:5px 0 0 0;">${day.schedule.length} scheduled event${day.schedule.length > 1 ? 's' : ''}</p>
                                </div>
                                <span style="font-size:20px;transition:transform 0.3s;${day.showScheduleInModal ? 'transform:rotate(180deg);' : ''}"></span>
                            </div>
                            ${day.showScheduleInModal ? `
                                <div style="display:flex;flex-direction:column;gap:8px;">
                                    ${day.schedule.sort((a, b) => a.time.localeCompare(b.time)).map(item => `
                                        <div style="display:grid;grid-template-columns:80px 1fr;gap:12px;padding:10px;background:white;border-radius:6px;border:1px solid #bfdbfe;">
                                            <div style="font-weight:700;color:#1e40af;">${item.time}</div>
                                            <div style="color:#374151;">${item.activity}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>`;
                    }
                    
                    // Action buttons
                    h += `<div style="display:flex;gap:10px;padding-top:15px;border-top:2px solid #e5e7eb;">
                        <div style="flex:1;position:relative;">
                            <div style="display:none;flex-direction:column;gap:6px;margin-bottom:6px;position:absolute;bottom:100%;left:0;right:0;z-index:100;background:white;border:3px solid #000;border-radius:8px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                                <button class="btn-secondary" onclick="event.stopPropagation();(() => {
                                    const day = DATA.days[${dayIndex}];
                                    let text = 'Day ' + day.d + ' - ' + day.loc + '\\n' + day.dt + '\\n\\n';
                                    DATA.categories.forEach(cat => {
                                        if (day[cat.id] && day[cat.id].n) {
                                            text += cat.icon + ' ' + cat.name + ': ' + day[cat.id].n + '\\n';
                                        }
                                    });
                                    if (day.note) {
                                        text += '\\nNotes: ' + day.note;
                                    }
                                    copyToClipboard(text, 'Copied without budget!');
                                    this.parentElement.style.display = 'none';
                                })();" style="width:100%;padding:8px;font-size:13px;">
                                    Without Budget
                                </button>
                                <button class="btn-secondary" onclick="event.stopPropagation();(() => {
                                    const day = DATA.days[${dayIndex}];
                                    let text = 'Day ' + day.d + ' - ' + day.loc + '\\n' + day.dt + '\\n\\n';
                                    DATA.categories.forEach(cat => {
                                        if (day[cat.id] && day[cat.id].n) {
                                            const planned = day[cat.id].p || 0;
                                            const actual = day.a && day.a[cat.id] || 0;
                                            text += cat.icon + ' ' + cat.name + ': ' + day[cat.id].n;
                                            if (day.done) {
                                                text += ' (Planned: ${DATA.currencySymbol}' + planned.toLocaleString() + ', Actual: ${DATA.currencySymbol}' + actual.toLocaleString() + ')';
                                            } else {
                                                text += ' (${DATA.currencySymbol}' + planned.toLocaleString() + ')';
                                            }
                                            text += '\\n';
                                        }
                                    });
                                    const totalP = ${calc(day)};
                                    const totalA = ${calcA(day)};
                                    text += '\\nTotal Planned: ${DATA.currencySymbol}' + totalP.toLocaleString();
                                    if (day.done) {
                                        text += '\\nTotal Actual: ${DATA.currencySymbol}' + totalA.toLocaleString();
                                        const diff = totalA - totalP;
                                        text += '\\nDifference: ${DATA.currencySymbol}' + Math.abs(diff).toLocaleString() + (diff > 0 ? ' over' : ' under');
                                    }
                                    if (day.note) {
                                        text += '\\n\\nNotes: ' + day.note;
                                    }
                                    copyToClipboard(text, 'Copied with budget!');
                                    this.parentElement.style.display = 'none';
                                })();" style="width:100%;padding:8px;font-size:13px;">
                                    With Budget
                                </button>
                            </div>
                            <button class="btn" onclick="event.stopPropagation();this.previousElementSibling.style.display = this.previousElementSibling.style.display === 'none' ? 'flex' : 'none';" style="width:100%;">
                                Copy
                            </button>
                        </div>
                        <button class="btn" onclick="event.stopPropagation();openDailyMap(${dayIndex});" style="flex:1;background:#10b981;color:white;">
                             Plan Day
                        </button>
                        <button class="btn" onclick="event.stopPropagation();viewDayInList(${dayIndex});" style="flex:1;">
                            View in List
                        </button>
                        <button class="btn-secondary" onclick="if(confirm('Delete this day?')){DATA.days.splice(${dayIndex},1);DATA.showDayDetailModal=null;saveToStorage();renderWithoutFlash();}" style="flex:1;">
                             Delete Day
                        </button>
                    </div>`;
                    
                    h += `</div></div></div>`; // Close body, content, modal
                }
            }


            // Only show FAB if no modals are open
            const isModalOpen = !!DATA.editingCategoryModal || !!DATA.editingNotesModal || !!DATA.showModal || 
                                DATA.days.some(d => d.showDaySection) || DATA.showSettings || 
                                DATA.showExportMenu || !!DATA.showAnalyticsPage || DATA.showTripManager ||
                                !!DATA.showChecklistPage || (DATA.showDayDetailModal !== null && DATA.showDayDetailModal !== undefined);

            if (!isModalOpen) {
                h += `<button class="fab" onclick="event.preventDefault();event.stopPropagation();addDay();" ontouchend="event.preventDefault();addDay();" title="Add Day"></button>`;
                h += `<button class="scroll-to-top" id="scrollToTop" onclick="window.scrollTo({top:0,behavior:'smooth'});" title="Scroll to Top"></button>`;

            }       

            h += `</div>`; // Close days-container wrapper
            h += `</div>`; // Close itinerary tab
            
            // ============================================
            // GALLERY TAB
            // ============================================

            h += `<div class="tab-content ${DATA.activeTab === 'gallery' ? 'active' : ''}">`;

            h += `<div class="gallery-controls">
                <button class="gallery-view-btn ${!DATA.galleryView || DATA.galleryView === 'timeline' ? 'active' : ''}" onclick="DATA.galleryView='timeline';renderWithoutFlash()">
                    Timeline View
                </button>
                <button class="gallery-view-btn ${DATA.galleryView === 'grid' ? 'active' : ''}" onclick="DATA.galleryView='grid';renderWithoutFlash()">
                    Grid View
                </button>
                <button class="gallery-view-btn ${DATA.galleryView === 'map' ? 'active' : ''}" onclick="DATA.galleryView='map';renderWithoutFlash()">
                    Map View
                </button>
                <div style="margin-left:auto;display:flex;gap:8px;">
                    ${DATA.photoSelectMode ? `
                        <button class="btn-secondary" onclick="exportSelectedPhotos()" style="padding:8px 16px;">
                            Export Selected (${(DATA.selectedPhotos || []).length})
                        </button>
                        <button class="btn-secondary" onclick="DATA.photoSelectMode=false;DATA.selectedPhotos=[];renderWithoutFlash();" style="padding:8px 16px;">
                            Cancel
                        </button>
                    ` : `
                        <button class="btn-secondary" onclick="exportAllPhotos()" style="padding:8px 16px;">
                            Export All
                        </button>
                        <button class="btn-secondary" onclick="DATA.photoSelectMode=true;DATA.selectedPhotos=[];renderWithoutFlash();" style="padding:8px 16px;">
                            Select Photos
                        </button>
                    `}
                </div>
            </div>`;

            // Timeline View
            if (!DATA.galleryView || DATA.galleryView === 'timeline') {
                const daysWithPhotos = DATA.days.filter(day => day.photos && day.photos.length > 0);
                
                if (daysWithPhotos.length === 0) {
                    h += `<div style="text-align:center;padding:60px 20px;color:#999;">
                        <div style="font-size:60px;margin-bottom:20px;"></div>
                        <h3>No photos yet</h3>
                        <p>Start adding photos to your trip days to see them here!</p>
                    </div>`;
                } else {
                    h += `<div class="gallery-timeline">`;
                    daysWithPhotos.forEach(day => {
                        const photoCount = day.photos.length;
                        h += `<div class="gallery-day-section">
                            <div class="gallery-day-header">
                                <h3>Day ${day.d} - ${day.dt}</h3>
                                <div class="gallery-day-location">${day.loc}</div>
                                <div class="gallery-photo-count">${photoCount} photo${photoCount > 1 ? 's' : ''}</div>
                            </div>
                            <div class="gallery-grid">
                                ${day.photos.map((photo, photoIndex) => {
                                    const dayIndex = DATA.days.indexOf(day);
                                    const isSelected = DATA.photoSelectMode && isPhotoSelected(dayIndex, photoIndex);
                                    return `
                                    <div class="gallery-photo-item" 
                                        onclick="${DATA.photoSelectMode ? `event.stopPropagation();togglePhotoSelection(${dayIndex}, ${photoIndex})` : `openPhotoModal('${photo}')`}"
                                        style="position:relative;${isSelected ? 'border:4px solid #0d9488;box-shadow:0 0 0 2px #fff, 0 0 0 4px #0d9488;' : ''}cursor:pointer;">
                                        ${DATA.photoSelectMode ? `
                                            <div style="position:absolute;top:8px;right:8px;width:28px;height:28px;background:${isSelected ? '#0d9488' : 'rgba(255,255,255,0.9)'};border:3px solid ${isSelected ? '#fff' : '#ddd'};border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:10;">
                                                ${isSelected ? '<span style="color:white;font-weight:900;font-size:16px;"></span>' : ''}
                                            </div>
                                        ` : ''}
                                        <img src="${photo}">
                                    </div>
                                `}).join('')}
                            </div>
                        </div>`;
                    });
                    h += `</div>`;
                }
            }

            // Grid View
            if (DATA.galleryView === 'grid') {
                const allPhotos = [];
                DATA.days.forEach(day => {
                    if (day.photos && day.photos.length > 0) {
                        day.photos.forEach(photo => {
                            allPhotos.push({ photo, day });
                        });
                    }
                });
                
                if (allPhotos.length === 0) {
                    h += `<div style="text-align:center;padding:60px 20px;color:#999;">
                        <div style="font-size:60px;margin-bottom:20px;"></div>
                        <h3>No photos yet</h3>
                        <p>Start adding photos to your trip days to see them here!</p>
                    </div>`;
                } else {
                    h += `<div class="gallery-stats">
                        <div class="stat-card">
                            <div class="stat-label">Total Photos</div>
                            <div class="stat-value">${allPhotos.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Days with Photos</div>
                            <div class="stat-value">${DATA.days.filter(d => d.photos && d.photos.length > 0).length}</div>
                        </div>
                    </div>`;
                    
                    h += `<div class="gallery-grid-all">
                        ${allPhotos.map((item, idx) => {
                            const dayIndex = DATA.days.indexOf(item.day);
                            const photoIndex = item.day.photos.indexOf(item.photo);
                            const isSelected = DATA.photoSelectMode && isPhotoSelected(dayIndex, photoIndex);
                            return `
                            <div class="gallery-photo-item" 
                                onclick="${DATA.photoSelectMode ? `event.stopPropagation();togglePhotoSelection(${dayIndex}, ${photoIndex})` : `openPhotoModal('${item.photo}')`}"
                                style="position:relative;${isSelected ? 'border:4px solid #0d9488;box-shadow:0 0 0 2px #fff, 0 0 0 4px #0d9488;' : ''}cursor:pointer;">
                                ${DATA.photoSelectMode ? `
                                    <div style="position:absolute;top:8px;right:8px;width:28px;height:28px;background:${isSelected ? '#0d9488' : 'rgba(255,255,255,0.9)'};border:3px solid ${isSelected ? '#fff' : '#ddd'};border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:10;">
                                        ${isSelected ? '<span style="color:white;font-weight:900;font-size:16px;"></span>' : ''}
                                    </div>
                                ` : ''}
                                <img src="${item.photo}">
                                <div class="gallery-photo-overlay">
                                    <div class="gallery-photo-day">Day ${item.day.d}</div>
                                    <div class="gallery-photo-location">${item.day.loc}</div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>`;
                }
            }

            // Map View
            if (DATA.galleryView === 'map') {
                h += `<div style="padding:20px;text-align:center;color:#666;">
                    <p> Map view coming soon! This will show photos on a map based on their location.</p>
                    <p style="font-size:13px;margin-top:10px;">Tip: Take photos with location services enabled for automatic placement.</p>
                </div>`;
            }

            h += `</div>`; // Close gallery tab

            // ============================================
            // TODAY TAB
            // ============================================

            h += `<div class="tab-content ${DATA.activeTab === 'today' ? 'active' : ''}" style="padding:0 20px;">`;

            // Get today's date and trip status
            // Use simulated date if What If is active, otherwise use real date
            const today = DATA.whatIfDate 
                ? (() => {
                    const parts = DATA.whatIfDate.split('-');
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
                })()
                : new Date();            today.setHours(0, 0, 0, 0);
            const tripStart = new Date(DATA.tripStartDate);
            tripStart.setHours(0, 0, 0, 0);
            const tripEnd = new Date(DATA.tripEndDate);
            tripEnd.setHours(0, 0, 0, 0);

            // INDICATOR:
            if (DATA.whatIfDate) {
                const simDate = new Date(DATA.whatIfDate);
                h += `<div style="padding:15px;background:#fafafa;border:3px solid #000;border-radius:8px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-weight:600;color:#92400e;margin-bottom:4px;">
                             What If Mode Active
                        </div>
                        <div style="font-size:13px;color:#78350f;">
                            Simulating: ${simDate.toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="DATA.whatIfDate=null;saveToStorage();renderWithoutFlash();" style="padding:8px 16px;">
                        Exit What If
                    </button>
                </div>`;
            }

            const isBeforeTrip = today < tripStart;
            const isAfterTrip = today > tripEnd;
            const isDuringTrip = !isBeforeTrip && !isAfterTrip;

            // Find today's day
            const todayDay = DATA.days.find(day => {
                if (!day.dt) return false;
                
                // Parse date - handle both "M-D-YYYY" and "YYYY-MM-DD" formats
                let dayDate;
                if (day.dt.includes('-')) {
                    const parts = day.dt.split('-');
                    // Check if it's M-D-YYYY (first part is small number)
                    if (parts[0].length <= 2) {
                        // Format: M-D-YYYY or MM-DD-YYYY
                        const [month, dayNum, year] = parts.map(num => parseInt(num, 10));
                        dayDate = new Date(year, month - 1, dayNum);
                    } else {
                        // Format: YYYY-MM-DD
                        const [year, month, dayNum] = parts.map(num => parseInt(num, 10));
                        dayDate = new Date(year, month - 1, dayNum);
                    }
                }
                
                if (dayDate) {
                    dayDate.setHours(0, 0, 0, 0);
                    return dayDate.getTime() === today.getTime();
                }
                return false;
            });

            if (isBeforeTrip) {
                // BEFORE TRIP - Countdown View
                const daysUntil = Math.ceil((tripStart - today) / (1000 * 60 * 60 * 24));
                const totalPlanned = DATA.days.reduce((sum, day) => sum + calc(day), 0);
                const packedItems = DATA.packingList.filter(item => item.packed).length;
                const totalPackingItems = DATA.packingList.length;
                const beforeChecklistDone = DATA.beforeChecklist.filter((item, idx) => {
                    const checkbox = document.querySelector(`#beforeCheck${idx}`);
                    return checkbox && checkbox.checked;
                }).length;
                
                h += `
                    <div class="today-hero" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:60px 40px;border-radius:12px;text-align:center;margin-bottom:30px;">
                        <div style="font-size:64px;margin-bottom:20px;"></div>
                        <h1 style="margin:0 0 15px 0;font-size:36px;">Trip Countdown</h1>
                        <p style="font-size:20px;margin:0 0 10px 0;opacity:0.9;">Your trip starts in <strong>${daysUntil} day${daysUntil !== 1 ? 's' : ''}</strong>!</p>
                        <p style="font-size:16px;margin:0;opacity:0.8;">Departure: ${new Date(DATA.tripStartDate).toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;">
                        <div class="today-card">
                            <h3 style="margin:0 0 15px 0;font-size:18px;display:flex;align-items:center;gap:10px;">
                                <span style="font-size:28px;"></span> Pre-Trip Checklist
                            </h3>
                            ${DATA.beforeChecklist && DATA.beforeChecklist.length > 0 ? `
                                <div style="margin-bottom:15px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                        <span style="font-size:14px;color:#666;">Items</span>
                                        <span style="font-size:14px;font-weight:600;">${DATA.beforeChecklist.length} item${DATA.beforeChecklist.length !== 1 ? 's' : ''}</span>
                                    </div>
                                </div>
                                <a href="#" onclick="event.preventDefault();DATA.activeTab='planning';DATA.showChecklistPage='before';renderWithoutFlash();return false;" style="color:#0d9488;font-size:13px;">
                                    View checklist 
                                </a>
                            ` : `
                                <p style="color:#999;font-style:italic;font-size:14px;">
                                    No checklist items yet. 
                                    <a href="#" onclick="event.preventDefault();DATA.activeTab='planning';DATA.showChecklistPage='before';renderWithoutFlash();return false;" style="color:#0d9488;">
                                        Create checklist 
                                    </a>
                                </p>
                            `}
                        </div>
                        
                        <div class="today-card">
                            <h3 style="margin:0 0 15px 0;font-size:18px;display:flex;align-items:center;gap:10px;">
                                <span style="font-size:28px;"></span> Packing List Progress
                            </h3>
                            ${DATA.packingList && DATA.packingList.length > 0 ? `
                                <div style="margin-bottom:15px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                        <span style="font-size:14px;color:#666;">Packed</span>
                                        <span style="font-size:14px;font-weight:600;">${packedItems} / ${totalPackingItems}</span>
                                    </div>
                                    <div style="width:100%;height:12px;background:#f0f0f0;border-radius:6px;overflow:hidden;">
                                        <div style="width:${totalPackingItems > 0 ? (packedItems/totalPackingItems*100) : 0}%;height:100%;background:#10b981;transition:width 0.3s;"></div>
                                    </div>
                                </div>
                                <a href="#" onclick="event.preventDefault();DATA.activeTab='planning';DATA.showChecklistPage='packing';renderWithoutFlash();return false;" style="color:#0d9488;font-size:13px;">
                                    View packing list 
                                </a>
                            ` : `
                                <p style="color:#999;font-style:italic;font-size:14px;">
                                    No packing list yet. 
                                    <a href="#" onclick="event.preventDefault();DATA.activeTab='planning';DATA.showChecklistPage='packing';renderWithoutFlash();return false;" style="color:#0d9488;">
                                        Create packing list 
                                    </a>
                                </p>
                            `}
                        </div>
                        
                        <div class="today-card">
                            <h3 style="margin:0 0 15px 0;font-size:18px;display:flex;align-items:center;gap:10px;">
                                <span style="font-size:28px;"></span> Budget Summary
                            </h3>
                            <div style="display:grid;gap:10px;">
                                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0;">
                                    <span style="font-size:14px;color:#666;">Budget</span>
                                    <span style="font-size:14px;font-weight:600;">${DATA.currencySymbol}${Math.round(DATA.budget * DATA.rate).toLocaleString()}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0;">
                                    <span style="font-size:14px;color:#666;">Planned</span>
                                    <span style="font-size:14px;font-weight:600;">${DATA.currencySymbol}${Math.round(totalPlanned).toLocaleString()}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:8px 0;">
                                    <span style="font-size:14px;color:#666;">Budget Usage</span>
                                    <span style="font-size:14px;font-weight:600;color:${totalPlanned > (DATA.budget * DATA.rate) ? '#ef4444' : '#10b981'}">
                                        ${totalPlanned > 0 && (DATA.budget * DATA.rate) > 0 ? ((totalPlanned / (DATA.budget * DATA.rate)) * 100).toFixed(1) : '0'}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } else if (isAfterTrip) {
                // AFTER TRIP - Memories View
                const daysAgo = Math.ceil((today - tripEnd) / (1000 * 60 * 60 * 24));
                const totalActual = DATA.days.reduce((sum, day) => sum + calcA(day), 0);
                const totalBudget = DATA.budget * DATA.rate;
                const budgetDiff = totalBudget - totalActual;
                const totalPhotos = DATA.days.reduce((sum, day) => sum + (day.photos?.length || 0), 0);
                
                h += `
                    <div class="today-hero" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;padding:60px 40px;border-radius:12px;text-align:center;margin-bottom:30px;">
                        <div style="font-size:64px;margin-bottom:20px;"></div>
                        <h1 style="margin:0 0 15px 0;font-size:36px;">Trip Completed!</h1>
                        <p style="font-size:20px;margin:0 0 10px 0;opacity:0.9;">Your ${DATA.tripTitle} ended ${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago</p>
                        <p style="font-size:16px;margin:0;opacity:0.8;">${new Date(DATA.tripStartDate).toLocaleDateString()} - ${new Date(DATA.tripEndDate).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="today-card" style="margin-bottom:30px;">
                        <h3 style="margin:0 0 20px 0;font-size:24px;text-align:center;">Final Stats</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;text-align:center;">
                            <div>
                                <div style="font-size:32px;font-weight:700;color:#0d9488;margin-bottom:5px;">
                                    ${DATA.currencySymbol}${totalActual.toLocaleString()}
                                </div>
                                <div style="font-size:14px;color:#666;">Total Spent</div>
                                <div style="font-size:12px;color:#999;margin-top:4px;">$${(totalActual/DATA.rate).toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size:32px;font-weight:700;color:${budgetDiff >= 0 ? '#10b981' : '#ef4444'};margin-bottom:5px;">
                                    ${budgetDiff >= 0 ? 'Under' : 'Over'} ${DATA.currencySymbol}${Math.abs(budgetDiff).toLocaleString()}
                                </div>
                                <div style="font-size:14px;color:#666;">Budget Status</div>
                                <div style="font-size:12px;color:#999;margin-top:4px;">${((totalActual/totalBudget)*100).toFixed(1)}% of budget</div>
                            </div>
                            <div>
                                <div style="font-size:32px;font-weight:700;color:#8b5cf6;margin-bottom:5px;">
                                    ${totalPhotos}
                                </div>
                                <div style="font-size:14px;color:#666;">Photos Captured</div>
                            </div>
                            <div>
                                <div style="font-size:32px;font-weight:700;color:#000;margin-bottom:5px;">
                                    Priceless
                                </div>
                                <div style="font-size:14px;color:#666;">Memories Created</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;">
                        <button class="today-action-card" onclick="DATA.activeTab='gallery';renderWithoutFlash()">
                            <div style="font-size:48px;margin-bottom:10px;"></div>
                            <div style="font-size:18px;font-weight:600;margin-bottom:5px;">View Gallery</div>
                            <div style="font-size:13px;color:#666;">Relive your memories</div>
                        </button>
                        
                        <button class="today-action-card" onclick="DATA.showAnalyticsPage='comparison';renderWithoutFlash()">
                            <div style="font-size:48px;margin-bottom:10px;"></div>
                            <div style="font-size:18px;font-weight:600;margin-bottom:5px;">Budget Report</div>
                            <div style="font-size:13px;color:#666;">View detailed analytics</div>
                        </button>
                    </div>
                    
                    <div class="today-card">
                        <h3 style="margin:0 0 15px 0;font-size:18px;"> Trip Reflection</h3>
                        <textarea placeholder="How was your trip? What were the highlights? Any lessons learned?" 
                                style="width:100%;min-height:150px;padding:15px;border:3px solid #000;border-radius:8px;font-size:15px;line-height:1.6;resize:vertical;"
                                onchange="DATA.tripReflection=this.value;saveToStorage();" onblur="this.onchange()">${DATA.tripReflection || ''}</textarea>
                    </div>
                `;
                
            } else if (isDuringTrip) {
                // DURING TRIP - Today View
                if (!todayDay) {
                    h += `
                        <div class="today-hero" style="background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);color:white;padding:60px 40px;border-radius:12px;text-align:center;">
                            <div style="font-size:64px;margin-bottom:20px;"></div>
                            <h1 style="margin:0 0 15px 0;font-size:36px;">No Day Scheduled</h1>
                            <p style="font-size:18px;margin:0;opacity:0.9;">You don't have a day planned for today (${today.toLocaleDateString()})</p>
                            <button class="btn" onclick="switchTab('itinerary')" style="margin-top:20px;padding:12px 24px;background:white;color:#4b5563;">
                                Go to Itinerary
                            </button>
                        </div>
                    `;
                } else {
                    const dayIndex = DATA.days.indexOf(todayDay);
                    const dayTotal = todayDay.done ? calcA(todayDay) : calc(todayDay);
                    // Parse date - handle both formats
                    let todayDate;
                    const parts = todayDay.dt.split('-');
                    if (parts[0].length <= 2) {
                        // Format: M-D-YYYY
                        const [month, dayNum, year] = parts.map(num => parseInt(num, 10));
                        todayDate = new Date(year, month - 1, dayNum);
                    } else {
                        // Format: YYYY-MM-DD
                        const [year, month, dayNum] = parts.map(num => parseInt(num, 10));
                        todayDate = new Date(year, month - 1, dayNum);
                    }
                    const dayName = todayDate.toLocaleDateString('en-US', {weekday: 'long'});
                    const fullDate = todayDate.toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
                    
                    h += `
                        <div class="today-hero" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:16px;border-radius:12px;margin-bottom:16px;">
                            <div style="font-size:20px;margin-bottom:6px;"></div>
                            <h1 style="margin:0 0 6px 0;font-size:18px;font-weight:700;">Day ${todayDay.d} of ${DATA.days.length}</h1>
                            <h2 style="margin:0 0 4px 0;font-size:16px;font-weight:600;">${todayDay.loc}</h2>
                            <p style="margin:0 0 8px 0;font-size:13px;opacity:0.9;">${dayName}, ${fullDate}</p>
                            <button onclick="openDailyMap(${dayIndex})" style="padding:14px 28px;background:white;color:#000;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 12px rgba(0,0,0,0.15);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                Plan Your Day
                            </button>
                        </div>
                        
<div style="display:grid;gap:25px;">
                            <!-- Journal Entry -->
                            <div class="today-card">
                                <h3 style="margin:0 0 15px 0;font-size:20px;display:flex;align-items:center;gap:10px;">
                                    <span style="font-size:28px;"></span> Quick Journal Entry
                                </h3>
                                <textarea placeholder="How's your day going? Jot down thoughts, experiences, or things you don't want to forget..." 
                                        style="width:100%;min-height:120px;padding:15px;border:3px solid #000;border-radius:8px;font-size:15px;line-height:1.6;resize:vertical;"
                                        onchange="updateJournal(${dayIndex}, this.value)" onblur="this.onchange()">${todayDay.journalNote || ''}</textarea>
                            </div>
                            
                            <!-- Today's Schedule -->
                            <div class="today-card">
                                <h3 style="margin:0 0 15px 0;font-size:20px;display:flex;align-items:center;gap:10px;">
                                    <span style="font-size:28px;"></span> Today's Schedule
                                </h3>
                                ${todayDay.schedule && todayDay.schedule.length > 0 ? `
                                    <div style="display:flex;flex-direction:column;gap:12px;">
                                        ${todayDay.schedule.sort((a, b) => a.time.localeCompare(b.time)).map((item, idx) => `
                                            <div style="display:flex;gap:15px;align-items:start;padding:12px;background:#f9fafb;border-radius:8px;">
                                                <input type="checkbox" style="width:20px;height:20px;margin-top:2px;">
                                                <div style="flex:1;">
                                                    <div style="font-weight:600;margin-bottom:4px;">${item.time} - ${item.activity}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="color:#999;font-style:italic;">No schedule for today. <a href="#" onclick="DATA.days[' + dayIndex + '].showDaySection=\'schedule\';renderWithoutFlash();return false;" style="color:#0d9488;">Add schedule </a></p>'}
                            </div>
                            
                            <!-- Embedded Today's Map -->
                            <div style="background:white;border-radius:8px;overflow:hidden;border:3px solid #000;">
                                <div id="todayMap${dayIndex}" style="width:100%;height:400px;min-height:400px;"></div>
                            </div>
                            
                            <!-- Today's Budget -->
                            <div class="today-card">
                                <h3 style="margin:0 0 15px 0;font-size:20px;display:flex;align-items:center;gap:10px;">
                                    <span style="font-size:28px;"></span> Today's Budget: ${DATA.currencySymbol}${dayTotal.toLocaleString()}
                                </h3>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;">
                                    ${DATA.categories.map(cat => {
                                        const planned = todayDay[cat.id]?.p || 0;
                                        const actual = todayDay.a?.[cat.id] || 0;
                                        return `
                                            <div style="padding:12px;background:#f9fafb;border-radius:8px;border-left:3px solid ${cat.color};">
                                                <div style="font-size:12px;color:#666;margin-bottom:4px;">${cat.icon} ${cat.name}</div>
                                                <div style="font-weight:600;">${DATA.currencySymbol}${(actual || planned).toLocaleString()}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                                <button class="today-action-card" onclick="DATA.days[${dayIndex}].showDaySection='receipts';renderWithoutFlash()">
                                    <div style="font-size:36px;margin-bottom:8px;"></div>
                                    <div style="font-size:16px;font-weight:600;">Add Receipt</div>
                                    ${todayDay.receipts && todayDay.receipts.length > 0 ? `<div style="font-size:12px;color:#666;margin-top:4px;">${todayDay.receipts.length} receipt${todayDay.receipts.length > 1 ? 's' : ''} today</div>` : ''}
                                </button>
                                
                                <button class="today-action-card" onclick="DATA.days[${dayIndex}].showDaySection='photos';renderWithoutFlash()">
                                    <div style="font-size:36px;margin-bottom:8px;"></div>
                                    <div style="font-size:16px;font-weight:600;">Add Photo</div>
                                    ${todayDay.photos && todayDay.photos.length > 0 ? `<div style="font-size:12px;color:#666;margin-top:4px;">${todayDay.photos.length} photo${todayDay.photos.length > 1 ? 's' : ''} today</div>` : ''}
                                </button>
                                
                                <button class="today-action-card" onclick="DATA.days[${dayIndex}].showDaySection='weather';renderWithoutFlash()">
                                    <div style="font-size:36px;margin-bottom:8px;"></div>
                                    <div style="font-size:16px;font-weight:600;">Check Weather</div>
                                    ${todayDay.weather && !todayDay.weather.error ? `<div style="font-size:12px;color:#666;margin-top:4px;">${todayDay.weather.temp}F</div>` : ''}
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Fallback - no dates set
                h += `
                    <div class="today-hero" style="background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);color:white;padding:60px 40px;border-radius:12px;text-align:center;">
                        <div style="font-size:64px;margin-bottom:20px;"></div>
                        <h1 style="margin:0 0 15px 0;font-size:36px;">Set Your Trip Dates</h1>
                        <p style="font-size:18px;margin:0;opacity:0.9;">Set your trip start and end dates to see your daily view</p>
                    </div>
                `;
            }

            h += `</div>`; // Close today tab
            
            // ============================================
            // MAP TAB
            // ============================================
            h += `<div class="tab-content ${DATA.activeTab === 'map' ? 'active' : ''}">`;
            
            // Map Controls - Clean organized layout
            if (!DATA.hasOwnProperty('showMapControls')) DATA.showMapControls = false;
            h += `<div style="background:white;padding:16px;border-radius:12px;border:3px solid #000;margin-bottom:20px;">
                
                <!-- Map Controls Header -->
                <div style="display:flex;flex-wrap:wrap;align-items:center;gap:6px;">
                    <div style="display:flex;align-items:center;gap:6px;cursor:pointer;margin-right:4px;" onclick="DATA.showMapControls=!DATA.showMapControls;renderWithoutFlash();">
                        <h2 style="margin:0;font-size:16px;font-weight:700;color:#0d9488;white-space:nowrap;"> Trip Map</h2>
                        <span style="font-size:14px;color:#0d9488;transition:transform 0.3s;display:inline-block;${DATA.showMapControls ? 'transform:rotate(180deg);' : ''}"></span>
                    </div>
                    <button class="btn-secondary ${DATA.isAnimating ? 'active' : ''}" 
                        onclick="animateRoute();" 
                        style="padding:5px 9px;font-size:11px;${DATA.isAnimating ? 'background:#000;color:white;' : ''}">
                        ${DATA.isAnimating ? ' Stop' : ' Animate'}
                    </button>
                    <button class="btn-secondary ${DATA.mapViewMode === 'markers' ? 'active' : ''}" 
                        onclick="DATA.mapViewMode='markers';DATA.directionsRenderer?.setMap(null);saveToStorage();renderWithoutFlash();"
                        style="padding:5px 9px;font-size:11px;${DATA.mapViewMode === 'markers' ? 'background:#0d9488;color:white;' : ''}">
                         Markers
                    </button>
                    <button class="btn-secondary ${DATA.mapViewMode === 'route' ? 'active' : ''}" 
                        onclick="if(DATA.mapViewMode!=='route'){DATA.mapViewMode='route';saveToStorage();drawDirectionsRoute();renderWithoutFlash();}"
                        style="padding:5px 9px;font-size:11px;${DATA.mapViewMode === 'route' ? 'background:#0d9488;color:white;' : ''}">
                         Route
                    </button>
                    <button class="btn-secondary" onclick="centerMapOnTrip();" style="padding:5px 9px;font-size:11px;"> Center</button>
                    <button class="btn-secondary ${DATA.markersLocked ? 'active' : ''}" 
                        onclick="toggleMarkerLock();" 
                        style="padding:5px 9px;font-size:11px;${DATA.markersLocked ? 'background:#000;color:white;' : ''}">
                        ${DATA.markersLocked ? ' Locked' : ' Unlock'}
                    </button>
                    <button class="btn-secondary" 
                        onclick="if(confirm('Clear cached route?')){resetRouteCache('main');}" 
                        style="padding:5px 9px;font-size:11px;${DATA.routeCache.main ? 'background:#f59e0b;color:white;font-weight:600;' : ''}">
                        ${DATA.routeCache.main ? ' Reset Cache' : ' Cache'}
                    </button>
                </div>
                
                ${DATA.showMapControls ? `
                <div style="margin-top:12px;border-top:1px solid #e5e7eb;padding-top:12px;">
                <div style="display:flex;gap:16px;flex-wrap:wrap;">
                    <!-- Animation column -->
                    <div style="flex:1;min-width:180px;padding:12px;background:#f0fdfa;border-radius:8px;border:2px solid #99f6e4;">
                        <div style="font-size:11px;font-weight:700;color:#0d9488;margin-bottom:8px;letter-spacing:0.5px;">ANIMATE</div>
                        <div style="display:flex;gap:6px;margin-bottom:8px;">
                            <button class="btn-secondary ${DATA.isAnimating ? 'active' : ''}"
                                onclick="animateRoute();"
                                style="padding:6px 12px;font-size:12px;${DATA.isAnimating ? 'background:#000;color:white;' : ''}">
                                ${DATA.isAnimating ? ' Stop' : ' Start'}
                            </button>
                        </div>
                        <div style="font-size:11px;font-weight:600;color:#0d9488;margin-bottom:6px;">MODE</div>
                        <div style="display:flex;gap:6px;">
                            <button class="btn-secondary ${!DATA.animationFollowRoute ? 'active' : ''}"
                                onclick="DATA.animationFollowRoute=false;saveToStorage();renderWithoutFlash();"
                                style="padding:6px 10px;font-size:12px;${!DATA.animationFollowRoute ? 'background:#0d9488;color:white;' : ''}">
                                 Direct
                            </button>
                            <button class="btn-secondary ${DATA.animationFollowRoute ? 'active' : ''}"
                                onclick="DATA.animationFollowRoute=true;saveToStorage();renderWithoutFlash();"
                                style="padding:6px 10px;font-size:12px;${DATA.animationFollowRoute ? 'background:#0d9488;color:white;' : ''}">
                                 Follow Route
                            </button>
                        </div>
                    </div>
                    <!-- Transport Priority column -->
                    <div style="flex:1;min-width:200px;padding:12px;background:#f0fdfa;border-radius:8px;border:2px solid #99f6e4;">
                        <div style="font-size:11px;font-weight:700;color:#0d9488;margin-bottom:8px;letter-spacing:0.5px;">ROUTE TRANSPORT PRIORITY</div>
                        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
                            ${DATA.transportPriority.map((mode, idx) => {
                                const icons = {TRANSIT: '', DRIVING: '', WALKING: '', BICYCLING: ''};
                                const labels = {TRANSIT: 'Transit', DRIVING: 'Drive', WALKING: 'Walk', BICYCLING: 'Bike'};
                                return `
                                    <div style="display:flex;align-items:center;gap:4px;background:white;padding:5px 8px;border-radius:6px;border:2px solid #0d9488;font-size:11px;">
                                        <span style="font-weight:700;color:#0d9488;">${idx + 1}.</span>
                                        <span>${icons[mode]} ${labels[mode]}</span>
                                        ${idx > 0 ? `<button onclick="moveTransportPriority(${idx},${idx-1})" style="background:none;border:none;cursor:pointer;padding:0;font-size:12px;"></button>` : ''}
                                        ${idx < DATA.transportPriority.length - 1 ? `<button onclick="moveTransportPriority(${idx},${idx+1})" style="background:none;border:none;cursor:pointer;padding:0;font-size:12px;"></button>` : ''}
                                        ${DATA.transportPriority.length > 1 ? `<button onclick="removeTransportPriority(${idx})" style="background:none;border:none;cursor:pointer;padding:0;color:#ef4444;font-size:12px;"></button>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="display:flex;gap:4px;margin-top:8px;">
                            ${!DATA.transportPriority.includes('TRANSIT') ? `<button onclick="addTransportPriority('TRANSIT')" class="btn-secondary" style="padding:4px 8px;font-size:10px;">+</button>` : ''}
                            ${!DATA.transportPriority.includes('DRIVING') ? `<button onclick="addTransportPriority('DRIVING')" class="btn-secondary" style="padding:4px 8px;font-size:10px;">+</button>` : ''}
                            ${!DATA.transportPriority.includes('WALKING') ? `<button onclick="addTransportPriority('WALKING')" class="btn-secondary" style="padding:4px 8px;font-size:10px;">+</button>` : ''}
                            ${!DATA.transportPriority.includes('BICYCLING') ? `<button onclick="addTransportPriority('BICYCLING')" class="btn-secondary" style="padding:4px 8px;font-size:10px;">+</button>` : ''}
                        </div>
                    </div>
                </div>
                </div>
                ` : ''}
            </div>`;
            
            // Map Container
            h += `<div style="background:white;border-radius:12px;border:3px solid #000;overflow:hidden;margin-bottom:20px;">
                <div id="googleMap" style="width:100%;height:600px;min-height:600px;" class="google-map-div"></div>
            </div>`;
            
            // Route Editor
            if (!DATA.showRouteEditor) DATA.showRouteEditor = false;
            
            h += `<div style="background:white;padding:24px;border-radius:12px;border:3px solid #000;margin-bottom:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
                    <div style="display:flex;align-items:center;gap:12px;cursor:pointer;" onclick="toggleRouteEditor()">
                        <h3 style="margin:0;font-size:18px;font-weight:700;"> Route Editor (${DATA.mapRoute.length} stops)</h3>
                        <span id="routeEditorArrow" style="font-size:20px;transition:transform 0.3s;${DATA.showRouteEditor ? 'transform:rotate(180deg);' : ''}"></span>
                    </div>
                    <div class="route-editor-btns" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <button class="btn-secondary" onclick="addRouteLocation()" style="padding:7px 10px;font-size:12px;">
                             Add Location
                        </button>
                        <button class="btn-secondary" onclick="cleanDuplicateLocations()" style="padding:7px 10px;font-size:12px;">
                             Clean Dupes
                        </button>
                        <button class="btn-secondary" onclick="reinitializeRoute()" style="padding:7px 10px;font-size:12px;">
                             Reset from Days
                        </button>
                        <button class="btn-secondary" onclick="debugRouteOrder()" style="padding:7px 10px;font-size:12px;">
                             Debug
                        </button>
                    </div>
                </div>
                
                <div id="routeEditorContent" style="display:${DATA.showRouteEditor ? 'block' : 'none'};overflow:hidden;">
                    ${DATA.mapRoute.length > 0 ? `
                        <div style="font-size:13px;color:#666;margin-bottom:15px;padding:10px;background:#f0fdfa;border-radius:6px;border-left:3px solid #0d9488;">
                             <strong>Tip:</strong> Click  Edit to modify names and coordinates. Drag markers on map to adjust positions.
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
                            ${DATA.mapRoute.map((loc, idx) => `
                                <div style="border-radius:8px;border:2px solid #0d9488;background:#f0fdfa;min-width:0;overflow:hidden;">
                                    <div style="display:flex;align-items:center;gap:10px;padding:12px;">
                                        <div style="font-size:16px;font-weight:800;color:#0d9488;min-width:24px;text-align:center;">${idx + 1}</div>
                                        <div style="flex:1;min-width:0;">
                                            ${DATA.editingLocationIdx === idx ? `
                                                <input type="text" value="${loc.name}" 
                                                    onchange="DATA.mapRoute[${idx}].name=this.value;saveToStorage();" 
                                                    style="width:100%;padding:6px;border:2px solid #0d9488;border-radius:4px;font-size:13px;font-weight:600;margin-bottom:6px;">
                                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                                                    <div>
                                                        <label style="font-size:10px;color:#0d9488;display:block;margin-bottom:2px;">Lat</label>
                                                        <input type="number" step="0.000001" value="${loc.lat || ''}" 
                                                            onchange="DATA.mapRoute[${idx}].lat=parseFloat(this.value);if(DATA.mapRoute[${idx}].type==='day'){DATA.days[DATA.mapRoute[${idx}].dayIndex].latitude=parseFloat(this.value);}saveToStorage();initializeMap();" 
                                                            style="width:100%;padding:4px;border:1px solid #99f6e4;border-radius:4px;font-size:11px;">
                                                    </div>
                                                    <div>
                                                        <label style="font-size:10px;color:#0d9488;display:block;margin-bottom:2px;">Lng</label>
                                                        <input type="number" step="0.000001" value="${loc.lng || ''}" 
                                                            onchange="DATA.mapRoute[${idx}].lng=parseFloat(this.value);if(DATA.mapRoute[${idx}].type==='day'){DATA.days[DATA.mapRoute[${idx}].dayIndex].longitude=parseFloat(this.value);}saveToStorage();initializeMap();" 
                                                            style="width:100%;padding:4px;border:1px solid #99f6e4;border-radius:4px;font-size:11px;">
                                                    </div>
                                                </div>
                                            ` : `
                                                <div style="font-weight:600;font-size:13px;color:#000;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${loc.name}</div>
                                                <div style="font-size:11px;color:#0d9488;">
                                                    ${loc.type === 'waypoint' ? ' Waypoint' : ` Day ${(DATA.days.find((d, i) => i === loc.dayIndex)?.d || '?')}`}
                                                    ${loc.lat && loc.lng ? `  ${loc.lat.toFixed(3)}, ${loc.lng.toFixed(3)}` : '  <span style="color:#0d9488;font-weight:600;">No coords</span>'}
                                                </div>
                                            `}
                                        </div>
                                        <div style="display:flex;gap:6px;">
                                            <button onclick="DATA.editingLocationIdx=${DATA.editingLocationIdx === idx ? 'null' : idx};renderWithoutFlash();" 
                                                style="padding:6px 10px;background:${DATA.editingLocationIdx === idx ? '#22c55e' : '#0d9488'};color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;">
                                                ${DATA.editingLocationIdx === idx ? '' : ''}
                                            </button>
                                            ${loc.type === 'waypoint' ? `
                                                <button onclick="removeRouteLocation(${idx});renderWithoutFlash();" 
                                                    style="padding:6px 10px;background:#000;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;">
                                                    
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align:center;padding:40px;color:#999;">
                            <div style="font-size:48px;margin-bottom:15px;"></div>
                            <p style="font-size:16px;margin-bottom:10px;">No route locations yet</p>
                            <p style="font-size:14px;">Route will initialize from your itinerary days when you visit the map.</p>
                        </div>
                    `}
                </div>
            </div>`;
            
            h += `</div>`; // Close map tab
            
            // Close content-body and main-content if not showing welcome
            if (!DATA.showWelcome) {
                h += `</div>`; // Close content-body
            }
            h += `</div>`; // Close main-content
            h += `</div>`; // Close app-shell
            
            // MODALS - Render at top level for proper z-index and click handling
            
            // Custom Modal System
            if (DATA.showModal) {
                h += `<div class="custom-modal-overlay" onclick="closeModal()"></div>
                <div class="custom-modal">
                    <div class="custom-modal-header">
                        <h3 style="margin:0;font-size:18px;">${DATA.showModal.title}</h3>
                        <button onclick="closeModal()" style="background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;"></button>
                    </div>
                    <div class="custom-modal-body">
                        ${DATA.showModal.message ? `<p style="margin-bottom:20px;color:#666;line-height:1.6;">${DATA.showModal.message}</p>` : ''}
                        
                        ${DATA.showModal.type === 'input' ? `
                            <input type="${DATA.showModal.inputType || 'text'}" 
                                id="modalInput" 
                                placeholder="${DATA.showModal.placeholder || ''}" 
                                value="${DATA.showModal.defaultValue || ''}"
                                style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:15px;margin-bottom:15px;"
                                onkeydown="if(event.key==='Enter'){document.getElementById('modalConfirm').click();}">
                        ` : ''}
                        
                        ${DATA.showModal.type === 'textarea' ? `
                            <textarea id="modalInput" 
                                    placeholder="${DATA.showModal.placeholder || ''}" 
                                    style="width:100%;min-height:100px;padding:12px;border:3px solid #000;border-radius:8px;font-size:15px;margin-bottom:15px;resize:vertical;">${DATA.showModal.defaultValue || ''}</textarea>
                        ` : ''}
                        
                        ${DATA.showModal.type === 'time' ? `
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px;">Hour</label>
                                    <select id="modalHour" style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:15px;">
                                        ${Array.from({length: 24}, (_, i) => `<option value="${i}">${i.toString().padStart(2,'0')}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px;">Minute</label>
                                    <select id="modalMinute" style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:15px;">
                                        ${Array.from({length: 60}, (_, i) => `<option value="${i}">${i.toString().padStart(2,'0')}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            ${DATA.showModal.rangeMessage ? `<div style="font-size:13px;color:#6b7280;margin-bottom:15px;">${DATA.showModal.rangeMessage}</div>` : ''}
                        ` : ''}
                    </div>
                    <div class="custom-modal-footer">
                        <button onclick="closeModal()" class="modal-btn modal-btn-cancel">Cancel</button>
                        <button id="modalConfirm" onclick="if(window.modalCallback){window.modalCallback();}" class="modal-btn modal-btn-confirm">${DATA.showModal.confirmText || 'OK'}</button>
                    </div>
                </div>`;
            }
            
            
           
            
            // What If Date Modal
            if (DATA.showWhatIfModal) {
                const currentSimDate = DATA.whatIfDate || new Date().toISOString().split('T')[0];
                
                h += `<div class="custom-modal-overlay" onclick="closeWhatIf()"></div>
                <div class="custom-modal">
                    <div class="custom-modal-header">
                        <h3 style="margin:0;font-size:18px;">What If Date Simulator</h3>
                        <button onclick="closeWhatIf()" style="background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;"></button>
                    </div>
                    <div class="custom-modal-body">
                        <p style="margin-bottom:15px;color:#666;">Simulate what the "Today" tab would look like on a different date.</p>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;margin-bottom:10px;font-weight:600;">Select Date to Simulate</label>
                            <input type="date" 
                                id="whatIfDateInput" 
                                value="${currentSimDate}"
                                style="width:100%;padding:12px;border:3px solid #000;border-radius:8px;font-size:16px;">
                        </div>
                        
                        ${DATA.whatIfDate ? `
                            <div style="padding:15px;background:#fafafa;border-radius:8px;border:3px solid #000;margin-bottom:15px;">
                                <div style="font-size:14px;color:#1e40af;font-weight:600;margin-bottom:5px;">
                                    Currently simulating: ${new Date(DATA.whatIfDate).toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}
                                </div>
                                <div style="font-size:12px;color:#0d9488;">
                                    The "Today" tab is showing data for this simulated date
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="padding:12px;background:#fafafa;border-radius:6px;font-size:13px;color:#92400e;">
                             <strong>Tip:</strong> This only affects the "Today" tab. Your actual trip dates remain unchanged.
                        </div>
                    </div>
                    <div class="custom-modal-footer">
                        ${DATA.whatIfDate ? `
                            <button onclick="DATA.whatIfDate=null;saveToStorage();renderWithoutFlash();" class="modal-btn modal-btn-cancel">
                                Reset to Real Date
                            </button>
                        ` : ''}
                        <button onclick="
                            const dateInput = document.getElementById('whatIfDateInput');
                            if(dateInput.value) {
                                DATA.whatIfDate = dateInput.value;
                                DATA.showWhatIfModal = false;
                                DATA.activeTab = 'today';
                                saveToStorage();
                                renderWithoutFlash();
                                // Force map initialization after render completes
                                setTimeout(() => {
                                    console.log('Force initializing today map after What If...');
                                    const today = DATA.whatIfDate 
                                        ? (() => {
                                            const parts = DATA.whatIfDate.split('-');
                                            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
                                        })()
                                        : new Date();
                                    today.setHours(0, 0, 0, 0);
                                    
                                    const todayDay = DATA.days.find(day => {
                                        if (!day.dt) return false;
                                        let dayDate;
                                        if (day.dt.includes('-')) {
                                            const parts = day.dt.split('-');
                                            if (parts[0].length <= 2) {
                                                const [month, dayNum, year] = parts.map(num => parseInt(num, 10));
                                                dayDate = new Date(year, month - 1, dayNum);
                                            } else {
                                                const [year, month, dayNum] = parts.map(num => parseInt(num, 10));
                                                dayDate = new Date(year, month - 1, dayNum);
                                            }
                                        }
                                        if (dayDate) {
                                            dayDate.setHours(0, 0, 0, 0);
                                            return dayDate.getTime() === today.getTime();
                                        }
                                        return false;
                                    });
                                    
                                    if (todayDay) {
                                        const dayIndex = DATA.days.indexOf(todayDay);
                                        if (dayIndex !== -1) {
                                            initializeTodayMap(dayIndex);
                                        }
                                    }
                                }, 600);
                            }
                        " class="modal-btn modal-btn-confirm">Apply & View Today Tab</button>
                    </div>
                </div>`;
            }
            
            // Mobile Bottom Tab Bar
            h += `<div class="mobile-tab-bar">
                ${(() => {
                    // Check if currently on trip for mobile
                    if (DATA.tripStartDate && DATA.tripEndDate) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const tripStart = new Date(DATA.tripStartDate);
                        tripStart.setHours(0, 0, 0, 0);
                        const tripEnd = new Date(DATA.tripEndDate);
                        tripEnd.setHours(0, 0, 0, 0);
                        const isDuringTrip = today >= tripStart && today <= tripEnd;
                        
                        if (isDuringTrip) {
                            return `<button class="mobile-tab-btn ${DATA.activeTab === 'today' ? 'active' : ''}" onclick="event.preventDefault();DATA.activeTab='today';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                                <div class="mobile-tab-icon"></div>
                                <div>Today</div>
                            </button>`;
                        }
                    }
                    return '';
                })()}
                <button class="mobile-tab-btn ${DATA.activeTab === 'home' ? 'active' : ''}" onclick="event.preventDefault();DATA.activeTab='home';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                    <div class="mobile-tab-icon"></div>
                    <div>Home</div>
                </button>
                <button class="mobile-tab-btn ${DATA.activeTab === 'planning' ? 'active' : ''}" onclick="event.preventDefault();DATA.activeTab='planning';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                    <div class="mobile-tab-icon"></div>
                    <div>Plan</div>
                </button>
                <button class="mobile-tab-btn ${DATA.activeTab === 'itinerary' ? 'active' : ''}" onclick="event.preventDefault();DATA.activeTab='itinerary';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                    <div class="mobile-tab-icon"></div>
                    <div>Days</div>
                </button>
                <button class="mobile-tab-btn ${DATA.activeTab === 'map' ? 'active' : ''}" onclick="event.preventDefault();DATA.activeTab='map';DATA.showWelcome=false;saveToStorage();renderWithoutFlash();">
                    <div class="mobile-tab-icon"></div>
                    <div>Map</div>
                </button>
                <button class="mobile-tab-btn ${DATA.mobileMenuOpen ? 'active' : ''}" onclick="event.preventDefault();DATA.mobileMenuOpen=!DATA.mobileMenuOpen;renderWithoutFlash();">
                    <div class="mobile-tab-icon"></div>
                    <div>More</div>
                </button>
            </div>`;
            
            // Mobile More Menu Submenu
            if (DATA.mobileMenuOpen) {
                h += `<div class="mobile-more-overlay" onclick="DATA.mobileMenuOpen=false;renderWithoutFlash();"></div>
                <div class="mobile-more-menu">
                    <div class="mobile-more-header">
                        <h3 style="margin:0;font-size:18px;font-weight:700;">More Options</h3>
                        <button onclick="DATA.mobileMenuOpen=false;renderWithoutFlash();" style="background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;"></button>
                    </div>
                    <div class="mobile-more-content">
                        <button class="mobile-more-item" onclick="DATA.mobileMenuOpen=false;DATA.mobileMenuSource=true;DATA.activeTab='gallery';saveToStorage();renderWithoutFlash();">
                            <div class="mobile-more-icon"></div>
                            <div class="mobile-more-text">
                                <div class="mobile-more-title">Gallery</div>
                                <div class="mobile-more-desc">Trip photos and memories</div>
                            </div>
                        </button>
                        
                        <button class="mobile-more-item" onclick="DATA.mobileMenuOpen=false;DATA.mobileMenuSource=true;DATA.showSettings=true;renderWithoutFlash();">
                            <div class="mobile-more-icon"></div>
                            <div class="mobile-more-text">
                                <div class="mobile-more-title">Settings</div>
                                <div class="mobile-more-desc">Currency, travelers, preferences</div>
                            </div>
                        </button>
                        
                        <button class="mobile-more-item" onclick="DATA.mobileMenuOpen=false;DATA.mobileMenuSource=true;DATA.showWhatIfModal=true;renderWithoutFlash();">
                            <div class="mobile-more-icon"></div>
                            <div class="mobile-more-text">
                                <div class="mobile-more-title">What-If Calculator</div>
                                <div class="mobile-more-desc">Test budget scenarios</div>
                            </div>
                        </button>
                        
                        <button class="mobile-more-item" onclick="DATA.mobileMenuOpen=false;DATA.mobileMenuSource=true;DATA.showTripManager=true;renderWithoutFlash();">
                            <div class="mobile-more-icon"></div>
                            <div class="mobile-more-text">
                                <div class="mobile-more-title">Trip Manager</div>
                                <div class="mobile-more-desc">Save & load trips</div>
                            </div>
                        </button>
                        
                        <button class="mobile-more-item" onclick="DATA.mobileMenuOpen=false;DATA.mobileMenuSource=true;DATA.showExportMenu=true;renderWithoutFlash();">
                            <div class="mobile-more-icon"></div>
                            <div class="mobile-more-text">
                                <div class="mobile-more-title">Export & Share</div>
                                <div class="mobile-more-desc">PDF, print, share options</div>
                            </div>
                        </button>
                    </div>
                </div>`;
            }
            
            // Daily Planner Modal
            if (DATA.showDailyMap !== null) {
                const day = DATA.days[DATA.showDailyMap];
                if (day) {
                    const isDark = document.body.classList.contains('dark-mode');
                    const modalBg = isDark ? '#1e293b' : 'white';
                    const modalBorder = isDark ? '#334155' : '#e5e7eb';
                    const modalText = isDark ? '#e2e8f0' : '#111827';
                    const modalSubtext = isDark ? '#94a3b8' : '#666';
                    const sidebarBg = isDark ? '#0f172a' : '#f9fafb';
                    const cardBg = isDark ? '#1e293b' : 'white';
                    const cardBorder = isDark ? '#475569' : '#000';
                    const isMobileMap = window.innerWidth <= 768;
                    h += `
                        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:${isMobileMap ? 'flex-end' : 'center'};justify-content:center;padding:${isMobileMap ? '0' : '20px'};" onclick="if(event.target===this)closeDailyMap();">
                            <div style="background:${modalBg};border-radius:${isMobileMap ? '16px 16px 0 0' : '16px'};width:100%;max-width:${isMobileMap ? '100%' : '1200px'};height:${isMobileMap ? '90vh' : '90vh'};max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px -12px rgba(0,0,0,0.4);overflow:hidden;" onclick="event.stopPropagation();">
                                <div style="padding:${isMobileMap ? '14px 16px' : '20px 24px'};border-bottom:2px solid ${modalBorder};display:flex;justify-content:space-between;align-items:center;flex-shrink:0;">
                                    <div>
                                        <h2 style="margin:0 0 2px 0;font-size:${isMobileMap ? '16px' : '20px'};font-weight:700;color:${modalText};">Plan Day ${day.d}</h2>
                                        <p style="margin:0;font-size:${isMobileMap ? '12px' : '14px'};color:${modalSubtext};">${day.loc}</p>
                                    </div>
                                    <button onclick="closeDailyMap()" style="padding:8px;background:${isDark ? '#334155' : '#f3f4f6'};border:none;border-radius:8px;cursor:pointer;font-size:18px;width:36px;height:36px;color:${modalText};"></button>
                                </div>
                                <div style="display:flex;flex-direction:${isMobileMap ? 'column' : 'row'};flex:1;overflow:hidden;position:relative;">
                                    <div style="flex:1;position:relative;overflow:hidden;${isMobileMap ? 'height:55vw;min-height:200px;max-height:280px;' : ''};">
                                        <div id="dailyMap${DATA.showDailyMap}" style="width:100%;height:100%;"></div>
                                    </div>
                                    <div style="${isMobileMap ? 'border-top:2px solid '+modalBorder+';flex:1;overflow-y:auto;' : 'width:320px;border-left:2px solid '+modalBorder+';'};display:flex;flex-direction:column;background:${sidebarBg};overflow:visible;">
                                        <div style="padding:12px 14px;border-bottom:2px solid ${modalBorder};position:relative;z-index:1;flex-shrink:0;">
                                            <h3 style="margin:0 0 10px 0;font-size:14px;font-weight:700;color:${modalText};"> Places</h3>
                                            <input type="text" id="dailyPoiSearch${DATA.showDailyMap}" placeholder="Search for hotels, restaurants..." 
                                                style="width:100%;padding:8px 10px;border:3px solid ${isDark ? '#475569' : '#000'};border-radius:8px;font-size:13px;margin-bottom:8px;position:relative;z-index:2;background:${isDark ? '#0f172a' : 'white'};color:${modalText};">
                                            <button onclick="addCustomDailyPoi(${DATA.showDailyMap})" style="width:100%;padding:8px;background:#0d9488;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;"> Add Place</button>
                                        </div>
                                        <div id="dailyPoiList${DATA.showDailyMap}" style="flex:1;overflow-y:auto;padding:10px 12px;">
                                            ${!(DATA.dailyMapPoints[DATA.showDailyMap] && DATA.dailyMapPoints[DATA.showDailyMap].length) ? `
                                                <div style="text-align:center;padding:30px 16px;color:${modalSubtext};"><div style="font-size:40px;margin-bottom:10px;"></div><p style="font-size:13px;margin:0;color:${modalSubtext};">No places yet</p><p style="font-size:11px;margin:6px 0 0 0;color:${modalSubtext};">Search or click map</p></div>
                                            ` : (DATA.dailyMapPoints[DATA.showDailyMap] || []).map((poi, idx) => `
                                                <div 
                                                    draggable="true" 
                                                    data-poi-index="${idx}"
                                                    ondragstart="handlePoiDragStart(event, ${DATA.showDailyMap}, ${idx})"
                                                    ondragover="handlePoiDragOver(event)"
                                                    ondrop="handlePoiDrop(event, ${DATA.showDailyMap}, ${idx})"
                                                    ondragend="handlePoiDragEnd(event)"
                                                    style="background:${cardBg};padding:10px;border-radius:8px;margin-bottom:8px;border:2px solid ${cardBorder};cursor:move;transition:all 0.2s;">
                                                    <div style="display:flex;align-items:start;gap:8px;">
                                                        <div style="font-size:20px;cursor:grab;user-select:none;line-height:1;" title="Drag to reorder"></div>
                                                        <div style="flex:1;">
                                                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
                                                                <div style="flex:1;">
                                                                    <div style="font-weight:600;font-size:13px;margin-bottom:3px;color:${modalText};">
                                                                        <span style="color:${modalSubtext};font-size:11px;margin-right:4px;">${idx + 1}.</span>${poi.name}
                                                                    </div>
                                                                    ${poi.category ? `<div style="font-size:11px;color:#666;">${poi.category}</div>` : ''}
                                                                </div>
                                                                <button onclick="event.stopPropagation();removeDailyPoi(${DATA.showDailyMap}, ${idx})" style="padding:4px 8px;background:#fee;color:#dc2626;border:none;border-radius:4px;cursor:pointer;font-size:12px;"></button>
                                                            </div>
                                                            ${poi.notes ? `<div style="font-size:12px;color:#666;margin-top:6px;">${poi.notes}</div>` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div style="padding:16px;border-top:2px solid #e5e7eb;background:white;">
                                            <button onclick="drawDailyRoute(${DATA.showDailyMap})" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;margin-bottom:8px;"> Draw Route</button>
                                            <button onclick="closeDailyMap()" style="width:100%;padding:12px;background:#0d9488;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;">Done</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Continue with rest of render
            // Apply dark mode BEFORE innerHTML to prevent white flash on re-render
            if (DATA.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
                 
                 app.innerHTML = h;
    
    
                // Adjust category title font sizes
                adjustCategoryTitleFontSize();
                
            // Set up currency converter listeners (after DOM is ready)
            const usdInput = document.getElementById('usdInput');
            if(usdInput && !usdInput.hasAttribute('data-listeners-attached')) {
                usdInput.setAttribute('data-listeners-attached', 'true');
                usdInput.addEventListener('input', (e) => {
                    DATA.converterUSD = parseFloat(e.target.value) || 0;
                    DATA.converterYEN = DATA.converterUSD * DATA.rate;
                    const yenInput = document.getElementById('yenInput');
                    if(yenInput) yenInput.value = DATA.converterYEN.toFixed(0);
                    saveToStorage();
                });
            }
            
            const yenInput = document.getElementById('yenInput');
            if(yenInput && !yenInput.hasAttribute('data-listeners-attached')) {
                yenInput.setAttribute('data-listeners-attached', 'true');
                yenInput.addEventListener('input', (e) => {
                    DATA.converterYEN = parseFloat(e.target.value) || 0;
                    DATA.converterUSD = DATA.converterYEN / DATA.rate;
                    const usdInput = document.getElementById('usdInput');
                    if(usdInput) usdInput.value = DATA.converterUSD.toFixed(2);
                    saveToStorage();
                });
            }

                // Set up search input listener - MOVED HERE (after DOM is ready)
                const searchInput = document.getElementById('searchInput');
                if(searchInput && !searchInput.hasAttribute('data-listeners-attached')) {
                    searchInput.setAttribute('data-listeners-attached', 'true');
                    
                    const performSearch = (query) => {
                        
                        if (!query || query.trim().length === 0) {
                            DATA.showSearchResults = false;
                            DATA.searchResults = [];
                            return;
                        }
                        
                        const searchLower = query.toLowerCase().trim();
                        const results = [];
                        
                        
                        DATA.days.forEach((day, idx) => {
                            const matches = [];
                            
                            if (day.loc && day.loc.toLowerCase().includes(searchLower)) {
                                matches.push({ field: 'Location', value: day.loc });
                            }
                            if (day.dt && day.dt.toLowerCase().includes(searchLower)) {
                                matches.push({ field: 'Date', value: day.dt });
                            }
                            
                            // Search through categories using .n field
                            DATA.categories.forEach(cat => {
                                const catData = day[cat.id];
                                if (catData && catData.n && catData.n.toLowerCase().includes(searchLower)) {
                                    matches.push({ field: cat.name, value: catData.n });
                                }
                            });
                            
                            if (day.note && day.note.toLowerCase().includes(searchLower)) {
                                matches.push({ field: 'Note', value: day.note });
                            }
                            if (day.journalNote && day.journalNote.toLowerCase().includes(searchLower)) {
                                matches.push({ field: 'Journal', value: day.journalNote.substring(0, 100) });
                            }
                            
                            if (matches.length > 0) {
                                results.push({ dayIndex: idx, day: day, matches: matches });
                            }
                        });
                        
                        DATA.searchResults = results;
                        DATA.showSearchResults = true; // ALWAYS show dropdown when searching (even if no results)
                    };
                    
                    // Enter-based search
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && DATA.searchMode === 'enter') {
                            performSearch(e.target.value);
                            renderWithoutFlash();
                        }
                    });
                    
                    // Input listener for both modes
                    searchInput.addEventListener('input', (e) => {
                        DATA.searchQuery = e.target.value;
                        
                        // Clear search results immediately when input is empty
                        if (!e.target.value || e.target.value.trim().length === 0) {
                            DATA.showSearchResults = false;
                            DATA.searchResults = [];
                            renderWithoutFlash();
                            return;
                        }
                        
                        // Auto mode with debounce
                        if (DATA.searchMode === 'auto') {
                            clearTimeout(window.searchTimer);
                            window.searchTimer = setTimeout(() => {
                                performSearch(e.target.value);
                                renderWithoutFlash();
                            }, 400);
                        }
                    });
            }

            // Restore scroll position after render
            restoreScrollPosition();
            
            // Setup tooltips for truncated text (after DOM is ready)
            setTimeout(() => setupTruncateTooltips(), 100);
            
            // Setup Quick Jump functionality
            setTimeout(() => setupQuickJump(), 150);
            
            // Apply appearance settings (including dark mode) after render
            setTimeout(() => applyAppearanceSettings(), 10);
        };
        
        // Apply appearance settings to document
        function applyAppearanceSettings() {
            // Animation speed
            const speeds = { fast: '0.15s', normal: '0.3s', slow: '0.6s' };
            document.documentElement.style.setProperty('--transition-speed', speeds[DATA.animationSpeed] || '0.3s');
            
            // Font size
            const fontSizes = { small: '14px', medium: '16px', large: '18px' };
            document.documentElement.style.fontSize = fontSizes[DATA.fontSize] || '16px';
            
            // Dark mode
            if (DATA.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // Card style
            if (DATA.cardStyle === 'classic') {
                document.body.classList.add('card-classic');
            } else {
                document.body.classList.remove('card-classic');
            }
            
            // Density
            document.body.classList.remove('density-compact', 'density-spacious');
            if (DATA.density === 'compact') {
                document.body.classList.add('density-compact');
            } else if (DATA.density === 'spacious') {
                document.body.classList.add('density-spacious');
            }
        }
        
        loadFromStorage();
        
        // Reset transient state that should never persist across sessions
        DATA.isAnimating = false;
        DATA.animationFollowRoute = false; // Always start in Direct mode
        
        // Apply dark mode immediately (before first render) to prevent white flash
        if (DATA.darkMode) {
            document.body.classList.add('dark-mode');
        }
        
        applyAppearanceSettings(); // Apply saved appearance settings (includes dark mode)

        if (DATA.liveRate) {
            fetchLiveRate();
        } else {
            renderWithoutFlash();
        }

        // Prevent multiple map initializations
        let mapInitInProgress = false;
        
        // Always init map if it's open AND we're on planning tab
        if (DATA.showMap && DATA.activeTab === 'planning' && !mapInitInProgress) {
            mapInitInProgress = true;
            setTimeout(() => {
                try {
                    const mapElement = document.getElementById('tripMap');
                    if (mapElement && !DATA.googleMap) {
                        initMap();
                    }
                } catch (error) {
                    console.error('Map init error:', error);
                } finally {
                    mapInitInProgress = false;
                }
            }, 100);
        }
        
        // Initialize today's embedded map if on today tab
        if (DATA.activeTab === 'today') {
            // Clear the instance flag to allow reinitialization
            window.todayMapInstance = null;
            
            // Wait longer for render to complete - 500ms instead of 200ms
            setTimeout(() => {
                try {
                    console.log('Attempting to initialize today map...');
                    // Find today's day
                const today = DATA.whatIfDate 
                    ? (() => {
                        const parts = DATA.whatIfDate.split('-');
                        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
                    })()
                    : new Date();
                today.setHours(0, 0, 0, 0);
                
                const todayDay = DATA.days.find(day => {
                    if (!day.dt) return false;
                    let dayDate;
                    if (day.dt.includes('-')) {
                        const parts = day.dt.split('-');
                        if (parts[0].length <= 2) {
                            const [month, dayNum, year] = parts.map(num => parseInt(num, 10));
                            dayDate = new Date(year, month - 1, dayNum);
                        } else {
                            const [year, month, dayNum] = parts.map(num => parseInt(num, 10));
                            dayDate = new Date(year, month - 1, dayNum);
                        }
                    }
                    if (dayDate) {
                        dayDate.setHours(0, 0, 0, 0);
                        return dayDate.getTime() === today.getTime();
                    }
                    return false;
                });
                
                if (todayDay) {
                    const dayIndex = DATA.days.indexOf(todayDay);
                    console.log('Today is day index:', dayIndex);
                    if (dayIndex !== -1) {
                        const todayMapElement = document.getElementById(`todayMap${dayIndex}`);
                        console.log('Today map element:', todayMapElement);
                        if (todayMapElement) {
                            console.log('Calling initializeTodayMap...');
                            initializeTodayMap(dayIndex);
                        } else {
                            console.error('Today map element not found in DOM');
                        }
                    }
                } else {
                    console.log('No matching day found for today');
                }
                } catch (error) {
                    console.error('Today map init error:', error);
                }
            }, 500); // Increased from 200ms to 500ms
        }
        
        // Quick Jump functionality
        function setupQuickJump() {
            const dayJumpInput = document.getElementById('dayJumpInput');
            const dayJumpGoBtn = document.getElementById('dayJumpGoBtn');
            
            if (!dayJumpInput || !dayJumpGoBtn) return;
            
            const jumpToDay = () => {
                const dayNum = parseInt(dayJumpInput.value);
                if (dayNum >= 1 && dayNum <= DATA.days.length) {
                    DATA.expanded = dayNum - 1;
                    saveToStorage();
                    renderWithoutFlash();
                    setTimeout(() => {
                        const dayCard = document.querySelector(`.day-card[data-day="${dayNum - 1}"]`);
                        if (dayCard) {
                            dayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            };
            
            dayJumpInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    jumpToDay();
                }
            });
            
            dayJumpGoBtn.addEventListener('click', jumpToDay);
        }
        
        
        document.addEventListener('click', (e) => {
            if (DATA.showSearchResults && !e.target.closest('.search-bar')) {
                DATA.showSearchResults = false;
                renderWithoutFlash();
            }
        });

        // Close day detail modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close modals/pages in priority order (most specific first)
                if (DATA.mobileMenuOpen) {
                    DATA.mobileMenuOpen = false;
                    renderWithoutFlash();
                } else if (DATA.showChecklistPage) {
                    DATA.showChecklistPage = null;
                    renderWithoutFlash();
                } else if (DATA.showAnalyticsPage) {
                    DATA.showAnalyticsPage = null;
                    renderWithoutFlash();
                } else if (DATA.showDayDetailModal !== null && DATA.showDayDetailModal !== undefined) {
                    DATA.showDayDetailModal = null;
                    renderWithoutFlash();
                } else if (DATA.showSettings) {
                    DATA.showSettings = false;
                    renderWithoutFlash();
                } else if (DATA.showExportModal) {
                    DATA.showExportModal = false;
                    renderWithoutFlash();
                } else if (DATA.editingNotesModal !== null) {
                    DATA.editingNotesModal = null;
                    renderWithoutFlash();
                } else if (DATA.editingCategoryModal !== null) {
                    DATA.editingCategoryModal = null;
                    renderWithoutFlash();
                }
            }
        });
        </script>
        
    </body>
</html>
                
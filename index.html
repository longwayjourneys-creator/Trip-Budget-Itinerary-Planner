<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trip Budget">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Trip Budget & Itinerary Planner</title>
    <title>Japan Trip 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #fafafa; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        .header { background: white; padding: 40px; margin-bottom: 30px; border-radius: 8px; border-left: 4px solid #333; }
        .header h1 { font-size: 28px; font-weight: 600; margin-bottom: 8px; color: #111; }
        .header .subtitle { color: #666; font-size: 15px; }
        .header-title-edit { border: 2px solid #3b82f6; border-radius: 4px; padding: 8px 12px; font-size: 28px; font-weight: 600; width: 100%; }
        .header-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .header-btn { background: #111; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
        .header-btn:hover { background: hsl(0, 0%, 20%); }
        .header-btn.danger { background: #ef4444; }
        .header-btn.danger:hover { background: #dc2626; }

        .currency-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .currency-selector label { font-size: 14px; font-weight: 600; color: #374151; }
        .currency-selector select { padding: 8px 12px; border: 2px solid #cbd5e1; border-radius: 4px; font-size: 14px; background: white; cursor: pointer; }
        .currency-selector select:focus { outline: none; border-color: #3b82f6; }
        .rate-toggle { display: flex; align-items: center; gap: 8px; }
        .rate-toggle-label { font-size: 13px; color: #666; }

        .day-card-controls { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; }
        .day-control-btn { background: #f3f4f6; color: #374151; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .day-control-btn:hover { background: #e5e7eb; }
        .day-control-btn.danger { background: #fee2e2; color: #dc2626; }
        .day-control-btn.danger:hover { background: #fecaca; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .stat-card.blue { background: #f0f9ff; border-color: #3b82f6; }
        .stat-card.red { background: #fef3f2; border-color: #ef4444; }
        .stat-card.green { background: #f0fdf4; border-color: #22c55e; }
        .stat-label { font-size: 12px; text-transform: uppercase; color: #999; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: 600; color: #111; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s; }
        .stat-value:hover { background: #f0f0f0; }
        .stat-card.green .stat-value { color: #16a34a; }
        .stat-sub { font-size: 13px; color: #666; margin-top: 4px; }
        .edit-input { width: 100%; max-width: 150px; padding: 4px 8px; border: 2px solid #3b82f6; border-radius: 4px; font-size: 24px; font-weight: 600; text-align: center; }
        
        .search-bar { background: white; padding: 15px 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; position: relative; }
        .search-input { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 15px; }
        .search-input:focus { outline: none; border-color: #3b82f6; }
        .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 5px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; display: none; }
        .search-dropdown.show { display: block; }
        .search-result-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .search-result-item:hover { background: #f9f9f9; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-day { font-weight: 600; color: #111; font-size: 14px; margin-bottom: 4px; }
        .search-result-location { color: #666; font-size: 13px; margin-bottom: 4px; }
        .search-result-match { color: #3b82f6; font-size: 12px; }
        .search-result-highlight { background: #fef08a; padding: 0 2px; border-radius: 2px; }
        .search-no-results { padding: 20px; text-align: center; color: #999; font-size: 14px; }
        
        .control-bar { background: white; padding: 15px 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .control-bar .rate { font-size: 14px; color: #666; }
        .control-bar .rate-value { font-size: 16px; font-weight: 600; cursor: pointer; padding: 6px 10px; border-radius: 4px; }
        .control-bar .rate-value:hover { background: #f0f0f0; }
        .btn { background: #111; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; }
        .btn:hover { background: #333; }
        
        .converter { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .converter h3 { font-size: 16px; margin-bottom: 15px; }
        .converter-inputs { display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; }
        .converter-input { display: flex; flex-direction: column; }
        .converter-input label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .converter-input input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 18px; font-weight: 600; }
        .converter-swap { font-size: 24px; cursor: pointer; user-select: none; }
        
        .daily-budget { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .daily-budget-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .daily-budget h3 { font-size: 16px; margin: 0; }
        .daily-budget-toggle { font-size: 20px; transition: transform 0.3s; }
        .daily-budget-toggle.open { transform: rotate(180deg); }
        .daily-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; display: none; }
        .daily-stats.show { display: grid; }
        .daily-stat { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; }
        .daily-stat-label { font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 5px; }
        .daily-stat-value { font-size: 22px; font-weight: 600; }
        .daily-stat-note { font-size: 10px; opacity: 0.7; margin-top: 4px; }
        
        .toggle { background: white; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; cursor: pointer; }
        .toggle:hover { background: #f9f9f9; }
        .toggle-switch { width: 50px; height: 26px; background: #ddd; border-radius: 13px; position: relative; transition: background 0.3s; }
        .toggle-switch.on { background: #22c55e; }
        .toggle-slider { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch.on .toggle-slider { transform: translateX(18px); }
        
        .progress { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 30px; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .progress-bar { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); transition: width 0.3s; }
        .progress-fill.over { background: linear-gradient(90deg, #ef4444, #dc2626); }
        
        .chart-container { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .chart-container h3 { font-size: 16px; margin: 0; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 15px; }
        .chart-header-toggle { font-size: 20px; transition: transform 0.3s; }
        .chart-header-toggle.open { transform: rotate(180deg); }
        .chart-content { display: none; }
        .chart-content.show { display: block; }
        .chart-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .chart-toggle button { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .chart-toggle button.active { background: #111; color: white; border-color: #111; }
        .chart { display: grid; gap: 10px; }
        .chart-bar { display: flex; align-items: center; gap: 10px; }
        .chart-label { min-width: 120px; font-size: 13px; font-weight: 600; }
        .chart-bar-bg { flex: 1; height: 30px; background: #f0f0f0; border-radius: 4px; overflow: hidden; position: relative; }
        .chart-bar-fill { height: 100%; display: flex; align-items: center; padding: 0 10px; color: white; font-size: 12px; font-weight: 600; transition: width 0.3s; }
        .chart-bar-fill.acc { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .chart-bar-fill.trn { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        .chart-bar-fill.food { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .chart-bar-fill.act { background: linear-gradient(90deg, #10b981, #059669); }
        .chart-value { min-width: 100px; text-align: right; font-size: 13px; font-weight: 600; }
        
        .day-card { background: white; margin-bottom: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .day-card.done { opacity: 0.7; border-left: 4px solid #22c55e; }
        .day-header { padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .day-header:hover { background: #f9f9f9; }
        .day-info { display: flex; align-items: center; gap: 20px; flex: 1; }
        .day-check { width: 24px; height: 24px; cursor: pointer; }
        .day-num { width: 40px; height: 40px; background: #111; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .day-card.done .day-num { background: #22c55e; }
        .day-title h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .day-title .date { font-size: 13px; color: #666; }
        .day-cost .amount { font-size: 18px; font-weight: 600; }
        .day-cost .usd { font-size: 13px; color: #666; }
        
        .details { padding: 20px; border-top: 1px solid #f0f0f0; display: none; }
        .details.show { display: block; }
        .edit-btn { background: #111; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; margin-bottom: 15px; }
        .edit-btn:hover { background: #333; }
        .edit-btn.save { background: #28a745; }
        .section { margin-top: 15px; padding: 15px; background: #fafafa; border-radius: 4px; }
        .section.blue { background: #f0f9ff; border-left: 3px solid #3b82f6; }
        .section.yellow { background: #fffbf0; border-left: 3px solid #ffc107; }
        .section-label { font-size: 12px; text-transform: uppercase; color: #999; margin-bottom: 8px; }
        .section-content { font-size: 14px; color: #333; }
        .section-cost { font-weight: 600; color: #111; margin-top: 8px; }
        .section-cost.actual { color: #ef4444; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        input[type="text"], input[type="number"], input[type="time"], textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; }
        textarea { min-height: 60px; resize: vertical; }
        
        .photo-section { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px; }
        .photo-upload { display: flex; gap: 10px; margin-bottom: 10px; }
        .photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .photo-item { position: relative; aspect-ratio: 1; border-radius: 4px; overflow: hidden; cursor: pointer; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-delete { position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; z-index: 10; }
        
        .photo-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .photo-modal.show { display: flex; }
        .photo-modal-content { max-width: 90%; max-height: 90%; position: relative; }
        .photo-modal-content img { max-width: 100%; max-height: 90vh; border-radius: 8px; }
        .photo-modal-close { position: absolute; top: -40px; right: 0; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; }
        
        .schedule-section { margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3b82f6; }
        .schedule-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 10px; }
        .schedule-header h4 { font-size: 14px; font-weight: 600; margin: 0; }
        .schedule-toggle { font-size: 16px; }
        .schedule-grid { display: grid; gap: 2px; margin-top: 15px; }
	    .schedule-hour { display: grid; grid-template-columns: 130px 1fr auto; gap: 0; align-items: stretch; background: white; border-radius: 4px; overflow: hidden; border: 1px solid #e5e7eb; transition: all 0.2s; }
        .schedule-hour:hover { border-color: #3b82f6; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1); }
        .schedule-time { display: flex; align-items: center; justify-content: center; background: #f9fafb; border-right: 2px solid #e5e7eb; padding: 12px 8px; }
        .schedule-time input { border: none; background: transparent; font-size: 13px; font-weight: 600; color: #374151; text-align: center; width: 100%; cursor: pointer; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .schedule-time input:focus { outline: none; }
        .schedule-activity { padding: 12px 15px; display: flex; align-items: center; }
        .schedule-activity input { border: none; background: transparent; font-size: 14px; color: #111827; width: 100%; }
        .schedule-activity input:focus { outline: none; }
        .schedule-activity input::placeholder { color: #9ca3af; }
        .schedule-actions { display: flex; align-items: center; padding: 0 10px; }
        .schedule-delete { background: transparent; color: #ef4444; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 16px; transition: all 0.2s; }
        .schedule-delete:hover { background: #fee; }
        .schedule-add-btn { width: 100%; padding: 12px; background: white; border: 2px dashed #cbd5e1; border-radius: 4px; color: #64748b; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;	margin-top: 10px; }
        .schedule-add-btn:hover { border-color: #3b82f6; color: #3b82f6; background: #f0f9ff; }
        .schedule-timeline { background: white; border-radius: 6px; border: 1px solid #e5e7eb; overflow: hidden; margin-top: 15px; }
        .timeline-hours { display: grid; grid-template-columns: 80px 1fr; }
        .timeline-hour-row { display: contents; }
        .timeline-hour-label { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; border-right: 2px solid #e5e7eb; background: #f9fafb; font-size: 12px; font-weight: 600; color: #6b7280; text-align: right; }
        .timeline-hour-cell { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; position: relative; min-height: 50px; cursor: pointer; transition: background 0.2s; }
        .timeline-hour-cell:hover { background: #f0f9ff; }
        .timeline-event { position: absolute; left: 5px; right: 5px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 10px; border-radius: 4px; font-size: 13px; cursor: pointer; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); transition: all 0.2s; z-index: 1; }        .timeline-event:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4); }
        .timeline-event-time { font-weight: 600; font-size: 11px; opacity: 0.9; margin-bottom: 2px; }
        .timeline-event-title { font-size: 13px; line-height: 1.3; }
        .timeline-event-delete { position: absolute; top: 4px; right: 4px; background: rgba(255, 255, 255, 0.3); border: none; border-radius: 3px; padding: 2px 6px; font-size: 11px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .timeline-event:hover .timeline-event-delete { opacity: 1; }
        .timeline-event-delete:hover { background: rgba(255, 255, 255, 0.5); }
        .schedule-view-toggle { display: flex; gap: 8px; margin-bottom: 10px; }
        .schedule-view-btn { padding: 6px 14px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; color: #64748b; transition: all 0.2s; }
        .schedule-view-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .schedule-view-btn:hover:not(.active) { border-color: #3b82f6; color: #3b82f6; }

	    .subtitle-edit { border: 2px solid #3b82f6; border-radius: 4px; padding: 6px 10px; font-size: 15px; width: 100%; margin-top: 8px; }
        .trip-notes-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .trip-notes-section h3 { font-size: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .trip-notes-section textarea { width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical; }

        .category-budget-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .category-budget-section h3 { font-size: 16px; margin-bottom: 15px; }
        .category-budget-item { margin-bottom: 20px; }
        .category-budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .category-budget-label { font-size: 14px; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 8px; }
        .category-budget-amount { font-size: 14px; color: #6b7280; }
        .category-budget-input { width: 120px; padding: 4px 8px; border: 2px solid #3b82f6; border-radius: 4px; font-size: 14px; font-weight: 600; }
        .category-budget-bar { width: 100%; height: 24px; background: #f3f4f6; border-radius: 12px; overflow: hidden; position: relative; }
        .category-budget-fill { height: 100%; transition: width 0.3s; position: relative; display: flex; align-items: center; padding: 0 10px; font-size: 12px; font-weight: 600; color: white; }
        .category-budget-fill.low { background: linear-gradient(90deg, #10b981, #059669); }
        .category-budget-fill.medium { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .category-budget-fill.high { background: linear-gradient(90deg, #ef4444, #dc2626); }

        .travelers-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .travelers-section h3 { font-size: 16px; margin-bottom: 15px; }
        .traveler-count { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .traveler-count-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #3b82f6; background: white; color: #3b82f6; font-size: 20px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .traveler-count-btn:hover { background: #3b82f6; color: white; }
        .traveler-count-display { font-size: 24px; font-weight: 600; min-width: 60px; text-align: center; }
        .traveler-list { display: grid; gap: 10px; margin-top: 15px; }
        .traveler-item { display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; }
        .traveler-item input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .cost-split-toggle { margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 6px; }
        .cost-split-option { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
        .cost-split-option input[type="radio"] { width: 18px; height: 18px; cursor: pointer; }
        .cost-split-option label { font-size: 14px; color: #374151; cursor: pointer; }
        .per-person-cost { display: inline-block; margin-left: 8px; padding: 2px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 12px; font-weight: 600; }
       
        .weather-section { background: white; padding: 15px; border-radius: 6px; border-left: 3px solid #3b82f6; margin-top: 15px; }
        .weather-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .weather-header h4 { font-size: 14px; font-weight: 600; margin: 0; }
        .weather-fetch-btn { background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s; }
        .weather-fetch-btn:hover { background: #2563eb; }
        .weather-fetch-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .weather-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .weather-card { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px; border-radius: 6px; text-align: center; }
        .weather-icon { font-size: 32px; margin-bottom: 5px; }
        .weather-temp { font-size: 20px; font-weight: 600; }
        .weather-desc { font-size: 11px; opacity: 0.9; margin-top: 4px; text-transform: capitalize; }
        .weather-error { color: #ef4444; font-size: 13px; padding: 10px; background: #fee2e2; border-radius: 4px; }
        .weather-loading { color: #666; font-size: 13px; font-style: italic; }

        .category-manager { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .category-manager h3 { font-size: 16px; margin-bottom: 15px; }
        .category-list { display: grid; gap: 10px; margin-bottom: 15px; }
        .category-item { display: grid; grid-template-columns: 50px 1fr 80px 100px auto; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; }
        .category-icon-picker { width: 40px; height: 40px; font-size: 20px; text-align: center; line-height: 40px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white; }
        .category-color-picker { width: 60px; height: 30px; border: 2px solid #e5e7eb; border-radius: 4px; cursor: pointer; }
        .add-category-btn { width: 100%; padding: 12px; background: white; border: 2px dashed #cbd5e1; border-radius: 6px; color: #64748b; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .add-category-btn:hover { border-color: #3b82f6; color: #3b82f6; background: #f0f9ff; }
        .icon-picker-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; max-height: 500px; overflow-y: auto; }
        .icon-picker-modal.show { display: block; }
        .icon-picker-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; }
        .icon-picker-overlay.show { display: block; }
        .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 15px; }
        .icon-option { width: 50px; height: 50px; font-size: 24px; display: flex; align-items: center; justify-content: center; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .icon-option:hover { border-color: #3b82f6; background: #f0f9ff; transform: scale(1.1); }

        .tab-navigation { background: white; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; display: flex; overflow: hidden; }
        .tab-btn { flex: 1; padding: 15px 20px; background: white; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 16px; font-weight: 600; color: #6b7280; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn:hover { background: #f9fafb; color: #374151; }
        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; background: #f0f9ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .map-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .map-section h3 { font-size: 16px; margin-bottom: 15px; }
        .map-container { width: 100%; height: 500px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; }
        .map-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .map-btn { padding: 8px 16px; background: white; border: 2px solid #3b82f6; color: #3b82f6; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; }
        .map-btn:hover { background: #3b82f6; color: white; }
        .map-btn.active { background: #3b82f6; color: white; }
        .route-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .route-stat-card { background: #f9fafb; padding: 15px; border-radius: 6px; border-left: 3px solid #3b82f6; }
        .route-stat-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .route-stat-value { font-size: 20px; font-weight: 600; color: #111; }
        .location-marker-popup { font-size: 13px; }
        .location-marker-popup strong { display: block; margin-bottom: 5px; font-size: 14px; }
        .map-loading { padding: 20px; text-align: center; color: #666; font-style: italic; }
        .route-arrow { 
            background: none !important; 
            border: none !important; 
            font-size: 20px; 
            color: #3b82f6; 
            text-shadow: 0 0 3px white;
        }

        .location-item { display: flex; gap: 10px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #3b82f6; cursor: move; }
        .location-item.dragging { opacity: 0.5; }
        .location-item.drag-over { border-top: 3px solid #3b82f6; }

        .checklist-item {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .checklist-item.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        .checklist-item.drag-over {
            background-color: #e3f2fd;
            border-top: 2px solid #3b82f6;
        }

        @media print {
            .control-bar, .toggle, .converter, .daily-budget, .edit-btn, .btn, .photo-upload, .photo-delete, .search-bar, .day-control-btn, .tab-navigation { display: none !important; }
            .tab-content { display: block !important; }
            .day-card { page-break-inside: avoid; }
            .details { display: block !important; }
            .chart-content { display: block !important; }
            .schedule-grid, .schedule-timeline { display: block !important; }
            .day-header { cursor: default !important; }
        }
        @media (max-width: 768px) {
            .day-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .stats { grid-template-columns: 1fr; }
            .converter-inputs { grid-template-columns: 1fr; }
            .converter-swap { transform: rotate(90deg); }
        }


        .receipt-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .receipt-upload {
            margin-bottom: 15px;
        }
        .receipt-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .receipt-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .receipt-details {
            flex: 1;
        }
        .receipt-details input,
        .receipt-details select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .receipt-analytics {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .receipt-header:hover {
            background: #f3f4f6;
        }
        .receipt-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }


        .gallery-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .gallery-view-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .gallery-view-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        .gallery-view-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        .gallery-timeline {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .gallery-day-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .gallery-day-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .gallery-day-header h3 {
            margin: 0 0 5px 0;
            font-size: 20px;
            color: #1f2937;
        }
        .gallery-day-location {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .gallery-photo-count {
            font-size: 12px;
            color: #9ca3af;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .gallery-grid-all {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .gallery-photo-item {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .gallery-photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .gallery-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gallery-photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 15px 10px 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .gallery-photo-item:hover .gallery-photo-overlay {
            opacity: 1;
        }
        .gallery-photo-day {
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .gallery-photo-location {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
        }
        .gallery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .photo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .photo-header:hover {
            background: #f3f4f6;
        }
        .photo-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        

    </style>
</head>
<body>
    <div class="container" id="app"></div>
    <script>

        let renderTimeout = null;
        const debouncedRender = () => {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(render, 50);
        };

        const DATA = {
            budget: 5000,
            rate: 155,
            currency: 'JPY',
            currencySymbol: '¬•',
            liveRate: true,
            lastFetchedRate: null,
            tripStartDate: '2026-06-18',
            tripEndDate: '2026-08-11',
            categories: [
                {id: 'acc', name: 'Accommodation', icon: 'üè®', color: '#3b82f6'},
                {id: 'trn', name: 'Transportation', icon: 'üöÜ', color: '#8b5cf6'},
                {id: 'food', name: 'Food', icon: 'üç±', color: '#f59e0b'},
                {id: 'act', name: 'Activities', icon: 'üó∫', color: '#10b981'}
            ],
            categoryBudgets: {},
            showCategoryManager: false,
            iconPickerOpen: false,
            iconPickerCategory: null,
            expanded: null,
            editing: null,
            editTitle: false,
            tripTitle: 'Japan Trip 2026 - Budget & Itinerary',
            tripSubtitle: 'June 18 - August 11, 2026',
            tripNotes: '',
            packingList: [],
            editPackingList: false,
            categoryBudgets: {
                acc: 0,
                trn: 0,
                food: 0,
                act: 0
            },
            travelers: ['Traveler 1'],
            travelerCount: 1,
            costSplitMode: 'total', // 'total', 'perPerson', or 'shared'
            showTravelers: false,
            showTravelerList: false,
            editCategoryBudget: null,
            showEst: false,
            editBudget: false,
            editRate: false,
            editBeforeChecklist: false,
            editTripChecklist: false,
            converterUSD: 100,
            converterYEN: 15500,
            searchQuery: '',
            searchResults: [],
            showSearchResults: false,
            searchMode: 'enter',
            chartView: 'planned',
            showDailyBudget: false,
            showChart: false,
            showChartAcc: false,
            showChartTrn: false,
            showChartFood: false,
            showChartAct: false,
            photoModal: null,
            activeTab: 'planning', // or 'itinerary'
            showMap: false,
            mapInitialized: false,
            mapView: 'all', // 'all', 'route', or 'clusters'
            geocodedLocations: {}, // Cache geocoded locations
            locationOrder: {},
            beforeChecklist: [{item: 'Book flights', checked: false}, {item: 'Get travel insurance', checked: false}],
            tripChecklist: [{item: 'Charge electronics', checked: false}, {item: 'Pack passport', checked: false}],
            receipts: [], // Array of receipt objects per day
            showReceipts: false,
            

            days: [
                {d:1,dt:'6-18-2026',loc:'Tokyo ‚Üí Okayama',acc:{n:'ARK Hotel Okayama (3n)',p:19200},trn:{d:'Bullet train ~8:30',p:20000},food:{d:'Conbini/local',p:1000},act:{d:'Land 2:10pm, train to Okayama, check in, izakaya dinner',p:0},note:'First day - take it easy',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:2,dt:'6-19-2026',loc:'Okayama',acc:{n:'ARK Hotel Okayama',p:0},trn:{d:'Local transport',p:500},food:{d:'Hotel breakfast, local',p:2000},act:{d:'Okayama Castle and Korakuen Gardens. Closes 5:30pm',p:640},note:'Castle beautiful, allow 3-4hrs',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:3,dt:'6-20-2026',loc:'Okayama',acc:{n:'ARK Hotel Okayama',p:0},trn:{d:'Local transport',p:500},food:{d:'Hotel breakfast',p:0},act:{d:'Kibiji bike path - bike rental',p:1500},note:'Beautiful bike ride',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:4,dt:'6-21-2026',loc:'Kurashiki ‚Üí Takamatsu',acc:{n:'Hostel Jaq Takamatsu (2n)',p:6842},trn:{d:'Okayama‚ÜíKurashiki 330¬•, Kurashiki‚ÜíUno 800¬•, Ferry',p:1810},food:{d:'Local/conbini',p:2000},act:{d:'Kurashiki: Canal Area, Historical Quarter',p:0},note:'Timing tight',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:5,dt:'6-22-2026',loc:'Takamatsu',acc:{n:'Hostel Jaq Takamatsu',p:0},trn:{d:'Local transport',p:0},food:{d:'Breakfast, Sanuki udon',p:1000},act:{d:'Ritsurin Koen, Shikoku Mura museum',p:500},note:"One of Japan's best gardens",done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:6,dt:'6-23-2026',loc:'Takamatsu ‚Üí Shodoshima',acc:{n:'Sen Guesthouse (2n)',p:10500},trn:{d:'Local, ferries, bus',p:2440},food:{d:'Conbini',p:0},act:{d:'Morning: Megijima & Takamatsu castle',p:200},note:'Plan ahead',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:7,dt:'6-24-2026',loc:'Shodoshima Island',acc:{n:'Sen Guesthouse',p:0},trn:{d:'Local buses',p:0},food:{d:'Local restaurants',p:1500},act:{d:'Monkey Park and Kankakei Gorge',p:2000},note:'Beautiful gorge',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:8,dt:'6-25-2026',loc:'Daisen-oki National Park',acc:{n:'Yonago Universal Hotel',p:4200},trn:{d:'Bus, Ferry, train (3H)',p:7300},food:{d:'Local',p:1500},act:{d:'Daisen-oki National Park',p:0},note:'Early start',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:9,dt:'6-26-2026',loc:'Tottori',acc:{n:'Tottori hostel',p:4500},trn:{d:'Yonago‚ÜíTottori',p:1700},food:{d:'Local',p:1500},act:{d:'Tottori sand dunes, Uradome Coast',p:0},note:'Famous sand dunes',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:10,dt:'6-27-2026',loc:'Himeji',acc:{n:'Hotel Livemax Himeji',p:5000},trn:{d:'Tottori‚ÜíHimeji, local',p:500},food:{d:'Local',p:1500},act:{d:'Himeji Castle and Kokoen Garden',p:0},note:'UNESCO castle',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:11,dt:'6-28-2026',loc:'Mount Seppiko',acc:{n:'Green Station Mt Seppiko',p:12000},trn:{d:'Local',p:500},food:{d:'Local',p:1500},act:{d:'Mt Seppiko full day hike 8-10hrs',p:0},note:'Challenging hike',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:12,dt:'6-29-2026',loc:'Kobe',acc:{n:'Capsule Inn Osaka',p:3000},trn:{d:'Bus to Himeji‚ÜíKobe',p:990},food:{d:'Kobe Gyudon',p:3000},act:{d:'Sorakuen Koen, Chinatown, Mt. Rokko',p:0},note:'Kobe beef!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:13,dt:'6-30-2026',loc:'Osaka',acc:{n:'Capsule Inn Osaka',p:2500},trn:{d:'Kobe‚ÜíOsaka',p:400},food:{d:'Local food',p:1500},act:{d:'Minoo Park, Osaka Castle',p:600},note:'Beautiful waterfall',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:14,dt:'7-1-2026',loc:'Osaka',acc:{n:'Capsule Inn Osaka',p:2500},trn:{d:'Local',p:250},food:{d:'Local food',p:1500},act:{d:'Minami district',p:0},note:'Dotonbori at night',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:15,dt:'7-2-2026',loc:'Osaka',acc:{n:'Capsule Inn Osaka',p:2500},trn:{d:'Local',p:250},food:{d:'Local food',p:1500},act:{d:'Universal Studios Japan',p:8000},note:'Arrive early',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:16,dt:'7-3-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto (5n)',p:6000},trn:{d:'Osaka‚ÜíKyoto, local',p:1100},food:{d:'Hotel breakfast, local',p:1000},act:{d:'Nijo Castle, Kiyomizudera',p:1500},note:'Temple exploration',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:17,dt:'7-4-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto',p:6000},trn:{d:'Local',p:500},food:{d:'Hotel breakfast, local',p:1000},act:{d:"Ginkakuji, Philosopher's Path",p:500},note:'Canal walk',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:18,dt:'7-5-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto',p:6000},trn:{d:'Local',p:500},food:{d:'Hotel breakfast, local',p:1000},act:{d:'Fushimi Inari Shrine, bamboo forest',p:1000},note:'1000 torii gates',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:19,dt:'7-6-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto',p:6000},trn:{d:'Local',p:500},food:{d:'Hotel breakfast/conbini',p:500},act:{d:'Arashiyama, Yoshiminedera',p:1500},note:'Bamboo grove',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:20,dt:'7-7-2026',loc:'Kyoto',acc:{n:'APA Hotel Kyoto',p:6000},trn:{d:'Local',p:500},food:{d:'Hotel breakfast, local',p:1000},act:{d:'Free day - explore more',p:0},note:'Catch up',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:21,dt:'7-8-2026',loc:'Maibara ‚Üí Kanazawa',acc:{n:'Kanazawa Capsule Hotel',p:2500},trn:{d:'Kyoto‚ÜíMaibara‚ÜíKanazawa',p:8200},food:{d:'Local',p:1000},act:{d:'Mt. Ibuki day hike',p:0},note:'Long travel day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:22,dt:'7-9-2026',loc:'Kanazawa',acc:{n:'Kanazawa Capsule Hotel',p:2500},trn:{d:'Local transport',p:0},food:{d:'Local',p:1500},act:{d:'Kenrokuen, Nagamachi',p:500},note:'Great garden',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:23,dt:'7-10-2026',loc:'Takayama',acc:{n:'APA Hotel Takaoka (2n)',p:4000},trn:{d:'Kanazawa‚ÜíTakayama round trip',p:13000},food:{d:'Local',p:2000},act:{d:'Hida Folk Village, Old Town',p:800},note:'Preserved town',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:24,dt:'7-11-2026',loc:'Kurobe',acc:{n:'APA Hotel Takaoka',p:4000},trn:{d:'Takaoka‚ÜíKurobe round trip',p:2400},food:{d:'Hotel breakfast',p:1000},act:{d:'Kurobe Gorge',p:2500},note:'Scenic railway',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:25,dt:'7-12-2026',loc:'Tateyama Alpine Route',acc:{n:'Hotel M Matsumoto',p:3500},trn:{d:'Alpine Route‚ÜíMatsumoto',p:17500},food:{d:'Buy food before',p:2000},act:{d:'Tateyama Alpine Route - snow walls',p:0},note:'Epic day!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:26,dt:'7-13-2026',loc:'Shimosuwa',acc:{n:'Masuya Guesthouse (2d)',p:3500},trn:{d:'Matsumoto‚ÜíShimosuwa',p:500},food:{d:'Local',p:3000},act:{d:'Matsumoto Castle, onsens',p:0},note:'Relaxing onsen',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:27,dt:'7-14-2026',loc:'Shimosuwa',acc:{n:'Masuya Guesthouse',p:3500},trn:{d:'Bike rental',p:1000},food:{d:'Local',p:3000},act:{d:'Bike around Lake Suwa',p:0},note:'Lake views',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:28,dt:'7-15-2026',loc:'Nakasendo ‚Üí Kawaguchiko',acc:{n:'Hotel Fuyokaku',p:5500},trn:{d:'Shimosuwa‚ÜíNakatsugawa‚ÜíFuji',p:11600},food:{d:'Local',p:2000},act:{d:'Nakasendo samurai trail',p:0},note:'Historic trail',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:29,dt:'7-16-2026',loc:'Mount Fuji',acc:{n:'Hotel Fuyokaku',p:5500},trn:{d:'Bus to Mt Fuji',p:3000},food:{d:'Local',p:2000},act:{d:'Climb Mount Fuji 6:30am',p:4000},note:'Epic! Warm clothes',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:30,dt:'7-17-2026',loc:'Kawaguchiko Lake',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Kawaguchiko‚ÜíTokyo',p:5700},food:{d:'Local',p:2000},act:{d:'Explore lakes, Oshino Hakkai',p:300},note:'Last Mt Fuji views',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:31,dt:'7-18-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:"Mom's Touch, local",p:3000},act:{d:'Tokyo Ramen St, Imperial Palace',p:2000},note:'Electric atmosphere!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:32,dt:'7-19-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Asakusa, Edo Museum, Skytree',p:5000},note:'Big day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:33,dt:'7-20-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Shibuya, Shinjuku, Gyoen',p:500},note:'Famous crossing',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:34,dt:'7-21-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Odaiba, temples',p:2000},note:'Waterfront',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:35,dt:'7-22-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Jinbocho, Kawagoe',p:2000},note:'Flexible day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:36,dt:'7-23-2026',loc:'Tokyo',acc:{n:'APA Tokyo Hotel',p:6000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Free day',p:2000},note:'Entertainment',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:37,dt:'7-24-2026',loc:'Tokyo ‚Üí Hitachi',acc:{n:'Toyoko Inn Hitachi',p:5200},trn:{d:'Tokyo‚ÜíHitachi',p:5000},food:{d:'Local',p:3000},act:{d:'Free morning, travel afternoon',p:0},note:'Travel day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:38,dt:'7-25-2026',loc:'Ibaraki',acc:{n:'Toyoko Inn Hitachi',p:5200},trn:{d:'Local',p:500},food:{d:'Local',p:2000},act:{d:'Hitachi Seaside Park',p:0},note:'Kochia bushes',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:39,dt:'7-26-2026',loc:'Northern Ibaraki',acc:{n:'Toyoko Inn Hitachi',p:5200},trn:{d:'Local',p:500},food:{d:'Local',p:2000},act:{d:'Hananuki Gorge, hiking',p:0},note:'Less touristy',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:40,dt:'7-27-2026',loc:'Daigo',acc:{n:'Hotel Okukujikan',p:9000},trn:{d:'Hitachi‚ÜíDaigo',p:1700},food:{d:'Local',p:2000},act:{d:'Fukuroda Falls, onsens',p:0},note:'Waterfall',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:41,dt:'7-28-2026',loc:'Oyama & Utsunomiya',acc:{n:'Nikko area',p:0},trn:{d:'Daigo‚ÜíOyama‚ÜíUtsunomiya',p:2900},food:{d:'Local',p:2000},act:{d:'Explore both cities',p:0},note:'City exploration',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:42,dt:'7-29-2026',loc:'Nikko',acc:{n:'Nikko accommodation',p:10000},trn:{d:'Utsunomiya‚ÜíNikko',p:800},food:{d:'Local',p:2000},act:{d:'Toshogu Shrine, Kirifuri Falls',p:0},note:'UNESCO site',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:43,dt:'7-30-2026',loc:'Nikko',acc:{n:'Nikko accommodation',p:10000},trn:{d:'Local',p:500},food:{d:'Local',p:3000},act:{d:'Okunikko - waterfalls, lakes',p:0},note:'Lake Chuzenji',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:44,dt:'7-31-2026',loc:'Takasaki',acc:{n:'Hotel Select Inn',p:5000},trn:{d:'Nikko‚ÜíTakasaki',p:3000},food:{d:'Local',p:2000},act:{d:'Hodota Kofun-gun tomb',p:1300},note:'Ancient burial mounds',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:45,dt:'8-1-2026',loc:'Shima Onsen',acc:{n:'Shima Yamaguchikan',p:22000},trn:{d:'Takasaki‚ÜíShima Onsen',p:500},food:{d:'Ryokan included',p:0},act:{d:'BIRTHDAY! Onsens',p:1000},note:'BIRTHDAY!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:46,dt:'8-2-2026',loc:'Shima ‚Üí Numata',acc:{n:'Minpaku Sarai Nikkoya',p:3000},trn:{d:'Bus‚ÜíTakasaki‚ÜíNumata',p:1100},food:{d:'Local',p:2000},act:{d:'Stay late, public baths',p:0},note:'Last morning',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:47,dt:'8-3-2026',loc:'Oze National Park',acc:{n:'Minpaku Sarai Nikkoya',p:3000},trn:{d:'Numata‚ÜíOze bus',p:0},food:{d:'Local',p:2000},act:{d:'Oze hiking - marshlands',p:0},note:'Beautiful hiking',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:48,dt:'8-4-2026',loc:'Yonezawa',acc:{n:'Yonezawa accommodation',p:5000},trn:{d:'Numata‚ÜíYonezawa',p:900},food:{d:'Local ramen',p:2000},act:{d:'Rental bike, trails',p:1000},note:'Explore',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:49,dt:'8-5-2026',loc:'Muikamachi ‚Üí Fukushima',acc:{n:'APA Fukushima',p:5000},trn:{d:'Numata‚ÜíMuikamachi‚ÜíTokamachi',p:2600},food:{d:'Local',p:1000},act:{d:'Bike to Unt≈çan, Kiyotsu Gorge',p:500},note:'Scenic gorge',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:50,dt:'8-6-2026',loc:'Takahata ‚Üí Yamagata',acc:{n:'Yamagata APA',p:5500},trn:{d:'Trains and buses',p:2500},food:{d:'Local',p:2000},act:{d:'Day trip to Yamagata',p:0},note:'Rural Japan',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:51,dt:'8-7-2026',loc:'Yamagata',acc:{n:'Yamagata APA',p:5500},trn:{d:'Buses, local',p:1000},food:{d:'Local',p:2000},act:{d:'Mt Zao, Basho Museum',p:1000},note:'Crater lake',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:52,dt:'8-8-2026',loc:'Sendai',acc:{n:'Capsule Hotel 9H',p:3300},trn:{d:'Yamagata‚ÜíSendai',p:1300},food:{d:'Local',p:1000},act:{d:'Omoshiroyama, Great Akiu Falls',p:0},note:'Good food',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:53,dt:'8-9-2026',loc:'Sendai Day 2',acc:{n:'Capsule Hotel 9H',p:3300},trn:{d:'Local',p:500},food:{d:'Gyutan beef tongue',p:2000},act:{d:'Matsushima Bay',p:0},note:'Three great views',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:54,dt:'8-10-2026',loc:'Train to Tokyo',acc:{n:'None',p:0},trn:{d:'Sendai‚ÜíTokyo',p:0},food:{d:'Local',p:1000},act:{d:'Prepare for flight',p:0},note:'Last day',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false},
                {d:55,dt:'8-11-2026',loc:'Flight Home',acc:{n:'Flight',p:0},trn:{d:'Flight 7:45am',p:0},food:{d:'Airport food',p:1000},act:{d:'Sayonara Japan! üëãüáØüáµ',p:0},note:'End of adventure!',done:false,a:{acc:0,trn:0,food:0,act:0},photos:[],journalNote:'',schedule:[],showSchedule:false}
            ]
        };
        
        const CURRENCIES = {
            'JPY': { name: 'Japanese Yen', symbol: '¬•' },
            'EUR': { name: 'Euro', symbol: '‚Ç¨' },
            'GBP': { name: 'British Pound', symbol: '¬£' },
            'CAD': { name: 'Canadian Dollar', symbol: 'CA$' },
            'AUD': { name: 'Australian Dollar', symbol: 'A$' },
            'CHF': { name: 'Swiss Franc', symbol: 'CHF' },
            'CNY': { name: 'Chinese Yuan', symbol: '¬•' },
            'KRW': { name: 'South Korean Won', symbol: '‚Ç©' },
            'MXN': { name: 'Mexican Peso', symbol: 'MX$' },
            'INR': { name: 'Indian Rupee', symbol: '‚Çπ' }
        };

        const CACHE_NAME = 'trip-budget-v1';
        const urlsToCache = ['/'];

        self.addEventListener('install', event => {
        event.waitUntil(
            caches.open(CACHE_NAME)
            .then(cache => cache.addAll(urlsToCache))
        );
        });

        self.addEventListener('fetch', event => {
        event.respondWith(
            caches.match(event.request)
            .then(response => response || fetch(event.request))
        );
        });
        
        const fetchLiveRate = async () => {
            if (!DATA.liveRate) return;
            
            try {
                const response = await fetch(`https://open.exchangerate-api.com/v6/latest/USD`);
                const data = await response.json();
                
                if (data.rates && data.rates[DATA.currency]) {
                    DATA.rate = data.rates[DATA.currency];
                    DATA.lastFetchedRate = new Date().toLocaleString();
                    saveToStorage();
                    render();
                }
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
            }
        };

        const changeCurrency = (newCurrency) => {
            DATA.currency = newCurrency;
            DATA.currencySymbol = CURRENCIES[newCurrency].symbol;
            if (DATA.liveRate) {
                fetchLiveRate();
            } else {
                saveToStorage();
                render();
            }
        };

       const updateTravelerCount = (change) => {
            const newCount = Math.max(1, DATA.travelerCount + change);
            DATA.travelerCount = newCount;
            
            // Adjust travelers array
            if (newCount > DATA.travelers.length) {
                for (let i = DATA.travelers.length; i < newCount; i++) {
                    DATA.travelers.push(`Traveler ${i + 1}`);
                }
            } else {
                DATA.travelers = DATA.travelers.slice(0, newCount);
            }
            
            saveToStorage();
            render();
        };

        const updateTravelerName = (idx, name) => {
            DATA.travelers[idx] = name;
            saveToStorage();
        };

        const setCostSplitMode = (mode) => {
            DATA.costSplitMode = mode;
            saveToStorage();
            debouncedRender(); // Changed from render()

        };

        const getWeatherIcon = (condition) => {
            const icons = {
                'clear': '‚òÄÔ∏è',
                'clouds': '‚òÅÔ∏è',
                'rain': 'üåßÔ∏è',
                'drizzle': 'üå¶Ô∏è',
                'thunderstorm': '‚õàÔ∏è',
                'snow': '‚ùÑÔ∏è',
                'mist': 'üå´Ô∏è',
                'fog': 'üå´Ô∏è',
                'haze': 'üå´Ô∏è'
            };
            
            const conditionLower = condition.toLowerCase();
            for (let key in icons) {
                if (conditionLower.includes(key)) {
                    return icons[key];
                }
            }
            return 'üå§Ô∏è';
        };

        const fetchWeather = async (dayIndex) => {
            const day = DATA.days[dayIndex];
            const location = day.loc.split('‚Üí')[0].trim().split(',')[0].trim(); // Get first location
            
            DATA.days[dayIndex].weatherLoading = true;
            render();
            
            try {
                // First, get coordinates for the location
                const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1&language=en&format=json`);
                const geoData = await geoResponse.json();
                
                if (!geoData.results || geoData.results.length === 0) {
                    throw new Error('Location not found');
                }
                
                const { latitude, longitude, name } = geoData.results[0];
                
                // Parse the date from the day
                const dateParts = day.dt.split('-'); // Assuming format like "6-18-2026"
                const month = dateParts[0].padStart(2, '0');
                const dayNum = dateParts[1].padStart(2, '0');
                const year = dateParts[2];
                const targetDate = `${year}-${month}-${dayNum}`;
                
                // Get weather forecast for that specific date
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode,windspeed_10m_max&timezone=auto&start_date=${targetDate}&end_date=${targetDate}`
                );
                const weatherData = await weatherResponse.json();
                
                if (weatherData.daily) {
                    const tempMax = Math.round((weatherData.daily.temperature_2m_max[0] * 9/5) + 32);
                    const tempMin = Math.round((weatherData.daily.temperature_2m_min[0] * 9/5) + 32);
                    const tempMaxC = Math.round(weatherData.daily.temperature_2m_max[0]);
                    const tempMinC = Math.round(weatherData.daily.temperature_2m_min[0]);
                    const weatherCode = weatherData.daily.weathercode[0];
                    const windSpeed = Math.round(weatherData.daily.windspeed_10m_max[0] * 0.621371); // km/h to mph
                    const precipitation = weatherData.daily.precipitation_sum[0];
                    
                    // Weather code to condition mapping
                    const getWeatherCondition = (code) => {
                        if (code === 0) return { condition: 'Clear sky', icon: '‚òÄÔ∏è' };
                        if (code <= 3) return { condition: 'Partly cloudy', icon: '‚õÖ' };
                        if (code <= 48) return { condition: 'Foggy', icon: 'üå´Ô∏è' };
                        if (code <= 57) return { condition: 'Drizzle', icon: 'üå¶Ô∏è' };
                        if (code <= 67) return { condition: 'Rain', icon: 'üåßÔ∏è' };
                        if (code <= 77) return { condition: 'Snow', icon: '‚ùÑÔ∏è' };
                        if (code <= 82) return { condition: 'Rain showers', icon: 'üåßÔ∏è' };
                        if (code <= 86) return { condition: 'Snow showers', icon: 'üå®Ô∏è' };
                        if (code <= 99) return { condition: 'Thunderstorm', icon: '‚õàÔ∏è' };
                        return { condition: 'Unknown', icon: 'üå§Ô∏è' };
                    };
                    
                    const { condition, icon } = getWeatherCondition(weatherCode);
                    
                    DATA.days[dayIndex].weather = {
                        temp: tempMax,
                        tempMin: tempMin,
                        tempC: tempMaxC,
                        tempMinC: tempMinC,
                        condition: condition,
                        icon: icon,
                        windSpeed: windSpeed,
                        precipitation: precipitation,
                        location: name
                    };
                }
            } catch (error) {
                console.error('Weather fetch failed:', error);
                DATA.days[dayIndex].weather = { error: `Unable to fetch weather for ${location}` };
            }
            
            DATA.days[dayIndex].weatherLoading = false;
            saveToStorage();
            render();
        };

        const formatCostWithSplit = (amount) => {
            if (DATA.costSplitMode === 'perPerson' && DATA.travelerCount > 1) {
                const perPerson = amount / DATA.travelerCount;
                return `${DATA.currencySymbol}${amount.toLocaleString()} <span class="per-person-cost">${DATA.currencySymbol}${perPerson.toFixed(0)}/person</span>`;
            }
            return `${DATA.currencySymbol}${amount.toLocaleString()}`;
        };
        
        const calc = (d) => {
            let total = 0;
            DATA.categories.forEach(cat => {
                total += d[cat.id]?.p || 0;
            });
            return total;
        };

        const calcA = (d) => {
            let total = 0;
            DATA.categories.forEach(cat => {
                total += d.a?.[cat.id] || 0;
            });
            return total;
        };


        const addDay = () => {
            const newDay = {
                d: DATA.days.length + 1,
                dt: 'MM-DD-YYYY',
                loc: 'New Location',
                acc: {n: 'Accommodation', p: 0},
                trn: {d: 'Transportation', p: 0},
                food: {d: 'Food', p: 0},
                act: {d: 'Activities', p: 0},
                note: '',
                done: false,
                a: {acc: 0, trn: 0, food: 0, act: 0},
                photos: [],
                receipts: [],
                journalNote: '',
                schedule: [],
                showSchedule: false,
                scheduleView: 'list',
                weather: null,
                weatherLoading: false,
            };
            DATA.days.push(newDay);
            saveToStorage();
            render();
        };

        const deleteDay = (idx) => {
            if (confirm(`Delete Day ${DATA.days[idx].d} - ${DATA.days[idx].loc}?`)) {
                DATA.days.splice(idx, 1);
                // Renumber remaining days
                DATA.days.forEach((day, i) => {
                    day.d = i + 1;
                });
                if (DATA.expanded === idx) DATA.expanded = null;
                saveToStorage();
                render();
            }
        };

        const duplicateDay = (idx) => {
            const original = DATA.days[idx];
            const duplicate = {
                ...original,
                d: DATA.days.length + 1,
                done: false,
                a: {acc: 0, trn: 0, food: 0, act: 0},
                photos: [],
                journalNote: '',
                schedule: [...original.schedule],
                acc: {...original.acc},
                trn: {...original.trn},
                food: {...original.food},
                act: {...original.act}
            };
            DATA.days.push(duplicate);
            saveToStorage();
            render();
        };
        
        const stats = () => {
            let tP = 0, tA = 0, done = 0;
            let catP = {};
            let catA = {};
            let itemsP = {};
            let itemsA = {};
            
            // Initialize categories
            DATA.categories.forEach(cat => {
                catP[cat.id] = 0;
                catA[cat.id] = 0;
                itemsP[cat.id] = [];
                itemsA[cat.id] = [];
            });
            
            let fixedCosts = 0;
            
            DATA.days.forEach(d => {
                if(d.done) done++;
                
                DATA.categories.forEach(cat => {
                    const pVal = d[cat.id]?.p || 0;
                    const aVal = d.a?.[cat.id] || 0;
                    
                    tP += pVal;
                    tA += aVal;
                    catP[cat.id] += pVal;
                    catA[cat.id] += aVal;
                    
                    // For fixed costs, use first two categories (typically accommodation and transport)
                    if (DATA.categories.indexOf(cat) < 2) {
                        fixedCosts += pVal;
                    }
                    
                    if(pVal > 0) {
                        itemsP[cat.id].push({
                            day: d.d, 
                            name: (d[cat.id]?.n || d[cat.id]?.d || 'Item').substring(0,40), 
                            value: pVal
                        });
                    }
                    
                    if(aVal > 0) {
                        itemsA[cat.id].push({
                            day: d.d, 
                            name: (d[cat.id]?.n || d[cat.id]?.d || 'Item').substring(0,40), 
                            value: aVal
                        });
                    }
                });
            });
            
            const tBudget = DATA.budget * DATA.rate;
            const remaining = tBudget - tA;
            const daysLeft = DATA.days.length - done;
            const avgDailySpent = done > 0 ? tA / done : 0;
            const avgDailyBudget = tP / DATA.days.length;
            const variableRemaining = remaining - (fixedCosts - (catA[DATA.categories[0]?.id || 'acc'] + catA[DATA.categories[1]?.id || 'trn']));
            const canSpendPerDay = daysLeft > 0 ? variableRemaining / daysLeft : 0;
            
            return { 
                tP, tA, done, 
                rem: remaining, 
                pct: (tA / tBudget * 100), 
                estRem: tBudget - tP, 
                estPct: (tP / tBudget * 100), 
                over: tP > tBudget, 
                daysLeft, 
                avgDailySpent, 
                avgDailyBudget, 
                canSpendPerDay, 
                catP, 
                catA,
                itemsP,
                itemsA
            };
        };
        
        const update = (i, cat, k, v) => {
            if(k === 'p') {
                DATA.days[i][cat][k] = parseFloat(v) || 0;
            } else if(k === 'd' || k === 'n') {
                DATA.days[i][cat][k] = v;
            } else if(cat === 'base') {
                DATA.days[i][k] = k === 'd' ? parseInt(v) : v;
            } else if(DATA.days[i].a && ['acc','trn','food','act'].includes(cat)) {
                DATA.days[i].a[cat] = parseFloat(v) || 0;
            }
            saveToStorage();
            render();
        };
        
        const updateJournal = (i, v) => { 
            DATA.days[i].journalNote = v; 
            saveToStorage(); 
        };
        
        const addPhoto = (i, dataUrl) => { 
            if (!DATA.days[i].photos) DATA.days[i].photos = []; 
            DATA.days[i].photos.push(dataUrl); 
            saveToStorage(); 
            render(); 
        };
        
        const deletePhoto = (i, photoIdx) => { 
            DATA.days[i].photos.splice(photoIdx, 1); 
            saveToStorage(); 
            render(); 
        };
        
        const handlePhotoUpload = (i, e) => { 
            const file = e.target.files[0]; 
            if (file) { 
                const reader = new FileReader(); 
                reader.onload = (event) => { 
                    addPhoto(i, event.target.result); 
                }; 
                reader.readAsDataURL(file); 
            } 
        };
        
        const addScheduleItem = (i) => { 
            if (!DATA.days[i].schedule) DATA.days[i].schedule = []; 
            DATA.days[i].schedule.push({time: '09:00', activity: ''}); 
            saveToStorage(); 
            render(); 
        };
        
        const updateSchedule = (i, idx, field, value) => { 
            DATA.days[i].schedule[idx][field] = value; 
            saveToStorage(); 
        };
        
        const deleteSchedule = (i, idx) => { 
            DATA.days[i].schedule.splice(idx, 1); 
            saveToStorage(); 
            render(); 
        };
        
        const openPhotoModal = (photo) => { 
            DATA.photoModal = photo; 
            render(); 
        };
        
        const closePhotoModal = () => { 
            DATA.photoModal = null; 
            render(); 
        };
        
        const highlightText = (text, query) => {
            if (!query) return text;
            const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escaped})`, 'gi');
            return text.replace(regex, '<span class="search-result-highlight">$1</span>');
        };
        
        const jumpToDay = (dayIndex) => {
            DATA.expanded = dayIndex;
            DATA.showSearchResults = false;
            DATA.searchQuery = '';
            render();
            setTimeout(() => {
                const dayCard = document.querySelector(`.day-card[data-day="${dayIndex}"]`);
                if (dayCard) {
                    dayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        };
        
        const saveToStorage = () => { 
            try { 
                localStorage.setItem('japan-trip-data', JSON.stringify(DATA)); 
            } catch (e) { 
                console.error('Save failed:', e); 
            } 
        };
        
        const loadFromStorage = () => { 
            try { 
                const stored = localStorage.getItem('japan-trip-data'); 
                if (stored) { 
                    const loaded = JSON.parse(stored); 
                    Object.keys(loaded).forEach(key => { 
                        DATA[key] = loaded[key]; 
                    }); 
                } 
                DATA.days.forEach(day => { 
                    if (!day.photos) day.photos = []; 
                    if (!day.journalNote) day.journalNote = ''; 
                    if (!day.schedule) day.schedule = []; 
                    if (day.showSchedule === undefined) day.showSchedule = false; 
                    if (day.scheduleView === undefined) day.scheduleView = 'list';
                    if (!day.weather) day.weather = null;
                    if (!day.weatherLoading) day.weatherLoading = false;
                }); 
                if (!DATA.tripSubtitle) DATA.tripSubtitle = 'June 18 - August 11, 2026';
                if (!DATA.tripNotes) DATA.tripNotes = '';
                if (!DATA.packingList) DATA.packingList = [];
                if (!DATA.categoryBudgets) DATA.categoryBudgets = {acc: 0, trn: 0, food: 0, act: 0};
                if (!DATA.travelers) DATA.travelers = ['Traveler 1'];
                if (!DATA.travelerCount) DATA.travelerCount = 1;
                if (!DATA.costSplitMode) DATA.costSplitMode = 'total';
                if (!DATA.beforeChecklist || DATA.beforeChecklist.length === 0) {
                            DATA.beforeChecklist = [{item: 'Book flights', checked: false}, {item: 'Get travel insurance', checked: false}];
                        } else if (typeof DATA.beforeChecklist[0] === 'string') {
                            // Convert old string format to new object format
                            DATA.beforeChecklist = DATA.beforeChecklist.map(item => ({ item, checked: false }));
                        }
                        
                if (!DATA.tripChecklist || DATA.tripChecklist.length === 0) {
                            DATA.tripChecklist = [{item: 'Charge electronics', checked: false}, {item: 'Pack passport', checked: false}];
                        } else if (typeof DATA.tripChecklist[0] === 'string') {
                            // Convert old string format to new object format
                            DATA.tripChecklist = DATA.tripChecklist.map(item => ({ item, checked: false }));
                        }
            } catch (e) { 
                console.error('Load failed:', e); 
            } 
        };

        const ICON_OPTIONS = ['üè®', 'üöÜ', 'üç±', 'üó∫', 'üéÅ', 'üíä', 'üéí', '‚úàÔ∏è', 'üöó', 'üèñÔ∏è', '‚õ∞Ô∏è', 'üé≠', 'üé®', 'üé™', 'üé¢', 'üèõÔ∏è', '‚õ©Ô∏è', 'üïå', 'üí∞', 'üõçÔ∏è', 'üì±', 'üíª', 'üì∑', 'üéµ', 'üéÆ', '‚öΩ', 'üèä', 'üßò', 'üíà', 'üîß', 'üè•', 'üí≥', 'üìö', 'üéì', 'üîë', 'üé´'];
       
        const addCategory = () => {
            const newId = 'cat_' + Date.now();
            DATA.categories.push({
                id: newId,
                name: 'New Category',
                icon: 'üì¶',
                color: '#6b7280'
            });
            DATA.categoryBudgets[newId] = 0;
            
            // Add to all existing days
            DATA.days.forEach(day => {
                day[newId] = {d: '', p: 0};
                day.a[newId] = 0;
            });
            
            saveToStorage();
            render();
        };

        const deleteCategory = (catId) => {
            if (DATA.categories.length <= 1) {
                alert("You must have at least one category!");
                return;
            }
            
            if (confirm(`Delete this category? This will remove it from all days.`)) {
                DATA.categories = DATA.categories.filter(c => c.id !== catId);
                delete DATA.categoryBudgets[catId];
                
                // Remove from all days
                DATA.days.forEach(day => {
                    delete day[catId];
                    delete day.a[catId];
                });
                
                saveToStorage();
                render();
            }
        };

        const updateCategory = (catId, field, value) => {
            const cat = DATA.categories.find(c => c.id === catId);
            if (cat) {
                cat[field] = value;
                saveToStorage();
                debouncedRender(); // Changed from render()

            }
        };

        const openIconPicker = (catId) => {
            DATA.iconPickerOpen = true;
            DATA.iconPickerCategory = catId;
            render();
        };

        const closeIconPicker = () => {
            DATA.iconPickerOpen = false;
            DATA.iconPickerCategory = null;
            render();
        };

        const selectIcon = (icon) => {
            if (DATA.iconPickerCategory) {
                updateCategory(DATA.iconPickerCategory, 'icon', icon);
            }
            closeIconPicker();
        };

        const calculateTripDays = () => {
            const start = new Date(DATA.tripStartDate);
            const end = new Date(DATA.tripEndDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end
            return diffDays;
        };

        const updateTripDates = () => {
            const expectedDays = calculateTripDays();
            const currentDays = DATA.days.length;
            
            if (expectedDays !== currentDays) {
                if (confirm(`Trip length changed to ${expectedDays} days. Current itinerary has ${currentDays} days. Adjust number of days?`)) {
                    if (expectedDays > currentDays) {
                        // Add days
                        for (let i = currentDays; i < expectedDays; i++) {
                            const newDay = {
                                d: i + 1,
                                dt: 'MM-DD-YYYY',
                                loc: 'New Location',
                                note: '',
                                done: false,
                                a: {},
                                photos: [],
                                journalNote: '',
                                schedule: [],
                                showSchedule: false,
                                scheduleView: 'list',
                                weather: null,
                                weatherLoading: false
                            };
                            
                            // Add all category fields
                            DATA.categories.forEach(cat => {
                                newDay[cat.id] = {d: '', p: 0};
                                newDay.a[cat.id] = 0;
                            });
                            
                            DATA.days.push(newDay);
                        }
                    } else {
                        // Remove days
                        DATA.days = DATA.days.slice(0, expectedDays);
                    }
                    
                    saveToStorage();
                    render();
                }
            } else {
                saveToStorage();
                render();
            }
        };
        
        const exp = () => { 
            let csv = 'Day,Date,Location,Category,Planned,Actual,Diff,Planned$,Actual$,Done\n'; 
            DATA.days.forEach(d => { 
                ['acc','trn','food','act'].forEach(c => { 
                    const p = d[c].p, a = d.a[c]; 
                    csv += `${d.d},${d.dt},${d.loc},${c},${p},${a},${a-p},${(p/DATA.rate).toFixed(2)},${(a/DATA.rate).toFixed(2)},${d.done}\n`; 
                }); 
            }); 
            const blob = new Blob([csv], {type:'text/csv'}); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = 'japan_trip_55days.csv'; 
            a.click(); 
        };
        
        const downloadHTML = () => { 
            const htmlContent = document.documentElement.outerHTML; 
            const updatedHTML = htmlContent.replace(/const DATA = \{[\s\S]*?\};/, `const DATA = ${JSON.stringify(DATA, null, 4)};`); 
            const blob = new Blob([updatedHTML], {type:'text/html'}); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = 'japan_trip_updated.html'; 
            a.click(); 
            URL.revokeObjectURL(url); 
        };

        const switchTab = (tab) => {
            const mapState = saveMapState();
            
            DATA.activeTab = tab;
            saveToStorage();
            render();
            
            restoreMapState(mapState);
        };
        // Make functions globally accessible

        let mapInstance = null;
        let markersLayer = null;
        let routeLayer = null;

        const initMap = () => {
            console.log('üó∫Ô∏è Initializing map...');
            
            if (mapInstance) {
                mapInstance.remove();
            }
            
            const mapElement = document.getElementById('tripMap');
            if (!mapElement) {
                console.error('Map element not found');
                return;
            }
            
            mapInstance = L.map('tripMap').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                maxZoom: 19
            }).addTo(mapInstance);
            
            markersLayer = L.layerGroup().addTo(mapInstance);
            routeLayer = L.layerGroup().addTo(mapInstance);
            
            DATA.mapInitialized = true;
            
            // Load from cache if available
            if (Object.keys(DATA.geocodedLocations).length > 0) {
                console.log('üìç Loading from cache:', Object.keys(DATA.geocodedLocations).length, 'locations');
                renderMapFromCache();
                
                // Update the location count
                const locationDiv = document.getElementById('mapTotalLocations');
                if (locationDiv) {
                    locationDiv.textContent = Object.keys(DATA.geocodedLocations).length;
                }
            } else {
                console.log('üìç No cache found, will geocode on refresh');
                const locationDiv = document.getElementById('mapTotalLocations');
                if (locationDiv) {
                    locationDiv.textContent = '0';
                }
            }
        };

        const renderMapFromCache = () => {
            if (!mapInstance || !markersLayer || !routeLayer) {
                console.error('Map not initialized');
                return;
            }
            
            console.log('üé® Rendering map from cache');
            
            markersLayer.clearLayers();
            routeLayer.clearLayers();
            draggableMarkers = {};
            
            const locations = [];
            let totalDistance = 0;
            
            // Group days by location
            const uniqueLocations = new Map();
            DATA.days.forEach(day => {
                const locationNames = day.loc.split('‚Üí').map(l => l.trim());
                locationNames.forEach(locName => {
                    if (!uniqueLocations.has(locName)) {
                        uniqueLocations.set(locName, []);
                    }
                    uniqueLocations.get(locName).push({d: day.d, dt: day.dt, loc: day.loc});
                });
            });
            
            // Add markers from cache
            for (const [locName, days] of uniqueLocations) {
                const coords = DATA.geocodedLocations[locName];
                if (coords) {
                    const marker = L.marker([coords.lat, coords.lng], {
                        draggable: DATA.mapEditMode
                    }).addTo(markersLayer);
                    
                    if (DATA.mapEditMode) {
                        marker.on('dragend', (e) => {
                            const newPos = e.target.getLatLng();
                            DATA.geocodedLocations[locName].lat = newPos.lat;
                            DATA.geocodedLocations[locName].lng = newPos.lng;
                            saveToStorage();
                            
                            // Update coordinates display in location list
                            const locationItems = document.querySelectorAll('.location-item');
                            locationItems.forEach(item => {
                                const nameDiv = item.querySelector('[data-location]');
                                if (nameDiv && nameDiv.dataset.location === locName) {
                                    const coordsDiv = item.querySelector('.location-coords');
                                    if (coordsDiv) {
                                        coordsDiv.textContent = `${newPos.lat.toFixed(4)}, ${newPos.lng.toFixed(4)}`;
                                    }
                                }
                            });
                            
                            // Redraw route if in route view
                            if (DATA.mapView === 'route') {
                                drawRoute();
                            }
                        });
                    }
                    
                    const daysList = days.map(d => `Day ${d.d} (${d.dt})`).join('<br>');
                    marker.bindPopup(`
                        <div class="location-marker-popup">
                            <strong>${coords.name}, ${coords.country}</strong>
                            <div style="margin-top:5px;font-size:12px;">${daysList}</div>
                            <div style="margin-top:5px;font-size:11px;color:#666;">
                                ${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}
                            </div>
                        </div>
                    `);
                    
                    draggableMarkers[locName] = marker;
                    locations.push(coords);
                }
            }
            
            // Add custom waypoints
            DATA.customWaypoints.forEach((waypoint, idx) => {
                const marker = L.marker([waypoint.lat, waypoint.lng], {
                    draggable: DATA.mapEditMode
                }).addTo(markersLayer);
                
                if (DATA.mapEditMode) {
                    marker.on('dragend', (e) => {
                        const newPos = e.target.getLatLng();
                        DATA.customWaypoints[idx].lat = newPos.lat;
                        DATA.customWaypoints[idx].lng = newPos.lng;
                        saveToStorage();
                    });
                }

                const popupContent = `
                    <div class="location-marker-popup">
                        <strong>üìå ${waypoint.name}</strong>
                        <div style="margin-top:5px;font-size:11px;color:#666;">
                            ${waypoint.lat.toFixed(4)}, ${waypoint.lng.toFixed(4)}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                if (DATA.mapEditMode) {
                    marker.on('popupopen', () => {
                        const deleteBtn = document.getElementById(`deleteWaypoint_${idx}`);
                        const editBtn = document.getElementById(`editWaypointCoords_${idx}`);
                        
                        if (deleteBtn) {
                            deleteBtn.onclick = () => {
                                marker.closePopup();
                                if (confirm(`Delete waypoint "${waypoint.name}"?`)) {
                                    DATA.customWaypoints.splice(idx, 1);
                                    saveToStorage();
                                    renderMapFromCache();
                                }
                            };
                        }
                        
                        if (editBtn) {
                            editBtn.onclick = () => {
                                marker.closePopup();
                                editWaypointCoords(idx);
                            };
                        }
                    });
                }
            });
            
            // Draw route if needed
            if (DATA.mapView === 'route') {
                totalDistance = drawRoute();
            }
            
            // Fit bounds
            if (locations.length > 0) {
                const bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lng]));
                mapInstance.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Update stats
            updateMapStats(locations.length, totalDistance);
        };

        const geocodeLocation = async (location, dayIndex) => {
            if (DATA.geocodedLocations[location]) {
                return DATA.geocodedLocations[location];
            }
            
            try {
                // Add timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1&language=en&format=json`,
                    { signal: controller.signal }
                );
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const result = {
                        lat: data.results[0].latitude,
                        lng: data.results[0].longitude,
                        name: data.results[0].name,
                        country: data.results[0].country
                    };
                    
                    DATA.geocodedLocations[location] = result;
                    saveToStorage();
                    return result;
                }
            } catch (error) {
                console.error('Geocoding failed for', location, error);
            }
            
            return null;
};

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            // Haversine formula to calculate distance between two points
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance; // in kilometers
        };

        const updateMap = async () => {
            if (!mapInstance || !markersLayer || !routeLayer) return;

            console.log('üó∫Ô∏è Starting map update...');
            console.log('üìç Geocoded locations in cache:', Object.keys(DATA.geocodedLocations).length);
            
            // Clear existing markers and routes
            markersLayer.clearLayers();
            routeLayer.clearLayers();
            
            const uniqueLocations = new Map(); // Use Map to deduplicate
            
            // Collect unique locations first (no geocoding yet)
            DATA.days.forEach(day => {
                const locationNames = day.loc.split('‚Üí').map(l => l.trim());
                locationNames.forEach(locName => {
                    if (!uniqueLocations.has(locName)) {
                        uniqueLocations.set(locName, {
                            name: locName,
                            days: []
                        });
                    }
                    uniqueLocations.get(locName).days.push({
                        d: day.d,
                        dt: day.dt,
                        loc: day.loc
                    });
                });
            });
            
            const locations = [];
            let totalDistance = 0;
            let geocoded = 0;
            
            // Geocode in sequence (to avoid rate limiting and lag)
            for (const [locName, locInfo] of uniqueLocations) {
                console.log('Geocoding:', locName);
                const coords = await geocodeLocation(locName);
                if (coords) {
                    console.log('‚úì Found:', locName, coords);
                    geocoded++;
                    
                    // Add marker immediately as we geocode
                    const marker = L.marker([coords.lat, coords.lng]).addTo(markersLayer);
                    
                    const daysList = locInfo.days.map(d => `Day ${d.d} (${d.dt})`).join('<br>');
                    marker.bindPopup(`
                        <div class="location-marker-popup">
                            <strong>${coords.name}, ${coords.country}</strong>
                            <div style="margin-top:5px;font-size:12px;">${daysList}</div>
                        </div>
                    `);
                    
                    locations.push({
                        ...coords,
                        days: locInfo.days
                    });
                    
                    // Update progress
                    document.getElementById('mapTotalLocations').textContent = `${geocoded}/${uniqueLocations.size}`;
                } else {
                    console.log('‚úó Failed:', locName);
                }
                // Small delay to prevent overwhelming the API
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            // Build route from day order (not unique locations)
            if (DATA.mapView === 'route' && locations.length > 1) {
                const routeCoords = [];
                let prevCoords = null;
                
                for (const day of DATA.days) {
                    const locName = day.loc.split('‚Üí')[0].trim();
                    const coords = DATA.geocodedLocations[locName];
                    
                    if (coords) {
                        const currentCoords = [coords.lat, coords.lng];
                        
                        // Only add if different from previous
                        if (!prevCoords || 
                            prevCoords[0] !== currentCoords[0] || 
                            prevCoords[1] !== currentCoords[1]) {
                            routeCoords.push(currentCoords);
                            
                            // Calculate distance from previous
                            if (prevCoords) {
                                const dist = calculateDistance(
                                    prevCoords[0], prevCoords[1],
                                    currentCoords[0], currentCoords[1]
                                );
                                totalDistance += dist;
                            }
                            
                            prevCoords = currentCoords;
                        }
                    }
                }
                
                if (routeCoords.length > 1) {
                    // Draw polyline
                    L.polyline(routeCoords, {
                        color: '#3b82f6',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(routeLayer);
                    
                    // Add direction arrows (fewer of them)
                    for (let i = 0; i < routeCoords.length - 1; i += Math.max(1, Math.floor(routeCoords.length / 10))) {
                        const midLat = (routeCoords[i][0] + routeCoords[i + 1][0]) / 2;
                        const midLng = (routeCoords[i][1] + routeCoords[i + 1][1]) / 2;
                        
                        L.marker([midLat, midLng], {
                            icon: L.divIcon({
                                html: '‚ûú',
                                className: 'route-arrow',
                                iconSize: [20, 20]
                            })
                        }).addTo(routeLayer);
                    }
                }
            }
            
            // Fit map to show all markers
            if (locations.length > 0) {
                const bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lng]));
                mapInstance.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Update final stats
            document.getElementById('mapTotalLocations').textContent = locations.length;
            document.getElementById('mapTotalDistance').textContent = 
                totalDistance > 0 ? `${totalDistance.toFixed(0)} km (${(totalDistance * 0.621371).toFixed(0)} mi)` : 'N/A';
            document.getElementById('mapTotalDays').textContent = DATA.days.length;
        };
       
       const updateMapStats = (locationCount, distance) => {
            const locationDiv = document.getElementById('mapTotalLocations');
            const distanceDiv = document.getElementById('mapTotalDistance');
            const daysDiv = document.getElementById('mapTotalDays');
            
            if (locationDiv) locationDiv.textContent = locationCount;
            if (distanceDiv) {
                distanceDiv.textContent = distance > 0 ? 
                    `${distance.toFixed(0)} km (${(distance * 0.621371).toFixed(0)} mi)` : 
                    'N/A';
            }
            if (daysDiv) daysDiv.textContent = DATA.days.length;
        };

        const switchMapView = (view) => {
            DATA.mapView = view;
            saveToStorage();
            
            // Update button states without full re-render
            document.querySelectorAll('.map-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (DATA.mapInitialized) {
                updateMap();
            }
        };

        const geocodeAllLocations = async () => {
            const btn = document.getElementById('geocodeBtn');
            if (btn) {
                btn.textContent = '‚è≥ Mapping...';
                btn.disabled = true;
            }
            
            // Show progress message
            document.getElementById('mapTotalLocations').textContent = 'Loading...';
            
            await updateMap();
            
            if (btn) {
                btn.textContent = '‚úì Complete';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh Map';
                    btn.disabled = false;
                }, 2000);
            }
        };

        const toggleMapEditMode = () => {
            DATA.mapEditMode = !DATA.mapEditMode;
            if (!DATA.mapEditMode) {
                DATA.editingLocation = null;
            }
            saveToStorage();
            
            // Update button manually
            const editBtn = Array.from(document.querySelectorAll('.map-btn')).find(b => b.textContent.includes('Edit') || b.textContent.includes('Done'));
            if (editBtn) {
                editBtn.classList.toggle('active', DATA.mapEditMode);
                editBtn.innerHTML = DATA.mapEditMode ? '‚úì Done Editing' : '‚úèÔ∏è Edit Map';
            }
            
            // Show/hide location list - but with the RIGHT layout
            const locationList = document.querySelector('.location-list');
            if (DATA.mapEditMode) {
                // Create and show location list with the nice layout
                if (!locationList) {
                    const statsDiv = document.querySelector('.route-stats');
                    if (statsDiv) {
                        const html = `
                            <div class="location-list">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                    <h4 style="font-size:14px;margin:0;">üìç Route Order</h4>
                                    <div style="display:flex;gap:8px;">
                                        <button class="btn" onclick="addManualLocation()" style="padding:4px 12px;font-size:12px;background:#10b981;">
                                            ‚ûï Add Location
                                        </button>
                                        <button class="btn" onclick="addCustomWaypoint()" style="padding:4px 12px;font-size:12px;background:#8b5cf6;">
                                            üìå Add Waypoint
                                        </button>
                                    </div>
                                </div>
                                <div style="font-size:12px;color:#666;margin-bottom:10px;">
                                    üí° Drag to reorder your route. Locations and waypoints in order from top to bottom.
                                </div>
                                ${getAllMapLocations().map(loc => `
                                    <div class="location-item" draggable="true" 
                                        data-location-id="${loc.id}"
                                        ondragstart="handleDragStart(event, '${loc.id}')"
                                        ondragover="handleDragOver(event)"
                                        ondrop="handleDrop(event, '${loc.id}')"
                                        ondragend="handleDragEnd(event)">
                                        <span class="location-drag-handle">‚ãÆ‚ãÆ</span>
                                        <div style="flex:1;">
                                            <div style="font-weight:600;font-size:13px;display:flex;align-items:center;gap:8px;">
                                                ${loc.type === 'waypoint' ? 'üìå' : 'üìç'} 
                                                <span data-location="${loc.id}">${loc.name}</span>
                                                ${loc.type === 'waypoint' ? '<span style="font-size:10px;background:#8b5cf6;color:white;padding:2px 6px;border-radius:4px;">WAYPOINT</span>' : ''}
                                            </div>
                                            <div class="location-coords">${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}</div>
                                        </div>
                                        <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `editWaypointInfo(${loc.waypointIndex})` : `editLocation('${loc.name}')`}" style="padding:4px 10px;font-size:11px;">‚úèÔ∏è Edit Name</button>
                                        <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `editWaypointCoords(${loc.waypointIndex})` : `editLocationCoords('${loc.name}')`}" style="padding:4px 10px;font-size:11px;background:#3b82f6;">üìç Edit Coords</button>
                                        <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `deleteWaypointFromList(${loc.waypointIndex})` : `deleteLocationFromCache('${loc.name}')`}" style="padding:4px 10px;font-size:11px;background:#ef4444;">üóëÔ∏è Delete</button>
                                    </div>
                                `).join('')}
                                ${getAllMapLocations().length === 0 ? `
                                    <div style="padding:20px;text-align:center;color:#999;font-size:13px;">
                                        No locations yet. Add locations or waypoints to plan your route.
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        statsDiv.insertAdjacentHTML('afterend', html);
                    }
                }
            } else {
                // Hide location list
                if (locationList) {
                    locationList.remove();
                }
            }
            
            // Redraw map with updated draggable state
            if (DATA.mapInitialized && Object.keys(DATA.geocodedLocations).length > 0) {
                renderMapFromCache();
            }
        };
        
        const addCustomWaypoint = () => {
            if (!mapInstance) {
                alert('Please wait for the map to load first!');
                return;
            }
            
            const center = mapInstance.getCenter();
            const waypointName = prompt('Enter waypoint name:', 'Custom Waypoint');
            
            if (!waypointName) return; // User cancelled
            
            DATA.customWaypoints.push({
                name: waypointName,
                lat: center.lat,
                lng: center.lng
            });
            
            saveToStorage();
            
            console.log('Added waypoint:', waypointName, 'Total waypoints:', DATA.customWaypoints.length);
            
            // Redraw the map to show the new waypoint
            if (DATA.mapInitialized) {
                renderMapFromCache();
            }
        };
        window.addCustomWaypoint = addCustomWaypoint

        const addManualLocation = () => {
            const name = prompt('Enter location name:');
            if (!name) return;
            
            const latStr = prompt('Enter latitude (-90 to 90):', '35.6762');
            const lngStr = prompt('Enter longitude (-180 to 180):', '139.6503');
            
            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Invalid coordinates! Please enter valid numbers.');
                return;
            }
            
            DATA.geocodedLocations[name] = {
                lat: lat,
                lng: lng,
                name: name,
                country: 'Custom'
            };
            
            saveToStorage();
            
            // Add to location list
            const locationList = document.querySelector('.location-list');
            if (locationList) {
                const emptyMsg = locationList.querySelector('div[style*="padding:20px"]');
                if (emptyMsg) emptyMsg.remove();
                
                const newItem = `
                    <div class="location-item">
                        <span class="location-drag-handle">‚ãÆ‚ãÆ</span>
                        <div>
                            <div style="font-weight:600;font-size:13px;" data-location="${name}">${name}</div>
                            <div class="location-coords">${lat.toFixed(4)}, ${lng.toFixed(4)}</div>
                        </div>
                        <button class="btn" onclick="editLocation('${name}')" style="padding:4px 10px;font-size:11px;">‚úèÔ∏è Edit Name</button>
                        <button class="btn" onclick="editLocationCoords('${name}')" style="padding:4px 10px;font-size:11px;background:#3b82f6;">üìç Edit Coords</button>
                        <button class="btn" onclick="deleteLocationFromCache('${name}')" style="padding:4px 10px;font-size:11px;background:#ef4444;">üóëÔ∏è Delete</button>
                    </div>
                `;
                locationList.querySelector('h4').insertAdjacentHTML('afterend', newItem);
            }
            
            // Redraw map
            if (DATA.mapInitialized) {
                renderMapFromCache();
            }
        };

        const editWaypointCoords = (idx) => {
            const waypoint = DATA.customWaypoints[idx];
            
            const latStr = prompt('Enter new latitude:', waypoint.lat);
            const lngStr = prompt('Enter new longitude:', waypoint.lng);
            
            if (latStr === null || lngStr === null) return;
            
            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Invalid coordinates!');
                return;
            }
            
            DATA.customWaypoints[idx].lat = lat;
            DATA.customWaypoints[idx].lng = lng;
            saveToStorage();
            renderMapFromCache();
        };

        const editLocationCoords = (locationName) => {
            const coords = DATA.geocodedLocations[locationName];
            if (!coords) return;
            
            const latStr = prompt('Enter new latitude (-90 to 90):', coords.lat);
            const lngStr = prompt('Enter new longitude (-180 to 180):', coords.lng);
            
            if (latStr === null || lngStr === null) return;
            
            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Invalid coordinates!');
                return;
            }
            
            DATA.geocodedLocations[locationName].lat = lat;
            DATA.geocodedLocations[locationName].lng = lng;
            saveToStorage();
            
            // Update the coords display
            const coordsDiv = document.querySelector(`[data-location="${locationName}"] + .location-coords`);
            if (coordsDiv) {
                coordsDiv.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
            
            // Redraw map
            if (DATA.mapInitialized) {
                renderMapFromCache();
            }
        };

        window.deleteLocationFromCache = (locationName) => {
            if (confirm(`Delete "${locationName}" from map? This will remove it from the cached locations but won't change your trip days.`)) {
                console.log('Deleting location:', locationName);
                delete DATA.geocodedLocations[locationName];
                saveToStorage();
                
                // Remove the location item from DOM
                const locationItems = document.querySelectorAll('.location-item');
                locationItems.forEach(item => {
                    const nameDiv = item.querySelector('[data-location]');
                    if (nameDiv && nameDiv.dataset.location === locationName) {
                        item.remove();
                    }
                });
                
                // Redraw map without this location
                if (DATA.mapInitialized) {
                    renderMapFromCache();
                }
                
                // Show empty state if no locations left
                if (Object.keys(DATA.geocodedLocations).length === 0) {
                    const locationList = document.querySelector('.location-list');
                    if (locationList) {
                        const existingItems = locationList.querySelectorAll('.location-item');
                        if (existingItems.length === 0) {
                            const emptyDiv = document.querySelector('.location-list > div:last-child');
                            if (!emptyDiv || !emptyDiv.textContent.includes('No locations')) {
                                locationList.querySelector('h4').insertAdjacentHTML('afterend', `
                                    <div style="padding:20px;text-align:center;color:#999;font-size:13px;">
                                        No locations yet. Add locations manually or refresh the map to geocode from your trip days.
                                    </div>
                                `);
                            }
                        }
                    }
                }
                
                console.log('Location deleted. Remaining:', Object.keys(DATA.geocodedLocations));
            }
        };
                
        const clearMapCache = () => {
            if (confirm('Clear all cached map locations? This will remove all your edits and custom waypoints. You\'ll need to refresh the map to reload from trip days.')) {
                console.log('üóëÔ∏è Clearing map cache...');
                DATA.geocodedLocations = {};
                DATA.customWaypoints = [];
                DATA.mapInitialized = false;
                saveToStorage();

                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                    markersLayer = null;
                    routeLayer = null;
                }
                
                alert('Map cache cleared! Click "Refresh Map" to reload from your trip days.');
                render();
            }
        };

        const saveMapState = () => {
            if (mapInstance) {
                return {
                    center: mapInstance.getCenter(),
                    zoom: mapInstance.getZoom(),
                    wasInitialized: true
                };
            }
            return null;
        };

        const restoreMapState = (state) => {
            // If we're on planning tab and map should be visible
            if (DATA.showMap && DATA.activeTab === 'planning') {
                setTimeout(() => {
                    const mapElement = document.getElementById('tripMap');
                    
                    if (mapElement && !DATA.mapInitialized) {
                        // Initialize the map
                        initMap();
                        
                        // Auto-fit to show all markers
                        if (mapInstance && Object.keys(DATA.geocodedLocations).length > 0) {
                            const allCoords = Object.values(DATA.geocodedLocations).map(loc => [loc.lat, loc.lng]);
                            
                            // Add waypoint coords too
                            DATA.customWaypoints.forEach(wp => {
                                allCoords.push([wp.lat, wp.lng]);
                            });
                            
                            if (allCoords.length > 0) {
                                const bounds = L.latLngBounds(allCoords);
                                mapInstance.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                    }
                }, 100);
            }
        };

        const toggleMap = () => {
            // Use the same approach as tab switching
            const mapState = saveMapState();
            
            // Destroy map before render (just like tab switch does)
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
                markersLayer = null;
                routeLayer = null;
                DATA.mapInitialized = false;
            }
            
            DATA.showMap = !DATA.showMap;
            saveToStorage();
            render();
            
            // Restore map state (just like tab switch does)
            restoreMapState(mapState);
        };

        const getAllMapLocations = () => {
            // Combine regular locations and waypoints with order info
            const locations = [];
            
            // Add all geocoded locations
            Object.entries(DATA.geocodedLocations).forEach(([name, coords]) => {
                locations.push({
                    id: name,
                    name: name,
                    lat: coords.lat,
                    lng: coords.lng,
                    type: 'location',
                    order: DATA.locationOrder?.[name] || 999
                });
            });
            
            // Add all custom waypoints
            DATA.customWaypoints.forEach((wp, idx) => {
                locations.push({
                    id: `waypoint_${idx}`,
                    name: wp.name,
                    lat: wp.lat,
                    lng: wp.lng,
                    type: 'waypoint',
                    waypointIndex: idx,
                    order: DATA.locationOrder?.[`waypoint_${idx}`] || 999
                });
            });
            
            // Sort by order
            locations.sort((a, b) => a.order - b.order);
            
            return locations;
        };

        const updateLocationOrder = () => {
            // Save current order based on DOM position
            const items = document.querySelectorAll('.location-item');
            DATA.locationOrder = {};
            
            items.forEach((item, index) => {
                const locationId = item.dataset.locationId;
                if (locationId) {
                    DATA.locationOrder[locationId] = index;
                }
            });
            
            saveToStorage();
        };

        let draggedElement = null;

        window.handleDragStart = (e, locationId) => {
            draggedElement = locationId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };

        window.handleDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const draggingItem = document.querySelector('.dragging');
            const afterElement = getDragAfterElement(e.currentTarget.parentElement, e.clientY);
            
            if (afterElement == null) {
                e.currentTarget.parentElement.appendChild(draggingItem);
            } else {
                e.currentTarget.parentElement.insertBefore(draggingItem, afterElement);
            }
        };

        window.handleDrop = (e, locationId) => {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            updateLocationOrder();
            
            // Redraw route with new order
            if (DATA.mapView === 'route' && DATA.mapInitialized) {
                drawRoute();
            }
        };

        window.handleDragEnd = (e) => {
            e.target.classList.remove('dragging');
            draggedElement = null;
        };

        const getDragAfterElement = (container, y) => {
            const draggableElements = [...container.querySelectorAll('.location-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        };
       
        const drawRoute = () => {
            if (!routeLayer) return 0;
            
            routeLayer.clearLayers();
            
            const orderedLocations = getAllMapLocations();
            const routeCoords = [];
            let totalDistance = 0;
            let prevCoords = null;
            
            orderedLocations.forEach(loc => {
                const currentCoords = [loc.lat, loc.lng];
                routeCoords.push(currentCoords);
                
                if (prevCoords) {
                    totalDistance += calculateDistance(
                        prevCoords[0], prevCoords[1],
                        currentCoords[0], currentCoords[1]
                    );
                }
                
                prevCoords = currentCoords;
            });
            
            if (routeCoords.length > 1) {
                L.polyline(routeCoords, {
                    color: DATA.mapEditMode ? '#f59e0b' : '#3b82f6',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: DATA.mapEditMode ? '5, 10' : '10, 10'
                }).addTo(routeLayer);
                
                const arrowInterval = Math.max(1, Math.floor(routeCoords.length / 8));
                for (let i = 0; i < routeCoords.length - 1; i += arrowInterval) {
                    const midLat = (routeCoords[i][0] + routeCoords[i + 1][0]) / 2;
                    const midLng = (routeCoords[i][1] + routeCoords[i + 1][1]) / 2;
                    
                    L.marker([midLat, midLng], {
                        icon: L.divIcon({
                            html: '‚ûú',
                            className: 'route-arrow',
                            iconSize: [20, 20]
                        })
                    }).addTo(routeLayer);
                }
            }
            
            return totalDistance;
        };

        window.editWaypointInfo = (idx) => {
            const waypoint = DATA.customWaypoints[idx];
            const newName = prompt('Enter waypoint name:', waypoint.name);
            
            if (newName && newName !== waypoint.name) {
                DATA.customWaypoints[idx].name = newName;
                saveToStorage();
                
                // Update the display
                const nameSpan = document.querySelector(`[data-location="waypoint_${idx}"]`);
                if (nameSpan) {
                    nameSpan.textContent = newName;
                }
                
                // Redraw map markers
                if (DATA.mapInitialized) {
                    renderMapFromCache();
                }
            }
        };

        window.deleteWaypointFromList = (idx) => {
            if (confirm(`Delete waypoint "${DATA.customWaypoints[idx].name}"?`)) {
                DATA.customWaypoints.splice(idx, 1);
                saveToStorage();
                
                // Remove from DOM
                const item = document.querySelector(`[data-location-id="waypoint_${idx}"]`);
                if (item) item.remove();
                
                // Redraw map
                if (DATA.mapInitialized) {
                    renderMapFromCache();
                }
                
                // Refresh the list to update indices
                toggleMapEditMode();
                toggleMapEditMode();
            }
        };

        let draggedChecklistItem = null;
        let draggedChecklistType = null;

        const handleChecklistDragStart = (e, type, index) => {
            draggedChecklistItem = index;
            draggedChecklistType = type;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };

        const handleChecklistDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        };

        const handleChecklistDrop = (e, type, targetIndex) => {
            e.preventDefault();
            if (draggedChecklistType !== type || draggedChecklistItem === null) return;
            
            const sourceIndex = draggedChecklistItem;
            
            if (sourceIndex !== targetIndex) {
                let arrayToUpdate;
                switch (type) {
                    case 'packing':
                        arrayToUpdate = DATA.packingList;
                        break;
                    case 'before':
                        arrayToUpdate = DATA.beforeChecklist;
                        break;
                    case 'trip':
                        arrayToUpdate = DATA.tripChecklist;
                        break;
                    default:
                        return;
                }
                
                // Remove the dragged item
                const [draggedItem] = arrayToUpdate.splice(sourceIndex, 1);
                
                // Insert at new position
                if (targetIndex >= arrayToUpdate.length) {
                    arrayToUpdate.push(draggedItem);
                } else {
                    arrayToUpdate.splice(targetIndex, 0, draggedItem);
                }
                
                saveToStorage();
                render();
            }
            
            e.target.classList.remove('drag-over');
        };

        const handleChecklistDragEnd = (e) => {
            draggedChecklistItem = null;
            draggedChecklistType = null;
            e.target.classList.remove('dragging');
            
            // Remove drag-over classes from all items
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        };

        // Make functions available globally
        window.handleChecklistDragStart = handleChecklistDragStart;
        window.handleChecklistDragOver = handleChecklistDragOver;
        window.handleChecklistDrop = handleChecklistDrop;
        window.handleChecklistDragEnd = handleChecklistDragEnd;

        const handleReceiptUpload = (dayIndex, event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                if (!DATA.days[dayIndex].receipts) {
                    DATA.days[dayIndex].receipts = [];
                }
                
                // Create receipt with empty fields (user will fill in description first)
                const newReceipt = {
                    image: e.target.result,
                    amount: '',
                    category: '',
                    description: '',
                    date: DATA.days[dayIndex].dt
                };
                
                DATA.days[dayIndex].receipts.push(newReceipt);
                saveToStorage();
                render();
                
                // Focus on the description input for the new receipt
                setTimeout(() => {
                    const receiptItems = document.querySelectorAll('.receipt-item');
                    const lastReceipt = receiptItems[receiptItems.length - 1];
                    if (lastReceipt) {
                        const descInput = lastReceipt.querySelector('input[placeholder="Description"]');
                        if (descInput) descInput.focus();
                    }
                }, 100);
            };
            reader.readAsDataURL(file);
        };
       
        const updateReceipt = (dayIndex, receiptIndex, field, value) => {
            if (field === 'amount') {
                DATA.days[dayIndex].receipts[receiptIndex][field] = parseFloat(value) || 0;
            } else {
                DATA.days[dayIndex].receipts[receiptIndex][field] = value;
                
                // Auto-categorize when description changes
                if (field === 'description' && value && !DATA.days[dayIndex].receipts[receiptIndex].category) {
                    const suggestedCategory = autoCategorizeReceipt(value);
                    if (suggestedCategory) {
                        DATA.days[dayIndex].receipts[receiptIndex].category = suggestedCategory;
                    }
                }
            }
            saveToStorage();
            render();
        };

        const deleteReceipt = (dayIndex, receiptIndex) => {
            if (confirm('Delete this receipt?')) {
                DATA.days[dayIndex].receipts.splice(receiptIndex, 1);
                saveToStorage();
                render();
            }
        };

        const autoCategorizeReceipt = (description) => {
            if (!description) return '';
            
            const desc = description.toLowerCase();
            
            // Accommodation keywords
            if (desc.includes('hotel') || desc.includes('hostel') || desc.includes('airbnb') || 
                desc.includes('booking') || desc.includes('stay') || desc.includes('lodge') ||
                desc.includes('inn') || desc.includes('motel') || desc.includes('resort')) {
                return 'acc';
            }
            
            // Transportation keywords
            if (desc.includes('train') || desc.includes('bus') || desc.includes('taxi') || 
                desc.includes('uber') || desc.includes('lyft') || desc.includes('flight') ||
                desc.includes('subway') || desc.includes('metro') || desc.includes('rail') ||
                desc.includes('ticket') || desc.includes('transport') || desc.includes('car rental') ||
                desc.includes('gas') || desc.includes('fuel') || desc.includes('parking')) {
                return 'trn';
            }
            
            // Food keywords
            if (desc.includes('restaurant') || desc.includes('cafe') || desc.includes('coffee') ||
                desc.includes('food') || desc.includes('pizza') || desc.includes('sushi') ||
                desc.includes('burger') || desc.includes('dinner') || desc.includes('lunch') ||
                desc.includes('breakfast') || desc.includes('bar') || desc.includes('pub') ||
                desc.includes('kitchen') || desc.includes('grill') || desc.includes('bakery') ||
                desc.includes('grocery') || desc.includes('market') || desc.includes('supermarket')) {
                return 'food';
            }
            
            // Activities keywords
            if (desc.includes('museum') || desc.includes('ticket') || desc.includes('tour') ||
                desc.includes('admission') || desc.includes('entry') || desc.includes('temple') ||
                desc.includes('shrine') || desc.includes('park') || desc.includes('attraction') ||
                desc.includes('show') || desc.includes('concert') || desc.includes('theater') ||
                desc.includes('cinema') || desc.includes('spa') || desc.includes('massage') ||
                desc.includes('activity') || desc.includes('experience')) {
                return 'act';
            }
            
            // Check custom categories
            for (const cat of DATA.categories) {
                if (cat.id !== 'acc' && cat.id !== 'trn' && cat.id !== 'food' && cat.id !== 'act') {
                    if (desc.includes(cat.name.toLowerCase()) || desc.includes(cat.id)) {
                        return cat.id;
                    }
                }
            }
            
            return ''; // No category matched
        };

        const calculateReceiptStats = () => {
            let totalReceipts = 0;
            let totalAmount = 0;
            const categoryTotals = {};
            
            DATA.days.forEach(day => {
                if (day.receipts && day.receipts.length > 0) {
                    day.receipts.forEach(receipt => {
                        totalReceipts++;
                        const amount = parseFloat(receipt.amount) || 0;
                        totalAmount += amount;
                        
                        if (receipt.category) {
                            if (!categoryTotals[receipt.category]) {
                                categoryTotals[receipt.category] = 0;
                            }
                            categoryTotals[receipt.category] += amount;
                        }
                    });
                }
            });
            
            return { totalReceipts, totalAmount, categoryTotals };
        };
       
       
       
        const render = () => {
            const s = stats();
            const app = document.getElementById('app');
            
            let h = `<div class="header">
                ${DATA.editTitle ? 
                    `<input type="text" class="header-title-edit" value="${DATA.tripTitle}" onchange="DATA.tripTitle=this.value;saveToStorage();render()" onblur="DATA.editTitle=false;render()" autofocus>` :
                    `<h1 onclick="DATA.editTitle=true;render()" style="cursor:pointer;">${DATA.tripTitle}</h1>`
                }
                <div class="subtitle">
                    <input type="date" value="${DATA.tripStartDate}" onchange="DATA.tripStartDate=this.value;updateTripDates();" style="padding:4px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;margin-right:5px;">
                    -
                    <input type="date" value="${DATA.tripEndDate}" onchange="DATA.tripEndDate=this.value;updateTripDates();" style="padding:4px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px;margin-left:5px;">
                    ‚Ä¢ ${s.done}/${DATA.days.length} days completed
                </div>
            </div>`;
            
            // TAB NAVIGATION
            h += `<div class="tab-navigation">
                <button class="tab-btn ${DATA.activeTab === 'planning' ? 'active' : ''}" onclick="switchTab('planning')">
                    üìã Planning & Budget
                </button>
                <button class="tab-btn ${DATA.activeTab === 'itinerary' ? 'active' : ''}" onclick="switchTab('itinerary')">
                    üìÖ Day-by-Day Itinerary
                </button>
                <button class="tab-btn ${DATA.activeTab === 'gallery' ? 'active' : ''}" onclick="switchTab('gallery')">
                    üì∏ Photo Gallery
                </button>
            </div>`;
            
            // PHOTO MODAL (shows on both tabs)
            if(DATA.photoModal) h += `<div class="photo-modal show" onclick="closePhotoModal()"><div class="photo-modal-content" onclick="event.stopPropagation()"><button class="photo-modal-close" onclick="closePhotoModal()">√ó</button><img src="${DATA.photoModal}"></div></div>`;
            
            // ICON PICKER MODAL (shows on both tabs)
            if (DATA.iconPickerOpen) {
                h += `<div class="icon-picker-overlay show" onclick="closeIconPicker()"></div>
                <div class="icon-picker-modal show">
                    <h3 style="margin:0 0 15px 0;">Choose an Icon</h3>
                    <div class="icon-grid">
                        ${ICON_OPTIONS.map(icon => `
                            <div class="icon-option" onclick="event.stopPropagation();selectIcon('${icon}')">${icon}</div>
                        `).join('')}
                    </div>
                </div>`;
            }
            
            // ============================================
            // PLANNING TAB
            // ============================================
            h += `<div class="tab-content ${DATA.activeTab === 'planning' ? 'active' : ''}">`;
                
            h += `<div class="trip-notes-section">
                <h3>
                    üìù Trip Notes
                    <span style="font-size:12px;font-weight:400;color:#666;">General notes, tips, and reminders</span>
                </h3>
                <textarea placeholder="Add general trip notes here... (travel tips, important info, things to remember, etc.)" onchange="DATA.tripNotes=this.value;saveToStorage();">${DATA.tripNotes}</textarea>
            </div>`;
            // Trip notes
            h += `<div class="travelers-section">
                <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;margin-bottom:15px;" onclick="DATA.showTravelers=!DATA.showTravelers;render()">
                    <h3 style="margin:0;">üë• Travelers</h3>
                    <span style="font-size:20px;transition:transform 0.3s;${DATA.showTravelers ? 'transform:rotate(180deg);' : ''}">‚ñº</span>
                </div>
                
                ${DATA.showTravelers ? `
                    <div class="traveler-count">
                        <button class="traveler-count-btn" onclick="event.stopPropagation();updateTravelerCount(-1)">‚àí</button>
                        <div class="traveler-count-display">${DATA.travelerCount}</div>
                        <button class="traveler-count-btn" onclick="event.stopPropagation();updateTravelerCount(1)">+</button>
                        <span style="color:#666;font-size:14px;">traveler${DATA.travelerCount > 1 ? 's' : ''}</span>
                    </div>
                    
                    ${DATA.travelerCount > 1 ? `
                        <div style="cursor:pointer;padding:10px;background:#f9fafb;border-radius:6px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;" onclick="event.stopPropagation();DATA.showTravelerList=!DATA.showTravelerList;render()">
                            <span style="font-size:14px;font-weight:600;color:#374151;">Manage Traveler Names</span>
                            <span style="font-size:16px;transition:transform 0.3s;${DATA.showTravelerList ? 'transform:rotate(180deg);' : ''}">‚ñº</span>
                        </div>
                        
                        ${DATA.showTravelerList ? `
                            <div class="traveler-list">
                                ${DATA.travelers.map((name, idx) => `
                                    <div class="traveler-item">
                                        <span style="font-size:18px;">üë§</span>
                                        <input type="text" value="${name}" onchange="event.stopPropagation();updateTravelerName(${idx}, this.value)" placeholder="Traveler name">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="cost-split-toggle">
                            <div style="font-weight:600;margin-bottom:8px;color:#374131;">Cost Display:</div>
                            <div class="cost-split-option">
                                <input type="radio" name="costSplit" id="costTotal" ${DATA.costSplitMode === 'total' ? 'checked' : ''} onchange="event.stopPropagation();setCostSplitMode('total')">
                                <label for="costTotal" onclick="event.stopPropagation()">Show total costs only</label>
                            </div>
                            <div class="cost-split-option">
                                <input type="radio" name="costSplit" id="costPerPerson" ${DATA.costSplitMode === 'perPerson' ? 'checked' : ''} onchange="event.stopPropagation();setCostSplitMode('perPerson')">
                                <label for="costPerPerson" onclick="event.stopPropagation()">Show total + per person breakdown</label>
                            </div>
                        </div>
                    ` : ''}
                ` : ''}
            </div>`;
            // Travelers section
            h += `<div class="stats">
                <div class="stat-card blue">
                    <div class="stat-label">Target Budget</div>
                    ${DATA.editBudget ? 
                        `<input type="number" class="edit-input" value="${DATA.budget}" onchange="DATA.budget=parseFloat(this.value)||5000;saveToStorage();render()" onblur="DATA.editBudget=false;render()" autofocus>` : 
                        `<div class="stat-value" onclick="DATA.editBudget=true;render()">$${DATA.budget.toLocaleString()}</div>`
                    }
                    <div class="stat-sub">${DATA.currencySymbol}${(DATA.budget * DATA.rate).toLocaleString()}</div>
                    ${DATA.travelerCount > 1 && DATA.costSplitMode === 'perPerson' ? `<div class="stat-sub" style="margin-top:4px;">$${(DATA.budget/DATA.travelerCount).toFixed(0)}/person</div>` : ''}
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Actually Spent</div>
                    <div class="stat-value">${(s.tA / DATA.rate).toFixed(2)}</div>
                    <div class="stat-sub">${DATA.currencySymbol}${s.tA.toLocaleString()}</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Remaining</div>
                    <div class="stat-value">${(s.rem / DATA.rate).toFixed(2)}</div>
                    <div class="stat-sub">${DATA.currencySymbol}${Math.round(s.rem).toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Days Completed</div>
                    <div class="stat-value">${s.done}/55</div>
                    <div class="stat-sub">${((s.done/DATA.days.length)*100).toFixed(0)}% done</div>
                </div>
            </div>`;
           
            h += `<div class="toggle" onclick="DATA.showEst=!DATA.showEst;render()">
                <span>üìä Show Estimated Costs</span>
                <div class="toggle-switch ${DATA.showEst?'on':''}">
                    <div class="toggle-slider"></div>
                </div>
            </div>`;
           
            if(DATA.showEst) {
                h += `<div class="stats">
                    <div class="stat-card ${s.over?'red':'blue'}">
                        <div class="stat-label">Estimated Total</div>
                        <div class="stat-value">${(s.tP/DATA.rate).toFixed(2)}</div>
                        <div class="stat-sub">${DATA.currencySymbol}${s.tP.toLocaleString()}</div>
                    </div>
                    <div class="stat-card ${s.over?'red':'blue'}">
                        <div class="stat-label">Estimated Remaining</div>
                        <div class="stat-value">${s.over?'-':''}${Math.abs(s.estRem/DATA.rate).toFixed(2)}</div>
                        <div class="stat-sub">${s.over?'-':''}${DATA.currencySymbol}${Math.abs(s.estRem).toLocaleString()}</div>
                    </div>
                    <div class="stat-card ${s.over?'red':'blue'}">
                        <div class="stat-label">Budget Status</div>
                        <div class="stat-value">${s.estPct.toFixed(1)}%</div>
                        <div class="stat-sub">${s.over?'‚ö†Ô∏è Over':'‚úì Within'}</div>
                    </div>
                </div>`;
            }
            // Stats cards

            // Control bar (currency, exchange rate, buttons)
                       // Charts
            h += `<div class="chart-container">
                <div class="chart-header" onclick="DATA.showChart=!DATA.showChart;render()">
                    <h3>üìä Expense Categories Breakdown</h3>
                    <span class="chart-header-toggle ${DATA.showChart?'open':''}">‚ñº</span>
                </div>
                <div class="chart-content ${DATA.showChart?'show':''}">
                    <div class="chart-toggle">
                        <button class="${DATA.chartView==='planned'?'active':''}" onclick="DATA.chartView='planned';render()">Planned</button>
                        <button class="${DATA.chartView==='actual'?'active':''}" onclick="DATA.chartView='actual';render()">Actual</button>
                    </div>
                    <div class="chart" style="margin-bottom:20px;">`;

            // Calculate totals dynamically
            const cat = DATA.chartView === 'planned' ? s.catP : s.catA;
            const items = DATA.chartView === 'planned' ? s.itemsP : s.itemsA;
            let total = 0;
            let maxVal = 0;

            DATA.categories.forEach(c => {
                const val = cat[c.id] || 0;
                total += val;
                if (val > maxVal) maxVal = val;
            });

            // Render category bars dynamically
            DATA.categories.forEach(category => {
                const catVal = cat[category.id] || 0;
                const pct = total > 0 ? (catVal / total * 100) : 0;
                const width = maxVal > 0 ? (catVal / maxVal * 100) : 0;
                
                h += `<div class="chart-bar">
                    <div class="chart-label">${category.icon} ${category.name}</div>
                    <div class="chart-bar-bg">
                        <div class="chart-bar-fill" style="width:${width}%;background:${category.color};color:white;">${pct.toFixed(1)}%</div>
                    </div>
                    <div class="chart-value">${DATA.currencySymbol}${catVal.toLocaleString()}</div>
                </div>`;
            });
            // Category detail dropdowns - dynamically for each category
            DATA.categories.forEach(category => {
                const catVal = cat[category.id] || 0;
                const catItems = items[category.id] || [];
                const showProp = `showChart${category.id.charAt(0).toUpperCase() + category.id.slice(1)}`;
                
                // Initialize the show property if it doesn't exist
                if (DATA[showProp] === undefined) DATA[showProp] = false;
                
                h += `<div class="chart-container" style="margin-bottom:10px;padding:15px;">
                    <div class="chart-header" onclick="DATA.${showProp}=!DATA.${showProp};render()" style="margin-bottom:0;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:20px;">${category.icon}</span>
                            <h3 style="margin:0;">${category.name}</h3>
                        </div>
                        <div style="display:flex;align-items:center;gap:15px;">
                            <span style="font-weight:600;color:${category.color};">${DATA.currencySymbol}${catVal.toLocaleString()} (${total>0?((catVal/total)*100).toFixed(1):0}%)</span>
                            <span class="chart-header-toggle ${DATA[showProp]?'open':''}">‚ñº</span>
                        </div>
                    </div>
                    ${DATA[showProp] ? `
                        <div style="margin-top:15px;padding-top:15px;border-top:1px solid #e0e0e0;">
                            ${catItems.length > 0 ? catItems.map(item => `
                                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0;">
                                    <span style="color:#666;font-size:13px;">Day ${item.day}: ${item.name}</span>
                                    <span style="font-weight:600;font-size:13px;">${DATA.currencySymbol}${item.value.toLocaleString()}</span>
                                </div>
                            `).join('') : '<div style="color:#999;font-size:13px;padding:10px;">No expenses in this category yet</div>'}
                        </div>
                    ` : ''}
                </div>`;
            });
            h += `</div>`; // closes .chart
            h += `</div>`; // closes .chart-content
            h += `</div>`; // closes .chart-container
            
            // Currency converter
            h += `<div class="category-manager">
                <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;margin-bottom:15px;" onclick="DATA.showCategoryManager=!DATA.showCategoryManager;render()">
                    <h3 style="margin:0;">üè∑Ô∏è Manage Expense Categories</h3>
                    <span style="font-size:20px;transition:transform 0.3s;${DATA.showCategoryManager ? 'transform:rotate(180deg);' : ''}">‚ñº</span>
                </div>
                
                ${DATA.showCategoryManager ? `
                    <div class="category-list">
                        ${DATA.categories.map(cat => `
                            <div class="category-item">
                                <div class="category-icon-picker" onclick="openIconPicker('${cat.id}')">${cat.icon}</div>
                                <input type="text" value="${cat.name}" onchange="updateCategory('${cat.id}', 'name', this.value)" style="padding:8px;border:1px solid #ddd;border-radius:4px;font-size:14px;">
                                <input type="color" class="category-color-picker" value="${cat.color}" onchange="updateCategory('${cat.id}', 'color', this.value)">
                                <span style="font-size:12px;color:#666;">${cat.id}</span>
                                <button class="btn" onclick="deleteCategory('${cat.id}')" style="padding:6px 12px;font-size:12px;background:#ef4444;">Delete</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="add-category-btn" onclick="addCategory()">+ Add New Category</button>
                ` : ''}
            </div>`;
            // Category manager
            // Category budgets
            h += `<div class="category-budget-section">
                <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;margin-bottom:15px;" onclick="DATA.showCategoryBudget=!DATA.showCategoryBudget;render()">
                    <h3 style="margin:0;">üí∞ Budget by Category</h3>
                    <span style="font-size:20px;transition:transform 0.3s;${DATA.showCategoryBudget ? 'transform:rotate(180deg);' : ''}"">‚ñº</span>
                </div>
                ${DATA.showCategoryBudget ? `
                    <div>
                        ${DATA.categories.map(cat => {
                            const spent = s.catA[cat.id] || 0;
                            const budgeted = DATA.categoryBudgets[cat.id] || 0;
                            const percentage = budgeted > 0 ? (spent / (budgeted * DATA.rate)) * 100 : 0;
                            const status = percentage < 70 ? 'low' : percentage < 90 ? 'medium' : 'high';
                            
                            return `
                                <div class="category-budget-item">
                                    <div class="category-budget-header">
                                        <div class="category-budget-label">
                                            <span style="color:${cat.color};">${cat.icon}</span> ${cat.name}
                                            ${DATA.editCategoryBudget === cat.id ? 
                                                `<input type="number" class="category-budget-input" value="${budgeted}" onchange="DATA.categoryBudgets['${cat.id}']=parseFloat(this.value)||0;saveToStorage();render()" onblur="DATA.editCategoryBudget=null;render()" autofocus placeholder="$0">` :
                                                `<button class="btn" onclick="DATA.editCategoryBudget='${cat.id}';render()" style="padding:2px 8px;font-size:11px;">${budgeted > 0 ? `$${budgeted}` : 'Set Budget'}</button>`
                                            }
                                        </div>
                                        <div class="category-budget-amount">
                                            ${DATA.currencySymbol}${spent.toLocaleString()} / ${budgeted > 0 ? `${DATA.currencySymbol}${(budgeted * DATA.rate).toLocaleString()}` : 'No limit'}
                                            ${budgeted > 0 ? ` (${percentage.toFixed(0)}%)` : ''}
                                        </div>
                                    </div>
                                    ${budgeted > 0 ? `
                                        <div class="category-budget-bar">
                                            <div class="category-budget-fill ${status}" style="width:${Math.min(percentage, 100)}%">
                                                ${percentage >= 20 ? `${percentage.toFixed(0)}%` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            </div>`;
            
            h += `<div class="receipt-analytics">
                <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;margin-bottom:15px;" onclick="DATA.showReceiptAnalytics=!DATA.showReceiptAnalytics;render()">
                    <h3 style="margin:0;font-size:16px;">üßæ Receipt Analytics</h3>
                    <span style="font-size:20px;transition:transform 0.3s;${DATA.showReceiptAnalytics ? 'transform:rotate(180deg);' : ''}">‚ñº</span>
                </div>
                
                ${DATA.showReceiptAnalytics ? `
                    ${(() => {
                        const stats = calculateReceiptStats();
                        return `
                            <div class="stats" style="margin-bottom:20px;">
                                <div class="stat-card">
                                    <div class="stat-label">Total Receipts</div>
                                    <div class="stat-value">${stats.totalReceipts}</div>
                                </div>
                                <div class="stat-card blue">
                                    <div class="stat-label">Receipt Total</div>
                                    <div class="stat-value">${DATA.currencySymbol}${stats.totalAmount.toLocaleString()}</div>
                                    <div class="stat-sub">$${(stats.totalAmount/DATA.rate).toFixed(2)}</div>
                                </div>
                                <div class="stat-card green">
                                    <div class="stat-label">Avg per Receipt</div>
                                    <div class="stat-value">${stats.totalReceipts > 0 ? DATA.currencySymbol + (stats.totalAmount/stats.totalReceipts).toFixed(0) : 'N/A'}</div>
                                </div>
                            </div>
                            
                            ${Object.keys(stats.categoryTotals).length > 0 ? `
                                <h4 style="font-size:14px;margin-bottom:10px;">Receipts by Category</h4>
                                <div class="chart">
                                    ${DATA.categories.map(cat => {
                                        const catTotal = stats.categoryTotals[cat.id] || 0;
                                        const pct = stats.totalAmount > 0 ? (catTotal / stats.totalAmount * 100) : 0;
                                        const maxCatTotal = Math.max(...Object.values(stats.categoryTotals));
                                        const width = maxCatTotal > 0 ? (catTotal / maxCatTotal * 100) : 0;
                                        
                                        if (catTotal === 0) return '';
                                        
                                        return `
                                            <div class="chart-bar">
                                                <div class="chart-label">${cat.icon} ${cat.name}</div>
                                                <div class="chart-bar-bg">
                                                    <div class="chart-bar-fill" style="width:${width}%;background:${cat.color};color:white;">${pct.toFixed(1)}%</div>
                                                </div>
                                                <div class="chart-value">${DATA.currencySymbol}${catTotal.toLocaleString()}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<div style="color:#999;text-align:center;padding:20px;">No categorized receipts yet</div>'}
                        `;
                    })()}
                ` : ''}
            </div>`;

            h += `<div class="map-section">
                <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;margin-bottom:15px;" onclick="toggleMap()">
                    <h3 style="margin:0;">üó∫Ô∏è Trip Map & Route Planning</h3>
                    <span style="font-size:20px;transition:transform 0.3s;${DATA.showMap ? 'transform:rotate(180deg);' : ''}">‚ñº</span>
                </div>
                
                ${DATA.showMap ? `
                    <div class="map-controls">
                        <button class="map-btn ${DATA.mapView === 'all' ? 'active' : ''}" onclick="switchMapView('all')">üìç All Locations</button>
                        <button class="map-btn ${DATA.mapView === 'route' ? 'active' : ''}" onclick="switchMapView('route')">üõ£Ô∏è Show Route</button>
                        <button class="map-btn" id="geocodeBtn" onclick="geocodeAllLocations()">üîÑ Refresh Map</button>
                        <button class="map-btn ${DATA.mapEditMode ? 'active' : ''}" onclick="toggleMapEditMode()">
                            ${DATA.mapEditMode ? '‚úì Done Editing' : '‚úèÔ∏è Edit Map'}
                        </button>
                        <button class="map-btn" onclick="addCustomWaypoint()">üìå Add Waypoint</button>
                        <button class="map-btn" onclick="clearMapCache()" style="background:#fee;color:#dc2626;">üóëÔ∏è Clear Cache</button>
                    </div>
                    
                    <div id="tripMap" class="map-container"></div>
                    
                    <div class="route-stats">
                        <div class="route-stat-card">
                            <div class="route-stat-label">Total Locations</div>
                            <div class="route-stat-value" id="mapTotalLocations">0</div>
                        </div>
                        <div class="route-stat-card">
                            <div class="route-stat-label">Total Distance</div>
                            <div class="route-stat-value" id="mapTotalDistance">Calculating...</div>
                        </div>
                        <div class="route-stat-card">
                            <div class="route-stat-label">Trip Duration</div>
                            <div class="route-stat-value" id="mapTotalDays">${DATA.days.length} days</div>
                        </div>
                    </div>
                    
                ${DATA.mapEditMode ? `
                    <div class="location-list">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h4 style="font-size:14px;margin:0;">üìç Route Order</h4>
                            <div style="display:flex;gap:8px;">
                                <button class="btn" onclick="addManualLocation()" style="padding:4px 12px;font-size:12px;background:#10b981;">
                                    ‚ûï Add Location
                                </button>
                                <button class="btn" onclick="addCustomWaypoint()" style="padding:4px 12px;font-size:12px;background:#8b5cf6;">
                                    üìå Add Waypoint
                                </button>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#666;margin-bottom:10px;">
                            üí° Drag to reorder your route. Locations and waypoints in order from top to bottom.
                        </div>
                        ${getAllMapLocations().map(loc => `
                            <div class="location-item ${DATA.editingLocation === loc.id ? 'being-edited' : ''}"
                                draggable="true" 
                                data-location-id="${loc.id}"
                                ondragstart="handleDragStart(event, '${loc.id}')"
                                ondragover="handleDragOver(event)"
                                ondrop="handleDrop(event, '${loc.id}')"
                                ondragend="handleDragEnd(event)">
                                <span class="location-drag-handle">‚ãÆ‚ãÆ</span>
                                <div style="flex:1;">
                                    <div style="font-weight:600;font-size:13px;display:flex;align-items:center;gap:8px;">
                                        ${loc.type === 'waypoint' ? 'üìå' : 'üìç'} 
                                        <span data-location="${loc.id}">${loc.name}</span>
                                        ${loc.type === 'waypoint' ? '<span style="font-size:10px;background:#8b5cf6;color:white;padding:2px 6px;border-radius:4px;">WAYPOINT</span>' : ''}
                                    </div>
                                    <div class="location-coords">${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}</div>
                                </div>
                                <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `editWaypointInfo(${loc.waypointIndex})` : `editLocation('${loc.name}')`}" style="padding:4px 10px;font-size:11px;">‚úèÔ∏è Edit Name</button>
                                <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `editWaypointCoords(${loc.waypointIndex})` : `editLocationCoords('${loc.name}')`}" style="padding:4px 10px;font-size:11px;background:#3b82f6;">üìç Edit Coords</button>
                                <button class="btn" onclick="event.stopPropagation();${loc.type === 'waypoint' ? `deleteWaypointFromList(${loc.waypointIndex})` : `deleteLocationFromCache('${loc.name}')`}" style="padding:4px 10px;font-size:11px;background:#ef4444;">üóëÔ∏è Delete</button>
                            </div>
                        `).join('')}
                        ${getAllMapLocations().length === 0 ? `
                            <div style="padding:20px;text-align:center;color:#999;font-size:13px;">
                                No locations yet. Add locations or waypoints to plan your route.
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                    
                    <div style="margin-top:15px;padding:10px;background:#f0f9ff;border-radius:6px;font-size:13px;color:#1e40af;">
                        üí° <strong>Tip:</strong> Click "Edit Map" to drag markers and adjust locations. Add custom waypoints for stops along the way.
                    </div>
                ` : ''}
            </div>`;

        h += `<div class="day-card">
            <div class="day-header" onclick="DATA.editPackingList = !DATA.editPackingList; render()">
                <div class="day-info">
                    <div style="font-size: 20px;">üéí</div>
                    <div class="day-title">
                        <h3>Packing List</h3>
                        <div class="date">What to bring</div>
                    </div>
                </div>
            </div>
            ${DATA.editPackingList ? `
                <div class="details show">
                    <div class="checklist-items">
                        ${DATA.packingList.map((item, idx) => `
                            <div class="checklist-item" draggable="true" 
                                ondragstart="handleChecklistDragStart(event, 'packing', ${idx})"
                                ondragover="handleChecklistDragOver(event)"
                                ondrop="handleChecklistDrop(event, 'packing', ${idx})"
                                ondragend="handleChecklistDragEnd(event)">
                                <span class="drag-handle" style="cursor: grab; padding: 0 8px; opacity: 0.5;">‚ãÆ‚ãÆ</span>
                                <input type="checkbox" ${item.packed ? 'checked' : ''} onchange="event.stopPropagation();DATA.packingList[${idx}].packed = this.checked; saveToStorage(); render();" style="width: 20px; height: 20px;">
                                <input type="text" 
                                    value="${item.item}" 
                                    onchange="event.stopPropagation();DATA.packingList[${idx}].item = this.value; saveToStorage();" 
                                    placeholder="Enter item name..."
                                    style="flex: 1; ${item.packed ? 'text-decoration: line-through; opacity: 0.6;' : ''} 
                                            ${!item.item ? 'color: #999; font-style: italic;' : ''}"
                                    ${!item.item ? 'class="empty-item-input"' : ''}>
                                <button class="btn" style="padding: 4px 12px; background: #ef4444;" onclick="event.stopPropagation(); DATA.packingList.splice(${idx}, 1); saveToStorage(); render()">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="edit-btn" onclick="event.stopPropagation(); 
                        DATA.packingList.push({item: '', packed: false}); 
                        saveToStorage(); 
                        render();
                        setTimeout(() => {
                            const newInput = document.querySelector('.empty-item-input:last-of-type');
                            if (newInput) {
                                newInput.focus();
                                newInput.select();
                            }
                        }, 10);">‚ûï Add Item</button>
                    
                    ${DATA.packingList.length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; font-size: 14px; color: #666;">
                            ${DATA.packingList.filter(i => i.packed).length} of ${DATA.packingList.length} items packed
                        </div>
                    ` : ''}
                </div>
            ` : ''}
        </div>`;

            h += `<div class="control-bar" style="flex-direction:column;align-items:stretch;">
                <div class="currency-selector">
                    <label>Currency:</label>
                    <select value="${DATA.currency}" onchange="changeCurrency(this.value)">
                        ${Object.keys(CURRENCIES).map(code => 
                            `<option value="${code}" ${DATA.currency === code ? 'selected' : ''}>${CURRENCIES[code].symbol} ${CURRENCIES[code].name}</option>`
                        ).join('')}
                    </select>
                    
                    <div class="rate-toggle">
                        <label class="rate-toggle-label">Live Rate</label>
                        <div class="toggle-switch ${DATA.liveRate ? 'on' : ''}" onclick="DATA.liveRate=!DATA.liveRate;if(DATA.liveRate){fetchLiveRate();}else{saveToStorage();render();}" style="width:40px;height:22px;cursor:pointer;">
                            <div class="toggle-slider" style="width:16px;height:16px;"></div>
                        </div>
                    </div>
                    
                    ${DATA.liveRate ? 
                        `<span style="font-size:12px;color:#666;">Last updated: ${DATA.lastFetchedRate || 'Fetching...'}</span>` :
                        `<button class="btn" onclick="DATA.editRate=true;render()" style="padding:6px 12px;font-size:13px;">Edit Rate</button>`
                    }
                </div>
                
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                    <div class="rate">Exchange Rate: 
                        ${DATA.editRate && !DATA.liveRate ? 
                            `<input type="number" style="width:100px;padding:6px;border:2px solid #3b82f6;border-radius:4px;font-size:16px;font-weight:600;" value="${DATA.rate}" onchange="event.stopPropagation();DATA.rate=parseFloat(this.value)||155;saveToStorage();render()" onblur="DATA.editRate=false;render()" autofocus>` : 
                            `<span class="rate-value">${DATA.currencySymbol}${DATA.rate.toFixed(2)} per $1</span>`
                        }
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
                        <button class="btn" onclick="downloadHTML()">üíæ Download</button>
                        <button class="btn" onclick="exp()">üì• CSV</button>
                    </div>
                </div>
            </div>`;
            
            h += `<div class="converter">
                <h3>üí± Currency Converter</h3>
                <div class="converter-inputs">
                    <div class="converter-input">
                        <label>US Dollar ($)</label>
                        <input type="number" id="usdInput" value="${DATA.converterUSD.toFixed(2)}" step="0.01">
                    </div>
                    <div class="converter-swap" onclick="const t=DATA.converterUSD;DATA.converterUSD=DATA.converterYEN/DATA.rate;DATA.converterYEN=t*DATA.rate;render()">‚áÑ</div>
                    <div class="converter-input">
                        <label>${CURRENCIES[DATA.currency].name} (${DATA.currencySymbol})</label>
                        <input type="number" id="yenInput" value="${DATA.converterYEN.toFixed(2)}" step="0.01">
                    </div>
                </div>
            </div>`;
  

            h += `</div>`;  
            // Before trip checklist
            // On trip checklist
            
            // [PUT ALL YOUR PLANNING CONTENT HERE - everything except search bar, progress bar, daily budget, show estimated toggle, and day cards]
            
            h += `</div>`; // Close planning tab
            

            // ============================================
            // ITINERARY TAB
            // ============================================

            h += `<div class="tab-content ${DATA.activeTab === 'itinerary' ? 'active' : ''}">`;
            
            h += `<div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search by location, date, activity, notes..." value="${DATA.searchQuery}" style="padding-right:60px;">
                <div style="position:absolute;top:50%;right:15px;transform:translateY(-50%);font-size:16px;color:#666;cursor:pointer;user-select:none;padding:4px 8px;background:#f5f5f5;border-radius:4px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;" 
                     onmouseover="this.style.background='#e5e5e5';this.style.color='#333'" 
                     onmouseout="this.style.background='#f5f5f5';this.style.color='#666'"
                     onclick="DATA.searchMode=DATA.searchMode==='enter'?'auto':'enter';render()" 
                     title="${DATA.searchMode === 'enter' ? 'Press Enter to search' : 'Auto-search (400ms)'}">
                    ${DATA.searchMode === 'enter' ? '‚èé' : '‚è±'}
                </div>
                ${DATA.showSearchResults ? `
                    <div class="search-dropdown show">
                        ${DATA.searchResults.length > 0 ? 
                            DATA.searchResults.map(result => `
                                <div class="search-result-item" onclick="jumpToDay(${result.dayIndex})">
                                    <div class="search-result-day">Day ${result.day.d} - ${result.day.dt}</div>
                                    <div class="search-result-location">${result.day.loc}</div>
                                    ${result.matches.map(match => `
                                        <div class="search-result-match">
                                            <strong>${match.field}:</strong> ${highlightText(match.value, DATA.searchQuery)}
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('') 
                            : '<div class="search-no-results">No results found</div>'
                        }
                    </div>
                ` : ''}
            </div>`;
            // Search bar
            h += `<div class="progress">
                <div class="progress-label">
                    <span>Budget Progress</span>
                    <span>${s.pct.toFixed(1)}% spent</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${s.pct>100?'over':''}" style="width:${Math.min(s.pct,100)}%"></div>
                </div>
            </div>`;
            // Progress bar

            // Daily budget analysis
            // Show estimated costs toggle
            // Estimated stats (if enabled)
            // All day cards
            // Add day button

            
        h += `<div class="day-card">
            <div class="day-header" onclick="DATA.editBeforeChecklist = !DATA.editBeforeChecklist; render()">
                <div class="day-info">
                    <div style="font-size: 20px;">üìã</div>
                    <div class="day-title">
                        <h3>Before Trip Checklist</h3>
                        <div class="date">Preparation</div>
                    </div>
                </div>
            </div>
            ${DATA.editBeforeChecklist ? `
                <div class="details show">
                    <div class="checklist-items">
                        ${DATA.beforeChecklist.map((checklistItem, idx) => {
                            const itemText = checklistItem.item || (typeof checklistItem === 'string' ? checklistItem : '');
                            const isChecked = checklistItem.checked || false;
                            return `
                            <div class="checklist-item" draggable="true" 
                                ondragstart="handleChecklistDragStart(event, 'before', ${idx})"
                                ondragover="handleChecklistDragOver(event)"
                                ondrop="handleChecklistDrop(event, 'before', ${idx})"
                                ondragend="handleChecklistDragEnd(event)">
                                <span class="drag-handle" style="cursor: grab; padding: 0 8px; opacity: 0.5;">‚ãÆ‚ãÆ</span>
                                <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="event.stopPropagation();DATA.beforeChecklist[${idx}].checked = this.checked; saveToStorage(); render();" style="width: 20px; height: 20px;">
                                <input type="text" 
                                    value="${itemText}" 
                                    onchange="event.stopPropagation();DATA.beforeChecklist[${idx}].item = this.value; saveToStorage(); render();" 
                                    placeholder="Enter checklist item..."
                                    style="flex: 1; ${isChecked ? 'text-decoration: line-through; opacity: 0.6;' : ''} 
                                            ${!itemText ? 'color: #999; font-style: italic;' : ''}"
                                    ${!itemText ? 'class="empty-before-input"' : ''}>
                                <button class="btn" style="padding: 4px 12px; background: #ef4444;" onclick="event.stopPropagation(); DATA.beforeChecklist.splice(${idx}, 1); saveToStorage(); render()">üóëÔ∏è</button>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <button class="edit-btn" onclick="event.stopPropagation(); 
                        DATA.beforeChecklist.push({item: '', checked: false}); 
                        saveToStorage(); 
                        render();
                        setTimeout(() => {
                            const newInputs = document.querySelectorAll('.empty-before-input');
                            const lastInput = newInputs[newInputs.length - 1];
                            if (lastInput) {
                                lastInput.focus();
                                lastInput.select();
                            }
                        }, 10);">‚ûï Add Item</button>
                    
                    ${DATA.beforeChecklist.length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; font-size: 14px; color: #666;">
                            ${DATA.beforeChecklist.filter(i => i.checked).length} of ${DATA.beforeChecklist.length} items completed
                        </div>
                    ` : ''}
                </div>
            ` : ''}
        </div>`;

        h += `<div class="day-card">
            <div class="day-header" onclick="DATA.editTripChecklist = !DATA.editTripChecklist; render()">
                <div class="day-info">
                    <div style="font-size: 20px;">‚úàÔ∏è</div>
                    <div class="day-title">
                        <h3>On Trip Checklist</h3>
                        <div class="date">Remember</div>
                    </div>
                </div>
            </div>
            
            ${DATA.editTripChecklist ? `
                <div class="details show">
                    <div class="checklist-items">
                        ${DATA.tripChecklist.map((checklistItem, idx) => {
                            const itemText = checklistItem.item || (typeof checklistItem === 'string' ? checklistItem : '');
                            const isChecked = checklistItem.checked || false;
                            return `
                            <div class="checklist-item" draggable="true" 
                                ondragstart="handleChecklistDragStart(event, 'trip', ${idx})"
                                ondragover="handleChecklistDragOver(event)"
                                ondrop="handleChecklistDrop(event, 'trip', ${idx})"
                                ondragend="handleChecklistDragEnd(event)">
                                <span class="drag-handle" style="cursor: grab; padding: 0 8px; opacity: 0.5;">‚ãÆ‚ãÆ</span>
                                <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="event.stopPropagation();DATA.tripChecklist[${idx}].checked = this.checked; saveToStorage(); render();" style="width: 20px; height: 20px;">
                                <input type="text" 
                                    value="${itemText}" 
                                    onchange="event.stopPropagation();DATA.tripChecklist[${idx}].item = this.value; saveToStorage(); render();" 
                                    placeholder="Enter checklist item..."
                                    style="flex: 1; ${isChecked ? 'text-decoration: line-through; opacity: 0.6;' : ''} 
                                            ${!itemText ? 'color: #999; font-style: italic;' : ''}"
                                    ${!itemText ? 'class="empty-trip-input"' : ''}>
                                <button class="btn" style="padding: 4px 12px; background: #ef4444;" onclick="event.stopPropagation(); DATA.tripChecklist.splice(${idx}, 1); saveToStorage(); render()">üóëÔ∏è</button>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <button class="edit-btn" onclick="event.stopPropagation(); 
                        DATA.tripChecklist.push({item: '', checked: false}); 
                        saveToStorage(); 
                        render();
                        setTimeout(() => {
                            const newInputs = document.querySelectorAll('.empty-trip-input');
                            const lastInput = newInputs[newInputs.length - 1];
                            if (lastInput) {
                                lastInput.focus();
                                lastInput.select();
                            }
                        }, 10);">‚ûï Add Item</button>
                    
                    ${DATA.tripChecklist.length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; font-size: 14px; color: #666;">
                            ${DATA.tripChecklist.filter(i => i.checked).length} of ${DATA.tripChecklist.length} items completed
                        </div>
                    ` : ''}
                </div>
            ` : ''}
        </div>`; 
            
            DATA.days.forEach((day, realIndex) => {
                const pT = calc(day), aT = calcA(day);
                const exp = DATA.expanded === realIndex;
                const edit = DATA.editing === realIndex;
                
                h += `<div class="day-card ${day.done?'done':''}" data-day="${realIndex}">
                    <div class="day-header" onclick="DATA.expanded=DATA.expanded===${realIndex}?null:${realIndex};render()">
                        <div class="day-info">
                            <input type="checkbox" class="day-check" ${day.done?'checked':''} onclick="event.stopPropagation();DATA.days[${realIndex}].done=!DATA.days[${realIndex}].done;saveToStorage();render()">
                            <div class="day-num">${day.d}</div>
                            <div class="day-title">
                                <h3>${day.loc}</h3>
                                <div class="date">${day.dt}</div>
                            </div>
                        </div>
                        <div class="day-cost">
                            <div class="amount">${formatCostWithSplit(day.done?aT:pT)} ${day.done?'(actual)':'(planned)'}</div>
                            <div class="usd">$${((day.done?aT:pT)/DATA.rate).toFixed(2)}${DATA.costSplitMode === 'perPerson' && DATA.travelerCount > 1 ? ` ($${(((day.done?aT:pT)/DATA.rate)/DATA.travelerCount).toFixed(2)}/person)` : ''}</div>
                        </div>
                    </div>`;
                
                if(exp) {
                    h += `<div class="details show">
                        <button class="edit-btn ${edit?'save':''}" onclick="event.stopPropagation();DATA.editing=DATA.editing===${realIndex}?null:${realIndex};render()">
                            ${edit?'üíæ Save':'‚úèÔ∏è Edit'}
                        </button>`;
                    
                    if(edit) {
                        h += `<div class="section blue">
                            <div class="grid">
                                <input type="number" placeholder="Day #" value="${day.d}" onchange="update(${realIndex},'base','d',this.value)">
                                <input type="text" placeholder="Date" value="${day.dt}" onchange="update(${realIndex},'base','dt',this.value)">
                                <input type="text" placeholder="Location" value="${day.loc}" style="grid-column:1/-1" onchange="update(${realIndex},'base','loc',this.value)">
                            </div>
                            
                            ${DATA.categories.map(cat => {
                                const catData = day[cat.id] || {d: '', n: '', p: 0};
                                return `
                                    <div style="margin-top:15px;padding:10px;background:#f9fafb;border-radius:4px;border-left:3px solid ${cat.color};">
                                        <div style="font-weight:600;margin-bottom:8px;color:#374151;">${cat.icon} ${cat.name}</div>
                                        <div class="grid">
                                            <textarea placeholder="Description" onchange="update(${realIndex},'${cat.id}','d',this.value)">${catData.d || catData.n || ''}</textarea>
                                            <input type="number" placeholder="${DATA.currencySymbol}" value="${catData.p || 0}" onchange="update(${realIndex},'${cat.id}','p',this.value)">
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            
                            <textarea placeholder="Notes" style="margin-top:10px" onchange="update(${realIndex},'base','note',this.value)">${day.note}</textarea>
                        </div>`;
                    }
                    
                    h += `<div class="section yellow">
                        <h4 style="font-size:14px;font-weight:600;margin-bottom:10px">üí∞ Actual Spending</h4>
                        <div class="grid">
                            ${DATA.categories.map(cat => {
                                const actualValue = day.a?.[cat.id] || 0;
                                return `<input type="number" placeholder="${cat.icon} ${DATA.currencySymbol}" value="${actualValue || ''}" onchange="update(${realIndex},'${cat.id}','',this.value)" style="border-left:3px solid ${cat.color};">`;
                            }).join('')}
                        </div>
                    </div>`;
                    
                    // Render all categories dynamically
                    DATA.categories.forEach(cat => {
                        const catData = day[cat.id] || {d: '', n: '', p: 0};
                        const actualSpent = day.a?.[cat.id] || 0;
                        
                        h += `<div class="section" style="border-left-color:${cat.color};">
                            <div class="section-label">${cat.icon} ${cat.name}</div>
                            <div class="section-content">${catData.n || catData.d || '-'}</div>
                            <div class="section-cost">Planned: ${DATA.currencySymbol}${(catData.p || 0).toLocaleString()} ($${((catData.p || 0)/DATA.rate).toFixed(2)})</div>
                            ${actualSpent > 0 ? `<div class="section-cost actual">Actual: ${DATA.currencySymbol}${actualSpent.toLocaleString()} ($${(actualSpent/DATA.rate).toFixed(2)})</div>` : ''}
                        </div>`;
                    });
                    
                h += `<div class="photo-section">
                    <div class="photo-header" onclick="event.stopPropagation();DATA.days[${realIndex}].showPhotos=!DATA.days[${realIndex}].showPhotos;render()">
                        <h4 style="font-size:14px;font-weight:600;margin:0;">üì∏ Photos & Journal</h4>
                        <div style="display:flex;align-items:center;gap:10px;">
                            ${day.photos && day.photos.length > 0 ? `
                                <span style="font-size:12px;color:#666;">
                                    ${day.photos.length} photo${day.photos.length > 1 ? 's' : ''}
                                </span>
                            ` : ''}
                            ${day.journalNote && day.journalNote.trim() ? `
                                <span style="font-size:12px;color:#666;">‚Ä¢ Journal entry</span>
                            ` : ''}
                            <span class="schedule-toggle">${day.showPhotos ? '‚ñº' : '‚ñ∂'}</span>
                        </div>
                    </div>
                    
                    ${day.showPhotos ? `
                        <div class="photo-upload" style="margin-top:15px;">
                            <input type="file" accept="image/*" onchange="handlePhotoUpload(${realIndex}, event)" id="photo-${realIndex}" style="display:none">
                            <button class="btn" onclick="event.stopPropagation();document.getElementById('photo-${realIndex}').click()">üì∑ Add Photo</button>
                        </div>
                        ${day.photos && day.photos.length > 0 ? `
                            <div class="photo-gallery">
                                ${day.photos.map((photo, pIdx) => `
                                    <div class="photo-item" onclick="event.stopPropagation();openPhotoModal('${photo}')">
                                        <img src="${photo}">
                                        <button class="photo-delete" onclick="event.stopPropagation();deletePhoto(${realIndex},${pIdx})">√ó</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <textarea placeholder="Journal entry..." style="margin-top:10px;min-height:100px;" onchange="event.stopPropagation();updateJournal(${realIndex},this.value)">${day.journalNote || ''}</textarea>
                    ` : ''}
                </div>`;
               
                h += `<div class="receipt-section">
                    <div class="receipt-header" onclick="event.stopPropagation();DATA.days[${realIndex}].showReceipts=!DATA.days[${realIndex}].showReceipts;render()">
                        <h4 style="font-size:14px;font-weight:600;margin:0;">üßæ Receipts & Expenses</h4>
                        <div style="display:flex;align-items:center;gap:10px;">
                            ${day.receipts && day.receipts.length > 0 ? `
                                <span style="font-size:12px;color:#666;">
                                    ${day.receipts.length} receipt${day.receipts.length > 1 ? 's' : ''} ‚Ä¢ 
                                    ${DATA.currencySymbol}${day.receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0).toLocaleString()}
                                </span>
                            ` : ''}
                            <span class="schedule-toggle">${day.showReceipts ? '‚ñº' : '‚ñ∂'}</span>
                        </div>
                    </div>
                    
                    ${day.showReceipts ? `
                        <div class="receipt-upload" style="margin-top:15px;">
                            <input type="file" accept="image/*" onchange="handleReceiptUpload(${realIndex}, event)" id="receipt-${realIndex}" style="display:none">
                            <button class="btn" onclick="event.stopPropagation();document.getElementById('receipt-${realIndex}').click()">üì∏ Add Receipt</button>
                        </div>
                        ${day.receipts && day.receipts.length > 0 ? `
                            <div class="receipt-list">
                                ${day.receipts.map((receipt, rIdx) => `
                                    <div class="receipt-item">
                                        <div class="receipt-image" onclick="event.stopPropagation();openPhotoModal('${receipt.image}')">
                                            <img src="${receipt.image}" style="width:80px;height:80px;object-fit:cover;border-radius:4px;cursor:pointer;">
                                        </div>
                                        <div class="receipt-details">
                                            <div style="display:flex;gap:10px;margin-bottom:8px;align-items:center;">
                                                <input type="number" placeholder="Amount" value="${receipt.amount || ''}" onchange="event.stopPropagation();updateReceipt(${realIndex},${rIdx},'amount',this.value)" style="width:100px;">
                                                <select onchange="event.stopPropagation();updateReceipt(${realIndex},${rIdx},'category',this.value)" style="flex:1;">
                                                    <option value="">Select category...</option>
                                                    ${DATA.categories.map(cat => 
                                                        `<option value="${cat.id}" ${receipt.category === cat.id ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
                                                    ).join('')}
                                                </select>
                                                ${!receipt.category && receipt.description ? `
                                                    <button class="btn" onclick="event.stopPropagation();const cat=autoCategorizeReceipt('${receipt.description.replace(/'/g, "\\'")}');if(cat){updateReceipt(${realIndex},${rIdx},'category',cat);}" style="padding:4px 10px;font-size:11px;background:#10b981;white-space:nowrap;">
                                                        ‚ú® Auto
                                                    </button>
                                                ` : ''}
                                            </div>
                                            <input type="text" placeholder="Description (e.g., 'Tokyo Station Coffee Shop')" value="${receipt.description || ''}" onchange="event.stopPropagation();updateReceipt(${realIndex},${rIdx},'description',this.value)" style="width:100%;margin-bottom:8px;">
                                            <input type="date" value="${receipt.date || day.dt}" onchange="event.stopPropagation();updateReceipt(${realIndex},${rIdx},'date',this.value)" style="width:100%;margin-bottom:8px;">
                                            <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;">
                                                <span style="font-size:12px;color:#666;">
                                                    ${receipt.category ? DATA.categories.find(c => c.id === receipt.category)?.icon + ' ' : ''}
                                                    ${receipt.amount ? DATA.currencySymbol + parseFloat(receipt.amount).toLocaleString() : 'No amount'}
                                                </span>
                                                <button class="btn" onclick="event.stopPropagation();deleteReceipt(${realIndex},${rIdx})" style="padding:4px 10px;font-size:11px;background:#ef4444;">üóëÔ∏è Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #e0e0e0;">
                                <div style="display:flex;justify-content:space-between;font-size:13px;color:#666;">
                                    <span><strong>${day.receipts.length}</strong> receipt${day.receipts.length > 1 ? 's' : ''}</span>
                                    <span><strong>${DATA.currencySymbol}${day.receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0).toLocaleString()}</strong> total</span>
                                </div>
                            </div>
                        ` : ''}
                    ` : ''}
                </div>`;
                    
                    h += `<div class="schedule-section">
                        <div class="schedule-header" onclick="event.stopPropagation();DATA.days[${realIndex}].showSchedule=!DATA.days[${realIndex}].showSchedule;render()">
                            <h4>üìÖ Daily Schedule</h4>
                            <span class="schedule-toggle">${day.showSchedule ? '‚ñº' : '‚ñ∂'}</span>
                        </div>
                        ${day.showSchedule ? `
                            <div class="schedule-view-toggle">
                                <button class="schedule-view-btn ${!day.scheduleView || day.scheduleView === 'list' ? 'active' : ''}" onclick="event.stopPropagation();DATA.days[${realIndex}].scheduleView='list';render()">üìã List</button>
                                <button class="schedule-view-btn ${day.scheduleView === 'timeline' ? 'active' : ''}" onclick="event.stopPropagation();DATA.days[${realIndex}].scheduleView='timeline';render()">üìä Timeline</button>
                            </div>
                            
                            ${!day.scheduleView || day.scheduleView === 'list' ? `
                                <div class="schedule-grid">
                                    ${(day.schedule || []).sort((a, b) => a.time.localeCompare(b.time)).map((item, sIdx) => `
                                        <div class="schedule-hour">
                                            <div class="schedule-time">
                                                <input type="time" value="${item.time}" onchange="event.stopPropagation();updateSchedule(${realIndex},${sIdx},'time',this.value)">
                                            </div>
                                            <div class="schedule-activity">
                                                <input type="text" placeholder="What's happening..." value="${item.activity}" onchange="event.stopPropagation();updateSchedule(${realIndex},${sIdx},'activity',this.value)">
                                            </div>
                                            <div class="schedule-actions">
                                                <button class="schedule-delete" onclick="event.stopPropagation();deleteSchedule(${realIndex},${sIdx})" title="Delete">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    <button class="schedule-add-btn" onclick="event.stopPropagation();addScheduleItem(${realIndex})">+ Add Time Slot</button>
                                </div>
                            ` : `
                                <div class="schedule-timeline">
                                    <div class="timeline-hours">
                                        ${Array.from({length: 24}, (_, hour) => {
                                            const events = (day.schedule || []).filter(item => {
                                                const itemHour = parseInt(item.time.split(':')[0]);
                                                return itemHour === hour;
                                            });
                                            return `
                                                <div class="timeline-hour-row">
                                                    <div class="timeline-hour-label">${hour === 0 ? '12 AM' : hour < 12 ? hour + ' AM' : hour === 12 ? '12 PM' : (hour - 12) + ' PM'}</div>
                                                    <div class="timeline-hour-cell" onclick="event.stopPropagation();const time='${hour.toString().padStart(2,'0')}:00';DATA.days[${realIndex}].schedule.push({time:time,activity:''});saveToStorage();render();">
                                                        ${events.map((evt, evtIdx) => {
                                                            const scheduleIdx = day.schedule.findIndex(s => s.time === evt.time && s.activity === evt.activity);
                                                            return `
                                                                <div class="timeline-event" onclick="event.stopPropagation();">
                                                                    <button class="timeline-event-delete" onclick="event.stopPropagation();deleteSchedule(${realIndex},${scheduleIdx})">√ó</button>
                                                                    <div class="timeline-event-time">${evt.time}</div>
                                                                    <input type="text" class="timeline-event-title" placeholder="Add activity..." value="${evt.activity}" onchange="event.stopPropagation();updateSchedule(${realIndex},${scheduleIdx},'activity',this.value)" style="background:transparent;border:none;color:white;width:100%;font-size:13px;" onclick="event.stopPropagation();">
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `}
                        ` : ''}
                    </div>`;
                    
                    h += `<div class="weather-section">
                        <div class="weather-header">
                            <h4>üå§Ô∏è Weather Forecast</h4>
                            <button class="weather-fetch-btn" onclick="event.stopPropagation();fetchWeather(${realIndex})" ${day.weatherLoading ? 'disabled' : ''}>
                                ${day.weatherLoading ? '‚è≥ Loading...' : day.weather ? 'üîÑ Refresh' : 'üì° Fetch Weather'}
                            </button>
                        </div>
                        
                        ${day.weatherLoading ? `
                            <div class="weather-loading">Fetching weather data...</div>
                        ` : day.weather ? (day.weather.error ? `
                            <div class="weather-error">${day.weather.error}</div>
                        ` : `
                            <div style="font-size:12px;color:#666;margin-bottom:10px;">üìç ${day.weather.location} on ${day.dt}</div>
                            <div class="weather-display">
                                <div class="weather-card">
                                    <div class="weather-icon">${day.weather.icon}</div>
                                    <div class="weather-temp">${day.weather.tempMin}¬∞ - ${day.weather.temp}¬∞F</div>
                                    <div style="font-size:11px;opacity:0.8;">${day.weather.tempMinC}¬∞ - ${day.weather.tempC}¬∞C</div>
                                    <div class="weather-desc">${day.weather.condition}</div>
                                </div>
                                <div class="weather-card" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                                    <div style="font-size:24px;margin-bottom:5px;">üíß</div>
                                    <div class="weather-temp">${day.weather.precipitation}mm</div>
                                    <div class="weather-desc">Precipitation</div>
                                </div>
                                <div class="weather-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                    <div style="font-size:24px;margin-bottom:5px;">üí®</div>
                                    <div class="weather-temp">${day.weather.windSpeed}</div>
                                    <div class="weather-desc">mph wind</div>
                                </div>
                            </div>
                        `) : `
                            <div style="color:#666;font-size:13px;font-style:italic;">Click "Fetch Weather" to see forecast for ${day.loc.split('‚Üí')[0].trim()} on ${day.dt}</div>
                        `}
                    </div>`;

                     h += `<div class="day-card-controls">
                        <button class="day-control-btn" onclick="event.stopPropagation();duplicateDay(${realIndex})">üìã Duplicate Day</button>
                        <button class="day-control-btn danger" onclick="event.stopPropagation();deleteDay(${realIndex})">üóëÔ∏è Delete Day</button>
                    </div>`;
                    
                    h += `</div>`;
                }
                
                h += `</div>`;
            });
            h += `<div style="margin-top:20px;text-align:center;">
                <button class="header-btn" onclick="addDay()">‚ûï Add New Day</button>
            </div>`;
                        
            h += `</div>`; // Close itinerary tab
            
            // ============================================
            // GALLERY TAB
            // ============================================

            h += `<div class="tab-content ${DATA.activeTab === 'gallery' ? 'active' : ''}">`;

            h += `<div class="gallery-controls">
                <button class="gallery-view-btn ${!DATA.galleryView || DATA.galleryView === 'timeline' ? 'active' : ''}" onclick="DATA.galleryView='timeline';render()">
                    üìÖ Timeline View
                </button>
                <button class="gallery-view-btn ${DATA.galleryView === 'grid' ? 'active' : ''}" onclick="DATA.galleryView='grid';render()">
                    üî≤ Grid View
                </button>
                <button class="gallery-view-btn ${DATA.galleryView === 'map' ? 'active' : ''}" onclick="DATA.galleryView='map';render()">
                    üó∫Ô∏è Map View
                </button>
            </div>`;

            // Timeline View
            if (!DATA.galleryView || DATA.galleryView === 'timeline') {
                const daysWithPhotos = DATA.days.filter(day => day.photos && day.photos.length > 0);
                
                if (daysWithPhotos.length === 0) {
                    h += `<div style="text-align:center;padding:60px 20px;color:#999;">
                        <div style="font-size:60px;margin-bottom:20px;">üì∏</div>
                        <h3>No photos yet</h3>
                        <p>Start adding photos to your trip days to see them here!</p>
                    </div>`;
                } else {
                    h += `<div class="gallery-timeline">`;
                    daysWithPhotos.forEach(day => {
                        const photoCount = day.photos.length;
                        h += `<div class="gallery-day-section">
                            <div class="gallery-day-header">
                                <h3>Day ${day.d} - ${day.dt}</h3>
                                <div class="gallery-day-location">${day.loc}</div>
                                <div class="gallery-photo-count">${photoCount} photo${photoCount > 1 ? 's' : ''}</div>
                            </div>
                            <div class="gallery-grid">
                                ${day.photos.map(photo => `
                                    <div class="gallery-photo-item" onclick="openPhotoModal('${photo}')">
                                        <img src="${photo}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    });
                    h += `</div>`;
                }
            }

            // Grid View
            if (DATA.galleryView === 'grid') {
                const allPhotos = [];
                DATA.days.forEach(day => {
                    if (day.photos && day.photos.length > 0) {
                        day.photos.forEach(photo => {
                            allPhotos.push({ photo, day });
                        });
                    }
                });
                
                if (allPhotos.length === 0) {
                    h += `<div style="text-align:center;padding:60px 20px;color:#999;">
                        <div style="font-size:60px;margin-bottom:20px;">üì∏</div>
                        <h3>No photos yet</h3>
                        <p>Start adding photos to your trip days to see them here!</p>
                    </div>`;
                } else {
                    h += `<div class="gallery-stats">
                        <div class="stat-card">
                            <div class="stat-label">Total Photos</div>
                            <div class="stat-value">${allPhotos.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Days with Photos</div>
                            <div class="stat-value">${DATA.days.filter(d => d.photos && d.photos.length > 0).length}</div>
                        </div>
                    </div>`;
                    
                    h += `<div class="gallery-grid-all">
                        ${allPhotos.map(item => `
                            <div class="gallery-photo-item" onclick="openPhotoModal('${item.photo}')">
                                <img src="${item.photo}">
                                <div class="gallery-photo-overlay">
                                    <div class="gallery-photo-day">Day ${item.day.d}</div>
                                    <div class="gallery-photo-location">${item.day.loc}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }
            }

            // Map View
            if (DATA.galleryView === 'map') {
                h += `<div style="padding:20px;text-align:center;color:#666;">
                    <p>üöß Map view coming soon! This will show photos on a map based on their location.</p>
                    <p style="font-size:13px;margin-top:10px;">Tip: Take photos with location services enabled for automatic placement.</p>
                </div>`;
            }

            h += `</div>`; // Close gallery tab

            
            // Continue with rest of render (currency converter listeners, search listeners, etc.)
    
            app.innerHTML = h;
            
            // Set up currency converter listeners (NO RENDER on input)
            const usdInput = document.getElementById('usdInput');
            if(usdInput) {
                usdInput.addEventListener('input', (e) => {
                    DATA.converterUSD = parseFloat(e.target.value) || 0;
                    DATA.converterYEN = DATA.converterUSD * DATA.rate;
                    const yenInput = document.getElementById('yenInput');
                    if(yenInput) yenInput.value = DATA.converterYEN.toFixed(0);
                    saveToStorage();
                });
            }
            
            const yenInput = document.getElementById('yenInput');
            if(yenInput) {
                yenInput.addEventListener('input', (e) => {
                    DATA.converterYEN = parseFloat(e.target.value) || 0;
                    DATA.converterUSD = DATA.converterYEN / DATA.rate;
                    const usdInput = document.getElementById('usdInput');
                    if(usdInput) usdInput.value = DATA.converterUSD.toFixed(2);
                    saveToStorage();
                });
            }
            
            // Set up search input listener
            const searchInput = document.getElementById('searchInput');
            if(searchInput) {
                const performSearch = (query) => {
                    if (!query || query.trim().length === 0) {
                        DATA.showSearchResults = false;
                        DATA.searchResults = [];
                        render();
                        return;
                    }
                    
                    const searchLower = query.toLowerCase().trim();
                    const results = [];
                    
                    DATA.days.forEach((day, idx) => {
                        const matches = [];
                        
                        if (day.loc.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Location', value: day.loc });
                        }
                        if (day.dt.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Date', value: day.dt });
                        }
                        if (day.acc.n.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Accommodation', value: day.acc.n });
                        }
                        if (day.trn.d.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Transportation', value: day.trn.d });
                        }
                        if (day.food.d.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Food', value: day.food.d });
                        }
                        if (day.act.d.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Activities', value: day.act.d });
                        }
                        if (day.note.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Note', value: day.note });
                        }
                        if (day.journalNote && day.journalNote.toLowerCase().includes(searchLower)) {
                            matches.push({ field: 'Journal', value: day.journalNote.substring(0, 100) });
                        }
                        
                        if (matches.length > 0) {
                            results.push({ dayIndex: idx, day: day, matches: matches });
                        }
                    });
                    
                    DATA.searchResults = results;
                    DATA.showSearchResults = query.length > 0;
                    render();
                };
                
                // Enter-based search
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && DATA.searchMode === 'enter') {
                        performSearch(e.target.value);
                    }
                });
                
                // Input listener for both modes
                searchInput.addEventListener('input', (e) => {
                    DATA.searchQuery = e.target.value;
                    
                    // Auto mode with debounce
                    if (DATA.searchMode === 'auto') {
                        clearTimeout(window.searchTimer);
                        if (!e.target.value || e.target.value.trim().length === 0) {
                            DATA.showSearchResults = false;
                            DATA.searchResults = [];
                            render();
                        } else {
                            window.searchTimer = setTimeout(() => {
                                performSearch(e.target.value);
                            }, 400);
                        }
                    } 
                    // Enter mode - only clear when empty
                    else if (!e.target.value || e.target.value.trim().length === 0) {
                        DATA.showSearchResults = false;
                        DATA.searchResults = [];
                        render();
                    }
                });
            }
        };
        
        loadFromStorage();

        if (DATA.liveRate) {
            fetchLiveRate();
        } else {
            render();
        }

        // Always init map if it's open AND we're on planning tab
        if (DATA.showMap && DATA.activeTab === 'planning') {
            setTimeout(() => {
                const mapElement = document.getElementById('tripMap');
                if (mapElement) {
                    console.log('üó∫Ô∏è Initializing map on page load');
                    initMap();
                }
            }, 100);
        }
        
        document.addEventListener('click', (e) => {
            if (DATA.showSearchResults && !e.target.closest('.search-bar')) {
                DATA.showSearchResults = false;
                render();
            }
        });
    </script>
</body>
</html>
                